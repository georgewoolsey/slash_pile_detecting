<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 3 RGB Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 3 RGB Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 3 RGB Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-processing.html"/>
<link rel="next" href="ptcld_process.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-processing.html"><a href="data-processing.html"><i class="fa fa-check"></i><b>2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-processing.html"><a href="data-processing.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.1</b> Slash Pile Vector Data</a></li>
<li class="chapter" data-level="2.2" data-path="data-processing.html"><a href="data-processing.html#load-rgb-orthomosaic-rasters"><i class="fa fa-check"></i><b>2.2</b> Load RGB orthomosaic rasters</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data-processing.html"><a href="data-processing.html#example-ratio-based-index"><i class="fa fa-check"></i><b>2.2.1</b> Example ratio-based index</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data-processing.html"><a href="data-processing.html#study-area-imagery"><i class="fa fa-check"></i><b>2.3</b> Study area imagery</a></li>
<li class="chapter" data-level="2.4" data-path="data-processing.html"><a href="data-processing.html#point-cloud-data"><i class="fa fa-check"></i><b>2.4</b> Point Cloud Data</a></li>
<li class="chapter" data-level="2.5" data-path="data-processing.html"><a href="data-processing.html#check-out-one-pile"><i class="fa fa-check"></i><b>2.5</b> Check out one pile</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="rgb-classification.html"><a href="rgb-classification.html"><i class="fa fa-check"></i><b>3</b> RGB Classification</a>
<ul>
<li class="chapter" data-level="3.1" data-path="rgb-classification.html"><a href="rgb-classification.html#textural-covariates"><i class="fa fa-check"></i><b>3.1</b> Textural covariates</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-panchromatic"><i class="fa fa-check"></i><b>3.1.1</b> Raster Texture: Panchromatic</a></li>
<li class="chapter" data-level="3.1.2" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-grvi"><i class="fa fa-check"></i><b>3.1.2</b> Raster Texture: GRVI</a></li>
<li class="chapter" data-level="3.1.3" data-path="rgb-classification.html"><a href="rgb-classification.html#plot-textural-rasters"><i class="fa fa-check"></i><b>3.1.3</b> Plot textural rasters</a></li>
<li class="chapter" data-level="3.1.4" data-path="rgb-classification.html"><a href="rgb-classification.html#features-for-classification"><i class="fa fa-check"></i><b>3.1.4</b> Features for classification</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel-based-unsupervised-classification"><i class="fa fa-check"></i><b>3.2</b> Pixel-based: unsupervised classification</a></li>
<li class="chapter" data-level="3.3" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel_class"><i class="fa fa-check"></i><b>3.3</b> Pixel-based: supervised classification</a></li>
<li class="chapter" data-level="3.4" data-path="rgb-classification.html"><a href="rgb-classification.html#obia"><i class="fa fa-check"></i><b>3.4</b> Object-based image analysis (OBIA)</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="rgb-classification.html"><a href="rgb-classification.html#training-data"><i class="fa fa-check"></i><b>3.4.1</b> Training data</a></li>
<li class="chapter" data-level="3.4.2" data-path="rgb-classification.html"><a href="rgb-classification.html#slic"><i class="fa fa-check"></i><b>3.4.2</b> <code>OpenImageR</code> package SLIC image segmentation</a></li>
<li class="chapter" data-level="3.4.3" data-path="rgb-classification.html"><a href="rgb-classification.html#superpixelimagesegmentation-package-slicap-clustering"><i class="fa fa-check"></i><b>3.4.3</b> <code>SuperpixelImageSegmentation</code> package SLICAP clustering</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ptcld_process.html"><a href="ptcld_process.html"><i class="fa fa-check"></i><b>4</b> Point Cloud Processing and Pile Segmentation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ptcld_process.html"><a href="ptcld_process.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>4.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ptcld_process.html"><a href="ptcld_process.html#dtm-and-chm-piles"><i class="fa fa-check"></i><b>4.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="raster_watershed.html"><a href="raster_watershed.html"><i class="fa fa-check"></i><b>5</b> Raster-based: Watershed Segmentation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="raster_watershed.html"><a href="raster_watershed.html#method-demonstration"><i class="fa fa-check"></i><b>5.1</b> Method Demonstration</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-irregularity-filtering"><i class="fa fa-check"></i><b>5.1.1</b> Geometric filtering: Irregularity Filtering</a></li>
<li class="chapter" data-level="5.1.2" data-path="raster_watershed.html"><a href="raster_watershed.html#area-filtering"><i class="fa fa-check"></i><b>5.1.2</b> Area Filtering</a></li>
<li class="chapter" data-level="5.1.3" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-circularity-filtering"><i class="fa fa-check"></i><b>5.1.3</b> Geometric filtering: Circularity Filtering</a></li>
<li class="chapter" data-level="5.1.4" data-path="raster_watershed.html"><a href="raster_watershed.html#smoothing"><i class="fa fa-check"></i><b>5.1.4</b> Smoothing</a></li>
<li class="chapter" data-level="5.1.5" data-path="raster_watershed.html"><a href="raster_watershed.html#shape-refinement"><i class="fa fa-check"></i><b>5.1.5</b> Shape Refinement</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="raster_watershed.html"><a href="raster_watershed.html#confusion-matrix-evaluation"><i class="fa fa-check"></i><b>5.2</b> Confusion matrix evaluation</a></li>
<li class="chapter" data-level="5.3" data-path="raster_watershed.html"><a href="raster_watershed.html#pile-area-rmse"><i class="fa fa-check"></i><b>5.3</b> Pile area RMSE</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html"><i class="fa fa-check"></i><b>6</b> Watershed Segmentation: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="6.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#slash_pile_detect_watershed"><i class="fa fa-check"></i><b>6.1</b> Watershed Pile Detection Function</a></li>
<li class="chapter" data-level="6.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#wshed_params_test"><i class="fa fa-check"></i><b>6.2</b> Parameter sensitivity testing</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#all_the_combos"><i class="fa fa-check"></i><b>6.2.1</b> Workflow over parameter combinations</a></li>
<li class="chapter" data-level="6.2.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#validation-over-parameter-combinations"><i class="fa fa-check"></i><b>6.2.2</b> Validation over parameter combinations</a></li>
<li class="chapter" data-level="6.2.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#aggregate-assessment-metrics"><i class="fa fa-check"></i><b>6.2.3</b> Aggregate assessment metrics</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#parameter-sensitivity-test-results"><i class="fa fa-check"></i><b>6.3</b> Parameter Sensitivity Test Results</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#overall-pile-detection"><i class="fa fa-check"></i><b>6.3.1</b> Overall: pile detection</a></li>
<li class="chapter" data-level="6.3.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#overall-form-quantification"><i class="fa fa-check"></i><b>6.3.2</b> Overall: form quantification</a></li>
<li class="chapter" data-level="6.3.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#main-effects-pile-detection"><i class="fa fa-check"></i><b>6.3.3</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="6.3.4" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#main-effects-form-quantification"><i class="fa fa-check"></i><b>6.3.4</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="6.3.5" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#best-results-detection-accuracy"><i class="fa fa-check"></i><b>6.3.5</b> Best results: detection accuracy</a></li>
<li class="chapter" data-level="6.3.6" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#best-results-quantification-accuracy"><i class="fa fa-check"></i><b>6.3.6</b> Best results: quantification accuracy</a></li>
<li class="chapter" data-level="6.3.7" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#wshed_best_best"><i class="fa fa-check"></i><b>6.3.7</b> Best results: detection &amp; quantification</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#final-recommended-settings"><i class="fa fa-check"></i><b>6.4</b> Final recommended settings</a></li>
<li class="chapter" data-level="6.5" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#appendix-parameter-combination-drill-downs"><i class="fa fa-check"></i><b>6.5</b> Appendix: Parameter combination drill-downs</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#f-score"><i class="fa fa-check"></i><b>6.5.1</b> F-score</a></li>
<li class="chapter" data-level="6.5.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#recall"><i class="fa fa-check"></i><b>6.5.2</b> Recall</a></li>
<li class="chapter" data-level="6.5.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#precision"><i class="fa fa-check"></i><b>6.5.3</b> Precision</a></li>
<li class="chapter" data-level="6.5.4" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-volume-irregular"><i class="fa fa-check"></i><b>6.5.4</b> MAPE Volume irregular</a></li>
<li class="chapter" data-level="6.5.5" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-diameter"><i class="fa fa-check"></i><b>6.5.5</b> MAPE Diameter</a></li>
<li class="chapter" data-level="6.5.6" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-area"><i class="fa fa-check"></i><b>6.5.6</b> MAPE Area</a></li>
<li class="chapter" data-level="6.5.7" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-height"><i class="fa fa-check"></i><b>6.5.7</b> MAPE Height</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data_fusion.html"><a href="data_fusion.html"><i class="fa fa-check"></i><b>7</b> Data Fusion</a>
<ul>
<li class="chapter" data-level="7.1" data-path="data_fusion.html"><a href="data_fusion.html#rgb-indices"><i class="fa fa-check"></i><b>7.1</b> RGB Indices</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-functions"><i class="fa fa-check"></i><b>7.1.1</b> Spectral Index Functions</a></li>
<li class="chapter" data-level="7.1.2" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-of-polygons"><i class="fa fa-check"></i><b>7.1.2</b> Spectral Index of Polygons</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="data_fusion.html"><a href="data_fusion.html#ground-truth-pile-spectral-summary"><i class="fa fa-check"></i><b>7.2</b> Ground Truth Pile Spectral Summary</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="data_fusion.html"><a href="data_fusion.html#voting-system"><i class="fa fa-check"></i><b>7.2.1</b> Voting System</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="data_fusion.html"><a href="data_fusion.html#polygon_spectral_filtering"><i class="fa fa-check"></i><b>7.3</b> Candidate Polygon Spectral Filtering Function</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="fusion_params_test.html"><a href="fusion_params_test.html"><i class="fa fa-check"></i><b>8</b> Data Fusion: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.1" data-path="fusion_params_test.html"><a href="fusion_params_test.html#example-comparison-by-spectral-weighting"><i class="fa fa-check"></i><b>8.1</b> Example comparison by spectral weighting</a></li>
<li class="chapter" data-level="8.2" data-path="fusion_params_test.html"><a href="fusion_params_test.html#aggregate-assessment-metrics-1"><i class="fa fa-check"></i><b>8.2</b> Aggregate assessment metrics</a></li>
<li class="chapter" data-level="8.3" data-path="fusion_params_test.html"><a href="fusion_params_test.html#parameter-sensitivity-test-results-1"><i class="fa fa-check"></i><b>8.3</b> Parameter Sensitivity Test Results</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="fusion_params_test.html"><a href="fusion_params_test.html#main-effect-of-spectral-data-pile-detection"><i class="fa fa-check"></i><b>8.3.1</b> Main effect of spectral data: pile detection</a></li>
<li class="chapter" data-level="8.3.2" data-path="fusion_params_test.html"><a href="fusion_params_test.html#main-effect-of-spectral-data-form-quantification"><i class="fa fa-check"></i><b>8.3.2</b> Main effect of spectral data: form quantification</a></li>
<li class="chapter" data-level="8.3.3" data-path="fusion_params_test.html"><a href="fusion_params_test.html#overall-pile-detection-1"><i class="fa fa-check"></i><b>8.3.3</b> Overall: pile detection</a></li>
<li class="chapter" data-level="8.3.4" data-path="fusion_params_test.html"><a href="fusion_params_test.html#overall-form-quantification-1"><i class="fa fa-check"></i><b>8.3.4</b> Overall: form quantification</a></li>
<li class="chapter" data-level="8.3.5" data-path="fusion_params_test.html"><a href="fusion_params_test.html#best-results-detection-accuracy-1"><i class="fa fa-check"></i><b>8.3.5</b> Best results: detection accuracy</a></li>
<li class="chapter" data-level="8.3.6" data-path="fusion_params_test.html"><a href="fusion_params_test.html#best-results-quantification-accuracy-1"><i class="fa fa-check"></i><b>8.3.6</b> Best results: quantification accuracy</a></li>
<li class="chapter" data-level="8.3.7" data-path="fusion_params_test.html"><a href="fusion_params_test.html#best-results-detection-quantification"><i class="fa fa-check"></i><b>8.3.7</b> Best results: detection &amp; quantification</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="fusion_params_test.html"><a href="fusion_params_test.html#final-recommended-settings-1"><i class="fa fa-check"></i><b>8.4</b> Final recommended settings</a></li>
<li class="chapter" data-level="8.5" data-path="fusion_params_test.html"><a href="fusion_params_test.html#final-recommended-settings-data-fusion-versus-structural-only"><i class="fa fa-check"></i><b>8.5</b> Final recommended settings: data fusion versus structural only</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html"><i class="fa fa-check"></i><b>9</b> CHM Raster Resolution Testing</a>
<ul>
<li class="chapter" data-level="9.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#process-raw-point-cloud-1"><i class="fa fa-check"></i><b>9.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="9.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#structural-only-parameter-testing"><i class="fa fa-check"></i><b>9.2</b> Structural Only: Parameter Testing</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#validation-over-parameter-combinations-1"><i class="fa fa-check"></i><b>9.2.1</b> Validation over parameter combinations</a></li>
<li class="chapter" data-level="9.2.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#aggregate-validation-metrics-to-parameter-combination"><i class="fa fa-check"></i><b>9.2.2</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#data-fusion-parameter-testing"><i class="fa fa-check"></i><b>9.3</b> Data Fusion: Parameter Testing</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#aggregate-validation-metrics-to-parameter-combination-1"><i class="fa fa-check"></i><b>9.3.1</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#read-data-for-analysis"><i class="fa fa-check"></i><b>9.4</b> Read Data for Analysis</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#structural-only"><i class="fa fa-check"></i><b>9.4.1</b> Structural Only</a></li>
<li class="chapter" data-level="9.4.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#data-fusion"><i class="fa fa-check"></i><b>9.4.2</b> Data Fusion</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#allthetests"><i class="fa fa-check"></i><b>9.5</b> Structural Only: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#detect_trends"><i class="fa fa-check"></i><b>9.5.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="9.5.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#main-effects-form-quantification-1"><i class="fa fa-check"></i><b>9.5.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="9.5.3" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#final-recommended-settings-2"><i class="fa fa-check"></i><b>9.5.3</b> Final recommended settings</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#data-fusion-sensitivity-testing"><i class="fa fa-check"></i><b>9.6</b> Data Fusion: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#main-effects-pile-detection-1"><i class="fa fa-check"></i><b>9.6.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="9.6.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#main-effects-form-quantification-2"><i class="fa fa-check"></i><b>9.6.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="9.6.3" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#balanced_acc_assess"><i class="fa fa-check"></i><b>9.6.3</b> Final recommended settings</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#save-the-data"><i class="fa fa-check"></i><b>9.7</b> save the data</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="stats_method.html"><a href="stats_method.html"><i class="fa fa-check"></i><b>10</b> Statistical Testing of Method Settings</a>
<ul>
<li class="chapter" data-level="10.1" data-path="stats_method.html"><a href="stats_method.html#bayesian-generalized-linear-model---f-score"><i class="fa fa-check"></i><b>10.1</b> Bayesian generalized linear model - F-score</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="stats_method.html"><a href="stats_method.html#model-selection"><i class="fa fa-check"></i><b>10.1.1</b> Model selection</a></li>
<li class="chapter" data-level="10.1.2" data-path="stats_method.html"><a href="stats_method.html#modeling"><i class="fa fa-check"></i><b>10.1.2</b> Modeling</a></li>
<li class="chapter" data-level="10.1.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks"><i class="fa fa-check"></i><b>10.1.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="10.1.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects"><i class="fa fa-check"></i><b>10.1.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="10.1.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation"><i class="fa fa-check"></i><b>10.1.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape"><i class="fa fa-check"></i><b>10.2</b> Bayesian generalized linear model - Diameter MAPE</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-1"><i class="fa fa-check"></i><b>10.2.1</b> Model selection</a></li>
<li class="chapter" data-level="10.2.2" data-path="stats_method.html"><a href="stats_method.html#modeling-1"><i class="fa fa-check"></i><b>10.2.2</b> Modeling</a></li>
<li class="chapter" data-level="10.2.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-1"><i class="fa fa-check"></i><b>10.2.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="10.2.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-1"><i class="fa fa-check"></i><b>10.2.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="10.2.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation-1"><i class="fa fa-check"></i><b>10.2.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="stats_method.html"><a href="stats_method.html#bayesian-generalized-linear-model---height-mape"><i class="fa fa-check"></i><b>10.3</b> Bayesian generalized linear model - Height MAPE</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-2"><i class="fa fa-check"></i><b>10.3.1</b> Model selection</a></li>
<li class="chapter" data-level="10.3.2" data-path="stats_method.html"><a href="stats_method.html#modeling-2"><i class="fa fa-check"></i><b>10.3.2</b> Modeling</a></li>
<li class="chapter" data-level="10.3.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-2"><i class="fa fa-check"></i><b>10.3.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="10.3.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-2"><i class="fa fa-check"></i><b>10.3.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="10.3.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation-2"><i class="fa fa-check"></i><b>10.3.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="method-validation.html"><a href="method-validation.html"><i class="fa fa-check"></i><b>11</b> Method Validation</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="rgb-classification" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Section 3</span> RGB Classification<a href="rgb-classification.html#rgb-classification" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We’ll use the RGB imagery alone to explore unsupervised and supervised classification algorithms.</p>
<p>Ultimately, it is likely we will use an object-based image analysis (OBIA) approach. OBIA is a technique (or a set of techniques) used to analyze digital images that was developed relatively recently in comparison to ‘classic’ pixel-based image approaches (<a href="https://doi.org/10.1016/S0304-3800(03)00139-X">Burnett and Blaschke 2003</a>). The OBIA approach for ecological applications is described by <a href="https://doi.org/10.1016/j.jag.2018.11.011">Goncalves et al. (2019)</a> who also introduce the <code>SegOptim</code> <a href="https://github.com/joaofgoncalves/SegOptim">package</a></p>
<p>In future sections we will explore, integration of spectral data with the 3D point cloud data (i.e. “data fusion”) to test distinguishing the woody material in slash piles from surrounding vegetation or soil. Field-measured slash piles will be used as the ground truth data to perform a confusion matrix-based validation accuracy assessment of the methods.</p>
<p><a href="https://doi.org/10.3390/rs14122896">Norton et al. (2022)</a> combined LiDAR and hyperspectral data in a data fusion approach for classification of semi-arid woody cover species and achieved accuracies ranging from 86% to 98% for five woody species</p>
<p>We’ll see how far we can get without hyperspectral data since this data is less common</p>
<div id="textural-covariates" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Textural covariates<a href="rgb-classification.html#textural-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><a href="https://scholar.google.com/scholar?cluster=13863271628667072083&amp;oi=gsb&amp;hl=en&amp;as_sdt=0,6">Haralick et al. (2007)</a> describe how quantitative measures of image texture can help distinguish between different imagery patterns that might have similar spectral signatures but distinct textures (e.g. vegetation types, habitat structures, or disturbance patterns). These textural features are typically calculated on a single-band grayscale image (i.e. panchromatic) but can also be calculated from spectral indicies (e.g. NDVI). Common Haralick statistics include: mean (average pixel value within the window), variance (variation in pixel values), homogeneity, contrast, and entropy (the randomness or disorder of the image)</p>
<p><a href="https://doi.org/10.1002/ecs2.2594">Rodman et al. (2019)</a> also describe a method using a series of image processing steps to add supplemental information describing the texture and context surrounding each image pixel in their analysis of forest cover change based only on panchromatic imagery (i.e. “black and white”). These textural covariates may be helpful for identifying slash piles, especially if we only have RGB data.</p>
<p>first, we’ll make a single panchromatic band (the mean of red, green, and blue values) from our RGB imagery</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="rgb-classification.html#cb41-1" tabindex="-1"></a>rgb_to_pan_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(r, g, b) {</span>
<span id="cb41-2"><a href="rgb-classification.html#cb41-2" tabindex="-1"></a>  pan <span class="ot">&lt;-</span> (r <span class="sc">+</span> g <span class="sc">+</span> b)<span class="sc">/</span><span class="dv">3</span></span>
<span id="cb41-3"><a href="rgb-classification.html#cb41-3" tabindex="-1"></a>  <span class="co"># replace all 0&#39;s with na</span></span>
<span id="cb41-4"><a href="rgb-classification.html#cb41-4" tabindex="-1"></a>  pan <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">subst</span>(pan, <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="cn">NA</span>)</span>
<span id="cb41-5"><a href="rgb-classification.html#cb41-5" tabindex="-1"></a>  <span class="fu">return</span>(pan)</span>
<span id="cb41-6"><a href="rgb-classification.html#cb41-6" tabindex="-1"></a>}</span>
<span id="cb41-7"><a href="rgb-classification.html#cb41-7" tabindex="-1"></a>panchromatic_rast <span class="ot">&lt;-</span> <span class="fu">rgb_to_pan_fn</span>(</span>
<span id="cb41-8"><a href="rgb-classification.html#cb41-8" tabindex="-1"></a>  ortho_rast[[<span class="dv">1</span>]], ortho_rast[[<span class="dv">2</span>]], ortho_rast[[<span class="dv">3</span>]]</span>
<span id="cb41-9"><a href="rgb-classification.html#cb41-9" tabindex="-1"></a>)</span></code></pre></div>
<p>quick plot</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="rgb-classification.html#cb42-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb42-2"><a href="rgb-classification.html#cb42-2" tabindex="-1"></a>  panchromatic_rast</span>
<span id="cb42-3"><a href="rgb-classification.html#cb42-3" tabindex="-1"></a>  , <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">pal_grey</span>(<span class="dv">0</span>, <span class="dv">1</span>)(<span class="dv">100</span>)</span>
<span id="cb42-4"><a href="rgb-classification.html#cb42-4" tabindex="-1"></a>  , <span class="at">axes=</span>F, <span class="at">legend =</span> F</span>
<span id="cb42-5"><a href="rgb-classification.html#cb42-5" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-28-1.png" width="1008" /></p>
<p>nice, now we’ll make the textural covariates described by <a href="https://doi.org/10.1002/ecs2.2594">Rodman et al. (2019)</a> in Appendix S2</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="rgb-classification.html#cb43-1" tabindex="-1"></a>rast_rodmanetal2019_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb43-2"><a href="rgb-classification.html#cb43-2" tabindex="-1"></a>    rast, <span class="at">windows_m =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">9</span>,<span class="dv">11</span>,<span class="dv">13</span>,<span class="dv">15</span>), <span class="at">scale_to_1m =</span> T</span>
<span id="cb43-3"><a href="rgb-classification.html#cb43-3" tabindex="-1"></a>    , <span class="at">rast_nm =</span> <span class="st">&quot;panchromatic&quot;</span></span>
<span id="cb43-4"><a href="rgb-classification.html#cb43-4" tabindex="-1"></a>) {</span>
<span id="cb43-5"><a href="rgb-classification.html#cb43-5" tabindex="-1"></a>  rast <span class="ot">&lt;-</span> rast[[<span class="dv">1</span>]]</span>
<span id="cb43-6"><a href="rgb-classification.html#cb43-6" tabindex="-1"></a>  </span>
<span id="cb43-7"><a href="rgb-classification.html#cb43-7" tabindex="-1"></a>  <span class="co"># scale the windows based on resolution</span></span>
<span id="cb43-8"><a href="rgb-classification.html#cb43-8" tabindex="-1"></a>  <span class="cf">if</span>(scale_to_1m){</span>
<span id="cb43-9"><a href="rgb-classification.html#cb43-9" tabindex="-1"></a>    windows_m <span class="ot">&lt;-</span> <span class="fu">round_to_nearest_odd</span>(</span>
<span id="cb43-10"><a href="rgb-classification.html#cb43-10" tabindex="-1"></a>      (<span class="dv">1</span><span class="sc">/</span>terra<span class="sc">::</span><span class="fu">res</span>(rast)[<span class="dv">1</span>])<span class="sc">*</span>windows_m</span>
<span id="cb43-11"><a href="rgb-classification.html#cb43-11" tabindex="-1"></a>    )</span>
<span id="cb43-12"><a href="rgb-classification.html#cb43-12" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb43-13"><a href="rgb-classification.html#cb43-13" tabindex="-1"></a>    windows_m <span class="ot">&lt;-</span> <span class="fu">round_to_nearest_odd</span>(windows_m)</span>
<span id="cb43-14"><a href="rgb-classification.html#cb43-14" tabindex="-1"></a>  }</span>
<span id="cb43-15"><a href="rgb-classification.html#cb43-15" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-16"><a href="rgb-classification.html#cb43-16" tabindex="-1"></a>  <span class="co"># means</span></span>
<span id="cb43-17"><a href="rgb-classification.html#cb43-17" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-18"><a href="rgb-classification.html#cb43-18" tabindex="-1"></a>  r_means <span class="ot">&lt;-</span> windows_m <span class="sc">%&gt;%</span> </span>
<span id="cb43-19"><a href="rgb-classification.html#cb43-19" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(w)</span>
<span id="cb43-20"><a href="rgb-classification.html#cb43-20" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">x =</span> rast, <span class="at">w =</span> w, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb43-21"><a href="rgb-classification.html#cb43-21" tabindex="-1"></a>    )</span>
<span id="cb43-22"><a href="rgb-classification.html#cb43-22" tabindex="-1"></a>  <span class="co"># r_means[[7]] %&gt;% terra::plot(col = scales::pal_grey(0, 1)(100))</span></span>
<span id="cb43-23"><a href="rgb-classification.html#cb43-23" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-24"><a href="rgb-classification.html#cb43-24" tabindex="-1"></a>  <span class="co"># sds</span></span>
<span id="cb43-25"><a href="rgb-classification.html#cb43-25" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-26"><a href="rgb-classification.html#cb43-26" tabindex="-1"></a>  r_sds <span class="ot">&lt;-</span> windows_m <span class="sc">%&gt;%</span> </span>
<span id="cb43-27"><a href="rgb-classification.html#cb43-27" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(w)</span>
<span id="cb43-28"><a href="rgb-classification.html#cb43-28" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">x =</span> rast, <span class="at">w =</span> w, <span class="at">fun =</span> <span class="st">&quot;sd&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb43-29"><a href="rgb-classification.html#cb43-29" tabindex="-1"></a>    )</span>
<span id="cb43-30"><a href="rgb-classification.html#cb43-30" tabindex="-1"></a>  <span class="co"># r_sds[[5]] %&gt;% terra::plot(col = scales::pal_grey(0, 1)(100))</span></span>
<span id="cb43-31"><a href="rgb-classification.html#cb43-31" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-32"><a href="rgb-classification.html#cb43-32" tabindex="-1"></a>  <span class="co"># local min</span></span>
<span id="cb43-33"><a href="rgb-classification.html#cb43-33" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-34"><a href="rgb-classification.html#cb43-34" tabindex="-1"></a>  local_min_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, mean, sd) {</span>
<span id="cb43-35"><a href="rgb-classification.html#cb43-35" tabindex="-1"></a>    <span class="fu">as.numeric</span>(rast <span class="sc">&lt;</span> ( mean<span class="sc">-</span>(sd<span class="sc">*</span><span class="dv">2</span>) ))</span>
<span id="cb43-36"><a href="rgb-classification.html#cb43-36" tabindex="-1"></a>  }</span>
<span id="cb43-37"><a href="rgb-classification.html#cb43-37" tabindex="-1"></a>  </span>
<span id="cb43-38"><a href="rgb-classification.html#cb43-38" tabindex="-1"></a>  r_local_min <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(r_means) <span class="sc">%&gt;%</span> </span>
<span id="cb43-39"><a href="rgb-classification.html#cb43-39" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(i)</span>
<span id="cb43-40"><a href="rgb-classification.html#cb43-40" tabindex="-1"></a>      <span class="fu">local_min_fn</span>(<span class="at">rast =</span> rast, <span class="at">mean =</span> r_means[[i]], <span class="at">sd =</span> r_sds[[i]])</span>
<span id="cb43-41"><a href="rgb-classification.html#cb43-41" tabindex="-1"></a>    )</span>
<span id="cb43-42"><a href="rgb-classification.html#cb43-42" tabindex="-1"></a>  <span class="co"># r_local_min[[5]] %&gt;% terra::plot()</span></span>
<span id="cb43-43"><a href="rgb-classification.html#cb43-43" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-44"><a href="rgb-classification.html#cb43-44" tabindex="-1"></a>  <span class="co"># local coefficient of variation</span></span>
<span id="cb43-45"><a href="rgb-classification.html#cb43-45" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-46"><a href="rgb-classification.html#cb43-46" tabindex="-1"></a>  local_cv_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(mean, sd) {</span>
<span id="cb43-47"><a href="rgb-classification.html#cb43-47" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">clamp</span>(sd<span class="sc">/</span>mean, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>, <span class="at">values =</span> T)</span>
<span id="cb43-48"><a href="rgb-classification.html#cb43-48" tabindex="-1"></a>  }</span>
<span id="cb43-49"><a href="rgb-classification.html#cb43-49" tabindex="-1"></a>  </span>
<span id="cb43-50"><a href="rgb-classification.html#cb43-50" tabindex="-1"></a>  r_local_cv <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(r_means) <span class="sc">%&gt;%</span> </span>
<span id="cb43-51"><a href="rgb-classification.html#cb43-51" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(i)</span>
<span id="cb43-52"><a href="rgb-classification.html#cb43-52" tabindex="-1"></a>      <span class="fu">local_cv_fn</span>(<span class="at">mean =</span> r_means[[i]], <span class="at">sd =</span> r_sds[[i]])</span>
<span id="cb43-53"><a href="rgb-classification.html#cb43-53" tabindex="-1"></a>    )</span>
<span id="cb43-54"><a href="rgb-classification.html#cb43-54" tabindex="-1"></a>  <span class="co"># r_local_min[[5]] %&gt;% terra::plot()</span></span>
<span id="cb43-55"><a href="rgb-classification.html#cb43-55" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-56"><a href="rgb-classification.html#cb43-56" tabindex="-1"></a>  <span class="co"># aggregate local min</span></span>
<span id="cb43-57"><a href="rgb-classification.html#cb43-57" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-58"><a href="rgb-classification.html#cb43-58" tabindex="-1"></a>  r_local_min_agg <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(r_local_min) <span class="sc">%&gt;%</span> </span>
<span id="cb43-59"><a href="rgb-classification.html#cb43-59" tabindex="-1"></a>    <span class="fu">cumsum</span>()</span>
<span id="cb43-60"><a href="rgb-classification.html#cb43-60" tabindex="-1"></a>  </span>
<span id="cb43-61"><a href="rgb-classification.html#cb43-61" tabindex="-1"></a>  <span class="co"># get the last of the local mins</span></span>
<span id="cb43-62"><a href="rgb-classification.html#cb43-62" tabindex="-1"></a>  local_minima <span class="ot">&lt;-</span> r_local_min_agg[[terra<span class="sc">::</span><span class="fu">nlyr</span>(r_local_min_agg)]]</span>
<span id="cb43-63"><a href="rgb-classification.html#cb43-63" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-64"><a href="rgb-classification.html#cb43-64" tabindex="-1"></a>  <span class="co"># aggregate local cv</span></span>
<span id="cb43-65"><a href="rgb-classification.html#cb43-65" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-66"><a href="rgb-classification.html#cb43-66" tabindex="-1"></a>  r_local_cv_agg <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(r_local_cv) <span class="sc">%&gt;%</span> </span>
<span id="cb43-67"><a href="rgb-classification.html#cb43-67" tabindex="-1"></a>    <span class="fu">cumsum</span>()</span>
<span id="cb43-68"><a href="rgb-classification.html#cb43-68" tabindex="-1"></a>  </span>
<span id="cb43-69"><a href="rgb-classification.html#cb43-69" tabindex="-1"></a>  <span class="co"># get the last of the local cvs</span></span>
<span id="cb43-70"><a href="rgb-classification.html#cb43-70" tabindex="-1"></a>  local_cv <span class="ot">&lt;-</span> r_local_cv_agg[[terra<span class="sc">::</span><span class="fu">nlyr</span>(r_local_cv_agg)]]</span>
<span id="cb43-71"><a href="rgb-classification.html#cb43-71" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-72"><a href="rgb-classification.html#cb43-72" tabindex="-1"></a>  <span class="co"># aggregate local sd</span></span>
<span id="cb43-73"><a href="rgb-classification.html#cb43-73" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-74"><a href="rgb-classification.html#cb43-74" tabindex="-1"></a>  r_sds_agg <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(r_sds) <span class="sc">%&gt;%</span> </span>
<span id="cb43-75"><a href="rgb-classification.html#cb43-75" tabindex="-1"></a>    <span class="fu">cumsum</span>()</span>
<span id="cb43-76"><a href="rgb-classification.html#cb43-76" tabindex="-1"></a>  </span>
<span id="cb43-77"><a href="rgb-classification.html#cb43-77" tabindex="-1"></a>  <span class="co"># get the last of the local sds</span></span>
<span id="cb43-78"><a href="rgb-classification.html#cb43-78" tabindex="-1"></a>  local_sd <span class="ot">&lt;-</span> r_sds_agg[[terra<span class="sc">::</span><span class="fu">nlyr</span>(r_sds_agg)]]</span>
<span id="cb43-79"><a href="rgb-classification.html#cb43-79" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-80"><a href="rgb-classification.html#cb43-80" tabindex="-1"></a>  <span class="co"># aggregate local mean</span></span>
<span id="cb43-81"><a href="rgb-classification.html#cb43-81" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-82"><a href="rgb-classification.html#cb43-82" tabindex="-1"></a>  r_means_agg <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(r_means) <span class="sc">%&gt;%</span> </span>
<span id="cb43-83"><a href="rgb-classification.html#cb43-83" tabindex="-1"></a>    <span class="fu">cumsum</span>()</span>
<span id="cb43-84"><a href="rgb-classification.html#cb43-84" tabindex="-1"></a>  </span>
<span id="cb43-85"><a href="rgb-classification.html#cb43-85" tabindex="-1"></a>  <span class="co"># get the last of the local mean</span></span>
<span id="cb43-86"><a href="rgb-classification.html#cb43-86" tabindex="-1"></a>  local_mean <span class="ot">&lt;-</span> r_means_agg[[terra<span class="sc">::</span><span class="fu">nlyr</span>(r_means_agg)]]</span>
<span id="cb43-87"><a href="rgb-classification.html#cb43-87" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-88"><a href="rgb-classification.html#cb43-88" tabindex="-1"></a>  <span class="co"># composite</span></span>
<span id="cb43-89"><a href="rgb-classification.html#cb43-89" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb43-90"><a href="rgb-classification.html#cb43-90" tabindex="-1"></a>  composite <span class="ot">&lt;-</span> <span class="fu">c</span>(rast, local_sd, local_minima)</span>
<span id="cb43-91"><a href="rgb-classification.html#cb43-91" tabindex="-1"></a>  <span class="fu">names</span>(composite) <span class="ot">&lt;-</span> <span class="fu">c</span>(rast_nm, <span class="st">&quot;local_sd&quot;</span>, <span class="st">&quot;local_minima&quot;</span>)</span>
<span id="cb43-92"><a href="rgb-classification.html#cb43-92" tabindex="-1"></a>  </span>
<span id="cb43-93"><a href="rgb-classification.html#cb43-93" tabindex="-1"></a>  <span class="co"># names</span></span>
<span id="cb43-94"><a href="rgb-classification.html#cb43-94" tabindex="-1"></a>  <span class="fu">names</span>(local_minima) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;local_minima&quot;</span>)</span>
<span id="cb43-95"><a href="rgb-classification.html#cb43-95" tabindex="-1"></a>  <span class="fu">names</span>(local_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;local_sd&quot;</span>)</span>
<span id="cb43-96"><a href="rgb-classification.html#cb43-96" tabindex="-1"></a>  </span>
<span id="cb43-97"><a href="rgb-classification.html#cb43-97" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb43-98"><a href="rgb-classification.html#cb43-98" tabindex="-1"></a>    <span class="at">local_minima =</span> local_minima</span>
<span id="cb43-99"><a href="rgb-classification.html#cb43-99" tabindex="-1"></a>    , <span class="at">local_sd =</span> local_sd</span>
<span id="cb43-100"><a href="rgb-classification.html#cb43-100" tabindex="-1"></a>    , <span class="at">local_mean =</span> local_mean</span>
<span id="cb43-101"><a href="rgb-classification.html#cb43-101" tabindex="-1"></a>    , <span class="at">local_cv =</span> local_cv</span>
<span id="cb43-102"><a href="rgb-classification.html#cb43-102" tabindex="-1"></a>    , <span class="at">composite =</span> composite</span>
<span id="cb43-103"><a href="rgb-classification.html#cb43-103" tabindex="-1"></a>  ))</span>
<span id="cb43-104"><a href="rgb-classification.html#cb43-104" tabindex="-1"></a>}</span></code></pre></div>
<div id="raster-texture-panchromatic" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Raster Texture: Panchromatic<a href="rgb-classification.html#raster-texture-panchromatic" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>implement our <code>rast_rodmanetal2019_fn</code> function</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="rgb-classification.html#cb44-1" tabindex="-1"></a>rodmanetal2019_panchromatic_rast <span class="ot">&lt;-</span> <span class="fu">rast_rodmanetal2019_fn</span>(</span>
<span id="cb44-2"><a href="rgb-classification.html#cb44-2" tabindex="-1"></a>  <span class="at">rast =</span> panchromatic_rast</span>
<span id="cb44-3"><a href="rgb-classification.html#cb44-3" tabindex="-1"></a>  , <span class="at">rast_nm =</span> <span class="st">&quot;panchromatic&quot;</span></span>
<span id="cb44-4"><a href="rgb-classification.html#cb44-4" tabindex="-1"></a>  , <span class="at">scale_to_1m =</span> F</span>
<span id="cb44-5"><a href="rgb-classification.html#cb44-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          </code></pre>
<p>plot of standard deviation pixel brightness which is a simple version of local texture that can improve forest classification in high-resolution imagery</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="rgb-classification.html#cb46-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb46-2"><a href="rgb-classification.html#cb46-2" tabindex="-1"></a>  rodmanetal2019_panchromatic_rast<span class="sc">$</span>local_sd</span>
<span id="cb46-3"><a href="rgb-classification.html#cb46-3" tabindex="-1"></a>  , <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">pal_grey</span>(<span class="dv">0</span>, <span class="dv">1</span>)(<span class="dv">100</span>)</span>
<span id="cb46-4"><a href="rgb-classification.html#cb46-4" tabindex="-1"></a>  , <span class="at">axes=</span>F, <span class="at">legend =</span> F</span>
<span id="cb46-5"><a href="rgb-classification.html#cb46-5" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-32-1.png" width="1008" /></p>
<p>plot of these combined panchromatic, local minima, and standard deviation images were merged to create a three-band composite which can be segmented to identify areas of relatively homogeneous brightness, contrast, and variance</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="rgb-classification.html#cb47-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(</span>
<span id="cb47-2"><a href="rgb-classification.html#cb47-2" tabindex="-1"></a>  rodmanetal2019_panchromatic_rast<span class="sc">$</span>composite</span>
<span id="cb47-3"><a href="rgb-classification.html#cb47-3" tabindex="-1"></a>  <span class="co"># , scale = c(255,7,520)</span></span>
<span id="cb47-4"><a href="rgb-classification.html#cb47-4" tabindex="-1"></a>  , <span class="at">stretch =</span> <span class="st">&quot;hist&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span></span>
<span id="cb47-5"><a href="rgb-classification.html#cb47-5" tabindex="-1"></a>)</span>
<span id="cb47-6"><a href="rgb-classification.html#cb47-6" tabindex="-1"></a><span class="co"># add polys</span></span>
<span id="cb47-7"><a href="rgb-classification.html#cb47-7" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb47-8"><a href="rgb-classification.html#cb47-8" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb47-9"><a href="rgb-classification.html#cb47-9" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span></span>
<span id="cb47-10"><a href="rgb-classification.html#cb47-10" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-33-1.png" width="1008" /></p>
</div>
<div id="raster-texture-grvi" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Raster Texture: GRVI<a href="rgb-classification.html#raster-texture-grvi" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>implement our <code>rast_rodmanetal2019_fn</code> function</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="rgb-classification.html#cb48-1" tabindex="-1"></a>rodmanetal2019_grvi_rast <span class="ot">&lt;-</span> <span class="fu">rast_rodmanetal2019_fn</span>(</span>
<span id="cb48-2"><a href="rgb-classification.html#cb48-2" tabindex="-1"></a>  <span class="at">rast =</span> grvi_rast</span>
<span id="cb48-3"><a href="rgb-classification.html#cb48-3" tabindex="-1"></a>  , <span class="at">rast_nm =</span> <span class="st">&quot;grvi&quot;</span></span>
<span id="cb48-4"><a href="rgb-classification.html#cb48-4" tabindex="-1"></a>  , <span class="at">scale_to_1m =</span> F</span>
<span id="cb48-5"><a href="rgb-classification.html#cb48-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          </code></pre>
<p>plot of these combined GRVI</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="rgb-classification.html#cb50-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(</span>
<span id="cb50-2"><a href="rgb-classification.html#cb50-2" tabindex="-1"></a>  rodmanetal2019_grvi_rast<span class="sc">$</span>composite</span>
<span id="cb50-3"><a href="rgb-classification.html#cb50-3" tabindex="-1"></a>  <span class="co"># , scale = c(255,7,520)</span></span>
<span id="cb50-4"><a href="rgb-classification.html#cb50-4" tabindex="-1"></a>  , <span class="at">stretch =</span> <span class="st">&quot;hist&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span></span>
<span id="cb50-5"><a href="rgb-classification.html#cb50-5" tabindex="-1"></a>)</span>
<span id="cb50-6"><a href="rgb-classification.html#cb50-6" tabindex="-1"></a><span class="co"># add polys</span></span>
<span id="cb50-7"><a href="rgb-classification.html#cb50-7" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb50-8"><a href="rgb-classification.html#cb50-8" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb50-9"><a href="rgb-classification.html#cb50-9" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span></span>
<span id="cb50-10"><a href="rgb-classification.html#cb50-10" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-36-1.png" width="1008" /></p>
<p>check out the local CV of GRVI</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="rgb-classification.html#cb51-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb51-2"><a href="rgb-classification.html#cb51-2" tabindex="-1"></a>  rodmanetal2019_grvi_rast<span class="sc">$</span>local_cv</span>
<span id="cb51-3"><a href="rgb-classification.html#cb51-3" tabindex="-1"></a>  , <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">pal_grey</span>(<span class="dv">0</span>, <span class="dv">1</span>)(<span class="dv">100</span>)</span>
<span id="cb51-4"><a href="rgb-classification.html#cb51-4" tabindex="-1"></a>  , <span class="at">axes=</span>F, <span class="at">legend =</span> F</span>
<span id="cb51-5"><a href="rgb-classification.html#cb51-5" tabindex="-1"></a>)</span>
<span id="cb51-6"><a href="rgb-classification.html#cb51-6" tabindex="-1"></a><span class="co"># add polys</span></span>
<span id="cb51-7"><a href="rgb-classification.html#cb51-7" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb51-8"><a href="rgb-classification.html#cb51-8" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb51-9"><a href="rgb-classification.html#cb51-9" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span></span>
<span id="cb51-10"><a href="rgb-classification.html#cb51-10" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-37-1.png" width="1008" /></p>
<p>this metric looks promising as it indicates that piles are generally in areas with low CV…which indicates low variability, meaning the GRVI values are tightly clustered around the focal mean, suggesting consistency and stability.</p>
</div>
<div id="plot-textural-rasters" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Plot textural rasters<a href="rgb-classification.html#plot-textural-rasters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s look at these textural rasters for some of the piles</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="rgb-classification.html#cb52-1" tabindex="-1"></a>p_fn_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb52-2"><a href="rgb-classification.html#cb52-2" tabindex="-1"></a>    rn</span>
<span id="cb52-3"><a href="rgb-classification.html#cb52-3" tabindex="-1"></a>    , <span class="at">df =</span> slash_piles_polys</span>
<span id="cb52-4"><a href="rgb-classification.html#cb52-4" tabindex="-1"></a>    , <span class="at">composite_rast =</span> rodmanetal2019_grvi_rast<span class="sc">$</span>composite</span>
<span id="cb52-5"><a href="rgb-classification.html#cb52-5" tabindex="-1"></a>    , <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)</span>
<span id="cb52-6"><a href="rgb-classification.html#cb52-6" tabindex="-1"></a>    , <span class="at">my_title =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb52-7"><a href="rgb-classification.html#cb52-7" tabindex="-1"></a>) {</span>
<span id="cb52-8"><a href="rgb-classification.html#cb52-8" tabindex="-1"></a>  <span class="co"># scale the buffer based on the largest</span></span>
<span id="cb52-9"><a href="rgb-classification.html#cb52-9" tabindex="-1"></a>    d_temp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb52-10"><a href="rgb-classification.html#cb52-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">tolower</span>(comment), <span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-11"><a href="rgb-classification.html#cb52-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(rn) <span class="sc">%&gt;%</span> </span>
<span id="cb52-12"><a href="rgb-classification.html#cb52-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(crs)</span>
<span id="cb52-13"><a href="rgb-classification.html#cb52-13" tabindex="-1"></a>    </span>
<span id="cb52-14"><a href="rgb-classification.html#cb52-14" tabindex="-1"></a>    <span class="co"># plt classifier</span></span>
<span id="cb52-15"><a href="rgb-classification.html#cb52-15" tabindex="-1"></a>    <span class="co"># convert to stars</span></span>
<span id="cb52-16"><a href="rgb-classification.html#cb52-16" tabindex="-1"></a>    comp_st <span class="ot">&lt;-</span> composite_rast <span class="sc">%&gt;%</span>  </span>
<span id="cb52-17"><a href="rgb-classification.html#cb52-17" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-18"><a href="rgb-classification.html#cb52-18" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb52-19"><a href="rgb-classification.html#cb52-19" tabindex="-1"></a>        d_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb52-20"><a href="rgb-classification.html#cb52-20" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb52-21"><a href="rgb-classification.html#cb52-21" tabindex="-1"></a>      <span class="co"># terra::aggregate(fact = 2, fun = &quot;mean&quot;, na.rm = T) %&gt;% </span></span>
<span id="cb52-22"><a href="rgb-classification.html#cb52-22" tabindex="-1"></a>      stars<span class="sc">::</span><span class="fu">st_as_stars</span>()</span>
<span id="cb52-23"><a href="rgb-classification.html#cb52-23" tabindex="-1"></a>    </span>
<span id="cb52-24"><a href="rgb-classification.html#cb52-24" tabindex="-1"></a>    <span class="co"># convert to rgb</span></span>
<span id="cb52-25"><a href="rgb-classification.html#cb52-25" tabindex="-1"></a>    comp_rgb <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">st_rgb</span>(</span>
<span id="cb52-26"><a href="rgb-classification.html#cb52-26" tabindex="-1"></a>      comp_st[,,,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb52-27"><a href="rgb-classification.html#cb52-27" tabindex="-1"></a>      , <span class="at">dimension =</span> <span class="dv">3</span></span>
<span id="cb52-28"><a href="rgb-classification.html#cb52-28" tabindex="-1"></a>      , <span class="at">use_alpha =</span> <span class="cn">FALSE</span></span>
<span id="cb52-29"><a href="rgb-classification.html#cb52-29" tabindex="-1"></a>      <span class="co"># , stretch = &quot;histogram&quot;</span></span>
<span id="cb52-30"><a href="rgb-classification.html#cb52-30" tabindex="-1"></a>      , <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.002</span>, <span class="fl">0.998</span>)</span>
<span id="cb52-31"><a href="rgb-classification.html#cb52-31" tabindex="-1"></a>      , <span class="at">stretch =</span> <span class="st">&quot;percent&quot;</span></span>
<span id="cb52-32"><a href="rgb-classification.html#cb52-32" tabindex="-1"></a>    )</span>
<span id="cb52-33"><a href="rgb-classification.html#cb52-33" tabindex="-1"></a>    <span class="co"># ggplot</span></span>
<span id="cb52-34"><a href="rgb-classification.html#cb52-34" tabindex="-1"></a>    comp_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb52-35"><a href="rgb-classification.html#cb52-35" tabindex="-1"></a>      stars<span class="sc">::</span><span class="fu">geom_stars</span>(<span class="at">data =</span> comp_rgb[]) <span class="sc">+</span></span>
<span id="cb52-36"><a href="rgb-classification.html#cb52-36" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_identity</span>(<span class="at">na.value =</span> <span class="st">&quot;transparent&quot;</span>) <span class="sc">+</span> <span class="co"># !!! don&#39;t take this out or RGB plot will kill your computer</span></span>
<span id="cb52-37"><a href="rgb-classification.html#cb52-37" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> d_temp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb52-38"><a href="rgb-classification.html#cb52-38" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb52-39"><a href="rgb-classification.html#cb52-39" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb52-40"><a href="rgb-classification.html#cb52-40" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb52-41"><a href="rgb-classification.html#cb52-41" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb52-42"><a href="rgb-classification.html#cb52-42" tabindex="-1"></a>        , <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb52-43"><a href="rgb-classification.html#cb52-43" tabindex="-1"></a>        , <span class="at">subtitle =</span> my_title</span>
<span id="cb52-44"><a href="rgb-classification.html#cb52-44" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb52-45"><a href="rgb-classification.html#cb52-45" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb52-46"><a href="rgb-classification.html#cb52-46" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb52-47"><a href="rgb-classification.html#cb52-47" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span> <span class="co"># c(0.5,1)</span></span>
<span id="cb52-48"><a href="rgb-classification.html#cb52-48" tabindex="-1"></a>        , <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span></span>
<span id="cb52-49"><a href="rgb-classification.html#cb52-49" tabindex="-1"></a>        , <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb52-50"><a href="rgb-classification.html#cb52-50" tabindex="-1"></a>        , <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb52-51"><a href="rgb-classification.html#cb52-51" tabindex="-1"></a>        , <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb52-52"><a href="rgb-classification.html#cb52-52" tabindex="-1"></a>        , <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb52-53"><a href="rgb-classification.html#cb52-53" tabindex="-1"></a>        <span class="co"># , plot.title = ggtext::element_markdown(size = 10, hjust = 0.5)</span></span>
<span id="cb52-54"><a href="rgb-classification.html#cb52-54" tabindex="-1"></a>        , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb52-55"><a href="rgb-classification.html#cb52-55" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)</span>
<span id="cb52-56"><a href="rgb-classification.html#cb52-56" tabindex="-1"></a>      )</span>
<span id="cb52-57"><a href="rgb-classification.html#cb52-57" tabindex="-1"></a>    </span>
<span id="cb52-58"><a href="rgb-classification.html#cb52-58" tabindex="-1"></a>  plt_temp <span class="ot">&lt;-</span> comp_temp</span>
<span id="cb52-59"><a href="rgb-classification.html#cb52-59" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;plt&quot;</span><span class="ot">=</span>plt_temp,<span class="st">&quot;d&quot;</span><span class="ot">=</span>d_temp))</span>
<span id="cb52-60"><a href="rgb-classification.html#cb52-60" tabindex="-1"></a>}</span>
<span id="cb52-61"><a href="rgb-classification.html#cb52-61" tabindex="-1"></a><span class="co"># combine 3</span></span>
<span id="cb52-62"><a href="rgb-classification.html#cb52-62" tabindex="-1"></a>plt_combine_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb52-63"><a href="rgb-classification.html#cb52-63" tabindex="-1"></a>    rn</span>
<span id="cb52-64"><a href="rgb-classification.html#cb52-64" tabindex="-1"></a>    , <span class="at">df =</span> slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))</span>
<span id="cb52-65"><a href="rgb-classification.html#cb52-65" tabindex="-1"></a>    , <span class="at">composite_rast1 =</span> rodmanetal2019_panchromatic_rast<span class="sc">$</span>composite</span>
<span id="cb52-66"><a href="rgb-classification.html#cb52-66" tabindex="-1"></a>    , <span class="at">title1 =</span> <span class="st">&quot;panchromatic composite&quot;</span></span>
<span id="cb52-67"><a href="rgb-classification.html#cb52-67" tabindex="-1"></a>    , <span class="at">composite_rast2 =</span> rodmanetal2019_grvi_rast<span class="sc">$</span>composite</span>
<span id="cb52-68"><a href="rgb-classification.html#cb52-68" tabindex="-1"></a>    , <span class="at">title2 =</span> <span class="st">&quot;GRVI composite&quot;</span></span>
<span id="cb52-69"><a href="rgb-classification.html#cb52-69" tabindex="-1"></a>    , <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)</span>
<span id="cb52-70"><a href="rgb-classification.html#cb52-70" tabindex="-1"></a>) {</span>
<span id="cb52-71"><a href="rgb-classification.html#cb52-71" tabindex="-1"></a>  <span class="co"># composite 1</span></span>
<span id="cb52-72"><a href="rgb-classification.html#cb52-72" tabindex="-1"></a>  ans1 <span class="ot">&lt;-</span> <span class="fu">p_fn_temp</span>(</span>
<span id="cb52-73"><a href="rgb-classification.html#cb52-73" tabindex="-1"></a>    <span class="at">rn =</span> rn</span>
<span id="cb52-74"><a href="rgb-classification.html#cb52-74" tabindex="-1"></a>    , <span class="at">df =</span> df</span>
<span id="cb52-75"><a href="rgb-classification.html#cb52-75" tabindex="-1"></a>    , <span class="at">composite_rast =</span> composite_rast1</span>
<span id="cb52-76"><a href="rgb-classification.html#cb52-76" tabindex="-1"></a>    , <span class="at">my_title =</span> title1</span>
<span id="cb52-77"><a href="rgb-classification.html#cb52-77" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb52-78"><a href="rgb-classification.html#cb52-78" tabindex="-1"></a>  )</span>
<span id="cb52-79"><a href="rgb-classification.html#cb52-79" tabindex="-1"></a>  <span class="co"># composite 2</span></span>
<span id="cb52-80"><a href="rgb-classification.html#cb52-80" tabindex="-1"></a>  ans2 <span class="ot">&lt;-</span> <span class="fu">p_fn_temp</span>(</span>
<span id="cb52-81"><a href="rgb-classification.html#cb52-81" tabindex="-1"></a>    <span class="at">rn =</span> rn</span>
<span id="cb52-82"><a href="rgb-classification.html#cb52-82" tabindex="-1"></a>    , <span class="at">df =</span> df</span>
<span id="cb52-83"><a href="rgb-classification.html#cb52-83" tabindex="-1"></a>    , <span class="at">composite_rast =</span> composite_rast2</span>
<span id="cb52-84"><a href="rgb-classification.html#cb52-84" tabindex="-1"></a>    , <span class="at">my_title =</span> title2</span>
<span id="cb52-85"><a href="rgb-classification.html#cb52-85" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb52-86"><a href="rgb-classification.html#cb52-86" tabindex="-1"></a>  )</span>
<span id="cb52-87"><a href="rgb-classification.html#cb52-87" tabindex="-1"></a>  <span class="co"># plt rgb</span></span>
<span id="cb52-88"><a href="rgb-classification.html#cb52-88" tabindex="-1"></a>    rgb_temp <span class="ot">&lt;-</span></span>
<span id="cb52-89"><a href="rgb-classification.html#cb52-89" tabindex="-1"></a>      <span class="fu">ortho_plt_fn</span>(ans1<span class="sc">$</span>d) <span class="sc">+</span> </span>
<span id="cb52-90"><a href="rgb-classification.html#cb52-90" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> ans1<span class="sc">$</span>d, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>)</span>
<span id="cb52-91"><a href="rgb-classification.html#cb52-91" tabindex="-1"></a>  <span class="co"># combine</span></span>
<span id="cb52-92"><a href="rgb-classification.html#cb52-92" tabindex="-1"></a>    r <span class="ot">&lt;-</span> ans1<span class="sc">$</span>plt <span class="sc">+</span> ans2<span class="sc">$</span>plt <span class="sc">+</span> rgb_temp</span>
<span id="cb52-93"><a href="rgb-classification.html#cb52-93" tabindex="-1"></a>    <span class="fu">return</span>(r)</span>
<span id="cb52-94"><a href="rgb-classification.html#cb52-94" tabindex="-1"></a>}</span>
<span id="cb52-95"><a href="rgb-classification.html#cb52-95" tabindex="-1"></a></span>
<span id="cb52-96"><a href="rgb-classification.html#cb52-96" tabindex="-1"></a><span class="co"># add pile locations</span></span>
<span id="cb52-97"><a href="rgb-classification.html#cb52-97" tabindex="-1"></a>plt_list_grvi_comp <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))),<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-98"><a href="rgb-classification.html#cb52-98" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(plt_combine_temp)</span>
<span id="cb52-99"><a href="rgb-classification.html#cb52-99" tabindex="-1"></a><span class="co"># plt_list_grvi_comp[[2]]</span></span></code></pre></div>
<p>combine the plots for a few piles</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="rgb-classification.html#cb53-1" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb53-2"><a href="rgb-classification.html#cb53-2" tabindex="-1"></a>  plt_list_grvi_comp</span>
<span id="cb53-3"><a href="rgb-classification.html#cb53-3" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb53-4"><a href="rgb-classification.html#cb53-4" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-39-1.png" width="1008" /></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="rgb-classification.html#cb54-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/pile_tiles_texture.jpeg&quot;</span>, <span class="at">height =</span> <span class="fl">10.5</span>, <span class="at">width =</span> <span class="dv">5</span>)</span></code></pre></div>
</div>
<div id="features-for-classification" class="section level3 hasAnchor" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> Features for classification<a href="rgb-classification.html#features-for-classification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><a href="https://doi.org/10.1016/j.jag.2018.11.011">Goncalves et al. (2019)</a> describe the general workflow of the OBIA approach for ecological applications based on Genetic Algorithms (GA) to optimize image segmentation parameters:</p>
<ol style="list-style-type: decimal">
<li>Run the image segmentation: involves the partitioning of an image into a set of jointly exhaustive and mutually disjoint regions (a.k.a. segments, composed by multiple image pixels) that are internally more homogeneous and similar compared to adjacent ones;
<ul>
<li>segmentation algorithms include: mean-shift; region growing; SNIC (Simple Non-iterative Clustering) and SLIC (Simple Linear Iterative Clustering)</li>
</ul></li>
<li>Load training data into the segmented image;</li>
<li>Calculate segment statistics (e.g., mean, standard-deviation) for classification features;</li>
<li>Merge training and segment statistics data (steps 2-3);</li>
<li>Do train/test data partitions (e.g., 5-fold cross-validation);</li>
<li>For each train/test set:
6.1. Train the supervised classifier;
6.2. Evaluate results for the test set;</li>
<li>Return the average evaluation score across all train/test rounds (fitness value);</li>
</ol>
<p>where:</p>
<ul>
<li>Segmentation features (step 1): a multi-layer raster dataset with features used only for the segmentation stage (e.g., spectral bands)</li>
<li>Classification features (step 3): a multi-layer raster dataset with features used for classification (e.g., spectral data, band ratios, spectral vegetation indices, texture features, topographic data).</li>
</ul>
<p>let’s combine our rasters into a raster stack and generate a data frame with individual cells as rows and covariates as columns</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="rgb-classification.html#cb55-1" tabindex="-1"></a><span class="co">#rename composites</span></span>
<span id="cb55-2"><a href="rgb-classification.html#cb55-2" tabindex="-1"></a><span class="fu">names</span>(rodmanetal2019_panchromatic_rast<span class="sc">$</span>composite) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb55-3"><a href="rgb-classification.html#cb55-3" tabindex="-1"></a>  <span class="st">&quot;panchromatic&quot;</span>, <span class="st">&quot;panchromatic_local_sd&quot;</span>, <span class="st">&quot;panchromatic_local_minima&quot;</span></span>
<span id="cb55-4"><a href="rgb-classification.html#cb55-4" tabindex="-1"></a>)</span>
<span id="cb55-5"><a href="rgb-classification.html#cb55-5" tabindex="-1"></a><span class="fu">names</span>(rodmanetal2019_panchromatic_rast<span class="sc">$</span>local_cv) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb55-6"><a href="rgb-classification.html#cb55-6" tabindex="-1"></a>  <span class="st">&quot;panchromatic_local_cv&quot;</span></span>
<span id="cb55-7"><a href="rgb-classification.html#cb55-7" tabindex="-1"></a>)</span>
<span id="cb55-8"><a href="rgb-classification.html#cb55-8" tabindex="-1"></a><span class="fu">names</span>(rodmanetal2019_grvi_rast<span class="sc">$</span>composite) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb55-9"><a href="rgb-classification.html#cb55-9" tabindex="-1"></a>  <span class="st">&quot;grvi&quot;</span>, <span class="st">&quot;grvi_local_sd&quot;</span>, <span class="st">&quot;grvi_local_minima&quot;</span></span>
<span id="cb55-10"><a href="rgb-classification.html#cb55-10" tabindex="-1"></a>)</span>
<span id="cb55-11"><a href="rgb-classification.html#cb55-11" tabindex="-1"></a><span class="fu">names</span>(rodmanetal2019_grvi_rast<span class="sc">$</span>local_cv) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb55-12"><a href="rgb-classification.html#cb55-12" tabindex="-1"></a>  <span class="st">&quot;grvi_local_cv&quot;</span></span>
<span id="cb55-13"><a href="rgb-classification.html#cb55-13" tabindex="-1"></a>)</span>
<span id="cb55-14"><a href="rgb-classification.html#cb55-14" tabindex="-1"></a><span class="co"># raster stack</span></span>
<span id="cb55-15"><a href="rgb-classification.html#cb55-15" tabindex="-1"></a>pred_rast <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb55-16"><a href="rgb-classification.html#cb55-16" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">subset</span>(ortho_rast, <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;blue&quot;</span>))</span>
<span id="cb55-17"><a href="rgb-classification.html#cb55-17" tabindex="-1"></a>  , rodmanetal2019_panchromatic_rast<span class="sc">$</span>composite</span>
<span id="cb55-18"><a href="rgb-classification.html#cb55-18" tabindex="-1"></a>  , rodmanetal2019_panchromatic_rast<span class="sc">$</span>local_cv</span>
<span id="cb55-19"><a href="rgb-classification.html#cb55-19" tabindex="-1"></a>  , rodmanetal2019_grvi_rast<span class="sc">$</span>composite</span>
<span id="cb55-20"><a href="rgb-classification.html#cb55-20" tabindex="-1"></a>  , rodmanetal2019_grvi_rast<span class="sc">$</span>local_cv</span>
<span id="cb55-21"><a href="rgb-classification.html#cb55-21" tabindex="-1"></a>)</span>
<span id="cb55-22"><a href="rgb-classification.html#cb55-22" tabindex="-1"></a><span class="co"># mask NA values from original data</span></span>
<span id="cb55-23"><a href="rgb-classification.html#cb55-23" tabindex="-1"></a>pred_rast <span class="ot">&lt;-</span> pred_rast <span class="sc">%&gt;%</span> </span>
<span id="cb55-24"><a href="rgb-classification.html#cb55-24" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb55-25"><a href="rgb-classification.html#cb55-25" tabindex="-1"></a>    ortho_rast <span class="sc">%&gt;%</span> </span>
<span id="cb55-26"><a href="rgb-classification.html#cb55-26" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">subset</span>(<span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;blue&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-27"><a href="rgb-classification.html#cb55-27" tabindex="-1"></a>      <span class="fu">cumsum</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb55-28"><a href="rgb-classification.html#cb55-28" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-29"><a href="rgb-classification.html#cb55-29" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">subst</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb55-30"><a href="rgb-classification.html#cb55-30" tabindex="-1"></a>    , <span class="at">inverse =</span> T</span>
<span id="cb55-31"><a href="rgb-classification.html#cb55-31" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="rgb-classification.html#cb57-1" tabindex="-1"></a><span class="co"># pred_rast %&gt;% names()</span></span></code></pre></div>
<p>check out correlations between covariates</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="rgb-classification.html#cb58-1" tabindex="-1"></a><span class="co"># investigate correlation among covariates</span></span>
<span id="cb58-2"><a href="rgb-classification.html#cb58-2" tabindex="-1"></a>pred_rast <span class="sc">%&gt;%</span> </span>
<span id="cb58-3"><a href="rgb-classification.html#cb58-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">pairs</span>(</span>
<span id="cb58-4"><a href="rgb-classification.html#cb58-4" tabindex="-1"></a>    <span class="at">maxcells =</span> <span class="fu">min</span>(<span class="dv">7777</span>, terra<span class="sc">::</span><span class="fu">ncell</span>(pred_rast)<span class="sc">*</span>.<span class="dv">01</span>)</span>
<span id="cb58-5"><a href="rgb-classification.html#cb58-5" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-41-1.png" width="1008" /></p>
<p>the panchromatic band itself doesn’t add much new information, let’s remove it and generate a data frame for training our clustering algorithms</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="rgb-classification.html#cb59-1" tabindex="-1"></a><span class="co"># remove correlated layers</span></span>
<span id="cb59-2"><a href="rgb-classification.html#cb59-2" tabindex="-1"></a>pred_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">subset</span>(</span>
<span id="cb59-3"><a href="rgb-classification.html#cb59-3" tabindex="-1"></a>  pred_rast</span>
<span id="cb59-4"><a href="rgb-classification.html#cb59-4" tabindex="-1"></a>  , <span class="at">subset =</span> <span class="fu">c</span>(<span class="st">&quot;panchromatic&quot;</span>)</span>
<span id="cb59-5"><a href="rgb-classification.html#cb59-5" tabindex="-1"></a>  , <span class="at">negate =</span> T</span>
<span id="cb59-6"><a href="rgb-classification.html#cb59-6" tabindex="-1"></a>)</span>
<span id="cb59-7"><a href="rgb-classification.html#cb59-7" tabindex="-1"></a><span class="co"># combine rasters as data frame</span></span>
<span id="cb59-8"><a href="rgb-classification.html#cb59-8" tabindex="-1"></a>pred_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">as.data.frame</span>(</span>
<span id="cb59-9"><a href="rgb-classification.html#cb59-9" tabindex="-1"></a>    pred_rast</span>
<span id="cb59-10"><a href="rgb-classification.html#cb59-10" tabindex="-1"></a>    , <span class="at">xy =</span> T</span>
<span id="cb59-11"><a href="rgb-classification.html#cb59-11" tabindex="-1"></a>    , <span class="at">cell =</span> T</span>
<span id="cb59-12"><a href="rgb-classification.html#cb59-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb59-13"><a href="rgb-classification.html#cb59-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb59-14"><a href="rgb-classification.html#cb59-14" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb59-15"><a href="rgb-classification.html#cb59-15" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(red,green,blue)</span>
<span id="cb59-16"><a href="rgb-classification.html#cb59-16" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(.x<span class="sc">==</span><span class="dv">0</span>,<span class="cn">NA</span>,.x)</span>
<span id="cb59-17"><a href="rgb-classification.html#cb59-17" tabindex="-1"></a>    )</span>
<span id="cb59-18"><a href="rgb-classification.html#cb59-18" tabindex="-1"></a>  )</span>
<span id="cb59-19"><a href="rgb-classification.html#cb59-19" tabindex="-1"></a><span class="co"># what is this data?</span></span>
<span id="cb59-20"><a href="rgb-classification.html#cb59-20" tabindex="-1"></a>pred_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">100</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 100
## Columns: 13
## $ cell                      &lt;dbl&gt; 3783340, 12823481, 1188704, 3630013, 1394345…
## $ x                         &lt;dbl&gt; 499368.9, 499349.2, 499369.5, 499585.0, 4993…
## $ y                         &lt;dbl&gt; 4318015, 4317717, 4318100, 4318020, 4317680,…
## $ red                       &lt;dbl&gt; 109.89790, 108.89064, 22.85625, 112.62171, 1…
## $ green                     &lt;dbl&gt; 104.60313, 109.06528, 20.22625, 135.81041, 1…
## $ blue                      &lt;dbl&gt; 98.22230, 74.58000, 18.40992, 77.99252, 128.…
## $ panchromatic_local_sd     &lt;dbl&gt; 133.68938, 76.37708, 104.15176, 108.46442, 8…
## $ panchromatic_local_minima &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ panchromatic_local_cv     &lt;dbl&gt; 1.0549057, 0.7367595, 3.4507045, 1.1899530, …
## $ grvi                      &lt;dbl&gt; -0.0246840850, 0.0008012484, -0.0610456616, …
## $ grvi_local_sd             &lt;dbl&gt; 0.10287406, 0.19633968, 0.31717706, 0.156255…
## $ grvi_local_minima         &lt;dbl&gt; 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ grvi_local_cv             &lt;dbl&gt; 0.000000, 2.000000, 5.000000, 1.888364, 0.00…</code></pre>
</div>
</div>
<div id="pixel-based-unsupervised-classification" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Pixel-based: unsupervised classification<a href="rgb-classification.html#pixel-based-unsupervised-classification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Unsupervised image classification could be used to identify slash piles by grouping pixels with similar spectral characteristics. We’ll call any method that implements classification at the pixel level like the unsupervised classification approach tested here “pixel-based image analysis” versus to OBIA. Unsupervised image classification uses algorithms like K-means to find natural clusters within spectral data and can use other inputs like elevation or spectral indices. This method operates without requiring pre-defined training data, making it useful when field data is limited. The output assigns each pixel to a class, which the user then interprets to potentially identify slash piles based on their distinct spectral signatures and elevated height. While effective for initial classification and pattern recognition, unsupervised methods can produce numerous classes that require manual interpretation and may be less accurate than supervised approaches without ground truth data.</p>
<p>let’s test out kmeans clustering and see what we get</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="rgb-classification.html#cb61-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">111</span>)</span>
<span id="cb61-2"><a href="rgb-classification.html#cb61-2" tabindex="-1"></a><span class="co"># Create 6 clusters, allow 500 iterations, start with 5 random sets using &quot;Lloyd&quot;</span></span>
<span id="cb61-3"><a href="rgb-classification.html#cb61-3" tabindex="-1"></a>kmncluster <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">kmeans</span>(</span>
<span id="cb61-4"><a href="rgb-classification.html#cb61-4" tabindex="-1"></a>  pred_df <span class="sc">%&gt;%</span> </span>
<span id="cb61-5"><a href="rgb-classification.html#cb61-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(cell,x,y)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-6"><a href="rgb-classification.html#cb61-6" tabindex="-1"></a>    <span class="co"># we can&#39;t have NA values in kmeans</span></span>
<span id="cb61-7"><a href="rgb-classification.html#cb61-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb61-8"><a href="rgb-classification.html#cb61-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb61-9"><a href="rgb-classification.html#cb61-9" tabindex="-1"></a>        <span class="at">.cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()</span>
<span id="cb61-10"><a href="rgb-classification.html#cb61-10" tabindex="-1"></a>        , <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(.x),<span class="sc">-</span><span class="dv">99</span>,.x))</span>
<span id="cb61-11"><a href="rgb-classification.html#cb61-11" tabindex="-1"></a>      )</span>
<span id="cb61-12"><a href="rgb-classification.html#cb61-12" tabindex="-1"></a>    )</span>
<span id="cb61-13"><a href="rgb-classification.html#cb61-13" tabindex="-1"></a>  , <span class="at">centers=</span><span class="dv">6</span></span>
<span id="cb61-14"><a href="rgb-classification.html#cb61-14" tabindex="-1"></a>  , <span class="at">iter.max =</span> <span class="dv">500</span></span>
<span id="cb61-15"><a href="rgb-classification.html#cb61-15" tabindex="-1"></a>  , <span class="at">nstart =</span> <span class="dv">5</span></span>
<span id="cb61-16"><a href="rgb-classification.html#cb61-16" tabindex="-1"></a>  , <span class="at">algorithm=</span><span class="st">&quot;Lloyd&quot;</span></span>
<span id="cb61-17"><a href="rgb-classification.html#cb61-17" tabindex="-1"></a>)</span>
<span id="cb61-18"><a href="rgb-classification.html#cb61-18" tabindex="-1"></a><span class="co"># kmeans returns an object of class kmeans</span></span>
<span id="cb61-19"><a href="rgb-classification.html#cb61-19" tabindex="-1"></a><span class="fu">str</span>(kmncluster)</span></code></pre></div>
<pre><code>## List of 9
##  $ cluster     : Named int [1:15638952] 1 1 1 1 1 1 1 1 1 1 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:15638952] &quot;2744&quot; &quot;2745&quot; &quot;2746&quot; &quot;2747&quot; ...
##  $ centers     : num [1:6, 1:10] 27 92.8 180.8 142.5 138.1 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:6] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##   .. ..$ : chr [1:10] &quot;red&quot; &quot;green&quot; &quot;blue&quot; &quot;panchromatic_local_sd&quot; ...
##  $ totss       : num 1.94e+11
##  $ withinss    : num [1:6] 5.06e+09 5.27e+09 6.47e+09 6.28e+09 7.52e+09 ...
##  $ tot.withinss: num 3.72e+10
##  $ betweenss   : num 1.57e+11
##  $ size        : int [1:6] 2193126 2736917 2674953 4350229 1839787 1843940
##  $ iter        : int 159
##  $ ifault      : NULL
##  - attr(*, &quot;class&quot;)= chr &quot;kmeans&quot;</code></pre>
<p>put the kmeans clusters into a raster</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="rgb-classification.html#cb63-1" tabindex="-1"></a><span class="co"># make a blank raster</span></span>
<span id="cb63-2"><a href="rgb-classification.html#cb63-2" tabindex="-1"></a>kmeans_cluster_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(ortho_rast, <span class="at">nlyr=</span><span class="dv">1</span>)</span>
<span id="cb63-3"><a href="rgb-classification.html#cb63-3" tabindex="-1"></a><span class="co"># fill the raster</span></span>
<span id="cb63-4"><a href="rgb-classification.html#cb63-4" tabindex="-1"></a>kmeans_cluster_rast[pred_df<span class="sc">$</span>cell] <span class="ot">&lt;-</span> kmncluster<span class="sc">$</span>cluster</span>
<span id="cb63-5"><a href="rgb-classification.html#cb63-5" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb63-6"><a href="rgb-classification.html#cb63-6" tabindex="-1"></a>kmeans_cluster_rast</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 3567, 4552, 1  (nrow, ncol, nlyr)
## resolution  : 0.15, 0.15  (x, y)
## extent      : 499274.8, 499957.6, 4317604, 4318139  (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N (EPSG:32613) 
## source(s)   : memory
## name        : lyr1 
## min value   :    1 
## max value   :    6</code></pre>
<p>there should be at most 6 clusters</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="rgb-classification.html#cb65-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(kmeans_cluster_rast)</span></code></pre></div>
<pre><code>##   layer value   count
## 1     1     1 2193126
## 2     1     2 2736917
## 3     1     3 2674953
## 4     1     4 4350229
## 5     1     5 1839787
## 6     1     6 1843940</code></pre>
<p>plot the kmeans unsupervised classfication result</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="rgb-classification.html#cb67-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb67-2"><a href="rgb-classification.html#cb67-2" tabindex="-1"></a>  kmeans_cluster_rast</span>
<span id="cb67-3"><a href="rgb-classification.html#cb67-3" tabindex="-1"></a>  , <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">6</span>)</span>
<span id="cb67-4"><a href="rgb-classification.html#cb67-4" tabindex="-1"></a>  , <span class="at">axes=</span>F, <span class="at">legend =</span> F</span>
<span id="cb67-5"><a href="rgb-classification.html#cb67-5" tabindex="-1"></a>)</span>
<span id="cb67-6"><a href="rgb-classification.html#cb67-6" tabindex="-1"></a><span class="co"># add polys</span></span>
<span id="cb67-7"><a href="rgb-classification.html#cb67-7" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb67-8"><a href="rgb-classification.html#cb67-8" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb67-9"><a href="rgb-classification.html#cb67-9" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span></span>
<span id="cb67-10"><a href="rgb-classification.html#cb67-10" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-47-1.png" width="1008" /></p>
<p>neat, let’s see if the piles are classified by making a custom function to plot the classified raster and RGB side-by-side</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="rgb-classification.html#cb68-1" tabindex="-1"></a>p_fn_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb68-2"><a href="rgb-classification.html#cb68-2" tabindex="-1"></a>    rn</span>
<span id="cb68-3"><a href="rgb-classification.html#cb68-3" tabindex="-1"></a>    , <span class="at">df =</span> slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))</span>
<span id="cb68-4"><a href="rgb-classification.html#cb68-4" tabindex="-1"></a>    , <span class="at">cluster_rast =</span> kmeans_cluster_rast</span>
<span id="cb68-5"><a href="rgb-classification.html#cb68-5" tabindex="-1"></a>    , <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)</span>
<span id="cb68-6"><a href="rgb-classification.html#cb68-6" tabindex="-1"></a>) {</span>
<span id="cb68-7"><a href="rgb-classification.html#cb68-7" tabindex="-1"></a>  <span class="co"># scale the buffer based on the largest</span></span>
<span id="cb68-8"><a href="rgb-classification.html#cb68-8" tabindex="-1"></a>    d_temp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb68-9"><a href="rgb-classification.html#cb68-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">tolower</span>(comment), <span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb68-10"><a href="rgb-classification.html#cb68-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(rn) <span class="sc">%&gt;%</span> </span>
<span id="cb68-11"><a href="rgb-classification.html#cb68-11" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(crs)</span>
<span id="cb68-12"><a href="rgb-classification.html#cb68-12" tabindex="-1"></a>    <span class="co"># plt</span></span>
<span id="cb68-13"><a href="rgb-classification.html#cb68-13" tabindex="-1"></a>    rgb_temp <span class="ot">&lt;-</span></span>
<span id="cb68-14"><a href="rgb-classification.html#cb68-14" tabindex="-1"></a>      <span class="fu">ortho_plt_fn</span>(d_temp) <span class="sc">+</span> </span>
<span id="cb68-15"><a href="rgb-classification.html#cb68-15" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> d_temp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="cb68-16"><a href="rgb-classification.html#cb68-16" tabindex="-1"></a>    </span>
<span id="cb68-17"><a href="rgb-classification.html#cb68-17" tabindex="-1"></a>    <span class="co"># plt classifier</span></span>
<span id="cb68-18"><a href="rgb-classification.html#cb68-18" tabindex="-1"></a>    class_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb68-19"><a href="rgb-classification.html#cb68-19" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb68-20"><a href="rgb-classification.html#cb68-20" tabindex="-1"></a>        <span class="at">data =</span> cluster_rast <span class="sc">%&gt;%</span>  </span>
<span id="cb68-21"><a href="rgb-classification.html#cb68-21" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb68-22"><a href="rgb-classification.html#cb68-22" tabindex="-1"></a>            d_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb68-23"><a href="rgb-classification.html#cb68-23" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb68-24"><a href="rgb-classification.html#cb68-24" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb68-25"><a href="rgb-classification.html#cb68-25" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb68-26"><a href="rgb-classification.html#cb68-26" tabindex="-1"></a>        , ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span><span class="fu">as.factor</span>(f))</span>
<span id="cb68-27"><a href="rgb-classification.html#cb68-27" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb68-28"><a href="rgb-classification.html#cb68-28" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> d_temp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb68-29"><a href="rgb-classification.html#cb68-29" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(</span>
<span id="cb68-30"><a href="rgb-classification.html#cb68-30" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb68-31"><a href="rgb-classification.html#cb68-31" tabindex="-1"></a>          <span class="st">&quot;1&quot;</span> <span class="ot">=</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">6</span>)[<span class="dv">1</span>]</span>
<span id="cb68-32"><a href="rgb-classification.html#cb68-32" tabindex="-1"></a>          , <span class="st">&quot;2&quot;</span> <span class="ot">=</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">6</span>)[<span class="dv">2</span>]</span>
<span id="cb68-33"><a href="rgb-classification.html#cb68-33" tabindex="-1"></a>          , <span class="st">&quot;3&quot;</span> <span class="ot">=</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">6</span>)[<span class="dv">3</span>]</span>
<span id="cb68-34"><a href="rgb-classification.html#cb68-34" tabindex="-1"></a>          , <span class="st">&quot;4&quot;</span> <span class="ot">=</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">6</span>)[<span class="dv">4</span>]</span>
<span id="cb68-35"><a href="rgb-classification.html#cb68-35" tabindex="-1"></a>          , <span class="st">&quot;5&quot;</span> <span class="ot">=</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">6</span>)[<span class="dv">5</span>]</span>
<span id="cb68-36"><a href="rgb-classification.html#cb68-36" tabindex="-1"></a>          , <span class="st">&quot;6&quot;</span> <span class="ot">=</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">6</span>)[<span class="dv">6</span>]</span>
<span id="cb68-37"><a href="rgb-classification.html#cb68-37" tabindex="-1"></a>          <span class="co"># , &quot;7&quot; = viridis::turbo(n=10)[7]</span></span>
<span id="cb68-38"><a href="rgb-classification.html#cb68-38" tabindex="-1"></a>          <span class="co"># , &quot;8&quot; = viridis::turbo(n=10)[8]</span></span>
<span id="cb68-39"><a href="rgb-classification.html#cb68-39" tabindex="-1"></a>          <span class="co"># , &quot;9&quot; = viridis::turbo(n=10)[9]</span></span>
<span id="cb68-40"><a href="rgb-classification.html#cb68-40" tabindex="-1"></a>          <span class="co"># , &quot;10&quot; = viridis::turbo(n=10)[10]</span></span>
<span id="cb68-41"><a href="rgb-classification.html#cb68-41" tabindex="-1"></a>        )</span>
<span id="cb68-42"><a href="rgb-classification.html#cb68-42" tabindex="-1"></a>        , <span class="at">na.value =</span> <span class="st">&quot;transparent&quot;</span></span>
<span id="cb68-43"><a href="rgb-classification.html#cb68-43" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb68-44"><a href="rgb-classification.html#cb68-44" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb68-45"><a href="rgb-classification.html#cb68-45" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb68-46"><a href="rgb-classification.html#cb68-46" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb68-47"><a href="rgb-classification.html#cb68-47" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb68-48"><a href="rgb-classification.html#cb68-48" tabindex="-1"></a>        , <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb68-49"><a href="rgb-classification.html#cb68-49" tabindex="-1"></a>        , <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb68-50"><a href="rgb-classification.html#cb68-50" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb68-51"><a href="rgb-classification.html#cb68-51" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span> </span>
<span id="cb68-52"><a href="rgb-classification.html#cb68-52" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb68-53"><a href="rgb-classification.html#cb68-53" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;left&quot;</span> <span class="co"># c(0.5,1)</span></span>
<span id="cb68-54"><a href="rgb-classification.html#cb68-54" tabindex="-1"></a>        , <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb68-55"><a href="rgb-classification.html#cb68-55" tabindex="-1"></a>        , <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb68-56"><a href="rgb-classification.html#cb68-56" tabindex="-1"></a>        , <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb68-57"><a href="rgb-classification.html#cb68-57" tabindex="-1"></a>        , <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb68-58"><a href="rgb-classification.html#cb68-58" tabindex="-1"></a>        <span class="co"># , plot.title = ggtext::element_markdown(size = 10, hjust = 0.5)</span></span>
<span id="cb68-59"><a href="rgb-classification.html#cb68-59" tabindex="-1"></a>        , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb68-60"><a href="rgb-classification.html#cb68-60" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)</span>
<span id="cb68-61"><a href="rgb-classification.html#cb68-61" tabindex="-1"></a>      )</span>
<span id="cb68-62"><a href="rgb-classification.html#cb68-62" tabindex="-1"></a>  plt_temp <span class="ot">&lt;-</span> class_temp<span class="sc">+</span>rgb_temp</span>
<span id="cb68-63"><a href="rgb-classification.html#cb68-63" tabindex="-1"></a>  <span class="fu">return</span>(plt_temp)</span>
<span id="cb68-64"><a href="rgb-classification.html#cb68-64" tabindex="-1"></a>}</span>
<span id="cb68-65"><a href="rgb-classification.html#cb68-65" tabindex="-1"></a><span class="co"># add pile locations</span></span>
<span id="cb68-66"><a href="rgb-classification.html#cb68-66" tabindex="-1"></a>plt_list_kmeans <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))),<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb68-67"><a href="rgb-classification.html#cb68-67" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(p_fn_temp)</span></code></pre></div>
<p>combine the plots for a few piles</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="rgb-classification.html#cb69-1" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb69-2"><a href="rgb-classification.html#cb69-2" tabindex="-1"></a>  plt_list_kmeans</span>
<span id="cb69-3"><a href="rgb-classification.html#cb69-3" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb69-4"><a href="rgb-classification.html#cb69-4" tabindex="-1"></a>  , <span class="at">guides =</span> <span class="st">&quot;collect&quot;</span></span>
<span id="cb69-5"><a href="rgb-classification.html#cb69-5" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-50-1.png" width="1008" /></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="rgb-classification.html#cb70-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/pile_tiles_kmeans6.jpeg&quot;</span>, <span class="at">height =</span> <span class="fl">10.5</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>there is no discernible pattern between the kmeans classes and the slash piles because the lighting and conditions around the piles are not consistent. this result also highlights the challenges we’ll likely face with pixel-based classification methods</p>
</div>
<div id="pixel_class" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Pixel-based: supervised classification<a href="rgb-classification.html#pixel_class" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>we’ll start with a pixel-based classification using the image-annotated pile polygons to train a classification model</p>
<p>first, let’s set aside some piles for use in validation</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="rgb-classification.html#cb71-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">333</span>)</span>
<span id="cb71-2"><a href="rgb-classification.html#cb71-2" tabindex="-1"></a><span class="co"># 20% will be used for validation</span></span>
<span id="cb71-3"><a href="rgb-classification.html#cb71-3" tabindex="-1"></a>slash_piles_polys <span class="ot">&lt;-</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb71-4"><a href="rgb-classification.html#cb71-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb71-5"><a href="rgb-classification.html#cb71-5" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb71-6"><a href="rgb-classification.html#cb71-6" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb71-7"><a href="rgb-classification.html#cb71-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment)) <span class="sc">%&gt;%</span> </span>
<span id="cb71-8"><a href="rgb-classification.html#cb71-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(pile_id) <span class="sc">%&gt;%</span></span>
<span id="cb71-9"><a href="rgb-classification.html#cb71-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="fl">0.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb71-10"><a href="rgb-classification.html#cb71-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_training =</span> F)</span>
<span id="cb71-11"><a href="rgb-classification.html#cb71-11" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb71-12"><a href="rgb-classification.html#cb71-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb71-13"><a href="rgb-classification.html#cb71-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_training =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_training, T))</span>
<span id="cb71-14"><a href="rgb-classification.html#cb71-14" tabindex="-1"></a>slash_piles_points <span class="ot">&lt;-</span> slash_piles_points <span class="sc">%&gt;%</span> </span>
<span id="cb71-15"><a href="rgb-classification.html#cb71-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb71-16"><a href="rgb-classification.html#cb71-16" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb71-17"><a href="rgb-classification.html#cb71-17" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb71-18"><a href="rgb-classification.html#cb71-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(objectid, is_training)</span>
<span id="cb71-19"><a href="rgb-classification.html#cb71-19" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;objectid&quot;</span></span>
<span id="cb71-20"><a href="rgb-classification.html#cb71-20" tabindex="-1"></a>  )</span>
<span id="cb71-21"><a href="rgb-classification.html#cb71-21" tabindex="-1"></a><span class="co"># slash_piles_points %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(is_training)</span></span></code></pre></div>
<p>first, we’ll generate a set of sample points to extract raster values from to build our training data with covariates</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="rgb-classification.html#cb72-1" tabindex="-1"></a>training_points <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb72-2"><a href="rgb-classification.html#cb72-2" tabindex="-1"></a><span class="co"># sample only from non-pile parts of the raster</span></span>
<span id="cb72-3"><a href="rgb-classification.html#cb72-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb72-4"><a href="rgb-classification.html#cb72-4" tabindex="-1"></a>    grvi_rast</span>
<span id="cb72-5"><a href="rgb-classification.html#cb72-5" tabindex="-1"></a>    , slash_piles_polys <span class="sc">%&gt;%</span> <span class="co"># use ALL piles (image-annotated and field-collected)</span></span>
<span id="cb72-6"><a href="rgb-classification.html#cb72-6" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-7"><a href="rgb-classification.html#cb72-7" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb72-8"><a href="rgb-classification.html#cb72-8" tabindex="-1"></a>    , <span class="at">inverse =</span> T</span>
<span id="cb72-9"><a href="rgb-classification.html#cb72-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-10"><a href="rgb-classification.html#cb72-10" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">spatSample</span>(<span class="at">size =</span> <span class="dv">5000</span>, <span class="at">na.rm =</span> T, <span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb72-11"><a href="rgb-classification.html#cb72-11" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-12"><a href="rgb-classification.html#cb72-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb72-13"><a href="rgb-classification.html#cb72-13" tabindex="-1"></a>    <span class="at">is_pile =</span> <span class="dv">0</span></span>
<span id="cb72-14"><a href="rgb-classification.html#cb72-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-15"><a href="rgb-classification.html#cb72-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(is_pile)</span>
<span id="cb72-16"><a href="rgb-classification.html#cb72-16" tabindex="-1"></a><span class="co"># sample points within piles</span></span>
<span id="cb72-17"><a href="rgb-classification.html#cb72-17" tabindex="-1"></a>  , slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb72-18"><a href="rgb-classification.html#cb72-18" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb72-19"><a href="rgb-classification.html#cb72-19" tabindex="-1"></a>      is_training</span>
<span id="cb72-20"><a href="rgb-classification.html#cb72-20" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-21"><a href="rgb-classification.html#cb72-21" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-22"><a href="rgb-classification.html#cb72-22" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-23"><a href="rgb-classification.html#cb72-23" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">spatSample</span>(<span class="at">size =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-24"><a href="rgb-classification.html#cb72-24" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-25"><a href="rgb-classification.html#cb72-25" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb72-26"><a href="rgb-classification.html#cb72-26" tabindex="-1"></a>      <span class="at">is_pile =</span> <span class="dv">1</span></span>
<span id="cb72-27"><a href="rgb-classification.html#cb72-27" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-28"><a href="rgb-classification.html#cb72-28" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(is_pile)</span>
<span id="cb72-29"><a href="rgb-classification.html#cb72-29" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-30"><a href="rgb-classification.html#cb72-30" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb72-31"><a href="rgb-classification.html#cb72-31" tabindex="-1"></a>  <span class="at">id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb72-32"><a href="rgb-classification.html#cb72-32" tabindex="-1"></a>  , <span class="at">is_pile =</span> <span class="fu">as.factor</span>(is_pile)</span>
<span id="cb72-33"><a href="rgb-classification.html#cb72-33" tabindex="-1"></a>  , <span class="at">x =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>]</span>
<span id="cb72-34"><a href="rgb-classification.html#cb72-34" tabindex="-1"></a>  , <span class="at">y =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>]</span>
<span id="cb72-35"><a href="rgb-classification.html#cb72-35" tabindex="-1"></a>)</span>
<span id="cb72-36"><a href="rgb-classification.html#cb72-36" tabindex="-1"></a><span class="do">####### validation points since we&#39;ll validate at the pixel level</span></span>
<span id="cb72-37"><a href="rgb-classification.html#cb72-37" tabindex="-1"></a>validation_points <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb72-38"><a href="rgb-classification.html#cb72-38" tabindex="-1"></a><span class="co"># sample only from non-pile parts of the raster</span></span>
<span id="cb72-39"><a href="rgb-classification.html#cb72-39" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb72-40"><a href="rgb-classification.html#cb72-40" tabindex="-1"></a>    grvi_rast</span>
<span id="cb72-41"><a href="rgb-classification.html#cb72-41" tabindex="-1"></a>    , slash_piles_polys <span class="sc">%&gt;%</span> <span class="co"># use ALL piles (image-annotated and field-collected)</span></span>
<span id="cb72-42"><a href="rgb-classification.html#cb72-42" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-43"><a href="rgb-classification.html#cb72-43" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb72-44"><a href="rgb-classification.html#cb72-44" tabindex="-1"></a>    , <span class="at">inverse =</span> T</span>
<span id="cb72-45"><a href="rgb-classification.html#cb72-45" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-46"><a href="rgb-classification.html#cb72-46" tabindex="-1"></a>  <span class="co"># mask the training points as well</span></span>
<span id="cb72-47"><a href="rgb-classification.html#cb72-47" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb72-48"><a href="rgb-classification.html#cb72-48" tabindex="-1"></a>    training_points <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb72-49"><a href="rgb-classification.html#cb72-49" tabindex="-1"></a>    , <span class="at">inverse =</span> T</span>
<span id="cb72-50"><a href="rgb-classification.html#cb72-50" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-51"><a href="rgb-classification.html#cb72-51" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">spatSample</span>(<span class="at">size =</span> <span class="dv">5000</span>, <span class="at">na.rm =</span> T, <span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb72-52"><a href="rgb-classification.html#cb72-52" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-53"><a href="rgb-classification.html#cb72-53" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb72-54"><a href="rgb-classification.html#cb72-54" tabindex="-1"></a>    <span class="at">is_pile =</span> <span class="dv">0</span></span>
<span id="cb72-55"><a href="rgb-classification.html#cb72-55" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-56"><a href="rgb-classification.html#cb72-56" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(is_pile)</span>
<span id="cb72-57"><a href="rgb-classification.html#cb72-57" tabindex="-1"></a><span class="co"># sample points within piles</span></span>
<span id="cb72-58"><a href="rgb-classification.html#cb72-58" tabindex="-1"></a>  , slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb72-59"><a href="rgb-classification.html#cb72-59" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb72-60"><a href="rgb-classification.html#cb72-60" tabindex="-1"></a>      <span class="sc">!</span>is_training</span>
<span id="cb72-61"><a href="rgb-classification.html#cb72-61" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-62"><a href="rgb-classification.html#cb72-62" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(grvi_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-63"><a href="rgb-classification.html#cb72-63" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-64"><a href="rgb-classification.html#cb72-64" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">spatSample</span>(<span class="at">size =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-65"><a href="rgb-classification.html#cb72-65" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-66"><a href="rgb-classification.html#cb72-66" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb72-67"><a href="rgb-classification.html#cb72-67" tabindex="-1"></a>      <span class="at">is_pile =</span> <span class="dv">1</span></span>
<span id="cb72-68"><a href="rgb-classification.html#cb72-68" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-69"><a href="rgb-classification.html#cb72-69" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(is_pile)</span>
<span id="cb72-70"><a href="rgb-classification.html#cb72-70" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-71"><a href="rgb-classification.html#cb72-71" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb72-72"><a href="rgb-classification.html#cb72-72" tabindex="-1"></a>  <span class="at">id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb72-73"><a href="rgb-classification.html#cb72-73" tabindex="-1"></a>  , <span class="at">is_pile =</span> <span class="fu">as.factor</span>(is_pile)</span>
<span id="cb72-74"><a href="rgb-classification.html#cb72-74" tabindex="-1"></a>  , <span class="at">x =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>]</span>
<span id="cb72-75"><a href="rgb-classification.html#cb72-75" tabindex="-1"></a>  , <span class="at">y =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>]</span>
<span id="cb72-76"><a href="rgb-classification.html#cb72-76" tabindex="-1"></a>)</span></code></pre></div>
<p>plot our RGB with training piles (white), validation piles (black), pile sample points (red), and non-pile sample points (blue)</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="rgb-classification.html#cb73-1" tabindex="-1"></a><span class="co"># let&#39;s check this out</span></span>
<span id="cb73-2"><a href="rgb-classification.html#cb73-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb73-3"><a href="rgb-classification.html#cb73-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb73-4"><a href="rgb-classification.html#cb73-4" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb73-5"><a href="rgb-classification.html#cb73-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training) <span class="sc">%&gt;%</span> </span>
<span id="cb73-6"><a href="rgb-classification.html#cb73-6" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb73-7"><a href="rgb-classification.html#cb73-7" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb73-8"><a href="rgb-classification.html#cb73-8" tabindex="-1"></a>)</span>
<span id="cb73-9"><a href="rgb-classification.html#cb73-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb73-10"><a href="rgb-classification.html#cb73-10" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb73-11"><a href="rgb-classification.html#cb73-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>is_training) <span class="sc">%&gt;%</span> </span>
<span id="cb73-12"><a href="rgb-classification.html#cb73-12" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb73-13"><a href="rgb-classification.html#cb73-13" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb73-14"><a href="rgb-classification.html#cb73-14" tabindex="-1"></a>)</span>
<span id="cb73-15"><a href="rgb-classification.html#cb73-15" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(training_points <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_pile<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>(), <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">add =</span> T)</span>
<span id="cb73-16"><a href="rgb-classification.html#cb73-16" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(training_points <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_pile<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>(), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">add =</span> T)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-53-1.png" width="1008" /></p>
<p>extract the raster cell values from each layer in our RGB-based raster data, these values will be the predictor variables</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="rgb-classification.html#cb74-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb74-2"><a href="rgb-classification.html#cb74-2" tabindex="-1"></a><span class="co">#extract covariate data at point locations</span></span>
<span id="cb74-3"><a href="rgb-classification.html#cb74-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb74-4"><a href="rgb-classification.html#cb74-4" tabindex="-1"></a>training_df <span class="ot">&lt;-</span></span>
<span id="cb74-5"><a href="rgb-classification.html#cb74-5" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb74-6"><a href="rgb-classification.html#cb74-6" tabindex="-1"></a>    pred_rast</span>
<span id="cb74-7"><a href="rgb-classification.html#cb74-7" tabindex="-1"></a>    , training_points <span class="sc">%&gt;%</span>  </span>
<span id="cb74-8"><a href="rgb-classification.html#cb74-8" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb74-9"><a href="rgb-classification.html#cb74-9" tabindex="-1"></a>    , <span class="at">ID =</span> F</span>
<span id="cb74-10"><a href="rgb-classification.html#cb74-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span>  </span>
<span id="cb74-11"><a href="rgb-classification.html#cb74-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb74-12"><a href="rgb-classification.html#cb74-12" tabindex="-1"></a>    training_points <span class="sc">%&gt;%</span>  </span>
<span id="cb74-13"><a href="rgb-classification.html#cb74-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(id,is_pile,x,y)</span>
<span id="cb74-14"><a href="rgb-classification.html#cb74-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span>  </span>
<span id="cb74-15"><a href="rgb-classification.html#cb74-15" tabindex="-1"></a>  <span class="do">## make sure no data is missing</span></span>
<span id="cb74-16"><a href="rgb-classification.html#cb74-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">if_all</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span> <span class="sc">!</span><span class="fu">is.na</span>(.x)))</span>
<span id="cb74-17"><a href="rgb-classification.html#cb74-17" tabindex="-1"></a>  <span class="co"># ## square continuous vars?</span></span>
<span id="cb74-18"><a href="rgb-classification.html#cb74-18" tabindex="-1"></a>  <span class="co"># dplyr::mutate(dplyr::across(</span></span>
<span id="cb74-19"><a href="rgb-classification.html#cb74-19" tabindex="-1"></a>  <span class="co">#   .cols = dplyr::where(is.numeric) &amp; !c(id, is_pile, x, y) &amp; !tidyselect::ends_with(&quot;local_minima&quot;)</span></span>
<span id="cb74-20"><a href="rgb-classification.html#cb74-20" tabindex="-1"></a>  <span class="co">#   , .fns = list(sq)</span></span>
<span id="cb74-21"><a href="rgb-classification.html#cb74-21" tabindex="-1"></a>  <span class="co">#   , .names = &quot;{.col}_sq&quot; </span></span>
<span id="cb74-22"><a href="rgb-classification.html#cb74-22" tabindex="-1"></a>  <span class="co"># ))</span></span>
<span id="cb74-23"><a href="rgb-classification.html#cb74-23" tabindex="-1"></a><span class="do">##### and validation data to perform accuracy assesment at the pixel level</span></span>
<span id="cb74-24"><a href="rgb-classification.html#cb74-24" tabindex="-1"></a>validation_df <span class="ot">&lt;-</span></span>
<span id="cb74-25"><a href="rgb-classification.html#cb74-25" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb74-26"><a href="rgb-classification.html#cb74-26" tabindex="-1"></a>    pred_rast</span>
<span id="cb74-27"><a href="rgb-classification.html#cb74-27" tabindex="-1"></a>    , validation_points <span class="sc">%&gt;%</span>  </span>
<span id="cb74-28"><a href="rgb-classification.html#cb74-28" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb74-29"><a href="rgb-classification.html#cb74-29" tabindex="-1"></a>    , <span class="at">ID =</span> F</span>
<span id="cb74-30"><a href="rgb-classification.html#cb74-30" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span>  </span>
<span id="cb74-31"><a href="rgb-classification.html#cb74-31" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb74-32"><a href="rgb-classification.html#cb74-32" tabindex="-1"></a>    validation_points <span class="sc">%&gt;%</span>  </span>
<span id="cb74-33"><a href="rgb-classification.html#cb74-33" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(id,is_pile,x,y)</span>
<span id="cb74-34"><a href="rgb-classification.html#cb74-34" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span>  </span>
<span id="cb74-35"><a href="rgb-classification.html#cb74-35" tabindex="-1"></a>  <span class="do">## make sure no data is missing</span></span>
<span id="cb74-36"><a href="rgb-classification.html#cb74-36" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">if_all</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span> <span class="sc">!</span><span class="fu">is.na</span>(.x)))</span>
<span id="cb74-37"><a href="rgb-classification.html#cb74-37" tabindex="-1"></a>  <span class="co"># ## square continuous vars?</span></span>
<span id="cb74-38"><a href="rgb-classification.html#cb74-38" tabindex="-1"></a>  <span class="co"># dplyr::mutate(dplyr::across(</span></span>
<span id="cb74-39"><a href="rgb-classification.html#cb74-39" tabindex="-1"></a>  <span class="co">#   .cols = dplyr::where(is.numeric) &amp; !c(id, is_pile, x, y) &amp; !tidyselect::ends_with(&quot;local_minima&quot;)</span></span>
<span id="cb74-40"><a href="rgb-classification.html#cb74-40" tabindex="-1"></a>  <span class="co">#   , .fns = list(sq)</span></span>
<span id="cb74-41"><a href="rgb-classification.html#cb74-41" tabindex="-1"></a>  <span class="co">#   , .names = &quot;{.col}_sq&quot; </span></span>
<span id="cb74-42"><a href="rgb-classification.html#cb74-42" tabindex="-1"></a>  <span class="co"># ))</span></span></code></pre></div>
<p>compare training and validation data to ensure that they are similar (i.e. we drew a big enough sample)</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="rgb-classification.html#cb75-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb75-2"><a href="rgb-classification.html#cb75-2" tabindex="-1"></a>    training_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dta_set =</span> <span class="st">&quot;Training&quot;</span>)</span>
<span id="cb75-3"><a href="rgb-classification.html#cb75-3" tabindex="-1"></a>    , validation_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dta_set =</span> <span class="st">&quot;Validation&quot;</span>)</span>
<span id="cb75-4"><a href="rgb-classification.html#cb75-4" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb75-5"><a href="rgb-classification.html#cb75-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geometry,dplyr<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_sq&quot;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb75-6"><a href="rgb-classification.html#cb75-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate_if</span>(is.factor, as.numeric) <span class="sc">%&gt;%</span> </span>
<span id="cb75-7"><a href="rgb-classification.html#cb75-7" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb75-8"><a href="rgb-classification.html#cb75-8" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(id, is_pile, dta_set)</span>
<span id="cb75-9"><a href="rgb-classification.html#cb75-9" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;covariate&quot;</span></span>
<span id="cb75-10"><a href="rgb-classification.html#cb75-10" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb75-11"><a href="rgb-classification.html#cb75-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb75-12"><a href="rgb-classification.html#cb75-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">covariate =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(covariate,<span class="st">&quot;_&quot;</span>, <span class="st">&quot; &quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-13"><a href="rgb-classification.html#cb75-13" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> dta_set, <span class="at">fill =</span> dta_set, <span class="at">group =</span> dta_set)) <span class="sc">+</span></span>
<span id="cb75-14"><a href="rgb-classification.html#cb75-14" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha=</span><span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb75-15"><a href="rgb-classification.html#cb75-15" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb75-16"><a href="rgb-classification.html#cb75-16" tabindex="-1"></a>    <span class="at">facets =</span> <span class="fu">vars</span>(covariate), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb75-17"><a href="rgb-classification.html#cb75-17" tabindex="-1"></a>    , <span class="at">labeller =</span> <span class="fu">label_wrap_gen</span>(<span class="at">width =</span> <span class="dv">25</span>, <span class="at">multi_line =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-18"><a href="rgb-classification.html#cb75-18" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb75-19"><a href="rgb-classification.html#cb75-19" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;cividis&quot;</span>) <span class="sc">+</span></span>
<span id="cb75-20"><a href="rgb-classification.html#cb75-20" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;cividis&quot;</span>) <span class="sc">+</span></span>
<span id="cb75-21"><a href="rgb-classification.html#cb75-21" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb75-22"><a href="rgb-classification.html#cb75-22" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Distribution of Model Covariates&quot;</span></span>
<span id="cb75-23"><a href="rgb-classification.html#cb75-23" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb75-24"><a href="rgb-classification.html#cb75-24" tabindex="-1"></a>      <span class="st">&quot;by Training (n=&quot;</span></span>
<span id="cb75-25"><a href="rgb-classification.html#cb75-25" tabindex="-1"></a>      , <span class="fu">nrow</span>(training_df) <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">comma</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb75-26"><a href="rgb-classification.html#cb75-26" tabindex="-1"></a>      , <span class="st">&quot;) and Validation (n=&quot;</span></span>
<span id="cb75-27"><a href="rgb-classification.html#cb75-27" tabindex="-1"></a>      , <span class="fu">nrow</span>(validation_df) <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">comma</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb75-28"><a href="rgb-classification.html#cb75-28" tabindex="-1"></a>      , <span class="st">&quot;) data&quot;</span></span>
<span id="cb75-29"><a href="rgb-classification.html#cb75-29" tabindex="-1"></a>    )</span>
<span id="cb75-30"><a href="rgb-classification.html#cb75-30" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb75-31"><a href="rgb-classification.html#cb75-31" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb75-32"><a href="rgb-classification.html#cb75-32" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb75-33"><a href="rgb-classification.html#cb75-33" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb75-34"><a href="rgb-classification.html#cb75-34" tabindex="-1"></a>    , <span class="at">legend.title =</span> <span class="fu">element_blank</span>()</span>
<span id="cb75-35"><a href="rgb-classification.html#cb75-35" tabindex="-1"></a>    , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb75-36"><a href="rgb-classification.html#cb75-36" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb75-37"><a href="rgb-classification.html#cb75-37" tabindex="-1"></a>    , <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb75-38"><a href="rgb-classification.html#cb75-38" tabindex="-1"></a>    , <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb75-39"><a href="rgb-classification.html#cb75-39" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb75-40"><a href="rgb-classification.html#cb75-40" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)))</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-55-1.png" width="1008" /></p>
<p>we’ll use a random forest model to predict raster values</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="rgb-classification.html#cb76-1" tabindex="-1"></a><span class="co"># Tune on the full data if below threshold</span></span>
<span id="cb76-2"><a href="rgb-classification.html#cb76-2" tabindex="-1"></a>tune_result_temp <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">tuneRF</span>(</span>
<span id="cb76-3"><a href="rgb-classification.html#cb76-3" tabindex="-1"></a>  <span class="at">y =</span> training_df<span class="sc">$</span>is_pile</span>
<span id="cb76-4"><a href="rgb-classification.html#cb76-4" tabindex="-1"></a>  , <span class="at">x =</span> training_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(id,is_pile,geometry))</span>
<span id="cb76-5"><a href="rgb-classification.html#cb76-5" tabindex="-1"></a>  , <span class="at">ntreeTry =</span> <span class="dv">500</span></span>
<span id="cb76-6"><a href="rgb-classification.html#cb76-6" tabindex="-1"></a>  , <span class="at">stepFactor =</span> <span class="dv">1</span></span>
<span id="cb76-7"><a href="rgb-classification.html#cb76-7" tabindex="-1"></a>  , <span class="at">improve =</span> <span class="fl">0.03</span></span>
<span id="cb76-8"><a href="rgb-classification.html#cb76-8" tabindex="-1"></a>  , <span class="at">plot =</span> F</span>
<span id="cb76-9"><a href="rgb-classification.html#cb76-9" tabindex="-1"></a>  , <span class="at">trace =</span> F</span>
<span id="cb76-10"><a href="rgb-classification.html#cb76-10" tabindex="-1"></a>)</span>
<span id="cb76-11"><a href="rgb-classification.html#cb76-11" tabindex="-1"></a><span class="co"># Extract the optimal mtry value</span></span>
<span id="cb76-12"><a href="rgb-classification.html#cb76-12" tabindex="-1"></a>optimal_mtry_temp <span class="ot">&lt;-</span> tune_result_temp <span class="sc">%&gt;%</span></span>
<span id="cb76-13"><a href="rgb-classification.html#cb76-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb76-14"><a href="rgb-classification.html#cb76-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(OOBError<span class="sc">==</span><span class="fu">min</span>(OOBError)) <span class="sc">%&gt;%</span></span>
<span id="cb76-15"><a href="rgb-classification.html#cb76-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb76-16"><a href="rgb-classification.html#cb76-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(mtry) <span class="sc">%&gt;%</span></span>
<span id="cb76-17"><a href="rgb-classification.html#cb76-17" tabindex="-1"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb76-18"><a href="rgb-classification.html#cb76-18" tabindex="-1"></a><span class="co"># pass to random forest model</span></span>
<span id="cb76-19"><a href="rgb-classification.html#cb76-19" tabindex="-1"></a>mod_rf <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">randomForest</span>(</span>
<span id="cb76-20"><a href="rgb-classification.html#cb76-20" tabindex="-1"></a>  <span class="at">y =</span> training_df<span class="sc">$</span>is_pile</span>
<span id="cb76-21"><a href="rgb-classification.html#cb76-21" tabindex="-1"></a>  , <span class="at">x =</span> training_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(id,is_pile,geometry))</span>
<span id="cb76-22"><a href="rgb-classification.html#cb76-22" tabindex="-1"></a>  , <span class="at">mtry =</span> optimal_mtry_temp</span>
<span id="cb76-23"><a href="rgb-classification.html#cb76-23" tabindex="-1"></a>  , <span class="at">na.action =</span> na.omit</span>
<span id="cb76-24"><a href="rgb-classification.html#cb76-24" tabindex="-1"></a>  , <span class="at">ntree =</span> <span class="dv">500</span></span>
<span id="cb76-25"><a href="rgb-classification.html#cb76-25" tabindex="-1"></a>)</span></code></pre></div>
<p>random forest variable importance plot</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="rgb-classification.html#cb77-1" tabindex="-1"></a><span class="co">#variable importance plot</span></span>
<span id="cb77-2"><a href="rgb-classification.html#cb77-2" tabindex="-1"></a>randomForest<span class="sc">::</span><span class="fu">varImpPlot</span>(mod_rf)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-57-1.png" width="1008" /></p>
<p>predict raster values</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="rgb-classification.html#cb78-1" tabindex="-1"></a><span class="co"># x,y rasters</span></span>
<span id="cb78-2"><a href="rgb-classification.html#cb78-2" tabindex="-1"></a>y_rast_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">init</span>(pred_rast[[<span class="dv">1</span>]], <span class="st">&quot;y&quot;</span>)</span>
<span id="cb78-3"><a href="rgb-classification.html#cb78-3" tabindex="-1"></a><span class="fu">names</span>(y_rast_temp) <span class="ot">&lt;-</span> <span class="st">&quot;y&quot;</span></span>
<span id="cb78-4"><a href="rgb-classification.html#cb78-4" tabindex="-1"></a>x_rast_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">init</span>(pred_rast[[<span class="dv">1</span>]], <span class="st">&quot;x&quot;</span>)</span>
<span id="cb78-5"><a href="rgb-classification.html#cb78-5" tabindex="-1"></a><span class="fu">names</span>(x_rast_temp) <span class="ot">&lt;-</span> <span class="st">&quot;x&quot;</span></span>
<span id="cb78-6"><a href="rgb-classification.html#cb78-6" tabindex="-1"></a><span class="co"># predict</span></span>
<span id="cb78-7"><a href="rgb-classification.html#cb78-7" tabindex="-1"></a>rf_pred_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">predict</span>(</span>
<span id="cb78-8"><a href="rgb-classification.html#cb78-8" tabindex="-1"></a>  <span class="at">object =</span> <span class="fu">c</span>(</span>
<span id="cb78-9"><a href="rgb-classification.html#cb78-9" tabindex="-1"></a>      pred_rast</span>
<span id="cb78-10"><a href="rgb-classification.html#cb78-10" tabindex="-1"></a>      , x_rast_temp, y_rast_temp</span>
<span id="cb78-11"><a href="rgb-classification.html#cb78-11" tabindex="-1"></a>    )</span>
<span id="cb78-12"><a href="rgb-classification.html#cb78-12" tabindex="-1"></a>  , <span class="at">model =</span> mod_rf</span>
<span id="cb78-13"><a href="rgb-classification.html#cb78-13" tabindex="-1"></a>  , <span class="at">na.rm =</span> T</span>
<span id="cb78-14"><a href="rgb-classification.html#cb78-14" tabindex="-1"></a>  <span class="co"># , type = &quot;prob&quot;</span></span>
<span id="cb78-15"><a href="rgb-classification.html#cb78-15" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="rgb-classification.html#cb80-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">coltab</span>(rf_pred_rast) <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">value=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;gray&quot;</span>, <span class="st">&quot;khaki&quot;</span>))</span>
<span id="cb80-2"><a href="rgb-classification.html#cb80-2" tabindex="-1"></a><span class="fu">levels</span>(rf_pred_rast) <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">value=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;non-pile&quot;</span>, <span class="st">&quot;pile&quot;</span>))</span></code></pre></div>
<p>plot pixel-level predictions</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="rgb-classification.html#cb81-1" tabindex="-1"></a><span class="co">#plot</span></span>
<span id="cb81-2"><a href="rgb-classification.html#cb81-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(rf_pred_rast)</span>
<span id="cb81-3"><a href="rgb-classification.html#cb81-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb81-4"><a href="rgb-classification.html#cb81-4" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb81-5"><a href="rgb-classification.html#cb81-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training) <span class="sc">%&gt;%</span> </span>
<span id="cb81-6"><a href="rgb-classification.html#cb81-6" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb81-7"><a href="rgb-classification.html#cb81-7" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb81-8"><a href="rgb-classification.html#cb81-8" tabindex="-1"></a>)</span>
<span id="cb81-9"><a href="rgb-classification.html#cb81-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb81-10"><a href="rgb-classification.html#cb81-10" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb81-11"><a href="rgb-classification.html#cb81-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>is_training) <span class="sc">%&gt;%</span> </span>
<span id="cb81-12"><a href="rgb-classification.html#cb81-12" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb81-13"><a href="rgb-classification.html#cb81-13" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb81-14"><a href="rgb-classification.html#cb81-14" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-60-1.png" width="1008" /></p>
<p>evaluate model performance based on the Area under the Receiver Operating Characteristic (ROC) Curve (AUC) criterion (an AUC value of 0.5 can be interpreted as the model performing no better than a random prediction). Higher AUC values indicate that the model is better at predicting “absence” classes as “absence” (true negative) and “presence” classes as “presence” (true positive).</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="rgb-classification.html#cb82-1" tabindex="-1"></a>validation_df <span class="ot">&lt;-</span></span>
<span id="cb82-2"><a href="rgb-classification.html#cb82-2" tabindex="-1"></a>  validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb82-3"><a href="rgb-classification.html#cb82-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb82-4"><a href="rgb-classification.html#cb82-4" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb82-5"><a href="rgb-classification.html#cb82-5" tabindex="-1"></a>      rf_pred_rast</span>
<span id="cb82-6"><a href="rgb-classification.html#cb82-6" tabindex="-1"></a>      , validation_points <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb82-7"><a href="rgb-classification.html#cb82-7" tabindex="-1"></a>      , <span class="at">ID =</span> F</span>
<span id="cb82-8"><a href="rgb-classification.html#cb82-8" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb82-9"><a href="rgb-classification.html#cb82-9" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">is_pile_predicted=</span><span class="dv">1</span>)</span>
<span id="cb82-10"><a href="rgb-classification.html#cb82-10" tabindex="-1"></a>  )</span>
<span id="cb82-11"><a href="rgb-classification.html#cb82-11" tabindex="-1"></a></span>
<span id="cb82-12"><a href="rgb-classification.html#cb82-12" tabindex="-1"></a>PresenceAbsence<span class="sc">::</span><span class="fu">auc.roc.plot</span>(</span>
<span id="cb82-13"><a href="rgb-classification.html#cb82-13" tabindex="-1"></a>  validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb82-14"><a href="rgb-classification.html#cb82-14" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb82-15"><a href="rgb-classification.html#cb82-15" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(id, is_pile, is_pile_predicted) <span class="sc">%&gt;%</span> </span>
<span id="cb82-16"><a href="rgb-classification.html#cb82-16" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;is_pile&quot;</span>), <span class="sc">~</span> <span class="fu">as.numeric</span>(.x)<span class="sc">-</span><span class="dv">1</span> ))</span>
<span id="cb82-17"><a href="rgb-classification.html#cb82-17" tabindex="-1"></a>  , <span class="at">main =</span> <span class="st">&quot;Random Forest&quot;</span></span>
<span id="cb82-18"><a href="rgb-classification.html#cb82-18" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-61-1.png" width="1008" /></p>
<p>now lets check the confusion matrix of the pixel-based approach where we evaluate omission rate (false negative rate or miss rate), commission rate (false positive rate), precision, recall (detection rate), and the F-score metric. As a reminder, true positive (<span class="math inline">\(TP\)</span>) instances correctly match ground truth instances with a prediction, commission tree predictions do not match a ground truth tree (false positive; <span class="math inline">\(FP\)</span>), and omissions are ground truth instances for which no predictions match (false negative; <span class="math inline">\(FN\)</span>)</p>
<p><span class="math display">\[\textrm{omission rate} = \frac{FN}{TP+FN}\]</span></p>
<p><span class="math display">\[\textrm{commission rate} = \frac{FP}{TP+FP}\]</span></p>
<p><span class="math display">\[\textrm{precision} = \frac{TP}{TP+FP}\]</span></p>
<p><span class="math display">\[\textrm{recall} = \frac{TP}{TP+FN}\]</span></p>
<p><span class="math display">\[
\textrm{F-score} = 2 \times \frac{\bigl(precision \times recall \bigr)}{\bigl(precision + recall \bigr)}
\]</span></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="rgb-classification.html#cb83-1" tabindex="-1"></a>confusion_matrix_temp <span class="ot">&lt;-</span></span>
<span id="cb83-2"><a href="rgb-classification.html#cb83-2" tabindex="-1"></a>  validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb83-3"><a href="rgb-classification.html#cb83-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;is_pile&quot;</span>), <span class="sc">~</span> <span class="fu">as.numeric</span>(.x)<span class="sc">-</span><span class="dv">1</span> )) <span class="sc">%&gt;%</span> </span>
<span id="cb83-4"><a href="rgb-classification.html#cb83-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb83-5"><a href="rgb-classification.html#cb83-5" tabindex="-1"></a>    <span class="at">presence =</span> is_pile</span>
<span id="cb83-6"><a href="rgb-classification.html#cb83-6" tabindex="-1"></a>    , <span class="at">estimate =</span> is_pile_predicted</span>
<span id="cb83-7"><a href="rgb-classification.html#cb83-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb83-8"><a href="rgb-classification.html#cb83-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(presence,estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb83-9"><a href="rgb-classification.html#cb83-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb83-10"><a href="rgb-classification.html#cb83-10" tabindex="-1"></a>    <span class="at">is_false =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(presence<span class="sc">!=</span>estimate,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb83-11"><a href="rgb-classification.html#cb83-11" tabindex="-1"></a>    , <span class="at">presence_fact =</span> <span class="fu">factor</span>(presence,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed Absent&quot;</span>, <span class="st">&quot;Observed Present&quot;</span>))</span>
<span id="cb83-12"><a href="rgb-classification.html#cb83-12" tabindex="-1"></a>    , <span class="at">estimate_fact =</span> <span class="fu">factor</span>(estimate,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Predicted Absent&quot;</span>, <span class="st">&quot;Predicted Present&quot;</span>))</span>
<span id="cb83-13"><a href="rgb-classification.html#cb83-13" tabindex="-1"></a>    , <span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)</span>
<span id="cb83-14"><a href="rgb-classification.html#cb83-14" tabindex="-1"></a>  )</span>
<span id="cb83-15"><a href="rgb-classification.html#cb83-15" tabindex="-1"></a><span class="co"># first function takes df with cols tp_n, fp_n, and fn_n to calculate rate</span></span>
<span id="cb83-16"><a href="rgb-classification.html#cb83-16" tabindex="-1"></a>confusion_matrix_scores_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb83-17"><a href="rgb-classification.html#cb83-17" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb83-18"><a href="rgb-classification.html#cb83-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb83-19"><a href="rgb-classification.html#cb83-19" tabindex="-1"></a>    <span class="at">omission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb83-20"><a href="rgb-classification.html#cb83-20" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb83-21"><a href="rgb-classification.html#cb83-21" tabindex="-1"></a>      , T <span class="sc">~</span> fn_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb83-22"><a href="rgb-classification.html#cb83-22" tabindex="-1"></a>    ) <span class="co"># False Negative Rate or Miss Rate</span></span>
<span id="cb83-23"><a href="rgb-classification.html#cb83-23" tabindex="-1"></a>    , <span class="at">commission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb83-24"><a href="rgb-classification.html#cb83-24" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb83-25"><a href="rgb-classification.html#cb83-25" tabindex="-1"></a>      , T <span class="sc">~</span> fp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb83-26"><a href="rgb-classification.html#cb83-26" tabindex="-1"></a>    ) <span class="co"># False Positive Rate</span></span>
<span id="cb83-27"><a href="rgb-classification.html#cb83-27" tabindex="-1"></a>    , <span class="at">precision =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb83-28"><a href="rgb-classification.html#cb83-28" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb83-29"><a href="rgb-classification.html#cb83-29" tabindex="-1"></a>      , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb83-30"><a href="rgb-classification.html#cb83-30" tabindex="-1"></a>    )</span>
<span id="cb83-31"><a href="rgb-classification.html#cb83-31" tabindex="-1"></a>    , <span class="at">recall =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb83-32"><a href="rgb-classification.html#cb83-32" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb83-33"><a href="rgb-classification.html#cb83-33" tabindex="-1"></a>      , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb83-34"><a href="rgb-classification.html#cb83-34" tabindex="-1"></a>    )</span>
<span id="cb83-35"><a href="rgb-classification.html#cb83-35" tabindex="-1"></a>    , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb83-36"><a href="rgb-classification.html#cb83-36" tabindex="-1"></a>      <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb83-37"><a href="rgb-classification.html#cb83-37" tabindex="-1"></a>      , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb83-38"><a href="rgb-classification.html#cb83-38" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb83-39"><a href="rgb-classification.html#cb83-39" tabindex="-1"></a>    )    </span>
<span id="cb83-40"><a href="rgb-classification.html#cb83-40" tabindex="-1"></a>  ) </span>
<span id="cb83-41"><a href="rgb-classification.html#cb83-41" tabindex="-1"></a>}</span>
<span id="cb83-42"><a href="rgb-classification.html#cb83-42" tabindex="-1"></a>confusion_matrix_scores_temp <span class="ot">&lt;-</span> <span class="fu">confusion_matrix_scores_fn</span>(</span>
<span id="cb83-43"><a href="rgb-classification.html#cb83-43" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb83-44"><a href="rgb-classification.html#cb83-44" tabindex="-1"></a>    <span class="at">tp_n =</span> confusion_matrix_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(presence<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> estimate <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(n)</span>
<span id="cb83-45"><a href="rgb-classification.html#cb83-45" tabindex="-1"></a>    , <span class="at">fn_n =</span> confusion_matrix_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(presence<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> estimate <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(n)</span>
<span id="cb83-46"><a href="rgb-classification.html#cb83-46" tabindex="-1"></a>    , <span class="at">fp_n =</span> confusion_matrix_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(presence<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> estimate <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(n)</span>
<span id="cb83-47"><a href="rgb-classification.html#cb83-47" tabindex="-1"></a>  )</span>
<span id="cb83-48"><a href="rgb-classification.html#cb83-48" tabindex="-1"></a>)</span>
<span id="cb83-49"><a href="rgb-classification.html#cb83-49" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb83-50"><a href="rgb-classification.html#cb83-50" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span>  confusion_matrix_temp, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> estimate_fact, <span class="at">x =</span> presence_fact)) <span class="sc">+</span></span>
<span id="cb83-51"><a href="rgb-classification.html#cb83-51" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> is_false), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>,<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb83-52"><a href="rgb-classification.html#cb83-52" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>)), <span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb83-53"><a href="rgb-classification.html#cb83-53" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)), <span class="at">vjust =</span> <span class="fl">3.5</span>, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb83-54"><a href="rgb-classification.html#cb83-54" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;turquoise&quot;</span>,<span class="st">&quot;tomato2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb83-55"><a href="rgb-classification.html#cb83-55" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb83-56"><a href="rgb-classification.html#cb83-56" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb83-57"><a href="rgb-classification.html#cb83-57" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Predicted&quot;</span></span>
<span id="cb83-58"><a href="rgb-classification.html#cb83-58" tabindex="-1"></a>    , <span class="at">x =</span> <span class="st">&quot;Observed&quot;</span></span>
<span id="cb83-59"><a href="rgb-classification.html#cb83-59" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb83-60"><a href="rgb-classification.html#cb83-60" tabindex="-1"></a>      <span class="st">&quot;True positive rate (recall) = &quot;</span></span>
<span id="cb83-61"><a href="rgb-classification.html#cb83-61" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>recall <span class="sc">%&gt;%</span> </span>
<span id="cb83-62"><a href="rgb-classification.html#cb83-62" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb83-63"><a href="rgb-classification.html#cb83-63" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Precision (PPV) = &quot;</span></span>
<span id="cb83-64"><a href="rgb-classification.html#cb83-64" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>precision <span class="sc">%&gt;%</span> </span>
<span id="cb83-65"><a href="rgb-classification.html#cb83-65" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb83-66"><a href="rgb-classification.html#cb83-66" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">F1-score = &quot;</span></span>
<span id="cb83-67"><a href="rgb-classification.html#cb83-67" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>f_score <span class="sc">%&gt;%</span> </span>
<span id="cb83-68"><a href="rgb-classification.html#cb83-68" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb83-69"><a href="rgb-classification.html#cb83-69" tabindex="-1"></a>    )</span>
<span id="cb83-70"><a href="rgb-classification.html#cb83-70" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb83-71"><a href="rgb-classification.html#cb83-71" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb83-72"><a href="rgb-classification.html#cb83-72" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb83-73"><a href="rgb-classification.html#cb83-73" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb83-74"><a href="rgb-classification.html#cb83-74" tabindex="-1"></a>    , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb83-75"><a href="rgb-classification.html#cb83-75" tabindex="-1"></a>    , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb83-76"><a href="rgb-classification.html#cb83-76" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb83-77"><a href="rgb-classification.html#cb83-77" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-62-1.png" width="1008" /></p>
<p>that’s not very good as we could tell from the prediction map</p>
</div>
<div id="obia" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Object-based image analysis (OBIA)<a href="rgb-classification.html#obia" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>OBIA is a technique (or a set of techniques) used to analyze digital images that was developed relatively recently in comparison to “classic” pixel-based image approaches (<a href="https://doi.org/10.1016/S0304-3800(03)00139-X">Burnett and Blaschke 2003</a>). <a href="https://doi.org/10.1016/j.jag.2018.11.011">Goncalves et al. (2019)</a> describe a general OBIA approach and created the <code>SegOptim</code> <a href="https://github.com/joaofgoncalves/SegOptim">package</a> to execute this framework. However, their package relies on 3rd party software to implement the initial image segmentation. The <code>OTBsegm</code> <a href="https://cidree.github.io/OTBsegm/">package</a> is another package that relies on 3rd party software to implement image segmentation. Alternatively, <code>imageseg</code> is an R package for deep learning-based image segmentation (<a href="https://doi.org/10.1111/2041-210X.13984">Niedballa et al. 2022</a>).</p>
<p>An alternative that does not require 3rd party software and works entirely within the R framework is the <code>OpenImageR</code> <a href="https://mlampros.github.io/OpenImageR/index.html">package</a>.</p>
<div id="training-data" class="section level3 hasAnchor" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> Training data<a href="rgb-classification.html#training-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Training data is described as “typically a single-layer SpatRaster (from terra package) containing samples for training a classifier. The labels, classes or categories should be coded as integers {0,1} for single-class problems or, {1,2,…,n} for multi-class problems.” We just have a single-class problem of classification with two mutually exclusive levels: piles and non-piles. Other examples include: species presence/absence, burned/unburned, cut/uncut forest.</p>
<p>first, we’ll make a raster covering the entire study area with cells classified based on the pile polygon locations</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="rgb-classification.html#cb84-1" tabindex="-1"></a>class_rast <span class="ot">&lt;-</span></span>
<span id="cb84-2"><a href="rgb-classification.html#cb84-2" tabindex="-1"></a>  ortho_rast[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb84-3"><a href="rgb-classification.html#cb84-3" tabindex="-1"></a>  <span class="co"># terra::subst(from = 0, to = NA) %&gt;% ## 0 values to NA which is specific to this data</span></span>
<span id="cb84-4"><a href="rgb-classification.html#cb84-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">lower=</span><span class="dv">0</span>,<span class="at">upper=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb84-5"><a href="rgb-classification.html#cb84-5" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb84-6"><a href="rgb-classification.html#cb84-6" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> <span class="co"># use ALL piles (image-annotated and field-collected)</span></span>
<span id="cb84-7"><a href="rgb-classification.html#cb84-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-8"><a href="rgb-classification.html#cb84-8" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb84-9"><a href="rgb-classification.html#cb84-9" tabindex="-1"></a>    , <span class="at">inverse =</span> T</span>
<span id="cb84-10"><a href="rgb-classification.html#cb84-10" tabindex="-1"></a>    , <span class="at">updatevalue =</span> <span class="dv">1</span></span>
<span id="cb84-11"><a href="rgb-classification.html#cb84-11" tabindex="-1"></a>  )</span>
<span id="cb84-12"><a href="rgb-classification.html#cb84-12" tabindex="-1"></a><span class="co"># terra::plot(class_rast)</span></span></code></pre></div>
<p>now we’ll make a grid of 0.25 ha to sample from to define our training versus validation areas. we’ll implement simple random sampling from this 0.25 ha grid.</p>
<p>after we make the sample area, we’ll sample from our classfied raster</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="rgb-classification.html#cb85-1" tabindex="-1"></a><span class="co"># generates the grid</span></span>
<span id="cb85-2"><a href="rgb-classification.html#cb85-2" tabindex="-1"></a>sample_grid <span class="ot">&lt;-</span> ortho_rast[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb85-3"><a href="rgb-classification.html#cb85-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">lower=</span><span class="dv">0</span>,<span class="at">upper=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-4"><a href="rgb-classification.html#cb85-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="fu">sqrt</span>(<span class="dv">10000</span><span class="sc">*</span><span class="fl">0.25</span>)<span class="sc">/</span>terra<span class="sc">::</span><span class="fu">res</span>(ortho_rast[[<span class="dv">1</span>]])[<span class="dv">1</span>])</span>
<span id="cb85-5"><a href="rgb-classification.html#cb85-5" tabindex="-1"></a><span class="co"># determins training tiles from the grid</span></span>
<span id="cb85-6"><a href="rgb-classification.html#cb85-6" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">66</span>)</span>
<span id="cb85-7"><a href="rgb-classification.html#cb85-7" tabindex="-1"></a>sample_grid <span class="ot">&lt;-</span></span>
<span id="cb85-8"><a href="rgb-classification.html#cb85-8" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">init</span>(sample_grid, <span class="st">&quot;cell&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-9"><a href="rgb-classification.html#cb85-9" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">subst</span>(</span>
<span id="cb85-10"><a href="rgb-classification.html#cb85-10" tabindex="-1"></a>    <span class="at">from =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">ncell</span>(sample_grid), <span class="at">size =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">ncell</span>(sample_grid)<span class="sc">*</span><span class="fl">0.7</span>))</span>
<span id="cb85-11"><a href="rgb-classification.html#cb85-11" tabindex="-1"></a>    , <span class="at">to =</span> <span class="dv">1</span></span>
<span id="cb85-12"><a href="rgb-classification.html#cb85-12" tabindex="-1"></a>    , <span class="at">others =</span> <span class="cn">NA</span></span>
<span id="cb85-13"><a href="rgb-classification.html#cb85-13" tabindex="-1"></a>  )</span>
<span id="cb85-14"><a href="rgb-classification.html#cb85-14" tabindex="-1"></a><span class="co"># terra::plot(sample_grid) # emmental</span></span>
<span id="cb85-15"><a href="rgb-classification.html#cb85-15" tabindex="-1"></a><span class="co"># sample from the classified raster</span></span>
<span id="cb85-16"><a href="rgb-classification.html#cb85-16" tabindex="-1"></a>class_rast_training <span class="ot">&lt;-</span></span>
<span id="cb85-17"><a href="rgb-classification.html#cb85-17" tabindex="-1"></a>  class_rast <span class="sc">%&gt;%</span> </span>
<span id="cb85-18"><a href="rgb-classification.html#cb85-18" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">mask</span>(terra<span class="sc">::</span><span class="fu">as.polygons</span>(sample_grid))</span></code></pre></div>
<p>check out the area we’ll use for training with the area for validation dimmed</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="rgb-classification.html#cb86-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(class_rast_training)</span>
<span id="cb86-2"><a href="rgb-classification.html#cb86-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(class_rast, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">add =</span> T, <span class="at">axes=</span>F, <span class="at">legend =</span> F)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-67-1.png" width="1008" /></p>
</div>
<div id="slic" class="section level3 hasAnchor" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> <code>OpenImageR</code> package SLIC image segmentation<a href="rgb-classification.html#slic" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>the <code>OpenImageR</code> <a href="https://github.com/mlampros/OpenImageR">package</a> makes the Simple Linear Iterative Clustering (SLIC) clustering algorithm (<a href="https://scholar.google.com/scholar?cluster=2726314889973535954&amp;hl=en&amp;as_sdt=0,6">Achanta et al. 2012</a>) available in R. SLIC takes an image and segments it into “superpixels.” These superpixels are compact, nearly uniform regions that adhere well to image boundaries. The key idea is that within a superpixel, pixels are likely to belong to the same object or land cover type. This is a crucial first step because subsequent classification will be performed on these superpixels, not individual pixels.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="rgb-classification.html#cb87-1" tabindex="-1"></a><span class="co"># the e1071 package is a popular choice for SVM implementation in R, providing a straightforward interface for training and evaluation.</span></span>
<span id="cb87-2"><a href="rgb-classification.html#cb87-2" tabindex="-1"></a><span class="co"># remotes::install_github(&#39;mlampros/OpenImageR&#39;)</span></span>
<span id="cb87-3"><a href="rgb-classification.html#cb87-3" tabindex="-1"></a><span class="co"># remotes::install_github(&#39;mlampros/SuperpixelImageSegmentation&#39;)</span></span>
<span id="cb87-4"><a href="rgb-classification.html#cb87-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;OpenImageR&quot;</span>)</span>
<span id="cb87-5"><a href="rgb-classification.html#cb87-5" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;SuperpixelImageSegmentation&quot;</span>)</span>
<span id="cb87-6"><a href="rgb-classification.html#cb87-6" tabindex="-1"></a><span class="co"># list.files(system.file(&quot;tmp_images&quot;, package = &quot;OpenImageR&quot;))</span></span>
<span id="cb87-7"><a href="rgb-classification.html#cb87-7" tabindex="-1"></a><span class="co"># system.file(&quot;tmp_images&quot;, &quot;slic_im.png&quot;, package = &quot;OpenImageR&quot;) %&gt;% </span></span>
<span id="cb87-8"><a href="rgb-classification.html#cb87-8" tabindex="-1"></a><span class="co">#   terra::rast() %&gt;% </span></span>
<span id="cb87-9"><a href="rgb-classification.html#cb87-9" tabindex="-1"></a><span class="co">#   # terra::subset(1) %&gt;% </span></span>
<span id="cb87-10"><a href="rgb-classification.html#cb87-10" tabindex="-1"></a><span class="co">#   # terra::plot()</span></span>
<span id="cb87-11"><a href="rgb-classification.html#cb87-11" tabindex="-1"></a><span class="co">#   terra::plotRGB()</span></span>
<span id="cb87-12"><a href="rgb-classification.html#cb87-12" tabindex="-1"></a></span>
<span id="cb87-13"><a href="rgb-classification.html#cb87-13" tabindex="-1"></a><span class="do">#### save files to disk as required by package</span></span>
<span id="cb87-14"><a href="rgb-classification.html#cb87-14" tabindex="-1"></a>tempdir_temp <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb87-15"><a href="rgb-classification.html#cb87-15" tabindex="-1"></a>fpath_train <span class="ot">&lt;-</span> <span class="fu">file.path</span>(tempdir_temp, <span class="st">&quot;train.tif&quot;</span>)</span>
<span id="cb87-16"><a href="rgb-classification.html#cb87-16" tabindex="-1"></a>fpath_seg <span class="ot">&lt;-</span> <span class="fu">file.path</span>(tempdir_temp, <span class="st">&quot;seg.tif&quot;</span>)</span>
<span id="cb87-17"><a href="rgb-classification.html#cb87-17" tabindex="-1"></a>fpath_class <span class="ot">&lt;-</span> <span class="fu">file.path</span>(tempdir_temp, <span class="st">&quot;class.tif&quot;</span>)</span>
<span id="cb87-18"><a href="rgb-classification.html#cb87-18" tabindex="-1"></a><span class="co"># write</span></span>
<span id="cb87-19"><a href="rgb-classification.html#cb87-19" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">writeRaster</span>(class_rast_training, <span class="at">filename =</span> fpath_train, <span class="at">overwrite =</span> T)</span>
<span id="cb87-20"><a href="rgb-classification.html#cb87-20" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">writeRaster</span>(</span>
<span id="cb87-21"><a href="rgb-classification.html#cb87-21" tabindex="-1"></a>  ortho_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;blue&quot;</span>))</span>
<span id="cb87-22"><a href="rgb-classification.html#cb87-22" tabindex="-1"></a>  , <span class="at">filename =</span> fpath_seg</span>
<span id="cb87-23"><a href="rgb-classification.html#cb87-23" tabindex="-1"></a>  , <span class="at">overwrite =</span> T</span>
<span id="cb87-24"><a href="rgb-classification.html#cb87-24" tabindex="-1"></a>)</span>
<span id="cb87-25"><a href="rgb-classification.html#cb87-25" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">writeRaster</span>(</span>
<span id="cb87-26"><a href="rgb-classification.html#cb87-26" tabindex="-1"></a>  pred_rast <span class="co"># includes indicies and textural as well as RGB</span></span>
<span id="cb87-27"><a href="rgb-classification.html#cb87-27" tabindex="-1"></a>  , <span class="at">filename =</span> fpath_class</span>
<span id="cb87-28"><a href="rgb-classification.html#cb87-28" tabindex="-1"></a>  , <span class="at">overwrite =</span> T</span>
<span id="cb87-29"><a href="rgb-classification.html#cb87-29" tabindex="-1"></a>)</span>
<span id="cb87-30"><a href="rgb-classification.html#cb87-30" tabindex="-1"></a></span>
<span id="cb87-31"><a href="rgb-classification.html#cb87-31" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb87-32"><a href="rgb-classification.html#cb87-32" tabindex="-1"></a>  pred_rast</span>
<span id="cb87-33"><a href="rgb-classification.html#cb87-33" tabindex="-1"></a>  , ortho_rast <span class="sc">%&gt;%</span> </span>
<span id="cb87-34"><a href="rgb-classification.html#cb87-34" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(<span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;blue&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb87-35"><a href="rgb-classification.html#cb87-35" tabindex="-1"></a>    <span class="fu">cumsum</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb87-36"><a href="rgb-classification.html#cb87-36" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-37"><a href="rgb-classification.html#cb87-37" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subst</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb87-38"><a href="rgb-classification.html#cb87-38" tabindex="-1"></a>  , <span class="at">inverse =</span> T</span>
<span id="cb87-39"><a href="rgb-classification.html#cb87-39" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-40"><a href="rgb-classification.html#cb87-40" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-41"><a href="rgb-classification.html#cb87-41" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>()</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-68-1.png" width="1008" /></p>
<p>we’ll implement the SLICO variation of SLIC because the user does not need to define the compactness parameter or try different values of it. SLICO adaptively chooses the compactness parameter for each superpixel differently. This generates regular shaped superpixels in both textured and non textured regions alike. The improvement comes with hardly any compromise on the computational efficiency - SLICO continues to be as fast as SLIC (<a href="https://www.epfl.ch/labs/ivrl/research/slic-superpixels/#SLICO"><strong>How is SLICO different from SLIC?</strong></a>)</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="rgb-classification.html#cb89-1" tabindex="-1"></a><span class="co">#--------------</span></span>
<span id="cb89-2"><a href="rgb-classification.html#cb89-2" tabindex="-1"></a><span class="co"># &quot;slico&quot; method</span></span>
<span id="cb89-3"><a href="rgb-classification.html#cb89-3" tabindex="-1"></a><span class="co">#--------------</span></span>
<span id="cb89-4"><a href="rgb-classification.html#cb89-4" tabindex="-1"></a><span class="co"># readImage on our RGB raster for segmentation</span></span>
<span id="cb89-5"><a href="rgb-classification.html#cb89-5" tabindex="-1"></a>im_temp <span class="ot">&lt;-</span> OpenImageR<span class="sc">::</span><span class="fu">readImage</span>(fpath_seg)</span>
<span id="cb89-6"><a href="rgb-classification.html#cb89-6" tabindex="-1"></a><span class="co"># str(im_temp)</span></span>
<span id="cb89-7"><a href="rgb-classification.html#cb89-7" tabindex="-1"></a></span>
<span id="cb89-8"><a href="rgb-classification.html#cb89-8" tabindex="-1"></a><span class="do">## number of superpixels to use</span></span>
<span id="cb89-9"><a href="rgb-classification.html#cb89-9" tabindex="-1"></a><span class="do">## set this to extent/minimum expected pile area?</span></span>
<span id="cb89-10"><a href="rgb-classification.html#cb89-10" tabindex="-1"></a>sp_temp <span class="ot">&lt;-</span> <span class="fu">floor</span>(</span>
<span id="cb89-11"><a href="rgb-classification.html#cb89-11" tabindex="-1"></a>    <span class="co"># raster area</span></span>
<span id="cb89-12"><a href="rgb-classification.html#cb89-12" tabindex="-1"></a>    ( terra<span class="sc">::</span><span class="fu">cellSize</span>(ortho_rast[[<span class="dv">1</span>]])[<span class="dv">1</span>]<span class="sc">*</span>terra<span class="sc">::</span><span class="fu">ncell</span>(ortho_rast[[<span class="dv">1</span>]]) ) <span class="sc">/</span> </span>
<span id="cb89-13"><a href="rgb-classification.html#cb89-13" tabindex="-1"></a>    <span class="co"># expected pile area</span></span>
<span id="cb89-14"><a href="rgb-classification.html#cb89-14" tabindex="-1"></a>      (</span>
<span id="cb89-15"><a href="rgb-classification.html#cb89-15" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb89-16"><a href="rgb-classification.html#cb89-16" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(area) <span class="sc">%&gt;%</span> </span>
<span id="cb89-17"><a href="rgb-classification.html#cb89-17" tabindex="-1"></a>        <span class="fu">quantile</span>(<span class="at">probs =</span> <span class="fl">0.33</span>)</span>
<span id="cb89-18"><a href="rgb-classification.html#cb89-18" tabindex="-1"></a>      )</span>
<span id="cb89-19"><a href="rgb-classification.html#cb89-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb89-20"><a href="rgb-classification.html#cb89-20" tabindex="-1"></a>  <span class="fu">max</span>(<span class="dv">200</span>) <span class="co"># 200 = function default</span></span>
<span id="cb89-21"><a href="rgb-classification.html#cb89-21" tabindex="-1"></a></span>
<span id="cb89-22"><a href="rgb-classification.html#cb89-22" tabindex="-1"></a>try_superpixels_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb89-23"><a href="rgb-classification.html#cb89-23" tabindex="-1"></a>  input_image</span>
<span id="cb89-24"><a href="rgb-classification.html#cb89-24" tabindex="-1"></a>  , <span class="at">method =</span> <span class="st">&quot;slico&quot;</span> </span>
<span id="cb89-25"><a href="rgb-classification.html#cb89-25" tabindex="-1"></a>  <span class="co"># number of superpixels to use</span></span>
<span id="cb89-26"><a href="rgb-classification.html#cb89-26" tabindex="-1"></a>  , <span class="at">superpixel =</span> <span class="dv">200</span></span>
<span id="cb89-27"><a href="rgb-classification.html#cb89-27" tabindex="-1"></a>  <span class="co"># numeric value specifying the compactness parameter. </span></span>
<span id="cb89-28"><a href="rgb-classification.html#cb89-28" tabindex="-1"></a>    <span class="co"># The compactness parameter is needed only if method is &quot;slic&quot;. The &quot;slico&quot; method adaptively chooses</span></span>
<span id="cb89-29"><a href="rgb-classification.html#cb89-29" tabindex="-1"></a>    <span class="co"># the compactness parameter for each superpixel differently</span></span>
<span id="cb89-30"><a href="rgb-classification.html#cb89-30" tabindex="-1"></a>  , <span class="at">compactness =</span> <span class="dv">20</span></span>
<span id="cb89-31"><a href="rgb-classification.html#cb89-31" tabindex="-1"></a>  <span class="co"># If TRUE then the resulted slic or slico data will be returned</span></span>
<span id="cb89-32"><a href="rgb-classification.html#cb89-32" tabindex="-1"></a>  , <span class="at">return_slic_data =</span> <span class="cn">TRUE</span></span>
<span id="cb89-33"><a href="rgb-classification.html#cb89-33" tabindex="-1"></a>  <span class="co"># If TRUE then the Lab data will be returned ( the Lab-colour format )</span></span>
<span id="cb89-34"><a href="rgb-classification.html#cb89-34" tabindex="-1"></a>  , <span class="at">return_labels =</span> <span class="cn">TRUE</span></span>
<span id="cb89-35"><a href="rgb-classification.html#cb89-35" tabindex="-1"></a>  <span class="co"># If not an empty string (&quot;&quot;) then it should be a path to the output file with extension .bin </span></span>
<span id="cb89-36"><a href="rgb-classification.html#cb89-36" tabindex="-1"></a>  , <span class="at">write_slic =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb89-37"><a href="rgb-classification.html#cb89-37" tabindex="-1"></a>  , <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb89-38"><a href="rgb-classification.html#cb89-38" tabindex="-1"></a>) {</span>
<span id="cb89-39"><a href="rgb-classification.html#cb89-39" tabindex="-1"></a>  <span class="co"># make sure sp is integer</span></span>
<span id="cb89-40"><a href="rgb-classification.html#cb89-40" tabindex="-1"></a>  new_sp <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(superpixel, <span class="dv">200</span>) <span class="sc">%&gt;%</span> <span class="fu">floor</span>()</span>
<span id="cb89-41"><a href="rgb-classification.html#cb89-41" tabindex="-1"></a>  <span class="co"># make a list of backup sp</span></span>
<span id="cb89-42"><a href="rgb-classification.html#cb89-42" tabindex="-1"></a>  try_sp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">max</span>(<span class="fu">floor</span>(new_sp<span class="sc">*</span><span class="fl">0.95</span>),<span class="dv">10</span>), <span class="at">to =</span> <span class="fu">max</span>(<span class="fu">floor</span>(new_sp<span class="sc">*</span><span class="fl">1.05</span>),<span class="dv">10</span>), <span class="at">by =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-43"><a href="rgb-classification.html#cb89-43" tabindex="-1"></a>    base<span class="sc">::</span><span class="fu">setdiff</span>(new_sp) <span class="sc">%&gt;%</span> </span>
<span id="cb89-44"><a href="rgb-classification.html#cb89-44" tabindex="-1"></a>    <span class="fu">sample</span>()</span>
<span id="cb89-45"><a href="rgb-classification.html#cb89-45" tabindex="-1"></a>  </span>
<span id="cb89-46"><a href="rgb-classification.html#cb89-46" tabindex="-1"></a>  <span class="co"># safe it</span></span>
<span id="cb89-47"><a href="rgb-classification.html#cb89-47" tabindex="-1"></a>  safe_superpixels <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(OpenImageR<span class="sc">::</span>superpixels)</span>
<span id="cb89-48"><a href="rgb-classification.html#cb89-48" tabindex="-1"></a>  </span>
<span id="cb89-49"><a href="rgb-classification.html#cb89-49" tabindex="-1"></a>  <span class="co"># while loop to handle superpixel errors</span></span>
<span id="cb89-50"><a href="rgb-classification.html#cb89-50" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb89-51"><a href="rgb-classification.html#cb89-51" tabindex="-1"></a>  </span>
<span id="cb89-52"><a href="rgb-classification.html#cb89-52" tabindex="-1"></a>  <span class="cf">while</span>(xx<span class="sc">!=</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> xx<span class="sc">&lt;</span><span class="fu">length</span>(try_sp)) {</span>
<span id="cb89-53"><a href="rgb-classification.html#cb89-53" tabindex="-1"></a>    <span class="co"># superpixels</span></span>
<span id="cb89-54"><a href="rgb-classification.html#cb89-54" tabindex="-1"></a>    superpixels_slico_ans <span class="ot">&lt;-</span> <span class="fu">safe_superpixels</span>(</span>
<span id="cb89-55"><a href="rgb-classification.html#cb89-55" tabindex="-1"></a>      <span class="at">input_image =</span> input_image</span>
<span id="cb89-56"><a href="rgb-classification.html#cb89-56" tabindex="-1"></a>      <span class="co"># Either &quot;slic&quot; or &quot;slico&quot;</span></span>
<span id="cb89-57"><a href="rgb-classification.html#cb89-57" tabindex="-1"></a>      , <span class="at">method =</span> method</span>
<span id="cb89-58"><a href="rgb-classification.html#cb89-58" tabindex="-1"></a>      <span class="co"># number of superpixels to use</span></span>
<span id="cb89-59"><a href="rgb-classification.html#cb89-59" tabindex="-1"></a>      , <span class="at">superpixel =</span> new_sp</span>
<span id="cb89-60"><a href="rgb-classification.html#cb89-60" tabindex="-1"></a>      <span class="co"># numeric value specifying the compactness parameter. </span></span>
<span id="cb89-61"><a href="rgb-classification.html#cb89-61" tabindex="-1"></a>        <span class="co"># The compactness parameter is needed only if method is &quot;slic&quot;. The &quot;slico&quot; method adaptively chooses</span></span>
<span id="cb89-62"><a href="rgb-classification.html#cb89-62" tabindex="-1"></a>        <span class="co"># the compactness parameter for each superpixel differently</span></span>
<span id="cb89-63"><a href="rgb-classification.html#cb89-63" tabindex="-1"></a>      <span class="co"># , compactness = 20 </span></span>
<span id="cb89-64"><a href="rgb-classification.html#cb89-64" tabindex="-1"></a>      <span class="co"># If TRUE then the resulted slic or slico data will be returned</span></span>
<span id="cb89-65"><a href="rgb-classification.html#cb89-65" tabindex="-1"></a>      , <span class="at">return_slic_data =</span> return_slic_data</span>
<span id="cb89-66"><a href="rgb-classification.html#cb89-66" tabindex="-1"></a>      <span class="co"># If TRUE then the Lab data will be returned ( the Lab-colour format )</span></span>
<span id="cb89-67"><a href="rgb-classification.html#cb89-67" tabindex="-1"></a>      , <span class="at">return_labels =</span> return_labels</span>
<span id="cb89-68"><a href="rgb-classification.html#cb89-68" tabindex="-1"></a>      <span class="co"># If not an empty string (&quot;&quot;) then it should be a path to the output file with extension .bin </span></span>
<span id="cb89-69"><a href="rgb-classification.html#cb89-69" tabindex="-1"></a>      , <span class="at">write_slic =</span> write_slic</span>
<span id="cb89-70"><a href="rgb-classification.html#cb89-70" tabindex="-1"></a>      , <span class="at">verbose =</span> verbose</span>
<span id="cb89-71"><a href="rgb-classification.html#cb89-71" tabindex="-1"></a>    )</span>
<span id="cb89-72"><a href="rgb-classification.html#cb89-72" tabindex="-1"></a>    </span>
<span id="cb89-73"><a href="rgb-classification.html#cb89-73" tabindex="-1"></a>    <span class="co"># check</span></span>
<span id="cb89-74"><a href="rgb-classification.html#cb89-74" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(superpixels_slico_ans<span class="sc">$</span>error)){</span>
<span id="cb89-75"><a href="rgb-classification.html#cb89-75" tabindex="-1"></a>      <span class="co"># just get the result</span></span>
<span id="cb89-76"><a href="rgb-classification.html#cb89-76" tabindex="-1"></a>      superpixels_slico_ans <span class="ot">&lt;-</span> superpixels_slico_ans<span class="sc">$</span>result</span>
<span id="cb89-77"><a href="rgb-classification.html#cb89-77" tabindex="-1"></a>      xx <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb89-78"><a href="rgb-classification.html#cb89-78" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb89-79"><a href="rgb-classification.html#cb89-79" tabindex="-1"></a>      <span class="cf">if</span>(xx<span class="sc">==</span><span class="dv">1</span>){<span class="fu">message</span>(<span class="st">&quot;attempting to adjust `superpixel` size.......&quot;</span>)}</span>
<span id="cb89-80"><a href="rgb-classification.html#cb89-80" tabindex="-1"></a>      <span class="co"># just get the result (in case we exit the while)</span></span>
<span id="cb89-81"><a href="rgb-classification.html#cb89-81" tabindex="-1"></a>      superpixels_slico_ans <span class="ot">&lt;-</span> superpixels_slico_ans<span class="sc">$</span>result</span>
<span id="cb89-82"><a href="rgb-classification.html#cb89-82" tabindex="-1"></a>      new_sp <span class="ot">&lt;-</span> try_sp[xx]</span>
<span id="cb89-83"><a href="rgb-classification.html#cb89-83" tabindex="-1"></a>      xx <span class="ot">&lt;-</span> xx<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb89-84"><a href="rgb-classification.html#cb89-84" tabindex="-1"></a>      </span>
<span id="cb89-85"><a href="rgb-classification.html#cb89-85" tabindex="-1"></a>    }</span>
<span id="cb89-86"><a href="rgb-classification.html#cb89-86" tabindex="-1"></a>  }</span>
<span id="cb89-87"><a href="rgb-classification.html#cb89-87" tabindex="-1"></a>  </span>
<span id="cb89-88"><a href="rgb-classification.html#cb89-88" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(superpixels_slico_ans)){<span class="fu">stop</span>(<span class="st">&quot;`superpixel` size not successfull, try a different value&quot;</span>)}</span>
<span id="cb89-89"><a href="rgb-classification.html#cb89-89" tabindex="-1"></a>  <span class="fu">return</span>(superpixels_slico_ans)</span>
<span id="cb89-90"><a href="rgb-classification.html#cb89-90" tabindex="-1"></a>    </span>
<span id="cb89-91"><a href="rgb-classification.html#cb89-91" tabindex="-1"></a>}</span>
<span id="cb89-92"><a href="rgb-classification.html#cb89-92" tabindex="-1"></a><span class="co"># run it</span></span>
<span id="cb89-93"><a href="rgb-classification.html#cb89-93" tabindex="-1"></a>superpixels_slico_ans <span class="ot">&lt;-</span> <span class="fu">try_superpixels_fn</span>(<span class="at">input_image =</span> im_temp, <span class="at">method =</span> <span class="st">&quot;slico&quot;</span>, <span class="at">superpixel =</span> sp_temp)</span></code></pre></div>
<pre><code>## The input image has the following dimensions: 3567 4552 3
## The &#39;slico&#39; method will be utilized!
## The output image has the following dimensions: 3567 4552 3</code></pre>
<p>what did we get back?</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="rgb-classification.html#cb91-1" tabindex="-1"></a><span class="fu">str</span>(superpixels_slico_ans)</span></code></pre></div>
<pre><code>## List of 2
##  $ slic_data: num [1:3567, 1:4552, 1:3] 0 0 0 0 0 0 0 0 0 0 ...
##  $ labels   : num [1:3567, 1:4552] 0 0 0 0 0 0 0 0 0 0 ...</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="rgb-classification.html#cb93-1" tabindex="-1"></a><span class="co"># superpixels_slico_ans$labels %&gt;% length()</span></span>
<span id="cb93-2"><a href="rgb-classification.html#cb93-2" tabindex="-1"></a><span class="co"># superpixels_slico_ans$labels %&gt;% unique() %&gt;% length()</span></span>
<span id="cb93-3"><a href="rgb-classification.html#cb93-3" tabindex="-1"></a><span class="co"># superpixels_slico_ans$labels %&gt;% dplyr::as_tibble() %&gt;% ncol()</span></span>
<span id="cb93-4"><a href="rgb-classification.html#cb93-4" tabindex="-1"></a><span class="co"># superpixels_slico_ans$labels %&gt;% dplyr::as_tibble() %&gt;% nrow()</span></span>
<span id="cb93-5"><a href="rgb-classification.html#cb93-5" tabindex="-1"></a><span class="co"># superpixels_slico_ans$slic_data %&gt;% str()</span></span></code></pre></div>
<p>let’s put the superpixels into a raster</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="rgb-classification.html#cb94-1" tabindex="-1"></a><span class="co"># use the ortho template so we get the projection and then fill with values</span></span>
<span id="cb94-2"><a href="rgb-classification.html#cb94-2" tabindex="-1"></a>superpixels_slico_rast <span class="ot">&lt;-</span> ortho_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">1</span>)</span>
<span id="cb94-3"><a href="rgb-classification.html#cb94-3" tabindex="-1"></a><span class="co"># fill raster with the superpixels</span></span>
<span id="cb94-4"><a href="rgb-classification.html#cb94-4" tabindex="-1"></a>superpixels_slico_rast[] <span class="ot">&lt;-</span> superpixels_slico_ans<span class="sc">$</span>labels <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb94-5"><a href="rgb-classification.html#cb94-5" tabindex="-1"></a>superpixels_slico_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">as.factor</span>(superpixels_slico_rast)</span>
<span id="cb94-6"><a href="rgb-classification.html#cb94-6" tabindex="-1"></a><span class="co"># reset the colors</span></span>
<span id="cb94-7"><a href="rgb-classification.html#cb94-7" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">coltab</span>(superpixels_slico_rast) <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb94-8"><a href="rgb-classification.html#cb94-8" tabindex="-1"></a>  <span class="at">value =</span> terra<span class="sc">::</span><span class="fu">minmax</span>(superpixels_slico_rast)[<span class="dv">1</span>]<span class="sc">:</span>terra<span class="sc">::</span><span class="fu">minmax</span>(superpixels_slico_rast)[<span class="dv">2</span>]</span>
<span id="cb94-9"><a href="rgb-classification.html#cb94-9" tabindex="-1"></a>  , <span class="at">col =</span> <span class="fu">c</span>(</span>
<span id="cb94-10"><a href="rgb-classification.html#cb94-10" tabindex="-1"></a>    viridis<span class="sc">::</span><span class="fu">turbo</span>(terra<span class="sc">::</span><span class="fu">unique</span>(superpixels_slico_rast) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">*</span><span class="st">`</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">ceiling</span>(), <span class="at">alpha =</span> <span class="fl">0.35</span>)</span>
<span id="cb94-11"><a href="rgb-classification.html#cb94-11" tabindex="-1"></a>    , viridis<span class="sc">::</span><span class="fu">viridis</span>(terra<span class="sc">::</span><span class="fu">unique</span>(superpixels_slico_rast) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">*</span><span class="st">`</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">ceiling</span>(), <span class="at">alpha =</span> <span class="fl">0.35</span>)</span>
<span id="cb94-12"><a href="rgb-classification.html#cb94-12" tabindex="-1"></a>    , viridis<span class="sc">::</span><span class="fu">cividis</span>(terra<span class="sc">::</span><span class="fu">unique</span>(superpixels_slico_rast) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">*</span><span class="st">`</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">ceiling</span>(), <span class="at">alpha =</span> <span class="fl">0.35</span>)</span>
<span id="cb94-13"><a href="rgb-classification.html#cb94-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb94-14"><a href="rgb-classification.html#cb94-14" tabindex="-1"></a>    <span class="fu">sample</span>(<span class="at">size =</span> (terra<span class="sc">::</span><span class="fu">unique</span>(superpixels_slico_rast) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()))</span>
<span id="cb94-15"><a href="rgb-classification.html#cb94-15" tabindex="-1"></a>)</span>
<span id="cb94-16"><a href="rgb-classification.html#cb94-16" tabindex="-1"></a><span class="co"># # plot</span></span>
<span id="cb94-17"><a href="rgb-classification.html#cb94-17" tabindex="-1"></a><span class="co"># superpixels_slico_rast %&gt;% terra::plot(legend = F, axes = F)</span></span></code></pre></div>
<p>let’s look at the superpixels overlaid on the RGB image with the slash pile locations (blue)</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="rgb-classification.html#cb95-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb95-2"><a href="rgb-classification.html#cb95-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(superpixels_slico_rast, <span class="at">add =</span> T, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb95-3"><a href="rgb-classification.html#cb95-3" tabindex="-1"></a><span class="co"># add polys</span></span>
<span id="cb95-4"><a href="rgb-classification.html#cb95-4" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb95-5"><a href="rgb-classification.html#cb95-5" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb95-6"><a href="rgb-classification.html#cb95-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span></span>
<span id="cb95-7"><a href="rgb-classification.html#cb95-7" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-72-1.png" width="1008" /></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="rgb-classification.html#cb96-1" tabindex="-1"></a><span class="co"># OpenImageR::NormalizeObject(superpixels_slico_ans$slic_data) %&gt;% </span></span>
<span id="cb96-2"><a href="rgb-classification.html#cb96-2" tabindex="-1"></a><span class="co">#   grDevices::as.raster() %&gt;% </span></span>
<span id="cb96-3"><a href="rgb-classification.html#cb96-3" tabindex="-1"></a><span class="co">#   graphics::plot()</span></span></code></pre></div>
<p>that’s neat, the superpixels are moderately aligned with the large machine piles but are generally too large for the smaller hand piles</p>
<p>the steps in the OBIA approach workflow described by <a href="https://doi.org/10.1016/j.jag.2018.11.011">Goncalves et al. (2019)</a> would be:</p>
<ol style="list-style-type: decimal">
<li>Image Segmentation (e.g. using SLIC) as demonstrated above</li>
<li>Feature Extraction for Superpixels: instead of using individual pixel values, extract features that describe each superpixel (e.g. spectral bands, band ratios, textural features)</li>
<li>Use labeled training data to assign superpixels to their respective classes and perform classifier training (i.e. using random forest, support vector machines, etc.)</li>
<li>Once the classifier is trained, you apply it to the features of all the unlabeled superpixels in the image</li>
</ol>
<div id="feature-extraction-for-superpixels" class="section level4 hasAnchor" number="3.4.2.1">
<h4><span class="header-section-number">3.4.2.1</span> Feature Extraction for Superpixels<a href="rgb-classification.html#feature-extraction-for-superpixels" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s classify the superpixels we generated using <a href="rgb-classification.html#slic">SLICO</a></p>
<ol style="list-style-type: decimal">
<li>Image Segmentation (e.g. using SLIC) as <a href="rgb-classification.html#slic">demonstrated above</a></li>
<li>Feature Extraction for Superpixels: instead of using individual pixel values, extract features that describe each superpixel (e.g. spectral bands, band ratios, textural features)</li>
<li>Use labeled training data to assign superpixels to their respective classes and perform classifier training (i.e. using random forest, support vector machines, etc.)</li>
<li>Once the classifier is trained, you apply it to the features of all the unlabeled superpixels in the image</li>
</ol>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="rgb-classification.html#cb97-1" tabindex="-1"></a><span class="co"># terra::plot(superpixels_slico_rast, legend = F)</span></span>
<span id="cb97-2"><a href="rgb-classification.html#cb97-2" tabindex="-1"></a><span class="co"># terra::values(superpixels_slico_rast) %&gt;% unique() %&gt;% length()</span></span>
<span id="cb97-3"><a href="rgb-classification.html#cb97-3" tabindex="-1"></a><span class="co"># terra::as.polygons(superpixels_slico_rast, aggregate = T, values = T) %&gt;% terra::plot(legend = T)</span></span>
<span id="cb97-4"><a href="rgb-classification.html#cb97-4" tabindex="-1"></a><span class="co"># convert superpixels to polygons</span></span>
<span id="cb97-5"><a href="rgb-classification.html#cb97-5" tabindex="-1"></a>superpixels_slico_sf <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">as.polygons</span>(superpixels_slico_rast, <span class="at">aggregate =</span> T, <span class="at">values =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb97-6"><a href="rgb-classification.html#cb97-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb97-7"><a href="rgb-classification.html#cb97-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">superpixel_id =</span> <span class="dv">1</span>)</span>
<span id="cb97-8"><a href="rgb-classification.html#cb97-8" tabindex="-1"></a><span class="co"># list of functions to aggregate pixel data to superpixel</span></span>
<span id="cb97-9"><a href="rgb-classification.html#cb97-9" tabindex="-1"></a>fn_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb97-10"><a href="rgb-classification.html#cb97-10" tabindex="-1"></a>  <span class="at">mean =</span> <span class="cf">function</span>(x){<span class="fu">mean</span>(x,<span class="at">na.rm =</span> T)}</span>
<span id="cb97-11"><a href="rgb-classification.html#cb97-11" tabindex="-1"></a>  , <span class="at">median =</span> <span class="cf">function</span>(x){<span class="fu">median</span>(x,<span class="at">na.rm =</span> T)}</span>
<span id="cb97-12"><a href="rgb-classification.html#cb97-12" tabindex="-1"></a>  , <span class="at">sd =</span> <span class="cf">function</span>(x){<span class="fu">sd</span>(x,<span class="at">na.rm =</span> T)}</span>
<span id="cb97-13"><a href="rgb-classification.html#cb97-13" tabindex="-1"></a>  , <span class="at">q90 =</span> <span class="cf">function</span>(x){<span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.9</span>, <span class="at">na.rm =</span> T)}</span>
<span id="cb97-14"><a href="rgb-classification.html#cb97-14" tabindex="-1"></a>  , <span class="at">q10 =</span> <span class="cf">function</span>(x){<span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.1</span>, <span class="at">na.rm =</span> T)}</span>
<span id="cb97-15"><a href="rgb-classification.html#cb97-15" tabindex="-1"></a>  <span class="co"># , mode = function(x) {</span></span>
<span id="cb97-16"><a href="rgb-classification.html#cb97-16" tabindex="-1"></a>  <span class="co">#     # Get the unique values in the vector</span></span>
<span id="cb97-17"><a href="rgb-classification.html#cb97-17" tabindex="-1"></a>  <span class="co">#     unique_values &lt;- unique(x)</span></span>
<span id="cb97-18"><a href="rgb-classification.html#cb97-18" tabindex="-1"></a>  <span class="co">#     # Calculate the frequency of each unique value</span></span>
<span id="cb97-19"><a href="rgb-classification.html#cb97-19" tabindex="-1"></a>  <span class="co">#     value_frequencies &lt;- tabulate(match(x, unique_values))</span></span>
<span id="cb97-20"><a href="rgb-classification.html#cb97-20" tabindex="-1"></a>  <span class="co">#     # Find the index of the maximum frequency</span></span>
<span id="cb97-21"><a href="rgb-classification.html#cb97-21" tabindex="-1"></a>  <span class="co">#     max_frequency_index &lt;- which.max(value_frequencies)[1]</span></span>
<span id="cb97-22"><a href="rgb-classification.html#cb97-22" tabindex="-1"></a>  <span class="co">#     # Return the unique value corresponding to the maximum frequency</span></span>
<span id="cb97-23"><a href="rgb-classification.html#cb97-23" tabindex="-1"></a>  <span class="co">#     return(unique_values[max_frequency_index])</span></span>
<span id="cb97-24"><a href="rgb-classification.html#cb97-24" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb97-25"><a href="rgb-classification.html#cb97-25" tabindex="-1"></a>)</span>
<span id="cb97-26"><a href="rgb-classification.html#cb97-26" tabindex="-1"></a><span class="co"># feature extraction for superpixels and aggregation</span></span>
<span id="cb97-27"><a href="rgb-classification.html#cb97-27" tabindex="-1"></a>superpixels_features_df <span class="ot">&lt;-</span></span>
<span id="cb97-28"><a href="rgb-classification.html#cb97-28" tabindex="-1"></a>  pred_rast <span class="sc">%&gt;%</span> </span>
<span id="cb97-29"><a href="rgb-classification.html#cb97-29" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb97-30"><a href="rgb-classification.html#cb97-30" tabindex="-1"></a>    <span class="at">y =</span> superpixels_slico_sf <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb97-31"><a href="rgb-classification.html#cb97-31" tabindex="-1"></a>    , <span class="at">ID =</span> T</span>
<span id="cb97-32"><a href="rgb-classification.html#cb97-32" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-33"><a href="rgb-classification.html#cb97-33" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span> </span>
<span id="cb97-34"><a href="rgb-classification.html#cb97-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb97-35"><a href="rgb-classification.html#cb97-35" tabindex="-1"></a>    <span class="at">.cols =</span> dplyr<span class="sc">::</span><span class="fu">where</span>(is.numeric)</span>
<span id="cb97-36"><a href="rgb-classification.html#cb97-36" tabindex="-1"></a>    , <span class="at">.fns =</span> fn_list</span>
<span id="cb97-37"><a href="rgb-classification.html#cb97-37" tabindex="-1"></a>    , <span class="at">.names =</span> <span class="st">&quot;{.col}_{.fn}&quot;</span></span>
<span id="cb97-38"><a href="rgb-classification.html#cb97-38" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb97-39"><a href="rgb-classification.html#cb97-39" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb97-40"><a href="rgb-classification.html#cb97-40" tabindex="-1"></a>  <span class="co"># get rid of summary variables for local_minima values since it&#39;s on 0-8 scale</span></span>
<span id="cb97-41"><a href="rgb-classification.html#cb97-41" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb97-42"><a href="rgb-classification.html#cb97-42" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">c</span>(</span>
<span id="cb97-43"><a href="rgb-classification.html#cb97-43" tabindex="-1"></a>      tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;local_minima_mean&quot;</span>)</span>
<span id="cb97-44"><a href="rgb-classification.html#cb97-44" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;local_minima_median&quot;</span>)</span>
<span id="cb97-45"><a href="rgb-classification.html#cb97-45" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;local_minima_sd&quot;</span>)</span>
<span id="cb97-46"><a href="rgb-classification.html#cb97-46" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;local_minima_q10&quot;</span>)</span>
<span id="cb97-47"><a href="rgb-classification.html#cb97-47" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;local_minima_q90&quot;</span>)</span>
<span id="cb97-48"><a href="rgb-classification.html#cb97-48" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;local_minima&quot;</span>) <span class="co"># just get rid of all local_minima since aggregation at this level just results in 0&#39;s</span></span>
<span id="cb97-49"><a href="rgb-classification.html#cb97-49" tabindex="-1"></a>    )</span>
<span id="cb97-50"><a href="rgb-classification.html#cb97-50" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-51"><a href="rgb-classification.html#cb97-51" tabindex="-1"></a>  <span class="co"># get rid of nan</span></span>
<span id="cb97-52"><a href="rgb-classification.html#cb97-52" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb97-53"><a href="rgb-classification.html#cb97-53" tabindex="-1"></a>    <span class="at">.cols =</span> dplyr<span class="sc">::</span><span class="fu">where</span>(is.numeric)</span>
<span id="cb97-54"><a href="rgb-classification.html#cb97-54" tabindex="-1"></a>    , <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(</span>
<span id="cb97-55"><a href="rgb-classification.html#cb97-55" tabindex="-1"></a>          <span class="fu">is.nan</span>(.x) <span class="sc">|</span> <span class="fu">is.infinite</span>(.x)</span>
<span id="cb97-56"><a href="rgb-classification.html#cb97-56" tabindex="-1"></a>          , <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb97-57"><a href="rgb-classification.html#cb97-57" tabindex="-1"></a>          , .x</span>
<span id="cb97-58"><a href="rgb-classification.html#cb97-58" tabindex="-1"></a>        )</span>
<span id="cb97-59"><a href="rgb-classification.html#cb97-59" tabindex="-1"></a>  ))</span>
<span id="cb97-60"><a href="rgb-classification.html#cb97-60" tabindex="-1"></a><span class="co"># add to the spatial data</span></span>
<span id="cb97-61"><a href="rgb-classification.html#cb97-61" tabindex="-1"></a>superpixels_slico_sf <span class="ot">&lt;-</span> superpixels_slico_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(superpixels_features_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>ID))</span></code></pre></div>
<p>let’s check out that we got what we expected by plotting median GRVI in each superpixel</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="rgb-classification.html#cb98-1" tabindex="-1"></a>superpixels_slico_sf <span class="sc">%&gt;%</span></span>
<span id="cb98-2"><a href="rgb-classification.html#cb98-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb98-3"><a href="rgb-classification.html#cb98-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> grvi_median)) <span class="sc">+</span></span>
<span id="cb98-4"><a href="rgb-classification.html#cb98-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="at">option =</span> <span class="st">&quot;slytherin&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb98-5"><a href="rgb-classification.html#cb98-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span> </span>
<span id="cb98-6"><a href="rgb-classification.html#cb98-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-74-1.png" width="1008" /></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="rgb-classification.html#cb99-1" tabindex="-1"></a><span class="co"># grvi_rast %&gt;% terra::aggregate(fact = 4) %&gt;%  </span></span>
<span id="cb99-2"><a href="rgb-classification.html#cb99-2" tabindex="-1"></a><span class="co">#   terra::plot(axes = F, legend = F, col = harrypotter::hp(n=200, option = &quot;slytherin&quot;))</span></span></code></pre></div>
<p>looks good. now we’ll use the training data to attach pile/non-pile information to each superpixel</p>
<p>we’ll take the mean of the 0/1 values to get the proportion of the superpixel that overlaps with the location of a pile (think of this as the probability that a superpixel is a pile)</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="rgb-classification.html#cb100-1" tabindex="-1"></a><span class="co"># get list of all piles that intersect with a training tile so that full pile extent can be added to training</span></span>
<span id="cb100-2"><a href="rgb-classification.html#cb100-2" tabindex="-1"></a>training_pile_id <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb100-3"><a href="rgb-classification.html#cb100-3" tabindex="-1"></a>    superpixels_slico_sf <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb100-4"><a href="rgb-classification.html#cb100-4" tabindex="-1"></a>    , sample_grid <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">as.polygons</span>()</span>
<span id="cb100-5"><a href="rgb-classification.html#cb100-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb100-6"><a href="rgb-classification.html#cb100-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb100-7"><a href="rgb-classification.html#cb100-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(slash_piles_polys)) <span class="sc">%&gt;%</span> </span>
<span id="cb100-8"><a href="rgb-classification.html#cb100-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(superpixel_id) <span class="sc">%&gt;%</span> </span>
<span id="cb100-9"><a href="rgb-classification.html#cb100-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_intersection</span>(slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb100-10"><a href="rgb-classification.html#cb100-10" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb100-11"><a href="rgb-classification.html#cb100-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb100-12"><a href="rgb-classification.html#cb100-12" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb100-13"><a href="rgb-classification.html#cb100-13" tabindex="-1"></a><span class="co"># unique training superpixel ids</span></span>
<span id="cb100-14"><a href="rgb-classification.html#cb100-14" tabindex="-1"></a>training_superpixel_id <span class="ot">&lt;-</span> </span>
<span id="cb100-15"><a href="rgb-classification.html#cb100-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb100-16"><a href="rgb-classification.html#cb100-16" tabindex="-1"></a>    <span class="co"># superpixels that are in the training grid</span></span>
<span id="cb100-17"><a href="rgb-classification.html#cb100-17" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb100-18"><a href="rgb-classification.html#cb100-18" tabindex="-1"></a>        superpixels_slico_sf <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb100-19"><a href="rgb-classification.html#cb100-19" tabindex="-1"></a>        , sample_grid <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">as.polygons</span>()</span>
<span id="cb100-20"><a href="rgb-classification.html#cb100-20" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb100-21"><a href="rgb-classification.html#cb100-21" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb100-22"><a href="rgb-classification.html#cb100-22" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(superpixel_id)</span>
<span id="cb100-23"><a href="rgb-classification.html#cb100-23" tabindex="-1"></a>    <span class="co"># superpixels of piles that intersect with training grid</span></span>
<span id="cb100-24"><a href="rgb-classification.html#cb100-24" tabindex="-1"></a>    , terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb100-25"><a href="rgb-classification.html#cb100-25" tabindex="-1"></a>        superpixels_slico_sf <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb100-26"><a href="rgb-classification.html#cb100-26" tabindex="-1"></a>        , slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb100-27"><a href="rgb-classification.html#cb100-27" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(pile_id <span class="sc">%in%</span> training_pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb100-28"><a href="rgb-classification.html#cb100-28" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(superpixels_slico_sf)) <span class="sc">%&gt;%</span> </span>
<span id="cb100-29"><a href="rgb-classification.html#cb100-29" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb100-30"><a href="rgb-classification.html#cb100-30" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb100-31"><a href="rgb-classification.html#cb100-31" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb100-32"><a href="rgb-classification.html#cb100-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(superpixel_id)</span>
<span id="cb100-33"><a href="rgb-classification.html#cb100-33" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb100-34"><a href="rgb-classification.html#cb100-34" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb100-35"><a href="rgb-classification.html#cb100-35" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(superpixel_id) <span class="sc">%&gt;%</span> </span>
<span id="cb100-36"><a href="rgb-classification.html#cb100-36" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb100-37"><a href="rgb-classification.html#cb100-37" tabindex="-1"></a><span class="co"># extract classified values</span></span>
<span id="cb100-38"><a href="rgb-classification.html#cb100-38" tabindex="-1"></a>training_df <span class="ot">&lt;-</span> class_rast <span class="sc">%&gt;%</span></span>
<span id="cb100-39"><a href="rgb-classification.html#cb100-39" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb100-40"><a href="rgb-classification.html#cb100-40" tabindex="-1"></a>    <span class="at">y =</span> superpixels_slico_sf <span class="sc">%&gt;%</span> </span>
<span id="cb100-41"><a href="rgb-classification.html#cb100-41" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(superpixel_id <span class="sc">%in%</span> training_superpixel_id) <span class="sc">%&gt;%</span> </span>
<span id="cb100-42"><a href="rgb-classification.html#cb100-42" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb100-43"><a href="rgb-classification.html#cb100-43" tabindex="-1"></a>    , <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span></span>
<span id="cb100-44"><a href="rgb-classification.html#cb100-44" tabindex="-1"></a>    , <span class="at">ID =</span> T</span>
<span id="cb100-45"><a href="rgb-classification.html#cb100-45" tabindex="-1"></a>    , <span class="at">na.rm =</span> T</span>
<span id="cb100-46"><a href="rgb-classification.html#cb100-46" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb100-47"><a href="rgb-classification.html#cb100-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">pr_pile =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb100-48"><a href="rgb-classification.html#cb100-48" tabindex="-1"></a>  <span class="co"># get rid of nan</span></span>
<span id="cb100-49"><a href="rgb-classification.html#cb100-49" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb100-50"><a href="rgb-classification.html#cb100-50" tabindex="-1"></a>    <span class="at">.cols =</span> dplyr<span class="sc">::</span><span class="fu">where</span>(is.numeric)</span>
<span id="cb100-51"><a href="rgb-classification.html#cb100-51" tabindex="-1"></a>    , <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(</span>
<span id="cb100-52"><a href="rgb-classification.html#cb100-52" tabindex="-1"></a>          <span class="fu">is.nan</span>(.x) <span class="sc">|</span> <span class="fu">is.infinite</span>(.x)</span>
<span id="cb100-53"><a href="rgb-classification.html#cb100-53" tabindex="-1"></a>          , <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb100-54"><a href="rgb-classification.html#cb100-54" tabindex="-1"></a>          , .x</span>
<span id="cb100-55"><a href="rgb-classification.html#cb100-55" tabindex="-1"></a>        )</span>
<span id="cb100-56"><a href="rgb-classification.html#cb100-56" tabindex="-1"></a>  ))</span>
<span id="cb100-57"><a href="rgb-classification.html#cb100-57" tabindex="-1"></a><span class="co"># join with features and pile id&#39;s, geometry</span></span>
<span id="cb100-58"><a href="rgb-classification.html#cb100-58" tabindex="-1"></a>training_df <span class="ot">&lt;-</span> superpixels_slico_sf <span class="sc">%&gt;%</span> </span>
<span id="cb100-59"><a href="rgb-classification.html#cb100-59" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(superpixel_id <span class="sc">%in%</span> training_superpixel_id) <span class="sc">%&gt;%</span> </span>
<span id="cb100-60"><a href="rgb-classification.html#cb100-60" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(training_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>ID)) <span class="sc">%&gt;%</span> </span>
<span id="cb100-61"><a href="rgb-classification.html#cb100-61" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pr_pile)) <span class="sc">%&gt;%</span> <span class="co"># because all values should be filled except for validation data</span></span>
<span id="cb100-62"><a href="rgb-classification.html#cb100-62" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>dplyr<span class="sc">::</span><span class="fu">if_any</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">is.na</span>(.x))) <span class="co"># cant pass NA to classifier</span></span>
<span id="cb100-63"><a href="rgb-classification.html#cb100-63" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb100-64"><a href="rgb-classification.html#cb100-64" tabindex="-1"></a>training_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 25,665
## Columns: 43
## $ superpixel_id                &lt;chr&gt; &quot;47&quot;, &quot;48&quot;, &quot;49&quot;, &quot;50&quot;, &quot;51&quot;, &quot;52&quot;, &quot;53&quot;,…
## $ red_mean                     &lt;dbl&gt; 21.767563, 46.749095, 19.953840, 12.44606…
## $ red_median                   &lt;dbl&gt; 19.696625, 50.754591, 1.608867, 7.848655,…
## $ red_sd                       &lt;dbl&gt; 7.639728, 12.470943, 31.509077, 12.638649…
## $ red_q90                      &lt;dbl&gt; 32.22101, 57.75210, 69.72624, 19.84112, 4…
## $ red_q10                      &lt;dbl&gt; 15.77217579, 29.21840305, 1.40461161, 3.1…
## $ green_mean                   &lt;dbl&gt; 21.450014, 41.930914, 17.301691, 11.46977…
## $ green_median                 &lt;dbl&gt; 19.932217, 44.475443, 1.557654, 7.840939,…
## $ green_sd                     &lt;dbl&gt; 7.289669, 10.887189, 27.072117, 10.786032…
## $ green_q90                    &lt;dbl&gt; 31.19603, 52.65567, 59.46888, 19.09069, 3…
## $ green_q10                    &lt;dbl&gt; 15.23379421, 25.60449314, 1.35912106, 2.3…
## $ blue_mean                    &lt;dbl&gt; 21.223033, 38.692076, 16.421043, 12.15558…
## $ blue_median                  &lt;dbl&gt; 19.762735, 40.345798, 1.637315, 8.053426,…
## $ blue_sd                      &lt;dbl&gt; 7.159253, 9.446573, 25.515555, 12.825506,…
## $ blue_q90                     &lt;dbl&gt; 30.52344, 48.29850, 56.74656, 19.71091, 3…
## $ blue_q10                     &lt;dbl&gt; 14.89831448, 23.95985260, 1.37880456, 2.3…
## $ panchromatic_local_sd_mean   &lt;dbl&gt; 366.42287, 301.51081, 312.21288, 338.5182…
## $ panchromatic_local_sd_median &lt;dbl&gt; 373.19644, 299.00290, 323.81876, 344.9524…
## $ panchromatic_local_sd_sd     &lt;dbl&gt; 21.002484, 19.107769, 38.274649, 19.22201…
## $ panchromatic_local_sd_q90    &lt;dbl&gt; 387.5803, 325.2822, 345.1707, 357.7225, 3…
## $ panchromatic_local_sd_q10    &lt;dbl&gt; 332.06888, 277.40496, 248.97193, 307.2339…
## $ panchromatic_local_cv_mean   &lt;dbl&gt; 3.386147, 2.635426, 3.691383, 4.068323, 3…
## $ panchromatic_local_cv_median &lt;dbl&gt; 3.428917, 2.537249, 4.259719, 4.126117, 3…
## $ panchromatic_local_cv_sd     &lt;dbl&gt; 0.2466124, 0.2871714, 0.9722439, 0.267112…
## $ panchromatic_local_cv_q90    &lt;dbl&gt; 3.684865, 3.037793, 4.392207, 4.427118, 3…
## $ panchromatic_local_cv_q10    &lt;dbl&gt; 3.033616, 2.334978, 2.132736, 3.689202, 3…
## $ grvi_mean                    &lt;dbl&gt; -0.006145718, -0.053105532, -0.030989022,…
## $ grvi_median                  &lt;dbl&gt; -0.010889890, -0.055965302, -0.022559599,…
## $ grvi_sd                      &lt;dbl&gt; 0.015857074, 0.015575469, 0.031271478, 0.…
## $ grvi_q90                     &lt;dbl&gt; 0.018913497, -0.038273566, -0.001872316, …
## $ grvi_q10                     &lt;dbl&gt; -0.021580103, -0.066212887, -0.079983293,…
## $ grvi_local_sd_mean           &lt;dbl&gt; 0.09162822, 0.09223491, 0.12474839, 0.264…
## $ grvi_local_sd_median         &lt;dbl&gt; 0.09342653, 0.08991079, 0.11806135, 0.245…
## $ grvi_local_sd_sd             &lt;dbl&gt; 0.015398625, 0.014933248, 0.022655873, 0.…
## $ grvi_local_sd_q90            &lt;dbl&gt; 0.10859583, 0.11734346, 0.15286480, 0.367…
## $ grvi_local_sd_q10            &lt;dbl&gt; 0.06897724, 0.07739877, 0.09815619, 0.188…
## $ grvi_local_cv_mean           &lt;dbl&gt; 0.96301870, 0.00000000, 0.13333333, 0.086…
## $ grvi_local_cv_median         &lt;dbl&gt; 0.000000, 0.000000, 0.000000, 0.000000, 0…
## $ grvi_local_cv_sd             &lt;dbl&gt; 1.2148062, 0.0000000, 0.3518658, 0.288104…
## $ grvi_local_cv_q90            &lt;dbl&gt; 2.414828, 0.000000, 0.600000, 0.000000, 5…
## $ grvi_local_cv_q10            &lt;dbl&gt; 0.000000, 0.000000, 0.000000, 0.000000, 0…
## $ pr_pile                      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ geometry                     &lt;POLYGON [m]&gt; POLYGON ((499424.5 4318139,..., P…</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="rgb-classification.html#cb102-1" tabindex="-1"></a><span class="co"># training_df %&gt;% terra::vect() %&gt;% terra::plot()</span></span></code></pre></div>
<p>check the training versus validation (dimmed) data with the superpixels overlaid</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="rgb-classification.html#cb103-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(class_rast_training, <span class="at">axes=</span>F, <span class="at">legend =</span> F)</span>
<span id="cb103-2"><a href="rgb-classification.html#cb103-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(class_rast, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">add =</span> T, <span class="at">axes=</span>F, <span class="at">legend =</span> F)</span>
<span id="cb103-3"><a href="rgb-classification.html#cb103-3" tabindex="-1"></a>training_df <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>() <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">add =</span> T)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-78-1.png" width="1008" /></p>
<p>for superpixels covered by a pile, what is the distribution of percentage of superpixel that is covered by a pile?</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="rgb-classification.html#cb104-1" tabindex="-1"></a>training_df <span class="sc">%&gt;%</span> </span>
<span id="cb104-2"><a href="rgb-classification.html#cb104-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pr_pile<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-3"><a href="rgb-classification.html#cb104-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pr_pile) <span class="sc">%&gt;%</span> </span>
<span id="cb104-4"><a href="rgb-classification.html#cb104-4" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## 0.001698 0.056225 0.197605 0.330665 0.548926 1.000000</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="rgb-classification.html#cb106-1" tabindex="-1"></a>median_pile_pct_overlap <span class="ot">&lt;-</span></span>
<span id="cb106-2"><a href="rgb-classification.html#cb106-2" tabindex="-1"></a>  training_df <span class="sc">%&gt;%</span> </span>
<span id="cb106-3"><a href="rgb-classification.html#cb106-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pr_pile<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-4"><a href="rgb-classification.html#cb106-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pr_pile) <span class="sc">%&gt;%</span> </span>
<span id="cb106-5"><a href="rgb-classification.html#cb106-5" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="at">probs =</span> <span class="fl">0.44</span>, <span class="at">na.rm =</span> T)</span></code></pre></div>
<p>check it on the map</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="rgb-classification.html#cb107-1" tabindex="-1"></a>training_df <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="rgb-classification.html#cb107-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb107-3"><a href="rgb-classification.html#cb107-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pr_pile)) <span class="sc">+</span></span>
<span id="cb107-4"><a href="rgb-classification.html#cb107-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> slash_piles_polys, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb107-5"><a href="rgb-classification.html#cb107-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb107-6"><a href="rgb-classification.html#cb107-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-81-1.png" width="1008" /></p>
<p>we can also see what it looks like if we include only pixels with &gt;16% (~median value) of their area covered by a pile</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="rgb-classification.html#cb108-1" tabindex="-1"></a>training_df <span class="sc">%&gt;%</span> </span>
<span id="cb108-2"><a href="rgb-classification.html#cb108-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-3"><a href="rgb-classification.html#cb108-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pr_pile<span class="sc">&gt;=</span>median_pile_pct_overlap)) <span class="sc">+</span></span>
<span id="cb108-4"><a href="rgb-classification.html#cb108-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> slash_piles_polys, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-5"><a href="rgb-classification.html#cb108-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb108-6"><a href="rgb-classification.html#cb108-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="fu">paste0</span>(<span class="st">&quot;pr_pile&gt;&quot;</span>,scales<span class="sc">::</span><span class="fu">percent</span>(median_pile_pct_overlap,<span class="at">accuracy=</span><span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb108-7"><a href="rgb-classification.html#cb108-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-82-1.png" width="1008" /></p>
</div>
<div id="classifier-training-for-superpixels" class="section level4 hasAnchor" number="3.4.2.2">
<h4><span class="header-section-number">3.4.2.2</span> Classifier training for Superpixels<a href="rgb-classification.html#classifier-training-for-superpixels" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>nice, now let’s train the a random forest classifier to predict superpixel values</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="rgb-classification.html#cb109-1" tabindex="-1"></a><span class="co"># Tune on the full data if below threshold</span></span>
<span id="cb109-2"><a href="rgb-classification.html#cb109-2" tabindex="-1"></a>tune_result_temp <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">tuneRF</span>(</span>
<span id="cb109-3"><a href="rgb-classification.html#cb109-3" tabindex="-1"></a>  <span class="at">y =</span> training_df<span class="sc">$</span>pr_pile</span>
<span id="cb109-4"><a href="rgb-classification.html#cb109-4" tabindex="-1"></a>  , <span class="at">x =</span> training_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(superpixel_id,pr_pile))</span>
<span id="cb109-5"><a href="rgb-classification.html#cb109-5" tabindex="-1"></a>  , <span class="at">ntreeTry =</span> <span class="dv">500</span></span>
<span id="cb109-6"><a href="rgb-classification.html#cb109-6" tabindex="-1"></a>  , <span class="at">stepFactor =</span> <span class="dv">1</span></span>
<span id="cb109-7"><a href="rgb-classification.html#cb109-7" tabindex="-1"></a>  , <span class="at">improve =</span> <span class="fl">0.03</span></span>
<span id="cb109-8"><a href="rgb-classification.html#cb109-8" tabindex="-1"></a>  , <span class="at">plot =</span> F</span>
<span id="cb109-9"><a href="rgb-classification.html#cb109-9" tabindex="-1"></a>  , <span class="at">trace =</span> F</span>
<span id="cb109-10"><a href="rgb-classification.html#cb109-10" tabindex="-1"></a>)</span>
<span id="cb109-11"><a href="rgb-classification.html#cb109-11" tabindex="-1"></a><span class="co"># Extract the optimal mtry value</span></span>
<span id="cb109-12"><a href="rgb-classification.html#cb109-12" tabindex="-1"></a>optimal_mtry_temp <span class="ot">&lt;-</span> tune_result_temp <span class="sc">%&gt;%</span></span>
<span id="cb109-13"><a href="rgb-classification.html#cb109-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb109-14"><a href="rgb-classification.html#cb109-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(OOBError<span class="sc">==</span><span class="fu">min</span>(OOBError)) <span class="sc">%&gt;%</span></span>
<span id="cb109-15"><a href="rgb-classification.html#cb109-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb109-16"><a href="rgb-classification.html#cb109-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(mtry) <span class="sc">%&gt;%</span></span>
<span id="cb109-17"><a href="rgb-classification.html#cb109-17" tabindex="-1"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb109-18"><a href="rgb-classification.html#cb109-18" tabindex="-1"></a><span class="co"># pass to random forest model</span></span>
<span id="cb109-19"><a href="rgb-classification.html#cb109-19" tabindex="-1"></a>mod_rf <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">randomForest</span>(</span>
<span id="cb109-20"><a href="rgb-classification.html#cb109-20" tabindex="-1"></a>  <span class="at">y =</span> training_df<span class="sc">$</span>pr_pile</span>
<span id="cb109-21"><a href="rgb-classification.html#cb109-21" tabindex="-1"></a>  , <span class="at">x =</span> training_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(superpixel_id,pr_pile))</span>
<span id="cb109-22"><a href="rgb-classification.html#cb109-22" tabindex="-1"></a>  , <span class="at">mtry =</span> optimal_mtry_temp</span>
<span id="cb109-23"><a href="rgb-classification.html#cb109-23" tabindex="-1"></a>  , <span class="at">na.action =</span> na.omit</span>
<span id="cb109-24"><a href="rgb-classification.html#cb109-24" tabindex="-1"></a>  , <span class="at">ntree =</span> <span class="dv">500</span></span>
<span id="cb109-25"><a href="rgb-classification.html#cb109-25" tabindex="-1"></a>)</span></code></pre></div>
<p>random forest variable importance plot</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="rgb-classification.html#cb110-1" tabindex="-1"></a><span class="co">#variable importance plot</span></span>
<span id="cb110-2"><a href="rgb-classification.html#cb110-2" tabindex="-1"></a>randomForest<span class="sc">::</span><span class="fu">varImpPlot</span>(mod_rf)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-84-1.png" width="1008" /></p>
</div>
<div id="predict-values-for-validation-superpixels" class="section level4 hasAnchor" number="3.4.2.3">
<h4><span class="header-section-number">3.4.2.3</span> Predict values for validation superpixels<a href="rgb-classification.html#predict-values-for-validation-superpixels" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Predict values for validation superpixels</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="rgb-classification.html#cb111-1" tabindex="-1"></a>validation_df <span class="ot">&lt;-</span> superpixels_slico_sf <span class="sc">%&gt;%</span> </span>
<span id="cb111-2"><a href="rgb-classification.html#cb111-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>superpixel_id <span class="sc">%in%</span> training_superpixel_id) <span class="sc">%&gt;%</span> </span>
<span id="cb111-3"><a href="rgb-classification.html#cb111-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>dplyr<span class="sc">::</span><span class="fu">if_any</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">is.na</span>(.x))) <span class="co"># cant pass NA to classifier</span></span>
<span id="cb111-4"><a href="rgb-classification.html#cb111-4" tabindex="-1"></a><span class="co"># predict</span></span>
<span id="cb111-5"><a href="rgb-classification.html#cb111-5" tabindex="-1"></a>validation_df <span class="ot">&lt;-</span> validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb111-6"><a href="rgb-classification.html#cb111-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb111-7"><a href="rgb-classification.html#cb111-7" tabindex="-1"></a>    <span class="at">pr_pile_pred =</span> stats<span class="sc">::</span><span class="fu">predict</span>(</span>
<span id="cb111-8"><a href="rgb-classification.html#cb111-8" tabindex="-1"></a>      mod_rf</span>
<span id="cb111-9"><a href="rgb-classification.html#cb111-9" tabindex="-1"></a>      , <span class="at">newdata =</span> validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb111-10"><a href="rgb-classification.html#cb111-10" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb111-11"><a href="rgb-classification.html#cb111-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb111-12"><a href="rgb-classification.html#cb111-12" tabindex="-1"></a>          training_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(superpixel_id,pr_pile)) <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span>
<span id="cb111-13"><a href="rgb-classification.html#cb111-13" tabindex="-1"></a>        )</span>
<span id="cb111-14"><a href="rgb-classification.html#cb111-14" tabindex="-1"></a>    )</span>
<span id="cb111-15"><a href="rgb-classification.html#cb111-15" tabindex="-1"></a>  )</span></code></pre></div>
<p>we’ll also apply predictions to the full extent, but won’t use this data for anything except to possibly identify piles that were missed in the field or image-annotation ground truth comparison</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="rgb-classification.html#cb112-1" tabindex="-1"></a><span class="co"># predict</span></span>
<span id="cb112-2"><a href="rgb-classification.html#cb112-2" tabindex="-1"></a>superpixels_slico_sf <span class="ot">&lt;-</span></span>
<span id="cb112-3"><a href="rgb-classification.html#cb112-3" tabindex="-1"></a>  superpixels_slico_sf <span class="sc">%&gt;%</span> </span>
<span id="cb112-4"><a href="rgb-classification.html#cb112-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb112-5"><a href="rgb-classification.html#cb112-5" tabindex="-1"></a>    superpixels_slico_sf <span class="sc">%&gt;%</span> </span>
<span id="cb112-6"><a href="rgb-classification.html#cb112-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>dplyr<span class="sc">::</span><span class="fu">if_any</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">is.na</span>(.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb112-7"><a href="rgb-classification.html#cb112-7" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-8"><a href="rgb-classification.html#cb112-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(superpixel_id) <span class="sc">%&gt;%</span> </span>
<span id="cb112-9"><a href="rgb-classification.html#cb112-9" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb112-10"><a href="rgb-classification.html#cb112-10" tabindex="-1"></a>      <span class="at">pr_pile_pred =</span> stats<span class="sc">::</span><span class="fu">predict</span>(</span>
<span id="cb112-11"><a href="rgb-classification.html#cb112-11" tabindex="-1"></a>        mod_rf</span>
<span id="cb112-12"><a href="rgb-classification.html#cb112-12" tabindex="-1"></a>        , <span class="at">newdata =</span> superpixels_slico_sf <span class="sc">%&gt;%</span> </span>
<span id="cb112-13"><a href="rgb-classification.html#cb112-13" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>dplyr<span class="sc">::</span><span class="fu">if_any</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">is.na</span>(.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb112-14"><a href="rgb-classification.html#cb112-14" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-15"><a href="rgb-classification.html#cb112-15" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb112-16"><a href="rgb-classification.html#cb112-16" tabindex="-1"></a>            training_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(superpixel_id,pr_pile)) <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span>
<span id="cb112-17"><a href="rgb-classification.html#cb112-17" tabindex="-1"></a>          )</span>
<span id="cb112-18"><a href="rgb-classification.html#cb112-18" tabindex="-1"></a>      )</span>
<span id="cb112-19"><a href="rgb-classification.html#cb112-19" tabindex="-1"></a>    )</span>
<span id="cb112-20"><a href="rgb-classification.html#cb112-20" tabindex="-1"></a>  )</span>
<span id="cb112-21"><a href="rgb-classification.html#cb112-21" tabindex="-1"></a></span>
<span id="cb112-22"><a href="rgb-classification.html#cb112-22" tabindex="-1"></a><span class="co"># combine pile predictions into polygons</span></span>
<span id="cb112-23"><a href="rgb-classification.html#cb112-23" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb112-24"><a href="rgb-classification.html#cb112-24" tabindex="-1"></a>    superpixels_slico_sf <span class="sc">%&gt;%</span> </span>
<span id="cb112-25"><a href="rgb-classification.html#cb112-25" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pr_pile_pred<span class="sc">&gt;=</span>median_pile_pct_overlap) <span class="sc">%&gt;%</span> </span>
<span id="cb112-26"><a href="rgb-classification.html#cb112-26" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_union</span>(<span class="at">by_feature =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb112-27"><a href="rgb-classification.html#cb112-27" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-28"><a href="rgb-classification.html#cb112-28" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-29"><a href="rgb-classification.html#cb112-29" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_pile_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>() <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb112-30"><a href="rgb-classification.html#cb112-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pred_pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb112-31"><a href="rgb-classification.html#cb112-31" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb112-32"><a href="rgb-classification.html#cb112-32" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb112-33"><a href="rgb-classification.html#cb112-33" tabindex="-1"></a>    , ortho_rast <span class="sc">%&gt;%</span> </span>
<span id="cb112-34"><a href="rgb-classification.html#cb112-34" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">subset</span>(<span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;blue&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb112-35"><a href="rgb-classification.html#cb112-35" tabindex="-1"></a>        <span class="fu">cumsum</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-36"><a href="rgb-classification.html#cb112-36" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-37"><a href="rgb-classification.html#cb112-37" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">subst</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-38"><a href="rgb-classification.html#cb112-38" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">as.polygons</span>()</span>
<span id="cb112-39"><a href="rgb-classification.html#cb112-39" tabindex="-1"></a>      , <span class="at">inverse =</span> T</span>
<span id="cb112-40"><a href="rgb-classification.html#cb112-40" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb112-41"><a href="rgb-classification.html#cb112-41" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-42"><a href="rgb-classification.html#cb112-42" tabindex="-1"></a>  <span class="co"># ggplot() + geom_sf()</span></span>
<span id="cb112-43"><a href="rgb-classification.html#cb112-43" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="st">&quot;../data/predicted_piles_obia.gpkg&quot;</span>, <span class="at">append =</span> F)</span></code></pre></div>
<pre><code>## Deleting layer `predicted_piles_obia&#39; using driver `GPKG&#39;
## Writing layer `predicted_piles_obia&#39; to data source 
##   `../data/predicted_piles_obia.gpkg&#39; using driver `GPKG&#39;
## Writing 204 features with 1 fields and geometry type Polygon.</code></pre>
<p>plot predictions in validation area</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="rgb-classification.html#cb114-1" tabindex="-1"></a>validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb114-2"><a href="rgb-classification.html#cb114-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb114-3"><a href="rgb-classification.html#cb114-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pr_pile_pred)) <span class="sc">+</span></span>
<span id="cb114-4"><a href="rgb-classification.html#cb114-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> slash_piles_polys, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb114-5"><a href="rgb-classification.html#cb114-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb114-6"><a href="rgb-classification.html#cb114-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-88-1.png" width="1008" /></p>
<p>we can also see what it looks like if we include only pixels with &gt;16% (~median value) probability of being a pile</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="rgb-classification.html#cb115-1" tabindex="-1"></a>validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb115-2"><a href="rgb-classification.html#cb115-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-3"><a href="rgb-classification.html#cb115-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pr_pile_pred<span class="sc">&gt;=</span>median_pile_pct_overlap)) <span class="sc">+</span></span>
<span id="cb115-4"><a href="rgb-classification.html#cb115-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> slash_piles_polys, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-5"><a href="rgb-classification.html#cb115-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb115-6"><a href="rgb-classification.html#cb115-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="fu">paste0</span>(<span class="st">&quot;pr_pile&gt;&quot;</span>,scales<span class="sc">::</span><span class="fu">percent</span>(median_pile_pct_overlap,<span class="at">accuracy=</span><span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb115-7"><a href="rgb-classification.html#cb115-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-89-1.png" width="1008" /></p>
<p>to filter potential false positives at this stage, we could apply additional statistical filters to the detected objects or their bounding boxes to remove detections that do not meet certain density or size criteria</p>
</div>
<div id="validation" class="section level4 hasAnchor" number="3.4.2.4">
<h4><span class="header-section-number">3.4.2.4</span> Validation<a href="rgb-classification.html#validation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s spatially combine superpixels with &gt;16% (~median value) probability of being a pile</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="rgb-classification.html#cb116-1" tabindex="-1"></a>predicted_piles_sf <span class="ot">&lt;-</span> </span>
<span id="cb116-2"><a href="rgb-classification.html#cb116-2" tabindex="-1"></a>  validation_df <span class="sc">%&gt;%</span> </span>
<span id="cb116-3"><a href="rgb-classification.html#cb116-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pr_pile_pred<span class="sc">&gt;=</span>median_pile_pct_overlap) <span class="sc">%&gt;%</span> </span>
<span id="cb116-4"><a href="rgb-classification.html#cb116-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_union</span>(<span class="at">by_feature =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb116-5"><a href="rgb-classification.html#cb116-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-6"><a href="rgb-classification.html#cb116-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb116-7"><a href="rgb-classification.html#cb116-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_pile_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>() <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb116-8"><a href="rgb-classification.html#cb116-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(pred_pile_id)</span>
<span id="cb116-9"><a href="rgb-classification.html#cb116-9" tabindex="-1"></a><span class="co"># remove areas outside of mask</span></span>
<span id="cb116-10"><a href="rgb-classification.html#cb116-10" tabindex="-1"></a>predicted_piles_sf <span class="ot">&lt;-</span> </span>
<span id="cb116-11"><a href="rgb-classification.html#cb116-11" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb116-12"><a href="rgb-classification.html#cb116-12" tabindex="-1"></a>    predicted_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb116-13"><a href="rgb-classification.html#cb116-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-14"><a href="rgb-classification.html#cb116-14" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb116-15"><a href="rgb-classification.html#cb116-15" tabindex="-1"></a>    , ortho_rast <span class="sc">%&gt;%</span> </span>
<span id="cb116-16"><a href="rgb-classification.html#cb116-16" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">subset</span>(<span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;blue&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-17"><a href="rgb-classification.html#cb116-17" tabindex="-1"></a>        <span class="fu">cumsum</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb116-18"><a href="rgb-classification.html#cb116-18" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-19"><a href="rgb-classification.html#cb116-19" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">subst</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">others =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-20"><a href="rgb-classification.html#cb116-20" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">as.polygons</span>()</span>
<span id="cb116-21"><a href="rgb-classification.html#cb116-21" tabindex="-1"></a>      , <span class="at">inverse =</span> T</span>
<span id="cb116-22"><a href="rgb-classification.html#cb116-22" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb116-23"><a href="rgb-classification.html#cb116-23" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span></code></pre></div>
<p>let’s check those on the map compared to the actual validation piles</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="rgb-classification.html#cb117-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb117-2"><a href="rgb-classification.html#cb117-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> predicted_piles_sf, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pred_pile_id), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb117-3"><a href="rgb-classification.html#cb117-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>pile_id <span class="sc">%in%</span> training_pile_id), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb117-4"><a href="rgb-classification.html#cb117-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(</span>
<span id="cb117-5"><a href="rgb-classification.html#cb117-5" tabindex="-1"></a>    <span class="at">values =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n =</span> <span class="fu">nrow</span>(predicted_piles_sf), <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">%&gt;%</span> <span class="fu">sample</span>()</span>
<span id="cb117-6"><a href="rgb-classification.html#cb117-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb117-7"><a href="rgb-classification.html#cb117-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb117-8"><a href="rgb-classification.html#cb117-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-93-1.png" width="1008" /></p>
<p>and let’s overlay all of this on the RGB imagery with the training piles in white, the validation piles in blue, and the predicted piles in orange</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="rgb-classification.html#cb118-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb118-2"><a href="rgb-classification.html#cb118-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb118-3"><a href="rgb-classification.html#cb118-3" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb118-4"><a href="rgb-classification.html#cb118-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pile_id <span class="sc">%in%</span> training_pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb118-5"><a href="rgb-classification.html#cb118-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb118-6"><a href="rgb-classification.html#cb118-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb118-7"><a href="rgb-classification.html#cb118-7" tabindex="-1"></a>)</span>
<span id="cb118-8"><a href="rgb-classification.html#cb118-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb118-9"><a href="rgb-classification.html#cb118-9" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb118-10"><a href="rgb-classification.html#cb118-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>pile_id <span class="sc">%in%</span> training_pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb118-11"><a href="rgb-classification.html#cb118-11" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb118-12"><a href="rgb-classification.html#cb118-12" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb118-13"><a href="rgb-classification.html#cb118-13" tabindex="-1"></a>)</span>
<span id="cb118-14"><a href="rgb-classification.html#cb118-14" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb118-15"><a href="rgb-classification.html#cb118-15" tabindex="-1"></a>  predicted_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb118-16"><a href="rgb-classification.html#cb118-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb118-17"><a href="rgb-classification.html#cb118-17" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb118-18"><a href="rgb-classification.html#cb118-18" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-94-1.png" width="1008" /></p>
<div id="iou_match" class="section level5 hasAnchor" number="3.4.2.4.1">
<h5><span class="header-section-number">3.4.2.4.1</span> Matching process<a href="rgb-classification.html#iou_match" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Puliti et al. <a href="https://doi.org/10.48550/arXiv.2309.01279">(2023, p. 14)</a> provide guidance on performing “instance segmentation evaluation” to assess the ability of a method to correctly identify and delineate individual tree crown instances compared ground truth data. We’ll use this same methodology to test our slash pile identification approach.</p>
<blockquote>
<p>The first step in performing any instance segmentation evaluation is to match the point cloud reference and predicted instance IDs. To do this, it is necessary to define whether a prediction is correct. Here we adopt a method Wielgosz et al. (2023) proposed for matching tree instance IDs from two point clouds with reference and predicted instance IDs, respectively. Given a reference and a predicted point cloud with two separate sets of instances, the tree instances are iteratively matched in descending order from the tallest to the shortest trees by using the following algorithm:</p>
</blockquote>
<ol style="list-style-type: lower-alpha">
<li>Find the tallest tree in the reference data;</li>
<li>Find the tree in the predicted instances that have the largest intersection over union (IoU) with the tree selected in the previous step;</li>
<li>if the IoU is &lt;0.5: the predicted tree is considered an error, and thus no reference instance ID is available;</li>
<li>if the IoU is ≥0.5: the tree is considered a correct match, and assign reference instance ID label to the predicted tree;</li>
<li>Add to collection (dictionary) of predicted tree instances with IDs matching the reference instance IDs.</li>
</ol>
<p>Following the initial matching of reference and predicted instance IDs, the evaluation can be done on the tree level to evaluate detection, omission, and commission rates (which can be used to calculate precision, recall, and the F-score metric)</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="rgb-classification.html#cb119-1" tabindex="-1"></a><span class="co"># check the data</span></span>
<span id="cb119-2"><a href="rgb-classification.html#cb119-2" tabindex="-1"></a>check_gt_str <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb119-3"><a href="rgb-classification.html#cb119-3" tabindex="-1"></a>  gt_inst</span>
<span id="cb119-4"><a href="rgb-classification.html#cb119-4" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb119-5"><a href="rgb-classification.html#cb119-5" tabindex="-1"></a>  , predictions</span>
<span id="cb119-6"><a href="rgb-classification.html#cb119-6" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_pile_id&quot;</span>  </span>
<span id="cb119-7"><a href="rgb-classification.html#cb119-7" tabindex="-1"></a>) {</span>
<span id="cb119-8"><a href="rgb-classification.html#cb119-8" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">inherits</span>(gt_inst,<span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;ground truth must be spatial `sf` data with a single record&quot;</span>)}</span>
<span id="cb119-9"><a href="rgb-classification.html#cb119-9" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">inherits</span>(predictions,<span class="st">&quot;sf&quot;</span>) ){<span class="fu">stop</span>(<span class="st">&quot;predictions must be spatial `sf` data&quot;</span>)}</span>
<span id="cb119-10"><a href="rgb-classification.html#cb119-10" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">identical</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(gt_inst),sf<span class="sc">::</span><span class="fu">st_crs</span>(predictions)) ){<span class="fu">stop</span>(<span class="st">&quot;`sf` data should have same crs projection&quot;</span>)}</span>
<span id="cb119-11"><a href="rgb-classification.html#cb119-11" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">is.null</span>(gt_id) <span class="sc">||</span> <span class="fu">is.na</span>(gt_id) <span class="sc">||</span> </span>
<span id="cb119-12"><a href="rgb-classification.html#cb119-12" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">inherits</span>(gt_id, <span class="st">&quot;character&quot;</span>) <span class="sc">||</span></span>
<span id="cb119-13"><a href="rgb-classification.html#cb119-13" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_trim</span>(gt_id) <span class="sc">==</span> <span class="st">&quot;&quot;</span> </span>
<span id="cb119-14"><a href="rgb-classification.html#cb119-14" tabindex="-1"></a>  ){</span>
<span id="cb119-15"><a href="rgb-classification.html#cb119-15" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;ground truth data must contain `gt_id` column&quot;</span>)</span>
<span id="cb119-16"><a href="rgb-classification.html#cb119-16" tabindex="-1"></a>  }</span>
<span id="cb119-17"><a href="rgb-classification.html#cb119-17" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">is.null</span>(pred_id) <span class="sc">||</span> <span class="fu">is.na</span>(pred_id) <span class="sc">||</span> </span>
<span id="cb119-18"><a href="rgb-classification.html#cb119-18" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">inherits</span>(pred_id, <span class="st">&quot;character&quot;</span>) <span class="sc">||</span></span>
<span id="cb119-19"><a href="rgb-classification.html#cb119-19" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_trim</span>(pred_id) <span class="sc">==</span> <span class="st">&quot;&quot;</span> </span>
<span id="cb119-20"><a href="rgb-classification.html#cb119-20" tabindex="-1"></a>  ){</span>
<span id="cb119-21"><a href="rgb-classification.html#cb119-21" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;ground truth  data must contain `pred_id` column&quot;</span>)</span>
<span id="cb119-22"><a href="rgb-classification.html#cb119-22" tabindex="-1"></a>  }</span>
<span id="cb119-23"><a href="rgb-classification.html#cb119-23" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(gt_inst) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(gt_id) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){<span class="fu">stop</span>(<span class="st">&quot;ground truth  data must contain `gt_id` column&quot;</span>)}</span>
<span id="cb119-24"><a href="rgb-classification.html#cb119-24" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">names</span>(predictions) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(gt_id) <span class="sc">%&gt;%</span> <span class="fu">any</span>() ){</span>
<span id="cb119-25"><a href="rgb-classification.html#cb119-25" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span> </span>
<span id="cb119-26"><a href="rgb-classification.html#cb119-26" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename_with</span>(</span>
<span id="cb119-27"><a href="rgb-classification.html#cb119-27" tabindex="-1"></a>        <span class="at">.cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(gt_id)</span>
<span id="cb119-28"><a href="rgb-classification.html#cb119-28" tabindex="-1"></a>        , <span class="at">.fn =</span> <span class="cf">function</span>(x){<span class="st">&quot;prediction_id&quot;</span>}</span>
<span id="cb119-29"><a href="rgb-classification.html#cb119-29" tabindex="-1"></a>      )</span>
<span id="cb119-30"><a href="rgb-classification.html#cb119-30" tabindex="-1"></a>    pred_id <span class="ot">&lt;-</span> <span class="st">&quot;prediction_id&quot;</span></span>
<span id="cb119-31"><a href="rgb-classification.html#cb119-31" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(predictions) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(pred_id) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){</span>
<span id="cb119-32"><a href="rgb-classification.html#cb119-32" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;predictions  data must contain `pred_id` column&quot;</span>)</span>
<span id="cb119-33"><a href="rgb-classification.html#cb119-33" tabindex="-1"></a>  }</span>
<span id="cb119-34"><a href="rgb-classification.html#cb119-34" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb119-35"><a href="rgb-classification.html#cb119-35" tabindex="-1"></a>    <span class="at">predictions =</span> predictions</span>
<span id="cb119-36"><a href="rgb-classification.html#cb119-36" tabindex="-1"></a>    , <span class="at">pred_id =</span> pred_id</span>
<span id="cb119-37"><a href="rgb-classification.html#cb119-37" tabindex="-1"></a>  ))</span>
<span id="cb119-38"><a href="rgb-classification.html#cb119-38" tabindex="-1"></a>}</span>
<span id="cb119-39"><a href="rgb-classification.html#cb119-39" tabindex="-1"></a><span class="co"># match the instance</span></span>
<span id="cb119-40"><a href="rgb-classification.html#cb119-40" tabindex="-1"></a>ground_truth_single_match <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb119-41"><a href="rgb-classification.html#cb119-41" tabindex="-1"></a>  gt_inst</span>
<span id="cb119-42"><a href="rgb-classification.html#cb119-42" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb119-43"><a href="rgb-classification.html#cb119-43" tabindex="-1"></a>  , predictions</span>
<span id="cb119-44"><a href="rgb-classification.html#cb119-44" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_pile_id&quot;</span></span>
<span id="cb119-45"><a href="rgb-classification.html#cb119-45" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb119-46"><a href="rgb-classification.html#cb119-46" tabindex="-1"></a>) {</span>
<span id="cb119-47"><a href="rgb-classification.html#cb119-47" tabindex="-1"></a>  <span class="co"># check it</span></span>
<span id="cb119-48"><a href="rgb-classification.html#cb119-48" tabindex="-1"></a>  check_ans <span class="ot">&lt;-</span> <span class="fu">check_gt_str</span>(</span>
<span id="cb119-49"><a href="rgb-classification.html#cb119-49" tabindex="-1"></a>    <span class="at">gt_inst =</span> gt_inst</span>
<span id="cb119-50"><a href="rgb-classification.html#cb119-50" tabindex="-1"></a>    , <span class="at">gt_id =</span> gt_id</span>
<span id="cb119-51"><a href="rgb-classification.html#cb119-51" tabindex="-1"></a>    , <span class="at">predictions =</span> predictions</span>
<span id="cb119-52"><a href="rgb-classification.html#cb119-52" tabindex="-1"></a>    , <span class="at">pred_id =</span> pred_id</span>
<span id="cb119-53"><a href="rgb-classification.html#cb119-53" tabindex="-1"></a>  )</span>
<span id="cb119-54"><a href="rgb-classification.html#cb119-54" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(gt_inst)<span class="sc">!=</span><span class="dv">1</span> ){<span class="fu">stop</span>(<span class="st">&quot;ground truth must be spatial `sf` data with a single record&quot;</span>)}</span>
<span id="cb119-55"><a href="rgb-classification.html#cb119-55" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> check_ans<span class="sc">$</span>predictions</span>
<span id="cb119-56"><a href="rgb-classification.html#cb119-56" tabindex="-1"></a>  pred_id <span class="ot">&lt;-</span> check_ans<span class="sc">$</span>pred_id</span>
<span id="cb119-57"><a href="rgb-classification.html#cb119-57" tabindex="-1"></a>  <span class="co"># intersection</span></span>
<span id="cb119-58"><a href="rgb-classification.html#cb119-58" tabindex="-1"></a>    i_temp <span class="ot">&lt;-</span></span>
<span id="cb119-59"><a href="rgb-classification.html#cb119-59" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(predictions,gt_inst) <span class="sc">%&gt;%</span> </span>
<span id="cb119-60"><a href="rgb-classification.html#cb119-60" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">i_area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>())</span>
<span id="cb119-61"><a href="rgb-classification.html#cb119-61" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(i_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb119-62"><a href="rgb-classification.html#cb119-62" tabindex="-1"></a>    </span>
<span id="cb119-63"><a href="rgb-classification.html#cb119-63" tabindex="-1"></a>  <span class="co"># union</span></span>
<span id="cb119-64"><a href="rgb-classification.html#cb119-64" tabindex="-1"></a>    u_temp <span class="ot">&lt;-</span></span>
<span id="cb119-65"><a href="rgb-classification.html#cb119-65" tabindex="-1"></a>      i_temp <span class="sc">%&gt;%</span> </span>
<span id="cb119-66"><a href="rgb-classification.html#cb119-66" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb119-67"><a href="rgb-classification.html#cb119-67" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(predictions <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geom1&quot;</span>), <span class="at">by =</span> pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb119-68"><a href="rgb-classification.html#cb119-68" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(gt_inst <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geom2&quot;</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(gt_id)), <span class="at">by =</span> gt_id) <span class="sc">%&gt;%</span> </span>
<span id="cb119-69"><a href="rgb-classification.html#cb119-69" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb119-70"><a href="rgb-classification.html#cb119-70" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb119-71"><a href="rgb-classification.html#cb119-71" tabindex="-1"></a>        <span class="at">u_area =</span> sf<span class="sc">::</span><span class="fu">st_union</span>(geom1, geom2) <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb119-72"><a href="rgb-classification.html#cb119-72" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb119-73"><a href="rgb-classification.html#cb119-73" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb119-74"><a href="rgb-classification.html#cb119-74" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geom1,geom2)) <span class="sc">%&gt;%</span> </span>
<span id="cb119-75"><a href="rgb-classification.html#cb119-75" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb119-76"><a href="rgb-classification.html#cb119-76" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb119-77"><a href="rgb-classification.html#cb119-77" tabindex="-1"></a>        <span class="at">iou =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb119-78"><a href="rgb-classification.html#cb119-78" tabindex="-1"></a>          <span class="fu">is.na</span>(u_area) <span class="sc">|</span> <span class="fu">is.nan</span>(u_area) <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb119-79"><a href="rgb-classification.html#cb119-79" tabindex="-1"></a>          , T <span class="sc">~</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(i_area,<span class="dv">0</span>)<span class="sc">/</span>u_area</span>
<span id="cb119-80"><a href="rgb-classification.html#cb119-80" tabindex="-1"></a>        )</span>
<span id="cb119-81"><a href="rgb-classification.html#cb119-81" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb119-82"><a href="rgb-classification.html#cb119-82" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(iou) <span class="sc">&amp;</span> iou<span class="sc">&gt;=</span>min_iou_pct)</span>
<span id="cb119-83"><a href="rgb-classification.html#cb119-83" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(u_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb119-84"><a href="rgb-classification.html#cb119-84" tabindex="-1"></a>    </span>
<span id="cb119-85"><a href="rgb-classification.html#cb119-85" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb119-86"><a href="rgb-classification.html#cb119-86" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb119-87"><a href="rgb-classification.html#cb119-87" tabindex="-1"></a>    u_temp <span class="sc">%&gt;%</span> </span>
<span id="cb119-88"><a href="rgb-classification.html#cb119-88" tabindex="-1"></a>      <span class="co"># pick the highest iou</span></span>
<span id="cb119-89"><a href="rgb-classification.html#cb119-89" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(iou)) <span class="sc">%&gt;%</span> </span>
<span id="cb119-90"><a href="rgb-classification.html#cb119-90" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb119-91"><a href="rgb-classification.html#cb119-91" tabindex="-1"></a>      <span class="co"># column clean</span></span>
<span id="cb119-92"><a href="rgb-classification.html#cb119-92" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(</span>
<span id="cb119-93"><a href="rgb-classification.html#cb119-93" tabindex="-1"></a>        <span class="fu">c</span>(</span>
<span id="cb119-94"><a href="rgb-classification.html#cb119-94" tabindex="-1"></a>          gt_id, <span class="st">&quot;i_area&quot;</span>, <span class="st">&quot;u_area&quot;</span>, <span class="st">&quot;iou&quot;</span></span>
<span id="cb119-95"><a href="rgb-classification.html#cb119-95" tabindex="-1"></a>          , base<span class="sc">::</span><span class="fu">setdiff</span>(</span>
<span id="cb119-96"><a href="rgb-classification.html#cb119-96" tabindex="-1"></a>            <span class="fu">names</span>(predictions)</span>
<span id="cb119-97"><a href="rgb-classification.html#cb119-97" tabindex="-1"></a>            , <span class="fu">c</span>(<span class="st">&quot;geometry&quot;</span>, <span class="st">&quot;geom&quot;</span>, gt_id, <span class="st">&quot;i_area&quot;</span>, <span class="st">&quot;u_area&quot;</span>, <span class="st">&quot;iou&quot;</span>) </span>
<span id="cb119-98"><a href="rgb-classification.html#cb119-98" tabindex="-1"></a>          )</span>
<span id="cb119-99"><a href="rgb-classification.html#cb119-99" tabindex="-1"></a>        )</span>
<span id="cb119-100"><a href="rgb-classification.html#cb119-100" tabindex="-1"></a>      ))</span>
<span id="cb119-101"><a href="rgb-classification.html#cb119-101" tabindex="-1"></a>  )</span>
<span id="cb119-102"><a href="rgb-classification.html#cb119-102" tabindex="-1"></a>}</span></code></pre></div>
<p>test for a single ground truth instance</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="rgb-classification.html#cb120-1" tabindex="-1"></a><span class="fu">ground_truth_single_match</span>(</span>
<span id="cb120-2"><a href="rgb-classification.html#cb120-2" tabindex="-1"></a>  <span class="at">gt_inst =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb120-3"><a href="rgb-classification.html#cb120-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>pile_id <span class="sc">%in%</span> training_pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb120-4"><a href="rgb-classification.html#cb120-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb120-5"><a href="rgb-classification.html#cb120-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_piles_sf)) <span class="sc">%&gt;%</span></span>
<span id="cb120-6"><a href="rgb-classification.html#cb120-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">2</span>)</span>
<span id="cb120-7"><a href="rgb-classification.html#cb120-7" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb120-8"><a href="rgb-classification.html#cb120-8" tabindex="-1"></a>  , <span class="at">predictions =</span> predicted_piles_sf</span>
<span id="cb120-9"><a href="rgb-classification.html#cb120-9" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_pile_id&quot;</span></span>
<span id="cb120-10"><a href="rgb-classification.html#cb120-10" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.4</span></span>
<span id="cb120-11"><a href="rgb-classification.html#cb120-11" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   pile_id i_area u_area   iou pred_pile_id
##   &lt;fct&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;       
## 1 50        32.9   44.1 0.746 2</code></pre>
<p>now we need to make a function that matches the instances iteratively allowing for only a single match from the predictions (i.e. one prediction can only go to one ground truth instance), and returns all instances labeled as true positive (correctly matched with a prediction), commission (predictions which do not match a ground truth instance; false positive), or omission (ground truth instances for which no predictions match; false negative)</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="rgb-classification.html#cb122-1" tabindex="-1"></a>ground_truth_prediction_match <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb122-2"><a href="rgb-classification.html#cb122-2" tabindex="-1"></a>  <span class="co"># ground_truth should be sorted already</span></span>
<span id="cb122-3"><a href="rgb-classification.html#cb122-3" tabindex="-1"></a>  ground_truth</span>
<span id="cb122-4"><a href="rgb-classification.html#cb122-4" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb122-5"><a href="rgb-classification.html#cb122-5" tabindex="-1"></a>  <span class="co"># predictions just needs treeID</span></span>
<span id="cb122-6"><a href="rgb-classification.html#cb122-6" tabindex="-1"></a>  , predictions</span>
<span id="cb122-7"><a href="rgb-classification.html#cb122-7" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_pile_id&quot;</span></span>
<span id="cb122-8"><a href="rgb-classification.html#cb122-8" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb122-9"><a href="rgb-classification.html#cb122-9" tabindex="-1"></a>) {</span>
<span id="cb122-10"><a href="rgb-classification.html#cb122-10" tabindex="-1"></a>  <span class="co"># check it</span></span>
<span id="cb122-11"><a href="rgb-classification.html#cb122-11" tabindex="-1"></a>  check_ans <span class="ot">&lt;-</span> <span class="fu">check_gt_str</span>(</span>
<span id="cb122-12"><a href="rgb-classification.html#cb122-12" tabindex="-1"></a>    <span class="at">gt_inst =</span> ground_truth</span>
<span id="cb122-13"><a href="rgb-classification.html#cb122-13" tabindex="-1"></a>    , <span class="at">gt_id =</span> gt_id</span>
<span id="cb122-14"><a href="rgb-classification.html#cb122-14" tabindex="-1"></a>    , <span class="at">predictions =</span> predictions</span>
<span id="cb122-15"><a href="rgb-classification.html#cb122-15" tabindex="-1"></a>    , <span class="at">pred_id =</span> pred_id</span>
<span id="cb122-16"><a href="rgb-classification.html#cb122-16" tabindex="-1"></a>  )</span>
<span id="cb122-17"><a href="rgb-classification.html#cb122-17" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> check_ans<span class="sc">$</span>predictions</span>
<span id="cb122-18"><a href="rgb-classification.html#cb122-18" tabindex="-1"></a>  pred_id <span class="ot">&lt;-</span> check_ans<span class="sc">$</span>pred_id</span>
<span id="cb122-19"><a href="rgb-classification.html#cb122-19" tabindex="-1"></a>  <span class="co"># set up a blank data frame</span></span>
<span id="cb122-20"><a href="rgb-classification.html#cb122-20" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span></span>
<span id="cb122-21"><a href="rgb-classification.html#cb122-21" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb122-22"><a href="rgb-classification.html#cb122-22" tabindex="-1"></a>      <span class="at">i_area =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb122-23"><a href="rgb-classification.html#cb122-23" tabindex="-1"></a>      , <span class="at">u_area =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb122-24"><a href="rgb-classification.html#cb122-24" tabindex="-1"></a>      , <span class="at">iou =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb122-25"><a href="rgb-classification.html#cb122-25" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb122-26"><a href="rgb-classification.html#cb122-26" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb122-27"><a href="rgb-classification.html#cb122-27" tabindex="-1"></a>      ground_truth <span class="sc">%&gt;%</span> </span>
<span id="cb122-28"><a href="rgb-classification.html#cb122-28" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb122-29"><a href="rgb-classification.html#cb122-29" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(gt_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb122-30"><a href="rgb-classification.html#cb122-30" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">0</span>)</span>
<span id="cb122-31"><a href="rgb-classification.html#cb122-31" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb122-32"><a href="rgb-classification.html#cb122-32" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb122-33"><a href="rgb-classification.html#cb122-33" tabindex="-1"></a>      predictions <span class="sc">%&gt;%</span> </span>
<span id="cb122-34"><a href="rgb-classification.html#cb122-34" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb122-35"><a href="rgb-classification.html#cb122-35" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(pred_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb122-36"><a href="rgb-classification.html#cb122-36" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">0</span>)</span>
<span id="cb122-37"><a href="rgb-classification.html#cb122-37" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb122-38"><a href="rgb-classification.html#cb122-38" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">relocate</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(gt_id))</span>
<span id="cb122-39"><a href="rgb-classification.html#cb122-39" tabindex="-1"></a>  </span>
<span id="cb122-40"><a href="rgb-classification.html#cb122-40" tabindex="-1"></a>  <span class="co"># save names to select</span></span>
<span id="cb122-41"><a href="rgb-classification.html#cb122-41" tabindex="-1"></a>  nms_temp <span class="ot">&lt;-</span> <span class="fu">names</span>(return_df)</span>
<span id="cb122-42"><a href="rgb-classification.html#cb122-42" tabindex="-1"></a>  </span>
<span id="cb122-43"><a href="rgb-classification.html#cb122-43" tabindex="-1"></a>  <span class="co"># start with tallest tree and match to get true positives</span></span>
<span id="cb122-44"><a href="rgb-classification.html#cb122-44" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ground_truth)) {</span>
<span id="cb122-45"><a href="rgb-classification.html#cb122-45" tabindex="-1"></a>      match_temp <span class="ot">&lt;-</span> <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb122-46"><a href="rgb-classification.html#cb122-46" tabindex="-1"></a>        <span class="at">gt_inst =</span> ground_truth <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(i)</span>
<span id="cb122-47"><a href="rgb-classification.html#cb122-47" tabindex="-1"></a>        , <span class="at">gt_id =</span> gt_id</span>
<span id="cb122-48"><a href="rgb-classification.html#cb122-48" tabindex="-1"></a>        , <span class="at">predictions =</span> predictions <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(pred_id)) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">anti_join</span>(return_df,<span class="at">by=</span>pred_id)</span>
<span id="cb122-49"><a href="rgb-classification.html#cb122-49" tabindex="-1"></a>        , <span class="at">pred_id =</span> pred_id</span>
<span id="cb122-50"><a href="rgb-classification.html#cb122-50" tabindex="-1"></a>        , <span class="at">min_iou_pct =</span> min_iou_pct</span>
<span id="cb122-51"><a href="rgb-classification.html#cb122-51" tabindex="-1"></a>      )</span>
<span id="cb122-52"><a href="rgb-classification.html#cb122-52" tabindex="-1"></a>      <span class="co"># add to return</span></span>
<span id="cb122-53"><a href="rgb-classification.html#cb122-53" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(match_temp)){</span>
<span id="cb122-54"><a href="rgb-classification.html#cb122-54" tabindex="-1"></a>        return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb122-55"><a href="rgb-classification.html#cb122-55" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(match_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(nms_temp))</span>
<span id="cb122-56"><a href="rgb-classification.html#cb122-56" tabindex="-1"></a>      }</span>
<span id="cb122-57"><a href="rgb-classification.html#cb122-57" tabindex="-1"></a>      match_temp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb122-58"><a href="rgb-classification.html#cb122-58" tabindex="-1"></a>    }</span>
<span id="cb122-59"><a href="rgb-classification.html#cb122-59" tabindex="-1"></a>  <span class="co"># label tps</span></span>
<span id="cb122-60"><a href="rgb-classification.html#cb122-60" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb122-61"><a href="rgb-classification.html#cb122-61" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">match_grp =</span> <span class="st">&quot;true positive&quot;</span>)</span>
<span id="cb122-62"><a href="rgb-classification.html#cb122-62" tabindex="-1"></a>  <span class="co"># add omissions</span></span>
<span id="cb122-63"><a href="rgb-classification.html#cb122-63" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span></span>
<span id="cb122-64"><a href="rgb-classification.html#cb122-64" tabindex="-1"></a>    return_df <span class="sc">%&gt;%</span> </span>
<span id="cb122-65"><a href="rgb-classification.html#cb122-65" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb122-66"><a href="rgb-classification.html#cb122-66" tabindex="-1"></a>      ground_truth <span class="sc">%&gt;%</span> </span>
<span id="cb122-67"><a href="rgb-classification.html#cb122-67" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb122-68"><a href="rgb-classification.html#cb122-68" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">anti_join</span>(return_df,<span class="at">by=</span>gt_id) <span class="sc">%&gt;%</span> </span>
<span id="cb122-69"><a href="rgb-classification.html#cb122-69" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(gt_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb122-70"><a href="rgb-classification.html#cb122-70" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">match_grp =</span> <span class="st">&quot;omission&quot;</span>)</span>
<span id="cb122-71"><a href="rgb-classification.html#cb122-71" tabindex="-1"></a>    )</span>
<span id="cb122-72"><a href="rgb-classification.html#cb122-72" tabindex="-1"></a>  <span class="co"># add commissions</span></span>
<span id="cb122-73"><a href="rgb-classification.html#cb122-73" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span></span>
<span id="cb122-74"><a href="rgb-classification.html#cb122-74" tabindex="-1"></a>    return_df <span class="sc">%&gt;%</span> </span>
<span id="cb122-75"><a href="rgb-classification.html#cb122-75" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb122-76"><a href="rgb-classification.html#cb122-76" tabindex="-1"></a>      predictions <span class="sc">%&gt;%</span> </span>
<span id="cb122-77"><a href="rgb-classification.html#cb122-77" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb122-78"><a href="rgb-classification.html#cb122-78" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">anti_join</span>(return_df,<span class="at">by=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb122-79"><a href="rgb-classification.html#cb122-79" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(pred_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb122-80"><a href="rgb-classification.html#cb122-80" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">match_grp =</span> <span class="st">&quot;commission&quot;</span>)</span>
<span id="cb122-81"><a href="rgb-classification.html#cb122-81" tabindex="-1"></a>    )</span>
<span id="cb122-82"><a href="rgb-classification.html#cb122-82" tabindex="-1"></a>  <span class="co"># make match_grp factor</span></span>
<span id="cb122-83"><a href="rgb-classification.html#cb122-83" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb122-84"><a href="rgb-classification.html#cb122-84" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb122-85"><a href="rgb-classification.html#cb122-85" tabindex="-1"></a>      <span class="at">match_grp =</span> <span class="fu">factor</span>(</span>
<span id="cb122-86"><a href="rgb-classification.html#cb122-86" tabindex="-1"></a>        match_grp</span>
<span id="cb122-87"><a href="rgb-classification.html#cb122-87" tabindex="-1"></a>        , <span class="at">ordered =</span> T</span>
<span id="cb122-88"><a href="rgb-classification.html#cb122-88" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb122-89"><a href="rgb-classification.html#cb122-89" tabindex="-1"></a>          <span class="st">&quot;true positive&quot;</span></span>
<span id="cb122-90"><a href="rgb-classification.html#cb122-90" tabindex="-1"></a>          , <span class="st">&quot;commission&quot;</span></span>
<span id="cb122-91"><a href="rgb-classification.html#cb122-91" tabindex="-1"></a>          , <span class="st">&quot;omission&quot;</span></span>
<span id="cb122-92"><a href="rgb-classification.html#cb122-92" tabindex="-1"></a>        )</span>
<span id="cb122-93"><a href="rgb-classification.html#cb122-93" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb122-94"><a href="rgb-classification.html#cb122-94" tabindex="-1"></a>    )</span>
<span id="cb122-95"><a href="rgb-classification.html#cb122-95" tabindex="-1"></a>  </span>
<span id="cb122-96"><a href="rgb-classification.html#cb122-96" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb122-97"><a href="rgb-classification.html#cb122-97" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(return_df)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb122-98"><a href="rgb-classification.html#cb122-98" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;no records found for ground truth to predition matching&quot;</span>)</span>
<span id="cb122-99"><a href="rgb-classification.html#cb122-99" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb122-100"><a href="rgb-classification.html#cb122-100" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb122-101"><a href="rgb-classification.html#cb122-101" tabindex="-1"></a>    <span class="fu">return</span>(return_df)</span>
<span id="cb122-102"><a href="rgb-classification.html#cb122-102" tabindex="-1"></a>  }</span>
<span id="cb122-103"><a href="rgb-classification.html#cb122-103" tabindex="-1"></a>  </span>
<span id="cb122-104"><a href="rgb-classification.html#cb122-104" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s see how we did given the full list of predictions and validation data</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="rgb-classification.html#cb123-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb123-2"><a href="rgb-classification.html#cb123-2" tabindex="-1"></a>  <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb123-3"><a href="rgb-classification.html#cb123-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>pile_id <span class="sc">%in%</span> training_pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb123-4"><a href="rgb-classification.html#cb123-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-5"><a href="rgb-classification.html#cb123-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_piles_sf))</span>
<span id="cb123-6"><a href="rgb-classification.html#cb123-6" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb123-7"><a href="rgb-classification.html#cb123-7" tabindex="-1"></a>  , <span class="at">predictions =</span> predicted_piles_sf</span>
<span id="cb123-8"><a href="rgb-classification.html#cb123-8" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_pile_id&quot;</span></span>
<span id="cb123-9"><a href="rgb-classification.html#cb123-9" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb123-10"><a href="rgb-classification.html#cb123-10" tabindex="-1"></a>)</span></code></pre></div>
<p>how did our predictions do for this particular example?</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="rgb-classification.html#cb124-1" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb124-2"><a href="rgb-classification.html#cb124-2" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb124-3"><a href="rgb-classification.html#cb124-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb124-4"><a href="rgb-classification.html#cb124-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> (n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy=</span><span class="fl">0.1</span>))</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   match_grp         n pct  
##   &lt;ord&gt;         &lt;int&gt; &lt;chr&gt;
## 1 omission         18 26.1%
## 2 commission       34 49.3%
## 3 true positive    17 24.6%</code></pre>
<p>let’s look at that spatially</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="rgb-classification.html#cb126-1" tabindex="-1"></a>pal_match_grp <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb126-2"><a href="rgb-classification.html#cb126-2" tabindex="-1"></a>  <span class="st">&quot;omission&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">1</span>]</span>
<span id="cb126-3"><a href="rgb-classification.html#cb126-3" tabindex="-1"></a>  , <span class="st">&quot;commission&quot;</span><span class="ot">=</span> <span class="st">&quot;black&quot;</span> <span class="co">#viridis::cividis(3)[2]</span></span>
<span id="cb126-4"><a href="rgb-classification.html#cb126-4" tabindex="-1"></a>  , <span class="st">&quot;true positive&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">3</span>]</span>
<span id="cb126-5"><a href="rgb-classification.html#cb126-5" tabindex="-1"></a>)</span>
<span id="cb126-6"><a href="rgb-classification.html#cb126-6" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb126-7"><a href="rgb-classification.html#cb126-7" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb126-8"><a href="rgb-classification.html#cb126-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb126-9"><a href="rgb-classification.html#cb126-9" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb126-10"><a href="rgb-classification.html#cb126-10" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb126-11"><a href="rgb-classification.html#cb126-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>pile_id <span class="sc">%in%</span> training_pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb126-12"><a href="rgb-classification.html#cb126-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_piles_sf)) <span class="sc">%&gt;%</span> </span>
<span id="cb126-13"><a href="rgb-classification.html#cb126-13" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb126-14"><a href="rgb-classification.html#cb126-14" tabindex="-1"></a>          ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb126-15"><a href="rgb-classification.html#cb126-15" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb126-16"><a href="rgb-classification.html#cb126-16" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb126-17"><a href="rgb-classification.html#cb126-17" tabindex="-1"></a>        )</span>
<span id="cb126-18"><a href="rgb-classification.html#cb126-18" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb126-19"><a href="rgb-classification.html#cb126-19" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.7</span></span>
<span id="cb126-20"><a href="rgb-classification.html#cb126-20" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb126-21"><a href="rgb-classification.html#cb126-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb126-22"><a href="rgb-classification.html#cb126-22" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb126-23"><a href="rgb-classification.html#cb126-23" tabindex="-1"></a>      predicted_piles_sf <span class="sc">%&gt;%</span></span>
<span id="cb126-24"><a href="rgb-classification.html#cb126-24" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb126-25"><a href="rgb-classification.html#cb126-25" tabindex="-1"></a>          ground_truth_prediction_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb126-26"><a href="rgb-classification.html#cb126-26" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_pile_id,match_grp)</span>
<span id="cb126-27"><a href="rgb-classification.html#cb126-27" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pred_pile_id&quot;</span></span>
<span id="cb126-28"><a href="rgb-classification.html#cb126-28" tabindex="-1"></a>        )</span>
<span id="cb126-29"><a href="rgb-classification.html#cb126-29" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb126-30"><a href="rgb-classification.html#cb126-30" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb126-31"><a href="rgb-classification.html#cb126-31" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.1</span></span>
<span id="cb126-32"><a href="rgb-classification.html#cb126-32" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb126-33"><a href="rgb-classification.html#cb126-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb126-34"><a href="rgb-classification.html#cb126-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb126-35"><a href="rgb-classification.html#cb126-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb126-36"><a href="rgb-classification.html#cb126-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb126-37"><a href="rgb-classification.html#cb126-37" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,pal_match_grp[<span class="st">&quot;commission&quot;</span>])))</span>
<span id="cb126-38"><a href="rgb-classification.html#cb126-38" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb126-39"><a href="rgb-classification.html#cb126-39" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-100-1.png" width="1008" /></p>
<p>let’s quickly look at the IoU values on the true positives</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="rgb-classification.html#cb127-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(iou) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##       iou         
##  Min.   :0.06114  
##  1st Qu.:0.35915  
##  Median :0.45784  
##  Mean   :0.44930  
##  3rd Qu.:0.57578  
##  Max.   :0.74625  
##  NA&#39;s   :52</code></pre>
<p>let’s make a function to aggregate the instances to pass to the <code>confusion_matrix_scores_fn()</code> function we defined above</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="rgb-classification.html#cb129-1" tabindex="-1"></a>agg_ground_truth_match <span class="ot">&lt;-</span> <span class="cf">function</span>(ground_truth_prediction_match_ans) {</span>
<span id="cb129-2"><a href="rgb-classification.html#cb129-2" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(ground_truth_prediction_match_ans)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb129-3"><a href="rgb-classification.html#cb129-3" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(ground_truth_prediction_match_ans) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){<span class="fu">stop</span>(<span class="st">&quot;ground_truth_prediction_match_ans must contain `match_grp` column&quot;</span>)}</span>
<span id="cb129-4"><a href="rgb-classification.html#cb129-4" tabindex="-1"></a>  <span class="co"># count by match group</span></span>
<span id="cb129-5"><a href="rgb-classification.html#cb129-5" tabindex="-1"></a>  agg <span class="ot">&lt;-</span> ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb129-6"><a href="rgb-classification.html#cb129-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb129-7"><a href="rgb-classification.html#cb129-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb129-8"><a href="rgb-classification.html#cb129-8" tabindex="-1"></a>      <span class="at">match_grp =</span> dplyr<span class="sc">::</span><span class="fu">case_match</span>(</span>
<span id="cb129-9"><a href="rgb-classification.html#cb129-9" tabindex="-1"></a>        match_grp</span>
<span id="cb129-10"><a href="rgb-classification.html#cb129-10" tabindex="-1"></a>        , <span class="st">&quot;true positive&quot;</span><span class="sc">~</span><span class="st">&quot;tp&quot;</span></span>
<span id="cb129-11"><a href="rgb-classification.html#cb129-11" tabindex="-1"></a>        , <span class="st">&quot;commission&quot;</span><span class="sc">~</span><span class="st">&quot;fp&quot;</span></span>
<span id="cb129-12"><a href="rgb-classification.html#cb129-12" tabindex="-1"></a>        , <span class="st">&quot;omission&quot;</span><span class="sc">~</span><span class="st">&quot;fn&quot;</span></span>
<span id="cb129-13"><a href="rgb-classification.html#cb129-13" tabindex="-1"></a>      )</span>
<span id="cb129-14"><a href="rgb-classification.html#cb129-14" tabindex="-1"></a>    )</span>
<span id="cb129-15"><a href="rgb-classification.html#cb129-15" tabindex="-1"></a>  <span class="co"># true positive, false positive, false negative rates</span></span>
<span id="cb129-16"><a href="rgb-classification.html#cb129-16" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">match_grp =</span> <span class="fu">c</span>(<span class="st">&quot;tp&quot;</span>,<span class="st">&quot;fp&quot;</span>,<span class="st">&quot;fn&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb129-17"><a href="rgb-classification.html#cb129-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(agg, <span class="at">by =</span> <span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb129-18"><a href="rgb-classification.html#cb129-18" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(n), <span class="at">.fn =</span> <span class="sc">~</span>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(.x,<span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb129-19"><a href="rgb-classification.html#cb129-19" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb129-20"><a href="rgb-classification.html#cb129-20" tabindex="-1"></a>      <span class="at">names_from =</span> match_grp</span>
<span id="cb129-21"><a href="rgb-classification.html#cb129-21" tabindex="-1"></a>      , <span class="at">values_from =</span> <span class="fu">c</span>(n)</span>
<span id="cb129-22"><a href="rgb-classification.html#cb129-22" tabindex="-1"></a>      , <span class="at">names_glue =</span> <span class="st">&quot;{match_grp}_{.value}&quot;</span></span>
<span id="cb129-23"><a href="rgb-classification.html#cb129-23" tabindex="-1"></a>    )</span>
<span id="cb129-24"><a href="rgb-classification.html#cb129-24" tabindex="-1"></a>  <span class="co"># rates, precision, recall, f-score</span></span>
<span id="cb129-25"><a href="rgb-classification.html#cb129-25" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> <span class="fu">confusion_matrix_scores_fn</span>()</span>
<span id="cb129-26"><a href="rgb-classification.html#cb129-26" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb129-27"><a href="rgb-classification.html#cb129-27" tabindex="-1"></a>  <span class="fu">return</span>(return_df)</span>
<span id="cb129-28"><a href="rgb-classification.html#cb129-28" tabindex="-1"></a>}</span></code></pre></div>
<p>finally, let’s check our confusion matrix</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="rgb-classification.html#cb130-1" tabindex="-1"></a>confusion_matrix_temp <span class="ot">&lt;-</span> <span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans)</span>
<span id="cb130-2"><a href="rgb-classification.html#cb130-2" tabindex="-1"></a>confusion_matrix_scores_temp <span class="ot">&lt;-</span> <span class="fu">confusion_matrix_scores_fn</span>(confusion_matrix_temp)</span>
<span id="cb130-3"><a href="rgb-classification.html#cb130-3" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb130-4"><a href="rgb-classification.html#cb130-4" tabindex="-1"></a>confusion_matrix_temp <span class="sc">%&gt;%</span> </span>
<span id="cb130-5"><a href="rgb-classification.html#cb130-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_n&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb130-6"><a href="rgb-classification.html#cb130-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb130-7"><a href="rgb-classification.html#cb130-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb130-8"><a href="rgb-classification.html#cb130-8" tabindex="-1"></a>    <span class="at">presence =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fn_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb130-9"><a href="rgb-classification.html#cb130-9" tabindex="-1"></a>    , <span class="at">estimate =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fp_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb130-10"><a href="rgb-classification.html#cb130-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb130-11"><a href="rgb-classification.html#cb130-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb130-12"><a href="rgb-classification.html#cb130-12" tabindex="-1"></a>    <span class="at">is_false =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(presence<span class="sc">!=</span>estimate,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb130-13"><a href="rgb-classification.html#cb130-13" tabindex="-1"></a>    , <span class="at">presence_fact =</span> <span class="fu">factor</span>(presence,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed Absent&quot;</span>, <span class="st">&quot;Observed Present&quot;</span>))</span>
<span id="cb130-14"><a href="rgb-classification.html#cb130-14" tabindex="-1"></a>    , <span class="at">estimate_fact =</span> <span class="fu">factor</span>(estimate,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Predicted Absent&quot;</span>, <span class="st">&quot;Predicted Present&quot;</span>))</span>
<span id="cb130-15"><a href="rgb-classification.html#cb130-15" tabindex="-1"></a>    , <span class="at">pct =</span> value<span class="sc">/</span><span class="fu">sum</span>(value)</span>
<span id="cb130-16"><a href="rgb-classification.html#cb130-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb130-17"><a href="rgb-classification.html#cb130-17" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> estimate_fact, <span class="at">x =</span> presence_fact)) <span class="sc">+</span></span>
<span id="cb130-18"><a href="rgb-classification.html#cb130-18" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> is_false), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>,<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb130-19"><a href="rgb-classification.html#cb130-19" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)), <span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb130-20"><a href="rgb-classification.html#cb130-20" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)), <span class="at">vjust =</span> <span class="fl">3.5</span>, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb130-21"><a href="rgb-classification.html#cb130-21" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;turquoise&quot;</span>,<span class="st">&quot;tomato2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb130-22"><a href="rgb-classification.html#cb130-22" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb130-23"><a href="rgb-classification.html#cb130-23" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb130-24"><a href="rgb-classification.html#cb130-24" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Predicted&quot;</span></span>
<span id="cb130-25"><a href="rgb-classification.html#cb130-25" tabindex="-1"></a>    , <span class="at">x =</span> <span class="st">&quot;Observed&quot;</span></span>
<span id="cb130-26"><a href="rgb-classification.html#cb130-26" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb130-27"><a href="rgb-classification.html#cb130-27" tabindex="-1"></a>      <span class="st">&quot;True positive rate (recall) = &quot;</span></span>
<span id="cb130-28"><a href="rgb-classification.html#cb130-28" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>recall <span class="sc">%&gt;%</span> </span>
<span id="cb130-29"><a href="rgb-classification.html#cb130-29" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb130-30"><a href="rgb-classification.html#cb130-30" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Precision (PPV) = &quot;</span></span>
<span id="cb130-31"><a href="rgb-classification.html#cb130-31" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>precision <span class="sc">%&gt;%</span> </span>
<span id="cb130-32"><a href="rgb-classification.html#cb130-32" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb130-33"><a href="rgb-classification.html#cb130-33" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">F1-score = &quot;</span></span>
<span id="cb130-34"><a href="rgb-classification.html#cb130-34" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>f_score <span class="sc">%&gt;%</span> </span>
<span id="cb130-35"><a href="rgb-classification.html#cb130-35" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb130-36"><a href="rgb-classification.html#cb130-36" tabindex="-1"></a>    )</span>
<span id="cb130-37"><a href="rgb-classification.html#cb130-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb130-38"><a href="rgb-classification.html#cb130-38" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb130-39"><a href="rgb-classification.html#cb130-39" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb130-40"><a href="rgb-classification.html#cb130-40" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb130-41"><a href="rgb-classification.html#cb130-41" tabindex="-1"></a>    , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb130-42"><a href="rgb-classification.html#cb130-42" tabindex="-1"></a>    , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb130-43"><a href="rgb-classification.html#cb130-43" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb130-44"><a href="rgb-classification.html#cb130-44" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-103-1.png" width="1008" /></p>
<p>compared to our pixel-based <a href="rgb-classification.html#pixel_class">approach above</a>, we improved the recall rate meaning that we correctly identified actual piles more often. However, this improved detection rate came at the expense of lowered precision as we incorrectly predicted piles at locations were no piles were actually observed. Combined, the OBIA approach had lower overall accuracy but improved detection rate and did so in a manner that actual objects were predicted that more closely align with the actual form of slash piles on the ground.</p>
</div>
</div>
</div>
<div id="superpixelimagesegmentation-package-slicap-clustering" class="section level3 hasAnchor" number="3.4.3">
<h3><span class="header-section-number">3.4.3</span> <code>SuperpixelImageSegmentation</code> package SLICAP clustering<a href="rgb-classification.html#superpixelimagesegmentation-package-slicap-clustering" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we’ll test out the <code>SuperpixelImageSegmentation</code> <a href="https://github.com/mlampros/SuperpixelImageSegmentation">package</a> which was developed specifically to implement the SLIC Superpixels and Affinity Propagation (AP) Clustering method of image segmentation (<a href="https://www.ijsr.net/archive/v4i4/SUB152869.pdf">Zhou 2015</a>). This method first uses the SLIC superpixel algorithm to form an over-segmentation of an image, constructs a similarity score based on the features of superpixels, and uses the AP algorithm to cluster superpixels. All of these steps are performed in a semi-automated manner as the user does not need to specify the number of clusters as required by other methods (e.g. Kmeans).</p>
<p>make a function to safely implement the methodology and automatically adjust the number of superpixels to attempt to return successful result</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="rgb-classification.html#cb131-1" tabindex="-1"></a>try_superpixels_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb131-2"><a href="rgb-classification.html#cb131-2" tabindex="-1"></a>  input_image</span>
<span id="cb131-3"><a href="rgb-classification.html#cb131-3" tabindex="-1"></a>  , <span class="at">method =</span> <span class="st">&quot;slico&quot;</span> </span>
<span id="cb131-4"><a href="rgb-classification.html#cb131-4" tabindex="-1"></a>  <span class="co"># number of superpixels to use</span></span>
<span id="cb131-5"><a href="rgb-classification.html#cb131-5" tabindex="-1"></a>  , <span class="at">superpixel =</span> <span class="dv">200</span></span>
<span id="cb131-6"><a href="rgb-classification.html#cb131-6" tabindex="-1"></a>  , <span class="at">kmeans_method =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb131-7"><a href="rgb-classification.html#cb131-7" tabindex="-1"></a>  , <span class="at">AP_data =</span> T</span>
<span id="cb131-8"><a href="rgb-classification.html#cb131-8" tabindex="-1"></a>  , <span class="at">use_median =</span> T</span>
<span id="cb131-9"><a href="rgb-classification.html#cb131-9" tabindex="-1"></a>  , <span class="at">sim_wL =</span> <span class="dv">3</span></span>
<span id="cb131-10"><a href="rgb-classification.html#cb131-10" tabindex="-1"></a>  , <span class="at">sim_wA =</span> <span class="dv">10</span></span>
<span id="cb131-11"><a href="rgb-classification.html#cb131-11" tabindex="-1"></a>  , <span class="at">sim_wB =</span> <span class="dv">10</span></span>
<span id="cb131-12"><a href="rgb-classification.html#cb131-12" tabindex="-1"></a>  , <span class="at">sim_color_radius =</span> <span class="dv">10</span></span>
<span id="cb131-13"><a href="rgb-classification.html#cb131-13" tabindex="-1"></a>  , <span class="at">verbose =</span> T</span>
<span id="cb131-14"><a href="rgb-classification.html#cb131-14" tabindex="-1"></a>) {</span>
<span id="cb131-15"><a href="rgb-classification.html#cb131-15" tabindex="-1"></a>  <span class="co"># make sure sp is integer</span></span>
<span id="cb131-16"><a href="rgb-classification.html#cb131-16" tabindex="-1"></a>  new_sp <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(superpixel, <span class="dv">200</span>) <span class="sc">%&gt;%</span> <span class="fu">floor</span>()</span>
<span id="cb131-17"><a href="rgb-classification.html#cb131-17" tabindex="-1"></a>  <span class="co"># make a list of backup sp</span></span>
<span id="cb131-18"><a href="rgb-classification.html#cb131-18" tabindex="-1"></a>  try_sp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">max</span>(<span class="fu">floor</span>(new_sp<span class="sc">*</span><span class="fl">0.95</span>),<span class="dv">10</span>), <span class="at">to =</span> <span class="fu">max</span>(<span class="fu">floor</span>(new_sp<span class="sc">*</span><span class="fl">1.05</span>),<span class="dv">10</span>), <span class="at">by =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb131-19"><a href="rgb-classification.html#cb131-19" tabindex="-1"></a>    base<span class="sc">::</span><span class="fu">setdiff</span>(new_sp) <span class="sc">%&gt;%</span> </span>
<span id="cb131-20"><a href="rgb-classification.html#cb131-20" tabindex="-1"></a>    <span class="fu">sample</span>()</span>
<span id="cb131-21"><a href="rgb-classification.html#cb131-21" tabindex="-1"></a>  </span>
<span id="cb131-22"><a href="rgb-classification.html#cb131-22" tabindex="-1"></a>  <span class="co"># safe it</span></span>
<span id="cb131-23"><a href="rgb-classification.html#cb131-23" tabindex="-1"></a>  safe_superpixels <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(OpenImageR<span class="sc">::</span>superpixels)</span>
<span id="cb131-24"><a href="rgb-classification.html#cb131-24" tabindex="-1"></a>  </span>
<span id="cb131-25"><a href="rgb-classification.html#cb131-25" tabindex="-1"></a>  <span class="co"># while loop to handle superpixel errors</span></span>
<span id="cb131-26"><a href="rgb-classification.html#cb131-26" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb131-27"><a href="rgb-classification.html#cb131-27" tabindex="-1"></a>  </span>
<span id="cb131-28"><a href="rgb-classification.html#cb131-28" tabindex="-1"></a>  </span>
<span id="cb131-29"><a href="rgb-classification.html#cb131-29" tabindex="-1"></a>  <span class="co"># initiate and perform segmentation of images based on superpixels, affinity propagation and kmeans clustering</span></span>
<span id="cb131-30"><a href="rgb-classification.html#cb131-30" tabindex="-1"></a>  init <span class="ot">&lt;-</span> SuperpixelImageSegmentation<span class="sc">::</span>Image_Segmentation<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb131-31"><a href="rgb-classification.html#cb131-31" tabindex="-1"></a>  safe_spixel_segmentation <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(init<span class="sc">$</span>spixel_segmentation)</span>
<span id="cb131-32"><a href="rgb-classification.html#cb131-32" tabindex="-1"></a>  </span>
<span id="cb131-33"><a href="rgb-classification.html#cb131-33" tabindex="-1"></a>  <span class="cf">while</span>(xx<span class="sc">!=</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> xx<span class="sc">&lt;</span><span class="fu">length</span>(try_sp)) {</span>
<span id="cb131-34"><a href="rgb-classification.html#cb131-34" tabindex="-1"></a>    <span class="co"># superpixels</span></span>
<span id="cb131-35"><a href="rgb-classification.html#cb131-35" tabindex="-1"></a>    superpixels_slicap_ans <span class="ot">&lt;-</span> <span class="fu">safe_spixel_segmentation</span>(</span>
<span id="cb131-36"><a href="rgb-classification.html#cb131-36" tabindex="-1"></a>      <span class="at">input_image =</span> input_image</span>
<span id="cb131-37"><a href="rgb-classification.html#cb131-37" tabindex="-1"></a>      , <span class="at">superpixel =</span> new_sp</span>
<span id="cb131-38"><a href="rgb-classification.html#cb131-38" tabindex="-1"></a>      , <span class="at">method =</span> method</span>
<span id="cb131-39"><a href="rgb-classification.html#cb131-39" tabindex="-1"></a>      , <span class="at">kmeans_method =</span> kmeans_method</span>
<span id="cb131-40"><a href="rgb-classification.html#cb131-40" tabindex="-1"></a>      , <span class="at">AP_data =</span> AP_data</span>
<span id="cb131-41"><a href="rgb-classification.html#cb131-41" tabindex="-1"></a>      , <span class="at">use_median =</span> use_median</span>
<span id="cb131-42"><a href="rgb-classification.html#cb131-42" tabindex="-1"></a>      , <span class="at">sim_wL =</span> sim_wL</span>
<span id="cb131-43"><a href="rgb-classification.html#cb131-43" tabindex="-1"></a>      , <span class="at">sim_wA =</span> sim_wA</span>
<span id="cb131-44"><a href="rgb-classification.html#cb131-44" tabindex="-1"></a>      , <span class="at">sim_wB =</span> sim_wB</span>
<span id="cb131-45"><a href="rgb-classification.html#cb131-45" tabindex="-1"></a>      , <span class="at">sim_color_radius =</span> sim_color_radius</span>
<span id="cb131-46"><a href="rgb-classification.html#cb131-46" tabindex="-1"></a>      , <span class="at">verbose =</span> verbose</span>
<span id="cb131-47"><a href="rgb-classification.html#cb131-47" tabindex="-1"></a>    )</span>
<span id="cb131-48"><a href="rgb-classification.html#cb131-48" tabindex="-1"></a>    </span>
<span id="cb131-49"><a href="rgb-classification.html#cb131-49" tabindex="-1"></a>    <span class="co"># check</span></span>
<span id="cb131-50"><a href="rgb-classification.html#cb131-50" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(superpixels_slicap_ans<span class="sc">$</span>error) <span class="sc">&amp;&amp;</span> </span>
<span id="cb131-51"><a href="rgb-classification.html#cb131-51" tabindex="-1"></a>       stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">as.character</span>(superpixels_slicap_ans<span class="sc">$</span>error), <span class="st">&quot;median&quot;</span>)</span>
<span id="cb131-52"><a href="rgb-classification.html#cb131-52" tabindex="-1"></a>    ){</span>
<span id="cb131-53"><a href="rgb-classification.html#cb131-53" tabindex="-1"></a>      <span class="fu">stop</span>(superpixels_slicap_ans<span class="sc">$</span>error)</span>
<span id="cb131-54"><a href="rgb-classification.html#cb131-54" tabindex="-1"></a>    }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.null</span>(superpixels_slicap_ans<span class="sc">$</span>error)){</span>
<span id="cb131-55"><a href="rgb-classification.html#cb131-55" tabindex="-1"></a>      <span class="co"># just get the result</span></span>
<span id="cb131-56"><a href="rgb-classification.html#cb131-56" tabindex="-1"></a>      superpixels_slicap_ans <span class="ot">&lt;-</span> superpixels_slicap_ans<span class="sc">$</span>result</span>
<span id="cb131-57"><a href="rgb-classification.html#cb131-57" tabindex="-1"></a>      xx <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb131-58"><a href="rgb-classification.html#cb131-58" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb131-59"><a href="rgb-classification.html#cb131-59" tabindex="-1"></a>      <span class="cf">if</span>(xx<span class="sc">==</span><span class="dv">1</span>){<span class="fu">message</span>(<span class="st">&quot;attempting to adjust `superpixel` size.......&quot;</span>)}</span>
<span id="cb131-60"><a href="rgb-classification.html#cb131-60" tabindex="-1"></a>      <span class="co"># just get the result (in case we exit the while)</span></span>
<span id="cb131-61"><a href="rgb-classification.html#cb131-61" tabindex="-1"></a>      superpixels_slicap_ans <span class="ot">&lt;-</span> superpixels_slicap_ans<span class="sc">$</span>result</span>
<span id="cb131-62"><a href="rgb-classification.html#cb131-62" tabindex="-1"></a>      new_sp <span class="ot">&lt;-</span> try_sp[xx]</span>
<span id="cb131-63"><a href="rgb-classification.html#cb131-63" tabindex="-1"></a>      xx <span class="ot">&lt;-</span> xx<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb131-64"><a href="rgb-classification.html#cb131-64" tabindex="-1"></a>      </span>
<span id="cb131-65"><a href="rgb-classification.html#cb131-65" tabindex="-1"></a>    }</span>
<span id="cb131-66"><a href="rgb-classification.html#cb131-66" tabindex="-1"></a>  }</span>
<span id="cb131-67"><a href="rgb-classification.html#cb131-67" tabindex="-1"></a>  </span>
<span id="cb131-68"><a href="rgb-classification.html#cb131-68" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(superpixels_slicap_ans)){<span class="fu">stop</span>(<span class="st">&quot;`superpixel` size not successfull, try a different value&quot;</span>)}</span>
<span id="cb131-69"><a href="rgb-classification.html#cb131-69" tabindex="-1"></a>  <span class="fu">return</span>(superpixels_slicap_ans)</span>
<span id="cb131-70"><a href="rgb-classification.html#cb131-70" tabindex="-1"></a>    </span>
<span id="cb131-71"><a href="rgb-classification.html#cb131-71" tabindex="-1"></a>}</span></code></pre></div>
<p>run it</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="rgb-classification.html#cb132-1" tabindex="-1"></a>superpixels_slicap_ans <span class="ot">&lt;-</span> <span class="fu">try_superpixels_fn</span>(</span>
<span id="cb132-2"><a href="rgb-classification.html#cb132-2" tabindex="-1"></a>  <span class="at">input_image =</span> OpenImageR<span class="sc">::</span><span class="fu">readImage</span>(fpath_seg)</span>
<span id="cb132-3"><a href="rgb-classification.html#cb132-3" tabindex="-1"></a>  <span class="co"># a numeric value specifying the number of superpixels</span></span>
<span id="cb132-4"><a href="rgb-classification.html#cb132-4" tabindex="-1"></a>  , <span class="at">superpixel =</span> <span class="dv">600</span></span>
<span id="cb132-5"><a href="rgb-classification.html#cb132-5" tabindex="-1"></a>  <span class="co"># Either &quot;slic&quot; or &quot;slico&quot;</span></span>
<span id="cb132-6"><a href="rgb-classification.html#cb132-6" tabindex="-1"></a>  , <span class="at">method =</span> <span class="st">&quot;slico&quot;</span></span>
<span id="cb132-7"><a href="rgb-classification.html#cb132-7" tabindex="-1"></a>  <span class="co"># a character string specifying the kmeans method. If not empty (&quot;&quot;) then it can be either &quot;kmeans&quot; or &quot;mini_batch_kmeans&quot;</span></span>
<span id="cb132-8"><a href="rgb-classification.html#cb132-8" tabindex="-1"></a>  , <span class="at">kmeans_method =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb132-9"><a href="rgb-classification.html#cb132-9" tabindex="-1"></a>  <span class="co"># If TRUE then the affinity propagation image data will be computed and returned</span></span>
<span id="cb132-10"><a href="rgb-classification.html#cb132-10" tabindex="-1"></a>  , <span class="at">AP_data =</span> <span class="cn">TRUE</span></span>
<span id="cb132-11"><a href="rgb-classification.html#cb132-11" tabindex="-1"></a>  <span class="co"># If TRUE then the median will be used rather than the mean value for the inner computations (see the details section for more information)</span></span>
<span id="cb132-12"><a href="rgb-classification.html#cb132-12" tabindex="-1"></a>  , <span class="at">use_median =</span> <span class="cn">TRUE</span></span>
<span id="cb132-13"><a href="rgb-classification.html#cb132-13" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;L&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb132-14"><a href="rgb-classification.html#cb132-14" tabindex="-1"></a>  , <span class="at">sim_wL =</span> <span class="dv">3</span></span>
<span id="cb132-15"><a href="rgb-classification.html#cb132-15" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;A&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb132-16"><a href="rgb-classification.html#cb132-16" tabindex="-1"></a>  , <span class="at">sim_wA =</span> <span class="dv">10</span></span>
<span id="cb132-17"><a href="rgb-classification.html#cb132-17" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;B&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb132-18"><a href="rgb-classification.html#cb132-18" tabindex="-1"></a>  , <span class="at">sim_wB =</span> <span class="dv">10</span></span>
<span id="cb132-19"><a href="rgb-classification.html#cb132-19" tabindex="-1"></a>  <span class="co"># numeric value specifying the colorradius: </span></span>
<span id="cb132-20"><a href="rgb-classification.html#cb132-20" tabindex="-1"></a>    <span class="do">## adjusts the number of clusters, and if its value is low, the number of targets would increase, which leads to more detailed segmentation results</span></span>
<span id="cb132-21"><a href="rgb-classification.html#cb132-21" tabindex="-1"></a>  , <span class="at">sim_color_radius =</span> <span class="dv">10</span></span>
<span id="cb132-22"><a href="rgb-classification.html#cb132-22" tabindex="-1"></a>  , <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb132-23"><a href="rgb-classification.html#cb132-23" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Sequential computation starts ...</code></pre>
<pre><code>## Sequential computation starts ...
## Sequential computation starts ...
## The super-pixel slico method as pre-processing step was used / completed!
## The similarity matrix based on super-pixels was computed!
## 
## Number of exemplars identified: 7  (for 612 data points)
## Net similarity: -130785
##   Similarities of data points to exemplars: -70926
##   Preferences of selected exemplars: -59859
## Number of iterations: 142
## 
## Elapsed time: 0.613274 sec
## It took 142 iterations for affinity propagation to complete!
## 7 clusters were chosen based on super-pixels and affinity propagation!
## Image data based on Affinity Propagation clustering (&#39;AP_image_data&#39;) will be returned!
## Elapsed time: 0 hours and 1 minutes and 25 seconds.</code></pre>
<p>what did we get back?</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="rgb-classification.html#cb135-1" tabindex="-1"></a><span class="fu">str</span>(superpixels_slicap_ans)</span></code></pre></div>
<pre><code>## List of 5
##  $ KMeans_image_data: num[0 , 0 , 0 ] 
##  $ KMeans_clusters  : num[1, 0 ] 
##  $ masks            : list()
##   ..- attr(*, &quot;dim&quot;)= int [1:2] 0 0
##  $ centr            : num[0 , 0 ] 
##  $ AP_image_data    : num [1:3567, 1:4552, 1:3] 0 0 0 0 0 0 0 0 0 0 ...</code></pre>
<p>let’s see the output based on <strong>Superpixels + AP</strong></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="rgb-classification.html#cb137-1" tabindex="-1"></a>OpenImageR<span class="sc">::</span><span class="fu">imageShow</span>(superpixels_slicap_ans<span class="sc">$</span>AP_image_data)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-108-1.png" width="1008" /></p>
<p>ok, let’s increase the number of <code>superpixel</code> and decrease the <code>sim_color_radius</code> to get finer detail (but significantly increase processing time)</p>
<p><strong>this takes so long, we aren’t going to show the result but we’ll leave the code for reference</strong></p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="rgb-classification.html#cb138-1" tabindex="-1"></a><span class="do">## number of superpixels to use</span></span>
<span id="cb138-2"><a href="rgb-classification.html#cb138-2" tabindex="-1"></a><span class="do">## set this to extent/minimum expected pile area?</span></span>
<span id="cb138-3"><a href="rgb-classification.html#cb138-3" tabindex="-1"></a>sp_temp <span class="ot">&lt;-</span> <span class="fu">floor</span>(</span>
<span id="cb138-4"><a href="rgb-classification.html#cb138-4" tabindex="-1"></a>    <span class="co"># raster area</span></span>
<span id="cb138-5"><a href="rgb-classification.html#cb138-5" tabindex="-1"></a>    ( terra<span class="sc">::</span><span class="fu">cellSize</span>(ortho_rast[[<span class="dv">1</span>]])[<span class="dv">1</span>]<span class="sc">*</span>terra<span class="sc">::</span><span class="fu">ncell</span>(ortho_rast[[<span class="dv">1</span>]]) ) <span class="sc">/</span> </span>
<span id="cb138-6"><a href="rgb-classification.html#cb138-6" tabindex="-1"></a>    <span class="co"># expected pile area</span></span>
<span id="cb138-7"><a href="rgb-classification.html#cb138-7" tabindex="-1"></a>      (</span>
<span id="cb138-8"><a href="rgb-classification.html#cb138-8" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb138-9"><a href="rgb-classification.html#cb138-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(area) <span class="sc">%&gt;%</span> </span>
<span id="cb138-10"><a href="rgb-classification.html#cb138-10" tabindex="-1"></a>        <span class="fu">quantile</span>(<span class="at">probs =</span> <span class="fl">0.77</span>)</span>
<span id="cb138-11"><a href="rgb-classification.html#cb138-11" tabindex="-1"></a>      )</span>
<span id="cb138-12"><a href="rgb-classification.html#cb138-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-13"><a href="rgb-classification.html#cb138-13" tabindex="-1"></a>  <span class="fu">max</span>(<span class="dv">200</span>) <span class="co"># 200 = function default</span></span>
<span id="cb138-14"><a href="rgb-classification.html#cb138-14" tabindex="-1"></a><span class="co"># try it</span></span>
<span id="cb138-15"><a href="rgb-classification.html#cb138-15" tabindex="-1"></a>superpixels_slicap_ans <span class="ot">&lt;-</span> <span class="fu">try_superpixels_fn</span>(</span>
<span id="cb138-16"><a href="rgb-classification.html#cb138-16" tabindex="-1"></a>  <span class="at">input_image =</span> OpenImageR<span class="sc">::</span><span class="fu">readImage</span>(fpath_seg)</span>
<span id="cb138-17"><a href="rgb-classification.html#cb138-17" tabindex="-1"></a>  <span class="co"># a numeric value specifying the number of superpixels</span></span>
<span id="cb138-18"><a href="rgb-classification.html#cb138-18" tabindex="-1"></a>  , <span class="at">superpixel =</span> sp_temp <span class="co"># 3333</span></span>
<span id="cb138-19"><a href="rgb-classification.html#cb138-19" tabindex="-1"></a>  <span class="co"># Either &quot;slic&quot; or &quot;slico&quot;</span></span>
<span id="cb138-20"><a href="rgb-classification.html#cb138-20" tabindex="-1"></a>  , <span class="at">method =</span> <span class="st">&quot;slico&quot;</span></span>
<span id="cb138-21"><a href="rgb-classification.html#cb138-21" tabindex="-1"></a>  <span class="co"># a character string specifying the kmeans method. If not empty (&quot;&quot;) then it can be either &quot;kmeans&quot; or &quot;mini_batch_kmeans&quot;</span></span>
<span id="cb138-22"><a href="rgb-classification.html#cb138-22" tabindex="-1"></a>  , <span class="at">kmeans_method =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb138-23"><a href="rgb-classification.html#cb138-23" tabindex="-1"></a>  <span class="co"># If TRUE then the affinity propagation image data will be computed and returned</span></span>
<span id="cb138-24"><a href="rgb-classification.html#cb138-24" tabindex="-1"></a>  , <span class="at">AP_data =</span> <span class="cn">TRUE</span></span>
<span id="cb138-25"><a href="rgb-classification.html#cb138-25" tabindex="-1"></a>  <span class="co"># If TRUE then the median will be used rather than the mean value for the inner computations (see the details section for more information)</span></span>
<span id="cb138-26"><a href="rgb-classification.html#cb138-26" tabindex="-1"></a>  , <span class="at">use_median =</span> <span class="cn">TRUE</span></span>
<span id="cb138-27"><a href="rgb-classification.html#cb138-27" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;L&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb138-28"><a href="rgb-classification.html#cb138-28" tabindex="-1"></a>  , <span class="at">sim_wL =</span> <span class="dv">3</span></span>
<span id="cb138-29"><a href="rgb-classification.html#cb138-29" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;A&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb138-30"><a href="rgb-classification.html#cb138-30" tabindex="-1"></a>  , <span class="at">sim_wA =</span> <span class="dv">10</span></span>
<span id="cb138-31"><a href="rgb-classification.html#cb138-31" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;B&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb138-32"><a href="rgb-classification.html#cb138-32" tabindex="-1"></a>  , <span class="at">sim_wB =</span> <span class="dv">10</span></span>
<span id="cb138-33"><a href="rgb-classification.html#cb138-33" tabindex="-1"></a>  <span class="co"># numeric value specifying the colorradius: </span></span>
<span id="cb138-34"><a href="rgb-classification.html#cb138-34" tabindex="-1"></a>    <span class="do">## adjusts the number of clusters, and if its value is low, the number of targets would increase, which leads to more detailed segmentation results</span></span>
<span id="cb138-35"><a href="rgb-classification.html#cb138-35" tabindex="-1"></a>  , <span class="at">sim_color_radius =</span> <span class="dv">3</span></span>
<span id="cb138-36"><a href="rgb-classification.html#cb138-36" tabindex="-1"></a>  , <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb138-37"><a href="rgb-classification.html#cb138-37" tabindex="-1"></a>)</span></code></pre></div>
<p>let’s see the clustering output based on <strong>Superpixels + AP</strong> and we’ll add the pile outlines in blue</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="rgb-classification.html#cb139-1" tabindex="-1"></a><span class="co"># use the ortho template so we get the projection and then fill with values</span></span>
<span id="cb139-2"><a href="rgb-classification.html#cb139-2" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> ortho_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">1</span>)</span>
<span id="cb139-3"><a href="rgb-classification.html#cb139-3" tabindex="-1"></a>rast_temp[] <span class="ot">&lt;-</span> superpixels_slicap_ans<span class="sc">$</span>AP_image_data[,,<span class="dv">1</span>] <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb139-4"><a href="rgb-classification.html#cb139-4" tabindex="-1"></a><span class="co"># the unique values in the layer represent the unique clusters</span></span>
<span id="cb139-5"><a href="rgb-classification.html#cb139-5" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">subst</span>(</span>
<span id="cb139-6"><a href="rgb-classification.html#cb139-6" tabindex="-1"></a>    rast_temp</span>
<span id="cb139-7"><a href="rgb-classification.html#cb139-7" tabindex="-1"></a>    , <span class="at">from =</span> terra<span class="sc">::</span><span class="fu">values</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">c</span>()</span>
<span id="cb139-8"><a href="rgb-classification.html#cb139-8" tabindex="-1"></a>    , <span class="at">to =</span> <span class="dv">1</span><span class="sc">:</span>(terra<span class="sc">::</span><span class="fu">values</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>())</span>
<span id="cb139-9"><a href="rgb-classification.html#cb139-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb139-10"><a href="rgb-classification.html#cb139-10" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.factor</span>()</span>
<span id="cb139-11"><a href="rgb-classification.html#cb139-11" tabindex="-1"></a><span class="co"># rast_temp %&gt;% terra::crs()</span></span>
<span id="cb139-12"><a href="rgb-classification.html#cb139-12" tabindex="-1"></a><span class="co"># rast_temp %&gt;% terra::plot()</span></span>
<span id="cb139-13"><a href="rgb-classification.html#cb139-13" tabindex="-1"></a><span class="co"># reset the colors</span></span>
<span id="cb139-14"><a href="rgb-classification.html#cb139-14" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">coltab</span>(rast_temp) <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb139-15"><a href="rgb-classification.html#cb139-15" tabindex="-1"></a>  <span class="at">value =</span> terra<span class="sc">::</span><span class="fu">minmax</span>(rast_temp)[<span class="dv">1</span>]<span class="sc">:</span>terra<span class="sc">::</span><span class="fu">minmax</span>(rast_temp)[<span class="dv">2</span>]</span>
<span id="cb139-16"><a href="rgb-classification.html#cb139-16" tabindex="-1"></a>  , <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(terra<span class="sc">::</span><span class="fu">unique</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>(), <span class="at">alpha =</span> <span class="fl">0.9</span>)</span>
<span id="cb139-17"><a href="rgb-classification.html#cb139-17" tabindex="-1"></a>)</span>
<span id="cb139-18"><a href="rgb-classification.html#cb139-18" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb139-19"><a href="rgb-classification.html#cb139-19" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(rast_temp, <span class="at">colNA =</span> <span class="st">&quot;black&quot;</span>, <span class="at">axes=</span>F)</span>
<span id="cb139-20"><a href="rgb-classification.html#cb139-20" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb139-21"><a href="rgb-classification.html#cb139-21" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb139-22"><a href="rgb-classification.html#cb139-22" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb139-23"><a href="rgb-classification.html#cb139-23" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>, <span class="at">axes=</span>F</span>
<span id="cb139-24"><a href="rgb-classification.html#cb139-24" tabindex="-1"></a>)</span></code></pre></div>
<p>it looks like the automatic clustering did not consistently classify the pile locations. let’s check the distribution of the clusters within the pile locations</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="rgb-classification.html#cb140-1" tabindex="-1"></a>tab_temp <span class="ot">&lt;-</span> rast_temp <span class="sc">%&gt;%</span> </span>
<span id="cb140-2"><a href="rgb-classification.html#cb140-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb140-3"><a href="rgb-classification.html#cb140-3" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb140-4"><a href="rgb-classification.html#cb140-4" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb140-5"><a href="rgb-classification.html#cb140-5" tabindex="-1"></a>    , <span class="at">ID =</span> F</span>
<span id="cb140-6"><a href="rgb-classification.html#cb140-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-7"><a href="rgb-classification.html#cb140-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">cluster =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb140-8"><a href="rgb-classification.html#cb140-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb140-9"><a href="rgb-classification.html#cb140-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb140-10"><a href="rgb-classification.html#cb140-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) </span>
<span id="cb140-11"><a href="rgb-classification.html#cb140-11" tabindex="-1"></a><span class="co"># table</span></span>
<span id="cb140-12"><a href="rgb-classification.html#cb140-12" tabindex="-1"></a>tab_temp <span class="sc">%&gt;%</span> </span>
<span id="cb140-13"><a href="rgb-classification.html#cb140-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb140-14"><a href="rgb-classification.html#cb140-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb140-15"><a href="rgb-classification.html#cb140-15" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb140-16"><a href="rgb-classification.html#cb140-16" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">&quot;cluster&quot;</span>,<span class="st">&quot;pct of clusters&lt;br&gt;that overlap with a pile&quot;</span>)</span>
<span id="cb140-17"><a href="rgb-classification.html#cb140-17" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb140-18"><a href="rgb-classification.html#cb140-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-19"><a href="rgb-classification.html#cb140-19" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<p>we can see this if we look at only the clusters that overlap with at least 10% of the piles</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="rgb-classification.html#cb141-1" tabindex="-1"></a><span class="do">### </span></span>
<span id="cb141-2"><a href="rgb-classification.html#cb141-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">subst</span>(</span>
<span id="cb141-3"><a href="rgb-classification.html#cb141-3" tabindex="-1"></a>  rast_temp</span>
<span id="cb141-4"><a href="rgb-classification.html#cb141-4" tabindex="-1"></a>  , <span class="at">from =</span> tab_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(pct<span class="sc">&gt;=</span><span class="fl">0.1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(cluster) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb141-5"><a href="rgb-classification.html#cb141-5" tabindex="-1"></a>  , <span class="at">to =</span> tab_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(pct<span class="sc">&gt;=</span><span class="fl">0.1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(cluster) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb141-6"><a href="rgb-classification.html#cb141-6" tabindex="-1"></a>  , <span class="at">others =</span> <span class="cn">NA</span></span>
<span id="cb141-7"><a href="rgb-classification.html#cb141-7" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb141-8"><a href="rgb-classification.html#cb141-8" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F)</span>
<span id="cb141-9"><a href="rgb-classification.html#cb141-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb141-10"><a href="rgb-classification.html#cb141-10" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb141-11"><a href="rgb-classification.html#cb141-11" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb141-12"><a href="rgb-classification.html#cb141-12" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>, <span class="at">axes=</span>F</span>
<span id="cb141-13"><a href="rgb-classification.html#cb141-13" tabindex="-1"></a>)</span></code></pre></div>
<p>this testing indicated that clustering based on <strong>Superpixels + AP</strong> will likely not work for our problem to detect slash piles in imagery because the output is not granular enough</p>
<div id="kmeans-to-automatically-determine-clusters" class="section level4 hasAnchor" number="3.4.3.1">
<h4><span class="header-section-number">3.4.3.1</span> Kmeans to automatically determine clusters<a href="rgb-classification.html#kmeans-to-automatically-determine-clusters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>one might take advantage of the automatic way the AP algorithm determines the number of clusters in order to perform vector quantization using kmeans (this will give qualitative better results at the cost of increasing computation time). the advantage of using Superpixels + AP + Kmeans (or Mini-Batch-Kmeans, which can decrease the computation time at the cost of a reduced image quality) lies in the fact that the user does not have to specify the number of clusters beforehand</p>
<p>to do this, we update the <code>kmeans_*</code> parameters</p>
<p><strong>this took 40 minutes with kmeans_method = “kmeans”</strong></p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="rgb-classification.html#cb142-1" tabindex="-1"></a><span class="co"># initiate and perform segmentation of images based on superpixels, affinity propagation and kmeans clustering</span></span>
<span id="cb142-2"><a href="rgb-classification.html#cb142-2" tabindex="-1"></a><span class="co"># ?SuperpixelImageSegmentation::Image_Segmentation</span></span>
<span id="cb142-3"><a href="rgb-classification.html#cb142-3" tabindex="-1"></a>init <span class="ot">&lt;-</span> SuperpixelImageSegmentation<span class="sc">::</span>Image_Segmentation<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb142-4"><a href="rgb-classification.html#cb142-4" tabindex="-1"></a>superpixels_slicap_ans <span class="ot">&lt;-</span> init<span class="sc">$</span><span class="fu">spixel_segmentation</span>(</span>
<span id="cb142-5"><a href="rgb-classification.html#cb142-5" tabindex="-1"></a>  <span class="at">input_image =</span> im_temp</span>
<span id="cb142-6"><a href="rgb-classification.html#cb142-6" tabindex="-1"></a>  <span class="co"># a numeric value specifying the number of superpixels</span></span>
<span id="cb142-7"><a href="rgb-classification.html#cb142-7" tabindex="-1"></a>  , <span class="at">superpixel =</span> sp_temp <span class="co"># 3333</span></span>
<span id="cb142-8"><a href="rgb-classification.html#cb142-8" tabindex="-1"></a>  <span class="co"># Either &quot;slic&quot; or &quot;slico&quot;</span></span>
<span id="cb142-9"><a href="rgb-classification.html#cb142-9" tabindex="-1"></a>  , <span class="at">method =</span> <span class="st">&quot;slico&quot;</span></span>
<span id="cb142-10"><a href="rgb-classification.html#cb142-10" tabindex="-1"></a>  <span class="co"># a character string specifying the kmeans method. If not empty (&quot;&quot;) then it can be either &quot;kmeans&quot; or &quot;mini_batch_kmeans&quot;</span></span>
<span id="cb142-11"><a href="rgb-classification.html#cb142-11" tabindex="-1"></a>  , <span class="at">kmeans_method =</span> <span class="st">&quot;mini_batch_kmeans&quot;</span></span>
<span id="cb142-12"><a href="rgb-classification.html#cb142-12" tabindex="-1"></a>  <span class="co"># the method of initialization. One of, optimal_init, quantile_init, kmeans++ and random</span></span>
<span id="cb142-13"><a href="rgb-classification.html#cb142-13" tabindex="-1"></a>  , <span class="at">kmeans_initializer =</span> <span class="st">&quot;kmeans++&quot;</span></span>
<span id="cb142-14"><a href="rgb-classification.html#cb142-14" tabindex="-1"></a>  <span class="co"># number of times the algorithm will be run with different centroid seeds</span></span>
<span id="cb142-15"><a href="rgb-classification.html#cb142-15" tabindex="-1"></a>  , <span class="at">kmeans_num_init =</span> <span class="dv">3</span></span>
<span id="cb142-16"><a href="rgb-classification.html#cb142-16" tabindex="-1"></a>  <span class="co"># the maximum number of clustering iterations</span></span>
<span id="cb142-17"><a href="rgb-classification.html#cb142-17" tabindex="-1"></a>  , <span class="at">kmeans_max_iters =</span> <span class="dv">100</span></span>
<span id="cb142-18"><a href="rgb-classification.html#cb142-18" tabindex="-1"></a>  <span class="co"># If TRUE then the affinity propagation image data will be computed and returned</span></span>
<span id="cb142-19"><a href="rgb-classification.html#cb142-19" tabindex="-1"></a>  , <span class="at">AP_data =</span> <span class="cn">TRUE</span></span>
<span id="cb142-20"><a href="rgb-classification.html#cb142-20" tabindex="-1"></a>  <span class="co"># If TRUE then the median will be used rather than the mean value for the inner computations (see the details section for more information)</span></span>
<span id="cb142-21"><a href="rgb-classification.html#cb142-21" tabindex="-1"></a>  , <span class="at">use_median =</span> <span class="cn">TRUE</span></span>
<span id="cb142-22"><a href="rgb-classification.html#cb142-22" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;L&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb142-23"><a href="rgb-classification.html#cb142-23" tabindex="-1"></a>  , <span class="at">sim_wL =</span> <span class="dv">3</span></span>
<span id="cb142-24"><a href="rgb-classification.html#cb142-24" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;A&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb142-25"><a href="rgb-classification.html#cb142-25" tabindex="-1"></a>  , <span class="at">sim_wA =</span> <span class="dv">10</span></span>
<span id="cb142-26"><a href="rgb-classification.html#cb142-26" tabindex="-1"></a>  <span class="co"># a numeric value specifying the weight for the &quot;B&quot; channel of the image (the weights of the three channels based on the &quot;CIELAB color space&quot;)</span></span>
<span id="cb142-27"><a href="rgb-classification.html#cb142-27" tabindex="-1"></a>  , <span class="at">sim_wB =</span> <span class="dv">10</span></span>
<span id="cb142-28"><a href="rgb-classification.html#cb142-28" tabindex="-1"></a>  <span class="co"># numeric value specifying the colorradius: </span></span>
<span id="cb142-29"><a href="rgb-classification.html#cb142-29" tabindex="-1"></a>    <span class="do">## adjusts the number of clusters, and if its value is low, the number of targets would increase, which leads to more detailed segmentation results</span></span>
<span id="cb142-30"><a href="rgb-classification.html#cb142-30" tabindex="-1"></a>  , <span class="at">sim_color_radius =</span> <span class="dv">2</span></span>
<span id="cb142-31"><a href="rgb-classification.html#cb142-31" tabindex="-1"></a>  , <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb142-32"><a href="rgb-classification.html#cb142-32" tabindex="-1"></a>)</span></code></pre></div>
<p>what did we get back?</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="rgb-classification.html#cb143-1" tabindex="-1"></a>superpixels_slicap_ans <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code></pre></div>
<p>let’s see the clustering output based on <strong>Superpixels + AP + Kmeans</strong> and we’ll add the pile outlines in blue</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="rgb-classification.html#cb144-1" tabindex="-1"></a><span class="co"># # Superpixels + AP</span></span>
<span id="cb144-2"><a href="rgb-classification.html#cb144-2" tabindex="-1"></a><span class="co"># OpenImageR::imageShow(superpixels_slicap_ans$AP_image_data)</span></span>
<span id="cb144-3"><a href="rgb-classification.html#cb144-3" tabindex="-1"></a><span class="co"># # Superpixels + AP + Kmeans</span></span>
<span id="cb144-4"><a href="rgb-classification.html#cb144-4" tabindex="-1"></a><span class="co"># OpenImageR::imageShow(superpixels_slicap_ans$KMeans_image_data)</span></span>
<span id="cb144-5"><a href="rgb-classification.html#cb144-5" tabindex="-1"></a><span class="co"># use the ortho template so we get the projection and then fill with values</span></span>
<span id="cb144-6"><a href="rgb-classification.html#cb144-6" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> ortho_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">1</span>)</span>
<span id="cb144-7"><a href="rgb-classification.html#cb144-7" tabindex="-1"></a>rast_temp[] <span class="ot">&lt;-</span> superpixels_slicap_ans<span class="sc">$</span>KMeans_image_data[,,<span class="dv">1</span>] <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb144-8"><a href="rgb-classification.html#cb144-8" tabindex="-1"></a><span class="co"># the unique values in the layer represent the unique clusters</span></span>
<span id="cb144-9"><a href="rgb-classification.html#cb144-9" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">subst</span>(</span>
<span id="cb144-10"><a href="rgb-classification.html#cb144-10" tabindex="-1"></a>    rast_temp</span>
<span id="cb144-11"><a href="rgb-classification.html#cb144-11" tabindex="-1"></a>    , <span class="at">from =</span> terra<span class="sc">::</span><span class="fu">values</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">c</span>()</span>
<span id="cb144-12"><a href="rgb-classification.html#cb144-12" tabindex="-1"></a>    , <span class="at">to =</span> <span class="dv">1</span><span class="sc">:</span>(terra<span class="sc">::</span><span class="fu">values</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>())</span>
<span id="cb144-13"><a href="rgb-classification.html#cb144-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb144-14"><a href="rgb-classification.html#cb144-14" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.factor</span>()</span>
<span id="cb144-15"><a href="rgb-classification.html#cb144-15" tabindex="-1"></a><span class="co"># rast_temp %&gt;% terra::crs()</span></span>
<span id="cb144-16"><a href="rgb-classification.html#cb144-16" tabindex="-1"></a><span class="co"># rast_temp %&gt;% terra::plot()</span></span>
<span id="cb144-17"><a href="rgb-classification.html#cb144-17" tabindex="-1"></a><span class="co"># reset the colors</span></span>
<span id="cb144-18"><a href="rgb-classification.html#cb144-18" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">coltab</span>(rast_temp) <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb144-19"><a href="rgb-classification.html#cb144-19" tabindex="-1"></a>  <span class="at">value =</span> terra<span class="sc">::</span><span class="fu">minmax</span>(rast_temp)[<span class="dv">1</span>]<span class="sc">:</span>terra<span class="sc">::</span><span class="fu">minmax</span>(rast_temp)[<span class="dv">2</span>]</span>
<span id="cb144-20"><a href="rgb-classification.html#cb144-20" tabindex="-1"></a>  , <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(terra<span class="sc">::</span><span class="fu">unique</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>(), <span class="at">alpha =</span> <span class="fl">0.9</span>)</span>
<span id="cb144-21"><a href="rgb-classification.html#cb144-21" tabindex="-1"></a>)</span>
<span id="cb144-22"><a href="rgb-classification.html#cb144-22" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb144-23"><a href="rgb-classification.html#cb144-23" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(rast_temp, <span class="at">colNA =</span> <span class="st">&quot;black&quot;</span>, <span class="at">axes=</span>F)</span>
<span id="cb144-24"><a href="rgb-classification.html#cb144-24" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb144-25"><a href="rgb-classification.html#cb144-25" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb144-26"><a href="rgb-classification.html#cb144-26" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb144-27"><a href="rgb-classification.html#cb144-27" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>, <span class="at">axes=</span>F</span>
<span id="cb144-28"><a href="rgb-classification.html#cb144-28" tabindex="-1"></a>)</span></code></pre></div>
<p>let’s check the distribution of the clusters within the pile locations</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="rgb-classification.html#cb145-1" tabindex="-1"></a>tab_temp <span class="ot">&lt;-</span> rast_temp <span class="sc">%&gt;%</span> </span>
<span id="cb145-2"><a href="rgb-classification.html#cb145-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb145-3"><a href="rgb-classification.html#cb145-3" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb145-4"><a href="rgb-classification.html#cb145-4" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb145-5"><a href="rgb-classification.html#cb145-5" tabindex="-1"></a>    , <span class="at">ID =</span> F</span>
<span id="cb145-6"><a href="rgb-classification.html#cb145-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb145-7"><a href="rgb-classification.html#cb145-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">cluster =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb145-8"><a href="rgb-classification.html#cb145-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb145-9"><a href="rgb-classification.html#cb145-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb145-10"><a href="rgb-classification.html#cb145-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) </span>
<span id="cb145-11"><a href="rgb-classification.html#cb145-11" tabindex="-1"></a><span class="co"># table</span></span>
<span id="cb145-12"><a href="rgb-classification.html#cb145-12" tabindex="-1"></a>tab_temp <span class="sc">%&gt;%</span> </span>
<span id="cb145-13"><a href="rgb-classification.html#cb145-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb145-14"><a href="rgb-classification.html#cb145-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb145-15"><a href="rgb-classification.html#cb145-15" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb145-16"><a href="rgb-classification.html#cb145-16" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">&quot;cluster&quot;</span>,<span class="st">&quot;pct of clusters&lt;br&gt;that overlap with a pile&quot;</span>)</span>
<span id="cb145-17"><a href="rgb-classification.html#cb145-17" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb145-18"><a href="rgb-classification.html#cb145-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb145-19"><a href="rgb-classification.html#cb145-19" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<p>did anything change with the <strong>Superpixels + AP</strong> output?</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="rgb-classification.html#cb146-1" tabindex="-1"></a><span class="co"># use the ortho template so we get the projection and then fill with values</span></span>
<span id="cb146-2"><a href="rgb-classification.html#cb146-2" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> ortho_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">1</span>)</span>
<span id="cb146-3"><a href="rgb-classification.html#cb146-3" tabindex="-1"></a>rast_temp[] <span class="ot">&lt;-</span> superpixels_slicap_ans<span class="sc">$</span>AP_image_data[,,<span class="dv">1</span>] <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb146-4"><a href="rgb-classification.html#cb146-4" tabindex="-1"></a><span class="co"># the unique values in the layer represent the unique clusters</span></span>
<span id="cb146-5"><a href="rgb-classification.html#cb146-5" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">subst</span>(</span>
<span id="cb146-6"><a href="rgb-classification.html#cb146-6" tabindex="-1"></a>    rast_temp</span>
<span id="cb146-7"><a href="rgb-classification.html#cb146-7" tabindex="-1"></a>    , <span class="at">from =</span> terra<span class="sc">::</span><span class="fu">values</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">c</span>()</span>
<span id="cb146-8"><a href="rgb-classification.html#cb146-8" tabindex="-1"></a>    , <span class="at">to =</span> <span class="dv">1</span><span class="sc">:</span>(terra<span class="sc">::</span><span class="fu">values</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>())</span>
<span id="cb146-9"><a href="rgb-classification.html#cb146-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb146-10"><a href="rgb-classification.html#cb146-10" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.factor</span>()</span>
<span id="cb146-11"><a href="rgb-classification.html#cb146-11" tabindex="-1"></a><span class="co"># rast_temp %&gt;% terra::crs()</span></span>
<span id="cb146-12"><a href="rgb-classification.html#cb146-12" tabindex="-1"></a><span class="co"># rast_temp %&gt;% terra::plot()</span></span>
<span id="cb146-13"><a href="rgb-classification.html#cb146-13" tabindex="-1"></a><span class="co"># reset the colors</span></span>
<span id="cb146-14"><a href="rgb-classification.html#cb146-14" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">coltab</span>(rast_temp) <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb146-15"><a href="rgb-classification.html#cb146-15" tabindex="-1"></a>  <span class="at">value =</span> terra<span class="sc">::</span><span class="fu">minmax</span>(rast_temp)[<span class="dv">1</span>]<span class="sc">:</span>terra<span class="sc">::</span><span class="fu">minmax</span>(rast_temp)[<span class="dv">2</span>]</span>
<span id="cb146-16"><a href="rgb-classification.html#cb146-16" tabindex="-1"></a>  , <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(terra<span class="sc">::</span><span class="fu">unique</span>(rast_temp) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>(), <span class="at">alpha =</span> <span class="fl">0.9</span>)</span>
<span id="cb146-17"><a href="rgb-classification.html#cb146-17" tabindex="-1"></a>)</span>
<span id="cb146-18"><a href="rgb-classification.html#cb146-18" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb146-19"><a href="rgb-classification.html#cb146-19" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(rast_temp, <span class="at">colNA =</span> <span class="st">&quot;black&quot;</span>, <span class="at">axes=</span>F)</span>
<span id="cb146-20"><a href="rgb-classification.html#cb146-20" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb146-21"><a href="rgb-classification.html#cb146-21" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb146-22"><a href="rgb-classification.html#cb146-22" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb146-23"><a href="rgb-classification.html#cb146-23" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>, <span class="at">axes=</span>F</span>
<span id="cb146-24"><a href="rgb-classification.html#cb146-24" tabindex="-1"></a>)</span></code></pre></div>
<p>no.</p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-processing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ptcld_process.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
