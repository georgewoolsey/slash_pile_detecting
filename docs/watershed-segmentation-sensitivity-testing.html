<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 6 Watershed Segmentation: Sensitivity Testing | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 6 Watershed Segmentation: Sensitivity Testing | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 6 Watershed Segmentation: Sensitivity Testing | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="raster_watershed.html"/>
<link rel="next" href="data_fusion.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-processing.html"><a href="data-processing.html"><i class="fa fa-check"></i><b>2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-processing.html"><a href="data-processing.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.1</b> Slash Pile Vector Data</a></li>
<li class="chapter" data-level="2.2" data-path="data-processing.html"><a href="data-processing.html#load-rgb-orthomosaic-rasters"><i class="fa fa-check"></i><b>2.2</b> Load RGB orthomosaic rasters</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data-processing.html"><a href="data-processing.html#example-ratio-based-index"><i class="fa fa-check"></i><b>2.2.1</b> Example ratio-based index</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data-processing.html"><a href="data-processing.html#study-area-imagery"><i class="fa fa-check"></i><b>2.3</b> Study area imagery</a></li>
<li class="chapter" data-level="2.4" data-path="data-processing.html"><a href="data-processing.html#point-cloud-data"><i class="fa fa-check"></i><b>2.4</b> Point Cloud Data</a></li>
<li class="chapter" data-level="2.5" data-path="data-processing.html"><a href="data-processing.html#check-out-one-pile"><i class="fa fa-check"></i><b>2.5</b> Check out one pile</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="rgb-classification.html"><a href="rgb-classification.html"><i class="fa fa-check"></i><b>3</b> RGB Classification</a>
<ul>
<li class="chapter" data-level="3.1" data-path="rgb-classification.html"><a href="rgb-classification.html#textural-covariates"><i class="fa fa-check"></i><b>3.1</b> Textural covariates</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-panchromatic"><i class="fa fa-check"></i><b>3.1.1</b> Raster Texture: Panchromatic</a></li>
<li class="chapter" data-level="3.1.2" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-grvi"><i class="fa fa-check"></i><b>3.1.2</b> Raster Texture: GRVI</a></li>
<li class="chapter" data-level="3.1.3" data-path="rgb-classification.html"><a href="rgb-classification.html#plot-textural-rasters"><i class="fa fa-check"></i><b>3.1.3</b> Plot textural rasters</a></li>
<li class="chapter" data-level="3.1.4" data-path="rgb-classification.html"><a href="rgb-classification.html#features-for-classification"><i class="fa fa-check"></i><b>3.1.4</b> Features for classification</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel-based-unsupervised-classification"><i class="fa fa-check"></i><b>3.2</b> Pixel-based: unsupervised classification</a></li>
<li class="chapter" data-level="3.3" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel_class"><i class="fa fa-check"></i><b>3.3</b> Pixel-based: supervised classification</a></li>
<li class="chapter" data-level="3.4" data-path="rgb-classification.html"><a href="rgb-classification.html#obia"><i class="fa fa-check"></i><b>3.4</b> Object-based image analysis (OBIA)</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="rgb-classification.html"><a href="rgb-classification.html#training-data"><i class="fa fa-check"></i><b>3.4.1</b> Training data</a></li>
<li class="chapter" data-level="3.4.2" data-path="rgb-classification.html"><a href="rgb-classification.html#slic"><i class="fa fa-check"></i><b>3.4.2</b> <code>OpenImageR</code> package SLIC image segmentation</a></li>
<li class="chapter" data-level="3.4.3" data-path="rgb-classification.html"><a href="rgb-classification.html#superpixelimagesegmentation-package-slicap-clustering"><i class="fa fa-check"></i><b>3.4.3</b> <code>SuperpixelImageSegmentation</code> package SLICAP clustering</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ptcld_process.html"><a href="ptcld_process.html"><i class="fa fa-check"></i><b>4</b> Point Cloud Processing and Pile Segmentation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ptcld_process.html"><a href="ptcld_process.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>4.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ptcld_process.html"><a href="ptcld_process.html#dtm-and-chm-piles"><i class="fa fa-check"></i><b>4.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="raster_watershed.html"><a href="raster_watershed.html"><i class="fa fa-check"></i><b>5</b> Raster-based: Watershed Segmentation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="raster_watershed.html"><a href="raster_watershed.html#method-demonstration"><i class="fa fa-check"></i><b>5.1</b> Method Demonstration</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-irregularity-filtering"><i class="fa fa-check"></i><b>5.1.1</b> Geometric filtering: Irregularity Filtering</a></li>
<li class="chapter" data-level="5.1.2" data-path="raster_watershed.html"><a href="raster_watershed.html#area-filtering"><i class="fa fa-check"></i><b>5.1.2</b> Area Filtering</a></li>
<li class="chapter" data-level="5.1.3" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-circularity-filtering"><i class="fa fa-check"></i><b>5.1.3</b> Geometric filtering: Circularity Filtering</a></li>
<li class="chapter" data-level="5.1.4" data-path="raster_watershed.html"><a href="raster_watershed.html#smoothing"><i class="fa fa-check"></i><b>5.1.4</b> Smoothing</a></li>
<li class="chapter" data-level="5.1.5" data-path="raster_watershed.html"><a href="raster_watershed.html#shape-refinement"><i class="fa fa-check"></i><b>5.1.5</b> Shape Refinement</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="raster_watershed.html"><a href="raster_watershed.html#confusion-matrix-evaluation"><i class="fa fa-check"></i><b>5.2</b> Confusion matrix evaluation</a></li>
<li class="chapter" data-level="5.3" data-path="raster_watershed.html"><a href="raster_watershed.html#pile-area-rmse"><i class="fa fa-check"></i><b>5.3</b> Pile area RMSE</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html"><i class="fa fa-check"></i><b>6</b> Watershed Segmentation: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="6.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#slash_pile_detect_watershed"><i class="fa fa-check"></i><b>6.1</b> Watershed Pile Detection Function</a></li>
<li class="chapter" data-level="6.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#wshed_params_test"><i class="fa fa-check"></i><b>6.2</b> Parameter sensitivity testing</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#all_the_combos"><i class="fa fa-check"></i><b>6.2.1</b> Workflow over parameter combinations</a></li>
<li class="chapter" data-level="6.2.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#validation-over-parameter-combinations"><i class="fa fa-check"></i><b>6.2.2</b> Validation over parameter combinations</a></li>
<li class="chapter" data-level="6.2.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#aggregate-assessment-metrics"><i class="fa fa-check"></i><b>6.2.3</b> Aggregate assessment metrics</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#parameter-sensitivity-test-results"><i class="fa fa-check"></i><b>6.3</b> Parameter Sensitivity Test Results</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#overall-pile-detection"><i class="fa fa-check"></i><b>6.3.1</b> Overall: pile detection</a></li>
<li class="chapter" data-level="6.3.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#overall-form-quantification"><i class="fa fa-check"></i><b>6.3.2</b> Overall: form quantification</a></li>
<li class="chapter" data-level="6.3.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#main-effects-pile-detection"><i class="fa fa-check"></i><b>6.3.3</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="6.3.4" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#main-effects-form-quantification"><i class="fa fa-check"></i><b>6.3.4</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="6.3.5" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#best-results-detection-accuracy"><i class="fa fa-check"></i><b>6.3.5</b> Best results: detection accuracy</a></li>
<li class="chapter" data-level="6.3.6" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#best-results-quantification-accuracy"><i class="fa fa-check"></i><b>6.3.6</b> Best results: quantification accuracy</a></li>
<li class="chapter" data-level="6.3.7" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#wshed_best_best"><i class="fa fa-check"></i><b>6.3.7</b> Best results: detection &amp; quantification</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#final-recommended-settings"><i class="fa fa-check"></i><b>6.4</b> Final recommended settings</a></li>
<li class="chapter" data-level="6.5" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#appendix-parameter-combination-drill-downs"><i class="fa fa-check"></i><b>6.5</b> Appendix: Parameter combination drill-downs</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#f-score"><i class="fa fa-check"></i><b>6.5.1</b> F-score</a></li>
<li class="chapter" data-level="6.5.2" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#recall"><i class="fa fa-check"></i><b>6.5.2</b> Recall</a></li>
<li class="chapter" data-level="6.5.3" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#precision"><i class="fa fa-check"></i><b>6.5.3</b> Precision</a></li>
<li class="chapter" data-level="6.5.4" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-volume-irregular"><i class="fa fa-check"></i><b>6.5.4</b> MAPE Volume irregular</a></li>
<li class="chapter" data-level="6.5.5" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-diameter"><i class="fa fa-check"></i><b>6.5.5</b> MAPE Diameter</a></li>
<li class="chapter" data-level="6.5.6" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-area"><i class="fa fa-check"></i><b>6.5.6</b> MAPE Area</a></li>
<li class="chapter" data-level="6.5.7" data-path="watershed-segmentation-sensitivity-testing.html"><a href="watershed-segmentation-sensitivity-testing.html#mape-height"><i class="fa fa-check"></i><b>6.5.7</b> MAPE Height</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data_fusion.html"><a href="data_fusion.html"><i class="fa fa-check"></i><b>7</b> Data Fusion</a>
<ul>
<li class="chapter" data-level="7.1" data-path="data_fusion.html"><a href="data_fusion.html#rgb-indices"><i class="fa fa-check"></i><b>7.1</b> RGB Indices</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-functions"><i class="fa fa-check"></i><b>7.1.1</b> Spectral Index Functions</a></li>
<li class="chapter" data-level="7.1.2" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-of-polygons"><i class="fa fa-check"></i><b>7.1.2</b> Spectral Index of Polygons</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="data_fusion.html"><a href="data_fusion.html#ground-truth-pile-spectral-summary"><i class="fa fa-check"></i><b>7.2</b> Ground Truth Pile Spectral Summary</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="data_fusion.html"><a href="data_fusion.html#voting-system"><i class="fa fa-check"></i><b>7.2.1</b> Voting System</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="data_fusion.html"><a href="data_fusion.html#polygon_spectral_filtering"><i class="fa fa-check"></i><b>7.3</b> Candidate Polygon Spectral Filtering Function</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="fusion_params_test.html"><a href="fusion_params_test.html"><i class="fa fa-check"></i><b>8</b> Data Fusion: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.1" data-path="fusion_params_test.html"><a href="fusion_params_test.html#example-comparison-by-spectral-weighting"><i class="fa fa-check"></i><b>8.1</b> Example comparison by spectral weighting</a></li>
<li class="chapter" data-level="8.2" data-path="fusion_params_test.html"><a href="fusion_params_test.html#aggregate-assessment-metrics-1"><i class="fa fa-check"></i><b>8.2</b> Aggregate assessment metrics</a></li>
<li class="chapter" data-level="8.3" data-path="fusion_params_test.html"><a href="fusion_params_test.html#parameter-sensitivity-test-results-1"><i class="fa fa-check"></i><b>8.3</b> Parameter Sensitivity Test Results</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="fusion_params_test.html"><a href="fusion_params_test.html#main-effect-of-spectral-data-pile-detection"><i class="fa fa-check"></i><b>8.3.1</b> Main effect of spectral data: pile detection</a></li>
<li class="chapter" data-level="8.3.2" data-path="fusion_params_test.html"><a href="fusion_params_test.html#main-effect-of-spectral-data-form-quantification"><i class="fa fa-check"></i><b>8.3.2</b> Main effect of spectral data: form quantification</a></li>
<li class="chapter" data-level="8.3.3" data-path="fusion_params_test.html"><a href="fusion_params_test.html#overall-pile-detection-1"><i class="fa fa-check"></i><b>8.3.3</b> Overall: pile detection</a></li>
<li class="chapter" data-level="8.3.4" data-path="fusion_params_test.html"><a href="fusion_params_test.html#overall-form-quantification-1"><i class="fa fa-check"></i><b>8.3.4</b> Overall: form quantification</a></li>
<li class="chapter" data-level="8.3.5" data-path="fusion_params_test.html"><a href="fusion_params_test.html#best-results-detection-accuracy-1"><i class="fa fa-check"></i><b>8.3.5</b> Best results: detection accuracy</a></li>
<li class="chapter" data-level="8.3.6" data-path="fusion_params_test.html"><a href="fusion_params_test.html#best-results-quantification-accuracy-1"><i class="fa fa-check"></i><b>8.3.6</b> Best results: quantification accuracy</a></li>
<li class="chapter" data-level="8.3.7" data-path="fusion_params_test.html"><a href="fusion_params_test.html#best-results-detection-quantification"><i class="fa fa-check"></i><b>8.3.7</b> Best results: detection &amp; quantification</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="fusion_params_test.html"><a href="fusion_params_test.html#final-recommended-settings-1"><i class="fa fa-check"></i><b>8.4</b> Final recommended settings</a></li>
<li class="chapter" data-level="8.5" data-path="fusion_params_test.html"><a href="fusion_params_test.html#final-recommended-settings-data-fusion-versus-structural-only"><i class="fa fa-check"></i><b>8.5</b> Final recommended settings: data fusion versus structural only</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html"><i class="fa fa-check"></i><b>9</b> CHM Raster Resolution Testing</a>
<ul>
<li class="chapter" data-level="9.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#process-raw-point-cloud-1"><i class="fa fa-check"></i><b>9.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="9.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#structural-only-parameter-testing"><i class="fa fa-check"></i><b>9.2</b> Structural Only: Parameter Testing</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#validation-over-parameter-combinations-1"><i class="fa fa-check"></i><b>9.2.1</b> Validation over parameter combinations</a></li>
<li class="chapter" data-level="9.2.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#aggregate-validation-metrics-to-parameter-combination"><i class="fa fa-check"></i><b>9.2.2</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#data-fusion-parameter-testing"><i class="fa fa-check"></i><b>9.3</b> Data Fusion: Parameter Testing</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#aggregate-validation-metrics-to-parameter-combination-1"><i class="fa fa-check"></i><b>9.3.1</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#read-data-for-analysis"><i class="fa fa-check"></i><b>9.4</b> Read Data for Analysis</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#structural-only"><i class="fa fa-check"></i><b>9.4.1</b> Structural Only</a></li>
<li class="chapter" data-level="9.4.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#data-fusion"><i class="fa fa-check"></i><b>9.4.2</b> Data Fusion</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#allthetests"><i class="fa fa-check"></i><b>9.5</b> Structural Only: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#detect_trends"><i class="fa fa-check"></i><b>9.5.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="9.5.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#main-effects-form-quantification-1"><i class="fa fa-check"></i><b>9.5.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="9.5.3" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#final-recommended-settings-2"><i class="fa fa-check"></i><b>9.5.3</b> Final recommended settings</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#data-fusion-sensitivity-testing"><i class="fa fa-check"></i><b>9.6</b> Data Fusion: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#main-effects-pile-detection-1"><i class="fa fa-check"></i><b>9.6.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="9.6.2" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#main-effects-form-quantification-2"><i class="fa fa-check"></i><b>9.6.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="9.6.3" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#balanced_acc_assess"><i class="fa fa-check"></i><b>9.6.3</b> Final recommended settings</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="chm-raster-resolution-testing.html"><a href="chm-raster-resolution-testing.html#save-the-data"><i class="fa fa-check"></i><b>9.7</b> save the data</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="stats_method.html"><a href="stats_method.html"><i class="fa fa-check"></i><b>10</b> Statistical Testing of Method Settings</a>
<ul>
<li class="chapter" data-level="10.1" data-path="stats_method.html"><a href="stats_method.html#bayesian-generalized-linear-model---f-score"><i class="fa fa-check"></i><b>10.1</b> Bayesian generalized linear model - F-score</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="stats_method.html"><a href="stats_method.html#model-selection"><i class="fa fa-check"></i><b>10.1.1</b> Model selection</a></li>
<li class="chapter" data-level="10.1.2" data-path="stats_method.html"><a href="stats_method.html#modeling"><i class="fa fa-check"></i><b>10.1.2</b> Modeling</a></li>
<li class="chapter" data-level="10.1.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks"><i class="fa fa-check"></i><b>10.1.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="10.1.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects"><i class="fa fa-check"></i><b>10.1.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="10.1.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation"><i class="fa fa-check"></i><b>10.1.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape"><i class="fa fa-check"></i><b>10.2</b> Bayesian generalized linear model - Diameter MAPE</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-1"><i class="fa fa-check"></i><b>10.2.1</b> Model selection</a></li>
<li class="chapter" data-level="10.2.2" data-path="stats_method.html"><a href="stats_method.html#modeling-1"><i class="fa fa-check"></i><b>10.2.2</b> Modeling</a></li>
<li class="chapter" data-level="10.2.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-1"><i class="fa fa-check"></i><b>10.2.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="10.2.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-1"><i class="fa fa-check"></i><b>10.2.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="10.2.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation-1"><i class="fa fa-check"></i><b>10.2.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="stats_method.html"><a href="stats_method.html#bayesian-generalized-linear-model---height-mape"><i class="fa fa-check"></i><b>10.3</b> Bayesian generalized linear model - Height MAPE</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-2"><i class="fa fa-check"></i><b>10.3.1</b> Model selection</a></li>
<li class="chapter" data-level="10.3.2" data-path="stats_method.html"><a href="stats_method.html#modeling-2"><i class="fa fa-check"></i><b>10.3.2</b> Modeling</a></li>
<li class="chapter" data-level="10.3.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-2"><i class="fa fa-check"></i><b>10.3.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="10.3.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-2"><i class="fa fa-check"></i><b>10.3.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="10.3.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation-2"><i class="fa fa-check"></i><b>10.3.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="method-validation.html"><a href="method-validation.html"><i class="fa fa-check"></i><b>11</b> Method Validation</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="watershed-segmentation-sensitivity-testing" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Section 6</span> Watershed Segmentation: Sensitivity Testing<a href="watershed-segmentation-sensitivity-testing.html#watershed-segmentation-sensitivity-testing" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Now we’ll perform sensitivity testing of our <a href="raster_watershed.html#raster_watershed">rules-based slash pile detection methodology</a> which uses a CHM input raster generated directly from the aerial point cloud data. This method does not require any training data for model building and can potentially be used broadly across different domains.</p>
<p>The rule-based method for slash pile detection using CHM raster data generally follows this outline:</p>
<ul>
<li><em>CHM Generation</em>: A Canopy Height Model (CHM) is generated from the point cloud data. The CHM is generated by removing the ground surface effectively representing a Digital Surface Model (DSM) without ground, ensuring all values are heights above bare earth.</li>
<li><em>CHM Height Filtering</em>: A maximum height filter is applied to the CHM to retaining only raster cells below a maximum expected slash pile height (e.g. 4 m), isolating a “slice” of the CHM.</li>
<li><em>Candidate Segmentation</em>: Watershed segmentation is performed on the filtered CHM raster to identify and delineate initial candidate piles based on their structural form.</li>
<li><em>First Irregularity Filtering</em>: Candidate pile locations are initially filtered to remove highly irregular shapes by assessing their overlap with their convex hull (e.g. &gt;70% overlap). This step helps exclude lower tree branches (objects with holes in the lower CHM slice) and unorganized coarse woody debris.</li>
<li><em>Area Filtering</em>: A filter is applied based on the minimum and maximum expected pile areas.</li>
<li><em>Circularity Filtering</em>: A final geometric screen uses least squares circle fitting on each candidate pile, removing any that do not have a strong overlap (based on an Intersection over Union, or IoU, threshold) with the best-fit circle (e.g., &gt;50%). This removes non-circular features such as rectangular boulders and downed tree stems.
<del>* <em>Raster Smoothing</em>: The remaining segmented candidate raster is smoothed to generalize boundaries and aggregate disconnected segments. This process is only applied when the smoothing window (requiring a minimum window size of 3x3 raster cells) would be less than or equal to half the expected minimum pile area, ensuring that coarser rasters are not over-smoothed, which would increase the chance of including non-pile areas.</del>
<del>* <em>Second Irregularity and Area Filtering</em>: A second pass of the area and irregularity filtering, using the convex hull process, is applied to remove any new irregular shapes that may have been generated during the smoothing</del></li>
<li><em>Shape Refinement &amp; Overlap Removal</em>: Lastly, segments are smoothed using their convex hull to remove the “blocky” raster edges (like they were made in Minecraft). Overlapping convex hull shapes are then removed to prevent false positives from clustered small trees or shrubs, ensuring singular pile detections.</li>
</ul>
<p><em>the raster smoothing of the filtered segments worked well at very low chm resolutions (&lt;=0.2m) for improving f-score and stabilizing slash pile footprint predictions when comparing the estimated diameter to field-measured values. however, at resolutions around 0.2 m, this process led to overestimation of pile diameter and a distorted trend in our accuracy metrics when compared across CHM resolutions. as a result, we have removed the raster smoothing step. our final detection process now relies on smoothing the filtered segments using their convex hull to remove “blocky” raster edges. the removal of any overlapping shapes is then used as the final step to prevent false positives from clustered small trees or shrubs.</em></p>
<div id="slash_pile_detect_watershed" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Watershed Pile Detection Function<a href="watershed-segmentation-sensitivity-testing.html#slash_pile_detect_watershed" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s package all of the steps we demonstrated when <a href="raster_watershed.html#raster_watershed">formulating the methodology</a> into a single function which can possibly be integrated into the <code>cloud2trees</code> package.</p>
<p>The parameters are defined as follows:</p>
<ul>
<li><code>max_ht_m</code> : numeric. The maximum height (in meters) a slash pile is expected to be. This value helps us focus on a specific “slice” of the data, ignoring anything taller than a typical pile.</li>
<li><code>min_area_m2</code> : numeric. The smallest 2D area (in square meters) a detected pile must cover to be considered valid.</li>
<li><code>max_area_m2</code> : numeric. The largest 2D area (in square meters) a detected pile can cover to be considered valid.</li>
<li><code>convexity_pct</code> : numeric. A value between 0 and 1 that controls how strict the filtering is for regularly shaped piles. A value of 1 means only piles that are perfectly smooth and rounded, with no dents or inward curves are kept. A value of 0 allows for both perfectly regular and very irregular shapes. This filter works alongside <code>circle_fit_iou_pct</code> to refine the pile’s overall shape.</li>
<li><code>circle_fit_iou_pct</code> : numeric. A value between 0 and 1 that controls how the filtering is for circular pile shapes. Setting it to 1 means only piles that are perfectly circular are kept. A value of 0 allows for a wide range of shapes, including very circular and non-circular ones (like long, straight lines).</li>
<li><code>smooth_segs</code> : logical. Setting this option to TRUE will: 1) smooth out the “blocky” edges of detected piles (which can look like they were made in Minecraft) by using their overall shape; and 2) remove any detected piles that overlap significantly with other smoothed piles to help ensure each detection is a single slash pile, not a cluster of small trees or shrubs.</li>
</ul>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="watershed-segmentation-sensitivity-testing.html#cb211-1" tabindex="-1"></a><span class="co"># function to calculate the diamater of an sf polygon that is potentially irregularly shaped</span></span>
<span id="cb211-2"><a href="watershed-segmentation-sensitivity-testing.html#cb211-2" tabindex="-1"></a><span class="co"># using the distance between the farthest points</span></span>
<span id="cb211-3"><a href="watershed-segmentation-sensitivity-testing.html#cb211-3" tabindex="-1"></a>st_calculate_diameter <span class="ot">&lt;-</span> <span class="cf">function</span>(polygon) {</span>
<span id="cb211-4"><a href="watershed-segmentation-sensitivity-testing.html#cb211-4" tabindex="-1"></a>  <span class="co"># compute the convex hull</span></span>
<span id="cb211-5"><a href="watershed-segmentation-sensitivity-testing.html#cb211-5" tabindex="-1"></a>  ch <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_convex_hull</span>(polygon)</span>
<span id="cb211-6"><a href="watershed-segmentation-sensitivity-testing.html#cb211-6" tabindex="-1"></a></span>
<span id="cb211-7"><a href="watershed-segmentation-sensitivity-testing.html#cb211-7" tabindex="-1"></a>  <span class="co"># cast to multipoint then point to get individual vertices</span></span>
<span id="cb211-8"><a href="watershed-segmentation-sensitivity-testing.html#cb211-8" tabindex="-1"></a>  ch_points <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(sf<span class="sc">::</span><span class="fu">st_cast</span>(ch, <span class="st">&#39;MULTIPOINT&#39;</span>), <span class="st">&#39;POINT&#39;</span>)</span>
<span id="cb211-9"><a href="watershed-segmentation-sensitivity-testing.html#cb211-9" tabindex="-1"></a></span>
<span id="cb211-10"><a href="watershed-segmentation-sensitivity-testing.html#cb211-10" tabindex="-1"></a>  <span class="co"># calculate the distances between all pairs of points</span></span>
<span id="cb211-11"><a href="watershed-segmentation-sensitivity-testing.html#cb211-11" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(ch_points)</span>
<span id="cb211-12"><a href="watershed-segmentation-sensitivity-testing.html#cb211-12" tabindex="-1"></a></span>
<span id="cb211-13"><a href="watershed-segmentation-sensitivity-testing.html#cb211-13" tabindex="-1"></a>  <span class="co"># find the maximum distance, which is the diameter</span></span>
<span id="cb211-14"><a href="watershed-segmentation-sensitivity-testing.html#cb211-14" tabindex="-1"></a>  diameter <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">max</span>(distances,<span class="at">na.rm=</span>T))</span>
<span id="cb211-15"><a href="watershed-segmentation-sensitivity-testing.html#cb211-15" tabindex="-1"></a>  <span class="fu">return</span>(diameter)</span>
<span id="cb211-16"><a href="watershed-segmentation-sensitivity-testing.html#cb211-16" tabindex="-1"></a>}</span>
<span id="cb211-17"><a href="watershed-segmentation-sensitivity-testing.html#cb211-17" tabindex="-1"></a><span class="co"># rounds to nearest odd since ws for terra::focal() only takes odd</span></span>
<span id="cb211-18"><a href="watershed-segmentation-sensitivity-testing.html#cb211-18" tabindex="-1"></a>round_to_nearest_odd <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb211-19"><a href="watershed-segmentation-sensitivity-testing.html#cb211-19" tabindex="-1"></a>  rounded_int <span class="ot">&lt;-</span> <span class="fu">round</span>(x)</span>
<span id="cb211-20"><a href="watershed-segmentation-sensitivity-testing.html#cb211-20" tabindex="-1"></a></span>
<span id="cb211-21"><a href="watershed-segmentation-sensitivity-testing.html#cb211-21" tabindex="-1"></a>  <span class="co"># step 2: check if the rounded integer is already odd</span></span>
<span id="cb211-22"><a href="watershed-segmentation-sensitivity-testing.html#cb211-22" tabindex="-1"></a>  is_odd <span class="ot">&lt;-</span> (rounded_int <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb211-23"><a href="watershed-segmentation-sensitivity-testing.html#cb211-23" tabindex="-1"></a></span>
<span id="cb211-24"><a href="watershed-segmentation-sensitivity-testing.html#cb211-24" tabindex="-1"></a>  <span class="co"># step 3: for numbers that rounded to an even integer, find the nearest odd</span></span>
<span id="cb211-25"><a href="watershed-segmentation-sensitivity-testing.html#cb211-25" tabindex="-1"></a>  odd_down <span class="ot">&lt;-</span> rounded_int <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb211-26"><a href="watershed-segmentation-sensitivity-testing.html#cb211-26" tabindex="-1"></a>  odd_up <span class="ot">&lt;-</span> rounded_int <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb211-27"><a href="watershed-segmentation-sensitivity-testing.html#cb211-27" tabindex="-1"></a></span>
<span id="cb211-28"><a href="watershed-segmentation-sensitivity-testing.html#cb211-28" tabindex="-1"></a>  <span class="co"># calculate the absolute distances from the original number &#39;x&#39;</span></span>
<span id="cb211-29"><a href="watershed-segmentation-sensitivity-testing.html#cb211-29" tabindex="-1"></a>  dist_down <span class="ot">&lt;-</span> <span class="fu">abs</span>(x <span class="sc">-</span> odd_down)</span>
<span id="cb211-30"><a href="watershed-segmentation-sensitivity-testing.html#cb211-30" tabindex="-1"></a>  dist_up <span class="ot">&lt;-</span> <span class="fu">abs</span>(x <span class="sc">-</span> odd_up)</span>
<span id="cb211-31"><a href="watershed-segmentation-sensitivity-testing.html#cb211-31" tabindex="-1"></a></span>
<span id="cb211-32"><a href="watershed-segmentation-sensitivity-testing.html#cb211-32" tabindex="-1"></a>  <span class="co"># step 4: use ifelse for vectorized conditional logic</span></span>
<span id="cb211-33"><a href="watershed-segmentation-sensitivity-testing.html#cb211-33" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb211-34"><a href="watershed-segmentation-sensitivity-testing.html#cb211-34" tabindex="-1"></a>    is_odd</span>
<span id="cb211-35"><a href="watershed-segmentation-sensitivity-testing.html#cb211-35" tabindex="-1"></a>    , rounded_int <span class="co"># if the initially rounded integer is odd, use it</span></span>
<span id="cb211-36"><a href="watershed-segmentation-sensitivity-testing.html#cb211-36" tabindex="-1"></a>    , <span class="fu">ifelse</span>(</span>
<span id="cb211-37"><a href="watershed-segmentation-sensitivity-testing.html#cb211-37" tabindex="-1"></a>      dist_down <span class="sc">&lt;</span> dist_up</span>
<span id="cb211-38"><a href="watershed-segmentation-sensitivity-testing.html#cb211-38" tabindex="-1"></a>      , odd_down <span class="co"># if odd_down is strictly closer</span></span>
<span id="cb211-39"><a href="watershed-segmentation-sensitivity-testing.html#cb211-39" tabindex="-1"></a>      , odd_up <span class="co"># if odd_up is closer or equidistant</span></span>
<span id="cb211-40"><a href="watershed-segmentation-sensitivity-testing.html#cb211-40" tabindex="-1"></a>    )</span>
<span id="cb211-41"><a href="watershed-segmentation-sensitivity-testing.html#cb211-41" tabindex="-1"></a>  )</span>
<span id="cb211-42"><a href="watershed-segmentation-sensitivity-testing.html#cb211-42" tabindex="-1"></a></span>
<span id="cb211-43"><a href="watershed-segmentation-sensitivity-testing.html#cb211-43" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb211-44"><a href="watershed-segmentation-sensitivity-testing.html#cb211-44" tabindex="-1"></a>}</span>
<span id="cb211-45"><a href="watershed-segmentation-sensitivity-testing.html#cb211-45" tabindex="-1"></a><span class="co"># round_to_nearest_odd(c(2,2.2,1.5,0))</span></span>
<span id="cb211-46"><a href="watershed-segmentation-sensitivity-testing.html#cb211-46" tabindex="-1"></a></span>
<span id="cb211-47"><a href="watershed-segmentation-sensitivity-testing.html#cb211-47" tabindex="-1"></a><span class="co"># find window size given res and min expected area</span></span>
<span id="cb211-48"><a href="watershed-segmentation-sensitivity-testing.html#cb211-48" tabindex="-1"></a>ws_for_smooth_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(chm_res,min_area_m2){</span>
<span id="cb211-49"><a href="watershed-segmentation-sensitivity-testing.html#cb211-49" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(min_area_m2)<span class="sc">&gt;</span><span class="dv">1</span>){<span class="fu">stop</span>(<span class="st">&quot;min_area_m2 must be a single numeric value&quot;</span>)}</span>
<span id="cb211-50"><a href="watershed-segmentation-sensitivity-testing.html#cb211-50" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb211-51"><a href="watershed-segmentation-sensitivity-testing.html#cb211-51" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>( </span>
<span id="cb211-52"><a href="watershed-segmentation-sensitivity-testing.html#cb211-52" tabindex="-1"></a>    T <span class="sc">~</span> <span class="dv">0</span> <span class="do">## all will be 0 so smoothing won&#39;t happen</span></span>
<span id="cb211-53"><a href="watershed-segmentation-sensitivity-testing.html#cb211-53" tabindex="-1"></a>    <span class="do">###!!!!!! original attempt down here...just remove T ~ 0 !!!!!!</span><span class="al">###</span></span>
<span id="cb211-54"><a href="watershed-segmentation-sensitivity-testing.html#cb211-54" tabindex="-1"></a>    , (chm_res<span class="sc">*</span><span class="dv">3</span>) <span class="sc">&gt;</span> (min_area_m2<span class="sc">/</span><span class="dv">2</span>) <span class="sc">~</span> <span class="dv">0</span> <span class="co"># the minimum ws of 3 exceeds half of the expected area (coarse)</span></span>
<span id="cb211-55"><a href="watershed-segmentation-sensitivity-testing.html#cb211-55" tabindex="-1"></a>    , T <span class="sc">~</span> <span class="fu">round</span>( (min_area_m2<span class="sc">/</span><span class="dv">4</span>) <span class="sc">/</span> chm_res ) <span class="sc">%&gt;%</span> <span class="fu">round_to_nearest_odd</span>() <span class="sc">%&gt;%</span> <span class="fu">max</span>(<span class="dv">3</span>) <span class="co"># has to be odd and at least 3</span></span>
<span id="cb211-56"><a href="watershed-segmentation-sensitivity-testing.html#cb211-56" tabindex="-1"></a>  )</span>
<span id="cb211-57"><a href="watershed-segmentation-sensitivity-testing.html#cb211-57" tabindex="-1"></a>}</span>
<span id="cb211-58"><a href="watershed-segmentation-sensitivity-testing.html#cb211-58" tabindex="-1"></a><span class="co"># dplyr::tibble(res = seq(0.01,0.5,by=0.01)) %&gt;% </span></span>
<span id="cb211-59"><a href="watershed-segmentation-sensitivity-testing.html#cb211-59" tabindex="-1"></a><span class="co">#   dplyr::rowwise() %&gt;% </span></span>
<span id="cb211-60"><a href="watershed-segmentation-sensitivity-testing.html#cb211-60" tabindex="-1"></a><span class="co">#   dplyr::mutate(</span></span>
<span id="cb211-61"><a href="watershed-segmentation-sensitivity-testing.html#cb211-61" tabindex="-1"></a><span class="co">#     ws = ws_for_smooth_fn(res, 2) # min_area_m2=2</span></span>
<span id="cb211-62"><a href="watershed-segmentation-sensitivity-testing.html#cb211-62" tabindex="-1"></a><span class="co">#     , area = ifelse(ws==0, res*res,</span></span>
<span id="cb211-63"><a href="watershed-segmentation-sensitivity-testing.html#cb211-63" tabindex="-1"></a><span class="co">#       (res^2) * (ws^2))</span></span>
<span id="cb211-64"><a href="watershed-segmentation-sensitivity-testing.html#cb211-64" tabindex="-1"></a><span class="co">#     , area_prop = area/2 # min_area_m2=2</span></span>
<span id="cb211-65"><a href="watershed-segmentation-sensitivity-testing.html#cb211-65" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb211-66"><a href="watershed-segmentation-sensitivity-testing.html#cb211-66" tabindex="-1"></a><span class="co"># ggplot() +</span></span>
<span id="cb211-67"><a href="watershed-segmentation-sensitivity-testing.html#cb211-67" tabindex="-1"></a><span class="co">#   # geom_line(aes(x=res,y=ws)) +</span></span>
<span id="cb211-68"><a href="watershed-segmentation-sensitivity-testing.html#cb211-68" tabindex="-1"></a><span class="co">#   # geom_line(aes(x=res,y=area)) +</span></span>
<span id="cb211-69"><a href="watershed-segmentation-sensitivity-testing.html#cb211-69" tabindex="-1"></a><span class="co">#   geom_line(aes(x=res,y=area_prop)) +</span></span>
<span id="cb211-70"><a href="watershed-segmentation-sensitivity-testing.html#cb211-70" tabindex="-1"></a><span class="co">#   # scale_y_continuous(breaks = scales::breaks_extended(n=22)) +</span></span>
<span id="cb211-71"><a href="watershed-segmentation-sensitivity-testing.html#cb211-71" tabindex="-1"></a><span class="co">#   scale_y_continuous(breaks = scales::breaks_extended(n=22), labels = scales::percent) +</span></span>
<span id="cb211-72"><a href="watershed-segmentation-sensitivity-testing.html#cb211-72" tabindex="-1"></a><span class="co">#   scale_x_continuous(breaks = scales::breaks_extended(n=20))</span></span>
<span id="cb211-73"><a href="watershed-segmentation-sensitivity-testing.html#cb211-73" tabindex="-1"></a></span>
<span id="cb211-74"><a href="watershed-segmentation-sensitivity-testing.html#cb211-74" tabindex="-1"></a></span>
<span id="cb211-75"><a href="watershed-segmentation-sensitivity-testing.html#cb211-75" tabindex="-1"></a><span class="co"># detect funciton</span></span>
<span id="cb211-76"><a href="watershed-segmentation-sensitivity-testing.html#cb211-76" tabindex="-1"></a>slash_pile_detect_watershed <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb211-77"><a href="watershed-segmentation-sensitivity-testing.html#cb211-77" tabindex="-1"></a>  chm_rast</span>
<span id="cb211-78"><a href="watershed-segmentation-sensitivity-testing.html#cb211-78" tabindex="-1"></a>  <span class="do">#### height and area thresholds for the detected piles</span></span>
<span id="cb211-79"><a href="watershed-segmentation-sensitivity-testing.html#cb211-79" tabindex="-1"></a>  <span class="co"># these should be based on data from the literature or expectations based on the prescription</span></span>
<span id="cb211-80"><a href="watershed-segmentation-sensitivity-testing.html#cb211-80" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span> <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb211-81"><a href="watershed-segmentation-sensitivity-testing.html#cb211-81" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="dv">2</span> <span class="co"># set the min expected pile area</span></span>
<span id="cb211-82"><a href="watershed-segmentation-sensitivity-testing.html#cb211-82" tabindex="-1"></a>  , <span class="at">max_area_m2 =</span> <span class="dv">50</span> <span class="co"># set the max expected pile area</span></span>
<span id="cb211-83"><a href="watershed-segmentation-sensitivity-testing.html#cb211-83" tabindex="-1"></a>  <span class="do">#### irregularity filtering</span></span>
<span id="cb211-84"><a href="watershed-segmentation-sensitivity-testing.html#cb211-84" tabindex="-1"></a>  <span class="co"># 1 = perfectly convex (no inward angles); 0 = so many inward angles</span></span>
<span id="cb211-85"><a href="watershed-segmentation-sensitivity-testing.html#cb211-85" tabindex="-1"></a>  <span class="co"># values closer to 1 remove more irregular segments; </span></span>
<span id="cb211-86"><a href="watershed-segmentation-sensitivity-testing.html#cb211-86" tabindex="-1"></a>    <span class="co"># values closer to 0 keep more irregular segments (and also regular segments)</span></span>
<span id="cb211-87"><a href="watershed-segmentation-sensitivity-testing.html#cb211-87" tabindex="-1"></a>  <span class="co"># these will all be further filtered for their circularity and later smoothed to remove blocky edges</span></span>
<span id="cb211-88"><a href="watershed-segmentation-sensitivity-testing.html#cb211-88" tabindex="-1"></a>  <span class="co"># and most inward angles by applying a convex hull to the original detected segment</span></span>
<span id="cb211-89"><a href="watershed-segmentation-sensitivity-testing.html#cb211-89" tabindex="-1"></a>  , <span class="at">convexity_pct =</span> <span class="fl">0.7</span> <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb211-90"><a href="watershed-segmentation-sensitivity-testing.html#cb211-90" tabindex="-1"></a>  <span class="do">#### circularity filtering</span></span>
<span id="cb211-91"><a href="watershed-segmentation-sensitivity-testing.html#cb211-91" tabindex="-1"></a>  <span class="co"># 1 = perfectly circular; 0 = not circular (e.g. linear) but also circular</span></span>
<span id="cb211-92"><a href="watershed-segmentation-sensitivity-testing.html#cb211-92" tabindex="-1"></a>  <span class="co"># min required IoU between the predicted pile and the best fit circle of the predicted pile</span></span>
<span id="cb211-93"><a href="watershed-segmentation-sensitivity-testing.html#cb211-93" tabindex="-1"></a>  , <span class="at">circle_fit_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb211-94"><a href="watershed-segmentation-sensitivity-testing.html#cb211-94" tabindex="-1"></a>  <span class="do">#### shape refinement &amp; overlap removal</span></span>
<span id="cb211-95"><a href="watershed-segmentation-sensitivity-testing.html#cb211-95" tabindex="-1"></a>  <span class="do">## smooth_segs = T ... convex hulls of raster detected segments are returned, any that overlap are removed</span></span>
<span id="cb211-96"><a href="watershed-segmentation-sensitivity-testing.html#cb211-96" tabindex="-1"></a>  <span class="do">## smooth_segs = F ... raster detected segments are returned (blocky) if they meet all prior rules</span></span>
<span id="cb211-97"><a href="watershed-segmentation-sensitivity-testing.html#cb211-97" tabindex="-1"></a>  , <span class="at">smooth_segs =</span> T</span>
<span id="cb211-98"><a href="watershed-segmentation-sensitivity-testing.html#cb211-98" tabindex="-1"></a>) {</span>
<span id="cb211-99"><a href="watershed-segmentation-sensitivity-testing.html#cb211-99" tabindex="-1"></a>    <span class="co"># checks</span></span>
<span id="cb211-100"><a href="watershed-segmentation-sensitivity-testing.html#cb211-100" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb211-101"><a href="watershed-segmentation-sensitivity-testing.html#cb211-101" tabindex="-1"></a>  <span class="co"># just get the first layer and &quot;slice&quot; the raster based on the height threshold</span></span>
<span id="cb211-102"><a href="watershed-segmentation-sensitivity-testing.html#cb211-102" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb211-103"><a href="watershed-segmentation-sensitivity-testing.html#cb211-103" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb211-104"><a href="watershed-segmentation-sensitivity-testing.html#cb211-104" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb211-105"><a href="watershed-segmentation-sensitivity-testing.html#cb211-105" tabindex="-1"></a>  </span>
<span id="cb211-106"><a href="watershed-segmentation-sensitivity-testing.html#cb211-106" tabindex="-1"></a>  <span class="co"># could make this a parameter</span></span>
<span id="cb211-107"><a href="watershed-segmentation-sensitivity-testing.html#cb211-107" tabindex="-1"></a>  <span class="co"># could automatically adjust for raster cell size: </span></span>
<span id="cb211-108"><a href="watershed-segmentation-sensitivity-testing.html#cb211-108" tabindex="-1"></a>    <span class="co"># higher res (smaller cell size) get bigger ws, lower res (larger cell size) get smaller/no ws???</span></span>
<span id="cb211-109"><a href="watershed-segmentation-sensitivity-testing.html#cb211-109" tabindex="-1"></a>  <span class="co"># get resolution which will be used to test against the minimum expected pile area</span></span>
<span id="cb211-110"><a href="watershed-segmentation-sensitivity-testing.html#cb211-110" tabindex="-1"></a>  chm_res <span class="ot">&lt;-</span> <span class="fu">max</span>(terra<span class="sc">::</span><span class="fu">res</span>(chm_rast)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">na.rm =</span> T)</span>
<span id="cb211-111"><a href="watershed-segmentation-sensitivity-testing.html#cb211-111" tabindex="-1"></a>  </span>
<span id="cb211-112"><a href="watershed-segmentation-sensitivity-testing.html#cb211-112" tabindex="-1"></a>  ws_for_smooth <span class="ot">&lt;-</span> <span class="fu">ws_for_smooth_fn</span>(<span class="at">chm_res =</span> chm_res, <span class="at">min_area_m2 =</span> min_area_m2) <span class="co"># 3 # needs to be the same for the watershed seg and CHM smooth</span></span>
<span id="cb211-113"><a href="watershed-segmentation-sensitivity-testing.html#cb211-113" tabindex="-1"></a>  <span class="co"># search_area = (res^2) * (ws^2)</span></span>
<span id="cb211-114"><a href="watershed-segmentation-sensitivity-testing.html#cb211-114" tabindex="-1"></a>  </span>
<span id="cb211-115"><a href="watershed-segmentation-sensitivity-testing.html#cb211-115" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-116"><a href="watershed-segmentation-sensitivity-testing.html#cb211-116" tabindex="-1"></a>  <span class="do">## 1) watershed segmentation</span></span>
<span id="cb211-117"><a href="watershed-segmentation-sensitivity-testing.html#cb211-117" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-118"><a href="watershed-segmentation-sensitivity-testing.html#cb211-118" tabindex="-1"></a>    <span class="co"># let&#39;s run watershed segmentation using `lidR::watershed()` which is based on the bioconductor package `EBIimage`</span></span>
<span id="cb211-119"><a href="watershed-segmentation-sensitivity-testing.html#cb211-119" tabindex="-1"></a>    <span class="co"># return is a raster with the first layer representing the identified watershed segments</span></span>
<span id="cb211-120"><a href="watershed-segmentation-sensitivity-testing.html#cb211-120" tabindex="-1"></a>    watershed_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb211-121"><a href="watershed-segmentation-sensitivity-testing.html#cb211-121" tabindex="-1"></a>        <span class="at">chm =</span> chm_rast</span>
<span id="cb211-122"><a href="watershed-segmentation-sensitivity-testing.html#cb211-122" tabindex="-1"></a>        , <span class="at">th_tree =</span> <span class="fl">0.5</span> <span class="co"># this would be the minimum expected pile height</span></span>
<span id="cb211-123"><a href="watershed-segmentation-sensitivity-testing.html#cb211-123" tabindex="-1"></a>      )()</span>
<span id="cb211-124"><a href="watershed-segmentation-sensitivity-testing.html#cb211-124" tabindex="-1"></a>    <span class="fu">names</span>(watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb211-125"><a href="watershed-segmentation-sensitivity-testing.html#cb211-125" tabindex="-1"></a></span>
<span id="cb211-126"><a href="watershed-segmentation-sensitivity-testing.html#cb211-126" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb211-127"><a href="watershed-segmentation-sensitivity-testing.html#cb211-127" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb211-128"><a href="watershed-segmentation-sensitivity-testing.html#cb211-128" tabindex="-1"></a>      watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb211-129"><a href="watershed-segmentation-sensitivity-testing.html#cb211-129" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb211-130"><a href="watershed-segmentation-sensitivity-testing.html#cb211-130" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-131"><a href="watershed-segmentation-sensitivity-testing.html#cb211-131" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-132"><a href="watershed-segmentation-sensitivity-testing.html#cb211-132" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-133"><a href="watershed-segmentation-sensitivity-testing.html#cb211-133" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-134"><a href="watershed-segmentation-sensitivity-testing.html#cb211-134" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb211-135"><a href="watershed-segmentation-sensitivity-testing.html#cb211-135" tabindex="-1"></a>      <span class="co"># simplify multipolygons by keeping the largest polygon of each multipolygon</span></span>
<span id="cb211-136"><a href="watershed-segmentation-sensitivity-testing.html#cb211-136" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb211-137"><a href="watershed-segmentation-sensitivity-testing.html#cb211-137" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-138"><a href="watershed-segmentation-sensitivity-testing.html#cb211-138" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb211-139"><a href="watershed-segmentation-sensitivity-testing.html#cb211-139" tabindex="-1"></a></span>
<span id="cb211-140"><a href="watershed-segmentation-sensitivity-testing.html#cb211-140" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-141"><a href="watershed-segmentation-sensitivity-testing.html#cb211-141" tabindex="-1"></a>  <span class="do">## 2) irregularity filtering</span></span>
<span id="cb211-142"><a href="watershed-segmentation-sensitivity-testing.html#cb211-142" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-143"><a href="watershed-segmentation-sensitivity-testing.html#cb211-143" tabindex="-1"></a>    <span class="co"># let&#39;s first filter out segments that have holes in them </span></span>
<span id="cb211-144"><a href="watershed-segmentation-sensitivity-testing.html#cb211-144" tabindex="-1"></a>    <span class="co"># or are very irregularly shaped by comparing the area of the polygon and convex hull</span></span>
<span id="cb211-145"><a href="watershed-segmentation-sensitivity-testing.html#cb211-145" tabindex="-1"></a></span>
<span id="cb211-146"><a href="watershed-segmentation-sensitivity-testing.html#cb211-146" tabindex="-1"></a>    <span class="co"># convexity_pct = min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb211-147"><a href="watershed-segmentation-sensitivity-testing.html#cb211-147" tabindex="-1"></a>    <span class="cf">if</span>(convexity_pct<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb211-148"><a href="watershed-segmentation-sensitivity-testing.html#cb211-148" tabindex="-1"></a>      <span class="co"># apply the irregularity filtering on the polygons</span></span>
<span id="cb211-149"><a href="watershed-segmentation-sensitivity-testing.html#cb211-149" tabindex="-1"></a>      watershed_ans_poly <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb211-150"><a href="watershed-segmentation-sensitivity-testing.html#cb211-150" tabindex="-1"></a>        <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> convexity_pct)</span>
<span id="cb211-151"><a href="watershed-segmentation-sensitivity-testing.html#cb211-151" tabindex="-1"></a>    }</span>
<span id="cb211-152"><a href="watershed-segmentation-sensitivity-testing.html#cb211-152" tabindex="-1"></a></span>
<span id="cb211-153"><a href="watershed-segmentation-sensitivity-testing.html#cb211-153" tabindex="-1"></a>    <span class="co"># check return</span></span>
<span id="cb211-154"><a href="watershed-segmentation-sensitivity-testing.html#cb211-154" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb211-155"><a href="watershed-segmentation-sensitivity-testing.html#cb211-155" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb211-156"><a href="watershed-segmentation-sensitivity-testing.html#cb211-156" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and irregularity expectations&quot;</span></span>
<span id="cb211-157"><a href="watershed-segmentation-sensitivity-testing.html#cb211-157" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `convexity_pct` &quot;</span></span>
<span id="cb211-158"><a href="watershed-segmentation-sensitivity-testing.html#cb211-158" tabindex="-1"></a>      ))</span>
<span id="cb211-159"><a href="watershed-segmentation-sensitivity-testing.html#cb211-159" tabindex="-1"></a>    }</span>
<span id="cb211-160"><a href="watershed-segmentation-sensitivity-testing.html#cb211-160" tabindex="-1"></a></span>
<span id="cb211-161"><a href="watershed-segmentation-sensitivity-testing.html#cb211-161" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-162"><a href="watershed-segmentation-sensitivity-testing.html#cb211-162" tabindex="-1"></a>  <span class="do">## 3) area filtering</span></span>
<span id="cb211-163"><a href="watershed-segmentation-sensitivity-testing.html#cb211-163" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-164"><a href="watershed-segmentation-sensitivity-testing.html#cb211-164" tabindex="-1"></a>    <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb211-165"><a href="watershed-segmentation-sensitivity-testing.html#cb211-165" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb211-166"><a href="watershed-segmentation-sensitivity-testing.html#cb211-166" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb211-167"><a href="watershed-segmentation-sensitivity-testing.html#cb211-167" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb211-168"><a href="watershed-segmentation-sensitivity-testing.html#cb211-168" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb211-169"><a href="watershed-segmentation-sensitivity-testing.html#cb211-169" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb211-170"><a href="watershed-segmentation-sensitivity-testing.html#cb211-170" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb211-171"><a href="watershed-segmentation-sensitivity-testing.html#cb211-171" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(area_xxxx))</span>
<span id="cb211-172"><a href="watershed-segmentation-sensitivity-testing.html#cb211-172" tabindex="-1"></a>   </span>
<span id="cb211-173"><a href="watershed-segmentation-sensitivity-testing.html#cb211-173" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-174"><a href="watershed-segmentation-sensitivity-testing.html#cb211-174" tabindex="-1"></a>  <span class="do">## 4) circularity filtering</span></span>
<span id="cb211-175"><a href="watershed-segmentation-sensitivity-testing.html#cb211-175" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-176"><a href="watershed-segmentation-sensitivity-testing.html#cb211-176" tabindex="-1"></a>    <span class="co"># let&#39;s apply a circle-fitting algorithm to remove non-circular segments from the remaining segments</span></span>
<span id="cb211-177"><a href="watershed-segmentation-sensitivity-testing.html#cb211-177" tabindex="-1"></a>    <span class="co"># let&#39;s apply the `sf_data_circle_fit()` function that</span></span>
<span id="cb211-178"><a href="watershed-segmentation-sensitivity-testing.html#cb211-178" tabindex="-1"></a>    <span class="co"># fits the best circle using `lidR::fit_circle()` to each watershed detected segment </span></span>
<span id="cb211-179"><a href="watershed-segmentation-sensitivity-testing.html#cb211-179" tabindex="-1"></a>    <span class="co"># to get a spatial data frame with the best fitting circle for each segment</span></span>
<span id="cb211-180"><a href="watershed-segmentation-sensitivity-testing.html#cb211-180" tabindex="-1"></a></span>
<span id="cb211-181"><a href="watershed-segmentation-sensitivity-testing.html#cb211-181" tabindex="-1"></a>    <span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb211-182"><a href="watershed-segmentation-sensitivity-testing.html#cb211-182" tabindex="-1"></a>    watershed_ans_poly_circle_fit <span class="ot">&lt;-</span> <span class="fu">sf_data_circle_fit</span>(watershed_ans_poly)</span>
<span id="cb211-183"><a href="watershed-segmentation-sensitivity-testing.html#cb211-183" tabindex="-1"></a>    </span>
<span id="cb211-184"><a href="watershed-segmentation-sensitivity-testing.html#cb211-184" tabindex="-1"></a>    <span class="co"># filter using the intersection over union (IoU) between the circle and the predicted segment. </span></span>
<span id="cb211-185"><a href="watershed-segmentation-sensitivity-testing.html#cb211-185" tabindex="-1"></a>    <span class="co"># we&#39;ll use the IoU function we defined </span></span>
<span id="cb211-186"><a href="watershed-segmentation-sensitivity-testing.html#cb211-186" tabindex="-1"></a>    <span class="co"># we map over this to only compare the segment to it&#39;s own best circle fit...not all</span></span>
<span id="cb211-187"><a href="watershed-segmentation-sensitivity-testing.html#cb211-187" tabindex="-1"></a>    <span class="co"># we should consider doing this in bulk.....another day</span></span>
<span id="cb211-188"><a href="watershed-segmentation-sensitivity-testing.html#cb211-188" tabindex="-1"></a>    watershed_circle_fit_iou <span class="ot">&lt;-</span> </span>
<span id="cb211-189"><a href="watershed-segmentation-sensitivity-testing.html#cb211-189" tabindex="-1"></a>      watershed_ans_poly<span class="sc">$</span>pred_id <span class="sc">%&gt;%</span> </span>
<span id="cb211-190"><a href="watershed-segmentation-sensitivity-testing.html#cb211-190" tabindex="-1"></a>      <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-191"><a href="watershed-segmentation-sensitivity-testing.html#cb211-191" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb211-192"><a href="watershed-segmentation-sensitivity-testing.html#cb211-192" tabindex="-1"></a>        <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb211-193"><a href="watershed-segmentation-sensitivity-testing.html#cb211-193" tabindex="-1"></a>          <span class="at">gt_inst =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb211-194"><a href="watershed-segmentation-sensitivity-testing.html#cb211-194" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x)</span>
<span id="cb211-195"><a href="watershed-segmentation-sensitivity-testing.html#cb211-195" tabindex="-1"></a>          , <span class="at">gt_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb211-196"><a href="watershed-segmentation-sensitivity-testing.html#cb211-196" tabindex="-1"></a>          , <span class="at">predictions =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb211-197"><a href="watershed-segmentation-sensitivity-testing.html#cb211-197" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb211-198"><a href="watershed-segmentation-sensitivity-testing.html#cb211-198" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb211-199"><a href="watershed-segmentation-sensitivity-testing.html#cb211-199" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_pred_id =</span> pred_id)</span>
<span id="cb211-200"><a href="watershed-segmentation-sensitivity-testing.html#cb211-200" tabindex="-1"></a>          , <span class="at">pred_id =</span> <span class="st">&quot;circ_pred_id&quot;</span></span>
<span id="cb211-201"><a href="watershed-segmentation-sensitivity-testing.html#cb211-201" tabindex="-1"></a>          , <span class="at">min_iou_pct =</span> <span class="dv">0</span> <span class="co"># set to 0 just to return pct</span></span>
<span id="cb211-202"><a href="watershed-segmentation-sensitivity-testing.html#cb211-202" tabindex="-1"></a>        )    </span>
<span id="cb211-203"><a href="watershed-segmentation-sensitivity-testing.html#cb211-203" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb211-204"><a href="watershed-segmentation-sensitivity-testing.html#cb211-204" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb211-205"><a href="watershed-segmentation-sensitivity-testing.html#cb211-205" tabindex="-1"></a>    </span>
<span id="cb211-206"><a href="watershed-segmentation-sensitivity-testing.html#cb211-206" tabindex="-1"></a>    <span class="co"># threshold for the minimum IoU to further filter for segments that are approximately round, </span></span>
<span id="cb211-207"><a href="watershed-segmentation-sensitivity-testing.html#cb211-207" tabindex="-1"></a>    <span class="co"># this filter should remove linear objects from the watershed detections</span></span>
<span id="cb211-208"><a href="watershed-segmentation-sensitivity-testing.html#cb211-208" tabindex="-1"></a>      <span class="co"># compare iou</span></span>
<span id="cb211-209"><a href="watershed-segmentation-sensitivity-testing.html#cb211-209" tabindex="-1"></a>      <span class="cf">if</span>(circle_fit_iou_pct<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb211-210"><a href="watershed-segmentation-sensitivity-testing.html#cb211-210" tabindex="-1"></a>        watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_keep_overlaps_chull_pred_id</span>
<span id="cb211-211"><a href="watershed-segmentation-sensitivity-testing.html#cb211-211" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb211-212"><a href="watershed-segmentation-sensitivity-testing.html#cb211-212" tabindex="-1"></a>        watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb211-213"><a href="watershed-segmentation-sensitivity-testing.html#cb211-213" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(iou<span class="sc">&gt;=</span>circle_fit_iou_pct) <span class="sc">%&gt;%</span> </span>
<span id="cb211-214"><a href="watershed-segmentation-sensitivity-testing.html#cb211-214" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id) </span>
<span id="cb211-215"><a href="watershed-segmentation-sensitivity-testing.html#cb211-215" tabindex="-1"></a>      }</span>
<span id="cb211-216"><a href="watershed-segmentation-sensitivity-testing.html#cb211-216" tabindex="-1"></a>      </span>
<span id="cb211-217"><a href="watershed-segmentation-sensitivity-testing.html#cb211-217" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb211-218"><a href="watershed-segmentation-sensitivity-testing.html#cb211-218" tabindex="-1"></a>      <span class="fu">identical</span>(watershed_keep_circle_fit_pred_id, <span class="fu">numeric</span>(<span class="dv">0</span>))</span>
<span id="cb211-219"><a href="watershed-segmentation-sensitivity-testing.html#cb211-219" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.null</span>(watershed_keep_circle_fit_pred_id))</span>
<span id="cb211-220"><a href="watershed-segmentation-sensitivity-testing.html#cb211-220" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(watershed_keep_circle_fit_pred_id))</span>
<span id="cb211-221"><a href="watershed-segmentation-sensitivity-testing.html#cb211-221" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">length</span>(watershed_keep_circle_fit_pred_id)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb211-222"><a href="watershed-segmentation-sensitivity-testing.html#cb211-222" tabindex="-1"></a>    ){</span>
<span id="cb211-223"><a href="watershed-segmentation-sensitivity-testing.html#cb211-223" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb211-224"><a href="watershed-segmentation-sensitivity-testing.html#cb211-224" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and circularity expectations&quot;</span></span>
<span id="cb211-225"><a href="watershed-segmentation-sensitivity-testing.html#cb211-225" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `circle_fit_iou_pct` &quot;</span></span>
<span id="cb211-226"><a href="watershed-segmentation-sensitivity-testing.html#cb211-226" tabindex="-1"></a>      ))</span>
<span id="cb211-227"><a href="watershed-segmentation-sensitivity-testing.html#cb211-227" tabindex="-1"></a>    }</span>
<span id="cb211-228"><a href="watershed-segmentation-sensitivity-testing.html#cb211-228" tabindex="-1"></a>  </span>
<span id="cb211-229"><a href="watershed-segmentation-sensitivity-testing.html#cb211-229" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-230"><a href="watershed-segmentation-sensitivity-testing.html#cb211-230" tabindex="-1"></a>  <span class="do">## 5) raster smoothing</span></span>
<span id="cb211-231"><a href="watershed-segmentation-sensitivity-testing.html#cb211-231" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-232"><a href="watershed-segmentation-sensitivity-testing.html#cb211-232" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb211-233"><a href="watershed-segmentation-sensitivity-testing.html#cb211-233" tabindex="-1"></a>    <span class="co"># use the remaining segments that meet the geometric and area filtering</span></span>
<span id="cb211-234"><a href="watershed-segmentation-sensitivity-testing.html#cb211-234" tabindex="-1"></a>    <span class="co"># to smooth the watershed raster</span></span>
<span id="cb211-235"><a href="watershed-segmentation-sensitivity-testing.html#cb211-235" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb211-236"><a href="watershed-segmentation-sensitivity-testing.html#cb211-236" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb211-237"><a href="watershed-segmentation-sensitivity-testing.html#cb211-237" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb211-238"><a href="watershed-segmentation-sensitivity-testing.html#cb211-238" tabindex="-1"></a>        watershed_ans_poly <span class="sc">%&gt;%</span> <span class="co">#these are irregularity and area filtered already</span></span>
<span id="cb211-239"><a href="watershed-segmentation-sensitivity-testing.html#cb211-239" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb211-240"><a href="watershed-segmentation-sensitivity-testing.html#cb211-240" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb211-241"><a href="watershed-segmentation-sensitivity-testing.html#cb211-241" tabindex="-1"></a>        , <span class="at">updatevalue=</span><span class="cn">NA</span></span>
<span id="cb211-242"><a href="watershed-segmentation-sensitivity-testing.html#cb211-242" tabindex="-1"></a>      )</span>
<span id="cb211-243"><a href="watershed-segmentation-sensitivity-testing.html#cb211-243" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb211-244"><a href="watershed-segmentation-sensitivity-testing.html#cb211-244" tabindex="-1"></a>      <span class="co"># smooths the raster using the majority value</span></span>
<span id="cb211-245"><a href="watershed-segmentation-sensitivity-testing.html#cb211-245" tabindex="-1"></a>      smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb211-246"><a href="watershed-segmentation-sensitivity-testing.html#cb211-246" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;modal&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co"># only fill NA cells  </span></span>
<span id="cb211-247"><a href="watershed-segmentation-sensitivity-testing.html#cb211-247" tabindex="-1"></a>    }</span>
<span id="cb211-248"><a href="watershed-segmentation-sensitivity-testing.html#cb211-248" tabindex="-1"></a>    </span>
<span id="cb211-249"><a href="watershed-segmentation-sensitivity-testing.html#cb211-249" tabindex="-1"></a>    <span class="fu">names</span>(smooth_watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb211-250"><a href="watershed-segmentation-sensitivity-testing.html#cb211-250" tabindex="-1"></a></span>
<span id="cb211-251"><a href="watershed-segmentation-sensitivity-testing.html#cb211-251" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb211-252"><a href="watershed-segmentation-sensitivity-testing.html#cb211-252" tabindex="-1"></a>    <span class="co"># mask the chm rast to these remaining segments and smooth to match the smoothing for the segments</span></span>
<span id="cb211-253"><a href="watershed-segmentation-sensitivity-testing.html#cb211-253" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb211-254"><a href="watershed-segmentation-sensitivity-testing.html#cb211-254" tabindex="-1"></a>    smooth_chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb211-255"><a href="watershed-segmentation-sensitivity-testing.html#cb211-255" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_watershed_ans)</span>
<span id="cb211-256"><a href="watershed-segmentation-sensitivity-testing.html#cb211-256" tabindex="-1"></a>    </span>
<span id="cb211-257"><a href="watershed-segmentation-sensitivity-testing.html#cb211-257" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb211-258"><a href="watershed-segmentation-sensitivity-testing.html#cb211-258" tabindex="-1"></a>      <span class="co"># smooths the raster to match the smoothing in the watershed segments</span></span>
<span id="cb211-259"><a href="watershed-segmentation-sensitivity-testing.html#cb211-259" tabindex="-1"></a>      smooth_chm_rast <span class="ot">&lt;-</span> smooth_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb211-260"><a href="watershed-segmentation-sensitivity-testing.html#cb211-260" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co">#only for cells that are NA</span></span>
<span id="cb211-261"><a href="watershed-segmentation-sensitivity-testing.html#cb211-261" tabindex="-1"></a>    }</span>
<span id="cb211-262"><a href="watershed-segmentation-sensitivity-testing.html#cb211-262" tabindex="-1"></a></span>
<span id="cb211-263"><a href="watershed-segmentation-sensitivity-testing.html#cb211-263" tabindex="-1"></a>    <span class="co"># now mask the watershed_ans raster to only keep cells that are in the originating CHM</span></span>
<span id="cb211-264"><a href="watershed-segmentation-sensitivity-testing.html#cb211-264" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb211-265"><a href="watershed-segmentation-sensitivity-testing.html#cb211-265" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_chm_rast)</span>
<span id="cb211-266"><a href="watershed-segmentation-sensitivity-testing.html#cb211-266" tabindex="-1"></a></span>
<span id="cb211-267"><a href="watershed-segmentation-sensitivity-testing.html#cb211-267" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-268"><a href="watershed-segmentation-sensitivity-testing.html#cb211-268" tabindex="-1"></a>  <span class="do">## calculate raster-based area and volume </span></span>
<span id="cb211-269"><a href="watershed-segmentation-sensitivity-testing.html#cb211-269" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-270"><a href="watershed-segmentation-sensitivity-testing.html#cb211-270" tabindex="-1"></a>    <span class="co"># first, calculate the area of each cell</span></span>
<span id="cb211-271"><a href="watershed-segmentation-sensitivity-testing.html#cb211-271" tabindex="-1"></a>    area_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(smooth_chm_rast)</span>
<span id="cb211-272"><a href="watershed-segmentation-sensitivity-testing.html#cb211-272" tabindex="-1"></a>    <span class="fu">names</span>(area_rast) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb211-273"><a href="watershed-segmentation-sensitivity-testing.html#cb211-273" tabindex="-1"></a>    <span class="co"># area_rast %&gt;% terra::plot()</span></span>
<span id="cb211-274"><a href="watershed-segmentation-sensitivity-testing.html#cb211-274" tabindex="-1"></a>    <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb211-275"><a href="watershed-segmentation-sensitivity-testing.html#cb211-275" tabindex="-1"></a>    vol_rast <span class="ot">&lt;-</span> area_rast<span class="sc">*</span>smooth_chm_rast</span>
<span id="cb211-276"><a href="watershed-segmentation-sensitivity-testing.html#cb211-276" tabindex="-1"></a>    <span class="fu">names</span>(vol_rast) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb211-277"><a href="watershed-segmentation-sensitivity-testing.html#cb211-277" tabindex="-1"></a>    <span class="co"># vol_rast %&gt;% terra::plot()</span></span>
<span id="cb211-278"><a href="watershed-segmentation-sensitivity-testing.html#cb211-278" tabindex="-1"></a>    <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb211-279"><a href="watershed-segmentation-sensitivity-testing.html#cb211-279" tabindex="-1"></a>    area_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> area_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb211-280"><a href="watershed-segmentation-sensitivity-testing.html#cb211-280" tabindex="-1"></a>    <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb211-281"><a href="watershed-segmentation-sensitivity-testing.html#cb211-281" tabindex="-1"></a>    vol_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> vol_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb211-282"><a href="watershed-segmentation-sensitivity-testing.html#cb211-282" tabindex="-1"></a>    <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb211-283"><a href="watershed-segmentation-sensitivity-testing.html#cb211-283" tabindex="-1"></a>    ht_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> smooth_chm_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb211-284"><a href="watershed-segmentation-sensitivity-testing.html#cb211-284" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">max_height_m=</span><span class="dv">2</span>)</span>
<span id="cb211-285"><a href="watershed-segmentation-sensitivity-testing.html#cb211-285" tabindex="-1"></a>      </span>
<span id="cb211-286"><a href="watershed-segmentation-sensitivity-testing.html#cb211-286" tabindex="-1"></a>    <span class="co"># let&#39;s convert the smoothed and filtered watershed-detected segments from raster to vector data </span></span>
<span id="cb211-287"><a href="watershed-segmentation-sensitivity-testing.html#cb211-287" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb211-288"><a href="watershed-segmentation-sensitivity-testing.html#cb211-288" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb211-289"><a href="watershed-segmentation-sensitivity-testing.html#cb211-289" tabindex="-1"></a>      smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb211-290"><a href="watershed-segmentation-sensitivity-testing.html#cb211-290" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb211-291"><a href="watershed-segmentation-sensitivity-testing.html#cb211-291" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-292"><a href="watershed-segmentation-sensitivity-testing.html#cb211-292" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-293"><a href="watershed-segmentation-sensitivity-testing.html#cb211-293" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-294"><a href="watershed-segmentation-sensitivity-testing.html#cb211-294" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb211-295"><a href="watershed-segmentation-sensitivity-testing.html#cb211-295" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb211-296"><a href="watershed-segmentation-sensitivity-testing.html#cb211-296" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-297"><a href="watershed-segmentation-sensitivity-testing.html#cb211-297" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb211-298"><a href="watershed-segmentation-sensitivity-testing.html#cb211-298" tabindex="-1"></a></span>
<span id="cb211-299"><a href="watershed-segmentation-sensitivity-testing.html#cb211-299" tabindex="-1"></a>    <span class="co"># add area and volume to our vector data  </span></span>
<span id="cb211-300"><a href="watershed-segmentation-sensitivity-testing.html#cb211-300" tabindex="-1"></a>    <span class="co"># we&#39;ll do this with a slick trick to perform multiple joins succinctly using purrr::reduce</span></span>
<span id="cb211-301"><a href="watershed-segmentation-sensitivity-testing.html#cb211-301" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb211-302"><a href="watershed-segmentation-sensitivity-testing.html#cb211-302" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">reduce</span>(</span>
<span id="cb211-303"><a href="watershed-segmentation-sensitivity-testing.html#cb211-303" tabindex="-1"></a>        <span class="fu">list</span>(watershed_ans_poly, area_df, vol_df, ht_df)</span>
<span id="cb211-304"><a href="watershed-segmentation-sensitivity-testing.html#cb211-304" tabindex="-1"></a>        , dplyr<span class="sc">::</span>left_join</span>
<span id="cb211-305"><a href="watershed-segmentation-sensitivity-testing.html#cb211-305" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&#39;pred_id&#39;</span></span>
<span id="cb211-306"><a href="watershed-segmentation-sensitivity-testing.html#cb211-306" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb211-307"><a href="watershed-segmentation-sensitivity-testing.html#cb211-307" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb211-308"><a href="watershed-segmentation-sensitivity-testing.html#cb211-308" tabindex="-1"></a>        <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb211-309"><a href="watershed-segmentation-sensitivity-testing.html#cb211-309" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb211-310"><a href="watershed-segmentation-sensitivity-testing.html#cb211-310" tabindex="-1"></a>      <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb211-311"><a href="watershed-segmentation-sensitivity-testing.html#cb211-311" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb211-312"><a href="watershed-segmentation-sensitivity-testing.html#cb211-312" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb211-313"><a href="watershed-segmentation-sensitivity-testing.html#cb211-313" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb211-314"><a href="watershed-segmentation-sensitivity-testing.html#cb211-314" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb211-315"><a href="watershed-segmentation-sensitivity-testing.html#cb211-315" tabindex="-1"></a>      <span class="co"># do one more pass of the irregularity filtering</span></span>
<span id="cb211-316"><a href="watershed-segmentation-sensitivity-testing.html#cb211-316" tabindex="-1"></a>      <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> convexity_pct)</span>
<span id="cb211-317"><a href="watershed-segmentation-sensitivity-testing.html#cb211-317" tabindex="-1"></a>      </span>
<span id="cb211-318"><a href="watershed-segmentation-sensitivity-testing.html#cb211-318" tabindex="-1"></a>      <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb211-319"><a href="watershed-segmentation-sensitivity-testing.html#cb211-319" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb211-320"><a href="watershed-segmentation-sensitivity-testing.html#cb211-320" tabindex="-1"></a>          <span class="st">&quot;no segments detected using the given CHM and expected size thresholds&quot;</span></span>
<span id="cb211-321"><a href="watershed-segmentation-sensitivity-testing.html#cb211-321" tabindex="-1"></a>          , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `max_ht_m`, `min_area_m2`, `max_area_m2` &quot;</span></span>
<span id="cb211-322"><a href="watershed-segmentation-sensitivity-testing.html#cb211-322" tabindex="-1"></a>        ))</span>
<span id="cb211-323"><a href="watershed-segmentation-sensitivity-testing.html#cb211-323" tabindex="-1"></a>      }</span>
<span id="cb211-324"><a href="watershed-segmentation-sensitivity-testing.html#cb211-324" tabindex="-1"></a>   </span>
<span id="cb211-325"><a href="watershed-segmentation-sensitivity-testing.html#cb211-325" tabindex="-1"></a></span>
<span id="cb211-326"><a href="watershed-segmentation-sensitivity-testing.html#cb211-326" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-327"><a href="watershed-segmentation-sensitivity-testing.html#cb211-327" tabindex="-1"></a>  <span class="do">## 4) shape refinement &amp; overlap removal</span></span>
<span id="cb211-328"><a href="watershed-segmentation-sensitivity-testing.html#cb211-328" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb211-329"><a href="watershed-segmentation-sensitivity-testing.html#cb211-329" tabindex="-1"></a>    <span class="co"># use the convex hull shapes of our remaining segments. </span></span>
<span id="cb211-330"><a href="watershed-segmentation-sensitivity-testing.html#cb211-330" tabindex="-1"></a>    <span class="co"># This helps to smooth out the often &#39;blocky&#39; edges of raster-based segments</span></span>
<span id="cb211-331"><a href="watershed-segmentation-sensitivity-testing.html#cb211-331" tabindex="-1"></a>    <span class="co"># , which can look like they were generated in Minecraft. </span></span>
<span id="cb211-332"><a href="watershed-segmentation-sensitivity-testing.html#cb211-332" tabindex="-1"></a>    <span class="co"># Additionally, by removing any segments with overlapping convex hull shapes, </span></span>
<span id="cb211-333"><a href="watershed-segmentation-sensitivity-testing.html#cb211-333" tabindex="-1"></a>    <span class="co"># we can likely reduce false detections that are actually groups of small trees or shrubs, </span></span>
<span id="cb211-334"><a href="watershed-segmentation-sensitivity-testing.html#cb211-334" tabindex="-1"></a>    <span class="co"># ensuring our results represent singular slash piles.</span></span>
<span id="cb211-335"><a href="watershed-segmentation-sensitivity-testing.html#cb211-335" tabindex="-1"></a>    </span>
<span id="cb211-336"><a href="watershed-segmentation-sensitivity-testing.html#cb211-336" tabindex="-1"></a>    <span class="cf">if</span>(smooth_segs){</span>
<span id="cb211-337"><a href="watershed-segmentation-sensitivity-testing.html#cb211-337" tabindex="-1"></a>      return_dta <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb211-338"><a href="watershed-segmentation-sensitivity-testing.html#cb211-338" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-339"><a href="watershed-segmentation-sensitivity-testing.html#cb211-339" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-340"><a href="watershed-segmentation-sensitivity-testing.html#cb211-340" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-341"><a href="watershed-segmentation-sensitivity-testing.html#cb211-341" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb211-342"><a href="watershed-segmentation-sensitivity-testing.html#cb211-342" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb211-343"><a href="watershed-segmentation-sensitivity-testing.html#cb211-343" tabindex="-1"></a>        <span class="fu">st_remove_overlaps</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb211-344"><a href="watershed-segmentation-sensitivity-testing.html#cb211-344" tabindex="-1"></a>        <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb211-345"><a href="watershed-segmentation-sensitivity-testing.html#cb211-345" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb211-346"><a href="watershed-segmentation-sensitivity-testing.html#cb211-346" tabindex="-1"></a>          <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb211-347"><a href="watershed-segmentation-sensitivity-testing.html#cb211-347" tabindex="-1"></a>          , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb211-348"><a href="watershed-segmentation-sensitivity-testing.html#cb211-348" tabindex="-1"></a>        )</span>
<span id="cb211-349"><a href="watershed-segmentation-sensitivity-testing.html#cb211-349" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb211-350"><a href="watershed-segmentation-sensitivity-testing.html#cb211-350" tabindex="-1"></a>      return_dta <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb211-351"><a href="watershed-segmentation-sensitivity-testing.html#cb211-351" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id)</span>
<span id="cb211-352"><a href="watershed-segmentation-sensitivity-testing.html#cb211-352" tabindex="-1"></a>    }</span>
<span id="cb211-353"><a href="watershed-segmentation-sensitivity-testing.html#cb211-353" tabindex="-1"></a>    </span>
<span id="cb211-354"><a href="watershed-segmentation-sensitivity-testing.html#cb211-354" tabindex="-1"></a>    <span class="co"># calculate diameter</span></span>
<span id="cb211-355"><a href="watershed-segmentation-sensitivity-testing.html#cb211-355" tabindex="-1"></a>    return_dta <span class="ot">&lt;-</span> return_dta <span class="sc">%&gt;%</span> </span>
<span id="cb211-356"><a href="watershed-segmentation-sensitivity-testing.html#cb211-356" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-357"><a href="watershed-segmentation-sensitivity-testing.html#cb211-357" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb211-358"><a href="watershed-segmentation-sensitivity-testing.html#cb211-358" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diameter_m =</span> <span class="fu">st_calculate_diameter</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb211-359"><a href="watershed-segmentation-sensitivity-testing.html#cb211-359" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb211-360"><a href="watershed-segmentation-sensitivity-testing.html#cb211-360" tabindex="-1"></a>      </span>
<span id="cb211-361"><a href="watershed-segmentation-sensitivity-testing.html#cb211-361" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb211-362"><a href="watershed-segmentation-sensitivity-testing.html#cb211-362" tabindex="-1"></a>    <span class="fu">return</span>(return_dta)</span>
<span id="cb211-363"><a href="watershed-segmentation-sensitivity-testing.html#cb211-363" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s test this real quick</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="watershed-segmentation-sensitivity-testing.html#cb212-1" tabindex="-1"></a>chm_temp <span class="ot">&lt;-</span> </span>
<span id="cb212-2"><a href="watershed-segmentation-sensitivity-testing.html#cb212-2" tabindex="-1"></a>  cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb212-3"><a href="watershed-segmentation-sensitivity-testing.html#cb212-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb212-4"><a href="watershed-segmentation-sensitivity-testing.html#cb212-4" tabindex="-1"></a>    slash_piles_points <span class="sc">%&gt;%</span> </span>
<span id="cb212-5"><a href="watershed-segmentation-sensitivity-testing.html#cb212-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_zm</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb212-6"><a href="watershed-segmentation-sensitivity-testing.html#cb212-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb212-7"><a href="watershed-segmentation-sensitivity-testing.html#cb212-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb212-8"><a href="watershed-segmentation-sensitivity-testing.html#cb212-8" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb212-9"><a href="watershed-segmentation-sensitivity-testing.html#cb212-9" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb212-10"><a href="watershed-segmentation-sensitivity-testing.html#cb212-10" tabindex="-1"></a>  )</span>
<span id="cb212-11"><a href="watershed-segmentation-sensitivity-testing.html#cb212-11" tabindex="-1"></a><span class="co"># terra::plot(chm_temp)</span></span>
<span id="cb212-12"><a href="watershed-segmentation-sensitivity-testing.html#cb212-12" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="ot">&lt;-</span> <span class="fu">slash_pile_detect_watershed</span>(chm_temp)</span>
<span id="cb212-13"><a href="watershed-segmentation-sensitivity-testing.html#cb212-13" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb212-14"><a href="watershed-segmentation-sensitivity-testing.html#cb212-14" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 67
## Columns: 8
## $ pred_id         &lt;dbl&gt; 9, 31, 40, 43, 71, 99, 145, 203, 206, 224, 244, 271, 2…
## $ area_m2         &lt;dbl&gt; 22.58, 5.22, 3.06, 2.28, 18.80, 5.20, 2.74, 3.48, 39.4…
## $ volume_m3       &lt;dbl&gt; 28.568242, 14.148823, 8.023260, 6.757049, 27.944571, 1…
## $ max_height_m    &lt;dbl&gt; 3.994792, 3.963911, 3.961000, 3.960000, 3.921000, 3.86…
## $ volume_per_area &lt;dbl&gt; 1.2652011, 2.7105025, 2.6219804, 2.9636182, 1.4864134,…
## $ pct_chull       &lt;dbl&gt; 0.8520815, 0.7969349, 0.8104575, 0.8947368, 0.8021277,…
## $ geometry        &lt;POLYGON [m]&gt; POLYGON ((499564 4317834, 4..., POLYGON ((4994…
## $ diameter_m      &lt;dbl&gt; 6.280127, 3.538361, 2.505993, 2.236068, 6.082763, 2.88…</code></pre>
<p>how does it look overlaid on the CHM?</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="watershed-segmentation-sensitivity-testing.html#cb214-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(chm_temp, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span>
<span id="cb214-2"><a href="watershed-segmentation-sensitivity-testing.html#cb214-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>(),<span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-179-1.png" width="1008" /></p>
<p>how do the area and volume metrics look?</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="watershed-segmentation-sensitivity-testing.html#cb215-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb215-2"><a href="watershed-segmentation-sensitivity-testing.html#cb215-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb215-3"><a href="watershed-segmentation-sensitivity-testing.html#cb215-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> area_m2)) <span class="sc">+</span></span>
<span id="cb215-4"><a href="watershed-segmentation-sensitivity-testing.html#cb215-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Blues&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb215-5"><a href="watershed-segmentation-sensitivity-testing.html#cb215-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb215-6"><a href="watershed-segmentation-sensitivity-testing.html#cb215-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb215-7"><a href="watershed-segmentation-sensitivity-testing.html#cb215-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb215-8"><a href="watershed-segmentation-sensitivity-testing.html#cb215-8" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb215-9"><a href="watershed-segmentation-sensitivity-testing.html#cb215-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb215-10"><a href="watershed-segmentation-sensitivity-testing.html#cb215-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> volume_m3)) <span class="sc">+</span></span>
<span id="cb215-11"><a href="watershed-segmentation-sensitivity-testing.html#cb215-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;BuGn&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb215-12"><a href="watershed-segmentation-sensitivity-testing.html#cb215-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb215-13"><a href="watershed-segmentation-sensitivity-testing.html#cb215-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb215-14"><a href="watershed-segmentation-sensitivity-testing.html#cb215-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb215-15"><a href="watershed-segmentation-sensitivity-testing.html#cb215-15" tabindex="-1"></a>p3_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb215-16"><a href="watershed-segmentation-sensitivity-testing.html#cb215-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb215-17"><a href="watershed-segmentation-sensitivity-testing.html#cb215-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> max_height_m)) <span class="sc">+</span></span>
<span id="cb215-18"><a href="watershed-segmentation-sensitivity-testing.html#cb215-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;YlOrBr&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb215-19"><a href="watershed-segmentation-sensitivity-testing.html#cb215-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb215-20"><a href="watershed-segmentation-sensitivity-testing.html#cb215-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb215-21"><a href="watershed-segmentation-sensitivity-testing.html#cb215-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb215-22"><a href="watershed-segmentation-sensitivity-testing.html#cb215-22" tabindex="-1"></a>p4_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb215-23"><a href="watershed-segmentation-sensitivity-testing.html#cb215-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb215-24"><a href="watershed-segmentation-sensitivity-testing.html#cb215-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> diameter_m)) <span class="sc">+</span></span>
<span id="cb215-25"><a href="watershed-segmentation-sensitivity-testing.html#cb215-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;PuRd&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb215-26"><a href="watershed-segmentation-sensitivity-testing.html#cb215-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb215-27"><a href="watershed-segmentation-sensitivity-testing.html#cb215-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb215-28"><a href="watershed-segmentation-sensitivity-testing.html#cb215-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb215-29"><a href="watershed-segmentation-sensitivity-testing.html#cb215-29" tabindex="-1"></a>(p1_temp <span class="sc">+</span> p2_temp) <span class="sc">/</span> (p3_temp <span class="sc">+</span> p4_temp)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-180-1.png" width="1008" /></p>
<p>the volume per area ratio (<code>volume_per_area</code>) quantifies the “effective” height or depth of that volume relative to the area it occupies; this ratio may not be very useful for anything other than scaling estimates to relate a three-dimensional quantity (volume) to a two-dimensional quantity (area)</p>
</div>
<div id="wshed_params_test" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Parameter sensitivity testing<a href="watershed-segmentation-sensitivity-testing.html#wshed_params_test" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Parameter sensitivity testing is a systematic process of evaluating how changes to the specific thresholds and settings within the detection methodology impact the final results. Since the method doesn’t use training data, its performance is highly dependent on these manually defined parameters. The objective of this testing is to understand the robustness of the method and identify the optimal combination of settings that yield the best detection performance, balancing factors like detection rate (recall) and accuracy of positive predictions (precision).</p>
<p>Here are the general steps to accomplish this testing:</p>
<ul>
<li><em>Define Parameter Ranges and Increments</em>: For each identified parameter, determine a reasonable range of values to test and the step size for incrementing through that range. For example, if a threshold is currently 0.5, you might test from 0.3 to 0.7 in increments of 0.05.</li>
<li><em>Automate the Detection Workflow</em>: Create a script or automated process that can run your entire rules-based slash pile detection method using different combinations of these parameter values.</li>
<li><em>Execute Tests</em>: Run the automated workflow for each defined parameter combination.</li>
<li><em>Collect Performance Metrics</em>: For every run, calculate the key performance metrics against your image-annotated validation data (e.g. recall, precision, F-score)</li>
<li><em>Analyze and Visualize Results</em>: Plot the performance metrics against the varying parameter values or combinations. This will help you visualize trends, identify sweet spots where performance is maximized, and understand trade-offs (e.g., increasing recall might decrease precision).</li>
<li><em>Select Optimal Parameters</em>: Based on the analysis and the specific goals of the project (e.g., minimizing false negatives for safety, or maximizing overall accuracy), select the parameter set that provides the most desirable performance. This might involve choosing a balance between precision and recall, or prioritizing one over the other.</li>
</ul>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="watershed-segmentation-sensitivity-testing.html#cb216-1" tabindex="-1"></a>param_combos_df <span class="ot">&lt;-</span></span>
<span id="cb216-2"><a href="watershed-segmentation-sensitivity-testing.html#cb216-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">crossing</span>(</span>
<span id="cb216-3"><a href="watershed-segmentation-sensitivity-testing.html#cb216-3" tabindex="-1"></a>    <span class="at">max_ht_m =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2</span>, <span class="at">to =</span>  <span class="dv">5</span>, <span class="at">by =</span> <span class="dv">1</span>) <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb216-4"><a href="watershed-segmentation-sensitivity-testing.html#cb216-4" tabindex="-1"></a>    , <span class="at">min_area_m2 =</span> <span class="fu">c</span>(<span class="dv">2</span>) <span class="co"># seq(from = 1, to =  2, by = 1) # set the min expected pile area</span></span>
<span id="cb216-5"><a href="watershed-segmentation-sensitivity-testing.html#cb216-5" tabindex="-1"></a>    , <span class="at">max_area_m2 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">10</span>, <span class="at">to =</span>  <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">10</span>) <span class="co"># set the max expected pile area</span></span>
<span id="cb216-6"><a href="watershed-segmentation-sensitivity-testing.html#cb216-6" tabindex="-1"></a>    , <span class="at">convexity_pct =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.3</span>, <span class="at">to =</span>  <span class="fl">0.8</span>, <span class="at">by =</span> <span class="fl">0.1</span>) <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb216-7"><a href="watershed-segmentation-sensitivity-testing.html#cb216-7" tabindex="-1"></a>    , <span class="at">circle_fit_iou_pct =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.3</span>, <span class="at">to =</span> <span class="fl">0.8</span>, <span class="at">by =</span> <span class="fl">0.1</span>) </span>
<span id="cb216-8"><a href="watershed-segmentation-sensitivity-testing.html#cb216-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb216-9"><a href="watershed-segmentation-sensitivity-testing.html#cb216-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb216-10"><a href="watershed-segmentation-sensitivity-testing.html#cb216-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(rn)</span>
<span id="cb216-11"><a href="watershed-segmentation-sensitivity-testing.html#cb216-11" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb216-12"><a href="watershed-segmentation-sensitivity-testing.html#cb216-12" tabindex="-1"></a>param_combos_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,440
## Columns: 6
## $ rn                 &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, …
## $ max_ht_m           &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ min_area_m2        &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ max_area_m2        &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,…
## $ convexity_pct      &lt;dbl&gt; 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.4, 0.4, 0.4, 0.4, 0…
## $ circle_fit_iou_pct &lt;dbl&gt; 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.3, 0.4, 0.5, 0.6, 0…</code></pre>
<p>that might be too many combinations but we’ll give it a shot</p>
<div id="all_the_combos" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Workflow over parameter combinations<a href="watershed-segmentation-sensitivity-testing.html#all_the_combos" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>to automate the detection workflow we can simply map these combinations over our <code>slash_pile_detect_watershed()</code> function. however, that would result in us running the same watershed segmentation process repeatedly with the same settings. as such, let’s make a function to efficiently perform the detection workflow using the same watershed segmentation and circle fitting for use with the different filtering combinations.</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="watershed-segmentation-sensitivity-testing.html#cb218-1" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb218-2"><a href="watershed-segmentation-sensitivity-testing.html#cb218-2" tabindex="-1"></a><span class="co"># 1)</span></span>
<span id="cb218-3"><a href="watershed-segmentation-sensitivity-testing.html#cb218-3" tabindex="-1"></a><span class="co"># function to apply watershed seg over a list of max_ht_m</span></span>
<span id="cb218-4"><a href="watershed-segmentation-sensitivity-testing.html#cb218-4" tabindex="-1"></a><span class="co"># function to apply watershed segmentation over a list of different maximum height threshold (`max_ht_m`) which determines the &quot;slice&quot; of the CHM to use</span></span>
<span id="cb218-5"><a href="watershed-segmentation-sensitivity-testing.html#cb218-5" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb218-6"><a href="watershed-segmentation-sensitivity-testing.html#cb218-6" tabindex="-1"></a>chm_watershed_seg_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(chm_rast,max_ht_m) {</span>
<span id="cb218-7"><a href="watershed-segmentation-sensitivity-testing.html#cb218-7" tabindex="-1"></a>  <span class="co"># get unique hts</span></span>
<span id="cb218-8"><a href="watershed-segmentation-sensitivity-testing.html#cb218-8" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.numeric</span>(max_ht_m))</span>
<span id="cb218-9"><a href="watershed-segmentation-sensitivity-testing.html#cb218-9" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> max_ht_m[<span class="sc">!</span><span class="fu">is.na</span>(max_ht_m)]</span>
<span id="cb218-10"><a href="watershed-segmentation-sensitivity-testing.html#cb218-10" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb218-11"><a href="watershed-segmentation-sensitivity-testing.html#cb218-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">length</span>(max_ht_m),<span class="dv">0</span>)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb218-12"><a href="watershed-segmentation-sensitivity-testing.html#cb218-12" tabindex="-1"></a>  ){<span class="fu">stop</span>(<span class="st">&quot;could not detect `max_ht_m` parameter setting which should be numeric list&quot;</span>)}</span>
<span id="cb218-13"><a href="watershed-segmentation-sensitivity-testing.html#cb218-13" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb218-14"><a href="watershed-segmentation-sensitivity-testing.html#cb218-14" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb218-15"><a href="watershed-segmentation-sensitivity-testing.html#cb218-15" tabindex="-1"></a>  <span class="co"># just get the first layer</span></span>
<span id="cb218-16"><a href="watershed-segmentation-sensitivity-testing.html#cb218-16" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>)</span>
<span id="cb218-17"><a href="watershed-segmentation-sensitivity-testing.html#cb218-17" tabindex="-1"></a>  <span class="co"># # first, calculate the area of each cell</span></span>
<span id="cb218-18"><a href="watershed-segmentation-sensitivity-testing.html#cb218-18" tabindex="-1"></a>  <span class="co"># area_rast &lt;- terra::cellSize(chm_rast)</span></span>
<span id="cb218-19"><a href="watershed-segmentation-sensitivity-testing.html#cb218-19" tabindex="-1"></a>  <span class="co"># names(area_rast) &lt;- &quot;area_m2&quot;</span></span>
<span id="cb218-20"><a href="watershed-segmentation-sensitivity-testing.html#cb218-20" tabindex="-1"></a>  </span>
<span id="cb218-21"><a href="watershed-segmentation-sensitivity-testing.html#cb218-21" tabindex="-1"></a>  <span class="co"># map over the max_ht_m to get the raster slice</span></span>
<span id="cb218-22"><a href="watershed-segmentation-sensitivity-testing.html#cb218-22" tabindex="-1"></a>  chm_ret_rast <span class="ot">&lt;-</span> max_ht_m <span class="sc">%&gt;%</span> </span>
<span id="cb218-23"><a href="watershed-segmentation-sensitivity-testing.html#cb218-23" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb218-24"><a href="watershed-segmentation-sensitivity-testing.html#cb218-24" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">clamp</span>(chm_rast, <span class="at">upper =</span> x, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb218-25"><a href="watershed-segmentation-sensitivity-testing.html#cb218-25" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-26"><a href="watershed-segmentation-sensitivity-testing.html#cb218-26" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb218-27"><a href="watershed-segmentation-sensitivity-testing.html#cb218-27" tabindex="-1"></a>  <span class="co"># name</span></span>
<span id="cb218-28"><a href="watershed-segmentation-sensitivity-testing.html#cb218-28" tabindex="-1"></a>  <span class="fu">names</span>(chm_ret_rast) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(max_ht_m)</span>
<span id="cb218-29"><a href="watershed-segmentation-sensitivity-testing.html#cb218-29" tabindex="-1"></a>  </span>
<span id="cb218-30"><a href="watershed-segmentation-sensitivity-testing.html#cb218-30" tabindex="-1"></a>  <span class="co"># chm_ret_rast</span></span>
<span id="cb218-31"><a href="watershed-segmentation-sensitivity-testing.html#cb218-31" tabindex="-1"></a>  <span class="co"># chm_ret_rast %&gt;% terra::subset(1) %&gt;% terra::plot()</span></span>
<span id="cb218-32"><a href="watershed-segmentation-sensitivity-testing.html#cb218-32" tabindex="-1"></a>  <span class="co"># chm_ret_rast %&gt;% terra::subset(2) %&gt;% terra::plot()</span></span>
<span id="cb218-33"><a href="watershed-segmentation-sensitivity-testing.html#cb218-33" tabindex="-1"></a>  <span class="co"># chm_rast[[1]]</span></span>
<span id="cb218-34"><a href="watershed-segmentation-sensitivity-testing.html#cb218-34" tabindex="-1"></a>  </span>
<span id="cb218-35"><a href="watershed-segmentation-sensitivity-testing.html#cb218-35" tabindex="-1"></a>  <span class="co"># # map over the volume</span></span>
<span id="cb218-36"><a href="watershed-segmentation-sensitivity-testing.html#cb218-36" tabindex="-1"></a>  <span class="co"># # then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb218-37"><a href="watershed-segmentation-sensitivity-testing.html#cb218-37" tabindex="-1"></a>  <span class="co"># vol_ret_rast &lt;- </span></span>
<span id="cb218-38"><a href="watershed-segmentation-sensitivity-testing.html#cb218-38" tabindex="-1"></a>  <span class="co">#   1:terra::nlyr(chm_ret_rast) %&gt;% </span></span>
<span id="cb218-39"><a href="watershed-segmentation-sensitivity-testing.html#cb218-39" tabindex="-1"></a>  <span class="co">#   purrr::map(function(x){</span></span>
<span id="cb218-40"><a href="watershed-segmentation-sensitivity-testing.html#cb218-40" tabindex="-1"></a>  <span class="co">#     vol_rast &lt;- area_rast*chm_ret_rast[[x]]</span></span>
<span id="cb218-41"><a href="watershed-segmentation-sensitivity-testing.html#cb218-41" tabindex="-1"></a>  <span class="co">#     names(vol_rast) &lt;- &quot;volume_m3&quot;</span></span>
<span id="cb218-42"><a href="watershed-segmentation-sensitivity-testing.html#cb218-42" tabindex="-1"></a>  <span class="co">#     return(vol_rast)</span></span>
<span id="cb218-43"><a href="watershed-segmentation-sensitivity-testing.html#cb218-43" tabindex="-1"></a>  <span class="co">#   }) %&gt;% </span></span>
<span id="cb218-44"><a href="watershed-segmentation-sensitivity-testing.html#cb218-44" tabindex="-1"></a>  <span class="co">#   terra::rast()</span></span>
<span id="cb218-45"><a href="watershed-segmentation-sensitivity-testing.html#cb218-45" tabindex="-1"></a>  <span class="co"># # name</span></span>
<span id="cb218-46"><a href="watershed-segmentation-sensitivity-testing.html#cb218-46" tabindex="-1"></a>  <span class="co"># names(vol_ret_rast) &lt;- as.character(max_ht_m)</span></span>
<span id="cb218-47"><a href="watershed-segmentation-sensitivity-testing.html#cb218-47" tabindex="-1"></a>  </span>
<span id="cb218-48"><a href="watershed-segmentation-sensitivity-testing.html#cb218-48" tabindex="-1"></a>  <span class="co"># map over the watershed</span></span>
<span id="cb218-49"><a href="watershed-segmentation-sensitivity-testing.html#cb218-49" tabindex="-1"></a>  <span class="co"># let&#39;s run watershed segmentation using `lidR::watershed()` which is based on the bioconductor package `EBIimage`</span></span>
<span id="cb218-50"><a href="watershed-segmentation-sensitivity-testing.html#cb218-50" tabindex="-1"></a>  <span class="co"># return is a raster with the first layer representing the identified watershed segments</span></span>
<span id="cb218-51"><a href="watershed-segmentation-sensitivity-testing.html#cb218-51" tabindex="-1"></a>  ret_rast <span class="ot">&lt;-</span> </span>
<span id="cb218-52"><a href="watershed-segmentation-sensitivity-testing.html#cb218-52" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(chm_ret_rast) <span class="sc">%&gt;%</span> </span>
<span id="cb218-53"><a href="watershed-segmentation-sensitivity-testing.html#cb218-53" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb218-54"><a href="watershed-segmentation-sensitivity-testing.html#cb218-54" tabindex="-1"></a>      lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb218-55"><a href="watershed-segmentation-sensitivity-testing.html#cb218-55" tabindex="-1"></a>        <span class="at">chm =</span> chm_ret_rast[[x]]</span>
<span id="cb218-56"><a href="watershed-segmentation-sensitivity-testing.html#cb218-56" tabindex="-1"></a>        , <span class="at">th_tree =</span> <span class="fl">0.5</span> <span class="co"># this would be the minimum expected pile height</span></span>
<span id="cb218-57"><a href="watershed-segmentation-sensitivity-testing.html#cb218-57" tabindex="-1"></a>      )()</span>
<span id="cb218-58"><a href="watershed-segmentation-sensitivity-testing.html#cb218-58" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-59"><a href="watershed-segmentation-sensitivity-testing.html#cb218-59" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb218-60"><a href="watershed-segmentation-sensitivity-testing.html#cb218-60" tabindex="-1"></a>  <span class="co"># name</span></span>
<span id="cb218-61"><a href="watershed-segmentation-sensitivity-testing.html#cb218-61" tabindex="-1"></a>  <span class="fu">names</span>(ret_rast) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(max_ht_m)</span>
<span id="cb218-62"><a href="watershed-segmentation-sensitivity-testing.html#cb218-62" tabindex="-1"></a>  </span>
<span id="cb218-63"><a href="watershed-segmentation-sensitivity-testing.html#cb218-63" tabindex="-1"></a>  <span class="co"># ret_rast</span></span>
<span id="cb218-64"><a href="watershed-segmentation-sensitivity-testing.html#cb218-64" tabindex="-1"></a>  <span class="co"># ret_rast %&gt;% terra::subset(1) %&gt;% terra::as.factor() %&gt;% terra::plot()</span></span>
<span id="cb218-65"><a href="watershed-segmentation-sensitivity-testing.html#cb218-65" tabindex="-1"></a>  <span class="co"># ret_rast %&gt;% terra::subset(2) %&gt;% terra::as.factor() %&gt;% terra::plot()</span></span>
<span id="cb218-66"><a href="watershed-segmentation-sensitivity-testing.html#cb218-66" tabindex="-1"></a>  </span>
<span id="cb218-67"><a href="watershed-segmentation-sensitivity-testing.html#cb218-67" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb218-68"><a href="watershed-segmentation-sensitivity-testing.html#cb218-68" tabindex="-1"></a>    <span class="at">chm_rast =</span> chm_ret_rast <span class="co"># length = length(max_ht_m)</span></span>
<span id="cb218-69"><a href="watershed-segmentation-sensitivity-testing.html#cb218-69" tabindex="-1"></a>    <span class="co"># , area_rast = area_rast # length = 1</span></span>
<span id="cb218-70"><a href="watershed-segmentation-sensitivity-testing.html#cb218-70" tabindex="-1"></a>    <span class="co"># , volume_rast = vol_ret_rast # length = length(max_ht_m)</span></span>
<span id="cb218-71"><a href="watershed-segmentation-sensitivity-testing.html#cb218-71" tabindex="-1"></a>    , <span class="at">watershed_rast =</span> ret_rast <span class="co"># length = length(max_ht_m)</span></span>
<span id="cb218-72"><a href="watershed-segmentation-sensitivity-testing.html#cb218-72" tabindex="-1"></a>  ))</span>
<span id="cb218-73"><a href="watershed-segmentation-sensitivity-testing.html#cb218-73" tabindex="-1"></a>}</span>
<span id="cb218-74"><a href="watershed-segmentation-sensitivity-testing.html#cb218-74" tabindex="-1"></a><span class="co"># xxx &lt;- chm_watershed_seg_fn(</span></span>
<span id="cb218-75"><a href="watershed-segmentation-sensitivity-testing.html#cb218-75" tabindex="-1"></a><span class="co">#   cloud2raster_ans$chm_rast %&gt;%</span></span>
<span id="cb218-76"><a href="watershed-segmentation-sensitivity-testing.html#cb218-76" tabindex="-1"></a><span class="co">#     terra::crop(</span></span>
<span id="cb218-77"><a href="watershed-segmentation-sensitivity-testing.html#cb218-77" tabindex="-1"></a><span class="co">#       stand_boundary %&gt;%</span></span>
<span id="cb218-78"><a href="watershed-segmentation-sensitivity-testing.html#cb218-78" tabindex="-1"></a><span class="co">#         dplyr::slice(1) %&gt;%</span></span>
<span id="cb218-79"><a href="watershed-segmentation-sensitivity-testing.html#cb218-79" tabindex="-1"></a><span class="co">#         sf::st_buffer(-80) %&gt;%</span></span>
<span id="cb218-80"><a href="watershed-segmentation-sensitivity-testing.html#cb218-80" tabindex="-1"></a><span class="co">#         sf::st_transform(terra::crs(cloud2raster_ans$chm_rast)) %&gt;%</span></span>
<span id="cb218-81"><a href="watershed-segmentation-sensitivity-testing.html#cb218-81" tabindex="-1"></a><span class="co">#         terra::vect()</span></span>
<span id="cb218-82"><a href="watershed-segmentation-sensitivity-testing.html#cb218-82" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb218-83"><a href="watershed-segmentation-sensitivity-testing.html#cb218-83" tabindex="-1"></a><span class="co">#   ,c(4,5)</span></span>
<span id="cb218-84"><a href="watershed-segmentation-sensitivity-testing.html#cb218-84" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb218-85"><a href="watershed-segmentation-sensitivity-testing.html#cb218-85" tabindex="-1"></a></span>
<span id="cb218-86"><a href="watershed-segmentation-sensitivity-testing.html#cb218-86" tabindex="-1"></a><span class="co"># xxx$chm_rast %&gt;% terra::subset( as.character(unique(c(4,5))[1]) ) %&gt;% terra::plot()</span></span>
<span id="cb218-87"><a href="watershed-segmentation-sensitivity-testing.html#cb218-87" tabindex="-1"></a><span class="co"># xxx$watershed_rast %&gt;% terra::subset( as.character(unique(c(4,5))[1]) ) %&gt;% terra::as.factor() %&gt;% terra::plot()</span></span>
<span id="cb218-88"><a href="watershed-segmentation-sensitivity-testing.html#cb218-88" tabindex="-1"></a><span class="co"># # xxx$volume_rast %&gt;% terra::subset( as.character(unique(c(4,5))[1]) ) %&gt;% terra::plot()</span></span>
<span id="cb218-89"><a href="watershed-segmentation-sensitivity-testing.html#cb218-89" tabindex="-1"></a><span class="co"># # xxx$area_rast[[1]] %&gt;% terra::minmax()</span></span>
<span id="cb218-90"><a href="watershed-segmentation-sensitivity-testing.html#cb218-90" tabindex="-1"></a><span class="co"># # xxx$area_rast %&gt;% terra::plot()</span></span>
<span id="cb218-91"><a href="watershed-segmentation-sensitivity-testing.html#cb218-91" tabindex="-1"></a></span>
<span id="cb218-92"><a href="watershed-segmentation-sensitivity-testing.html#cb218-92" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb218-93"><a href="watershed-segmentation-sensitivity-testing.html#cb218-93" tabindex="-1"></a><span class="co"># 2)</span></span>
<span id="cb218-94"><a href="watershed-segmentation-sensitivity-testing.html#cb218-94" tabindex="-1"></a><span class="co"># now we need to define a function to apply the filters to the resulting watershed segmented rasters </span></span>
<span id="cb218-95"><a href="watershed-segmentation-sensitivity-testing.html#cb218-95" tabindex="-1"></a><span class="co"># based on a data frame of difference combinations of filters for irregularity using the comparison to the convex hull</span></span>
<span id="cb218-96"><a href="watershed-segmentation-sensitivity-testing.html#cb218-96" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb218-97"><a href="watershed-segmentation-sensitivity-testing.html#cb218-97" tabindex="-1"></a>param_combos_detect_convexity_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb218-98"><a href="watershed-segmentation-sensitivity-testing.html#cb218-98" tabindex="-1"></a>  chm_watershed_seg_fn_ans</span>
<span id="cb218-99"><a href="watershed-segmentation-sensitivity-testing.html#cb218-99" tabindex="-1"></a>  <span class="do">#### height and area thresholds for the detected piles</span></span>
<span id="cb218-100"><a href="watershed-segmentation-sensitivity-testing.html#cb218-100" tabindex="-1"></a>  <span class="co"># these should be based on data from the literature or expectations based on the prescription</span></span>
<span id="cb218-101"><a href="watershed-segmentation-sensitivity-testing.html#cb218-101" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span> <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb218-102"><a href="watershed-segmentation-sensitivity-testing.html#cb218-102" tabindex="-1"></a>  <span class="do">#### irregularity filtering</span></span>
<span id="cb218-103"><a href="watershed-segmentation-sensitivity-testing.html#cb218-103" tabindex="-1"></a>  <span class="co"># 1 = perfectly convex (no inward angles); 0 = so many inward angles</span></span>
<span id="cb218-104"><a href="watershed-segmentation-sensitivity-testing.html#cb218-104" tabindex="-1"></a>  <span class="co"># values closer to 1 remove more irregular segments; </span></span>
<span id="cb218-105"><a href="watershed-segmentation-sensitivity-testing.html#cb218-105" tabindex="-1"></a>    <span class="co"># values closer to 0 keep more irregular segments (and also regular segments)</span></span>
<span id="cb218-106"><a href="watershed-segmentation-sensitivity-testing.html#cb218-106" tabindex="-1"></a>  <span class="co"># these will all be further filtered for their circularity and later smoothed to remove blocky edges</span></span>
<span id="cb218-107"><a href="watershed-segmentation-sensitivity-testing.html#cb218-107" tabindex="-1"></a>  <span class="co"># and most inward angles by applying a convex hull to the original detected segment</span></span>
<span id="cb218-108"><a href="watershed-segmentation-sensitivity-testing.html#cb218-108" tabindex="-1"></a>  , <span class="at">convexity_pct =</span> <span class="fl">0.7</span> <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb218-109"><a href="watershed-segmentation-sensitivity-testing.html#cb218-109" tabindex="-1"></a>) {</span>
<span id="cb218-110"><a href="watershed-segmentation-sensitivity-testing.html#cb218-110" tabindex="-1"></a>  <span class="co"># extract individual elements from chm_watershed_seg_fn</span></span>
<span id="cb218-111"><a href="watershed-segmentation-sensitivity-testing.html#cb218-111" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb218-112"><a href="watershed-segmentation-sensitivity-testing.html#cb218-112" tabindex="-1"></a>  watershed_ans <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>watershed_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb218-113"><a href="watershed-segmentation-sensitivity-testing.html#cb218-113" tabindex="-1"></a>  <span class="fu">names</span>(watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb218-114"><a href="watershed-segmentation-sensitivity-testing.html#cb218-114" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb218-115"><a href="watershed-segmentation-sensitivity-testing.html#cb218-115" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb218-116"><a href="watershed-segmentation-sensitivity-testing.html#cb218-116" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(watershed_ans,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`watershed_ans` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb218-117"><a href="watershed-segmentation-sensitivity-testing.html#cb218-117" tabindex="-1"></a>  </span>
<span id="cb218-118"><a href="watershed-segmentation-sensitivity-testing.html#cb218-118" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-119"><a href="watershed-segmentation-sensitivity-testing.html#cb218-119" tabindex="-1"></a>  <span class="do">## convert to polys and area filters</span></span>
<span id="cb218-120"><a href="watershed-segmentation-sensitivity-testing.html#cb218-120" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-121"><a href="watershed-segmentation-sensitivity-testing.html#cb218-121" tabindex="-1"></a>    <span class="co"># let&#39;s convert the watershed-detected segments from raster to vector data </span></span>
<span id="cb218-122"><a href="watershed-segmentation-sensitivity-testing.html#cb218-122" tabindex="-1"></a>    <span class="co"># and create a convex hull of the shapes for comparison</span></span>
<span id="cb218-123"><a href="watershed-segmentation-sensitivity-testing.html#cb218-123" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb218-124"><a href="watershed-segmentation-sensitivity-testing.html#cb218-124" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb218-125"><a href="watershed-segmentation-sensitivity-testing.html#cb218-125" tabindex="-1"></a>      watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb218-126"><a href="watershed-segmentation-sensitivity-testing.html#cb218-126" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb218-127"><a href="watershed-segmentation-sensitivity-testing.html#cb218-127" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-128"><a href="watershed-segmentation-sensitivity-testing.html#cb218-128" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-129"><a href="watershed-segmentation-sensitivity-testing.html#cb218-129" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-130"><a href="watershed-segmentation-sensitivity-testing.html#cb218-130" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-131"><a href="watershed-segmentation-sensitivity-testing.html#cb218-131" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb218-132"><a href="watershed-segmentation-sensitivity-testing.html#cb218-132" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-133"><a href="watershed-segmentation-sensitivity-testing.html#cb218-133" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb218-134"><a href="watershed-segmentation-sensitivity-testing.html#cb218-134" tabindex="-1"></a>    </span>
<span id="cb218-135"><a href="watershed-segmentation-sensitivity-testing.html#cb218-135" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">&lt;</span><span class="dv">1</span>){</span>
<span id="cb218-136"><a href="watershed-segmentation-sensitivity-testing.html#cb218-136" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb218-137"><a href="watershed-segmentation-sensitivity-testing.html#cb218-137" tabindex="-1"></a>    }</span>
<span id="cb218-138"><a href="watershed-segmentation-sensitivity-testing.html#cb218-138" tabindex="-1"></a>    </span>
<span id="cb218-139"><a href="watershed-segmentation-sensitivity-testing.html#cb218-139" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-140"><a href="watershed-segmentation-sensitivity-testing.html#cb218-140" tabindex="-1"></a>  <span class="do">## 2) irregularity filtering</span></span>
<span id="cb218-141"><a href="watershed-segmentation-sensitivity-testing.html#cb218-141" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-142"><a href="watershed-segmentation-sensitivity-testing.html#cb218-142" tabindex="-1"></a>    <span class="co"># let&#39;s first filter out segments that have holes in them </span></span>
<span id="cb218-143"><a href="watershed-segmentation-sensitivity-testing.html#cb218-143" tabindex="-1"></a>    <span class="co"># or are very irregularly shaped by comparing the area of the polygon and convex hull</span></span>
<span id="cb218-144"><a href="watershed-segmentation-sensitivity-testing.html#cb218-144" tabindex="-1"></a>    <span class="co"># convexity_pct = min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb218-145"><a href="watershed-segmentation-sensitivity-testing.html#cb218-145" tabindex="-1"></a>    <span class="cf">if</span>(convexity_pct<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb218-146"><a href="watershed-segmentation-sensitivity-testing.html#cb218-146" tabindex="-1"></a>      <span class="co"># apply the irregularity filtering on the polygons</span></span>
<span id="cb218-147"><a href="watershed-segmentation-sensitivity-testing.html#cb218-147" tabindex="-1"></a>      watershed_ans_poly <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb218-148"><a href="watershed-segmentation-sensitivity-testing.html#cb218-148" tabindex="-1"></a>        <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> convexity_pct)</span>
<span id="cb218-149"><a href="watershed-segmentation-sensitivity-testing.html#cb218-149" tabindex="-1"></a>    }</span>
<span id="cb218-150"><a href="watershed-segmentation-sensitivity-testing.html#cb218-150" tabindex="-1"></a>    </span>
<span id="cb218-151"><a href="watershed-segmentation-sensitivity-testing.html#cb218-151" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb218-152"><a href="watershed-segmentation-sensitivity-testing.html#cb218-152" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb218-153"><a href="watershed-segmentation-sensitivity-testing.html#cb218-153" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb218-154"><a href="watershed-segmentation-sensitivity-testing.html#cb218-154" tabindex="-1"></a>      <span class="fu">return</span>(watershed_ans_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">max_ht_m =</span> max_ht_m, <span class="at">convexity_pct =</span> convexity_pct))</span>
<span id="cb218-155"><a href="watershed-segmentation-sensitivity-testing.html#cb218-155" tabindex="-1"></a>    }</span>
<span id="cb218-156"><a href="watershed-segmentation-sensitivity-testing.html#cb218-156" tabindex="-1"></a>}</span>
<span id="cb218-157"><a href="watershed-segmentation-sensitivity-testing.html#cb218-157" tabindex="-1"></a></span>
<span id="cb218-158"><a href="watershed-segmentation-sensitivity-testing.html#cb218-158" tabindex="-1"></a><span class="co"># # just get the unique combinations needed for this param_combos_detect_convexity_fn function</span></span>
<span id="cb218-159"><a href="watershed-segmentation-sensitivity-testing.html#cb218-159" tabindex="-1"></a><span class="co"># param_combos_convexity_df &lt;-</span></span>
<span id="cb218-160"><a href="watershed-segmentation-sensitivity-testing.html#cb218-160" tabindex="-1"></a><span class="co">#   param_combos_df %&gt;% </span></span>
<span id="cb218-161"><a href="watershed-segmentation-sensitivity-testing.html#cb218-161" tabindex="-1"></a><span class="co">#   dplyr::filter(max_ht_m %in% as.numeric(names(xxx$chm_rast))) %&gt;% ## !!!!!!!!!!take this out</span></span>
<span id="cb218-162"><a href="watershed-segmentation-sensitivity-testing.html#cb218-162" tabindex="-1"></a><span class="co">#   dplyr::distinct(max_ht_m,convexity_pct)</span></span>
<span id="cb218-163"><a href="watershed-segmentation-sensitivity-testing.html#cb218-163" tabindex="-1"></a><span class="co"># # apply this using our data frame to map over the combinations</span></span>
<span id="cb218-164"><a href="watershed-segmentation-sensitivity-testing.html#cb218-164" tabindex="-1"></a><span class="co"># </span><span class="al">###</span><span class="co"> takes ~40 mins</span></span>
<span id="cb218-165"><a href="watershed-segmentation-sensitivity-testing.html#cb218-165" tabindex="-1"></a><span class="co"># param_combos_detect_convexity_ans &lt;- </span></span>
<span id="cb218-166"><a href="watershed-segmentation-sensitivity-testing.html#cb218-166" tabindex="-1"></a><span class="co">#   1:nrow(param_combos_convexity_df) %&gt;% </span></span>
<span id="cb218-167"><a href="watershed-segmentation-sensitivity-testing.html#cb218-167" tabindex="-1"></a><span class="co">#   sample(2) %&gt;% </span></span>
<span id="cb218-168"><a href="watershed-segmentation-sensitivity-testing.html#cb218-168" tabindex="-1"></a><span class="co">#   purrr::map(\(x)</span></span>
<span id="cb218-169"><a href="watershed-segmentation-sensitivity-testing.html#cb218-169" tabindex="-1"></a><span class="co">#     param_combos_detect_convexity_fn(</span></span>
<span id="cb218-170"><a href="watershed-segmentation-sensitivity-testing.html#cb218-170" tabindex="-1"></a><span class="co">#         chm_watershed_seg_fn_ans = xxx  ## !!!!!!!!!!change this</span></span>
<span id="cb218-171"><a href="watershed-segmentation-sensitivity-testing.html#cb218-171" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_convexity_df$max_ht_m[x]</span></span>
<span id="cb218-172"><a href="watershed-segmentation-sensitivity-testing.html#cb218-172" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_convexity_df$convexity_pct[x]</span></span>
<span id="cb218-173"><a href="watershed-segmentation-sensitivity-testing.html#cb218-173" tabindex="-1"></a><span class="co">#       )</span></span>
<span id="cb218-174"><a href="watershed-segmentation-sensitivity-testing.html#cb218-174" tabindex="-1"></a><span class="co">#     , .progress = T</span></span>
<span id="cb218-175"><a href="watershed-segmentation-sensitivity-testing.html#cb218-175" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb218-176"><a href="watershed-segmentation-sensitivity-testing.html#cb218-176" tabindex="-1"></a><span class="co">#   dplyr::bind_rows()</span></span>
<span id="cb218-177"><a href="watershed-segmentation-sensitivity-testing.html#cb218-177" tabindex="-1"></a><span class="co"># # param_combos_detect_convexity_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-178"><a href="watershed-segmentation-sensitivity-testing.html#cb218-178" tabindex="-1"></a><span class="co"># # param_combos_detect_convexity_ans %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(max_ht_m,convexity_pct)</span></span>
<span id="cb218-179"><a href="watershed-segmentation-sensitivity-testing.html#cb218-179" tabindex="-1"></a><span class="co"># # param_combos_detect_convexity_ans %&gt;% </span></span>
<span id="cb218-180"><a href="watershed-segmentation-sensitivity-testing.html#cb218-180" tabindex="-1"></a><span class="co"># #   dplyr::mutate(area_xxxx = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb218-181"><a href="watershed-segmentation-sensitivity-testing.html#cb218-181" tabindex="-1"></a><span class="co"># #   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb218-182"><a href="watershed-segmentation-sensitivity-testing.html#cb218-182" tabindex="-1"></a><span class="co"># #   dplyr::group_by(max_ht_m,convexity_pct) %&gt;% </span></span>
<span id="cb218-183"><a href="watershed-segmentation-sensitivity-testing.html#cb218-183" tabindex="-1"></a><span class="co"># #   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb218-184"><a href="watershed-segmentation-sensitivity-testing.html#cb218-184" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb218-185"><a href="watershed-segmentation-sensitivity-testing.html#cb218-185" tabindex="-1"></a><span class="co"># # now just join to filter for area</span></span>
<span id="cb218-186"><a href="watershed-segmentation-sensitivity-testing.html#cb218-186" tabindex="-1"></a><span class="co"># # expands to row unique by max_ht_m,convexity_pct,min_area_m2,max_area_m2,pred_id</span></span>
<span id="cb218-187"><a href="watershed-segmentation-sensitivity-testing.html#cb218-187" tabindex="-1"></a><span class="co"># param_combos_area &lt;- </span></span>
<span id="cb218-188"><a href="watershed-segmentation-sensitivity-testing.html#cb218-188" tabindex="-1"></a><span class="co">#   param_combos_detect_convexity_ans %&gt;% </span></span>
<span id="cb218-189"><a href="watershed-segmentation-sensitivity-testing.html#cb218-189" tabindex="-1"></a><span class="co">#   dplyr::mutate(area_xxxx = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb218-190"><a href="watershed-segmentation-sensitivity-testing.html#cb218-190" tabindex="-1"></a><span class="co">#   dplyr::inner_join(</span></span>
<span id="cb218-191"><a href="watershed-segmentation-sensitivity-testing.html#cb218-191" tabindex="-1"></a><span class="co">#     # add area ranges</span></span>
<span id="cb218-192"><a href="watershed-segmentation-sensitivity-testing.html#cb218-192" tabindex="-1"></a><span class="co">#     param_combos_df %&gt;% </span></span>
<span id="cb218-193"><a href="watershed-segmentation-sensitivity-testing.html#cb218-193" tabindex="-1"></a><span class="co">#       dplyr::distinct(max_ht_m,convexity_pct,min_area_m2,max_area_m2)</span></span>
<span id="cb218-194"><a href="watershed-segmentation-sensitivity-testing.html#cb218-194" tabindex="-1"></a><span class="co">#     , by = dplyr::join_by(</span></span>
<span id="cb218-195"><a href="watershed-segmentation-sensitivity-testing.html#cb218-195" tabindex="-1"></a><span class="co">#       max_ht_m, convexity_pct</span></span>
<span id="cb218-196"><a href="watershed-segmentation-sensitivity-testing.html#cb218-196" tabindex="-1"></a><span class="co">#       , area_xxxx&gt;=min_area_m2</span></span>
<span id="cb218-197"><a href="watershed-segmentation-sensitivity-testing.html#cb218-197" tabindex="-1"></a><span class="co">#       , area_xxxx&lt;=max_area_m2</span></span>
<span id="cb218-198"><a href="watershed-segmentation-sensitivity-testing.html#cb218-198" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb218-199"><a href="watershed-segmentation-sensitivity-testing.html#cb218-199" tabindex="-1"></a><span class="co">#     , relationship = &quot;many-to-many&quot;</span></span>
<span id="cb218-200"><a href="watershed-segmentation-sensitivity-testing.html#cb218-200" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb218-201"><a href="watershed-segmentation-sensitivity-testing.html#cb218-201" tabindex="-1"></a><span class="co">#   # dplyr::filter(</span></span>
<span id="cb218-202"><a href="watershed-segmentation-sensitivity-testing.html#cb218-202" tabindex="-1"></a><span class="co">#   #   area_xxxx&gt;=min_area_m2</span></span>
<span id="cb218-203"><a href="watershed-segmentation-sensitivity-testing.html#cb218-203" tabindex="-1"></a><span class="co">#   #   , area_xxxx&lt;=max_area_m2</span></span>
<span id="cb218-204"><a href="watershed-segmentation-sensitivity-testing.html#cb218-204" tabindex="-1"></a><span class="co">#   # )</span></span>
<span id="cb218-205"><a href="watershed-segmentation-sensitivity-testing.html#cb218-205" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-206"><a href="watershed-segmentation-sensitivity-testing.html#cb218-206" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb218-207"><a href="watershed-segmentation-sensitivity-testing.html#cb218-207" tabindex="-1"></a><span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb218-208"><a href="watershed-segmentation-sensitivity-testing.html#cb218-208" tabindex="-1"></a><span class="co">#   dplyr::group_by(max_ht_m,convexity_pct,min_area_m2,max_area_m2) %&gt;% </span></span>
<span id="cb218-209"><a href="watershed-segmentation-sensitivity-testing.html#cb218-209" tabindex="-1"></a><span class="co">#   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb218-210"><a href="watershed-segmentation-sensitivity-testing.html#cb218-210" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb218-211"><a href="watershed-segmentation-sensitivity-testing.html#cb218-211" tabindex="-1"></a><span class="co"># # geometries are unique by max_ht_m,pred_id</span></span>
<span id="cb218-212"><a href="watershed-segmentation-sensitivity-testing.html#cb218-212" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb218-213"><a href="watershed-segmentation-sensitivity-testing.html#cb218-213" tabindex="-1"></a><span class="co">#   dplyr::filter(</span></span>
<span id="cb218-214"><a href="watershed-segmentation-sensitivity-testing.html#cb218-214" tabindex="-1"></a><span class="co">#     pred_id == param_combos_area$pred_id[111]</span></span>
<span id="cb218-215"><a href="watershed-segmentation-sensitivity-testing.html#cb218-215" tabindex="-1"></a><span class="co">#     , max_ht_m == param_combos_area$max_ht_m[111]</span></span>
<span id="cb218-216"><a href="watershed-segmentation-sensitivity-testing.html#cb218-216" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb218-217"><a href="watershed-segmentation-sensitivity-testing.html#cb218-217" tabindex="-1"></a><span class="co">#   dplyr::mutate(lab = stringr::str_c(max_ht_m,convexity_pct,min_area_m2,max_area_m2, sep = &quot;:&quot;)) %&gt;% </span></span>
<span id="cb218-218"><a href="watershed-segmentation-sensitivity-testing.html#cb218-218" tabindex="-1"></a><span class="co">#   ggplot() + geom_sf(aes(linetype = lab, color = lab),fill=NA) + facet_wrap(facets = dplyr::vars(lab)) + theme_void()</span></span>
<span id="cb218-219"><a href="watershed-segmentation-sensitivity-testing.html#cb218-219" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb218-220"><a href="watershed-segmentation-sensitivity-testing.html#cb218-220" tabindex="-1"></a><span class="co">#   dplyr::group_by(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb218-221"><a href="watershed-segmentation-sensitivity-testing.html#cb218-221" tabindex="-1"></a><span class="co">#   dplyr::filter(dplyr::row_number()==1) %&gt;%</span></span>
<span id="cb218-222"><a href="watershed-segmentation-sensitivity-testing.html#cb218-222" tabindex="-1"></a><span class="co">#   dplyr::select(max_ht_m,pred_id) %&gt;% </span></span>
<span id="cb218-223"><a href="watershed-segmentation-sensitivity-testing.html#cb218-223" tabindex="-1"></a><span class="co">#   dplyr::ungroup() %&gt;% </span></span>
<span id="cb218-224"><a href="watershed-segmentation-sensitivity-testing.html#cb218-224" tabindex="-1"></a><span class="co">#   # dplyr::glimpse()</span></span>
<span id="cb218-225"><a href="watershed-segmentation-sensitivity-testing.html#cb218-225" tabindex="-1"></a><span class="co">#   ggplot() + geom_sf(aes(color = factor(max_ht_m)),fill=NA) + facet_wrap(facets = dplyr::vars(max_ht_m))</span></span>
<span id="cb218-226"><a href="watershed-segmentation-sensitivity-testing.html#cb218-226" tabindex="-1"></a></span>
<span id="cb218-227"><a href="watershed-segmentation-sensitivity-testing.html#cb218-227" tabindex="-1"></a><span class="co"># unique_geometries_cf &lt;- sf_data_circle_fit(</span></span>
<span id="cb218-228"><a href="watershed-segmentation-sensitivity-testing.html#cb218-228" tabindex="-1"></a><span class="co">#   param_combos_area %&gt;% </span></span>
<span id="cb218-229"><a href="watershed-segmentation-sensitivity-testing.html#cb218-229" tabindex="-1"></a><span class="co">#   dplyr::group_by(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb218-230"><a href="watershed-segmentation-sensitivity-testing.html#cb218-230" tabindex="-1"></a><span class="co">#   dplyr::filter(dplyr::row_number()==1) %&gt;%</span></span>
<span id="cb218-231"><a href="watershed-segmentation-sensitivity-testing.html#cb218-231" tabindex="-1"></a><span class="co">#   dplyr::select(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb218-232"><a href="watershed-segmentation-sensitivity-testing.html#cb218-232" tabindex="-1"></a><span class="co">#   dplyr::ungroup()</span></span>
<span id="cb218-233"><a href="watershed-segmentation-sensitivity-testing.html#cb218-233" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb218-234"><a href="watershed-segmentation-sensitivity-testing.html#cb218-234" tabindex="-1"></a><span class="co"># unique_geometries_cf %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-235"><a href="watershed-segmentation-sensitivity-testing.html#cb218-235" tabindex="-1"></a></span>
<span id="cb218-236"><a href="watershed-segmentation-sensitivity-testing.html#cb218-236" tabindex="-1"></a><span class="co"># function to smooth</span></span>
<span id="cb218-237"><a href="watershed-segmentation-sensitivity-testing.html#cb218-237" tabindex="-1"></a>raster_smooth_smoother <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb218-238"><a href="watershed-segmentation-sensitivity-testing.html#cb218-238" tabindex="-1"></a>  chm_watershed_seg_fn_ans</span>
<span id="cb218-239"><a href="watershed-segmentation-sensitivity-testing.html#cb218-239" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span></span>
<span id="cb218-240"><a href="watershed-segmentation-sensitivity-testing.html#cb218-240" tabindex="-1"></a>  , watershed_ans_poly</span>
<span id="cb218-241"><a href="watershed-segmentation-sensitivity-testing.html#cb218-241" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="dv">2</span></span>
<span id="cb218-242"><a href="watershed-segmentation-sensitivity-testing.html#cb218-242" tabindex="-1"></a>) {</span>
<span id="cb218-243"><a href="watershed-segmentation-sensitivity-testing.html#cb218-243" tabindex="-1"></a>  <span class="co"># extract individual elements from chm_watershed_seg_fn</span></span>
<span id="cb218-244"><a href="watershed-segmentation-sensitivity-testing.html#cb218-244" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb218-245"><a href="watershed-segmentation-sensitivity-testing.html#cb218-245" tabindex="-1"></a>  watershed_ans <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>watershed_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb218-246"><a href="watershed-segmentation-sensitivity-testing.html#cb218-246" tabindex="-1"></a>  <span class="fu">names</span>(watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb218-247"><a href="watershed-segmentation-sensitivity-testing.html#cb218-247" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb218-248"><a href="watershed-segmentation-sensitivity-testing.html#cb218-248" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb218-249"><a href="watershed-segmentation-sensitivity-testing.html#cb218-249" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(watershed_ans,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`watershed_ans` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb218-250"><a href="watershed-segmentation-sensitivity-testing.html#cb218-250" tabindex="-1"></a>  </span>
<span id="cb218-251"><a href="watershed-segmentation-sensitivity-testing.html#cb218-251" tabindex="-1"></a>  chm_res <span class="ot">&lt;-</span> <span class="fu">max</span>(terra<span class="sc">::</span><span class="fu">res</span>(chm_rast)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">na.rm =</span> T)</span>
<span id="cb218-252"><a href="watershed-segmentation-sensitivity-testing.html#cb218-252" tabindex="-1"></a>  </span>
<span id="cb218-253"><a href="watershed-segmentation-sensitivity-testing.html#cb218-253" tabindex="-1"></a>  ws_for_smooth <span class="ot">&lt;-</span> <span class="fu">ws_for_smooth_fn</span>(<span class="at">chm_res =</span> chm_res, <span class="at">min_area_m2 =</span> min_area_m2) <span class="co"># 3 # needs to be the same for the watershed seg and CHM smooth</span></span>
<span id="cb218-254"><a href="watershed-segmentation-sensitivity-testing.html#cb218-254" tabindex="-1"></a>  <span class="co"># search_area = (res^2) * (ws^2)</span></span>
<span id="cb218-255"><a href="watershed-segmentation-sensitivity-testing.html#cb218-255" tabindex="-1"></a>  </span>
<span id="cb218-256"><a href="watershed-segmentation-sensitivity-testing.html#cb218-256" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-257"><a href="watershed-segmentation-sensitivity-testing.html#cb218-257" tabindex="-1"></a>  <span class="do">## 5) raster smoothing</span></span>
<span id="cb218-258"><a href="watershed-segmentation-sensitivity-testing.html#cb218-258" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-259"><a href="watershed-segmentation-sensitivity-testing.html#cb218-259" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb218-260"><a href="watershed-segmentation-sensitivity-testing.html#cb218-260" tabindex="-1"></a>    <span class="co"># use the remaining segments that meet the geometric and area filtering</span></span>
<span id="cb218-261"><a href="watershed-segmentation-sensitivity-testing.html#cb218-261" tabindex="-1"></a>    <span class="co"># to smooth the watershed raster</span></span>
<span id="cb218-262"><a href="watershed-segmentation-sensitivity-testing.html#cb218-262" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb218-263"><a href="watershed-segmentation-sensitivity-testing.html#cb218-263" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb218-264"><a href="watershed-segmentation-sensitivity-testing.html#cb218-264" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb218-265"><a href="watershed-segmentation-sensitivity-testing.html#cb218-265" tabindex="-1"></a>        watershed_ans_poly <span class="sc">%&gt;%</span> <span class="co">#these are irregularity and area filtered already</span></span>
<span id="cb218-266"><a href="watershed-segmentation-sensitivity-testing.html#cb218-266" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb218-267"><a href="watershed-segmentation-sensitivity-testing.html#cb218-267" tabindex="-1"></a>        , <span class="at">updatevalue=</span><span class="cn">NA</span></span>
<span id="cb218-268"><a href="watershed-segmentation-sensitivity-testing.html#cb218-268" tabindex="-1"></a>      )</span>
<span id="cb218-269"><a href="watershed-segmentation-sensitivity-testing.html#cb218-269" tabindex="-1"></a>  </span>
<span id="cb218-270"><a href="watershed-segmentation-sensitivity-testing.html#cb218-270" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb218-271"><a href="watershed-segmentation-sensitivity-testing.html#cb218-271" tabindex="-1"></a>      <span class="co"># smooths the raster using the majority value</span></span>
<span id="cb218-272"><a href="watershed-segmentation-sensitivity-testing.html#cb218-272" tabindex="-1"></a>      smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb218-273"><a href="watershed-segmentation-sensitivity-testing.html#cb218-273" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;modal&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co"># only fill NA cells  </span></span>
<span id="cb218-274"><a href="watershed-segmentation-sensitivity-testing.html#cb218-274" tabindex="-1"></a>    }</span>
<span id="cb218-275"><a href="watershed-segmentation-sensitivity-testing.html#cb218-275" tabindex="-1"></a></span>
<span id="cb218-276"><a href="watershed-segmentation-sensitivity-testing.html#cb218-276" tabindex="-1"></a>    <span class="fu">names</span>(smooth_watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb218-277"><a href="watershed-segmentation-sensitivity-testing.html#cb218-277" tabindex="-1"></a></span>
<span id="cb218-278"><a href="watershed-segmentation-sensitivity-testing.html#cb218-278" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb218-279"><a href="watershed-segmentation-sensitivity-testing.html#cb218-279" tabindex="-1"></a>    <span class="co"># mask the chm rast to these remaining segments and smooth to match the smoothing for the segments</span></span>
<span id="cb218-280"><a href="watershed-segmentation-sensitivity-testing.html#cb218-280" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb218-281"><a href="watershed-segmentation-sensitivity-testing.html#cb218-281" tabindex="-1"></a>    smooth_chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb218-282"><a href="watershed-segmentation-sensitivity-testing.html#cb218-282" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_watershed_ans)</span>
<span id="cb218-283"><a href="watershed-segmentation-sensitivity-testing.html#cb218-283" tabindex="-1"></a>    </span>
<span id="cb218-284"><a href="watershed-segmentation-sensitivity-testing.html#cb218-284" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb218-285"><a href="watershed-segmentation-sensitivity-testing.html#cb218-285" tabindex="-1"></a>      <span class="co"># smooths the raster to match the smoothing in the watershed segments</span></span>
<span id="cb218-286"><a href="watershed-segmentation-sensitivity-testing.html#cb218-286" tabindex="-1"></a>      smooth_chm_rast <span class="ot">&lt;-</span> smooth_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb218-287"><a href="watershed-segmentation-sensitivity-testing.html#cb218-287" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co">#only for cells that are NA</span></span>
<span id="cb218-288"><a href="watershed-segmentation-sensitivity-testing.html#cb218-288" tabindex="-1"></a>    }</span>
<span id="cb218-289"><a href="watershed-segmentation-sensitivity-testing.html#cb218-289" tabindex="-1"></a></span>
<span id="cb218-290"><a href="watershed-segmentation-sensitivity-testing.html#cb218-290" tabindex="-1"></a>    <span class="co"># now mask the watershed_ans raster to only keep cells that are in the originating CHM</span></span>
<span id="cb218-291"><a href="watershed-segmentation-sensitivity-testing.html#cb218-291" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb218-292"><a href="watershed-segmentation-sensitivity-testing.html#cb218-292" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_chm_rast)</span>
<span id="cb218-293"><a href="watershed-segmentation-sensitivity-testing.html#cb218-293" tabindex="-1"></a></span>
<span id="cb218-294"><a href="watershed-segmentation-sensitivity-testing.html#cb218-294" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-295"><a href="watershed-segmentation-sensitivity-testing.html#cb218-295" tabindex="-1"></a>  <span class="do">## calculate raster-based area and volume </span></span>
<span id="cb218-296"><a href="watershed-segmentation-sensitivity-testing.html#cb218-296" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-297"><a href="watershed-segmentation-sensitivity-testing.html#cb218-297" tabindex="-1"></a>    <span class="co"># first, calculate the area of each cell</span></span>
<span id="cb218-298"><a href="watershed-segmentation-sensitivity-testing.html#cb218-298" tabindex="-1"></a>    area_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(smooth_chm_rast)</span>
<span id="cb218-299"><a href="watershed-segmentation-sensitivity-testing.html#cb218-299" tabindex="-1"></a>    <span class="fu">names</span>(area_rast) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb218-300"><a href="watershed-segmentation-sensitivity-testing.html#cb218-300" tabindex="-1"></a>    <span class="co"># area_rast %&gt;% terra::plot()</span></span>
<span id="cb218-301"><a href="watershed-segmentation-sensitivity-testing.html#cb218-301" tabindex="-1"></a>    <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb218-302"><a href="watershed-segmentation-sensitivity-testing.html#cb218-302" tabindex="-1"></a>    vol_rast <span class="ot">&lt;-</span> area_rast<span class="sc">*</span>smooth_chm_rast</span>
<span id="cb218-303"><a href="watershed-segmentation-sensitivity-testing.html#cb218-303" tabindex="-1"></a>    <span class="fu">names</span>(vol_rast) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb218-304"><a href="watershed-segmentation-sensitivity-testing.html#cb218-304" tabindex="-1"></a>    <span class="co"># vol_rast %&gt;% terra::plot()</span></span>
<span id="cb218-305"><a href="watershed-segmentation-sensitivity-testing.html#cb218-305" tabindex="-1"></a>    <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb218-306"><a href="watershed-segmentation-sensitivity-testing.html#cb218-306" tabindex="-1"></a>    area_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> area_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb218-307"><a href="watershed-segmentation-sensitivity-testing.html#cb218-307" tabindex="-1"></a>    <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb218-308"><a href="watershed-segmentation-sensitivity-testing.html#cb218-308" tabindex="-1"></a>    vol_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> vol_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb218-309"><a href="watershed-segmentation-sensitivity-testing.html#cb218-309" tabindex="-1"></a>    <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb218-310"><a href="watershed-segmentation-sensitivity-testing.html#cb218-310" tabindex="-1"></a>    ht_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> smooth_chm_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb218-311"><a href="watershed-segmentation-sensitivity-testing.html#cb218-311" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">max_height_m=</span><span class="dv">2</span>)</span>
<span id="cb218-312"><a href="watershed-segmentation-sensitivity-testing.html#cb218-312" tabindex="-1"></a>      </span>
<span id="cb218-313"><a href="watershed-segmentation-sensitivity-testing.html#cb218-313" tabindex="-1"></a>    <span class="co"># let&#39;s convert the smoothed and filtered watershed-detected segments from raster to vector data </span></span>
<span id="cb218-314"><a href="watershed-segmentation-sensitivity-testing.html#cb218-314" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb218-315"><a href="watershed-segmentation-sensitivity-testing.html#cb218-315" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb218-316"><a href="watershed-segmentation-sensitivity-testing.html#cb218-316" tabindex="-1"></a>      smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb218-317"><a href="watershed-segmentation-sensitivity-testing.html#cb218-317" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb218-318"><a href="watershed-segmentation-sensitivity-testing.html#cb218-318" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-319"><a href="watershed-segmentation-sensitivity-testing.html#cb218-319" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-320"><a href="watershed-segmentation-sensitivity-testing.html#cb218-320" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-321"><a href="watershed-segmentation-sensitivity-testing.html#cb218-321" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-322"><a href="watershed-segmentation-sensitivity-testing.html#cb218-322" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb218-323"><a href="watershed-segmentation-sensitivity-testing.html#cb218-323" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-324"><a href="watershed-segmentation-sensitivity-testing.html#cb218-324" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb218-325"><a href="watershed-segmentation-sensitivity-testing.html#cb218-325" tabindex="-1"></a></span>
<span id="cb218-326"><a href="watershed-segmentation-sensitivity-testing.html#cb218-326" tabindex="-1"></a>    <span class="co"># add area and volume to our vector data  </span></span>
<span id="cb218-327"><a href="watershed-segmentation-sensitivity-testing.html#cb218-327" tabindex="-1"></a>    <span class="co"># we&#39;ll do this with a slick trick to perform multiple joins succinctly using purrr::reduce</span></span>
<span id="cb218-328"><a href="watershed-segmentation-sensitivity-testing.html#cb218-328" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb218-329"><a href="watershed-segmentation-sensitivity-testing.html#cb218-329" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">reduce</span>(</span>
<span id="cb218-330"><a href="watershed-segmentation-sensitivity-testing.html#cb218-330" tabindex="-1"></a>        <span class="fu">list</span>(watershed_ans_poly, area_df, vol_df, ht_df)</span>
<span id="cb218-331"><a href="watershed-segmentation-sensitivity-testing.html#cb218-331" tabindex="-1"></a>        , dplyr<span class="sc">::</span>left_join</span>
<span id="cb218-332"><a href="watershed-segmentation-sensitivity-testing.html#cb218-332" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&#39;pred_id&#39;</span></span>
<span id="cb218-333"><a href="watershed-segmentation-sensitivity-testing.html#cb218-333" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-334"><a href="watershed-segmentation-sensitivity-testing.html#cb218-334" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb218-335"><a href="watershed-segmentation-sensitivity-testing.html#cb218-335" tabindex="-1"></a>        <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb218-336"><a href="watershed-segmentation-sensitivity-testing.html#cb218-336" tabindex="-1"></a>      )</span>
<span id="cb218-337"><a href="watershed-segmentation-sensitivity-testing.html#cb218-337" tabindex="-1"></a>      <span class="co"># # filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb218-338"><a href="watershed-segmentation-sensitivity-testing.html#cb218-338" tabindex="-1"></a>      <span class="co"># dplyr::filter(</span></span>
<span id="cb218-339"><a href="watershed-segmentation-sensitivity-testing.html#cb218-339" tabindex="-1"></a>      <span class="co">#   dplyr::coalesce(area_m2,0) &gt;= min_area_m2</span></span>
<span id="cb218-340"><a href="watershed-segmentation-sensitivity-testing.html#cb218-340" tabindex="-1"></a>      <span class="co">#   &amp; dplyr::coalesce(area_m2,0) &lt;= max_area_m2</span></span>
<span id="cb218-341"><a href="watershed-segmentation-sensitivity-testing.html#cb218-341" tabindex="-1"></a>      <span class="co"># ) %&gt;% </span></span>
<span id="cb218-342"><a href="watershed-segmentation-sensitivity-testing.html#cb218-342" tabindex="-1"></a>      <span class="co"># # do one more pass of the irregularity filtering</span></span>
<span id="cb218-343"><a href="watershed-segmentation-sensitivity-testing.html#cb218-343" tabindex="-1"></a>      <span class="co"># st_irregular_remove(pct_chull_overlap = convexity_pct)</span></span>
<span id="cb218-344"><a href="watershed-segmentation-sensitivity-testing.html#cb218-344" tabindex="-1"></a>      </span>
<span id="cb218-345"><a href="watershed-segmentation-sensitivity-testing.html#cb218-345" tabindex="-1"></a>      <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb218-346"><a href="watershed-segmentation-sensitivity-testing.html#cb218-346" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb218-347"><a href="watershed-segmentation-sensitivity-testing.html#cb218-347" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb218-348"><a href="watershed-segmentation-sensitivity-testing.html#cb218-348" tabindex="-1"></a>        <span class="fu">return</span>(watershed_ans_poly)</span>
<span id="cb218-349"><a href="watershed-segmentation-sensitivity-testing.html#cb218-349" tabindex="-1"></a>      }</span>
<span id="cb218-350"><a href="watershed-segmentation-sensitivity-testing.html#cb218-350" tabindex="-1"></a>   </span>
<span id="cb218-351"><a href="watershed-segmentation-sensitivity-testing.html#cb218-351" tabindex="-1"></a>}</span>
<span id="cb218-352"><a href="watershed-segmentation-sensitivity-testing.html#cb218-352" tabindex="-1"></a></span>
<span id="cb218-353"><a href="watershed-segmentation-sensitivity-testing.html#cb218-353" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% dplyr::slice_head(n=222) %&gt;% </span></span>
<span id="cb218-354"><a href="watershed-segmentation-sensitivity-testing.html#cb218-354" tabindex="-1"></a><span class="co">#   # sf::st_geometry() %&gt;% </span></span>
<span id="cb218-355"><a href="watershed-segmentation-sensitivity-testing.html#cb218-355" tabindex="-1"></a><span class="co">#   sf::st_set_geometry(&quot;geometry&quot;) %&gt;% </span></span>
<span id="cb218-356"><a href="watershed-segmentation-sensitivity-testing.html#cb218-356" tabindex="-1"></a><span class="co">#   dplyr::slice(1:3) %&gt;% </span></span>
<span id="cb218-357"><a href="watershed-segmentation-sensitivity-testing.html#cb218-357" tabindex="-1"></a><span class="co">#   dplyr::rowwise() %&gt;% </span></span>
<span id="cb218-358"><a href="watershed-segmentation-sensitivity-testing.html#cb218-358" tabindex="-1"></a><span class="co">#   dplyr::mutate(diam = st_calculate_diameter(geometry)) %&gt;% </span></span>
<span id="cb218-359"><a href="watershed-segmentation-sensitivity-testing.html#cb218-359" tabindex="-1"></a><span class="co">#   dplyr::ungroup() %&gt;% </span></span>
<span id="cb218-360"><a href="watershed-segmentation-sensitivity-testing.html#cb218-360" tabindex="-1"></a><span class="co">#   dplyr::glimpse()</span></span>
<span id="cb218-361"><a href="watershed-segmentation-sensitivity-testing.html#cb218-361" tabindex="-1"></a></span>
<span id="cb218-362"><a href="watershed-segmentation-sensitivity-testing.html#cb218-362" tabindex="-1"></a></span>
<span id="cb218-363"><a href="watershed-segmentation-sensitivity-testing.html#cb218-363" tabindex="-1"></a><span class="co"># function to do the whole thing</span></span>
<span id="cb218-364"><a href="watershed-segmentation-sensitivity-testing.html#cb218-364" tabindex="-1"></a>param_combos_piles_detect_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb218-365"><a href="watershed-segmentation-sensitivity-testing.html#cb218-365" tabindex="-1"></a>  chm</span>
<span id="cb218-366"><a href="watershed-segmentation-sensitivity-testing.html#cb218-366" tabindex="-1"></a>  , param_combos_df</span>
<span id="cb218-367"><a href="watershed-segmentation-sensitivity-testing.html#cb218-367" tabindex="-1"></a>  , <span class="at">smooth_segs =</span> T</span>
<span id="cb218-368"><a href="watershed-segmentation-sensitivity-testing.html#cb218-368" tabindex="-1"></a>  , <span class="at">ofile =</span> <span class="st">&quot;../data/param_combos_piles.gpkg&quot;</span></span>
<span id="cb218-369"><a href="watershed-segmentation-sensitivity-testing.html#cb218-369" tabindex="-1"></a>) {</span>
<span id="cb218-370"><a href="watershed-segmentation-sensitivity-testing.html#cb218-370" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-371"><a href="watershed-segmentation-sensitivity-testing.html#cb218-371" tabindex="-1"></a>  <span class="do">## 1) chm slice and watershed segmentation</span></span>
<span id="cb218-372"><a href="watershed-segmentation-sensitivity-testing.html#cb218-372" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-373"><a href="watershed-segmentation-sensitivity-testing.html#cb218-373" tabindex="-1"></a>  <span class="co"># apply chm_watershed_seg_fn</span></span>
<span id="cb218-374"><a href="watershed-segmentation-sensitivity-testing.html#cb218-374" tabindex="-1"></a>  <span class="do">### takes ~37 mins</span></span>
<span id="cb218-375"><a href="watershed-segmentation-sensitivity-testing.html#cb218-375" tabindex="-1"></a>  chm_watershed_seg_ans <span class="ot">&lt;-</span> <span class="fu">chm_watershed_seg_fn</span>(chm, <span class="at">max_ht_m =</span> <span class="fu">unique</span>(param_combos_df<span class="sc">$</span>max_ht_m))</span>
<span id="cb218-376"><a href="watershed-segmentation-sensitivity-testing.html#cb218-376" tabindex="-1"></a>  <span class="co"># # what did we get?</span></span>
<span id="cb218-377"><a href="watershed-segmentation-sensitivity-testing.html#cb218-377" tabindex="-1"></a>  <span class="co"># chm_watershed_seg_ans %&gt;% </span></span>
<span id="cb218-378"><a href="watershed-segmentation-sensitivity-testing.html#cb218-378" tabindex="-1"></a>  <span class="co">#   terra::subset( as.character(unique(param_combos_df$max_ht_m)[3]) ) %&gt;% </span></span>
<span id="cb218-379"><a href="watershed-segmentation-sensitivity-testing.html#cb218-379" tabindex="-1"></a>  <span class="co">#   terra::plot()</span></span>
<span id="cb218-380"><a href="watershed-segmentation-sensitivity-testing.html#cb218-380" tabindex="-1"></a>  </span>
<span id="cb218-381"><a href="watershed-segmentation-sensitivity-testing.html#cb218-381" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-382"><a href="watershed-segmentation-sensitivity-testing.html#cb218-382" tabindex="-1"></a>  <span class="do">## 2) irregularity filter</span></span>
<span id="cb218-383"><a href="watershed-segmentation-sensitivity-testing.html#cb218-383" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-384"><a href="watershed-segmentation-sensitivity-testing.html#cb218-384" tabindex="-1"></a>  <span class="co"># just get the unique combinations needed for this param_combos_detect_convexity_fn function</span></span>
<span id="cb218-385"><a href="watershed-segmentation-sensitivity-testing.html#cb218-385" tabindex="-1"></a>    param_combos_convexity_df <span class="ot">&lt;-</span></span>
<span id="cb218-386"><a href="watershed-segmentation-sensitivity-testing.html#cb218-386" tabindex="-1"></a>      param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb218-387"><a href="watershed-segmentation-sensitivity-testing.html#cb218-387" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(max_ht_m,convexity_pct)</span>
<span id="cb218-388"><a href="watershed-segmentation-sensitivity-testing.html#cb218-388" tabindex="-1"></a>    </span>
<span id="cb218-389"><a href="watershed-segmentation-sensitivity-testing.html#cb218-389" tabindex="-1"></a>    <span class="co"># apply this using our data frame to map over the combinations</span></span>
<span id="cb218-390"><a href="watershed-segmentation-sensitivity-testing.html#cb218-390" tabindex="-1"></a>    <span class="do">### takes ~40 mins</span></span>
<span id="cb218-391"><a href="watershed-segmentation-sensitivity-testing.html#cb218-391" tabindex="-1"></a>    param_combos_detect_convexity_ans <span class="ot">&lt;-</span> </span>
<span id="cb218-392"><a href="watershed-segmentation-sensitivity-testing.html#cb218-392" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_combos_convexity_df) <span class="sc">%&gt;%</span> </span>
<span id="cb218-393"><a href="watershed-segmentation-sensitivity-testing.html#cb218-393" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb218-394"><a href="watershed-segmentation-sensitivity-testing.html#cb218-394" tabindex="-1"></a>        <span class="fu">param_combos_detect_convexity_fn</span>(</span>
<span id="cb218-395"><a href="watershed-segmentation-sensitivity-testing.html#cb218-395" tabindex="-1"></a>            <span class="at">chm_watershed_seg_fn_ans =</span> chm_watershed_seg_ans</span>
<span id="cb218-396"><a href="watershed-segmentation-sensitivity-testing.html#cb218-396" tabindex="-1"></a>            , <span class="at">max_ht_m =</span> param_combos_convexity_df<span class="sc">$</span>max_ht_m[x]</span>
<span id="cb218-397"><a href="watershed-segmentation-sensitivity-testing.html#cb218-397" tabindex="-1"></a>            , <span class="at">convexity_pct =</span> param_combos_convexity_df<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb218-398"><a href="watershed-segmentation-sensitivity-testing.html#cb218-398" tabindex="-1"></a>          )</span>
<span id="cb218-399"><a href="watershed-segmentation-sensitivity-testing.html#cb218-399" tabindex="-1"></a>        , <span class="at">.progress =</span> <span class="st">&quot;convexity filtering&quot;</span></span>
<span id="cb218-400"><a href="watershed-segmentation-sensitivity-testing.html#cb218-400" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-401"><a href="watershed-segmentation-sensitivity-testing.html#cb218-401" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb218-402"><a href="watershed-segmentation-sensitivity-testing.html#cb218-402" tabindex="-1"></a>    <span class="co"># param_combos_detect_convexity_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-403"><a href="watershed-segmentation-sensitivity-testing.html#cb218-403" tabindex="-1"></a>    <span class="co"># param_combos_detect_convexity_ans %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(max_ht_m,convexity_pct)</span></span>
<span id="cb218-404"><a href="watershed-segmentation-sensitivity-testing.html#cb218-404" tabindex="-1"></a>    <span class="co"># param_combos_detect_convexity_ans %&gt;% </span></span>
<span id="cb218-405"><a href="watershed-segmentation-sensitivity-testing.html#cb218-405" tabindex="-1"></a>    <span class="co">#   dplyr::mutate(area_xxxx = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb218-406"><a href="watershed-segmentation-sensitivity-testing.html#cb218-406" tabindex="-1"></a>    <span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb218-407"><a href="watershed-segmentation-sensitivity-testing.html#cb218-407" tabindex="-1"></a>    <span class="co">#   dplyr::group_by(max_ht_m,convexity_pct) %&gt;% </span></span>
<span id="cb218-408"><a href="watershed-segmentation-sensitivity-testing.html#cb218-408" tabindex="-1"></a>    <span class="co">#   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb218-409"><a href="watershed-segmentation-sensitivity-testing.html#cb218-409" tabindex="-1"></a>  </span>
<span id="cb218-410"><a href="watershed-segmentation-sensitivity-testing.html#cb218-410" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-411"><a href="watershed-segmentation-sensitivity-testing.html#cb218-411" tabindex="-1"></a>  <span class="do">## 3) area filter</span></span>
<span id="cb218-412"><a href="watershed-segmentation-sensitivity-testing.html#cb218-412" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-413"><a href="watershed-segmentation-sensitivity-testing.html#cb218-413" tabindex="-1"></a>    <span class="co"># now just join to filter for area</span></span>
<span id="cb218-414"><a href="watershed-segmentation-sensitivity-testing.html#cb218-414" tabindex="-1"></a>    <span class="co"># expands to row unique by max_ht_m,convexity_pct,min_area_m2,max_area_m2,pred_id</span></span>
<span id="cb218-415"><a href="watershed-segmentation-sensitivity-testing.html#cb218-415" tabindex="-1"></a>    param_combos_area <span class="ot">&lt;-</span> </span>
<span id="cb218-416"><a href="watershed-segmentation-sensitivity-testing.html#cb218-416" tabindex="-1"></a>      param_combos_detect_convexity_ans <span class="sc">%&gt;%</span> </span>
<span id="cb218-417"><a href="watershed-segmentation-sensitivity-testing.html#cb218-417" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb218-418"><a href="watershed-segmentation-sensitivity-testing.html#cb218-418" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-419"><a href="watershed-segmentation-sensitivity-testing.html#cb218-419" tabindex="-1"></a>        <span class="co"># add area ranges</span></span>
<span id="cb218-420"><a href="watershed-segmentation-sensitivity-testing.html#cb218-420" tabindex="-1"></a>        param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb218-421"><a href="watershed-segmentation-sensitivity-testing.html#cb218-421" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">distinct</span>(max_ht_m,convexity_pct,min_area_m2,max_area_m2)</span>
<span id="cb218-422"><a href="watershed-segmentation-sensitivity-testing.html#cb218-422" tabindex="-1"></a>        , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(</span>
<span id="cb218-423"><a href="watershed-segmentation-sensitivity-testing.html#cb218-423" tabindex="-1"></a>          max_ht_m, convexity_pct</span>
<span id="cb218-424"><a href="watershed-segmentation-sensitivity-testing.html#cb218-424" tabindex="-1"></a>          , area_xxxx<span class="sc">&gt;=</span>min_area_m2</span>
<span id="cb218-425"><a href="watershed-segmentation-sensitivity-testing.html#cb218-425" tabindex="-1"></a>          , area_xxxx<span class="sc">&lt;=</span>max_area_m2</span>
<span id="cb218-426"><a href="watershed-segmentation-sensitivity-testing.html#cb218-426" tabindex="-1"></a>        )</span>
<span id="cb218-427"><a href="watershed-segmentation-sensitivity-testing.html#cb218-427" tabindex="-1"></a>        , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb218-428"><a href="watershed-segmentation-sensitivity-testing.html#cb218-428" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-429"><a href="watershed-segmentation-sensitivity-testing.html#cb218-429" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>area_xxxx)</span>
<span id="cb218-430"><a href="watershed-segmentation-sensitivity-testing.html#cb218-430" tabindex="-1"></a>      <span class="co"># dplyr::filter(</span></span>
<span id="cb218-431"><a href="watershed-segmentation-sensitivity-testing.html#cb218-431" tabindex="-1"></a>      <span class="co">#   area_xxxx&gt;=min_area_m2</span></span>
<span id="cb218-432"><a href="watershed-segmentation-sensitivity-testing.html#cb218-432" tabindex="-1"></a>      <span class="co">#   , area_xxxx&lt;=max_area_m2</span></span>
<span id="cb218-433"><a href="watershed-segmentation-sensitivity-testing.html#cb218-433" tabindex="-1"></a>      <span class="co"># )</span></span>
<span id="cb218-434"><a href="watershed-segmentation-sensitivity-testing.html#cb218-434" tabindex="-1"></a>    </span>
<span id="cb218-435"><a href="watershed-segmentation-sensitivity-testing.html#cb218-435" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-436"><a href="watershed-segmentation-sensitivity-testing.html#cb218-436" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb218-437"><a href="watershed-segmentation-sensitivity-testing.html#cb218-437" tabindex="-1"></a>    <span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb218-438"><a href="watershed-segmentation-sensitivity-testing.html#cb218-438" tabindex="-1"></a>    <span class="co">#   dplyr::group_by(max_ht_m,convexity_pct,min_area_m2,max_area_m2) %&gt;% </span></span>
<span id="cb218-439"><a href="watershed-segmentation-sensitivity-testing.html#cb218-439" tabindex="-1"></a>    <span class="co">#   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb218-440"><a href="watershed-segmentation-sensitivity-testing.html#cb218-440" tabindex="-1"></a>    </span>
<span id="cb218-441"><a href="watershed-segmentation-sensitivity-testing.html#cb218-441" tabindex="-1"></a>    <span class="co"># !!!!!!!!!!!!!!!!!!!!!!geometries are unique by max_ht_m,pred_id!!!!!!!!!!!!!!!!!!!!!!</span></span>
<span id="cb218-442"><a href="watershed-segmentation-sensitivity-testing.html#cb218-442" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb218-443"><a href="watershed-segmentation-sensitivity-testing.html#cb218-443" tabindex="-1"></a>    <span class="co">#   dplyr::filter(</span></span>
<span id="cb218-444"><a href="watershed-segmentation-sensitivity-testing.html#cb218-444" tabindex="-1"></a>    <span class="co">#     pred_id == param_combos_area$pred_id[111]</span></span>
<span id="cb218-445"><a href="watershed-segmentation-sensitivity-testing.html#cb218-445" tabindex="-1"></a>    <span class="co">#     , max_ht_m == param_combos_area$max_ht_m[111]</span></span>
<span id="cb218-446"><a href="watershed-segmentation-sensitivity-testing.html#cb218-446" tabindex="-1"></a>    <span class="co">#   ) %&gt;% </span></span>
<span id="cb218-447"><a href="watershed-segmentation-sensitivity-testing.html#cb218-447" tabindex="-1"></a>    <span class="co">#   dplyr::mutate(lab = stringr::str_c(max_ht_m,convexity_pct,min_area_m2,max_area_m2, sep = &quot;:&quot;)) %&gt;% </span></span>
<span id="cb218-448"><a href="watershed-segmentation-sensitivity-testing.html#cb218-448" tabindex="-1"></a>    <span class="co">#   ggplot() + geom_sf(aes(linetype = lab, color = lab),fill=NA) + facet_wrap(facets = dplyr::vars(lab)) + theme_void()</span></span>
<span id="cb218-449"><a href="watershed-segmentation-sensitivity-testing.html#cb218-449" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb218-450"><a href="watershed-segmentation-sensitivity-testing.html#cb218-450" tabindex="-1"></a>    <span class="co">#   dplyr::group_by(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb218-451"><a href="watershed-segmentation-sensitivity-testing.html#cb218-451" tabindex="-1"></a>    <span class="co">#   dplyr::filter(dplyr::row_number()==1) %&gt;%</span></span>
<span id="cb218-452"><a href="watershed-segmentation-sensitivity-testing.html#cb218-452" tabindex="-1"></a>    <span class="co">#   dplyr::select(max_ht_m,pred_id) %&gt;% </span></span>
<span id="cb218-453"><a href="watershed-segmentation-sensitivity-testing.html#cb218-453" tabindex="-1"></a>    <span class="co">#   dplyr::ungroup() %&gt;% </span></span>
<span id="cb218-454"><a href="watershed-segmentation-sensitivity-testing.html#cb218-454" tabindex="-1"></a>    <span class="co">#   # dplyr::glimpse()</span></span>
<span id="cb218-455"><a href="watershed-segmentation-sensitivity-testing.html#cb218-455" tabindex="-1"></a>    <span class="co">#   ggplot() + geom_sf(aes(color = factor(max_ht_m)),fill=NA) + facet_wrap(facets = dplyr::vars(max_ht_m))</span></span>
<span id="cb218-456"><a href="watershed-segmentation-sensitivity-testing.html#cb218-456" tabindex="-1"></a>    </span>
<span id="cb218-457"><a href="watershed-segmentation-sensitivity-testing.html#cb218-457" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-458"><a href="watershed-segmentation-sensitivity-testing.html#cb218-458" tabindex="-1"></a>  <span class="do">## 4) circle filter</span></span>
<span id="cb218-459"><a href="watershed-segmentation-sensitivity-testing.html#cb218-459" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb218-460"><a href="watershed-segmentation-sensitivity-testing.html#cb218-460" tabindex="-1"></a>    <span class="co"># !!!!!!!!!!!!!!!!!!!!!!geometries are unique by max_ht_m,pred_id!!!!!!!!!!!!!!!!!!!!!!</span></span>
<span id="cb218-461"><a href="watershed-segmentation-sensitivity-testing.html#cb218-461" tabindex="-1"></a>    unique_geometries <span class="ot">&lt;-</span> param_combos_area <span class="sc">%&gt;%</span> </span>
<span id="cb218-462"><a href="watershed-segmentation-sensitivity-testing.html#cb218-462" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(max_ht_m,pred_id) <span class="sc">%&gt;%</span></span>
<span id="cb218-463"><a href="watershed-segmentation-sensitivity-testing.html#cb218-463" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb218-464"><a href="watershed-segmentation-sensitivity-testing.html#cb218-464" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-465"><a href="watershed-segmentation-sensitivity-testing.html#cb218-465" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(max_ht_m,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb218-466"><a href="watershed-segmentation-sensitivity-testing.html#cb218-466" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">record_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb218-467"><a href="watershed-segmentation-sensitivity-testing.html#cb218-467" tabindex="-1"></a>  </span>
<span id="cb218-468"><a href="watershed-segmentation-sensitivity-testing.html#cb218-468" tabindex="-1"></a>  <span class="co"># param_combos_detect_convexity_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-469"><a href="watershed-segmentation-sensitivity-testing.html#cb218-469" tabindex="-1"></a>  <span class="co"># and we&#39;ll apply the circle fitting to this spatial data</span></span>
<span id="cb218-470"><a href="watershed-segmentation-sensitivity-testing.html#cb218-470" tabindex="-1"></a>  <span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb218-471"><a href="watershed-segmentation-sensitivity-testing.html#cb218-471" tabindex="-1"></a>  unique_geometries_cf <span class="ot">&lt;-</span> <span class="fu">sf_data_circle_fit</span>(unique_geometries)</span>
<span id="cb218-472"><a href="watershed-segmentation-sensitivity-testing.html#cb218-472" tabindex="-1"></a>  <span class="co"># param_combos_detect_cf_ans %&gt;% sf::st_write(&quot;../data/param_combos_detect_cf_ans.gpkg&quot;)</span></span>
<span id="cb218-473"><a href="watershed-segmentation-sensitivity-testing.html#cb218-473" tabindex="-1"></a>  <span class="co"># param_combos_detect_cf_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-474"><a href="watershed-segmentation-sensitivity-testing.html#cb218-474" tabindex="-1"></a>  <span class="co"># nrow(param_combos_detect_cf_ans)</span></span>
<span id="cb218-475"><a href="watershed-segmentation-sensitivity-testing.html#cb218-475" tabindex="-1"></a>  <span class="co"># nrow(param_combos_detect_convexity_ans)</span></span>
<span id="cb218-476"><a href="watershed-segmentation-sensitivity-testing.html#cb218-476" tabindex="-1"></a>  </span>
<span id="cb218-477"><a href="watershed-segmentation-sensitivity-testing.html#cb218-477" tabindex="-1"></a>  <span class="co"># we&#39;ll use the IoU function we defined </span></span>
<span id="cb218-478"><a href="watershed-segmentation-sensitivity-testing.html#cb218-478" tabindex="-1"></a>    <span class="co"># we map over this to only compare the segment to it&#39;s own best circle fit...not all</span></span>
<span id="cb218-479"><a href="watershed-segmentation-sensitivity-testing.html#cb218-479" tabindex="-1"></a>    <span class="co"># we should consider doing this in bulk.....another day</span></span>
<span id="cb218-480"><a href="watershed-segmentation-sensitivity-testing.html#cb218-480" tabindex="-1"></a>    param_combos_detect_cf_iou <span class="ot">&lt;-</span> </span>
<span id="cb218-481"><a href="watershed-segmentation-sensitivity-testing.html#cb218-481" tabindex="-1"></a>      unique_geometries<span class="sc">$</span>record_id <span class="sc">%&gt;%</span> </span>
<span id="cb218-482"><a href="watershed-segmentation-sensitivity-testing.html#cb218-482" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb218-483"><a href="watershed-segmentation-sensitivity-testing.html#cb218-483" tabindex="-1"></a>        <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb218-484"><a href="watershed-segmentation-sensitivity-testing.html#cb218-484" tabindex="-1"></a>          <span class="at">gt_inst =</span> unique_geometries <span class="sc">%&gt;%</span> </span>
<span id="cb218-485"><a href="watershed-segmentation-sensitivity-testing.html#cb218-485" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(record_id <span class="sc">==</span> x)</span>
<span id="cb218-486"><a href="watershed-segmentation-sensitivity-testing.html#cb218-486" tabindex="-1"></a>          , <span class="at">gt_id =</span> <span class="st">&quot;record_id&quot;</span></span>
<span id="cb218-487"><a href="watershed-segmentation-sensitivity-testing.html#cb218-487" tabindex="-1"></a>          , <span class="at">predictions =</span> unique_geometries_cf <span class="sc">%&gt;%</span> </span>
<span id="cb218-488"><a href="watershed-segmentation-sensitivity-testing.html#cb218-488" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(record_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb218-489"><a href="watershed-segmentation-sensitivity-testing.html#cb218-489" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(record_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb218-490"><a href="watershed-segmentation-sensitivity-testing.html#cb218-490" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_record_id =</span> record_id)</span>
<span id="cb218-491"><a href="watershed-segmentation-sensitivity-testing.html#cb218-491" tabindex="-1"></a>          , <span class="at">pred_id =</span> <span class="st">&quot;circ_record_id&quot;</span></span>
<span id="cb218-492"><a href="watershed-segmentation-sensitivity-testing.html#cb218-492" tabindex="-1"></a>          , <span class="at">min_iou_pct =</span> <span class="dv">0</span> <span class="co"># set to 0 just to return pct</span></span>
<span id="cb218-493"><a href="watershed-segmentation-sensitivity-testing.html#cb218-493" tabindex="-1"></a>        )    </span>
<span id="cb218-494"><a href="watershed-segmentation-sensitivity-testing.html#cb218-494" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-495"><a href="watershed-segmentation-sensitivity-testing.html#cb218-495" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb218-496"><a href="watershed-segmentation-sensitivity-testing.html#cb218-496" tabindex="-1"></a>    </span>
<span id="cb218-497"><a href="watershed-segmentation-sensitivity-testing.html#cb218-497" tabindex="-1"></a>    <span class="co"># param_combos_detect_cf_iou %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-498"><a href="watershed-segmentation-sensitivity-testing.html#cb218-498" tabindex="-1"></a>  </span>
<span id="cb218-499"><a href="watershed-segmentation-sensitivity-testing.html#cb218-499" tabindex="-1"></a>  <span class="do">### now we need a function to map over all the different filters for circularity by combination of the other settings</span></span>
<span id="cb218-500"><a href="watershed-segmentation-sensitivity-testing.html#cb218-500" tabindex="-1"></a>    <span class="do">### this is going to be highly custom to this particular task :\</span></span>
<span id="cb218-501"><a href="watershed-segmentation-sensitivity-testing.html#cb218-501" tabindex="-1"></a>  param_combos_circle_fit <span class="ot">&lt;-</span> </span>
<span id="cb218-502"><a href="watershed-segmentation-sensitivity-testing.html#cb218-502" tabindex="-1"></a>    param_combos_area <span class="sc">%&gt;%</span> </span>
<span id="cb218-503"><a href="watershed-segmentation-sensitivity-testing.html#cb218-503" tabindex="-1"></a>    <span class="co"># expands row to unique by max_ht_m,min_area_m2,max_area_m2,convexity_pct,circle_fit_iou_pct,pred_id</span></span>
<span id="cb218-504"><a href="watershed-segmentation-sensitivity-testing.html#cb218-504" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-505"><a href="watershed-segmentation-sensitivity-testing.html#cb218-505" tabindex="-1"></a>      param_combos_df</span>
<span id="cb218-506"><a href="watershed-segmentation-sensitivity-testing.html#cb218-506" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(max_ht_m,min_area_m2,max_area_m2,convexity_pct)</span>
<span id="cb218-507"><a href="watershed-segmentation-sensitivity-testing.html#cb218-507" tabindex="-1"></a>      , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb218-508"><a href="watershed-segmentation-sensitivity-testing.html#cb218-508" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-509"><a href="watershed-segmentation-sensitivity-testing.html#cb218-509" tabindex="-1"></a>    <span class="co"># join unique geoms</span></span>
<span id="cb218-510"><a href="watershed-segmentation-sensitivity-testing.html#cb218-510" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-511"><a href="watershed-segmentation-sensitivity-testing.html#cb218-511" tabindex="-1"></a>      unique_geometries <span class="sc">%&gt;%</span> </span>
<span id="cb218-512"><a href="watershed-segmentation-sensitivity-testing.html#cb218-512" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-513"><a href="watershed-segmentation-sensitivity-testing.html#cb218-513" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(max_ht_m,pred_id,record_id)</span>
<span id="cb218-514"><a href="watershed-segmentation-sensitivity-testing.html#cb218-514" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(max_ht_m,pred_id)</span>
<span id="cb218-515"><a href="watershed-segmentation-sensitivity-testing.html#cb218-515" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-516"><a href="watershed-segmentation-sensitivity-testing.html#cb218-516" tabindex="-1"></a>    <span class="co"># join circle fits</span></span>
<span id="cb218-517"><a href="watershed-segmentation-sensitivity-testing.html#cb218-517" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb218-518"><a href="watershed-segmentation-sensitivity-testing.html#cb218-518" tabindex="-1"></a>      param_combos_detect_cf_iou <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(record_id,iou)</span>
<span id="cb218-519"><a href="watershed-segmentation-sensitivity-testing.html#cb218-519" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;record_id&quot;</span></span>
<span id="cb218-520"><a href="watershed-segmentation-sensitivity-testing.html#cb218-520" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-521"><a href="watershed-segmentation-sensitivity-testing.html#cb218-521" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(iou,<span class="dv">0</span>)<span class="sc">&gt;=</span>circle_fit_iou_pct)</span>
<span id="cb218-522"><a href="watershed-segmentation-sensitivity-testing.html#cb218-522" tabindex="-1"></a>  <span class="do">############################################################</span></span>
<span id="cb218-523"><a href="watershed-segmentation-sensitivity-testing.html#cb218-523" tabindex="-1"></a>  <span class="co"># get unique sets of pred_id by height so we only need to smooth the raster for these sets</span></span>
<span id="cb218-524"><a href="watershed-segmentation-sensitivity-testing.html#cb218-524" tabindex="-1"></a>  <span class="do">############################################################</span></span>
<span id="cb218-525"><a href="watershed-segmentation-sensitivity-testing.html#cb218-525" tabindex="-1"></a>    rn_geom_lookup <span class="ot">&lt;-</span> param_combos_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb218-526"><a href="watershed-segmentation-sensitivity-testing.html#cb218-526" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-527"><a href="watershed-segmentation-sensitivity-testing.html#cb218-527" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(rn,max_ht_m,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb218-528"><a href="watershed-segmentation-sensitivity-testing.html#cb218-528" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(rn,max_ht_m) <span class="sc">%&gt;%</span> </span>
<span id="cb218-529"><a href="watershed-segmentation-sensitivity-testing.html#cb218-529" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">preds =</span> <span class="fu">paste</span>(<span class="fu">sort</span>(pred_id), <span class="at">collapse =</span> <span class="st">&quot;_&quot;</span>),<span class="at">n=</span>dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb218-530"><a href="watershed-segmentation-sensitivity-testing.html#cb218-530" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-531"><a href="watershed-segmentation-sensitivity-testing.html#cb218-531" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(max_ht_m,<span class="fu">desc</span>(n))</span>
<span id="cb218-532"><a href="watershed-segmentation-sensitivity-testing.html#cb218-532" tabindex="-1"></a></span>
<span id="cb218-533"><a href="watershed-segmentation-sensitivity-testing.html#cb218-533" tabindex="-1"></a>    <span class="co"># now just get the unique sets by max_ht_m</span></span>
<span id="cb218-534"><a href="watershed-segmentation-sensitivity-testing.html#cb218-534" tabindex="-1"></a>    rn_geom_lookup <span class="ot">&lt;-</span> rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb218-535"><a href="watershed-segmentation-sensitivity-testing.html#cb218-535" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-536"><a href="watershed-segmentation-sensitivity-testing.html#cb218-536" tabindex="-1"></a>        rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb218-537"><a href="watershed-segmentation-sensitivity-testing.html#cb218-537" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">distinct</span>(max_ht_m,preds) <span class="sc">%&gt;%</span> </span>
<span id="cb218-538"><a href="watershed-segmentation-sensitivity-testing.html#cb218-538" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">set_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb218-539"><a href="watershed-segmentation-sensitivity-testing.html#cb218-539" tabindex="-1"></a>        , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(max_ht_m,preds)</span>
<span id="cb218-540"><a href="watershed-segmentation-sensitivity-testing.html#cb218-540" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-541"><a href="watershed-segmentation-sensitivity-testing.html#cb218-541" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(set_id,rn,max_ht_m)</span>
<span id="cb218-542"><a href="watershed-segmentation-sensitivity-testing.html#cb218-542" tabindex="-1"></a>    <span class="co"># rn_geom_lookup %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-543"><a href="watershed-segmentation-sensitivity-testing.html#cb218-543" tabindex="-1"></a>    <span class="co"># now just get the unique max_ht_m and actual geoms</span></span>
<span id="cb218-544"><a href="watershed-segmentation-sensitivity-testing.html#cb218-544" tabindex="-1"></a>    geom_sets <span class="ot">&lt;-</span></span>
<span id="cb218-545"><a href="watershed-segmentation-sensitivity-testing.html#cb218-545" tabindex="-1"></a>      param_combos_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb218-546"><a href="watershed-segmentation-sensitivity-testing.html#cb218-546" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(rn,max_ht_m,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb218-547"><a href="watershed-segmentation-sensitivity-testing.html#cb218-547" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-548"><a href="watershed-segmentation-sensitivity-testing.html#cb218-548" tabindex="-1"></a>          rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb218-549"><a href="watershed-segmentation-sensitivity-testing.html#cb218-549" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">group_by</span>(set_id) <span class="sc">%&gt;%</span> </span>
<span id="cb218-550"><a href="watershed-segmentation-sensitivity-testing.html#cb218-550" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb218-551"><a href="watershed-segmentation-sensitivity-testing.html#cb218-551" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-552"><a href="watershed-segmentation-sensitivity-testing.html#cb218-552" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb218-553"><a href="watershed-segmentation-sensitivity-testing.html#cb218-553" tabindex="-1"></a>          , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn)</span>
<span id="cb218-554"><a href="watershed-segmentation-sensitivity-testing.html#cb218-554" tabindex="-1"></a>        )</span>
<span id="cb218-555"><a href="watershed-segmentation-sensitivity-testing.html#cb218-555" tabindex="-1"></a>        <span class="co"># dplyr::relocate(set_id) %&gt;% </span></span>
<span id="cb218-556"><a href="watershed-segmentation-sensitivity-testing.html#cb218-556" tabindex="-1"></a>        <span class="co"># dplyr::arrange(set_id,pred_id) %&gt;% </span></span>
<span id="cb218-557"><a href="watershed-segmentation-sensitivity-testing.html#cb218-557" tabindex="-1"></a>        <span class="co"># dplyr::glimpse()</span></span>
<span id="cb218-558"><a href="watershed-segmentation-sensitivity-testing.html#cb218-558" tabindex="-1"></a>    <span class="do">######## </span></span>
<span id="cb218-559"><a href="watershed-segmentation-sensitivity-testing.html#cb218-559" tabindex="-1"></a>  </span>
<span id="cb218-560"><a href="watershed-segmentation-sensitivity-testing.html#cb218-560" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-561"><a href="watershed-segmentation-sensitivity-testing.html#cb218-561" tabindex="-1"></a>    <span class="do">## 6) raster smooth</span></span>
<span id="cb218-562"><a href="watershed-segmentation-sensitivity-testing.html#cb218-562" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-563"><a href="watershed-segmentation-sensitivity-testing.html#cb218-563" tabindex="-1"></a>      geom_sets_smooth <span class="ot">&lt;-</span> </span>
<span id="cb218-564"><a href="watershed-segmentation-sensitivity-testing.html#cb218-564" tabindex="-1"></a>        geom_sets<span class="sc">$</span>set_id <span class="sc">%&gt;%</span> </span>
<span id="cb218-565"><a href="watershed-segmentation-sensitivity-testing.html#cb218-565" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-566"><a href="watershed-segmentation-sensitivity-testing.html#cb218-566" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb218-567"><a href="watershed-segmentation-sensitivity-testing.html#cb218-567" tabindex="-1"></a>          <span class="fu">raster_smooth_smoother</span>(</span>
<span id="cb218-568"><a href="watershed-segmentation-sensitivity-testing.html#cb218-568" tabindex="-1"></a>              <span class="at">chm_watershed_seg_fn_ans =</span> chm_watershed_seg_ans</span>
<span id="cb218-569"><a href="watershed-segmentation-sensitivity-testing.html#cb218-569" tabindex="-1"></a>              , <span class="at">max_ht_m =</span> (geom_sets <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(max_ht_m))</span>
<span id="cb218-570"><a href="watershed-segmentation-sensitivity-testing.html#cb218-570" tabindex="-1"></a>              , <span class="at">watershed_ans_poly =</span> geom_sets <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x)</span>
<span id="cb218-571"><a href="watershed-segmentation-sensitivity-testing.html#cb218-571" tabindex="-1"></a>              , <span class="at">min_area_m2 =</span> <span class="fu">min</span>(param_combos_df<span class="sc">$</span>min_area_m2,<span class="at">na.rm=</span>T) <span class="do">##### this fixes the parameter </span></span>
<span id="cb218-572"><a href="watershed-segmentation-sensitivity-testing.html#cb218-572" tabindex="-1"></a>                <span class="co"># .......... so won&#39;t work if param_combos_df contains multiple values #ohwell...just don&#39;t test min_area_m2</span></span>
<span id="cb218-573"><a href="watershed-segmentation-sensitivity-testing.html#cb218-573" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-574"><a href="watershed-segmentation-sensitivity-testing.html#cb218-574" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb218-575"><a href="watershed-segmentation-sensitivity-testing.html#cb218-575" tabindex="-1"></a>              <span class="at">set_id =</span> x</span>
<span id="cb218-576"><a href="watershed-segmentation-sensitivity-testing.html#cb218-576" tabindex="-1"></a>              , <span class="at">max_ht_m =</span> (geom_sets <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(max_ht_m))</span>
<span id="cb218-577"><a href="watershed-segmentation-sensitivity-testing.html#cb218-577" tabindex="-1"></a>            )</span>
<span id="cb218-578"><a href="watershed-segmentation-sensitivity-testing.html#cb218-578" tabindex="-1"></a>          , <span class="at">.progress =</span> <span class="st">&quot;smooth smoothing it&quot;</span></span>
<span id="cb218-579"><a href="watershed-segmentation-sensitivity-testing.html#cb218-579" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-580"><a href="watershed-segmentation-sensitivity-testing.html#cb218-580" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb218-581"><a href="watershed-segmentation-sensitivity-testing.html#cb218-581" tabindex="-1"></a>    </span>
<span id="cb218-582"><a href="watershed-segmentation-sensitivity-testing.html#cb218-582" tabindex="-1"></a>    <span class="co"># geom_sets_smooth %&gt;% dplyr::glimpse()  </span></span>
<span id="cb218-583"><a href="watershed-segmentation-sensitivity-testing.html#cb218-583" tabindex="-1"></a>    <span class="co"># ggplot() +</span></span>
<span id="cb218-584"><a href="watershed-segmentation-sensitivity-testing.html#cb218-584" tabindex="-1"></a>    <span class="co">#   geom_sf(</span></span>
<span id="cb218-585"><a href="watershed-segmentation-sensitivity-testing.html#cb218-585" tabindex="-1"></a>    <span class="co">#     data = geom_sets_smooth %&gt;% dplyr::filter(set_id == geom_sets_smooth$set_id[1])</span></span>
<span id="cb218-586"><a href="watershed-segmentation-sensitivity-testing.html#cb218-586" tabindex="-1"></a>    <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb218-587"><a href="watershed-segmentation-sensitivity-testing.html#cb218-587" tabindex="-1"></a>    <span class="co">#     , alpha = 0.8</span></span>
<span id="cb218-588"><a href="watershed-segmentation-sensitivity-testing.html#cb218-588" tabindex="-1"></a>    <span class="co">#   ) +</span></span>
<span id="cb218-589"><a href="watershed-segmentation-sensitivity-testing.html#cb218-589" tabindex="-1"></a>    <span class="co">#   geom_sf(</span></span>
<span id="cb218-590"><a href="watershed-segmentation-sensitivity-testing.html#cb218-590" tabindex="-1"></a>    <span class="co">#     data = geom_sets %&gt;% dplyr::filter(set_id == geom_sets_smooth$set_id[1])</span></span>
<span id="cb218-591"><a href="watershed-segmentation-sensitivity-testing.html#cb218-591" tabindex="-1"></a>    <span class="co">#     , fill = NA</span></span>
<span id="cb218-592"><a href="watershed-segmentation-sensitivity-testing.html#cb218-592" tabindex="-1"></a>    <span class="co">#     , color = &quot;gold&quot;</span></span>
<span id="cb218-593"><a href="watershed-segmentation-sensitivity-testing.html#cb218-593" tabindex="-1"></a>    <span class="co">#   ) +</span></span>
<span id="cb218-594"><a href="watershed-segmentation-sensitivity-testing.html#cb218-594" tabindex="-1"></a>    <span class="co">#   theme_void()</span></span>
<span id="cb218-595"><a href="watershed-segmentation-sensitivity-testing.html#cb218-595" tabindex="-1"></a>      </span>
<span id="cb218-596"><a href="watershed-segmentation-sensitivity-testing.html#cb218-596" tabindex="-1"></a>      <span class="co"># # these polygons are unique</span></span>
<span id="cb218-597"><a href="watershed-segmentation-sensitivity-testing.html#cb218-597" tabindex="-1"></a>      <span class="co"># # diameter</span></span>
<span id="cb218-598"><a href="watershed-segmentation-sensitivity-testing.html#cb218-598" tabindex="-1"></a>      <span class="co"># message(&quot;diametering.....&quot;)</span></span>
<span id="cb218-599"><a href="watershed-segmentation-sensitivity-testing.html#cb218-599" tabindex="-1"></a>      <span class="co"># geom_sets_smooth &lt;- geom_sets_smooth %&gt;%</span></span>
<span id="cb218-600"><a href="watershed-segmentation-sensitivity-testing.html#cb218-600" tabindex="-1"></a>      <span class="co">#   sf::st_set_geometry(&quot;geometry&quot;) %&gt;%</span></span>
<span id="cb218-601"><a href="watershed-segmentation-sensitivity-testing.html#cb218-601" tabindex="-1"></a>      <span class="co">#   dplyr::rowwise() %&gt;%</span></span>
<span id="cb218-602"><a href="watershed-segmentation-sensitivity-testing.html#cb218-602" tabindex="-1"></a>      <span class="co">#   dplyr::mutate(diameter_m = st_calculate_diameter(geometry)) %&gt;%</span></span>
<span id="cb218-603"><a href="watershed-segmentation-sensitivity-testing.html#cb218-603" tabindex="-1"></a>      <span class="co">#   dplyr::ungroup()</span></span>
<span id="cb218-604"><a href="watershed-segmentation-sensitivity-testing.html#cb218-604" tabindex="-1"></a>    </span>
<span id="cb218-605"><a href="watershed-segmentation-sensitivity-testing.html#cb218-605" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-606"><a href="watershed-segmentation-sensitivity-testing.html#cb218-606" tabindex="-1"></a>    <span class="do">## 6.3) second irregular filter</span></span>
<span id="cb218-607"><a href="watershed-segmentation-sensitivity-testing.html#cb218-607" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-608"><a href="watershed-segmentation-sensitivity-testing.html#cb218-608" tabindex="-1"></a>    <span class="co"># get set, convexity combinations to map over st_irregular_remove</span></span>
<span id="cb218-609"><a href="watershed-segmentation-sensitivity-testing.html#cb218-609" tabindex="-1"></a>    set_convexity_combo <span class="ot">&lt;-</span> </span>
<span id="cb218-610"><a href="watershed-segmentation-sensitivity-testing.html#cb218-610" tabindex="-1"></a>      rn_geom_lookup <span class="sc">%&gt;%</span>  </span>
<span id="cb218-611"><a href="watershed-segmentation-sensitivity-testing.html#cb218-611" tabindex="-1"></a>        <span class="co"># add in convexity pct to get unique set_id, convexity</span></span>
<span id="cb218-612"><a href="watershed-segmentation-sensitivity-testing.html#cb218-612" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-613"><a href="watershed-segmentation-sensitivity-testing.html#cb218-613" tabindex="-1"></a>          param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb218-614"><a href="watershed-segmentation-sensitivity-testing.html#cb218-614" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(rn,convexity_pct)</span>
<span id="cb218-615"><a href="watershed-segmentation-sensitivity-testing.html#cb218-615" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb218-616"><a href="watershed-segmentation-sensitivity-testing.html#cb218-616" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-617"><a href="watershed-segmentation-sensitivity-testing.html#cb218-617" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(set_id,convexity_pct)</span>
<span id="cb218-618"><a href="watershed-segmentation-sensitivity-testing.html#cb218-618" tabindex="-1"></a>    </span>
<span id="cb218-619"><a href="watershed-segmentation-sensitivity-testing.html#cb218-619" tabindex="-1"></a>    <span class="co"># filter for convexity</span></span>
<span id="cb218-620"><a href="watershed-segmentation-sensitivity-testing.html#cb218-620" tabindex="-1"></a>      geom_sets_convexity <span class="ot">&lt;-</span> </span>
<span id="cb218-621"><a href="watershed-segmentation-sensitivity-testing.html#cb218-621" tabindex="-1"></a>        <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(set_convexity_combo) <span class="sc">%&gt;%</span> </span>
<span id="cb218-622"><a href="watershed-segmentation-sensitivity-testing.html#cb218-622" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb218-623"><a href="watershed-segmentation-sensitivity-testing.html#cb218-623" tabindex="-1"></a>          <span class="fu">st_irregular_remove</span>(</span>
<span id="cb218-624"><a href="watershed-segmentation-sensitivity-testing.html#cb218-624" tabindex="-1"></a>            <span class="at">sf_data =</span> geom_sets_smooth <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>set_convexity_combo<span class="sc">$</span>set_id[x])</span>
<span id="cb218-625"><a href="watershed-segmentation-sensitivity-testing.html#cb218-625" tabindex="-1"></a>            , <span class="at">pct_chull_overlap =</span> set_convexity_combo<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb218-626"><a href="watershed-segmentation-sensitivity-testing.html#cb218-626" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-627"><a href="watershed-segmentation-sensitivity-testing.html#cb218-627" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb218-628"><a href="watershed-segmentation-sensitivity-testing.html#cb218-628" tabindex="-1"></a>              <span class="at">set_id =</span> set_convexity_combo<span class="sc">$</span>set_id[x]</span>
<span id="cb218-629"><a href="watershed-segmentation-sensitivity-testing.html#cb218-629" tabindex="-1"></a>              , <span class="at">convexity_pct =</span> set_convexity_combo<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb218-630"><a href="watershed-segmentation-sensitivity-testing.html#cb218-630" tabindex="-1"></a>            )</span>
<span id="cb218-631"><a href="watershed-segmentation-sensitivity-testing.html#cb218-631" tabindex="-1"></a>          , <span class="at">.progress =</span> <span class="st">&quot;second irregularity filter&quot;</span></span>
<span id="cb218-632"><a href="watershed-segmentation-sensitivity-testing.html#cb218-632" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-633"><a href="watershed-segmentation-sensitivity-testing.html#cb218-633" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb218-634"><a href="watershed-segmentation-sensitivity-testing.html#cb218-634" tabindex="-1"></a>    </span>
<span id="cb218-635"><a href="watershed-segmentation-sensitivity-testing.html#cb218-635" tabindex="-1"></a>    <span class="co"># row is unique by set_id,convexity_pct,pred_id</span></span>
<span id="cb218-636"><a href="watershed-segmentation-sensitivity-testing.html#cb218-636" tabindex="-1"></a>    <span class="co"># geom_sets_convexity %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-637"><a href="watershed-segmentation-sensitivity-testing.html#cb218-637" tabindex="-1"></a>    <span class="co"># geom_sets_convexity %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(set_id,convexity_pct)</span></span>
<span id="cb218-638"><a href="watershed-segmentation-sensitivity-testing.html#cb218-638" tabindex="-1"></a>    </span>
<span id="cb218-639"><a href="watershed-segmentation-sensitivity-testing.html#cb218-639" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-640"><a href="watershed-segmentation-sensitivity-testing.html#cb218-640" tabindex="-1"></a>    <span class="do">## 6.6) second area filter</span></span>
<span id="cb218-641"><a href="watershed-segmentation-sensitivity-testing.html#cb218-641" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-642"><a href="watershed-segmentation-sensitivity-testing.html#cb218-642" tabindex="-1"></a>    <span class="co"># filter for area</span></span>
<span id="cb218-643"><a href="watershed-segmentation-sensitivity-testing.html#cb218-643" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;expanding to final param combos.....&quot;</span>)</span>
<span id="cb218-644"><a href="watershed-segmentation-sensitivity-testing.html#cb218-644" tabindex="-1"></a>      filtered_final <span class="ot">&lt;-</span> </span>
<span id="cb218-645"><a href="watershed-segmentation-sensitivity-testing.html#cb218-645" tabindex="-1"></a>        geom_sets_convexity <span class="sc">%&gt;%</span> </span>
<span id="cb218-646"><a href="watershed-segmentation-sensitivity-testing.html#cb218-646" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(max_ht_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-647"><a href="watershed-segmentation-sensitivity-testing.html#cb218-647" tabindex="-1"></a>        <span class="co"># expand to full param_combos_df</span></span>
<span id="cb218-648"><a href="watershed-segmentation-sensitivity-testing.html#cb218-648" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-649"><a href="watershed-segmentation-sensitivity-testing.html#cb218-649" tabindex="-1"></a>          param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb218-650"><a href="watershed-segmentation-sensitivity-testing.html#cb218-650" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-651"><a href="watershed-segmentation-sensitivity-testing.html#cb218-651" tabindex="-1"></a>              rn_geom_lookup <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb218-652"><a href="watershed-segmentation-sensitivity-testing.html#cb218-652" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb218-653"><a href="watershed-segmentation-sensitivity-testing.html#cb218-653" tabindex="-1"></a>            )</span>
<span id="cb218-654"><a href="watershed-segmentation-sensitivity-testing.html#cb218-654" tabindex="-1"></a>          , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id,convexity_pct)</span>
<span id="cb218-655"><a href="watershed-segmentation-sensitivity-testing.html#cb218-655" tabindex="-1"></a>          , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb218-656"><a href="watershed-segmentation-sensitivity-testing.html#cb218-656" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-657"><a href="watershed-segmentation-sensitivity-testing.html#cb218-657" tabindex="-1"></a>        <span class="co"># filter for area</span></span>
<span id="cb218-658"><a href="watershed-segmentation-sensitivity-testing.html#cb218-658" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb218-659"><a href="watershed-segmentation-sensitivity-testing.html#cb218-659" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb218-660"><a href="watershed-segmentation-sensitivity-testing.html#cb218-660" tabindex="-1"></a>          <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb218-661"><a href="watershed-segmentation-sensitivity-testing.html#cb218-661" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-662"><a href="watershed-segmentation-sensitivity-testing.html#cb218-662" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(set_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-663"><a href="watershed-segmentation-sensitivity-testing.html#cb218-663" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">relocate</span>(<span class="fu">names</span>(param_combos_df))</span>
<span id="cb218-664"><a href="watershed-segmentation-sensitivity-testing.html#cb218-664" tabindex="-1"></a>    <span class="co"># filtered_final %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-665"><a href="watershed-segmentation-sensitivity-testing.html#cb218-665" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-666"><a href="watershed-segmentation-sensitivity-testing.html#cb218-666" tabindex="-1"></a>    <span class="do">## 7) shape refinement &amp; overlap removal</span></span>
<span id="cb218-667"><a href="watershed-segmentation-sensitivity-testing.html#cb218-667" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb218-668"><a href="watershed-segmentation-sensitivity-testing.html#cb218-668" tabindex="-1"></a>      <span class="co"># use the convex hull shapes of our remaining segments. </span></span>
<span id="cb218-669"><a href="watershed-segmentation-sensitivity-testing.html#cb218-669" tabindex="-1"></a>      <span class="co"># This helps to smooth out the often &#39;blocky&#39; edges of raster-based segments</span></span>
<span id="cb218-670"><a href="watershed-segmentation-sensitivity-testing.html#cb218-670" tabindex="-1"></a>      <span class="co"># , which can look like they were generated in Minecraft. </span></span>
<span id="cb218-671"><a href="watershed-segmentation-sensitivity-testing.html#cb218-671" tabindex="-1"></a>      <span class="co"># Additionally, by removing any segments with overlapping convex hull shapes, </span></span>
<span id="cb218-672"><a href="watershed-segmentation-sensitivity-testing.html#cb218-672" tabindex="-1"></a>      <span class="co"># we can likely reduce false detections that are actually groups of small trees or shrubs, </span></span>
<span id="cb218-673"><a href="watershed-segmentation-sensitivity-testing.html#cb218-673" tabindex="-1"></a>      <span class="co"># ensuring our results represent singular slash piles.</span></span>
<span id="cb218-674"><a href="watershed-segmentation-sensitivity-testing.html#cb218-674" tabindex="-1"></a>      smooth_segs <span class="ot">&lt;-</span> T</span>
<span id="cb218-675"><a href="watershed-segmentation-sensitivity-testing.html#cb218-675" tabindex="-1"></a>      </span>
<span id="cb218-676"><a href="watershed-segmentation-sensitivity-testing.html#cb218-676" tabindex="-1"></a>      <span class="cf">if</span>(smooth_segs){</span>
<span id="cb218-677"><a href="watershed-segmentation-sensitivity-testing.html#cb218-677" tabindex="-1"></a>        <span class="co"># smooth unique polygons </span></span>
<span id="cb218-678"><a href="watershed-segmentation-sensitivity-testing.html#cb218-678" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;shape refinement and diametering.....&quot;</span>)</span>
<span id="cb218-679"><a href="watershed-segmentation-sensitivity-testing.html#cb218-679" tabindex="-1"></a>        <span class="do">##### just work with unique polygons</span></span>
<span id="cb218-680"><a href="watershed-segmentation-sensitivity-testing.html#cb218-680" tabindex="-1"></a>        <span class="do">##### geom_sets_smooth row is unique by: set_id,pred_id</span></span>
<span id="cb218-681"><a href="watershed-segmentation-sensitivity-testing.html#cb218-681" tabindex="-1"></a>        geom_sets_final <span class="ot">&lt;-</span> geom_sets_smooth <span class="sc">%&gt;%</span> </span>
<span id="cb218-682"><a href="watershed-segmentation-sensitivity-testing.html#cb218-682" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb218-683"><a href="watershed-segmentation-sensitivity-testing.html#cb218-683" tabindex="-1"></a>            <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb218-684"><a href="watershed-segmentation-sensitivity-testing.html#cb218-684" tabindex="-1"></a>            , <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb218-685"><a href="watershed-segmentation-sensitivity-testing.html#cb218-685" tabindex="-1"></a>          ))) <span class="sc">%&gt;%</span> </span>
<span id="cb218-686"><a href="watershed-segmentation-sensitivity-testing.html#cb218-686" tabindex="-1"></a>          <span class="co"># join to filter geoms</span></span>
<span id="cb218-687"><a href="watershed-segmentation-sensitivity-testing.html#cb218-687" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-688"><a href="watershed-segmentation-sensitivity-testing.html#cb218-688" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb218-689"><a href="watershed-segmentation-sensitivity-testing.html#cb218-689" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-690"><a href="watershed-segmentation-sensitivity-testing.html#cb218-690" tabindex="-1"></a>                filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb218-691"><a href="watershed-segmentation-sensitivity-testing.html#cb218-691" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-692"><a href="watershed-segmentation-sensitivity-testing.html#cb218-692" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb218-693"><a href="watershed-segmentation-sensitivity-testing.html#cb218-693" tabindex="-1"></a>                , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn)</span>
<span id="cb218-694"><a href="watershed-segmentation-sensitivity-testing.html#cb218-694" tabindex="-1"></a>                , <span class="at">relationship =</span> <span class="st">&quot;one-to-many&quot;</span></span>
<span id="cb218-695"><a href="watershed-segmentation-sensitivity-testing.html#cb218-695" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-696"><a href="watershed-segmentation-sensitivity-testing.html#cb218-696" tabindex="-1"></a>              <span class="co"># just get the unique geoms now</span></span>
<span id="cb218-697"><a href="watershed-segmentation-sensitivity-testing.html#cb218-697" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(set_id,pred_id)</span>
<span id="cb218-698"><a href="watershed-segmentation-sensitivity-testing.html#cb218-698" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id,pred_id)</span>
<span id="cb218-699"><a href="watershed-segmentation-sensitivity-testing.html#cb218-699" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb218-700"><a href="watershed-segmentation-sensitivity-testing.html#cb218-700" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-701"><a href="watershed-segmentation-sensitivity-testing.html#cb218-701" tabindex="-1"></a>          <span class="co"># smooth</span></span>
<span id="cb218-702"><a href="watershed-segmentation-sensitivity-testing.html#cb218-702" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-703"><a href="watershed-segmentation-sensitivity-testing.html#cb218-703" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-704"><a href="watershed-segmentation-sensitivity-testing.html#cb218-704" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-705"><a href="watershed-segmentation-sensitivity-testing.html#cb218-705" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-706"><a href="watershed-segmentation-sensitivity-testing.html#cb218-706" tabindex="-1"></a>          <span class="co"># diameter</span></span>
<span id="cb218-707"><a href="watershed-segmentation-sensitivity-testing.html#cb218-707" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb218-708"><a href="watershed-segmentation-sensitivity-testing.html#cb218-708" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb218-709"><a href="watershed-segmentation-sensitivity-testing.html#cb218-709" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diameter_m =</span> <span class="fu">st_calculate_diameter</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb218-710"><a href="watershed-segmentation-sensitivity-testing.html#cb218-710" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-711"><a href="watershed-segmentation-sensitivity-testing.html#cb218-711" tabindex="-1"></a>          <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb218-712"><a href="watershed-segmentation-sensitivity-testing.html#cb218-712" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb218-713"><a href="watershed-segmentation-sensitivity-testing.html#cb218-713" tabindex="-1"></a>            <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb218-714"><a href="watershed-segmentation-sensitivity-testing.html#cb218-714" tabindex="-1"></a>            , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb218-715"><a href="watershed-segmentation-sensitivity-testing.html#cb218-715" tabindex="-1"></a>          )</span>
<span id="cb218-716"><a href="watershed-segmentation-sensitivity-testing.html#cb218-716" tabindex="-1"></a>        </span>
<span id="cb218-717"><a href="watershed-segmentation-sensitivity-testing.html#cb218-717" tabindex="-1"></a>        <span class="co"># ##### geom_sets_final row is unique by: set_id,pred_id</span></span>
<span id="cb218-718"><a href="watershed-segmentation-sensitivity-testing.html#cb218-718" tabindex="-1"></a>        <span class="co"># geom_sets_final %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-719"><a href="watershed-segmentation-sensitivity-testing.html#cb218-719" tabindex="-1"></a>        <span class="co"># ggplot() +</span></span>
<span id="cb218-720"><a href="watershed-segmentation-sensitivity-testing.html#cb218-720" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb218-721"><a href="watershed-segmentation-sensitivity-testing.html#cb218-721" tabindex="-1"></a>        <span class="co">#     # post smooth (should be slightly larger)</span></span>
<span id="cb218-722"><a href="watershed-segmentation-sensitivity-testing.html#cb218-722" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final %&gt;% dplyr::filter(set_id == geom_sets_final$set_id[1])</span></span>
<span id="cb218-723"><a href="watershed-segmentation-sensitivity-testing.html#cb218-723" tabindex="-1"></a>        <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb218-724"><a href="watershed-segmentation-sensitivity-testing.html#cb218-724" tabindex="-1"></a>        <span class="co">#     , alpha = 0.8</span></span>
<span id="cb218-725"><a href="watershed-segmentation-sensitivity-testing.html#cb218-725" tabindex="-1"></a>        <span class="co">#     , color = &quot;gray&quot;</span></span>
<span id="cb218-726"><a href="watershed-segmentation-sensitivity-testing.html#cb218-726" tabindex="-1"></a>        <span class="co">#     , lwd = 0.2</span></span>
<span id="cb218-727"><a href="watershed-segmentation-sensitivity-testing.html#cb218-727" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb218-728"><a href="watershed-segmentation-sensitivity-testing.html#cb218-728" tabindex="-1"></a>        <span class="co">#   theme_void()</span></span>
<span id="cb218-729"><a href="watershed-segmentation-sensitivity-testing.html#cb218-729" tabindex="-1"></a>        <span class="co"># ggplot() +</span></span>
<span id="cb218-730"><a href="watershed-segmentation-sensitivity-testing.html#cb218-730" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb218-731"><a href="watershed-segmentation-sensitivity-testing.html#cb218-731" tabindex="-1"></a>        <span class="co">#     # post smooth (should be slightly larger)</span></span>
<span id="cb218-732"><a href="watershed-segmentation-sensitivity-testing.html#cb218-732" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final %&gt;% dplyr::filter(set_id == geom_sets_final$set_id[1])</span></span>
<span id="cb218-733"><a href="watershed-segmentation-sensitivity-testing.html#cb218-733" tabindex="-1"></a>        <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb218-734"><a href="watershed-segmentation-sensitivity-testing.html#cb218-734" tabindex="-1"></a>        <span class="co">#     , alpha = 0.8</span></span>
<span id="cb218-735"><a href="watershed-segmentation-sensitivity-testing.html#cb218-735" tabindex="-1"></a>        <span class="co">#     , color = &quot;gray&quot;</span></span>
<span id="cb218-736"><a href="watershed-segmentation-sensitivity-testing.html#cb218-736" tabindex="-1"></a>        <span class="co">#     , lwd = 0.2</span></span>
<span id="cb218-737"><a href="watershed-segmentation-sensitivity-testing.html#cb218-737" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb218-738"><a href="watershed-segmentation-sensitivity-testing.html#cb218-738" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb218-739"><a href="watershed-segmentation-sensitivity-testing.html#cb218-739" tabindex="-1"></a>        <span class="co">#     # pre-smooth</span></span>
<span id="cb218-740"><a href="watershed-segmentation-sensitivity-testing.html#cb218-740" tabindex="-1"></a>        <span class="co">#     data = geom_sets %&gt;% dplyr::filter(set_id == geom_sets_final$set_id[1])</span></span>
<span id="cb218-741"><a href="watershed-segmentation-sensitivity-testing.html#cb218-741" tabindex="-1"></a>        <span class="co">#     , fill = NA</span></span>
<span id="cb218-742"><a href="watershed-segmentation-sensitivity-testing.html#cb218-742" tabindex="-1"></a>        <span class="co">#     , color = &quot;gold&quot;</span></span>
<span id="cb218-743"><a href="watershed-segmentation-sensitivity-testing.html#cb218-743" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb218-744"><a href="watershed-segmentation-sensitivity-testing.html#cb218-744" tabindex="-1"></a>        <span class="co">#   theme_void()</span></span>
<span id="cb218-745"><a href="watershed-segmentation-sensitivity-testing.html#cb218-745" tabindex="-1"></a>        </span>
<span id="cb218-746"><a href="watershed-segmentation-sensitivity-testing.html#cb218-746" tabindex="-1"></a>        <span class="co"># sf::st_read(&quot;c:/data/usfs/manitou_slash_piles/data/param_combos_piles_chm0.45m.gpkg&quot;) %&gt;% </span></span>
<span id="cb218-747"><a href="watershed-segmentation-sensitivity-testing.html#cb218-747" tabindex="-1"></a>        <span class="co">#   dplyr::mutate(xxxarea_m2 = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb218-748"><a href="watershed-segmentation-sensitivity-testing.html#cb218-748" tabindex="-1"></a>        <span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb218-749"><a href="watershed-segmentation-sensitivity-testing.html#cb218-749" tabindex="-1"></a>        <span class="co">#   dplyr::slice_sample(n=33333) %&gt;% </span></span>
<span id="cb218-750"><a href="watershed-segmentation-sensitivity-testing.html#cb218-750" tabindex="-1"></a>        <span class="co">#   ggplot2::ggplot(mapping = ggplot2::aes(x = xxxarea_m2, y =area_m2)) +</span></span>
<span id="cb218-751"><a href="watershed-segmentation-sensitivity-testing.html#cb218-751" tabindex="-1"></a>        <span class="co">#   ggplot2::geom_abline(lwd = 1) +</span></span>
<span id="cb218-752"><a href="watershed-segmentation-sensitivity-testing.html#cb218-752" tabindex="-1"></a>        <span class="co">#   ggplot2::geom_point() +</span></span>
<span id="cb218-753"><a href="watershed-segmentation-sensitivity-testing.html#cb218-753" tabindex="-1"></a>        <span class="co">#   ggplot2::geom_smooth(method = &quot;lm&quot;, se=F, color = &quot;tomato&quot;, linetype = &quot;dashed&quot;) +</span></span>
<span id="cb218-754"><a href="watershed-segmentation-sensitivity-testing.html#cb218-754" tabindex="-1"></a>        <span class="co">#   ggplot2::scale_color_viridis_c(option = &quot;mako&quot;, direction = -1, alpha = 0.8) +</span></span>
<span id="cb218-755"><a href="watershed-segmentation-sensitivity-testing.html#cb218-755" tabindex="-1"></a>        <span class="co">#   ggplot2::theme_light()</span></span>
<span id="cb218-756"><a href="watershed-segmentation-sensitivity-testing.html#cb218-756" tabindex="-1"></a>          </span>
<span id="cb218-757"><a href="watershed-segmentation-sensitivity-testing.html#cb218-757" tabindex="-1"></a>        </span>
<span id="cb218-758"><a href="watershed-segmentation-sensitivity-testing.html#cb218-758" tabindex="-1"></a>        <span class="co"># ##### geom_sets_final row is unique by: set_id,pred_id</span></span>
<span id="cb218-759"><a href="watershed-segmentation-sensitivity-testing.html#cb218-759" tabindex="-1"></a>        <span class="co"># overlapping convex hull shapes are then removed to prevent false positives from clustered small trees or shrubs</span></span>
<span id="cb218-760"><a href="watershed-segmentation-sensitivity-testing.html#cb218-760" tabindex="-1"></a>        <span class="co"># have to map over this to do overlaps only on one set at a time</span></span>
<span id="cb218-761"><a href="watershed-segmentation-sensitivity-testing.html#cb218-761" tabindex="-1"></a>        geom_sets_final_olaps <span class="ot">&lt;-</span> </span>
<span id="cb218-762"><a href="watershed-segmentation-sensitivity-testing.html#cb218-762" tabindex="-1"></a>            geom_sets_final<span class="sc">$</span>set_id <span class="sc">%&gt;%</span> </span>
<span id="cb218-763"><a href="watershed-segmentation-sensitivity-testing.html#cb218-763" tabindex="-1"></a>            <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-764"><a href="watershed-segmentation-sensitivity-testing.html#cb218-764" tabindex="-1"></a>            purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb218-765"><a href="watershed-segmentation-sensitivity-testing.html#cb218-765" tabindex="-1"></a>              geom_sets_final <span class="sc">%&gt;%</span> </span>
<span id="cb218-766"><a href="watershed-segmentation-sensitivity-testing.html#cb218-766" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb218-767"><a href="watershed-segmentation-sensitivity-testing.html#cb218-767" tabindex="-1"></a>                <span class="fu">st_remove_overlaps</span>()</span>
<span id="cb218-768"><a href="watershed-segmentation-sensitivity-testing.html#cb218-768" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-769"><a href="watershed-segmentation-sensitivity-testing.html#cb218-769" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb218-770"><a href="watershed-segmentation-sensitivity-testing.html#cb218-770" tabindex="-1"></a>          </span>
<span id="cb218-771"><a href="watershed-segmentation-sensitivity-testing.html#cb218-771" tabindex="-1"></a>        <span class="co"># ##### geom_sets_final_olaps row is unique by: set_id,pred_id</span></span>
<span id="cb218-772"><a href="watershed-segmentation-sensitivity-testing.html#cb218-772" tabindex="-1"></a>        <span class="co"># geom_sets_final %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-773"><a href="watershed-segmentation-sensitivity-testing.html#cb218-773" tabindex="-1"></a>        <span class="co"># geom_sets_final_olaps %&gt;% dplyr::glimpse()</span></span>
<span id="cb218-774"><a href="watershed-segmentation-sensitivity-testing.html#cb218-774" tabindex="-1"></a>        <span class="co"># ggplot() +</span></span>
<span id="cb218-775"><a href="watershed-segmentation-sensitivity-testing.html#cb218-775" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb218-776"><a href="watershed-segmentation-sensitivity-testing.html#cb218-776" tabindex="-1"></a>        <span class="co">#     # post smooth (should be slightly larger)</span></span>
<span id="cb218-777"><a href="watershed-segmentation-sensitivity-testing.html#cb218-777" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final_olaps %&gt;% dplyr::filter(set_id == geom_sets_final_olaps$set_id[1])</span></span>
<span id="cb218-778"><a href="watershed-segmentation-sensitivity-testing.html#cb218-778" tabindex="-1"></a>        <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb218-779"><a href="watershed-segmentation-sensitivity-testing.html#cb218-779" tabindex="-1"></a>        <span class="co">#     , alpha = 0.8</span></span>
<span id="cb218-780"><a href="watershed-segmentation-sensitivity-testing.html#cb218-780" tabindex="-1"></a>        <span class="co">#     , color = &quot;gray&quot;</span></span>
<span id="cb218-781"><a href="watershed-segmentation-sensitivity-testing.html#cb218-781" tabindex="-1"></a>        <span class="co">#     , lwd = 0.2</span></span>
<span id="cb218-782"><a href="watershed-segmentation-sensitivity-testing.html#cb218-782" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb218-783"><a href="watershed-segmentation-sensitivity-testing.html#cb218-783" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb218-784"><a href="watershed-segmentation-sensitivity-testing.html#cb218-784" tabindex="-1"></a>        <span class="co">#     # pre-smooth</span></span>
<span id="cb218-785"><a href="watershed-segmentation-sensitivity-testing.html#cb218-785" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final %&gt;% dplyr::filter(set_id == geom_sets_final_olaps$set_id[1])</span></span>
<span id="cb218-786"><a href="watershed-segmentation-sensitivity-testing.html#cb218-786" tabindex="-1"></a>        <span class="co">#     , fill = NA</span></span>
<span id="cb218-787"><a href="watershed-segmentation-sensitivity-testing.html#cb218-787" tabindex="-1"></a>        <span class="co">#     , color = &quot;gold&quot;</span></span>
<span id="cb218-788"><a href="watershed-segmentation-sensitivity-testing.html#cb218-788" tabindex="-1"></a>        <span class="co">#     , lwd = 1</span></span>
<span id="cb218-789"><a href="watershed-segmentation-sensitivity-testing.html#cb218-789" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb218-790"><a href="watershed-segmentation-sensitivity-testing.html#cb218-790" tabindex="-1"></a>        <span class="co">#   theme_void()</span></span>
<span id="cb218-791"><a href="watershed-segmentation-sensitivity-testing.html#cb218-791" tabindex="-1"></a>        </span>
<span id="cb218-792"><a href="watershed-segmentation-sensitivity-testing.html#cb218-792" tabindex="-1"></a>        </span>
<span id="cb218-793"><a href="watershed-segmentation-sensitivity-testing.html#cb218-793" tabindex="-1"></a>        <span class="co"># join back to param_combos list</span></span>
<span id="cb218-794"><a href="watershed-segmentation-sensitivity-testing.html#cb218-794" tabindex="-1"></a>        final_ans <span class="ot">&lt;-</span> geom_sets_final_olaps <span class="sc">%&gt;%</span> </span>
<span id="cb218-795"><a href="watershed-segmentation-sensitivity-testing.html#cb218-795" tabindex="-1"></a>          <span class="co"># join to lookup</span></span>
<span id="cb218-796"><a href="watershed-segmentation-sensitivity-testing.html#cb218-796" tabindex="-1"></a>          <span class="co"># expands row to unique by set_id,rn,pred_id</span></span>
<span id="cb218-797"><a href="watershed-segmentation-sensitivity-testing.html#cb218-797" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-798"><a href="watershed-segmentation-sensitivity-testing.html#cb218-798" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb218-799"><a href="watershed-segmentation-sensitivity-testing.html#cb218-799" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb218-800"><a href="watershed-segmentation-sensitivity-testing.html#cb218-800" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id)</span>
<span id="cb218-801"><a href="watershed-segmentation-sensitivity-testing.html#cb218-801" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb218-802"><a href="watershed-segmentation-sensitivity-testing.html#cb218-802" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-803"><a href="watershed-segmentation-sensitivity-testing.html#cb218-803" tabindex="-1"></a>          <span class="co"># join with filtered_final which have pred_id</span></span>
<span id="cb218-804"><a href="watershed-segmentation-sensitivity-testing.html#cb218-804" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-805"><a href="watershed-segmentation-sensitivity-testing.html#cb218-805" tabindex="-1"></a>            filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb218-806"><a href="watershed-segmentation-sensitivity-testing.html#cb218-806" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-807"><a href="watershed-segmentation-sensitivity-testing.html#cb218-807" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb218-808"><a href="watershed-segmentation-sensitivity-testing.html#cb218-808" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb218-809"><a href="watershed-segmentation-sensitivity-testing.html#cb218-809" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb218-810"><a href="watershed-segmentation-sensitivity-testing.html#cb218-810" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-811"><a href="watershed-segmentation-sensitivity-testing.html#cb218-811" tabindex="-1"></a>          <span class="co"># add param_combos_df data</span></span>
<span id="cb218-812"><a href="watershed-segmentation-sensitivity-testing.html#cb218-812" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-813"><a href="watershed-segmentation-sensitivity-testing.html#cb218-813" tabindex="-1"></a>            param_combos_df</span>
<span id="cb218-814"><a href="watershed-segmentation-sensitivity-testing.html#cb218-814" tabindex="-1"></a>            , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb218-815"><a href="watershed-segmentation-sensitivity-testing.html#cb218-815" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-one&quot;</span></span>
<span id="cb218-816"><a href="watershed-segmentation-sensitivity-testing.html#cb218-816" tabindex="-1"></a>          )</span>
<span id="cb218-817"><a href="watershed-segmentation-sensitivity-testing.html#cb218-817" tabindex="-1"></a>        </span>
<span id="cb218-818"><a href="watershed-segmentation-sensitivity-testing.html#cb218-818" tabindex="-1"></a>        <span class="co"># nrow(filtered_final)</span></span>
<span id="cb218-819"><a href="watershed-segmentation-sensitivity-testing.html#cb218-819" tabindex="-1"></a>        <span class="co"># nrow(final_ans) # should be less</span></span>
<span id="cb218-820"><a href="watershed-segmentation-sensitivity-testing.html#cb218-820" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb218-821"><a href="watershed-segmentation-sensitivity-testing.html#cb218-821" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;diametering.....&quot;</span>)</span>
<span id="cb218-822"><a href="watershed-segmentation-sensitivity-testing.html#cb218-822" tabindex="-1"></a>        <span class="do">##### just work with unique polygons</span></span>
<span id="cb218-823"><a href="watershed-segmentation-sensitivity-testing.html#cb218-823" tabindex="-1"></a>        <span class="do">##### geom_sets_smooth row is unique by: set_id,pred_id</span></span>
<span id="cb218-824"><a href="watershed-segmentation-sensitivity-testing.html#cb218-824" tabindex="-1"></a>        geom_sets_final <span class="ot">&lt;-</span> geom_sets_smooth <span class="sc">%&gt;%</span> </span>
<span id="cb218-825"><a href="watershed-segmentation-sensitivity-testing.html#cb218-825" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb218-826"><a href="watershed-segmentation-sensitivity-testing.html#cb218-826" tabindex="-1"></a>            <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb218-827"><a href="watershed-segmentation-sensitivity-testing.html#cb218-827" tabindex="-1"></a>            , <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb218-828"><a href="watershed-segmentation-sensitivity-testing.html#cb218-828" tabindex="-1"></a>          ))) <span class="sc">%&gt;%</span> </span>
<span id="cb218-829"><a href="watershed-segmentation-sensitivity-testing.html#cb218-829" tabindex="-1"></a>          <span class="co"># join to filter geoms</span></span>
<span id="cb218-830"><a href="watershed-segmentation-sensitivity-testing.html#cb218-830" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-831"><a href="watershed-segmentation-sensitivity-testing.html#cb218-831" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb218-832"><a href="watershed-segmentation-sensitivity-testing.html#cb218-832" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-833"><a href="watershed-segmentation-sensitivity-testing.html#cb218-833" tabindex="-1"></a>                filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb218-834"><a href="watershed-segmentation-sensitivity-testing.html#cb218-834" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-835"><a href="watershed-segmentation-sensitivity-testing.html#cb218-835" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb218-836"><a href="watershed-segmentation-sensitivity-testing.html#cb218-836" tabindex="-1"></a>                , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn)</span>
<span id="cb218-837"><a href="watershed-segmentation-sensitivity-testing.html#cb218-837" tabindex="-1"></a>                , <span class="at">relationship =</span> <span class="st">&quot;one-to-many&quot;</span></span>
<span id="cb218-838"><a href="watershed-segmentation-sensitivity-testing.html#cb218-838" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-839"><a href="watershed-segmentation-sensitivity-testing.html#cb218-839" tabindex="-1"></a>              <span class="co"># just get the unique geoms now</span></span>
<span id="cb218-840"><a href="watershed-segmentation-sensitivity-testing.html#cb218-840" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(set_id,pred_id)</span>
<span id="cb218-841"><a href="watershed-segmentation-sensitivity-testing.html#cb218-841" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id,pred_id)</span>
<span id="cb218-842"><a href="watershed-segmentation-sensitivity-testing.html#cb218-842" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb218-843"><a href="watershed-segmentation-sensitivity-testing.html#cb218-843" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-844"><a href="watershed-segmentation-sensitivity-testing.html#cb218-844" tabindex="-1"></a>          <span class="co"># diameter</span></span>
<span id="cb218-845"><a href="watershed-segmentation-sensitivity-testing.html#cb218-845" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb218-846"><a href="watershed-segmentation-sensitivity-testing.html#cb218-846" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb218-847"><a href="watershed-segmentation-sensitivity-testing.html#cb218-847" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diameter_m =</span> <span class="fu">st_calculate_diameter</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb218-848"><a href="watershed-segmentation-sensitivity-testing.html#cb218-848" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb218-849"><a href="watershed-segmentation-sensitivity-testing.html#cb218-849" tabindex="-1"></a>        </span>
<span id="cb218-850"><a href="watershed-segmentation-sensitivity-testing.html#cb218-850" tabindex="-1"></a>        <span class="co"># join back to param_combos list</span></span>
<span id="cb218-851"><a href="watershed-segmentation-sensitivity-testing.html#cb218-851" tabindex="-1"></a>        final_ans <span class="ot">&lt;-</span> geom_sets_final <span class="sc">%&gt;%</span> </span>
<span id="cb218-852"><a href="watershed-segmentation-sensitivity-testing.html#cb218-852" tabindex="-1"></a>          <span class="co"># join to lookup</span></span>
<span id="cb218-853"><a href="watershed-segmentation-sensitivity-testing.html#cb218-853" tabindex="-1"></a>          <span class="co"># expands row to unique by set_id,rn,pred_id</span></span>
<span id="cb218-854"><a href="watershed-segmentation-sensitivity-testing.html#cb218-854" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-855"><a href="watershed-segmentation-sensitivity-testing.html#cb218-855" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb218-856"><a href="watershed-segmentation-sensitivity-testing.html#cb218-856" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb218-857"><a href="watershed-segmentation-sensitivity-testing.html#cb218-857" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id)</span>
<span id="cb218-858"><a href="watershed-segmentation-sensitivity-testing.html#cb218-858" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb218-859"><a href="watershed-segmentation-sensitivity-testing.html#cb218-859" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-860"><a href="watershed-segmentation-sensitivity-testing.html#cb218-860" tabindex="-1"></a>          <span class="co"># join with filtered_final which have pred_id</span></span>
<span id="cb218-861"><a href="watershed-segmentation-sensitivity-testing.html#cb218-861" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-862"><a href="watershed-segmentation-sensitivity-testing.html#cb218-862" tabindex="-1"></a>            filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb218-863"><a href="watershed-segmentation-sensitivity-testing.html#cb218-863" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-864"><a href="watershed-segmentation-sensitivity-testing.html#cb218-864" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb218-865"><a href="watershed-segmentation-sensitivity-testing.html#cb218-865" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb218-866"><a href="watershed-segmentation-sensitivity-testing.html#cb218-866" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb218-867"><a href="watershed-segmentation-sensitivity-testing.html#cb218-867" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-868"><a href="watershed-segmentation-sensitivity-testing.html#cb218-868" tabindex="-1"></a>          <span class="co"># add param_combos_df data</span></span>
<span id="cb218-869"><a href="watershed-segmentation-sensitivity-testing.html#cb218-869" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb218-870"><a href="watershed-segmentation-sensitivity-testing.html#cb218-870" tabindex="-1"></a>            param_combos_df</span>
<span id="cb218-871"><a href="watershed-segmentation-sensitivity-testing.html#cb218-871" tabindex="-1"></a>            , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb218-872"><a href="watershed-segmentation-sensitivity-testing.html#cb218-872" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-one&quot;</span></span>
<span id="cb218-873"><a href="watershed-segmentation-sensitivity-testing.html#cb218-873" tabindex="-1"></a>          )</span>
<span id="cb218-874"><a href="watershed-segmentation-sensitivity-testing.html#cb218-874" tabindex="-1"></a>        </span>
<span id="cb218-875"><a href="watershed-segmentation-sensitivity-testing.html#cb218-875" tabindex="-1"></a>      }</span>
<span id="cb218-876"><a href="watershed-segmentation-sensitivity-testing.html#cb218-876" tabindex="-1"></a>      </span>
<span id="cb218-877"><a href="watershed-segmentation-sensitivity-testing.html#cb218-877" tabindex="-1"></a>      <span class="cf">if</span>(stringr<span class="sc">::</span><span class="fu">str_length</span>(ofile)<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb218-878"><a href="watershed-segmentation-sensitivity-testing.html#cb218-878" tabindex="-1"></a>        final_ans <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_write</span>(ofile, <span class="at">append =</span> F, <span class="at">quiet =</span> T)</span>
<span id="cb218-879"><a href="watershed-segmentation-sensitivity-testing.html#cb218-879" tabindex="-1"></a>      }</span>
<span id="cb218-880"><a href="watershed-segmentation-sensitivity-testing.html#cb218-880" tabindex="-1"></a>      </span>
<span id="cb218-881"><a href="watershed-segmentation-sensitivity-testing.html#cb218-881" tabindex="-1"></a>    <span class="co"># return</span></span>
<span id="cb218-882"><a href="watershed-segmentation-sensitivity-testing.html#cb218-882" tabindex="-1"></a>      <span class="fu">return</span>(final_ans)</span>
<span id="cb218-883"><a href="watershed-segmentation-sensitivity-testing.html#cb218-883" tabindex="-1"></a>}</span>
<span id="cb218-884"><a href="watershed-segmentation-sensitivity-testing.html#cb218-884" tabindex="-1"></a></span>
<span id="cb218-885"><a href="watershed-segmentation-sensitivity-testing.html#cb218-885" tabindex="-1"></a><span class="co"># param_combos_piles &lt;- </span></span>
<span id="cb218-886"><a href="watershed-segmentation-sensitivity-testing.html#cb218-886" tabindex="-1"></a><span class="co">#   param_combos_df$rn %&gt;% </span></span>
<span id="cb218-887"><a href="watershed-segmentation-sensitivity-testing.html#cb218-887" tabindex="-1"></a><span class="co">#   # sample(3) %&gt;% ## !!!!!!!!!!!!!!!!!!!! remove after testing</span></span>
<span id="cb218-888"><a href="watershed-segmentation-sensitivity-testing.html#cb218-888" tabindex="-1"></a><span class="co">#   purrr::map(\(x)</span></span>
<span id="cb218-889"><a href="watershed-segmentation-sensitivity-testing.html#cb218-889" tabindex="-1"></a><span class="co">#     slash_pile_detect_watershed(</span></span>
<span id="cb218-890"><a href="watershed-segmentation-sensitivity-testing.html#cb218-890" tabindex="-1"></a><span class="co">#         chm_rast = cloud2raster_ans$chm_rast</span></span>
<span id="cb218-891"><a href="watershed-segmentation-sensitivity-testing.html#cb218-891" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_df$max_ht_m[x]</span></span>
<span id="cb218-892"><a href="watershed-segmentation-sensitivity-testing.html#cb218-892" tabindex="-1"></a><span class="co">#         , min_area_m2 = param_combos_df$min_area_m2[x]</span></span>
<span id="cb218-893"><a href="watershed-segmentation-sensitivity-testing.html#cb218-893" tabindex="-1"></a><span class="co">#         , max_area_m2 = param_combos_df$max_area_m2[x]</span></span>
<span id="cb218-894"><a href="watershed-segmentation-sensitivity-testing.html#cb218-894" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_df$convexity_pct[x]</span></span>
<span id="cb218-895"><a href="watershed-segmentation-sensitivity-testing.html#cb218-895" tabindex="-1"></a><span class="co">#         , circle_fit_iou_pct = param_combos_df$circle_fit_iou_pct[x]</span></span>
<span id="cb218-896"><a href="watershed-segmentation-sensitivity-testing.html#cb218-896" tabindex="-1"></a><span class="co">#       ) %&gt;% </span></span>
<span id="cb218-897"><a href="watershed-segmentation-sensitivity-testing.html#cb218-897" tabindex="-1"></a><span class="co">#       dplyr::mutate(</span></span>
<span id="cb218-898"><a href="watershed-segmentation-sensitivity-testing.html#cb218-898" tabindex="-1"></a><span class="co">#         rn = param_combos_df$rn[x]</span></span>
<span id="cb218-899"><a href="watershed-segmentation-sensitivity-testing.html#cb218-899" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_df$max_ht_m[x]</span></span>
<span id="cb218-900"><a href="watershed-segmentation-sensitivity-testing.html#cb218-900" tabindex="-1"></a><span class="co">#         , min_area_m2 = param_combos_df$min_area_m2[x]</span></span>
<span id="cb218-901"><a href="watershed-segmentation-sensitivity-testing.html#cb218-901" tabindex="-1"></a><span class="co">#         , max_area_m2 = param_combos_df$max_area_m2[x]</span></span>
<span id="cb218-902"><a href="watershed-segmentation-sensitivity-testing.html#cb218-902" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_df$convexity_pct[x]</span></span>
<span id="cb218-903"><a href="watershed-segmentation-sensitivity-testing.html#cb218-903" tabindex="-1"></a><span class="co">#         , circle_fit_iou_pct = param_combos_df$circle_fit_iou_pct[x]</span></span>
<span id="cb218-904"><a href="watershed-segmentation-sensitivity-testing.html#cb218-904" tabindex="-1"></a><span class="co">#       )</span></span>
<span id="cb218-905"><a href="watershed-segmentation-sensitivity-testing.html#cb218-905" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb218-906"><a href="watershed-segmentation-sensitivity-testing.html#cb218-906" tabindex="-1"></a><span class="co">#   dplyr::bind_rows()</span></span>
<span id="cb218-907"><a href="watershed-segmentation-sensitivity-testing.html#cb218-907" tabindex="-1"></a></span>
<span id="cb218-908"><a href="watershed-segmentation-sensitivity-testing.html#cb218-908" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% </span></span>
<span id="cb218-909"><a href="watershed-segmentation-sensitivity-testing.html#cb218-909" tabindex="-1"></a><span class="co">#   sf::st_write(&quot;../data/param_combos_piles.gpkg&quot;, append = F)</span></span>
<span id="cb218-910"><a href="watershed-segmentation-sensitivity-testing.html#cb218-910" tabindex="-1"></a><span class="co"># # param_combos_piles &lt;- sf::st_read(&quot;../data/param_combos_piles.gpkg&quot;)</span></span></code></pre></div>
<p>apply our function using the data frame of the parameter combinations</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="watershed-segmentation-sensitivity-testing.html#cb219-1" tabindex="-1"></a>f_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/param_combos_piles.gpkg&quot;</span></span>
<span id="cb219-2"><a href="watershed-segmentation-sensitivity-testing.html#cb219-2" tabindex="-1"></a>  <span class="co"># &quot;f:/PFDP_Data/sens_test_param_combos/param_combos_piles.gpkg&quot;</span></span>
<span id="cb219-3"><a href="watershed-segmentation-sensitivity-testing.html#cb219-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(f_temp)){</span>
<span id="cb219-4"><a href="watershed-segmentation-sensitivity-testing.html#cb219-4" tabindex="-1"></a>  param_combos_piles <span class="ot">&lt;-</span> <span class="fu">param_combos_piles_detect_fn</span>(</span>
<span id="cb219-5"><a href="watershed-segmentation-sensitivity-testing.html#cb219-5" tabindex="-1"></a>    <span class="at">chm =</span> cloud2raster_ans<span class="sc">$</span>chm_rast</span>
<span id="cb219-6"><a href="watershed-segmentation-sensitivity-testing.html#cb219-6" tabindex="-1"></a>    , <span class="at">param_combos_df =</span> param_combos_df</span>
<span id="cb219-7"><a href="watershed-segmentation-sensitivity-testing.html#cb219-7" tabindex="-1"></a>    , <span class="at">smooth_segs =</span> T</span>
<span id="cb219-8"><a href="watershed-segmentation-sensitivity-testing.html#cb219-8" tabindex="-1"></a>    , <span class="at">ofile =</span> f_temp</span>
<span id="cb219-9"><a href="watershed-segmentation-sensitivity-testing.html#cb219-9" tabindex="-1"></a>  )</span>
<span id="cb219-10"><a href="watershed-segmentation-sensitivity-testing.html#cb219-10" tabindex="-1"></a>  <span class="co"># param_combos_piles %&gt;% dplyr::glimpse()</span></span>
<span id="cb219-11"><a href="watershed-segmentation-sensitivity-testing.html#cb219-11" tabindex="-1"></a>  </span>
<span id="cb219-12"><a href="watershed-segmentation-sensitivity-testing.html#cb219-12" tabindex="-1"></a>  <span class="co"># save it</span></span>
<span id="cb219-13"><a href="watershed-segmentation-sensitivity-testing.html#cb219-13" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(param_combos_piles, f_temp, <span class="at">append =</span> F, <span class="at">quiet =</span> T)</span>
<span id="cb219-14"><a href="watershed-segmentation-sensitivity-testing.html#cb219-14" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb219-15"><a href="watershed-segmentation-sensitivity-testing.html#cb219-15" tabindex="-1"></a>  param_combos_piles <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(f_temp, <span class="at">quiet =</span> T)</span>
<span id="cb219-16"><a href="watershed-segmentation-sensitivity-testing.html#cb219-16" tabindex="-1"></a>}</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="watershed-segmentation-sensitivity-testing.html#cb220-1" tabindex="-1"></a>param_combos_piles <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 451,567
## Columns: 14
## $ rn                 &lt;int&gt; 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 2…
## $ max_ht_m           &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ min_area_m2        &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ max_area_m2        &lt;dbl&gt; 70, 70, 70, 70, 70, 70, 70, 70, 70, 70, 70, 70, 70,…
## $ convexity_pct      &lt;dbl&gt; 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0…
## $ circle_fit_iou_pct &lt;dbl&gt; 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0…
## $ pred_id            &lt;dbl&gt; 14, 16, 17, 22, 24, 25, 27, 32, 33, 39, 40, 57, 61,…
## $ area_m2            &lt;dbl&gt; 4.403522, 24.059243, 8.446756, 16.252999, 35.588464…
## $ volume_m3          &lt;dbl&gt; 6.930014, 30.282873, 7.859209, 15.506141, 37.801728…
## $ max_height_m       &lt;dbl&gt; 2.000, 2.000, 2.000, 2.000, 2.000, 2.000, 2.000, 2.…
## $ volume_per_area    &lt;dbl&gt; 1.5737435, 1.2586794, 0.9304411, 0.9540480, 1.06219…
## $ diameter_m         &lt;dbl&gt; 3.492850, 6.997142, 3.720215, 5.813777, 8.765843, 4…
## $ pct_chull          &lt;dbl&gt; 0.9282700, 0.8301105, 0.9254386, 0.8962472, 0.74674…
## $ geom               &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((499573.2 43..., MULTIP…</code></pre>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="watershed-segmentation-sensitivity-testing.html#cb222-1" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(rn) %&gt;% dplyr::slice_head(n=6)</span></span>
<span id="cb222-2"><a href="watershed-segmentation-sensitivity-testing.html#cb222-2" tabindex="-1"></a><span class="co"># terra::plot(cloud2raster_ans$chm_rast, col = viridis::plasma(100), axes = F)</span></span>
<span id="cb222-3"><a href="watershed-segmentation-sensitivity-testing.html#cb222-3" tabindex="-1"></a><span class="co"># terra::plot(param_combos_piles %&gt;% dplyr::filter(rn==param_combos_piles$rn[2222]) %&gt;% terra::vect(),add = T, border = &quot;gray44&quot;, col = NA, lwd = 3)</span></span></code></pre></div>
</div>
<div id="validation-over-parameter-combinations" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Validation over parameter combinations<a href="watershed-segmentation-sensitivity-testing.html#validation-over-parameter-combinations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>now we need to validate these combinations against the ground truth data and we can map over the <code>ground_truth_prediction_match()</code> function to get true positive, false positive (commission), and false negative (omission) classifications for the predicted and ground truth piles</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="watershed-segmentation-sensitivity-testing.html#cb223-1" tabindex="-1"></a>f_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/param_combos_gt.csv&quot;</span></span>
<span id="cb223-2"><a href="watershed-segmentation-sensitivity-testing.html#cb223-2" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(f_temp)){</span>
<span id="cb223-3"><a href="watershed-segmentation-sensitivity-testing.html#cb223-3" tabindex="-1"></a>  param_combos_gt <span class="ot">&lt;-</span> </span>
<span id="cb223-4"><a href="watershed-segmentation-sensitivity-testing.html#cb223-4" tabindex="-1"></a>    <span class="fu">unique</span>(param_combos_df<span class="sc">$</span>rn) <span class="sc">%&gt;%</span> </span>
<span id="cb223-5"><a href="watershed-segmentation-sensitivity-testing.html#cb223-5" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb223-6"><a href="watershed-segmentation-sensitivity-testing.html#cb223-6" tabindex="-1"></a>      <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb223-7"><a href="watershed-segmentation-sensitivity-testing.html#cb223-7" tabindex="-1"></a>        <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb223-8"><a href="watershed-segmentation-sensitivity-testing.html#cb223-8" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb223-9"><a href="watershed-segmentation-sensitivity-testing.html#cb223-9" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb223-10"><a href="watershed-segmentation-sensitivity-testing.html#cb223-10" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb223-11"><a href="watershed-segmentation-sensitivity-testing.html#cb223-11" tabindex="-1"></a>        , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb223-12"><a href="watershed-segmentation-sensitivity-testing.html#cb223-12" tabindex="-1"></a>        , <span class="at">predictions =</span> param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb223-13"><a href="watershed-segmentation-sensitivity-testing.html#cb223-13" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb223-14"><a href="watershed-segmentation-sensitivity-testing.html#cb223-14" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb223-15"><a href="watershed-segmentation-sensitivity-testing.html#cb223-15" tabindex="-1"></a>            pred_id <span class="sc">%in%</span> (param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb223-16"><a href="watershed-segmentation-sensitivity-testing.html#cb223-16" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb223-17"><a href="watershed-segmentation-sensitivity-testing.html#cb223-17" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb223-18"><a href="watershed-segmentation-sensitivity-testing.html#cb223-18" tabindex="-1"></a>                stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb223-19"><a href="watershed-segmentation-sensitivity-testing.html#cb223-19" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb223-20"><a href="watershed-segmentation-sensitivity-testing.html#cb223-20" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb223-21"><a href="watershed-segmentation-sensitivity-testing.html#cb223-21" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb223-22"><a href="watershed-segmentation-sensitivity-testing.html#cb223-22" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id))</span>
<span id="cb223-23"><a href="watershed-segmentation-sensitivity-testing.html#cb223-23" tabindex="-1"></a>          )</span>
<span id="cb223-24"><a href="watershed-segmentation-sensitivity-testing.html#cb223-24" tabindex="-1"></a>        , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb223-25"><a href="watershed-segmentation-sensitivity-testing.html#cb223-25" tabindex="-1"></a>        , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb223-26"><a href="watershed-segmentation-sensitivity-testing.html#cb223-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb223-27"><a href="watershed-segmentation-sensitivity-testing.html#cb223-27" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn=</span>x)</span>
<span id="cb223-28"><a href="watershed-segmentation-sensitivity-testing.html#cb223-28" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb223-29"><a href="watershed-segmentation-sensitivity-testing.html#cb223-29" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb223-30"><a href="watershed-segmentation-sensitivity-testing.html#cb223-30" tabindex="-1"></a>  param_combos_gt <span class="sc">%&gt;%</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(f_temp, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span>
<span id="cb223-31"><a href="watershed-segmentation-sensitivity-testing.html#cb223-31" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb223-32"><a href="watershed-segmentation-sensitivity-testing.html#cb223-32" tabindex="-1"></a>  param_combos_gt <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(f_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb223-33"><a href="watershed-segmentation-sensitivity-testing.html#cb223-33" tabindex="-1"></a>}</span>
<span id="cb223-34"><a href="watershed-segmentation-sensitivity-testing.html#cb223-34" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb223-35"><a href="watershed-segmentation-sensitivity-testing.html#cb223-35" tabindex="-1"></a>param_combos_gt <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span>
<span id="cb223-36"><a href="watershed-segmentation-sensitivity-testing.html#cb223-36" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::filter(pile_id==120)</span></span></code></pre></div>
<p>to evaluate the method’s ability to properly quantify slash pile form, we will perform a detailed comparison between our predicted data and ground truth measurements. the process involves a series of calculations and comparisons:</p>
<p><strong>1) Data Preparation and Pile Measurement Quantification:</strong></p>
<p>first, we will prepare the data by isolating only those piles that intersect with the stand boundary. next, we will perform the following form quantification calculations:</p>
<ul>
<li><strong>ground truth piles</strong>
<ul>
<li><strong>area</strong> assumes a perfectly circular base using the field-measured diameter</li>
<li><strong>volume</strong> assumes a paraboloid shape, with volume calculated using the field-measured diameter (as the width) and height</li>
</ul></li>
<li><strong>predicted piles</strong>
<ul>
<li><strong>height</strong> calculated as the maximum height from the height-filtered CHM “slice”</li>
<li><strong>diameter</strong> calculated as the maximum internal distance of the segment’s polygon, which identifies the longest straight line that can be drawn between any two points within the pile’s footprint.</li>
<li><strong>volume (irregular)</strong> calculated from the elevation profile of the pile segment’s footprint, without assuming a specific geometric shape.</li>
<li><strong>area</strong> calculated from the irregular shape of the pile segment detected by the raster-based watershed method</li>
</ul></li>
</ul>
<p><strong>2) Form Quantification Accuracy Evaluation:</strong></p>
<p>after these measurements are quantified, we will assess the method’s accuracy by comparing the true-positive matches using the following metrics:</p>
<ul>
<li><strong>Volume</strong> compares the predicted volume from the irregular elevation profile and footprint to the ground truth paraboloid volume</li>
<li><strong>Diameter</strong> compares the predicted diameter (from the maximum internal distance) to the ground truth field-measured diameter.</li>
<li><strong>Area</strong> compares the predicted area from the irregular shape to the ground truth assumed circular area</li>
<li><strong>Height</strong> compares the predicted maximum height from the CHM to the ground truth field-measured height</li>
</ul>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="watershed-segmentation-sensitivity-testing.html#cb224-1" tabindex="-1"></a><span class="co"># let&#39;s attach a flag to only work with piles that intersect with the stand boundary</span></span>
<span id="cb224-2"><a href="watershed-segmentation-sensitivity-testing.html#cb224-2" tabindex="-1"></a><span class="co"># and caclulate the &quot;diameter&quot; of the piles</span></span>
<span id="cb224-3"><a href="watershed-segmentation-sensitivity-testing.html#cb224-3" tabindex="-1"></a><span class="co"># add in/out to piles data</span></span>
<span id="cb224-4"><a href="watershed-segmentation-sensitivity-testing.html#cb224-4" tabindex="-1"></a>param_combos_piles <span class="ot">&lt;-</span> param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb224-5"><a href="watershed-segmentation-sensitivity-testing.html#cb224-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb224-6"><a href="watershed-segmentation-sensitivity-testing.html#cb224-6" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb224-7"><a href="watershed-segmentation-sensitivity-testing.html#cb224-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb224-8"><a href="watershed-segmentation-sensitivity-testing.html#cb224-8" tabindex="-1"></a>        stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb224-9"><a href="watershed-segmentation-sensitivity-testing.html#cb224-9" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb224-10"><a href="watershed-segmentation-sensitivity-testing.html#cb224-10" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-11"><a href="watershed-segmentation-sensitivity-testing.html#cb224-11" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb224-12"><a href="watershed-segmentation-sensitivity-testing.html#cb224-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(rn,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb224-13"><a href="watershed-segmentation-sensitivity-testing.html#cb224-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_in_stand =</span> T)</span>
<span id="cb224-14"><a href="watershed-segmentation-sensitivity-testing.html#cb224-14" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb224-15"><a href="watershed-segmentation-sensitivity-testing.html#cb224-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-16"><a href="watershed-segmentation-sensitivity-testing.html#cb224-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-17"><a href="watershed-segmentation-sensitivity-testing.html#cb224-17" tabindex="-1"></a>    <span class="at">is_in_stand =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_in_stand,F)</span>
<span id="cb224-18"><a href="watershed-segmentation-sensitivity-testing.html#cb224-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-19"><a href="watershed-segmentation-sensitivity-testing.html#cb224-19" tabindex="-1"></a>  <span class="co"># get the length (diameter) and width of the polygon</span></span>
<span id="cb224-20"><a href="watershed-segmentation-sensitivity-testing.html#cb224-20" tabindex="-1"></a>  <span class="co"># st_bbox_by_row(dimensions = T) %&gt;% # gets shape_length, where shape_length=length of longest bbox side</span></span>
<span id="cb224-21"><a href="watershed-segmentation-sensitivity-testing.html#cb224-21" tabindex="-1"></a>  <span class="co"># and paraboloid volume</span></span>
<span id="cb224-22"><a href="watershed-segmentation-sensitivity-testing.html#cb224-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-23"><a href="watershed-segmentation-sensitivity-testing.html#cb224-23" tabindex="-1"></a>    <span class="co"># paraboloid_volume_m3 = (1/8) * pi * (shape_length^2) * max_height_m</span></span>
<span id="cb224-24"><a href="watershed-segmentation-sensitivity-testing.html#cb224-24" tabindex="-1"></a>    <span class="at">paraboloid_volume_m3 =</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>) <span class="sc">*</span> pi <span class="sc">*</span> (diameter_m<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> max_height_m</span>
<span id="cb224-25"><a href="watershed-segmentation-sensitivity-testing.html#cb224-25" tabindex="-1"></a>  )</span>
<span id="cb224-26"><a href="watershed-segmentation-sensitivity-testing.html#cb224-26" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% dplyr::glimpse()</span></span>
<span id="cb224-27"><a href="watershed-segmentation-sensitivity-testing.html#cb224-27" tabindex="-1"></a></span>
<span id="cb224-28"><a href="watershed-segmentation-sensitivity-testing.html#cb224-28" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% </span></span>
<span id="cb224-29"><a href="watershed-segmentation-sensitivity-testing.html#cb224-29" tabindex="-1"></a><span class="co">#   ggplot2::ggplot(mapping=ggplot2::aes(x=area_m2)) + </span></span>
<span id="cb224-30"><a href="watershed-segmentation-sensitivity-testing.html#cb224-30" tabindex="-1"></a><span class="co">#   geom_boxplot() +</span></span>
<span id="cb224-31"><a href="watershed-segmentation-sensitivity-testing.html#cb224-31" tabindex="-1"></a><span class="co">#   facet_wrap(facets = vars(max_area_m2), scales = &quot;free_x&quot;)</span></span>
<span id="cb224-32"><a href="watershed-segmentation-sensitivity-testing.html#cb224-32" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb224-33"><a href="watershed-segmentation-sensitivity-testing.html#cb224-33" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% sf::st_drop_geometry() %&gt;% dplyr::group_by(max_area_m2) %&gt;% dplyr::summarise(min = min(area_m2,na.rm=T),max = max(area_m2,na.rm=T))</span></span>
<span id="cb224-34"><a href="watershed-segmentation-sensitivity-testing.html#cb224-34" tabindex="-1"></a></span>
<span id="cb224-35"><a href="watershed-segmentation-sensitivity-testing.html#cb224-35" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% dplyr::glimpse()</span></span>
<span id="cb224-36"><a href="watershed-segmentation-sensitivity-testing.html#cb224-36" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::glimpse()</span></span>
<span id="cb224-37"><a href="watershed-segmentation-sensitivity-testing.html#cb224-37" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::slice_sample(prop = 0.05) %&gt;% dplyr::count(match_grp)</span></span>
<span id="cb224-38"><a href="watershed-segmentation-sensitivity-testing.html#cb224-38" tabindex="-1"></a><span class="co"># add it to validation</span></span>
<span id="cb224-39"><a href="watershed-segmentation-sensitivity-testing.html#cb224-39" tabindex="-1"></a>param_combos_gt <span class="ot">&lt;-</span></span>
<span id="cb224-40"><a href="watershed-segmentation-sensitivity-testing.html#cb224-40" tabindex="-1"></a>  param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb224-41"><a href="watershed-segmentation-sensitivity-testing.html#cb224-41" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id =</span> <span class="fu">as.numeric</span>(pile_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb224-42"><a href="watershed-segmentation-sensitivity-testing.html#cb224-42" tabindex="-1"></a>  <span class="co"># add area of gt</span></span>
<span id="cb224-43"><a href="watershed-segmentation-sensitivity-testing.html#cb224-43" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb224-44"><a href="watershed-segmentation-sensitivity-testing.html#cb224-44" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb224-45"><a href="watershed-segmentation-sensitivity-testing.html#cb224-45" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb224-46"><a href="watershed-segmentation-sensitivity-testing.html#cb224-46" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,image_gt_area_m2,field_gt_area_m2,image_gt_volume_m3,field_gt_volume_m3,height_m,field_diameter_m) <span class="sc">%&gt;%</span> </span>
<span id="cb224-47"><a href="watershed-segmentation-sensitivity-testing.html#cb224-47" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb224-48"><a href="watershed-segmentation-sensitivity-testing.html#cb224-48" tabindex="-1"></a>        <span class="at">gt_height_m =</span> height_m</span>
<span id="cb224-49"><a href="watershed-segmentation-sensitivity-testing.html#cb224-49" tabindex="-1"></a>        , <span class="at">gt_diameter_m =</span> field_diameter_m</span>
<span id="cb224-50"><a href="watershed-segmentation-sensitivity-testing.html#cb224-50" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-51"><a href="watershed-segmentation-sensitivity-testing.html#cb224-51" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id=</span><span class="fu">as.numeric</span>(pile_id))</span>
<span id="cb224-52"><a href="watershed-segmentation-sensitivity-testing.html#cb224-52" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb224-53"><a href="watershed-segmentation-sensitivity-testing.html#cb224-53" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-54"><a href="watershed-segmentation-sensitivity-testing.html#cb224-54" tabindex="-1"></a>  <span class="co"># add info from predictions</span></span>
<span id="cb224-55"><a href="watershed-segmentation-sensitivity-testing.html#cb224-55" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb224-56"><a href="watershed-segmentation-sensitivity-testing.html#cb224-56" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span></span>
<span id="cb224-57"><a href="watershed-segmentation-sensitivity-testing.html#cb224-57" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb224-58"><a href="watershed-segmentation-sensitivity-testing.html#cb224-58" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb224-59"><a href="watershed-segmentation-sensitivity-testing.html#cb224-59" tabindex="-1"></a>        rn,pred_id</span>
<span id="cb224-60"><a href="watershed-segmentation-sensitivity-testing.html#cb224-60" tabindex="-1"></a>        ,is_in_stand</span>
<span id="cb224-61"><a href="watershed-segmentation-sensitivity-testing.html#cb224-61" tabindex="-1"></a>        , area_m2, volume_m3, max_height_m, diameter_m</span>
<span id="cb224-62"><a href="watershed-segmentation-sensitivity-testing.html#cb224-62" tabindex="-1"></a>        , paraboloid_volume_m3</span>
<span id="cb224-63"><a href="watershed-segmentation-sensitivity-testing.html#cb224-63" tabindex="-1"></a>        <span class="co"># , shape_length # , shape_width</span></span>
<span id="cb224-64"><a href="watershed-segmentation-sensitivity-testing.html#cb224-64" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-65"><a href="watershed-segmentation-sensitivity-testing.html#cb224-65" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb224-66"><a href="watershed-segmentation-sensitivity-testing.html#cb224-66" tabindex="-1"></a>        <span class="at">pred_area_m2 =</span> area_m2, <span class="at">pred_volume_m3 =</span> volume_m3</span>
<span id="cb224-67"><a href="watershed-segmentation-sensitivity-testing.html#cb224-67" tabindex="-1"></a>        , <span class="at">pred_height_m =</span> max_height_m, <span class="at">pred_diameter_m =</span> diameter_m</span>
<span id="cb224-68"><a href="watershed-segmentation-sensitivity-testing.html#cb224-68" tabindex="-1"></a>        , <span class="at">pred_paraboloid_volume_m3 =</span> paraboloid_volume_m3</span>
<span id="cb224-69"><a href="watershed-segmentation-sensitivity-testing.html#cb224-69" tabindex="-1"></a>      )</span>
<span id="cb224-70"><a href="watershed-segmentation-sensitivity-testing.html#cb224-70" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb224-71"><a href="watershed-segmentation-sensitivity-testing.html#cb224-71" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb224-72"><a href="watershed-segmentation-sensitivity-testing.html#cb224-72" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-73"><a href="watershed-segmentation-sensitivity-testing.html#cb224-73" tabindex="-1"></a>    <span class="at">is_in_stand =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb224-74"><a href="watershed-segmentation-sensitivity-testing.html#cb224-74" tabindex="-1"></a>      is_in_stand <span class="sc">==</span> T <span class="sc">~</span> T</span>
<span id="cb224-75"><a href="watershed-segmentation-sensitivity-testing.html#cb224-75" tabindex="-1"></a>      , is_in_stand <span class="sc">==</span> F <span class="sc">~</span> F</span>
<span id="cb224-76"><a href="watershed-segmentation-sensitivity-testing.html#cb224-76" tabindex="-1"></a>      , match_grp <span class="sc">==</span> <span class="st">&quot;omission&quot;</span> <span class="sc">~</span> T</span>
<span id="cb224-77"><a href="watershed-segmentation-sensitivity-testing.html#cb224-77" tabindex="-1"></a>      , T <span class="sc">~</span> F</span>
<span id="cb224-78"><a href="watershed-segmentation-sensitivity-testing.html#cb224-78" tabindex="-1"></a>    )</span>
<span id="cb224-79"><a href="watershed-segmentation-sensitivity-testing.html#cb224-79" tabindex="-1"></a>    <span class="do">### calculate these based on the formulas below...agg_ground_truth_match() depends on those formulas</span></span>
<span id="cb224-80"><a href="watershed-segmentation-sensitivity-testing.html#cb224-80" tabindex="-1"></a>    <span class="co"># ht diffs</span></span>
<span id="cb224-81"><a href="watershed-segmentation-sensitivity-testing.html#cb224-81" tabindex="-1"></a>    , <span class="at">height_diff =</span> pred_height_m<span class="sc">-</span>gt_height_m</span>
<span id="cb224-82"><a href="watershed-segmentation-sensitivity-testing.html#cb224-82" tabindex="-1"></a>    , <span class="at">pct_diff_height =</span> (gt_height_m<span class="sc">-</span>pred_height_m)<span class="sc">/</span>gt_height_m</span>
<span id="cb224-83"><a href="watershed-segmentation-sensitivity-testing.html#cb224-83" tabindex="-1"></a>    <span class="co"># diameter</span></span>
<span id="cb224-84"><a href="watershed-segmentation-sensitivity-testing.html#cb224-84" tabindex="-1"></a>    , <span class="at">diameter_diff =</span> pred_diameter_m<span class="sc">-</span>gt_diameter_m</span>
<span id="cb224-85"><a href="watershed-segmentation-sensitivity-testing.html#cb224-85" tabindex="-1"></a>    , <span class="at">pct_diff_diameter =</span> (gt_diameter_m<span class="sc">-</span>pred_diameter_m)<span class="sc">/</span>gt_diameter_m</span>
<span id="cb224-86"><a href="watershed-segmentation-sensitivity-testing.html#cb224-86" tabindex="-1"></a>    <span class="co"># area diffs</span></span>
<span id="cb224-87"><a href="watershed-segmentation-sensitivity-testing.html#cb224-87" tabindex="-1"></a>    <span class="co"># , area_diff_image = pred_area_m2-image_gt_area_m2</span></span>
<span id="cb224-88"><a href="watershed-segmentation-sensitivity-testing.html#cb224-88" tabindex="-1"></a>    <span class="co"># , pct_diff_area_image = (image_gt_area_m2-pred_area_m2)/image_gt_area_m2</span></span>
<span id="cb224-89"><a href="watershed-segmentation-sensitivity-testing.html#cb224-89" tabindex="-1"></a>    , <span class="at">area_diff_field =</span> pred_area_m2<span class="sc">-</span>field_gt_area_m2</span>
<span id="cb224-90"><a href="watershed-segmentation-sensitivity-testing.html#cb224-90" tabindex="-1"></a>    , <span class="at">pct_diff_area_field =</span> (field_gt_area_m2<span class="sc">-</span>pred_area_m2)<span class="sc">/</span>field_gt_area_m2</span>
<span id="cb224-91"><a href="watershed-segmentation-sensitivity-testing.html#cb224-91" tabindex="-1"></a>    <span class="co"># volume diffs</span></span>
<span id="cb224-92"><a href="watershed-segmentation-sensitivity-testing.html#cb224-92" tabindex="-1"></a>    <span class="co"># , volume_diff_image = pred_volume_m3-image_gt_volume_m3</span></span>
<span id="cb224-93"><a href="watershed-segmentation-sensitivity-testing.html#cb224-93" tabindex="-1"></a>    <span class="co"># , pct_diff_volume_image = (image_gt_volume_m3-pred_volume_m3)/image_gt_volume_m3</span></span>
<span id="cb224-94"><a href="watershed-segmentation-sensitivity-testing.html#cb224-94" tabindex="-1"></a>    , <span class="at">volume_diff_field =</span> pred_volume_m3<span class="sc">-</span>field_gt_volume_m3</span>
<span id="cb224-95"><a href="watershed-segmentation-sensitivity-testing.html#cb224-95" tabindex="-1"></a>    , <span class="at">pct_diff_volume_field =</span> (field_gt_volume_m3<span class="sc">-</span>pred_volume_m3)<span class="sc">/</span>field_gt_volume_m3</span>
<span id="cb224-96"><a href="watershed-segmentation-sensitivity-testing.html#cb224-96" tabindex="-1"></a>    <span class="co"># volume diffs cone</span></span>
<span id="cb224-97"><a href="watershed-segmentation-sensitivity-testing.html#cb224-97" tabindex="-1"></a>    <span class="co"># # , paraboloid_volume_diff_image = pred_paraboloid_volume_m3-image_gt_volume_m3</span></span>
<span id="cb224-98"><a href="watershed-segmentation-sensitivity-testing.html#cb224-98" tabindex="-1"></a>    <span class="co"># , paraboloid_volume_diff_field = pred_paraboloid_volume_m3-field_gt_volume_m3</span></span>
<span id="cb224-99"><a href="watershed-segmentation-sensitivity-testing.html#cb224-99" tabindex="-1"></a>    <span class="co"># , pct_diff_paraboloid_volume_field = (field_gt_volume_m3-pred_paraboloid_volume_m3)/field_gt_volume_m3</span></span>
<span id="cb224-100"><a href="watershed-segmentation-sensitivity-testing.html#cb224-100" tabindex="-1"></a>  )</span>
<span id="cb224-101"><a href="watershed-segmentation-sensitivity-testing.html#cb224-101" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb224-102"><a href="watershed-segmentation-sensitivity-testing.html#cb224-102" tabindex="-1"></a>param_combos_gt <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<p>let’s look at one combination spatially</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="watershed-segmentation-sensitivity-testing.html#cb225-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb225-2"><a href="watershed-segmentation-sensitivity-testing.html#cb225-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb225-3"><a href="watershed-segmentation-sensitivity-testing.html#cb225-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb225-4"><a href="watershed-segmentation-sensitivity-testing.html#cb225-4" tabindex="-1"></a>    <span class="at">data =</span> stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb225-5"><a href="watershed-segmentation-sensitivity-testing.html#cb225-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb225-6"><a href="watershed-segmentation-sensitivity-testing.html#cb225-6" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb225-7"><a href="watershed-segmentation-sensitivity-testing.html#cb225-7" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb225-8"><a href="watershed-segmentation-sensitivity-testing.html#cb225-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb225-9"><a href="watershed-segmentation-sensitivity-testing.html#cb225-9" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb225-10"><a href="watershed-segmentation-sensitivity-testing.html#cb225-10" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb225-11"><a href="watershed-segmentation-sensitivity-testing.html#cb225-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb225-12"><a href="watershed-segmentation-sensitivity-testing.html#cb225-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles)) <span class="sc">%&gt;%</span> </span>
<span id="cb225-13"><a href="watershed-segmentation-sensitivity-testing.html#cb225-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id=</span><span class="fu">as.numeric</span>(pile_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb225-14"><a href="watershed-segmentation-sensitivity-testing.html#cb225-14" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb225-15"><a href="watershed-segmentation-sensitivity-testing.html#cb225-15" tabindex="-1"></a>          param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb225-16"><a href="watershed-segmentation-sensitivity-testing.html#cb225-16" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> param_combos_gt<span class="sc">$</span>rn[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb225-17"><a href="watershed-segmentation-sensitivity-testing.html#cb225-17" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb225-18"><a href="watershed-segmentation-sensitivity-testing.html#cb225-18" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb225-19"><a href="watershed-segmentation-sensitivity-testing.html#cb225-19" tabindex="-1"></a>        )</span>
<span id="cb225-20"><a href="watershed-segmentation-sensitivity-testing.html#cb225-20" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb225-21"><a href="watershed-segmentation-sensitivity-testing.html#cb225-21" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb225-22"><a href="watershed-segmentation-sensitivity-testing.html#cb225-22" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb225-23"><a href="watershed-segmentation-sensitivity-testing.html#cb225-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb225-24"><a href="watershed-segmentation-sensitivity-testing.html#cb225-24" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb225-25"><a href="watershed-segmentation-sensitivity-testing.html#cb225-25" tabindex="-1"></a>      param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb225-26"><a href="watershed-segmentation-sensitivity-testing.html#cb225-26" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> param_combos_gt<span class="sc">$</span>rn[<span class="dv">1</span>] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb225-27"><a href="watershed-segmentation-sensitivity-testing.html#cb225-27" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb225-28"><a href="watershed-segmentation-sensitivity-testing.html#cb225-28" tabindex="-1"></a>          param_combos_gt <span class="sc">%&gt;%</span></span>
<span id="cb225-29"><a href="watershed-segmentation-sensitivity-testing.html#cb225-29" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> param_combos_gt<span class="sc">$</span>rn[<span class="dv">1</span>] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb225-30"><a href="watershed-segmentation-sensitivity-testing.html#cb225-30" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb225-31"><a href="watershed-segmentation-sensitivity-testing.html#cb225-31" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb225-32"><a href="watershed-segmentation-sensitivity-testing.html#cb225-32" tabindex="-1"></a>        )</span>
<span id="cb225-33"><a href="watershed-segmentation-sensitivity-testing.html#cb225-33" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb225-34"><a href="watershed-segmentation-sensitivity-testing.html#cb225-34" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb225-35"><a href="watershed-segmentation-sensitivity-testing.html#cb225-35" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">0.7</span></span>
<span id="cb225-36"><a href="watershed-segmentation-sensitivity-testing.html#cb225-36" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb225-37"><a href="watershed-segmentation-sensitivity-testing.html#cb225-37" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb225-38"><a href="watershed-segmentation-sensitivity-testing.html#cb225-38" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb225-39"><a href="watershed-segmentation-sensitivity-testing.html#cb225-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb225-40"><a href="watershed-segmentation-sensitivity-testing.html#cb225-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb225-41"><a href="watershed-segmentation-sensitivity-testing.html#cb225-41" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb225-42"><a href="watershed-segmentation-sensitivity-testing.html#cb225-42" tabindex="-1"></a>    , <span class="at">panel.background =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;gray66&quot;</span>)</span>
<span id="cb225-43"><a href="watershed-segmentation-sensitivity-testing.html#cb225-43" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb225-44"><a href="watershed-segmentation-sensitivity-testing.html#cb225-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb225-45"><a href="watershed-segmentation-sensitivity-testing.html#cb225-45" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(pal_match_grp[<span class="st">&quot;commission&quot;</span>],<span class="cn">NA</span>,<span class="cn">NA</span>)))</span>
<span id="cb225-46"><a href="watershed-segmentation-sensitivity-testing.html#cb225-46" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb225-47"><a href="watershed-segmentation-sensitivity-testing.html#cb225-47" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-189-1.png" width="1008" /></p>
</div>
<div id="aggregate-assessment-metrics" class="section level3 hasAnchor" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> Aggregate assessment metrics<a href="watershed-segmentation-sensitivity-testing.html#aggregate-assessment-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>to prepare our results for analysis, we will develop a function that aggregates the single-pile-level data into a single record for each parameter combination. this function will calculate detection performance metrics such as F-score, precision, and recall, as well as quantification accuracy metrics including Root Mean Squared Error (RMSE), Mean Error (ME), and Mean Absolute Percentage Error (MAPE) to assess the accuracy of our pile form measurements. this could be a valuable function for any future analysis comparing predictions to ground truth data.</p>
<p>here are the accuracy metric formulas:</p>
<p><span class="math display">\[
\textrm{RMSE} = \sqrt{ \frac{  \sum_{i=1}^{N} (y_{i} - \hat{y_{i}})^{2}}{N}}
\]</span></p>
<p><span class="math display">\[
\textrm{ME} = \frac{  \sum_{i=1}^{N} (\hat{y_{i}} - y_{i})}{N}
\]</span>
<span class="math display">\[
\textrm{MAPE} = \frac{1}{N} \sum_{i=1}^{N} \left| \frac{y_{i} - \hat{y_{i}}}{y_{i}} \right|
\]</span></p>
<p>Where <span class="math inline">\(N\)</span> is equal to the total number of correctly matched piles, <span class="math inline">\(y_i\)</span> is the ground truth measured value and <span class="math inline">\(\hat{y_i}\)</span> is the predicted value of <span class="math inline">\(i\)</span></p>
<p>we could also calculate Relative RMSE (RRMSE)</p>
<p><span class="math display">\[
\textrm{RRMSE} = \frac{\text{RMSE}}{\bar{y}} \times 100\%
\]</span></p>
<p>where, <span class="math inline">\(\bar{y}\)</span> represents the mean of the ground truth values. the interpretations of RMSE and RRMSE are:</p>
<ul>
<li>RMSE: Measures the average magnitude of the differences between predicted and the actual observed values, expressed in the same units as the metric.</li>
<li>RRMSE: Expresses RMSE as a percentage of the mean of the observed values, providing a scale-independent measure to compare model accuracy across different datasets or models.</li>
</ul>
<p>for this analysis, we’ll show how to calculate RRMSE but we’ll only investigate MAPE:</p>
<ul>
<li>Use MAPE when: You need an easily understandable metric for comparing prediction accuracy across different series or models with varying scales, particularly when zeros or near-zero actual values are not present in your data.</li>
<li>Use RRMSE when: You need a metric that is more robust to small or zero actual values and you want to penalize larger errors more heavily due to the squaring of errors in its calculation.</li>
</ul>
<p>as a reminder regarding the form quantification accuracy evaluation, we will assess the method’s accuracy by comparing the true-positive matches using the following metrics:</p>
<ul>
<li><strong>Volume</strong> compares the predicted volume from the irregular elevation profile and footprint to the ground truth paraboloid volume</li>
<li><strong>Diameter</strong> compares the predicted diameter (from the maximum internal distance) to the ground truth field-measured diameter.</li>
<li><strong>Area</strong> compares the predicted area from the irregular shape to the ground truth assumed circular area</li>
<li><strong>Height</strong> compares the predicted maximum height from the CHM to the ground truth field-measured height</li>
</ul>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="watershed-segmentation-sensitivity-testing.html#cb226-1" tabindex="-1"></a><span class="co"># first function takes df with cols tp_n, fp_n, and fn_n to calculate rate</span></span>
<span id="cb226-2"><a href="watershed-segmentation-sensitivity-testing.html#cb226-2" tabindex="-1"></a>confusion_matrix_scores_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb226-3"><a href="watershed-segmentation-sensitivity-testing.html#cb226-3" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb226-4"><a href="watershed-segmentation-sensitivity-testing.html#cb226-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb226-5"><a href="watershed-segmentation-sensitivity-testing.html#cb226-5" tabindex="-1"></a>    <span class="at">omission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-6"><a href="watershed-segmentation-sensitivity-testing.html#cb226-6" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-7"><a href="watershed-segmentation-sensitivity-testing.html#cb226-7" tabindex="-1"></a>      , T <span class="sc">~</span> fn_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb226-8"><a href="watershed-segmentation-sensitivity-testing.html#cb226-8" tabindex="-1"></a>    ) <span class="co"># False Negative Rate or Miss Rate</span></span>
<span id="cb226-9"><a href="watershed-segmentation-sensitivity-testing.html#cb226-9" tabindex="-1"></a>    , <span class="at">commission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-10"><a href="watershed-segmentation-sensitivity-testing.html#cb226-10" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-11"><a href="watershed-segmentation-sensitivity-testing.html#cb226-11" tabindex="-1"></a>      , T <span class="sc">~</span> fp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb226-12"><a href="watershed-segmentation-sensitivity-testing.html#cb226-12" tabindex="-1"></a>    ) <span class="co"># False Positive Rate</span></span>
<span id="cb226-13"><a href="watershed-segmentation-sensitivity-testing.html#cb226-13" tabindex="-1"></a>    , <span class="at">precision =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-14"><a href="watershed-segmentation-sensitivity-testing.html#cb226-14" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-15"><a href="watershed-segmentation-sensitivity-testing.html#cb226-15" tabindex="-1"></a>      , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb226-16"><a href="watershed-segmentation-sensitivity-testing.html#cb226-16" tabindex="-1"></a>    )</span>
<span id="cb226-17"><a href="watershed-segmentation-sensitivity-testing.html#cb226-17" tabindex="-1"></a>    , <span class="at">recall =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-18"><a href="watershed-segmentation-sensitivity-testing.html#cb226-18" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-19"><a href="watershed-segmentation-sensitivity-testing.html#cb226-19" tabindex="-1"></a>      , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb226-20"><a href="watershed-segmentation-sensitivity-testing.html#cb226-20" tabindex="-1"></a>    )</span>
<span id="cb226-21"><a href="watershed-segmentation-sensitivity-testing.html#cb226-21" tabindex="-1"></a>    , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-22"><a href="watershed-segmentation-sensitivity-testing.html#cb226-22" tabindex="-1"></a>      <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-23"><a href="watershed-segmentation-sensitivity-testing.html#cb226-23" tabindex="-1"></a>      , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb226-24"><a href="watershed-segmentation-sensitivity-testing.html#cb226-24" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb226-25"><a href="watershed-segmentation-sensitivity-testing.html#cb226-25" tabindex="-1"></a>    )    </span>
<span id="cb226-26"><a href="watershed-segmentation-sensitivity-testing.html#cb226-26" tabindex="-1"></a>  ) </span>
<span id="cb226-27"><a href="watershed-segmentation-sensitivity-testing.html#cb226-27" tabindex="-1"></a>}</span>
<span id="cb226-28"><a href="watershed-segmentation-sensitivity-testing.html#cb226-28" tabindex="-1"></a><span class="co"># aggregate results from ground_truth_prediction_match()</span></span>
<span id="cb226-29"><a href="watershed-segmentation-sensitivity-testing.html#cb226-29" tabindex="-1"></a>agg_ground_truth_match <span class="ot">&lt;-</span> <span class="cf">function</span>(ground_truth_prediction_match_ans) {</span>
<span id="cb226-30"><a href="watershed-segmentation-sensitivity-testing.html#cb226-30" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(ground_truth_prediction_match_ans)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb226-31"><a href="watershed-segmentation-sensitivity-testing.html#cb226-31" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(ground_truth_prediction_match_ans) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){<span class="fu">stop</span>(<span class="st">&quot;ground_truth_prediction_match_ans must contain `match_grp` column&quot;</span>)}</span>
<span id="cb226-32"><a href="watershed-segmentation-sensitivity-testing.html#cb226-32" tabindex="-1"></a>  </span>
<span id="cb226-33"><a href="watershed-segmentation-sensitivity-testing.html#cb226-33" tabindex="-1"></a>  <span class="co"># check for difference columns (contains &quot;_diff&quot;) and calc rmse for only those to return a single line df with colums for each diff_rmse</span></span>
<span id="cb226-34"><a href="watershed-segmentation-sensitivity-testing.html#cb226-34" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb226-35"><a href="watershed-segmentation-sensitivity-testing.html#cb226-35" tabindex="-1"></a>      (ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb226-36"><a href="watershed-segmentation-sensitivity-testing.html#cb226-36" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;_diff&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb226-37"><a href="watershed-segmentation-sensitivity-testing.html#cb226-37" tabindex="-1"></a>        <span class="fu">ncol</span>() )<span class="sc">&gt;</span><span class="dv">0</span></span>
<span id="cb226-38"><a href="watershed-segmentation-sensitivity-testing.html#cb226-38" tabindex="-1"></a>    ){</span>
<span id="cb226-39"><a href="watershed-segmentation-sensitivity-testing.html#cb226-39" tabindex="-1"></a>      <span class="co"># get rmse and mean difference/error for all columns with &quot;_diff&quot; but not &quot;pct_diff&quot;</span></span>
<span id="cb226-40"><a href="watershed-segmentation-sensitivity-testing.html#cb226-40" tabindex="-1"></a>      <span class="co"># get mape for all columns with &quot;pct_diff&quot; but not &quot;diff_&quot;</span></span>
<span id="cb226-41"><a href="watershed-segmentation-sensitivity-testing.html#cb226-41" tabindex="-1"></a>      rmse_df <span class="ot">&lt;-</span> ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb226-42"><a href="watershed-segmentation-sensitivity-testing.html#cb226-42" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb226-43"><a href="watershed-segmentation-sensitivity-testing.html#cb226-43" tabindex="-1"></a>          (tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;_diff&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_&quot;</span>))</span>
<span id="cb226-44"><a href="watershed-segmentation-sensitivity-testing.html#cb226-44" tabindex="-1"></a>          <span class="sc">|</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_diff&quot;</span>)</span>
<span id="cb226-45"><a href="watershed-segmentation-sensitivity-testing.html#cb226-45" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb226-46"><a href="watershed-segmentation-sensitivity-testing.html#cb226-46" tabindex="-1"></a>        tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="at">values_drop_na =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb226-47"><a href="watershed-segmentation-sensitivity-testing.html#cb226-47" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb226-48"><a href="watershed-segmentation-sensitivity-testing.html#cb226-48" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb226-49"><a href="watershed-segmentation-sensitivity-testing.html#cb226-49" tabindex="-1"></a>          <span class="at">sq =</span> <span class="fu">sum</span>(value<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb226-50"><a href="watershed-segmentation-sensitivity-testing.html#cb226-50" tabindex="-1"></a>          , <span class="at">mean =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> T)</span>
<span id="cb226-51"><a href="watershed-segmentation-sensitivity-testing.html#cb226-51" tabindex="-1"></a>          , <span class="at">sumabs =</span> <span class="fu">sum</span>(<span class="fu">abs</span>(value), <span class="at">na.rm =</span> T)</span>
<span id="cb226-52"><a href="watershed-segmentation-sensitivity-testing.html#cb226-52" tabindex="-1"></a>          , <span class="at">nomiss =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(value))</span>
<span id="cb226-53"><a href="watershed-segmentation-sensitivity-testing.html#cb226-53" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-54"><a href="watershed-segmentation-sensitivity-testing.html#cb226-54" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb226-55"><a href="watershed-segmentation-sensitivity-testing.html#cb226-55" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb226-56"><a href="watershed-segmentation-sensitivity-testing.html#cb226-56" tabindex="-1"></a>          <span class="at">rmse =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-57"><a href="watershed-segmentation-sensitivity-testing.html#cb226-57" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">coalesce</span>(nomiss,<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-58"><a href="watershed-segmentation-sensitivity-testing.html#cb226-58" tabindex="-1"></a>            , T <span class="sc">~</span> <span class="fu">sqrt</span>(sq<span class="sc">/</span>nomiss)</span>
<span id="cb226-59"><a href="watershed-segmentation-sensitivity-testing.html#cb226-59" tabindex="-1"></a>          )</span>
<span id="cb226-60"><a href="watershed-segmentation-sensitivity-testing.html#cb226-60" tabindex="-1"></a>          , <span class="at">mape =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-61"><a href="watershed-segmentation-sensitivity-testing.html#cb226-61" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">coalesce</span>(nomiss,<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-62"><a href="watershed-segmentation-sensitivity-testing.html#cb226-62" tabindex="-1"></a>            , T <span class="sc">~</span> sumabs<span class="sc">/</span>nomiss</span>
<span id="cb226-63"><a href="watershed-segmentation-sensitivity-testing.html#cb226-63" tabindex="-1"></a>          )</span>
<span id="cb226-64"><a href="watershed-segmentation-sensitivity-testing.html#cb226-64" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-65"><a href="watershed-segmentation-sensitivity-testing.html#cb226-65" tabindex="-1"></a>        <span class="co"># NA nonsense values</span></span>
<span id="cb226-66"><a href="watershed-segmentation-sensitivity-testing.html#cb226-66" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb226-67"><a href="watershed-segmentation-sensitivity-testing.html#cb226-67" tabindex="-1"></a>          <span class="at">mape =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-68"><a href="watershed-segmentation-sensitivity-testing.html#cb226-68" tabindex="-1"></a>            stringr<span class="sc">::</span><span class="fu">str_starts</span>(name, <span class="st">&quot;pct_diff&quot;</span>) <span class="sc">~</span> mape</span>
<span id="cb226-69"><a href="watershed-segmentation-sensitivity-testing.html#cb226-69" tabindex="-1"></a>            , T <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-70"><a href="watershed-segmentation-sensitivity-testing.html#cb226-70" tabindex="-1"></a>          )</span>
<span id="cb226-71"><a href="watershed-segmentation-sensitivity-testing.html#cb226-71" tabindex="-1"></a>          , <span class="at">rmse =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-72"><a href="watershed-segmentation-sensitivity-testing.html#cb226-72" tabindex="-1"></a>            stringr<span class="sc">::</span><span class="fu">str_starts</span>(name, <span class="st">&quot;pct_diff&quot;</span>) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-73"><a href="watershed-segmentation-sensitivity-testing.html#cb226-73" tabindex="-1"></a>            , T <span class="sc">~</span> rmse</span>
<span id="cb226-74"><a href="watershed-segmentation-sensitivity-testing.html#cb226-74" tabindex="-1"></a>          )</span>
<span id="cb226-75"><a href="watershed-segmentation-sensitivity-testing.html#cb226-75" tabindex="-1"></a>          , <span class="at">mean =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb226-76"><a href="watershed-segmentation-sensitivity-testing.html#cb226-76" tabindex="-1"></a>            stringr<span class="sc">::</span><span class="fu">str_starts</span>(name, <span class="st">&quot;pct_diff&quot;</span>) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb226-77"><a href="watershed-segmentation-sensitivity-testing.html#cb226-77" tabindex="-1"></a>            , T <span class="sc">~</span> mean</span>
<span id="cb226-78"><a href="watershed-segmentation-sensitivity-testing.html#cb226-78" tabindex="-1"></a>          )</span>
<span id="cb226-79"><a href="watershed-segmentation-sensitivity-testing.html#cb226-79" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-80"><a href="watershed-segmentation-sensitivity-testing.html#cb226-80" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(name,rmse,mean,mape) <span class="sc">%&gt;%</span> </span>
<span id="cb226-81"><a href="watershed-segmentation-sensitivity-testing.html#cb226-81" tabindex="-1"></a>        tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb226-82"><a href="watershed-segmentation-sensitivity-testing.html#cb226-82" tabindex="-1"></a>          <span class="at">names_from =</span> name</span>
<span id="cb226-83"><a href="watershed-segmentation-sensitivity-testing.html#cb226-83" tabindex="-1"></a>          , <span class="at">values_from =</span> <span class="fu">c</span>(rmse,mean,mape)</span>
<span id="cb226-84"><a href="watershed-segmentation-sensitivity-testing.html#cb226-84" tabindex="-1"></a>          , <span class="at">names_glue =</span> <span class="st">&quot;{name}_{.value}&quot;</span></span>
<span id="cb226-85"><a href="watershed-segmentation-sensitivity-testing.html#cb226-85" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-86"><a href="watershed-segmentation-sensitivity-testing.html#cb226-86" tabindex="-1"></a>        <span class="co"># remove columns with NA in all rows</span></span>
<span id="cb226-87"><a href="watershed-segmentation-sensitivity-testing.html#cb226-87" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>( dplyr<span class="sc">::</span><span class="fu">where</span>( <span class="sc">~!</span><span class="fu">all</span>(<span class="fu">is.na</span>(.x)) ) )</span>
<span id="cb226-88"><a href="watershed-segmentation-sensitivity-testing.html#cb226-88" tabindex="-1"></a>      </span>
<span id="cb226-89"><a href="watershed-segmentation-sensitivity-testing.html#cb226-89" tabindex="-1"></a>      <span class="cf">if</span>(</span>
<span id="cb226-90"><a href="watershed-segmentation-sensitivity-testing.html#cb226-90" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(rmse_df),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span></span>
<span id="cb226-91"><a href="watershed-segmentation-sensitivity-testing.html#cb226-91" tabindex="-1"></a>        <span class="sc">||</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">ncol</span>(rmse_df),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span></span>
<span id="cb226-92"><a href="watershed-segmentation-sensitivity-testing.html#cb226-92" tabindex="-1"></a>      ){</span>
<span id="cb226-93"><a href="watershed-segmentation-sensitivity-testing.html#cb226-93" tabindex="-1"></a>        <span class="co"># empty df</span></span>
<span id="cb226-94"><a href="watershed-segmentation-sensitivity-testing.html#cb226-94" tabindex="-1"></a>        rmse_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>()</span>
<span id="cb226-95"><a href="watershed-segmentation-sensitivity-testing.html#cb226-95" tabindex="-1"></a>      }</span>
<span id="cb226-96"><a href="watershed-segmentation-sensitivity-testing.html#cb226-96" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb226-97"><a href="watershed-segmentation-sensitivity-testing.html#cb226-97" tabindex="-1"></a>      <span class="co"># empty df</span></span>
<span id="cb226-98"><a href="watershed-segmentation-sensitivity-testing.html#cb226-98" tabindex="-1"></a>      rmse_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>()</span>
<span id="cb226-99"><a href="watershed-segmentation-sensitivity-testing.html#cb226-99" tabindex="-1"></a>    }</span>
<span id="cb226-100"><a href="watershed-segmentation-sensitivity-testing.html#cb226-100" tabindex="-1"></a>  </span>
<span id="cb226-101"><a href="watershed-segmentation-sensitivity-testing.html#cb226-101" tabindex="-1"></a>  <span class="co"># count by match group</span></span>
<span id="cb226-102"><a href="watershed-segmentation-sensitivity-testing.html#cb226-102" tabindex="-1"></a>    agg <span class="ot">&lt;-</span></span>
<span id="cb226-103"><a href="watershed-segmentation-sensitivity-testing.html#cb226-103" tabindex="-1"></a>      ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb226-104"><a href="watershed-segmentation-sensitivity-testing.html#cb226-104" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb226-105"><a href="watershed-segmentation-sensitivity-testing.html#cb226-105" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb226-106"><a href="watershed-segmentation-sensitivity-testing.html#cb226-106" tabindex="-1"></a>        <span class="at">match_grp =</span> dplyr<span class="sc">::</span><span class="fu">case_match</span>(</span>
<span id="cb226-107"><a href="watershed-segmentation-sensitivity-testing.html#cb226-107" tabindex="-1"></a>          match_grp</span>
<span id="cb226-108"><a href="watershed-segmentation-sensitivity-testing.html#cb226-108" tabindex="-1"></a>          , <span class="st">&quot;true positive&quot;</span><span class="sc">~</span><span class="st">&quot;tp&quot;</span></span>
<span id="cb226-109"><a href="watershed-segmentation-sensitivity-testing.html#cb226-109" tabindex="-1"></a>          , <span class="st">&quot;commission&quot;</span><span class="sc">~</span><span class="st">&quot;fp&quot;</span></span>
<span id="cb226-110"><a href="watershed-segmentation-sensitivity-testing.html#cb226-110" tabindex="-1"></a>          , <span class="st">&quot;omission&quot;</span><span class="sc">~</span><span class="st">&quot;fn&quot;</span></span>
<span id="cb226-111"><a href="watershed-segmentation-sensitivity-testing.html#cb226-111" tabindex="-1"></a>        )</span>
<span id="cb226-112"><a href="watershed-segmentation-sensitivity-testing.html#cb226-112" tabindex="-1"></a>      )</span>
<span id="cb226-113"><a href="watershed-segmentation-sensitivity-testing.html#cb226-113" tabindex="-1"></a>    <span class="co"># true positive, false positive, false negative rates</span></span>
<span id="cb226-114"><a href="watershed-segmentation-sensitivity-testing.html#cb226-114" tabindex="-1"></a>    return_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">match_grp =</span> <span class="fu">c</span>(<span class="st">&quot;tp&quot;</span>,<span class="st">&quot;fp&quot;</span>,<span class="st">&quot;fn&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb226-115"><a href="watershed-segmentation-sensitivity-testing.html#cb226-115" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(agg, <span class="at">by =</span> <span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb226-116"><a href="watershed-segmentation-sensitivity-testing.html#cb226-116" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(n), <span class="at">.fn =</span> <span class="sc">~</span>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(.x,<span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb226-117"><a href="watershed-segmentation-sensitivity-testing.html#cb226-117" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb226-118"><a href="watershed-segmentation-sensitivity-testing.html#cb226-118" tabindex="-1"></a>        <span class="at">names_from =</span> match_grp</span>
<span id="cb226-119"><a href="watershed-segmentation-sensitivity-testing.html#cb226-119" tabindex="-1"></a>        , <span class="at">values_from =</span> <span class="fu">c</span>(n)</span>
<span id="cb226-120"><a href="watershed-segmentation-sensitivity-testing.html#cb226-120" tabindex="-1"></a>        , <span class="at">names_glue =</span> <span class="st">&quot;{match_grp}_{.value}&quot;</span></span>
<span id="cb226-121"><a href="watershed-segmentation-sensitivity-testing.html#cb226-121" tabindex="-1"></a>      )</span>
<span id="cb226-122"><a href="watershed-segmentation-sensitivity-testing.html#cb226-122" tabindex="-1"></a>    <span class="co"># rates, precision, recall, f-score</span></span>
<span id="cb226-123"><a href="watershed-segmentation-sensitivity-testing.html#cb226-123" tabindex="-1"></a>    return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb226-124"><a href="watershed-segmentation-sensitivity-testing.html#cb226-124" tabindex="-1"></a>      <span class="fu">confusion_matrix_scores_fn</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb226-125"><a href="watershed-segmentation-sensitivity-testing.html#cb226-125" tabindex="-1"></a>      <span class="co"># add rmse</span></span>
<span id="cb226-126"><a href="watershed-segmentation-sensitivity-testing.html#cb226-126" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(rmse_df)</span>
<span id="cb226-127"><a href="watershed-segmentation-sensitivity-testing.html#cb226-127" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb226-128"><a href="watershed-segmentation-sensitivity-testing.html#cb226-128" tabindex="-1"></a>  <span class="fu">return</span>(return_df)</span>
<span id="cb226-129"><a href="watershed-segmentation-sensitivity-testing.html#cb226-129" tabindex="-1"></a>}</span></code></pre></div>
<p>now let’s apply it at the parameter combination level</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="watershed-segmentation-sensitivity-testing.html#cb227-1" tabindex="-1"></a>param_combos_gt_agg <span class="ot">&lt;-</span> <span class="fu">unique</span>(param_combos_gt<span class="sc">$</span>rn) <span class="sc">%&gt;%</span> </span>
<span id="cb227-2"><a href="watershed-segmentation-sensitivity-testing.html#cb227-2" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb227-3"><a href="watershed-segmentation-sensitivity-testing.html#cb227-3" tabindex="-1"></a>    <span class="fu">agg_ground_truth_match</span>(</span>
<span id="cb227-4"><a href="watershed-segmentation-sensitivity-testing.html#cb227-4" tabindex="-1"></a>      param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb227-5"><a href="watershed-segmentation-sensitivity-testing.html#cb227-5" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb227-6"><a href="watershed-segmentation-sensitivity-testing.html#cb227-6" tabindex="-1"></a>          is_in_stand</span>
<span id="cb227-7"><a href="watershed-segmentation-sensitivity-testing.html#cb227-7" tabindex="-1"></a>          <span class="sc">&amp;</span> rn <span class="sc">==</span> x</span>
<span id="cb227-8"><a href="watershed-segmentation-sensitivity-testing.html#cb227-8" tabindex="-1"></a>        )</span>
<span id="cb227-9"><a href="watershed-segmentation-sensitivity-testing.html#cb227-9" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb227-10"><a href="watershed-segmentation-sensitivity-testing.html#cb227-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn =</span> x)</span>
<span id="cb227-11"><a href="watershed-segmentation-sensitivity-testing.html#cb227-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb227-12"><a href="watershed-segmentation-sensitivity-testing.html#cb227-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb227-13"><a href="watershed-segmentation-sensitivity-testing.html#cb227-13" tabindex="-1"></a>  <span class="co"># add in info on all parameter combinations</span></span>
<span id="cb227-14"><a href="watershed-segmentation-sensitivity-testing.html#cb227-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb227-15"><a href="watershed-segmentation-sensitivity-testing.html#cb227-15" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb227-16"><a href="watershed-segmentation-sensitivity-testing.html#cb227-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb227-17"><a href="watershed-segmentation-sensitivity-testing.html#cb227-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(</span>
<span id="cb227-18"><a href="watershed-segmentation-sensitivity-testing.html#cb227-18" tabindex="-1"></a>      rn,max_ht_m,min_area_m2,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb227-19"><a href="watershed-segmentation-sensitivity-testing.html#cb227-19" tabindex="-1"></a>    )</span>
<span id="cb227-20"><a href="watershed-segmentation-sensitivity-testing.html#cb227-20" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb227-21"><a href="watershed-segmentation-sensitivity-testing.html#cb227-21" tabindex="-1"></a>    , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb227-22"><a href="watershed-segmentation-sensitivity-testing.html#cb227-22" tabindex="-1"></a>  )</span>
<span id="cb227-23"><a href="watershed-segmentation-sensitivity-testing.html#cb227-23" tabindex="-1"></a></span>
<span id="cb227-24"><a href="watershed-segmentation-sensitivity-testing.html#cb227-24" tabindex="-1"></a><span class="co"># we can also add the relative rmse (rrmse) by comparing the rmse to the mean value of the ground truth data</span></span>
<span id="cb227-25"><a href="watershed-segmentation-sensitivity-testing.html#cb227-25" tabindex="-1"></a>param_combos_gt_agg <span class="ot">&lt;-</span> param_combos_gt_agg <span class="sc">%&gt;%</span></span>
<span id="cb227-26"><a href="watershed-segmentation-sensitivity-testing.html#cb227-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb227-27"><a href="watershed-segmentation-sensitivity-testing.html#cb227-27" tabindex="-1"></a>    <span class="co"># add means of gt</span></span>
<span id="cb227-28"><a href="watershed-segmentation-sensitivity-testing.html#cb227-28" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb227-29"><a href="watershed-segmentation-sensitivity-testing.html#cb227-29" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb227-30"><a href="watershed-segmentation-sensitivity-testing.html#cb227-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(image_gt_area_m2,field_gt_area_m2,image_gt_volume_m3,field_gt_volume_m3,height_m,field_diameter_m) <span class="sc">%&gt;%</span> </span>
<span id="cb227-31"><a href="watershed-segmentation-sensitivity-testing.html#cb227-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb227-32"><a href="watershed-segmentation-sensitivity-testing.html#cb227-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(.x,<span class="at">na.rm=</span>T))) <span class="sc">%&gt;%</span> </span>
<span id="cb227-33"><a href="watershed-segmentation-sensitivity-testing.html#cb227-33" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">&quot;gt_&quot;</span>, .x, <span class="at">recycle0 =</span> <span class="cn">TRUE</span>))</span>
<span id="cb227-34"><a href="watershed-segmentation-sensitivity-testing.html#cb227-34" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb227-35"><a href="watershed-segmentation-sensitivity-testing.html#cb227-35" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb227-36"><a href="watershed-segmentation-sensitivity-testing.html#cb227-36" tabindex="-1"></a>    <span class="at">area_diff_field_rrmse =</span> area_diff_field_rmse<span class="sc">/</span>gt_field_gt_area_m2</span>
<span id="cb227-37"><a href="watershed-segmentation-sensitivity-testing.html#cb227-37" tabindex="-1"></a>    <span class="co"># , area_diff_image_rrmse = area_diff_image_rmse/gt_image_gt_area_m2</span></span>
<span id="cb227-38"><a href="watershed-segmentation-sensitivity-testing.html#cb227-38" tabindex="-1"></a>    , <span class="at">volume_diff_field_rrmse =</span> volume_diff_field_rmse<span class="sc">/</span>gt_field_gt_volume_m3</span>
<span id="cb227-39"><a href="watershed-segmentation-sensitivity-testing.html#cb227-39" tabindex="-1"></a>    <span class="co"># , volume_diff_image_rrmse = volume_diff_image_rmse/gt_image_gt_volume_m3</span></span>
<span id="cb227-40"><a href="watershed-segmentation-sensitivity-testing.html#cb227-40" tabindex="-1"></a>    <span class="co"># , paraboloid_volume_diff_field_rrmse = paraboloid_volume_diff_field_rmse/gt_field_gt_volume_m3</span></span>
<span id="cb227-41"><a href="watershed-segmentation-sensitivity-testing.html#cb227-41" tabindex="-1"></a>    <span class="co"># , paraboloid_volume_diff_image_rrmse = paraboloid_volume_diff_image_rmse/gt_image_gt_volume_m3</span></span>
<span id="cb227-42"><a href="watershed-segmentation-sensitivity-testing.html#cb227-42" tabindex="-1"></a>    , <span class="at">height_diff_rrmse =</span> height_diff_rmse<span class="sc">/</span>gt_height_m</span>
<span id="cb227-43"><a href="watershed-segmentation-sensitivity-testing.html#cb227-43" tabindex="-1"></a>    , <span class="at">diameter_diff_rrmse =</span> diameter_diff_rmse<span class="sc">/</span>gt_field_diameter_m</span>
<span id="cb227-44"><a href="watershed-segmentation-sensitivity-testing.html#cb227-44" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb227-45"><a href="watershed-segmentation-sensitivity-testing.html#cb227-45" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;gt_&quot;</span>))</span>
<span id="cb227-46"><a href="watershed-segmentation-sensitivity-testing.html#cb227-46" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb227-47"><a href="watershed-segmentation-sensitivity-testing.html#cb227-47" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,440
## Columns: 30
## $ tp_n                       &lt;dbl&gt; 79, 73, 65, 54, 32, 4, 79, 73, 65, 54, 32, …
## $ fp_n                       &lt;dbl&gt; 44, 32, 17, 9, 0, 0, 44, 32, 17, 9, 0, 0, 4…
## $ fn_n                       &lt;dbl&gt; 42, 48, 56, 67, 89, 117, 42, 48, 56, 67, 89…
## $ omission_rate              &lt;dbl&gt; 0.3471074, 0.3966942, 0.4628099, 0.5537190,…
## $ commission_rate            &lt;dbl&gt; 0.3577236, 0.3047619, 0.2073171, 0.1428571,…
## $ precision                  &lt;dbl&gt; 0.6422764, 0.6952381, 0.7926829, 0.8571429,…
## $ recall                     &lt;dbl&gt; 0.65289256, 0.60330579, 0.53719008, 0.44628…
## $ f_score                    &lt;dbl&gt; 0.6475410, 0.6460177, 0.6403941, 0.5869565,…
## $ area_diff_field_rmse       &lt;dbl&gt; 1.611770, 1.664736, 1.626639, 1.638681, 1.6…
## $ diameter_diff_rmse         &lt;dbl&gt; 0.7485177, 0.7525893, 0.7488925, 0.7384185,…
## $ height_diff_rmse           &lt;dbl&gt; 0.3094341, 0.3178506, 0.3062417, 0.3100133,…
## $ volume_diff_field_rmse     &lt;dbl&gt; 2.134892, 2.206145, 2.192266, 2.191718, 2.0…
## $ area_diff_field_mean       &lt;dbl&gt; 0.022080324, 0.021422253, -0.002900846, -0.…
## $ diameter_diff_mean         &lt;dbl&gt; 0.6528961, 0.6522134, 0.6509824, 0.6366149,…
## $ height_diff_mean           &lt;dbl&gt; -0.2040260, -0.2230022, -0.2209795, -0.2303…
## $ volume_diff_field_mean     &lt;dbl&gt; -0.8267348, -0.8985110, -0.8974220, -0.8900…
## $ pct_diff_area_field_mape   &lt;dbl&gt; 0.1775634, 0.1861107, 0.1824384, 0.1827844,…
## $ pct_diff_diameter_mape     &lt;dbl&gt; 0.2236866, 0.2242669, 0.2226649, 0.2205699,…
## $ pct_diff_height_mape       &lt;dbl&gt; 0.1295703, 0.1335366, 0.1332140, 0.1357417,…
## $ pct_diff_volume_field_mape &lt;dbl&gt; 0.2357586, 0.2456211, 0.2479493, 0.2558522,…
## $ rn                         &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, …
## $ max_ht_m                   &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…
## $ min_area_m2                &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…
## $ max_area_m2                &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,…
## $ convexity_pct              &lt;dbl&gt; 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.4, 0.4, 0.4…
## $ circle_fit_iou_pct         &lt;dbl&gt; 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.3, 0.4, 0.5…
## $ area_diff_field_rrmse      &lt;dbl&gt; 0.1519422, 0.1569353, 0.1533438, 0.1544791,…
## $ volume_diff_field_rrmse    &lt;dbl&gt; 0.1396832, 0.1443452, 0.1434371, 0.1434012,…
## $ height_diff_rrmse          &lt;dbl&gt; 0.1417985, 0.1456554, 0.1403356, 0.1420639,…
## $ diameter_diff_rrmse        &lt;dbl&gt; 0.2162193, 0.2173954, 0.2163276, 0.2133020,…</code></pre>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="watershed-segmentation-sensitivity-testing.html#cb229-1" tabindex="-1"></a><span class="co"># param_combos_gt_agg %&gt;% readr::write_csv(&quot;c:/Users/georg/Downloads/param_combos_gt_agg.csv&quot;)</span></span></code></pre></div>
</div>
</div>
<div id="parameter-sensitivity-test-results" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Parameter Sensitivity Test Results<a href="watershed-segmentation-sensitivity-testing.html#parameter-sensitivity-test-results" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>let’s get a quick summary of the evaluation metrics across all parameter combinations</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="watershed-segmentation-sensitivity-testing.html#cb230-1" tabindex="-1"></a><span class="co"># pal</span></span>
<span id="cb230-2"><a href="watershed-segmentation-sensitivity-testing.html#cb230-2" tabindex="-1"></a>pal_eval_metric <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb230-3"><a href="watershed-segmentation-sensitivity-testing.html#cb230-3" tabindex="-1"></a>  RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Oranges&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb230-4"><a href="watershed-segmentation-sensitivity-testing.html#cb230-4" tabindex="-1"></a>  , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Greys&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb230-5"><a href="watershed-segmentation-sensitivity-testing.html#cb230-5" tabindex="-1"></a>  , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Purples&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb230-6"><a href="watershed-segmentation-sensitivity-testing.html#cb230-6" tabindex="-1"></a>)</span>
<span id="cb230-7"><a href="watershed-segmentation-sensitivity-testing.html#cb230-7" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb230-8"><a href="watershed-segmentation-sensitivity-testing.html#cb230-8" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb230-9"><a href="watershed-segmentation-sensitivity-testing.html#cb230-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(f_score,recall,precision,tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb230-10"><a href="watershed-segmentation-sensitivity-testing.html#cb230-10" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##     f_score           recall          precision      pct_diff_area_field_mape
##  Min.   :0.0640   Min.   :0.03306   Min.   :0.2905   Min.   :0.1062          
##  1st Qu.:0.5062   1st Qu.:0.48760   1st Qu.:0.5119   1st Qu.:0.2193          
##  Median :0.5986   Median :0.69421   Median :0.6456   Median :0.2270          
##  Mean   :0.5474   Mean   :0.60348   Mean   :0.6569   Mean   :0.2227          
##  3rd Qu.:0.6900   3rd Qu.:0.84298   3rd Qu.:0.8020   3rd Qu.:0.2346          
##  Max.   :0.7572   Max.   :0.91736   Max.   :1.0000   Max.   :0.2569          
##  pct_diff_diameter_mape pct_diff_height_mape pct_diff_volume_field_mape
##  Min.   :0.1343         Min.   :0.09824      Min.   :0.1032            
##  1st Qu.:0.2404         1st Qu.:0.14032      1st Qu.:0.2832            
##  Median :0.2493         Median :0.17690      Median :0.2962            
##  Mean   :0.2440         Mean   :0.16937      Mean   :0.2919            
##  3rd Qu.:0.2564         3rd Qu.:0.19214      3rd Qu.:0.3151            
##  Max.   :0.3053         Max.   :0.20849      Max.   :0.3424</code></pre>
<div id="overall-pile-detection" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> Overall: pile detection<a href="watershed-segmentation-sensitivity-testing.html#overall-pile-detection" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s check out the distribution of the instance segmentation (i.e. pile detection) results by looking at the detection accuracy metrics where:</p>
<ul>
<li><strong>Precision</strong> precision measures how many of the objects our method detected as slash piles were actually correct. A high precision means the method has a low rate of false alarms.</li>
<li><strong>Recall</strong> recall (i.e. detection rate) indicates how many actual (ground truth) slash piles our method successfully identified. High recall means the method is good at finding most existing piles, minimizing omissions.</li>
<li><strong>F-score</strong> provides a single, balanced measure that combines both precision and recall. A high F-score indicates overall effectiveness in both finding most piles and ensuring most detections are correct.</li>
</ul>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="watershed-segmentation-sensitivity-testing.html#cb232-1" tabindex="-1"></a><span class="co"># this is a lot of work, so we&#39;re going to make it a function</span></span>
<span id="cb232-2"><a href="watershed-segmentation-sensitivity-testing.html#cb232-2" tabindex="-1"></a>plt_detection_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb232-3"><a href="watershed-segmentation-sensitivity-testing.html#cb232-3" tabindex="-1"></a>  df</span>
<span id="cb232-4"><a href="watershed-segmentation-sensitivity-testing.html#cb232-4" tabindex="-1"></a>  , <span class="at">my_subtitle =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb232-5"><a href="watershed-segmentation-sensitivity-testing.html#cb232-5" tabindex="-1"></a>  , <span class="at">show_rug =</span> T</span>
<span id="cb232-6"><a href="watershed-segmentation-sensitivity-testing.html#cb232-6" tabindex="-1"></a>) {</span>
<span id="cb232-7"><a href="watershed-segmentation-sensitivity-testing.html#cb232-7" tabindex="-1"></a>  pal_eval_metric <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb232-8"><a href="watershed-segmentation-sensitivity-testing.html#cb232-8" tabindex="-1"></a>    RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Oranges&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb232-9"><a href="watershed-segmentation-sensitivity-testing.html#cb232-9" tabindex="-1"></a>    , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Greys&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb232-10"><a href="watershed-segmentation-sensitivity-testing.html#cb232-10" tabindex="-1"></a>    , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Purples&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb232-11"><a href="watershed-segmentation-sensitivity-testing.html#cb232-11" tabindex="-1"></a>  )</span>
<span id="cb232-12"><a href="watershed-segmentation-sensitivity-testing.html#cb232-12" tabindex="-1"></a>  </span>
<span id="cb232-13"><a href="watershed-segmentation-sensitivity-testing.html#cb232-13" tabindex="-1"></a>  df_temp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb232-14"><a href="watershed-segmentation-sensitivity-testing.html#cb232-14" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb232-15"><a href="watershed-segmentation-sensitivity-testing.html#cb232-15" tabindex="-1"></a>      <span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)</span>
<span id="cb232-16"><a href="watershed-segmentation-sensitivity-testing.html#cb232-16" tabindex="-1"></a>      , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb232-17"><a href="watershed-segmentation-sensitivity-testing.html#cb232-17" tabindex="-1"></a>      , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb232-18"><a href="watershed-segmentation-sensitivity-testing.html#cb232-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb232-19"><a href="watershed-segmentation-sensitivity-testing.html#cb232-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb232-20"><a href="watershed-segmentation-sensitivity-testing.html#cb232-20" tabindex="-1"></a>      <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb232-21"><a href="watershed-segmentation-sensitivity-testing.html#cb232-21" tabindex="-1"></a>          metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb232-22"><a href="watershed-segmentation-sensitivity-testing.html#cb232-22" tabindex="-1"></a>          , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb232-23"><a href="watershed-segmentation-sensitivity-testing.html#cb232-23" tabindex="-1"></a>          , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb232-24"><a href="watershed-segmentation-sensitivity-testing.html#cb232-24" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb232-25"><a href="watershed-segmentation-sensitivity-testing.html#cb232-25" tabindex="-1"></a>        <span class="fu">factor</span>(</span>
<span id="cb232-26"><a href="watershed-segmentation-sensitivity-testing.html#cb232-26" tabindex="-1"></a>          <span class="at">ordered =</span> T</span>
<span id="cb232-27"><a href="watershed-segmentation-sensitivity-testing.html#cb232-27" tabindex="-1"></a>          , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb232-28"><a href="watershed-segmentation-sensitivity-testing.html#cb232-28" tabindex="-1"></a>          , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb232-29"><a href="watershed-segmentation-sensitivity-testing.html#cb232-29" tabindex="-1"></a>            <span class="st">&quot;F-score&quot;</span></span>
<span id="cb232-30"><a href="watershed-segmentation-sensitivity-testing.html#cb232-30" tabindex="-1"></a>            , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb232-31"><a href="watershed-segmentation-sensitivity-testing.html#cb232-31" tabindex="-1"></a>            , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb232-32"><a href="watershed-segmentation-sensitivity-testing.html#cb232-32" tabindex="-1"></a>          )</span>
<span id="cb232-33"><a href="watershed-segmentation-sensitivity-testing.html#cb232-33" tabindex="-1"></a>        )</span>
<span id="cb232-34"><a href="watershed-segmentation-sensitivity-testing.html#cb232-34" tabindex="-1"></a>    ) </span>
<span id="cb232-35"><a href="watershed-segmentation-sensitivity-testing.html#cb232-35" tabindex="-1"></a>  </span>
<span id="cb232-36"><a href="watershed-segmentation-sensitivity-testing.html#cb232-36" tabindex="-1"></a>  <span class="co"># plot </span></span>
<span id="cb232-37"><a href="watershed-segmentation-sensitivity-testing.html#cb232-37" tabindex="-1"></a>  <span class="co"># if(nrow(df)&lt;=15 &amp;&amp; (df_temp %&gt;% dplyr::count(metric,value) %&gt;% dplyr::pull(n) %&gt;% max())&gt;1 ){</span></span>
<span id="cb232-38"><a href="watershed-segmentation-sensitivity-testing.html#cb232-38" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(df)<span class="sc">&lt;=</span><span class="dv">15</span>){</span>
<span id="cb232-39"><a href="watershed-segmentation-sensitivity-testing.html#cb232-39" tabindex="-1"></a>    <span class="co"># round</span></span>
<span id="cb232-40"><a href="watershed-segmentation-sensitivity-testing.html#cb232-40" tabindex="-1"></a>    df_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb232-41"><a href="watershed-segmentation-sensitivity-testing.html#cb232-41" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb232-42"><a href="watershed-segmentation-sensitivity-testing.html#cb232-42" tabindex="-1"></a>        <span class="at">value =</span> <span class="fu">round</span>(value,<span class="dv">2</span>)</span>
<span id="cb232-43"><a href="watershed-segmentation-sensitivity-testing.html#cb232-43" tabindex="-1"></a>      )</span>
<span id="cb232-44"><a href="watershed-segmentation-sensitivity-testing.html#cb232-44" tabindex="-1"></a>    <span class="co"># agg for median plotting</span></span>
<span id="cb232-45"><a href="watershed-segmentation-sensitivity-testing.html#cb232-45" tabindex="-1"></a>      xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb232-46"><a href="watershed-segmentation-sensitivity-testing.html#cb232-46" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(metric) <span class="sc">%&gt;%</span> </span>
<span id="cb232-47"><a href="watershed-segmentation-sensitivity-testing.html#cb232-47" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb232-48"><a href="watershed-segmentation-sensitivity-testing.html#cb232-48" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb232-49"><a href="watershed-segmentation-sensitivity-testing.html#cb232-49" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb232-50"><a href="watershed-segmentation-sensitivity-testing.html#cb232-50" tabindex="-1"></a>          <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb232-51"><a href="watershed-segmentation-sensitivity-testing.html#cb232-51" tabindex="-1"></a>            <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb232-52"><a href="watershed-segmentation-sensitivity-testing.html#cb232-52" tabindex="-1"></a>            , scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb232-53"><a href="watershed-segmentation-sensitivity-testing.html#cb232-53" tabindex="-1"></a>          )</span>
<span id="cb232-54"><a href="watershed-segmentation-sensitivity-testing.html#cb232-54" tabindex="-1"></a>        )</span>
<span id="cb232-55"><a href="watershed-segmentation-sensitivity-testing.html#cb232-55" tabindex="-1"></a>    </span>
<span id="cb232-56"><a href="watershed-segmentation-sensitivity-testing.html#cb232-56" tabindex="-1"></a>    <span class="co"># plot </span></span>
<span id="cb232-57"><a href="watershed-segmentation-sensitivity-testing.html#cb232-57" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb232-58"><a href="watershed-segmentation-sensitivity-testing.html#cb232-58" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">count</span>(metric,value) <span class="sc">%&gt;%</span> </span>
<span id="cb232-59"><a href="watershed-segmentation-sensitivity-testing.html#cb232-59" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb232-60"><a href="watershed-segmentation-sensitivity-testing.html#cb232-60" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric, <span class="at">color =</span> metric)</span>
<span id="cb232-61"><a href="watershed-segmentation-sensitivity-testing.html#cb232-61" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-62"><a href="watershed-segmentation-sensitivity-testing.html#cb232-62" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb232-63"><a href="watershed-segmentation-sensitivity-testing.html#cb232-63" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb232-64"><a href="watershed-segmentation-sensitivity-testing.html#cb232-64" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb232-65"><a href="watershed-segmentation-sensitivity-testing.html#cb232-65" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb232-66"><a href="watershed-segmentation-sensitivity-testing.html#cb232-66" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-67"><a href="watershed-segmentation-sensitivity-testing.html#cb232-67" tabindex="-1"></a>      <span class="co"># ggplot2::geom_jitter(mapping = ggplot2::aes(y=-0.2), width = 0, height = 0.1) +</span></span>
<span id="cb232-68"><a href="watershed-segmentation-sensitivity-testing.html#cb232-68" tabindex="-1"></a>      <span class="co"># ggplot2::geom_boxplot(width = 0.1, color = &quot;black&quot;, fill = NA, outliers = F) +</span></span>
<span id="cb232-69"><a href="watershed-segmentation-sensitivity-testing.html#cb232-69" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb232-70"><a href="watershed-segmentation-sensitivity-testing.html#cb232-70" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">yend=</span><span class="dv">0</span>)</span>
<span id="cb232-71"><a href="watershed-segmentation-sensitivity-testing.html#cb232-71" tabindex="-1"></a>        , <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb232-72"><a href="watershed-segmentation-sensitivity-testing.html#cb232-72" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-73"><a href="watershed-segmentation-sensitivity-testing.html#cb232-73" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb232-74"><a href="watershed-segmentation-sensitivity-testing.html#cb232-74" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n)</span>
<span id="cb232-75"><a href="watershed-segmentation-sensitivity-testing.html#cb232-75" tabindex="-1"></a>        , <span class="at">alpha =</span> <span class="dv">1</span></span>
<span id="cb232-76"><a href="watershed-segmentation-sensitivity-testing.html#cb232-76" tabindex="-1"></a>        , <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb232-77"><a href="watershed-segmentation-sensitivity-testing.html#cb232-77" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-78"><a href="watershed-segmentation-sensitivity-testing.html#cb232-78" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb232-79"><a href="watershed-segmentation-sensitivity-testing.html#cb232-79" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">label=</span>n)</span>
<span id="cb232-80"><a href="watershed-segmentation-sensitivity-testing.html#cb232-80" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb232-81"><a href="watershed-segmentation-sensitivity-testing.html#cb232-81" tabindex="-1"></a>        <span class="co"># , vjust = -0.01</span></span>
<span id="cb232-82"><a href="watershed-segmentation-sensitivity-testing.html#cb232-82" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-83"><a href="watershed-segmentation-sensitivity-testing.html#cb232-83" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb232-84"><a href="watershed-segmentation-sensitivity-testing.html#cb232-84" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb232-85"><a href="watershed-segmentation-sensitivity-testing.html#cb232-85" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb232-86"><a href="watershed-segmentation-sensitivity-testing.html#cb232-86" tabindex="-1"></a>          <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb232-87"><a href="watershed-segmentation-sensitivity-testing.html#cb232-87" tabindex="-1"></a>          <span class="co"># x = value, y = 0</span></span>
<span id="cb232-88"><a href="watershed-segmentation-sensitivity-testing.html#cb232-88" tabindex="-1"></a>          , <span class="at">label =</span> value_lab</span>
<span id="cb232-89"><a href="watershed-segmentation-sensitivity-testing.html#cb232-89" tabindex="-1"></a>        )</span>
<span id="cb232-90"><a href="watershed-segmentation-sensitivity-testing.html#cb232-90" tabindex="-1"></a>        , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb232-91"><a href="watershed-segmentation-sensitivity-testing.html#cb232-91" tabindex="-1"></a>        <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb232-92"><a href="watershed-segmentation-sensitivity-testing.html#cb232-92" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb232-93"><a href="watershed-segmentation-sensitivity-testing.html#cb232-93" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-94"><a href="watershed-segmentation-sensitivity-testing.html#cb232-94" tabindex="-1"></a>      <span class="co"># ggplot2::geom_rug() +</span></span>
<span id="cb232-95"><a href="watershed-segmentation-sensitivity-testing.html#cb232-95" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb232-96"><a href="watershed-segmentation-sensitivity-testing.html#cb232-96" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb232-97"><a href="watershed-segmentation-sensitivity-testing.html#cb232-97" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb232-98"><a href="watershed-segmentation-sensitivity-testing.html#cb232-98" tabindex="-1"></a>        <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb232-99"><a href="watershed-segmentation-sensitivity-testing.html#cb232-99" tabindex="-1"></a>        <span class="co"># , limits = c(0,1)</span></span>
<span id="cb232-100"><a href="watershed-segmentation-sensitivity-testing.html#cb232-100" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-101"><a href="watershed-segmentation-sensitivity-testing.html#cb232-101" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb232-102"><a href="watershed-segmentation-sensitivity-testing.html#cb232-102" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb232-103"><a href="watershed-segmentation-sensitivity-testing.html#cb232-103" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb232-104"><a href="watershed-segmentation-sensitivity-testing.html#cb232-104" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb232-105"><a href="watershed-segmentation-sensitivity-testing.html#cb232-105" tabindex="-1"></a>        , <span class="at">subtitle =</span> my_subtitle</span>
<span id="cb232-106"><a href="watershed-segmentation-sensitivity-testing.html#cb232-106" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-107"><a href="watershed-segmentation-sensitivity-testing.html#cb232-107" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb232-108"><a href="watershed-segmentation-sensitivity-testing.html#cb232-108" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb232-109"><a href="watershed-segmentation-sensitivity-testing.html#cb232-109" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb232-110"><a href="watershed-segmentation-sensitivity-testing.html#cb232-110" tabindex="-1"></a>        , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb232-111"><a href="watershed-segmentation-sensitivity-testing.html#cb232-111" tabindex="-1"></a>        , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb232-112"><a href="watershed-segmentation-sensitivity-testing.html#cb232-112" tabindex="-1"></a>        , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-113"><a href="watershed-segmentation-sensitivity-testing.html#cb232-113" tabindex="-1"></a>        , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-114"><a href="watershed-segmentation-sensitivity-testing.html#cb232-114" tabindex="-1"></a>        , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-115"><a href="watershed-segmentation-sensitivity-testing.html#cb232-115" tabindex="-1"></a>        , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-116"><a href="watershed-segmentation-sensitivity-testing.html#cb232-116" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb232-117"><a href="watershed-segmentation-sensitivity-testing.html#cb232-117" tabindex="-1"></a>      )</span>
<span id="cb232-118"><a href="watershed-segmentation-sensitivity-testing.html#cb232-118" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb232-119"><a href="watershed-segmentation-sensitivity-testing.html#cb232-119" tabindex="-1"></a>    <span class="co"># agg for median plotting</span></span>
<span id="cb232-120"><a href="watershed-segmentation-sensitivity-testing.html#cb232-120" tabindex="-1"></a>      xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb232-121"><a href="watershed-segmentation-sensitivity-testing.html#cb232-121" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(metric) <span class="sc">%&gt;%</span> </span>
<span id="cb232-122"><a href="watershed-segmentation-sensitivity-testing.html#cb232-122" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb232-123"><a href="watershed-segmentation-sensitivity-testing.html#cb232-123" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb232-124"><a href="watershed-segmentation-sensitivity-testing.html#cb232-124" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb232-125"><a href="watershed-segmentation-sensitivity-testing.html#cb232-125" tabindex="-1"></a>          <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb232-126"><a href="watershed-segmentation-sensitivity-testing.html#cb232-126" tabindex="-1"></a>            <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb232-127"><a href="watershed-segmentation-sensitivity-testing.html#cb232-127" tabindex="-1"></a>            , scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb232-128"><a href="watershed-segmentation-sensitivity-testing.html#cb232-128" tabindex="-1"></a>          )</span>
<span id="cb232-129"><a href="watershed-segmentation-sensitivity-testing.html#cb232-129" tabindex="-1"></a>        )</span>
<span id="cb232-130"><a href="watershed-segmentation-sensitivity-testing.html#cb232-130" tabindex="-1"></a>  </span>
<span id="cb232-131"><a href="watershed-segmentation-sensitivity-testing.html#cb232-131" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb232-132"><a href="watershed-segmentation-sensitivity-testing.html#cb232-132" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb232-133"><a href="watershed-segmentation-sensitivity-testing.html#cb232-133" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric, <span class="at">color =</span> metric)</span>
<span id="cb232-134"><a href="watershed-segmentation-sensitivity-testing.html#cb232-134" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-135"><a href="watershed-segmentation-sensitivity-testing.html#cb232-135" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb232-136"><a href="watershed-segmentation-sensitivity-testing.html#cb232-136" tabindex="-1"></a>      <span class="co"># ggplot2::geom_rug(</span></span>
<span id="cb232-137"><a href="watershed-segmentation-sensitivity-testing.html#cb232-137" tabindex="-1"></a>      <span class="co">#   # # setting these makes the plotting more computationally intensive</span></span>
<span id="cb232-138"><a href="watershed-segmentation-sensitivity-testing.html#cb232-138" tabindex="-1"></a>      <span class="co">#   # alpha = 0.5</span></span>
<span id="cb232-139"><a href="watershed-segmentation-sensitivity-testing.html#cb232-139" tabindex="-1"></a>      <span class="co">#   # , length = ggplot2::unit(0.01, &quot;npc&quot;)</span></span>
<span id="cb232-140"><a href="watershed-segmentation-sensitivity-testing.html#cb232-140" tabindex="-1"></a>      <span class="co"># ) +</span></span>
<span id="cb232-141"><a href="watershed-segmentation-sensitivity-testing.html#cb232-141" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb232-142"><a href="watershed-segmentation-sensitivity-testing.html#cb232-142" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb232-143"><a href="watershed-segmentation-sensitivity-testing.html#cb232-143" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb232-144"><a href="watershed-segmentation-sensitivity-testing.html#cb232-144" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb232-145"><a href="watershed-segmentation-sensitivity-testing.html#cb232-145" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-146"><a href="watershed-segmentation-sensitivity-testing.html#cb232-146" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb232-147"><a href="watershed-segmentation-sensitivity-testing.html#cb232-147" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb232-148"><a href="watershed-segmentation-sensitivity-testing.html#cb232-148" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb232-149"><a href="watershed-segmentation-sensitivity-testing.html#cb232-149" tabindex="-1"></a>          <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb232-150"><a href="watershed-segmentation-sensitivity-testing.html#cb232-150" tabindex="-1"></a>          <span class="co"># x = value, y = 0</span></span>
<span id="cb232-151"><a href="watershed-segmentation-sensitivity-testing.html#cb232-151" tabindex="-1"></a>          , <span class="at">label =</span> value_lab</span>
<span id="cb232-152"><a href="watershed-segmentation-sensitivity-testing.html#cb232-152" tabindex="-1"></a>        )</span>
<span id="cb232-153"><a href="watershed-segmentation-sensitivity-testing.html#cb232-153" tabindex="-1"></a>        , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb232-154"><a href="watershed-segmentation-sensitivity-testing.html#cb232-154" tabindex="-1"></a>        <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb232-155"><a href="watershed-segmentation-sensitivity-testing.html#cb232-155" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb232-156"><a href="watershed-segmentation-sensitivity-testing.html#cb232-156" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-157"><a href="watershed-segmentation-sensitivity-testing.html#cb232-157" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb232-158"><a href="watershed-segmentation-sensitivity-testing.html#cb232-158" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb232-159"><a href="watershed-segmentation-sensitivity-testing.html#cb232-159" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb232-160"><a href="watershed-segmentation-sensitivity-testing.html#cb232-160" tabindex="-1"></a>        <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb232-161"><a href="watershed-segmentation-sensitivity-testing.html#cb232-161" tabindex="-1"></a>        <span class="co"># , limits = c(0,1)</span></span>
<span id="cb232-162"><a href="watershed-segmentation-sensitivity-testing.html#cb232-162" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-163"><a href="watershed-segmentation-sensitivity-testing.html#cb232-163" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb232-164"><a href="watershed-segmentation-sensitivity-testing.html#cb232-164" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb232-165"><a href="watershed-segmentation-sensitivity-testing.html#cb232-165" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb232-166"><a href="watershed-segmentation-sensitivity-testing.html#cb232-166" tabindex="-1"></a>        , <span class="at">subtitle =</span> my_subtitle</span>
<span id="cb232-167"><a href="watershed-segmentation-sensitivity-testing.html#cb232-167" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb232-168"><a href="watershed-segmentation-sensitivity-testing.html#cb232-168" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb232-169"><a href="watershed-segmentation-sensitivity-testing.html#cb232-169" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb232-170"><a href="watershed-segmentation-sensitivity-testing.html#cb232-170" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb232-171"><a href="watershed-segmentation-sensitivity-testing.html#cb232-171" tabindex="-1"></a>        , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb232-172"><a href="watershed-segmentation-sensitivity-testing.html#cb232-172" tabindex="-1"></a>        , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb232-173"><a href="watershed-segmentation-sensitivity-testing.html#cb232-173" tabindex="-1"></a>        , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-174"><a href="watershed-segmentation-sensitivity-testing.html#cb232-174" tabindex="-1"></a>        , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-175"><a href="watershed-segmentation-sensitivity-testing.html#cb232-175" tabindex="-1"></a>        , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-176"><a href="watershed-segmentation-sensitivity-testing.html#cb232-176" tabindex="-1"></a>        , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb232-177"><a href="watershed-segmentation-sensitivity-testing.html#cb232-177" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb232-178"><a href="watershed-segmentation-sensitivity-testing.html#cb232-178" tabindex="-1"></a>      )</span>
<span id="cb232-179"><a href="watershed-segmentation-sensitivity-testing.html#cb232-179" tabindex="-1"></a>    <span class="cf">if</span>(show_rug){</span>
<span id="cb232-180"><a href="watershed-segmentation-sensitivity-testing.html#cb232-180" tabindex="-1"></a>      plt <span class="ot">&lt;-</span> plt <span class="sc">+</span> </span>
<span id="cb232-181"><a href="watershed-segmentation-sensitivity-testing.html#cb232-181" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">geom_rug</span>(</span>
<span id="cb232-182"><a href="watershed-segmentation-sensitivity-testing.html#cb232-182" tabindex="-1"></a>          <span class="co"># # setting these makes the plotting more computationally intensive</span></span>
<span id="cb232-183"><a href="watershed-segmentation-sensitivity-testing.html#cb232-183" tabindex="-1"></a>          <span class="co"># alpha = 0.5</span></span>
<span id="cb232-184"><a href="watershed-segmentation-sensitivity-testing.html#cb232-184" tabindex="-1"></a>          <span class="co"># , length = ggplot2::unit(0.01, &quot;npc&quot;)</span></span>
<span id="cb232-185"><a href="watershed-segmentation-sensitivity-testing.html#cb232-185" tabindex="-1"></a>        )</span>
<span id="cb232-186"><a href="watershed-segmentation-sensitivity-testing.html#cb232-186" tabindex="-1"></a>    }</span>
<span id="cb232-187"><a href="watershed-segmentation-sensitivity-testing.html#cb232-187" tabindex="-1"></a>  }</span>
<span id="cb232-188"><a href="watershed-segmentation-sensitivity-testing.html#cb232-188" tabindex="-1"></a>  <span class="fu">return</span>(plt)</span>
<span id="cb232-189"><a href="watershed-segmentation-sensitivity-testing.html#cb232-189" tabindex="-1"></a>}</span>
<span id="cb232-190"><a href="watershed-segmentation-sensitivity-testing.html#cb232-190" tabindex="-1"></a></span>
<span id="cb232-191"><a href="watershed-segmentation-sensitivity-testing.html#cb232-191" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb232-192"><a href="watershed-segmentation-sensitivity-testing.html#cb232-192" tabindex="-1"></a><span class="fu">plt_detection_dist</span>(</span>
<span id="cb232-193"><a href="watershed-segmentation-sensitivity-testing.html#cb232-193" tabindex="-1"></a>  <span class="at">df =</span> param_combos_gt_agg</span>
<span id="cb232-194"><a href="watershed-segmentation-sensitivity-testing.html#cb232-194" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb232-195"><a href="watershed-segmentation-sensitivity-testing.html#cb232-195" tabindex="-1"></a>     <span class="st">&quot;distribution of pile detection accuracy metrics for all&quot;</span></span>
<span id="cb232-196"><a href="watershed-segmentation-sensitivity-testing.html#cb232-196" tabindex="-1"></a>     , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb232-197"><a href="watershed-segmentation-sensitivity-testing.html#cb232-197" tabindex="-1"></a>     , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">nrow</span>(param_combos_gt_agg), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb232-198"><a href="watershed-segmentation-sensitivity-testing.html#cb232-198" tabindex="-1"></a>     , <span class="st">&quot;) &quot;</span></span>
<span id="cb232-199"><a href="watershed-segmentation-sensitivity-testing.html#cb232-199" tabindex="-1"></a>     , <span class="st">&quot;parameter combinations tested&quot;</span></span>
<span id="cb232-200"><a href="watershed-segmentation-sensitivity-testing.html#cb232-200" tabindex="-1"></a>    )</span>
<span id="cb232-201"><a href="watershed-segmentation-sensitivity-testing.html#cb232-201" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-193-1.png" width="1008" /></p>
</div>
<div id="overall-form-quantification" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Overall: form quantification<a href="watershed-segmentation-sensitivity-testing.html#overall-form-quantification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s check out the the ability of the method to properly extract the form of the piles by looking at the quantification accuracy metrics where:</p>
<ul>
<li><strong>Mean Error (ME)</strong> represents the direction of bias (over or under-prediction) in the original units</li>
<li><strong>RMSE</strong> represents the typical magnitude of error in the original units, with a stronger penalty for large errors</li>
<li><strong>MAPE</strong> represents the typical magnitude of error as a percentage, allowing for scale-independent comparisons</li>
</ul>
<p>as a reminder regarding the form quantification accuracy evaluation, we will assess the method’s accuracy by comparing the true-positive matches using the following metrics:</p>
<ul>
<li><strong>Volume</strong> compares the predicted volume from the irregular elevation profile and footprint to the ground truth paraboloid volume</li>
<li><strong>Diameter</strong> compares the predicted diameter (from the maximum internal distance) to the ground truth field-measured diameter.</li>
<li><strong>Area</strong> compares the predicted area from the irregular shape to the ground truth assumed circular area</li>
<li><strong>Height</strong> compares the predicted maximum height from the CHM to the ground truth field-measured height</li>
</ul>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="watershed-segmentation-sensitivity-testing.html#cb233-1" tabindex="-1"></a><span class="co"># this is a lot of work, so we&#39;re going to make it a function</span></span>
<span id="cb233-2"><a href="watershed-segmentation-sensitivity-testing.html#cb233-2" tabindex="-1"></a>plt_form_quantification_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb233-3"><a href="watershed-segmentation-sensitivity-testing.html#cb233-3" tabindex="-1"></a>  df</span>
<span id="cb233-4"><a href="watershed-segmentation-sensitivity-testing.html#cb233-4" tabindex="-1"></a>  , <span class="at">my_subtitle =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb233-5"><a href="watershed-segmentation-sensitivity-testing.html#cb233-5" tabindex="-1"></a>  , <span class="at">show_rug =</span> T</span>
<span id="cb233-6"><a href="watershed-segmentation-sensitivity-testing.html#cb233-6" tabindex="-1"></a>) {</span>
<span id="cb233-7"><a href="watershed-segmentation-sensitivity-testing.html#cb233-7" tabindex="-1"></a>  <span class="co"># reshape data to go long by evaluation metric</span></span>
<span id="cb233-8"><a href="watershed-segmentation-sensitivity-testing.html#cb233-8" tabindex="-1"></a>  df_temp <span class="ot">&lt;-</span></span>
<span id="cb233-9"><a href="watershed-segmentation-sensitivity-testing.html#cb233-9" tabindex="-1"></a>    df <span class="sc">%&gt;%</span> </span>
<span id="cb233-10"><a href="watershed-segmentation-sensitivity-testing.html#cb233-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb233-11"><a href="watershed-segmentation-sensitivity-testing.html#cb233-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb233-12"><a href="watershed-segmentation-sensitivity-testing.html#cb233-12" tabindex="-1"></a>      <span class="co"># label combining params</span></span>
<span id="cb233-13"><a href="watershed-segmentation-sensitivity-testing.html#cb233-13" tabindex="-1"></a>      <span class="at">lab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct, <span class="at">sep =</span> <span class="st">&quot;:&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb233-14"><a href="watershed-segmentation-sensitivity-testing.html#cb233-14" tabindex="-1"></a>        forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(f_score) <span class="co"># %&gt;% forcats::fct_rev()</span></span>
<span id="cb233-15"><a href="watershed-segmentation-sensitivity-testing.html#cb233-15" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb233-16"><a href="watershed-segmentation-sensitivity-testing.html#cb233-16" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb233-17"><a href="watershed-segmentation-sensitivity-testing.html#cb233-17" tabindex="-1"></a>      max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb233-18"><a href="watershed-segmentation-sensitivity-testing.html#cb233-18" tabindex="-1"></a>      , lab</span>
<span id="cb233-19"><a href="watershed-segmentation-sensitivity-testing.html#cb233-19" tabindex="-1"></a>      <span class="co"># quantification</span></span>
<span id="cb233-20"><a href="watershed-segmentation-sensitivity-testing.html#cb233-20" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb233-21"><a href="watershed-segmentation-sensitivity-testing.html#cb233-21" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rrmse&quot;</span>)</span>
<span id="cb233-22"><a href="watershed-segmentation-sensitivity-testing.html#cb233-22" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb233-23"><a href="watershed-segmentation-sensitivity-testing.html#cb233-23" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb233-24"><a href="watershed-segmentation-sensitivity-testing.html#cb233-24" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb233-25"><a href="watershed-segmentation-sensitivity-testing.html#cb233-25" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb233-26"><a href="watershed-segmentation-sensitivity-testing.html#cb233-26" tabindex="-1"></a>      <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb233-27"><a href="watershed-segmentation-sensitivity-testing.html#cb233-27" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb233-28"><a href="watershed-segmentation-sensitivity-testing.html#cb233-28" tabindex="-1"></a>        , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rrmse&quot;</span>)</span>
<span id="cb233-29"><a href="watershed-segmentation-sensitivity-testing.html#cb233-29" tabindex="-1"></a>        , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb233-30"><a href="watershed-segmentation-sensitivity-testing.html#cb233-30" tabindex="-1"></a>        , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb233-31"><a href="watershed-segmentation-sensitivity-testing.html#cb233-31" tabindex="-1"></a>      )</span>
<span id="cb233-32"><a href="watershed-segmentation-sensitivity-testing.html#cb233-32" tabindex="-1"></a>      , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb233-33"><a href="watershed-segmentation-sensitivity-testing.html#cb233-33" tabindex="-1"></a>      , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb233-34"><a href="watershed-segmentation-sensitivity-testing.html#cb233-34" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb233-35"><a href="watershed-segmentation-sensitivity-testing.html#cb233-35" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb233-36"><a href="watershed-segmentation-sensitivity-testing.html#cb233-36" tabindex="-1"></a>      <span class="at">eval_metric =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(metric, <span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb233-37"><a href="watershed-segmentation-sensitivity-testing.html#cb233-37" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb233-38"><a href="watershed-segmentation-sensitivity-testing.html#cb233-38" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;me&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb233-39"><a href="watershed-segmentation-sensitivity-testing.html#cb233-39" tabindex="-1"></a>        <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb233-40"><a href="watershed-segmentation-sensitivity-testing.html#cb233-40" tabindex="-1"></a>        <span class="fu">factor</span>(</span>
<span id="cb233-41"><a href="watershed-segmentation-sensitivity-testing.html#cb233-41" tabindex="-1"></a>          <span class="at">ordered =</span> T</span>
<span id="cb233-42"><a href="watershed-segmentation-sensitivity-testing.html#cb233-42" tabindex="-1"></a>          , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb233-43"><a href="watershed-segmentation-sensitivity-testing.html#cb233-43" tabindex="-1"></a>        )</span>
<span id="cb233-44"><a href="watershed-segmentation-sensitivity-testing.html#cb233-44" tabindex="-1"></a>      , <span class="at">pile_metric =</span> metric <span class="sc">%&gt;%</span> </span>
<span id="cb233-45"><a href="watershed-segmentation-sensitivity-testing.html#cb233-45" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb233-46"><a href="watershed-segmentation-sensitivity-testing.html#cb233-46" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">&quot;(paraboloid_volume|volume|area|height|diameter)&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb233-47"><a href="watershed-segmentation-sensitivity-testing.html#cb233-47" tabindex="-1"></a>        <span class="fu">factor</span>(</span>
<span id="cb233-48"><a href="watershed-segmentation-sensitivity-testing.html#cb233-48" tabindex="-1"></a>          <span class="at">ordered =</span> T</span>
<span id="cb233-49"><a href="watershed-segmentation-sensitivity-testing.html#cb233-49" tabindex="-1"></a>          , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb233-50"><a href="watershed-segmentation-sensitivity-testing.html#cb233-50" tabindex="-1"></a>            <span class="st">&quot;volume&quot;</span></span>
<span id="cb233-51"><a href="watershed-segmentation-sensitivity-testing.html#cb233-51" tabindex="-1"></a>            , <span class="st">&quot;paraboloid_volume&quot;</span></span>
<span id="cb233-52"><a href="watershed-segmentation-sensitivity-testing.html#cb233-52" tabindex="-1"></a>            , <span class="st">&quot;area&quot;</span></span>
<span id="cb233-53"><a href="watershed-segmentation-sensitivity-testing.html#cb233-53" tabindex="-1"></a>            , <span class="st">&quot;height&quot;</span></span>
<span id="cb233-54"><a href="watershed-segmentation-sensitivity-testing.html#cb233-54" tabindex="-1"></a>            , <span class="st">&quot;diameter&quot;</span></span>
<span id="cb233-55"><a href="watershed-segmentation-sensitivity-testing.html#cb233-55" tabindex="-1"></a>          )</span>
<span id="cb233-56"><a href="watershed-segmentation-sensitivity-testing.html#cb233-56" tabindex="-1"></a>          , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb233-57"><a href="watershed-segmentation-sensitivity-testing.html#cb233-57" tabindex="-1"></a>            <span class="st">&quot;Volume&quot;</span></span>
<span id="cb233-58"><a href="watershed-segmentation-sensitivity-testing.html#cb233-58" tabindex="-1"></a>            , <span class="st">&quot;Volume paraboloid&quot;</span></span>
<span id="cb233-59"><a href="watershed-segmentation-sensitivity-testing.html#cb233-59" tabindex="-1"></a>            , <span class="st">&quot;Area&quot;</span></span>
<span id="cb233-60"><a href="watershed-segmentation-sensitivity-testing.html#cb233-60" tabindex="-1"></a>            , <span class="st">&quot;Height&quot;</span></span>
<span id="cb233-61"><a href="watershed-segmentation-sensitivity-testing.html#cb233-61" tabindex="-1"></a>            , <span class="st">&quot;Diameter&quot;</span></span>
<span id="cb233-62"><a href="watershed-segmentation-sensitivity-testing.html#cb233-62" tabindex="-1"></a>          )</span>
<span id="cb233-63"><a href="watershed-segmentation-sensitivity-testing.html#cb233-63" tabindex="-1"></a>        )</span>
<span id="cb233-64"><a href="watershed-segmentation-sensitivity-testing.html#cb233-64" tabindex="-1"></a>    )</span>
<span id="cb233-65"><a href="watershed-segmentation-sensitivity-testing.html#cb233-65" tabindex="-1"></a>  </span>
<span id="cb233-66"><a href="watershed-segmentation-sensitivity-testing.html#cb233-66" tabindex="-1"></a>  <span class="co"># plot</span></span>
<span id="cb233-67"><a href="watershed-segmentation-sensitivity-testing.html#cb233-67" tabindex="-1"></a>  <span class="co"># !!! we map over the ggplot function to allow for differnt formatting of the x axis</span></span>
<span id="cb233-68"><a href="watershed-segmentation-sensitivity-testing.html#cb233-68" tabindex="-1"></a>  <span class="co"># !!! and to allow for different axis ranges for each individual panel which is not possible when faceting</span></span>
<span id="cb233-69"><a href="watershed-segmentation-sensitivity-testing.html#cb233-69" tabindex="-1"></a>  plt_list_temp <span class="ot">&lt;-</span> </span>
<span id="cb233-70"><a href="watershed-segmentation-sensitivity-testing.html#cb233-70" tabindex="-1"></a>    <span class="co"># get factors in order</span></span>
<span id="cb233-71"><a href="watershed-segmentation-sensitivity-testing.html#cb233-71" tabindex="-1"></a>    df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb233-72"><a href="watershed-segmentation-sensitivity-testing.html#cb233-72" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">!=</span><span class="st">&quot;RRMSE&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb233-73"><a href="watershed-segmentation-sensitivity-testing.html#cb233-73" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">count</span>(eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb233-74"><a href="watershed-segmentation-sensitivity-testing.html#cb233-74" tabindex="-1"></a>    <span class="fu">pull</span>(eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb233-75"><a href="watershed-segmentation-sensitivity-testing.html#cb233-75" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x, <span class="at">my_show_rug=</span>show_rug){</span>
<span id="cb233-76"><a href="watershed-segmentation-sensitivity-testing.html#cb233-76" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(df)<span class="sc">&lt;=</span><span class="dv">15</span>){</span>
<span id="cb233-77"><a href="watershed-segmentation-sensitivity-testing.html#cb233-77" tabindex="-1"></a>        df_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb233-78"><a href="watershed-segmentation-sensitivity-testing.html#cb233-78" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb233-79"><a href="watershed-segmentation-sensitivity-testing.html#cb233-79" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb233-80"><a href="watershed-segmentation-sensitivity-testing.html#cb233-80" tabindex="-1"></a>            <span class="at">value =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb233-81"><a href="watershed-segmentation-sensitivity-testing.html#cb233-81" tabindex="-1"></a>              eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>) <span class="sc">~</span> <span class="fu">round</span>(value,<span class="dv">2</span>)</span>
<span id="cb233-82"><a href="watershed-segmentation-sensitivity-testing.html#cb233-82" tabindex="-1"></a>              , T <span class="sc">~</span> <span class="fu">round</span>(value,<span class="dv">1</span>)</span>
<span id="cb233-83"><a href="watershed-segmentation-sensitivity-testing.html#cb233-83" tabindex="-1"></a>            )</span>
<span id="cb233-84"><a href="watershed-segmentation-sensitivity-testing.html#cb233-84" tabindex="-1"></a>          )</span>
<span id="cb233-85"><a href="watershed-segmentation-sensitivity-testing.html#cb233-85" tabindex="-1"></a>        <span class="co"># aggregate</span></span>
<span id="cb233-86"><a href="watershed-segmentation-sensitivity-testing.html#cb233-86" tabindex="-1"></a>        xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb233-87"><a href="watershed-segmentation-sensitivity-testing.html#cb233-87" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">group_by</span>(pile_metric,eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb233-88"><a href="watershed-segmentation-sensitivity-testing.html#cb233-88" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb233-89"><a href="watershed-segmentation-sensitivity-testing.html#cb233-89" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb233-90"><a href="watershed-segmentation-sensitivity-testing.html#cb233-90" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb233-91"><a href="watershed-segmentation-sensitivity-testing.html#cb233-91" tabindex="-1"></a>            <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb233-92"><a href="watershed-segmentation-sensitivity-testing.html#cb233-92" tabindex="-1"></a>                <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb233-93"><a href="watershed-segmentation-sensitivity-testing.html#cb233-93" tabindex="-1"></a>              , dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb233-94"><a href="watershed-segmentation-sensitivity-testing.html#cb233-94" tabindex="-1"></a>                eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>) <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb233-95"><a href="watershed-segmentation-sensitivity-testing.html#cb233-95" tabindex="-1"></a>                , eval_metric <span class="sc">==</span> <span class="st">&quot;ME&quot;</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb233-96"><a href="watershed-segmentation-sensitivity-testing.html#cb233-96" tabindex="-1"></a>                , T <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb233-97"><a href="watershed-segmentation-sensitivity-testing.html#cb233-97" tabindex="-1"></a>              )</span>
<span id="cb233-98"><a href="watershed-segmentation-sensitivity-testing.html#cb233-98" tabindex="-1"></a>            )</span>
<span id="cb233-99"><a href="watershed-segmentation-sensitivity-testing.html#cb233-99" tabindex="-1"></a>          )</span>
<span id="cb233-100"><a href="watershed-segmentation-sensitivity-testing.html#cb233-100" tabindex="-1"></a>        <span class="co"># plot </span></span>
<span id="cb233-101"><a href="watershed-segmentation-sensitivity-testing.html#cb233-101" tabindex="-1"></a>        p <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb233-102"><a href="watershed-segmentation-sensitivity-testing.html#cb233-102" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">count</span>(eval_metric,pile_metric,value) <span class="sc">%&gt;%</span> </span>
<span id="cb233-103"><a href="watershed-segmentation-sensitivity-testing.html#cb233-103" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb233-104"><a href="watershed-segmentation-sensitivity-testing.html#cb233-104" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> pile_metric, <span class="at">color =</span> pile_metric)</span>
<span id="cb233-105"><a href="watershed-segmentation-sensitivity-testing.html#cb233-105" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-106"><a href="watershed-segmentation-sensitivity-testing.html#cb233-106" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb233-107"><a href="watershed-segmentation-sensitivity-testing.html#cb233-107" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp</span>
<span id="cb233-108"><a href="watershed-segmentation-sensitivity-testing.html#cb233-108" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb233-109"><a href="watershed-segmentation-sensitivity-testing.html#cb233-109" tabindex="-1"></a>            , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb233-110"><a href="watershed-segmentation-sensitivity-testing.html#cb233-110" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-111"><a href="watershed-segmentation-sensitivity-testing.html#cb233-111" tabindex="-1"></a>          <span class="co"># ggplot2::geom_jitter(mapping = ggplot2::aes(y=-0.2), width = 0, height = 0.1) +</span></span>
<span id="cb233-112"><a href="watershed-segmentation-sensitivity-testing.html#cb233-112" tabindex="-1"></a>          <span class="co"># ggplot2::geom_boxplot(width = 0.1, color = &quot;black&quot;, fill = NA, outliers = F) +</span></span>
<span id="cb233-113"><a href="watershed-segmentation-sensitivity-testing.html#cb233-113" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb233-114"><a href="watershed-segmentation-sensitivity-testing.html#cb233-114" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">yend=</span><span class="dv">0</span>)</span>
<span id="cb233-115"><a href="watershed-segmentation-sensitivity-testing.html#cb233-115" tabindex="-1"></a>            , <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb233-116"><a href="watershed-segmentation-sensitivity-testing.html#cb233-116" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-117"><a href="watershed-segmentation-sensitivity-testing.html#cb233-117" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb233-118"><a href="watershed-segmentation-sensitivity-testing.html#cb233-118" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n)</span>
<span id="cb233-119"><a href="watershed-segmentation-sensitivity-testing.html#cb233-119" tabindex="-1"></a>            , <span class="at">alpha =</span> <span class="dv">1</span></span>
<span id="cb233-120"><a href="watershed-segmentation-sensitivity-testing.html#cb233-120" tabindex="-1"></a>            , <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb233-121"><a href="watershed-segmentation-sensitivity-testing.html#cb233-121" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-122"><a href="watershed-segmentation-sensitivity-testing.html#cb233-122" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb233-123"><a href="watershed-segmentation-sensitivity-testing.html#cb233-123" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">label=</span>n)</span>
<span id="cb233-124"><a href="watershed-segmentation-sensitivity-testing.html#cb233-124" tabindex="-1"></a>            , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb233-125"><a href="watershed-segmentation-sensitivity-testing.html#cb233-125" tabindex="-1"></a>            <span class="co"># , vjust = -0.01</span></span>
<span id="cb233-126"><a href="watershed-segmentation-sensitivity-testing.html#cb233-126" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-127"><a href="watershed-segmentation-sensitivity-testing.html#cb233-127" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb233-128"><a href="watershed-segmentation-sensitivity-testing.html#cb233-128" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp</span>
<span id="cb233-129"><a href="watershed-segmentation-sensitivity-testing.html#cb233-129" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb233-130"><a href="watershed-segmentation-sensitivity-testing.html#cb233-130" tabindex="-1"></a>              <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb233-131"><a href="watershed-segmentation-sensitivity-testing.html#cb233-131" tabindex="-1"></a>              <span class="co"># x = value, y = 0</span></span>
<span id="cb233-132"><a href="watershed-segmentation-sensitivity-testing.html#cb233-132" tabindex="-1"></a>              , <span class="at">label =</span> value_lab</span>
<span id="cb233-133"><a href="watershed-segmentation-sensitivity-testing.html#cb233-133" tabindex="-1"></a>            )</span>
<span id="cb233-134"><a href="watershed-segmentation-sensitivity-testing.html#cb233-134" tabindex="-1"></a>            , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb233-135"><a href="watershed-segmentation-sensitivity-testing.html#cb233-135" tabindex="-1"></a>            <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb233-136"><a href="watershed-segmentation-sensitivity-testing.html#cb233-136" tabindex="-1"></a>            , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb233-137"><a href="watershed-segmentation-sensitivity-testing.html#cb233-137" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-138"><a href="watershed-segmentation-sensitivity-testing.html#cb233-138" tabindex="-1"></a>          <span class="co"># ggplot2::geom_rug() +</span></span>
<span id="cb233-139"><a href="watershed-segmentation-sensitivity-testing.html#cb233-139" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-140"><a href="watershed-segmentation-sensitivity-testing.html#cb233-140" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-141"><a href="watershed-segmentation-sensitivity-testing.html#cb233-141" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">33</span>))) <span class="sc">+</span></span>
<span id="cb233-142"><a href="watershed-segmentation-sensitivity-testing.html#cb233-142" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(</span>
<span id="cb233-143"><a href="watershed-segmentation-sensitivity-testing.html#cb233-143" tabindex="-1"></a>            <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(pile_metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(eval_metric)</span>
<span id="cb233-144"><a href="watershed-segmentation-sensitivity-testing.html#cb233-144" tabindex="-1"></a>            , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb233-145"><a href="watershed-segmentation-sensitivity-testing.html#cb233-145" tabindex="-1"></a>            , <span class="at">switch =</span> <span class="st">&quot;y&quot;</span> <span class="co"># moves y facet label to left</span></span>
<span id="cb233-146"><a href="watershed-segmentation-sensitivity-testing.html#cb233-146" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-147"><a href="watershed-segmentation-sensitivity-testing.html#cb233-147" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-148"><a href="watershed-segmentation-sensitivity-testing.html#cb233-148" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb233-149"><a href="watershed-segmentation-sensitivity-testing.html#cb233-149" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb233-150"><a href="watershed-segmentation-sensitivity-testing.html#cb233-150" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb233-151"><a href="watershed-segmentation-sensitivity-testing.html#cb233-151" tabindex="-1"></a>            , <span class="at">strip.placement =</span> <span class="st">&quot;outside&quot;</span></span>
<span id="cb233-152"><a href="watershed-segmentation-sensitivity-testing.html#cb233-152" tabindex="-1"></a>            , <span class="at">strip.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb233-153"><a href="watershed-segmentation-sensitivity-testing.html#cb233-153" tabindex="-1"></a>            , <span class="at">strip.text.y.left =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb233-154"><a href="watershed-segmentation-sensitivity-testing.html#cb233-154" tabindex="-1"></a>            , <span class="at">strip.background.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb233-155"><a href="watershed-segmentation-sensitivity-testing.html#cb233-155" tabindex="-1"></a>            , <span class="at">strip.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb233-156"><a href="watershed-segmentation-sensitivity-testing.html#cb233-156" tabindex="-1"></a>            , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">6.5</span>)</span>
<span id="cb233-157"><a href="watershed-segmentation-sensitivity-testing.html#cb233-157" tabindex="-1"></a>            , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-158"><a href="watershed-segmentation-sensitivity-testing.html#cb233-158" tabindex="-1"></a>            , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-159"><a href="watershed-segmentation-sensitivity-testing.html#cb233-159" tabindex="-1"></a>            , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-160"><a href="watershed-segmentation-sensitivity-testing.html#cb233-160" tabindex="-1"></a>            , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-161"><a href="watershed-segmentation-sensitivity-testing.html#cb233-161" tabindex="-1"></a>          )</span>
<span id="cb233-162"><a href="watershed-segmentation-sensitivity-testing.html#cb233-162" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb233-163"><a href="watershed-segmentation-sensitivity-testing.html#cb233-163" tabindex="-1"></a>        <span class="co"># aggregate</span></span>
<span id="cb233-164"><a href="watershed-segmentation-sensitivity-testing.html#cb233-164" tabindex="-1"></a>        xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb233-165"><a href="watershed-segmentation-sensitivity-testing.html#cb233-165" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">group_by</span>(pile_metric,eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb233-166"><a href="watershed-segmentation-sensitivity-testing.html#cb233-166" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb233-167"><a href="watershed-segmentation-sensitivity-testing.html#cb233-167" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb233-168"><a href="watershed-segmentation-sensitivity-testing.html#cb233-168" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb233-169"><a href="watershed-segmentation-sensitivity-testing.html#cb233-169" tabindex="-1"></a>            <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb233-170"><a href="watershed-segmentation-sensitivity-testing.html#cb233-170" tabindex="-1"></a>                <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb233-171"><a href="watershed-segmentation-sensitivity-testing.html#cb233-171" tabindex="-1"></a>              , dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb233-172"><a href="watershed-segmentation-sensitivity-testing.html#cb233-172" tabindex="-1"></a>                eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>) <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb233-173"><a href="watershed-segmentation-sensitivity-testing.html#cb233-173" tabindex="-1"></a>                , eval_metric <span class="sc">==</span> <span class="st">&quot;ME&quot;</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb233-174"><a href="watershed-segmentation-sensitivity-testing.html#cb233-174" tabindex="-1"></a>                , T <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb233-175"><a href="watershed-segmentation-sensitivity-testing.html#cb233-175" tabindex="-1"></a>              )</span>
<span id="cb233-176"><a href="watershed-segmentation-sensitivity-testing.html#cb233-176" tabindex="-1"></a>            )</span>
<span id="cb233-177"><a href="watershed-segmentation-sensitivity-testing.html#cb233-177" tabindex="-1"></a>          )</span>
<span id="cb233-178"><a href="watershed-segmentation-sensitivity-testing.html#cb233-178" tabindex="-1"></a>        p <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb233-179"><a href="watershed-segmentation-sensitivity-testing.html#cb233-179" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb233-180"><a href="watershed-segmentation-sensitivity-testing.html#cb233-180" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb233-181"><a href="watershed-segmentation-sensitivity-testing.html#cb233-181" tabindex="-1"></a>          <span class="co"># ggplot2::geom_vline(xintercept = 0, color = &quot;gray&quot;) +</span></span>
<span id="cb233-182"><a href="watershed-segmentation-sensitivity-testing.html#cb233-182" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> pile_metric), <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb233-183"><a href="watershed-segmentation-sensitivity-testing.html#cb233-183" tabindex="-1"></a>          <span class="co"># ggplot2::geom_rug(mapping = ggplot2::aes(x = value, color = pile_metric)) +</span></span>
<span id="cb233-184"><a href="watershed-segmentation-sensitivity-testing.html#cb233-184" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-185"><a href="watershed-segmentation-sensitivity-testing.html#cb233-185" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-186"><a href="watershed-segmentation-sensitivity-testing.html#cb233-186" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb233-187"><a href="watershed-segmentation-sensitivity-testing.html#cb233-187" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x)</span>
<span id="cb233-188"><a href="watershed-segmentation-sensitivity-testing.html#cb233-188" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb233-189"><a href="watershed-segmentation-sensitivity-testing.html#cb233-189" tabindex="-1"></a>            , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb233-190"><a href="watershed-segmentation-sensitivity-testing.html#cb233-190" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-191"><a href="watershed-segmentation-sensitivity-testing.html#cb233-191" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb233-192"><a href="watershed-segmentation-sensitivity-testing.html#cb233-192" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x)</span>
<span id="cb233-193"><a href="watershed-segmentation-sensitivity-testing.html#cb233-193" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb233-194"><a href="watershed-segmentation-sensitivity-testing.html#cb233-194" tabindex="-1"></a>              <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb233-195"><a href="watershed-segmentation-sensitivity-testing.html#cb233-195" tabindex="-1"></a>              <span class="co"># x = value, y = 0</span></span>
<span id="cb233-196"><a href="watershed-segmentation-sensitivity-testing.html#cb233-196" tabindex="-1"></a>              , <span class="at">label =</span> value_lab</span>
<span id="cb233-197"><a href="watershed-segmentation-sensitivity-testing.html#cb233-197" tabindex="-1"></a>            )</span>
<span id="cb233-198"><a href="watershed-segmentation-sensitivity-testing.html#cb233-198" tabindex="-1"></a>            , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb233-199"><a href="watershed-segmentation-sensitivity-testing.html#cb233-199" tabindex="-1"></a>            <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb233-200"><a href="watershed-segmentation-sensitivity-testing.html#cb233-200" tabindex="-1"></a>            , <span class="at">size =</span> <span class="fl">2.5</span></span>
<span id="cb233-201"><a href="watershed-segmentation-sensitivity-testing.html#cb233-201" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-202"><a href="watershed-segmentation-sensitivity-testing.html#cb233-202" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(</span>
<span id="cb233-203"><a href="watershed-segmentation-sensitivity-testing.html#cb233-203" tabindex="-1"></a>            <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(pile_metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(eval_metric)</span>
<span id="cb233-204"><a href="watershed-segmentation-sensitivity-testing.html#cb233-204" tabindex="-1"></a>            , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb233-205"><a href="watershed-segmentation-sensitivity-testing.html#cb233-205" tabindex="-1"></a>            , <span class="at">switch =</span> <span class="st">&quot;y&quot;</span> <span class="co"># moves y facet label to left</span></span>
<span id="cb233-206"><a href="watershed-segmentation-sensitivity-testing.html#cb233-206" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb233-207"><a href="watershed-segmentation-sensitivity-testing.html#cb233-207" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-208"><a href="watershed-segmentation-sensitivity-testing.html#cb233-208" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb233-209"><a href="watershed-segmentation-sensitivity-testing.html#cb233-209" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb233-210"><a href="watershed-segmentation-sensitivity-testing.html#cb233-210" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb233-211"><a href="watershed-segmentation-sensitivity-testing.html#cb233-211" tabindex="-1"></a>            , <span class="at">strip.placement =</span> <span class="st">&quot;outside&quot;</span></span>
<span id="cb233-212"><a href="watershed-segmentation-sensitivity-testing.html#cb233-212" tabindex="-1"></a>            , <span class="at">strip.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb233-213"><a href="watershed-segmentation-sensitivity-testing.html#cb233-213" tabindex="-1"></a>            , <span class="at">strip.text.y.left =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb233-214"><a href="watershed-segmentation-sensitivity-testing.html#cb233-214" tabindex="-1"></a>            , <span class="at">strip.background.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb233-215"><a href="watershed-segmentation-sensitivity-testing.html#cb233-215" tabindex="-1"></a>            , <span class="at">strip.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb233-216"><a href="watershed-segmentation-sensitivity-testing.html#cb233-216" tabindex="-1"></a>            , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">6.5</span>)</span>
<span id="cb233-217"><a href="watershed-segmentation-sensitivity-testing.html#cb233-217" tabindex="-1"></a>            , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-218"><a href="watershed-segmentation-sensitivity-testing.html#cb233-218" tabindex="-1"></a>            , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-219"><a href="watershed-segmentation-sensitivity-testing.html#cb233-219" tabindex="-1"></a>            , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-220"><a href="watershed-segmentation-sensitivity-testing.html#cb233-220" tabindex="-1"></a>            , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb233-221"><a href="watershed-segmentation-sensitivity-testing.html#cb233-221" tabindex="-1"></a>          )</span>
<span id="cb233-222"><a href="watershed-segmentation-sensitivity-testing.html#cb233-222" tabindex="-1"></a>        </span>
<span id="cb233-223"><a href="watershed-segmentation-sensitivity-testing.html#cb233-223" tabindex="-1"></a>        <span class="cf">if</span>(my_show_rug){</span>
<span id="cb233-224"><a href="watershed-segmentation-sensitivity-testing.html#cb233-224" tabindex="-1"></a>          p <span class="ot">&lt;-</span> p <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">geom_rug</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> pile_metric))</span>
<span id="cb233-225"><a href="watershed-segmentation-sensitivity-testing.html#cb233-225" tabindex="-1"></a>        }</span>
<span id="cb233-226"><a href="watershed-segmentation-sensitivity-testing.html#cb233-226" tabindex="-1"></a>      }</span>
<span id="cb233-227"><a href="watershed-segmentation-sensitivity-testing.html#cb233-227" tabindex="-1"></a>      </span>
<span id="cb233-228"><a href="watershed-segmentation-sensitivity-testing.html#cb233-228" tabindex="-1"></a>      <span class="cf">if</span>(x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>)){</span>
<span id="cb233-229"><a href="watershed-segmentation-sensitivity-testing.html#cb233-229" tabindex="-1"></a>        <span class="fu">return</span>(p<span class="sc">+</span>ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)))</span>
<span id="cb233-230"><a href="watershed-segmentation-sensitivity-testing.html#cb233-230" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb233-231"><a href="watershed-segmentation-sensitivity-testing.html#cb233-231" tabindex="-1"></a>        <span class="fu">return</span>(p)</span>
<span id="cb233-232"><a href="watershed-segmentation-sensitivity-testing.html#cb233-232" tabindex="-1"></a>      }</span>
<span id="cb233-233"><a href="watershed-segmentation-sensitivity-testing.html#cb233-233" tabindex="-1"></a>    })</span>
<span id="cb233-234"><a href="watershed-segmentation-sensitivity-testing.html#cb233-234" tabindex="-1"></a>  <span class="co"># combine</span></span>
<span id="cb233-235"><a href="watershed-segmentation-sensitivity-testing.html#cb233-235" tabindex="-1"></a>  <span class="co"># plt_list_temp</span></span>
<span id="cb233-236"><a href="watershed-segmentation-sensitivity-testing.html#cb233-236" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb233-237"><a href="watershed-segmentation-sensitivity-testing.html#cb233-237" tabindex="-1"></a>      plt_list_temp</span>
<span id="cb233-238"><a href="watershed-segmentation-sensitivity-testing.html#cb233-238" tabindex="-1"></a>      , <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb233-239"><a href="watershed-segmentation-sensitivity-testing.html#cb233-239" tabindex="-1"></a>  ) <span class="sc">+</span> patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb233-240"><a href="watershed-segmentation-sensitivity-testing.html#cb233-240" tabindex="-1"></a>      <span class="co"># title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)</span></span>
<span id="cb233-241"><a href="watershed-segmentation-sensitivity-testing.html#cb233-241" tabindex="-1"></a>      <span class="at">subtitle =</span> my_subtitle</span>
<span id="cb233-242"><a href="watershed-segmentation-sensitivity-testing.html#cb233-242" tabindex="-1"></a>        <span class="co"># paste0(</span></span>
<span id="cb233-243"><a href="watershed-segmentation-sensitivity-testing.html#cb233-243" tabindex="-1"></a>        <span class="co">#      &quot;distribution of pile form quantification accuracy metrics for all&quot;</span></span>
<span id="cb233-244"><a href="watershed-segmentation-sensitivity-testing.html#cb233-244" tabindex="-1"></a>        <span class="co">#      # , scales::percent(1-pct_rank_th_top,accuracy=1)</span></span>
<span id="cb233-245"><a href="watershed-segmentation-sensitivity-testing.html#cb233-245" tabindex="-1"></a>        <span class="co">#      , &quot; (n=&quot;</span></span>
<span id="cb233-246"><a href="watershed-segmentation-sensitivity-testing.html#cb233-246" tabindex="-1"></a>        <span class="co">#      , scales::comma(nrow(param_combos_gt_agg), accuracy = 1)</span></span>
<span id="cb233-247"><a href="watershed-segmentation-sensitivity-testing.html#cb233-247" tabindex="-1"></a>        <span class="co">#      , &quot;) &quot;</span></span>
<span id="cb233-248"><a href="watershed-segmentation-sensitivity-testing.html#cb233-248" tabindex="-1"></a>        <span class="co">#      , &quot;parameter combinations tested&quot;</span></span>
<span id="cb233-249"><a href="watershed-segmentation-sensitivity-testing.html#cb233-249" tabindex="-1"></a>        <span class="co">#   )</span></span>
<span id="cb233-250"><a href="watershed-segmentation-sensitivity-testing.html#cb233-250" tabindex="-1"></a>      <span class="co"># , caption = &quot;hey&quot;</span></span>
<span id="cb233-251"><a href="watershed-segmentation-sensitivity-testing.html#cb233-251" tabindex="-1"></a>      , <span class="at">theme =</span> ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb233-252"><a href="watershed-segmentation-sensitivity-testing.html#cb233-252" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb233-253"><a href="watershed-segmentation-sensitivity-testing.html#cb233-253" tabindex="-1"></a>      )</span>
<span id="cb233-254"><a href="watershed-segmentation-sensitivity-testing.html#cb233-254" tabindex="-1"></a>    )</span>
<span id="cb233-255"><a href="watershed-segmentation-sensitivity-testing.html#cb233-255" tabindex="-1"></a>}</span>
<span id="cb233-256"><a href="watershed-segmentation-sensitivity-testing.html#cb233-256" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb233-257"><a href="watershed-segmentation-sensitivity-testing.html#cb233-257" tabindex="-1"></a><span class="fu">plt_form_quantification_dist</span>(</span>
<span id="cb233-258"><a href="watershed-segmentation-sensitivity-testing.html#cb233-258" tabindex="-1"></a>  <span class="at">df =</span> param_combos_gt_agg</span>
<span id="cb233-259"><a href="watershed-segmentation-sensitivity-testing.html#cb233-259" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb233-260"><a href="watershed-segmentation-sensitivity-testing.html#cb233-260" tabindex="-1"></a>     <span class="st">&quot;distribution of pile form quantification accuracy metrics for all&quot;</span></span>
<span id="cb233-261"><a href="watershed-segmentation-sensitivity-testing.html#cb233-261" tabindex="-1"></a>     , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb233-262"><a href="watershed-segmentation-sensitivity-testing.html#cb233-262" tabindex="-1"></a>     , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">nrow</span>(param_combos_gt_agg), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb233-263"><a href="watershed-segmentation-sensitivity-testing.html#cb233-263" tabindex="-1"></a>     , <span class="st">&quot;) &quot;</span></span>
<span id="cb233-264"><a href="watershed-segmentation-sensitivity-testing.html#cb233-264" tabindex="-1"></a>     , <span class="st">&quot;parameter combinations tested&quot;</span></span>
<span id="cb233-265"><a href="watershed-segmentation-sensitivity-testing.html#cb233-265" tabindex="-1"></a>  )</span>
<span id="cb233-266"><a href="watershed-segmentation-sensitivity-testing.html#cb233-266" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-194-1.png" width="1008" /></p>
</div>
<div id="main-effects-pile-detection" class="section level3 hasAnchor" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Main Effects: pile detection<a href="watershed-segmentation-sensitivity-testing.html#main-effects-pile-detection" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s average across all other factors to look at the main effect by parameter for instance segmentation performance (i.e. pile detection)</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="watershed-segmentation-sensitivity-testing.html#cb234-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb234-2"><a href="watershed-segmentation-sensitivity-testing.html#cb234-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb234-3"><a href="watershed-segmentation-sensitivity-testing.html#cb234-3" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)</span>
<span id="cb234-4"><a href="watershed-segmentation-sensitivity-testing.html#cb234-4" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb234-5"><a href="watershed-segmentation-sensitivity-testing.html#cb234-5" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb234-6"><a href="watershed-segmentation-sensitivity-testing.html#cb234-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-7"><a href="watershed-segmentation-sensitivity-testing.html#cb234-7" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb234-8"><a href="watershed-segmentation-sensitivity-testing.html#cb234-8" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct)</span>
<span id="cb234-9"><a href="watershed-segmentation-sensitivity-testing.html#cb234-9" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;param&quot;</span></span>
<span id="cb234-10"><a href="watershed-segmentation-sensitivity-testing.html#cb234-10" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;param_value&quot;</span></span>
<span id="cb234-11"><a href="watershed-segmentation-sensitivity-testing.html#cb234-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-12"><a href="watershed-segmentation-sensitivity-testing.html#cb234-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(param, param_value, metric) <span class="sc">%&gt;%</span></span>
<span id="cb234-13"><a href="watershed-segmentation-sensitivity-testing.html#cb234-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb234-14"><a href="watershed-segmentation-sensitivity-testing.html#cb234-14" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)</span>
<span id="cb234-15"><a href="watershed-segmentation-sensitivity-testing.html#cb234-15" tabindex="-1"></a>    , <span class="at">q25 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb234-16"><a href="watershed-segmentation-sensitivity-testing.html#cb234-16" tabindex="-1"></a>    , <span class="at">q75 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb234-17"><a href="watershed-segmentation-sensitivity-testing.html#cb234-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-18"><a href="watershed-segmentation-sensitivity-testing.html#cb234-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb234-19"><a href="watershed-segmentation-sensitivity-testing.html#cb234-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb234-20"><a href="watershed-segmentation-sensitivity-testing.html#cb234-20" tabindex="-1"></a>    <span class="at">param =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb234-21"><a href="watershed-segmentation-sensitivity-testing.html#cb234-21" tabindex="-1"></a>        param <span class="sc">==</span> <span class="st">&quot;max_ht_m&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb234-22"><a href="watershed-segmentation-sensitivity-testing.html#cb234-22" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;min_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb234-23"><a href="watershed-segmentation-sensitivity-testing.html#cb234-23" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;max_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb234-24"><a href="watershed-segmentation-sensitivity-testing.html#cb234-24" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;convexity_pct&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb234-25"><a href="watershed-segmentation-sensitivity-testing.html#cb234-25" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb234-26"><a href="watershed-segmentation-sensitivity-testing.html#cb234-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-27"><a href="watershed-segmentation-sensitivity-testing.html#cb234-27" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb234-28"><a href="watershed-segmentation-sensitivity-testing.html#cb234-28" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb234-29"><a href="watershed-segmentation-sensitivity-testing.html#cb234-29" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb234-30"><a href="watershed-segmentation-sensitivity-testing.html#cb234-30" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb234-31"><a href="watershed-segmentation-sensitivity-testing.html#cb234-31" tabindex="-1"></a>          <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb234-32"><a href="watershed-segmentation-sensitivity-testing.html#cb234-32" tabindex="-1"></a>          , <span class="st">&quot;min_area_m2&quot;</span></span>
<span id="cb234-33"><a href="watershed-segmentation-sensitivity-testing.html#cb234-33" tabindex="-1"></a>          , <span class="st">&quot;max_area_m2&quot;</span></span>
<span id="cb234-34"><a href="watershed-segmentation-sensitivity-testing.html#cb234-34" tabindex="-1"></a>          , <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb234-35"><a href="watershed-segmentation-sensitivity-testing.html#cb234-35" tabindex="-1"></a>          , <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb234-36"><a href="watershed-segmentation-sensitivity-testing.html#cb234-36" tabindex="-1"></a>        )</span>
<span id="cb234-37"><a href="watershed-segmentation-sensitivity-testing.html#cb234-37" tabindex="-1"></a>      )</span>
<span id="cb234-38"><a href="watershed-segmentation-sensitivity-testing.html#cb234-38" tabindex="-1"></a>    , <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb234-39"><a href="watershed-segmentation-sensitivity-testing.html#cb234-39" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb234-40"><a href="watershed-segmentation-sensitivity-testing.html#cb234-40" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb234-41"><a href="watershed-segmentation-sensitivity-testing.html#cb234-41" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb234-42"><a href="watershed-segmentation-sensitivity-testing.html#cb234-42" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-43"><a href="watershed-segmentation-sensitivity-testing.html#cb234-43" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb234-44"><a href="watershed-segmentation-sensitivity-testing.html#cb234-44" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb234-45"><a href="watershed-segmentation-sensitivity-testing.html#cb234-45" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb234-46"><a href="watershed-segmentation-sensitivity-testing.html#cb234-46" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb234-47"><a href="watershed-segmentation-sensitivity-testing.html#cb234-47" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb234-48"><a href="watershed-segmentation-sensitivity-testing.html#cb234-48" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb234-49"><a href="watershed-segmentation-sensitivity-testing.html#cb234-49" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb234-50"><a href="watershed-segmentation-sensitivity-testing.html#cb234-50" tabindex="-1"></a>        )</span>
<span id="cb234-51"><a href="watershed-segmentation-sensitivity-testing.html#cb234-51" tabindex="-1"></a>      )</span>
<span id="cb234-52"><a href="watershed-segmentation-sensitivity-testing.html#cb234-52" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-53"><a href="watershed-segmentation-sensitivity-testing.html#cb234-53" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb234-54"><a href="watershed-segmentation-sensitivity-testing.html#cb234-54" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> median, <span class="at">x =</span> param_value, <span class="at">color =</span> metric, <span class="at">fill =</span> metric, <span class="at">group =</span> metric, <span class="at">shape =</span> metric)</span>
<span id="cb234-55"><a href="watershed-segmentation-sensitivity-testing.html#cb234-55" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb234-56"><a href="watershed-segmentation-sensitivity-testing.html#cb234-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(</span>
<span id="cb234-57"><a href="watershed-segmentation-sensitivity-testing.html#cb234-57" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">ymin =</span> q25, <span class="at">ymax =</span> q75)</span>
<span id="cb234-58"><a href="watershed-segmentation-sensitivity-testing.html#cb234-58" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb234-59"><a href="watershed-segmentation-sensitivity-testing.html#cb234-59" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb234-60"><a href="watershed-segmentation-sensitivity-testing.html#cb234-60" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb234-61"><a href="watershed-segmentation-sensitivity-testing.html#cb234-61" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb234-62"><a href="watershed-segmentation-sensitivity-testing.html#cb234-62" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(param), <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb234-63"><a href="watershed-segmentation-sensitivity-testing.html#cb234-63" tabindex="-1"></a>  <span class="co"># ggplot2::scale_color_viridis_d(begin = 0.2, end = 0.8) +</span></span>
<span id="cb234-64"><a href="watershed-segmentation-sensitivity-testing.html#cb234-64" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb234-65"><a href="watershed-segmentation-sensitivity-testing.html#cb234-65" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb234-66"><a href="watershed-segmentation-sensitivity-testing.html#cb234-66" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels =</span> scales<span class="sc">::</span>percent, <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb234-67"><a href="watershed-segmentation-sensitivity-testing.html#cb234-67" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;median value&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb234-68"><a href="watershed-segmentation-sensitivity-testing.html#cb234-68" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb234-69"><a href="watershed-segmentation-sensitivity-testing.html#cb234-69" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb234-70"><a href="watershed-segmentation-sensitivity-testing.html#cb234-70" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb234-71"><a href="watershed-segmentation-sensitivity-testing.html#cb234-71" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb234-72"><a href="watershed-segmentation-sensitivity-testing.html#cb234-72" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb234-73"><a href="watershed-segmentation-sensitivity-testing.html#cb234-73" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb234-74"><a href="watershed-segmentation-sensitivity-testing.html#cb234-74" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">linetype =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="dv">1</span>))</span>
<span id="cb234-75"><a href="watershed-segmentation-sensitivity-testing.html#cb234-75" tabindex="-1"></a>    , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb234-76"><a href="watershed-segmentation-sensitivity-testing.html#cb234-76" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-196-1.png" width="1008" /></p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="watershed-segmentation-sensitivity-testing.html#cb235-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_test.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>based on these main effect aggregated results:</p>
<ul>
<li>increasing the <code>max_ht_m</code> (determines the “slice” of the CHM to use) reduces precision and F-score with minimal impact on recall</li>
<li>increasing the <code>max_area_m2</code> (determines the maximum pile area) has minimal impact on all three evaluation metrics</li>
<li>increasing <code>convexity_pct</code> toward 1 to favor regular shapes had minimal impact on metrics until parameter values exceeded 0.7, at which point recall decreased, but precision and F-score slightly improved</li>
<li>increasing <code>circle_fit_iou_pct</code> toward 1 to favor circular shapes minimally affected recall while improving precision and F-score up to parameter values of 0.5. Beyond this, recall significantly dropped, with only modest F-score improvements, and overall accuracy measured by F-score crashed past 0.7</li>
</ul>
</div>
<div id="main-effects-form-quantification" class="section level3 hasAnchor" number="6.3.4">
<h3><span class="header-section-number">6.3.4</span> Main Effects: form quantification<a href="watershed-segmentation-sensitivity-testing.html#main-effects-form-quantification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s average across all other factors to look at the main effect by parameter for the <strong>MAPE</strong> metrics quantifying the pile form accuracy</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="watershed-segmentation-sensitivity-testing.html#cb236-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span></span>
<span id="cb236-2"><a href="watershed-segmentation-sensitivity-testing.html#cb236-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb236-3"><a href="watershed-segmentation-sensitivity-testing.html#cb236-3" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb236-4"><a href="watershed-segmentation-sensitivity-testing.html#cb236-4" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb236-5"><a href="watershed-segmentation-sensitivity-testing.html#cb236-5" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb236-6"><a href="watershed-segmentation-sensitivity-testing.html#cb236-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-7"><a href="watershed-segmentation-sensitivity-testing.html#cb236-7" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb236-8"><a href="watershed-segmentation-sensitivity-testing.html#cb236-8" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct)</span>
<span id="cb236-9"><a href="watershed-segmentation-sensitivity-testing.html#cb236-9" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;param&quot;</span></span>
<span id="cb236-10"><a href="watershed-segmentation-sensitivity-testing.html#cb236-10" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;param_value&quot;</span></span>
<span id="cb236-11"><a href="watershed-segmentation-sensitivity-testing.html#cb236-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-12"><a href="watershed-segmentation-sensitivity-testing.html#cb236-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(param, param_value, metric) <span class="sc">%&gt;%</span></span>
<span id="cb236-13"><a href="watershed-segmentation-sensitivity-testing.html#cb236-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb236-14"><a href="watershed-segmentation-sensitivity-testing.html#cb236-14" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)</span>
<span id="cb236-15"><a href="watershed-segmentation-sensitivity-testing.html#cb236-15" tabindex="-1"></a>    , <span class="at">q25 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb236-16"><a href="watershed-segmentation-sensitivity-testing.html#cb236-16" tabindex="-1"></a>    , <span class="at">q75 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb236-17"><a href="watershed-segmentation-sensitivity-testing.html#cb236-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-18"><a href="watershed-segmentation-sensitivity-testing.html#cb236-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb236-19"><a href="watershed-segmentation-sensitivity-testing.html#cb236-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb236-20"><a href="watershed-segmentation-sensitivity-testing.html#cb236-20" tabindex="-1"></a>    <span class="at">param =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb236-21"><a href="watershed-segmentation-sensitivity-testing.html#cb236-21" tabindex="-1"></a>        param <span class="sc">==</span> <span class="st">&quot;max_ht_m&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb236-22"><a href="watershed-segmentation-sensitivity-testing.html#cb236-22" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;min_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb236-23"><a href="watershed-segmentation-sensitivity-testing.html#cb236-23" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;max_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb236-24"><a href="watershed-segmentation-sensitivity-testing.html#cb236-24" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;convexity_pct&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb236-25"><a href="watershed-segmentation-sensitivity-testing.html#cb236-25" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb236-26"><a href="watershed-segmentation-sensitivity-testing.html#cb236-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-27"><a href="watershed-segmentation-sensitivity-testing.html#cb236-27" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb236-28"><a href="watershed-segmentation-sensitivity-testing.html#cb236-28" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb236-29"><a href="watershed-segmentation-sensitivity-testing.html#cb236-29" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb236-30"><a href="watershed-segmentation-sensitivity-testing.html#cb236-30" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb236-31"><a href="watershed-segmentation-sensitivity-testing.html#cb236-31" tabindex="-1"></a>          <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb236-32"><a href="watershed-segmentation-sensitivity-testing.html#cb236-32" tabindex="-1"></a>          , <span class="st">&quot;min_area_m2&quot;</span></span>
<span id="cb236-33"><a href="watershed-segmentation-sensitivity-testing.html#cb236-33" tabindex="-1"></a>          , <span class="st">&quot;max_area_m2&quot;</span></span>
<span id="cb236-34"><a href="watershed-segmentation-sensitivity-testing.html#cb236-34" tabindex="-1"></a>          , <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb236-35"><a href="watershed-segmentation-sensitivity-testing.html#cb236-35" tabindex="-1"></a>          , <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb236-36"><a href="watershed-segmentation-sensitivity-testing.html#cb236-36" tabindex="-1"></a>        )</span>
<span id="cb236-37"><a href="watershed-segmentation-sensitivity-testing.html#cb236-37" tabindex="-1"></a>      )</span>
<span id="cb236-38"><a href="watershed-segmentation-sensitivity-testing.html#cb236-38" tabindex="-1"></a>    , <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb236-39"><a href="watershed-segmentation-sensitivity-testing.html#cb236-39" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb236-40"><a href="watershed-segmentation-sensitivity-testing.html#cb236-40" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb236-41"><a href="watershed-segmentation-sensitivity-testing.html#cb236-41" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb236-42"><a href="watershed-segmentation-sensitivity-testing.html#cb236-42" tabindex="-1"></a>        <span class="co"># rmse</span></span>
<span id="cb236-43"><a href="watershed-segmentation-sensitivity-testing.html#cb236-43" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_volume_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb236-44"><a href="watershed-segmentation-sensitivity-testing.html#cb236-44" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_paraboloid_volume_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb236-45"><a href="watershed-segmentation-sensitivity-testing.html#cb236-45" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_area_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">6</span></span>
<span id="cb236-46"><a href="watershed-segmentation-sensitivity-testing.html#cb236-46" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_height_mape&quot;</span> <span class="sc">~</span> <span class="dv">7</span></span>
<span id="cb236-47"><a href="watershed-segmentation-sensitivity-testing.html#cb236-47" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_diameter_mape&quot;</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb236-48"><a href="watershed-segmentation-sensitivity-testing.html#cb236-48" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-49"><a href="watershed-segmentation-sensitivity-testing.html#cb236-49" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb236-50"><a href="watershed-segmentation-sensitivity-testing.html#cb236-50" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb236-51"><a href="watershed-segmentation-sensitivity-testing.html#cb236-51" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb236-52"><a href="watershed-segmentation-sensitivity-testing.html#cb236-52" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb236-53"><a href="watershed-segmentation-sensitivity-testing.html#cb236-53" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb236-54"><a href="watershed-segmentation-sensitivity-testing.html#cb236-54" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb236-55"><a href="watershed-segmentation-sensitivity-testing.html#cb236-55" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb236-56"><a href="watershed-segmentation-sensitivity-testing.html#cb236-56" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Volume irregular (%)&quot;</span></span>
<span id="cb236-57"><a href="watershed-segmentation-sensitivity-testing.html#cb236-57" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Volume paraboloid (%)&quot;</span></span>
<span id="cb236-58"><a href="watershed-segmentation-sensitivity-testing.html#cb236-58" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Area (%)&quot;</span></span>
<span id="cb236-59"><a href="watershed-segmentation-sensitivity-testing.html#cb236-59" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Height (%)&quot;</span></span>
<span id="cb236-60"><a href="watershed-segmentation-sensitivity-testing.html#cb236-60" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Diameter (%)&quot;</span></span>
<span id="cb236-61"><a href="watershed-segmentation-sensitivity-testing.html#cb236-61" tabindex="-1"></a>        )</span>
<span id="cb236-62"><a href="watershed-segmentation-sensitivity-testing.html#cb236-62" tabindex="-1"></a>      )</span>
<span id="cb236-63"><a href="watershed-segmentation-sensitivity-testing.html#cb236-63" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-64"><a href="watershed-segmentation-sensitivity-testing.html#cb236-64" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb236-65"><a href="watershed-segmentation-sensitivity-testing.html#cb236-65" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> median, <span class="at">x =</span> param_value, <span class="at">color =</span> metric, <span class="at">fill =</span> metric, <span class="at">group =</span> metric, <span class="at">shape =</span> metric)</span>
<span id="cb236-66"><a href="watershed-segmentation-sensitivity-testing.html#cb236-66" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb236-67"><a href="watershed-segmentation-sensitivity-testing.html#cb236-67" tabindex="-1"></a>  <span class="co"># ggplot2::geom_ribbon(</span></span>
<span id="cb236-68"><a href="watershed-segmentation-sensitivity-testing.html#cb236-68" tabindex="-1"></a>  <span class="co">#   mapping = ggplot2::aes(ymin = q25, ymax = q75)</span></span>
<span id="cb236-69"><a href="watershed-segmentation-sensitivity-testing.html#cb236-69" tabindex="-1"></a>  <span class="co">#   , alpha = 0.2, color = NA</span></span>
<span id="cb236-70"><a href="watershed-segmentation-sensitivity-testing.html#cb236-70" tabindex="-1"></a>  <span class="co"># ) +</span></span>
<span id="cb236-71"><a href="watershed-segmentation-sensitivity-testing.html#cb236-71" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb236-72"><a href="watershed-segmentation-sensitivity-testing.html#cb236-72" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb236-73"><a href="watershed-segmentation-sensitivity-testing.html#cb236-73" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(param), <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb236-74"><a href="watershed-segmentation-sensitivity-testing.html#cb236-74" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb236-75"><a href="watershed-segmentation-sensitivity-testing.html#cb236-75" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb236-76"><a href="watershed-segmentation-sensitivity-testing.html#cb236-76" tabindex="-1"></a>  <span class="co"># ggplot2::scale_fill_manual(values = pal_get_pairs_fn(6)[1:5]) +</span></span>
<span id="cb236-77"><a href="watershed-segmentation-sensitivity-testing.html#cb236-77" tabindex="-1"></a>  <span class="co"># ggplot2::scale_color_manual(values = pal_get_pairs_fn(6)[1:5]) +</span></span>
<span id="cb236-78"><a href="watershed-segmentation-sensitivity-testing.html#cb236-78" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb236-79"><a href="watershed-segmentation-sensitivity-testing.html#cb236-79" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels =</span> scales<span class="sc">::</span>percent, <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb236-80"><a href="watershed-segmentation-sensitivity-testing.html#cb236-80" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;median value&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb236-81"><a href="watershed-segmentation-sensitivity-testing.html#cb236-81" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb236-82"><a href="watershed-segmentation-sensitivity-testing.html#cb236-82" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb236-83"><a href="watershed-segmentation-sensitivity-testing.html#cb236-83" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb236-84"><a href="watershed-segmentation-sensitivity-testing.html#cb236-84" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb236-85"><a href="watershed-segmentation-sensitivity-testing.html#cb236-85" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb236-86"><a href="watershed-segmentation-sensitivity-testing.html#cb236-86" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb236-87"><a href="watershed-segmentation-sensitivity-testing.html#cb236-87" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">linetype =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="dv">1</span>))</span>
<span id="cb236-88"><a href="watershed-segmentation-sensitivity-testing.html#cb236-88" tabindex="-1"></a>    , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb236-89"><a href="watershed-segmentation-sensitivity-testing.html#cb236-89" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-197-1.png" width="1008" /></p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="watershed-segmentation-sensitivity-testing.html#cb237-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_test_mape.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">9</span>)</span></code></pre></div>
<p>these results indicate that the method’s accuracy in outlining slash pile form is robust to parameter changes, as the relevant shape accuracy metrics remain consistent across various settings</p>
</div>
<div id="best-results-detection-accuracy" class="section level3 hasAnchor" number="6.3.5">
<h3><span class="header-section-number">6.3.5</span> Best results: detection accuracy<a href="watershed-segmentation-sensitivity-testing.html#best-results-detection-accuracy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we can cut to the chase and just look at the parameter combinations that achieved the best results based on the detection accuracy metrics</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="watershed-segmentation-sensitivity-testing.html#cb238-1" tabindex="-1"></a>pct_rank_th_temp <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="cb238-2"><a href="watershed-segmentation-sensitivity-testing.html#cb238-2" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span></span>
<span id="cb238-3"><a href="watershed-segmentation-sensitivity-testing.html#cb238-3" tabindex="-1"></a>  param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb238-4"><a href="watershed-segmentation-sensitivity-testing.html#cb238-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb238-5"><a href="watershed-segmentation-sensitivity-testing.html#cb238-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(f_score), <span class="fu">desc</span>(recall), <span class="fu">desc</span>(precision), pct_diff_volume_field_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb238-6"><a href="watershed-segmentation-sensitivity-testing.html#cb238-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb238-7"><a href="watershed-segmentation-sensitivity-testing.html#cb238-7" tabindex="-1"></a>    <span class="co"># label combining params</span></span>
<span id="cb238-8"><a href="watershed-segmentation-sensitivity-testing.html#cb238-8" tabindex="-1"></a>    <span class="at">lab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct, <span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)</span>
<span id="cb238-9"><a href="watershed-segmentation-sensitivity-testing.html#cb238-9" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb238-10"><a href="watershed-segmentation-sensitivity-testing.html#cb238-10" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(f_score,precision,recall)</span>
<span id="cb238-11"><a href="watershed-segmentation-sensitivity-testing.html#cb238-11" tabindex="-1"></a>      , <span class="at">.fn =</span> dplyr<span class="sc">::</span>percent_rank</span>
<span id="cb238-12"><a href="watershed-segmentation-sensitivity-testing.html#cb238-12" tabindex="-1"></a>      , <span class="at">.names =</span> <span class="st">&quot;pct_rank_{.col}&quot;</span></span>
<span id="cb238-13"><a href="watershed-segmentation-sensitivity-testing.html#cb238-13" tabindex="-1"></a>    )</span>
<span id="cb238-14"><a href="watershed-segmentation-sensitivity-testing.html#cb238-14" tabindex="-1"></a>    , <span class="at">sort_lab =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb238-15"><a href="watershed-segmentation-sensitivity-testing.html#cb238-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-16"><a href="watershed-segmentation-sensitivity-testing.html#cb238-16" tabindex="-1"></a>  <span class="co"># dplyr::select(precision, pct_rank_precision) %&gt;%</span></span>
<span id="cb238-17"><a href="watershed-segmentation-sensitivity-testing.html#cb238-17" tabindex="-1"></a>  <span class="co"># dplyr::arrange(desc(precision), desc(pct_rank_precision)) %&gt;%</span></span>
<span id="cb238-18"><a href="watershed-segmentation-sensitivity-testing.html#cb238-18" tabindex="-1"></a>  <span class="co"># View()</span></span>
<span id="cb238-19"><a href="watershed-segmentation-sensitivity-testing.html#cb238-19" tabindex="-1"></a>  <span class="co"># now get the max of these pct ranks by row</span></span>
<span id="cb238-20"><a href="watershed-segmentation-sensitivity-testing.html#cb238-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb238-21"><a href="watershed-segmentation-sensitivity-testing.html#cb238-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb238-22"><a href="watershed-segmentation-sensitivity-testing.html#cb238-22" tabindex="-1"></a>    <span class="at">pct_rank_max =</span> <span class="fu">max</span>(</span>
<span id="cb238-23"><a href="watershed-segmentation-sensitivity-testing.html#cb238-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">c_across</span>(</span>
<span id="cb238-24"><a href="watershed-segmentation-sensitivity-testing.html#cb238-24" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb238-25"><a href="watershed-segmentation-sensitivity-testing.html#cb238-25" tabindex="-1"></a>      )</span>
<span id="cb238-26"><a href="watershed-segmentation-sensitivity-testing.html#cb238-26" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb238-27"><a href="watershed-segmentation-sensitivity-testing.html#cb238-27" tabindex="-1"></a>    )</span>
<span id="cb238-28"><a href="watershed-segmentation-sensitivity-testing.html#cb238-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-29"><a href="watershed-segmentation-sensitivity-testing.html#cb238-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb238-30"><a href="watershed-segmentation-sensitivity-testing.html#cb238-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_rank_max<span class="sc">&gt;=</span>pct_rank_th_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb238-31"><a href="watershed-segmentation-sensitivity-testing.html#cb238-31" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb238-32"><a href="watershed-segmentation-sensitivity-testing.html#cb238-32" tabindex="-1"></a>    rn,max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb238-33"><a href="watershed-segmentation-sensitivity-testing.html#cb238-33" tabindex="-1"></a>    , lab, sort_lab</span>
<span id="cb238-34"><a href="watershed-segmentation-sensitivity-testing.html#cb238-34" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb238-35"><a href="watershed-segmentation-sensitivity-testing.html#cb238-35" tabindex="-1"></a>    , <span class="fu">c</span>(f_score,precision,recall)</span>
<span id="cb238-36"><a href="watershed-segmentation-sensitivity-testing.html#cb238-36" tabindex="-1"></a>    , <span class="sc">-</span><span class="fu">c</span>(pct_rank_max)</span>
<span id="cb238-37"><a href="watershed-segmentation-sensitivity-testing.html#cb238-37" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-38"><a href="watershed-segmentation-sensitivity-testing.html#cb238-38" tabindex="-1"></a>  <span class="co"># expand data to unique lab, pct_rank</span></span>
<span id="cb238-39"><a href="watershed-segmentation-sensitivity-testing.html#cb238-39" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb238-40"><a href="watershed-segmentation-sensitivity-testing.html#cb238-40" tabindex="-1"></a>    <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb238-41"><a href="watershed-segmentation-sensitivity-testing.html#cb238-41" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb238-42"><a href="watershed-segmentation-sensitivity-testing.html#cb238-42" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb238-43"><a href="watershed-segmentation-sensitivity-testing.html#cb238-43" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-44"><a href="watershed-segmentation-sensitivity-testing.html#cb238-44" tabindex="-1"></a>  <span class="co"># keep only relevant records </span></span>
<span id="cb238-45"><a href="watershed-segmentation-sensitivity-testing.html#cb238-45" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(value<span class="sc">&gt;=</span>pct_rank_th_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb238-46"><a href="watershed-segmentation-sensitivity-testing.html#cb238-46" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(metric) <span class="sc">%&gt;%</span> </span>
<span id="cb238-47"><a href="watershed-segmentation-sensitivity-testing.html#cb238-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(value),<span class="fu">desc</span>(f_score), <span class="fu">desc</span>(recall), <span class="fu">desc</span>(precision)) <span class="sc">%&gt;%</span> </span>
<span id="cb238-48"><a href="watershed-segmentation-sensitivity-testing.html#cb238-48" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span><span class="dv">11</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb238-49"><a href="watershed-segmentation-sensitivity-testing.html#cb238-49" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb238-50"><a href="watershed-segmentation-sensitivity-testing.html#cb238-50" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb238-51"><a href="watershed-segmentation-sensitivity-testing.html#cb238-51" tabindex="-1"></a>    <span class="at">rank_lab =</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(metric,<span class="st">&quot;pct_rank_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb238-52"><a href="watershed-segmentation-sensitivity-testing.html#cb238-52" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb238-53"><a href="watershed-segmentation-sensitivity-testing.html#cb238-53" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb238-54"><a href="watershed-segmentation-sensitivity-testing.html#cb238-54" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb238-55"><a href="watershed-segmentation-sensitivity-testing.html#cb238-55" tabindex="-1"></a>          <span class="st">&quot;f_score&quot;</span></span>
<span id="cb238-56"><a href="watershed-segmentation-sensitivity-testing.html#cb238-56" tabindex="-1"></a>          , <span class="st">&quot;recall&quot;</span></span>
<span id="cb238-57"><a href="watershed-segmentation-sensitivity-testing.html#cb238-57" tabindex="-1"></a>          , <span class="st">&quot;precision&quot;</span></span>
<span id="cb238-58"><a href="watershed-segmentation-sensitivity-testing.html#cb238-58" tabindex="-1"></a>        )</span>
<span id="cb238-59"><a href="watershed-segmentation-sensitivity-testing.html#cb238-59" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb238-60"><a href="watershed-segmentation-sensitivity-testing.html#cb238-60" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; F-Score&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb238-61"><a href="watershed-segmentation-sensitivity-testing.html#cb238-61" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; Recall&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb238-62"><a href="watershed-segmentation-sensitivity-testing.html#cb238-62" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; Precision&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb238-63"><a href="watershed-segmentation-sensitivity-testing.html#cb238-63" tabindex="-1"></a>        )</span>
<span id="cb238-64"><a href="watershed-segmentation-sensitivity-testing.html#cb238-64" tabindex="-1"></a>      )</span>
<span id="cb238-65"><a href="watershed-segmentation-sensitivity-testing.html#cb238-65" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-66"><a href="watershed-segmentation-sensitivity-testing.html#cb238-66" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(metric,value))</span>
<span id="cb238-67"><a href="watershed-segmentation-sensitivity-testing.html#cb238-67" tabindex="-1"></a>  </span>
<span id="cb238-68"><a href="watershed-segmentation-sensitivity-testing.html#cb238-68" tabindex="-1"></a><span class="co"># df_temp %&gt;% dplyr::count(rank_lab)</span></span>
<span id="cb238-69"><a href="watershed-segmentation-sensitivity-testing.html#cb238-69" tabindex="-1"></a><span class="co"># df_temp %&gt;% dplyr::glimpse()</span></span>
<span id="cb238-70"><a href="watershed-segmentation-sensitivity-testing.html#cb238-70" tabindex="-1"></a></span>
<span id="cb238-71"><a href="watershed-segmentation-sensitivity-testing.html#cb238-71" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb238-72"><a href="watershed-segmentation-sensitivity-testing.html#cb238-72" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb238-73"><a href="watershed-segmentation-sensitivity-testing.html#cb238-73" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb238-74"><a href="watershed-segmentation-sensitivity-testing.html#cb238-74" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)</span>
<span id="cb238-75"><a href="watershed-segmentation-sensitivity-testing.html#cb238-75" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb238-76"><a href="watershed-segmentation-sensitivity-testing.html#cb238-76" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb238-77"><a href="watershed-segmentation-sensitivity-testing.html#cb238-77" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-78"><a href="watershed-segmentation-sensitivity-testing.html#cb238-78" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb238-79"><a href="watershed-segmentation-sensitivity-testing.html#cb238-79" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb238-80"><a href="watershed-segmentation-sensitivity-testing.html#cb238-80" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb238-81"><a href="watershed-segmentation-sensitivity-testing.html#cb238-81" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb238-82"><a href="watershed-segmentation-sensitivity-testing.html#cb238-82" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb238-83"><a href="watershed-segmentation-sensitivity-testing.html#cb238-83" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-84"><a href="watershed-segmentation-sensitivity-testing.html#cb238-84" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb238-85"><a href="watershed-segmentation-sensitivity-testing.html#cb238-85" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb238-86"><a href="watershed-segmentation-sensitivity-testing.html#cb238-86" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb238-87"><a href="watershed-segmentation-sensitivity-testing.html#cb238-87" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb238-88"><a href="watershed-segmentation-sensitivity-testing.html#cb238-88" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb238-89"><a href="watershed-segmentation-sensitivity-testing.html#cb238-89" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb238-90"><a href="watershed-segmentation-sensitivity-testing.html#cb238-90" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb238-91"><a href="watershed-segmentation-sensitivity-testing.html#cb238-91" tabindex="-1"></a>        )</span>
<span id="cb238-92"><a href="watershed-segmentation-sensitivity-testing.html#cb238-92" tabindex="-1"></a>      )</span>
<span id="cb238-93"><a href="watershed-segmentation-sensitivity-testing.html#cb238-93" tabindex="-1"></a>    , <span class="at">lab =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(lab, sort_lab) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb238-94"><a href="watershed-segmentation-sensitivity-testing.html#cb238-94" tabindex="-1"></a>    , <span class="at">val_lab =</span> scales<span class="sc">::</span><span class="fu">percent</span>(value, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb238-95"><a href="watershed-segmentation-sensitivity-testing.html#cb238-95" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb238-96"><a href="watershed-segmentation-sensitivity-testing.html#cb238-96" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb238-97"><a href="watershed-segmentation-sensitivity-testing.html#cb238-97" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> lab, <span class="at">fill =</span> metric, <span class="at">label =</span> val_lab)</span>
<span id="cb238-98"><a href="watershed-segmentation-sensitivity-testing.html#cb238-98" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb238-99"><a href="watershed-segmentation-sensitivity-testing.html#cb238-99" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb238-100"><a href="watershed-segmentation-sensitivity-testing.html#cb238-100" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb238-101"><a href="watershed-segmentation-sensitivity-testing.html#cb238-101" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb238-102"><a href="watershed-segmentation-sensitivity-testing.html#cb238-102" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb238-103"><a href="watershed-segmentation-sensitivity-testing.html#cb238-103" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb238-104"><a href="watershed-segmentation-sensitivity-testing.html#cb238-104" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.11</span>)</span>
<span id="cb238-105"><a href="watershed-segmentation-sensitivity-testing.html#cb238-105" tabindex="-1"></a>    <span class="co"># , expand = expansion(mult = c(0, .08))</span></span>
<span id="cb238-106"><a href="watershed-segmentation-sensitivity-testing.html#cb238-106" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb238-107"><a href="watershed-segmentation-sensitivity-testing.html#cb238-107" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(rank_lab), <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb238-108"><a href="watershed-segmentation-sensitivity-testing.html#cb238-108" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb238-109"><a href="watershed-segmentation-sensitivity-testing.html#cb238-109" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;max_ht_m : max_area_m2 : convexity_pct : circle_fit_iou_pct&quot;</span></span>
<span id="cb238-110"><a href="watershed-segmentation-sensitivity-testing.html#cb238-110" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb238-111"><a href="watershed-segmentation-sensitivity-testing.html#cb238-111" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;top parameter combinations by evaluation metrics&quot;</span></span>
<span id="cb238-112"><a href="watershed-segmentation-sensitivity-testing.html#cb238-112" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb238-113"><a href="watershed-segmentation-sensitivity-testing.html#cb238-113" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb238-114"><a href="watershed-segmentation-sensitivity-testing.html#cb238-114" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb238-115"><a href="watershed-segmentation-sensitivity-testing.html#cb238-115" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb238-116"><a href="watershed-segmentation-sensitivity-testing.html#cb238-116" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb238-117"><a href="watershed-segmentation-sensitivity-testing.html#cb238-117" tabindex="-1"></a>    , <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb238-118"><a href="watershed-segmentation-sensitivity-testing.html#cb238-118" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-198-1.png" width="1008" /></p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="watershed-segmentation-sensitivity-testing.html#cb239-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_ever_bars.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>let’s make a table of these results</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="watershed-segmentation-sensitivity-testing.html#cb240-1" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb240-2"><a href="watershed-segmentation-sensitivity-testing.html#cb240-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb240-3"><a href="watershed-segmentation-sensitivity-testing.html#cb240-3" tabindex="-1"></a>    rank_lab</span>
<span id="cb240-4"><a href="watershed-segmentation-sensitivity-testing.html#cb240-4" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb240-5"><a href="watershed-segmentation-sensitivity-testing.html#cb240-5" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb240-6"><a href="watershed-segmentation-sensitivity-testing.html#cb240-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb240-7"><a href="watershed-segmentation-sensitivity-testing.html#cb240-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb240-8"><a href="watershed-segmentation-sensitivity-testing.html#cb240-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(rank_lab,<span class="fu">desc</span>(f_score), <span class="fu">desc</span>(recall), <span class="fu">desc</span>(precision)) <span class="sc">%&gt;%</span> </span>
<span id="cb240-9"><a href="watershed-segmentation-sensitivity-testing.html#cb240-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb240-10"><a href="watershed-segmentation-sensitivity-testing.html#cb240-10" tabindex="-1"></a>    <span class="at">.cols =</span> <span class="fu">c</span>(f_score, recall, precision)</span>
<span id="cb240-11"><a href="watershed-segmentation-sensitivity-testing.html#cb240-11" tabindex="-1"></a>    , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb240-12"><a href="watershed-segmentation-sensitivity-testing.html#cb240-12" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb240-13"><a href="watershed-segmentation-sensitivity-testing.html#cb240-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">blank=</span> <span class="st">&quot;   &quot;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb240-14"><a href="watershed-segmentation-sensitivity-testing.html#cb240-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(blank, <span class="at">.before =</span> f_score) <span class="sc">%&gt;%</span> </span>
<span id="cb240-15"><a href="watershed-segmentation-sensitivity-testing.html#cb240-15" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb240-16"><a href="watershed-segmentation-sensitivity-testing.html#cb240-16" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;parameter combinations that achieved the best slash pile detection results&quot;</span></span>
<span id="cb240-17"><a href="watershed-segmentation-sensitivity-testing.html#cb240-17" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb240-18"><a href="watershed-segmentation-sensitivity-testing.html#cb240-18" tabindex="-1"></a>      <span class="st">&quot;.&quot;</span></span>
<span id="cb240-19"><a href="watershed-segmentation-sensitivity-testing.html#cb240-19" tabindex="-1"></a>      ,<span class="st">&quot;max_ht_m&quot;</span>,<span class="st">&quot;max_area_m2&quot;</span>,<span class="st">&quot;convexity_pct&quot;</span>,<span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb240-20"><a href="watershed-segmentation-sensitivity-testing.html#cb240-20" tabindex="-1"></a>      , <span class="st">&quot;   &quot;</span></span>
<span id="cb240-21"><a href="watershed-segmentation-sensitivity-testing.html#cb240-21" tabindex="-1"></a>      , <span class="st">&quot;F-score&quot;</span>, <span class="st">&quot;Recall&quot;</span>, <span class="st">&quot;Precision&quot;</span></span>
<span id="cb240-22"><a href="watershed-segmentation-sensitivity-testing.html#cb240-22" tabindex="-1"></a>    )</span>
<span id="cb240-23"><a href="watershed-segmentation-sensitivity-testing.html#cb240-23" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb240-24"><a href="watershed-segmentation-sensitivity-testing.html#cb240-24" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb240-25"><a href="watershed-segmentation-sensitivity-testing.html#cb240-25" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">11</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb240-26"><a href="watershed-segmentation-sensitivity-testing.html#cb240-26" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb240-27"><a href="watershed-segmentation-sensitivity-testing.html#cb240-27" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">6</span>, <span class="st">&quot;Evaluation Metric&quot;</span> <span class="ot">=</span> <span class="dv">3</span>))</span></code></pre></div>
<table class="table" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-199">Table 6.1: </span>parameter combinations that achieved the best slash pile detection results
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="6">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Evaluation Metric
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
.
</th>
<th style="text-align:right;">
max_ht_m
</th>
<th style="text-align:right;">
max_area_m2
</th>
<th style="text-align:right;">
convexity_pct
</th>
<th style="text-align:right;">
circle_fit_iou_pct
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
F-score
</th>
<th style="text-align:left;">
Recall
</th>
<th style="text-align:left;">
Precision
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="11">
top 5% F-Score
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
76%
</td>
<td style="text-align:left;">
75%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="11">
top 5% Recall
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
59%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
59%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
59%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
59%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
59%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
59%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
57%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
57%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
57%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
57%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
92%
</td>
<td style="text-align:left;">
57%
</td>
</tr>
</tbody>
</table>
<p>let’s check out maps of the pile detection results for the parameter combinations with the highest F-score</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="watershed-segmentation-sensitivity-testing.html#cb241-1" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span></span>
<span id="cb241-2"><a href="watershed-segmentation-sensitivity-testing.html#cb241-2" tabindex="-1"></a>  df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb241-3"><a href="watershed-segmentation-sensitivity-testing.html#cb241-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb241-4"><a href="watershed-segmentation-sensitivity-testing.html#cb241-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(f_score), <span class="fu">desc</span>(recall), <span class="fu">desc</span>(precision)) <span class="sc">%&gt;%</span> </span>
<span id="cb241-5"><a href="watershed-segmentation-sensitivity-testing.html#cb241-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb241-6"><a href="watershed-segmentation-sensitivity-testing.html#cb241-6" tabindex="-1"></a>    rn, rank_lab</span>
<span id="cb241-7"><a href="watershed-segmentation-sensitivity-testing.html#cb241-7" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb241-8"><a href="watershed-segmentation-sensitivity-testing.html#cb241-8" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb241-9"><a href="watershed-segmentation-sensitivity-testing.html#cb241-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb241-10"><a href="watershed-segmentation-sensitivity-testing.html#cb241-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb241-11"><a href="watershed-segmentation-sensitivity-testing.html#cb241-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">4</span>)</span>
<span id="cb241-12"><a href="watershed-segmentation-sensitivity-testing.html#cb241-12" tabindex="-1"></a><span class="co"># ortho</span></span>
<span id="cb241-13"><a href="watershed-segmentation-sensitivity-testing.html#cb241-13" tabindex="-1"></a>ortho_plt_temp <span class="ot">&lt;-</span> <span class="fu">ortho_plt_fn</span>(</span>
<span id="cb241-14"><a href="watershed-segmentation-sensitivity-testing.html#cb241-14" tabindex="-1"></a>    <span class="at">stand =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(stand_boundary) <span class="sc">%&gt;%</span></span>
<span id="cb241-15"><a href="watershed-segmentation-sensitivity-testing.html#cb241-15" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span></span>
<span id="cb241-16"><a href="watershed-segmentation-sensitivity-testing.html#cb241-16" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb241-17"><a href="watershed-segmentation-sensitivity-testing.html#cb241-17" tabindex="-1"></a>    , <span class="at">buffer =</span> <span class="dv">10</span></span>
<span id="cb241-18"><a href="watershed-segmentation-sensitivity-testing.html#cb241-18" tabindex="-1"></a>  )</span>
<span id="cb241-19"><a href="watershed-segmentation-sensitivity-testing.html#cb241-19" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb241-20"><a href="watershed-segmentation-sensitivity-testing.html#cb241-20" tabindex="-1"></a>plt_list_temp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_temp) <span class="sc">%&gt;%</span></span>
<span id="cb241-21"><a href="watershed-segmentation-sensitivity-testing.html#cb241-21" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb241-22"><a href="watershed-segmentation-sensitivity-testing.html#cb241-22" tabindex="-1"></a>    ortho_plt_temp <span class="sc">+</span></span>
<span id="cb241-23"><a href="watershed-segmentation-sensitivity-testing.html#cb241-23" tabindex="-1"></a>    <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb241-24"><a href="watershed-segmentation-sensitivity-testing.html#cb241-24" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb241-25"><a href="watershed-segmentation-sensitivity-testing.html#cb241-25" tabindex="-1"></a>        <span class="at">data =</span> stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb241-26"><a href="watershed-segmentation-sensitivity-testing.html#cb241-26" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb241-27"><a href="watershed-segmentation-sensitivity-testing.html#cb241-27" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb241-28"><a href="watershed-segmentation-sensitivity-testing.html#cb241-28" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb241-29"><a href="watershed-segmentation-sensitivity-testing.html#cb241-29" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb241-30"><a href="watershed-segmentation-sensitivity-testing.html#cb241-30" tabindex="-1"></a>        <span class="at">data =</span> </span>
<span id="cb241-31"><a href="watershed-segmentation-sensitivity-testing.html#cb241-31" tabindex="-1"></a>          slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb241-32"><a href="watershed-segmentation-sensitivity-testing.html#cb241-32" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb241-33"><a href="watershed-segmentation-sensitivity-testing.html#cb241-33" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles)) <span class="sc">%&gt;%</span> </span>
<span id="cb241-34"><a href="watershed-segmentation-sensitivity-testing.html#cb241-34" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id=</span><span class="fu">as.numeric</span>(pile_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb241-35"><a href="watershed-segmentation-sensitivity-testing.html#cb241-35" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb241-36"><a href="watershed-segmentation-sensitivity-testing.html#cb241-36" tabindex="-1"></a>              param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb241-37"><a href="watershed-segmentation-sensitivity-testing.html#cb241-37" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> df_temp<span class="sc">$</span>rn[x]) <span class="sc">%&gt;%</span> </span>
<span id="cb241-38"><a href="watershed-segmentation-sensitivity-testing.html#cb241-38" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb241-39"><a href="watershed-segmentation-sensitivity-testing.html#cb241-39" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb241-40"><a href="watershed-segmentation-sensitivity-testing.html#cb241-40" tabindex="-1"></a>            )</span>
<span id="cb241-41"><a href="watershed-segmentation-sensitivity-testing.html#cb241-41" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb241-42"><a href="watershed-segmentation-sensitivity-testing.html#cb241-42" tabindex="-1"></a>        , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb241-43"><a href="watershed-segmentation-sensitivity-testing.html#cb241-43" tabindex="-1"></a>      ) <span class="sc">+</span> </span>
<span id="cb241-44"><a href="watershed-segmentation-sensitivity-testing.html#cb241-44" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb241-45"><a href="watershed-segmentation-sensitivity-testing.html#cb241-45" tabindex="-1"></a>        <span class="at">data =</span></span>
<span id="cb241-46"><a href="watershed-segmentation-sensitivity-testing.html#cb241-46" tabindex="-1"></a>          param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb241-47"><a href="watershed-segmentation-sensitivity-testing.html#cb241-47" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> df_temp<span class="sc">$</span>rn[x] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb241-48"><a href="watershed-segmentation-sensitivity-testing.html#cb241-48" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb241-49"><a href="watershed-segmentation-sensitivity-testing.html#cb241-49" tabindex="-1"></a>              param_combos_gt <span class="sc">%&gt;%</span></span>
<span id="cb241-50"><a href="watershed-segmentation-sensitivity-testing.html#cb241-50" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> df_temp<span class="sc">$</span>rn[x] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb241-51"><a href="watershed-segmentation-sensitivity-testing.html#cb241-51" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb241-52"><a href="watershed-segmentation-sensitivity-testing.html#cb241-52" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb241-53"><a href="watershed-segmentation-sensitivity-testing.html#cb241-53" tabindex="-1"></a>            )</span>
<span id="cb241-54"><a href="watershed-segmentation-sensitivity-testing.html#cb241-54" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb241-55"><a href="watershed-segmentation-sensitivity-testing.html#cb241-55" tabindex="-1"></a>        , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb241-56"><a href="watershed-segmentation-sensitivity-testing.html#cb241-56" tabindex="-1"></a>        , <span class="at">lwd =</span> <span class="fl">0.5</span></span>
<span id="cb241-57"><a href="watershed-segmentation-sensitivity-testing.html#cb241-57" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb241-58"><a href="watershed-segmentation-sensitivity-testing.html#cb241-58" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb241-59"><a href="watershed-segmentation-sensitivity-testing.html#cb241-59" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb241-60"><a href="watershed-segmentation-sensitivity-testing.html#cb241-60" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb241-61"><a href="watershed-segmentation-sensitivity-testing.html#cb241-61" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb241-62"><a href="watershed-segmentation-sensitivity-testing.html#cb241-62" tabindex="-1"></a>          <span class="st">&quot; F-score = &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(df_temp<span class="sc">$</span>f_score[x], <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb241-63"><a href="watershed-segmentation-sensitivity-testing.html#cb241-63" tabindex="-1"></a>          ,<span class="st">&quot; | Recall = &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(df_temp<span class="sc">$</span>recall[x], <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb241-64"><a href="watershed-segmentation-sensitivity-testing.html#cb241-64" tabindex="-1"></a>          ,<span class="st">&quot; | Precision = &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(df_temp<span class="sc">$</span>precision[x], <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb241-65"><a href="watershed-segmentation-sensitivity-testing.html#cb241-65" tabindex="-1"></a>        )</span>
<span id="cb241-66"><a href="watershed-segmentation-sensitivity-testing.html#cb241-66" tabindex="-1"></a>        , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb241-67"><a href="watershed-segmentation-sensitivity-testing.html#cb241-67" tabindex="-1"></a>          <span class="st">&quot; max_ht_m = &quot;</span>, (df_temp<span class="sc">$</span>max_ht_m[x])</span>
<span id="cb241-68"><a href="watershed-segmentation-sensitivity-testing.html#cb241-68" tabindex="-1"></a>          ,<span class="st">&quot; : max_area_m2 = &quot;</span>, (df_temp<span class="sc">$</span>max_area_m2[x])</span>
<span id="cb241-69"><a href="watershed-segmentation-sensitivity-testing.html#cb241-69" tabindex="-1"></a>          ,<span class="st">&quot; : convexity_pct = &quot;</span>, (df_temp<span class="sc">$</span>convexity_pct[x])</span>
<span id="cb241-70"><a href="watershed-segmentation-sensitivity-testing.html#cb241-70" tabindex="-1"></a>          ,<span class="st">&quot; : circle_fit_iou_pct = &quot;</span>, (df_temp<span class="sc">$</span>circle_fit_iou_pct[x])</span>
<span id="cb241-71"><a href="watershed-segmentation-sensitivity-testing.html#cb241-71" tabindex="-1"></a>          , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb241-72"><a href="watershed-segmentation-sensitivity-testing.html#cb241-72" tabindex="-1"></a>        )</span>
<span id="cb241-73"><a href="watershed-segmentation-sensitivity-testing.html#cb241-73" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb241-74"><a href="watershed-segmentation-sensitivity-testing.html#cb241-74" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb241-75"><a href="watershed-segmentation-sensitivity-testing.html#cb241-75" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb241-76"><a href="watershed-segmentation-sensitivity-testing.html#cb241-76" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb241-77"><a href="watershed-segmentation-sensitivity-testing.html#cb241-77" tabindex="-1"></a>        <span class="co"># , panel.background = ggplot2::element_rect(fill = &quot;gray66&quot;)</span></span>
<span id="cb241-78"><a href="watershed-segmentation-sensitivity-testing.html#cb241-78" tabindex="-1"></a>        , <span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb241-79"><a href="watershed-segmentation-sensitivity-testing.html#cb241-79" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb241-80"><a href="watershed-segmentation-sensitivity-testing.html#cb241-80" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb241-81"><a href="watershed-segmentation-sensitivity-testing.html#cb241-81" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb241-82"><a href="watershed-segmentation-sensitivity-testing.html#cb241-82" tabindex="-1"></a>        <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(pal_match_grp[<span class="st">&quot;commission&quot;</span>],<span class="cn">NA</span>,<span class="cn">NA</span>)))</span>
<span id="cb241-83"><a href="watershed-segmentation-sensitivity-testing.html#cb241-83" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb241-84"><a href="watershed-segmentation-sensitivity-testing.html#cb241-84" tabindex="-1"></a>      )</span>
<span id="cb241-85"><a href="watershed-segmentation-sensitivity-testing.html#cb241-85" tabindex="-1"></a>  )</span></code></pre></div>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="watershed-segmentation-sensitivity-testing.html#cb242-1" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb242-2"><a href="watershed-segmentation-sensitivity-testing.html#cb242-2" tabindex="-1"></a>    plt_list_temp</span>
<span id="cb242-3"><a href="watershed-segmentation-sensitivity-testing.html#cb242-3" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb242-4"><a href="watershed-segmentation-sensitivity-testing.html#cb242-4" tabindex="-1"></a>    , <span class="at">guides =</span> <span class="st">&quot;collect&quot;</span></span>
<span id="cb242-5"><a href="watershed-segmentation-sensitivity-testing.html#cb242-5" tabindex="-1"></a>  ) <span class="sc">&amp;</span></span>
<span id="cb242-6"><a href="watershed-segmentation-sensitivity-testing.html#cb242-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-201-1.png" width="816" /></p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="watershed-segmentation-sensitivity-testing.html#cb243-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_ever.jpeg&quot;</span>, <span class="at">height =</span> <span class="fl">9.5</span>, <span class="at">width =</span> <span class="fl">8.5</span>)</span></code></pre></div>
<p>it looks like even for these best performing pile detection parameter combinations, there were false positive (commission) detections in areas with trees. These incorrect detections appear to be mostly in aspen groves where the short, clumped low trees resemble slash piles structurally. The integration of the spectral data should help to filter out these false positive predictions</p>
<p>let’s look at only the top 5% of parameter combinations by F-score</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="watershed-segmentation-sensitivity-testing.html#cb244-1" tabindex="-1"></a><span class="co"># filter parameter combos for top x pct</span></span>
<span id="cb244-2"><a href="watershed-segmentation-sensitivity-testing.html#cb244-2" tabindex="-1"></a>top_x_pct_fscore <span class="ot">&lt;-</span> </span>
<span id="cb244-3"><a href="watershed-segmentation-sensitivity-testing.html#cb244-3" tabindex="-1"></a>  param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb244-4"><a href="watershed-segmentation-sensitivity-testing.html#cb244-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb244-5"><a href="watershed-segmentation-sensitivity-testing.html#cb244-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(f_score)) <span class="sc">%&gt;%</span> </span>
<span id="cb244-6"><a href="watershed-segmentation-sensitivity-testing.html#cb244-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb244-7"><a href="watershed-segmentation-sensitivity-testing.html#cb244-7" tabindex="-1"></a>      <span class="at">pct_rank_f_score =</span> dplyr<span class="sc">::</span><span class="fu">percent_rank</span>(f_score)</span>
<span id="cb244-8"><a href="watershed-segmentation-sensitivity-testing.html#cb244-8" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-9"><a href="watershed-segmentation-sensitivity-testing.html#cb244-9" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_rank_f_score<span class="sc">&gt;=</span>pct_rank_th_top)</span>
<span id="cb244-10"><a href="watershed-segmentation-sensitivity-testing.html#cb244-10" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb244-11"><a href="watershed-segmentation-sensitivity-testing.html#cb244-11" tabindex="-1"></a><span class="fu">plt_detection_dist</span>(</span>
<span id="cb244-12"><a href="watershed-segmentation-sensitivity-testing.html#cb244-12" tabindex="-1"></a>  <span class="at">df =</span> top_x_pct_fscore</span>
<span id="cb244-13"><a href="watershed-segmentation-sensitivity-testing.html#cb244-13" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb244-14"><a href="watershed-segmentation-sensitivity-testing.html#cb244-14" tabindex="-1"></a>     <span class="st">&quot;distribution of evaluation metrics for top &quot;</span></span>
<span id="cb244-15"><a href="watershed-segmentation-sensitivity-testing.html#cb244-15" tabindex="-1"></a>     , scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_top,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb244-16"><a href="watershed-segmentation-sensitivity-testing.html#cb244-16" tabindex="-1"></a>     , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb244-17"><a href="watershed-segmentation-sensitivity-testing.html#cb244-17" tabindex="-1"></a>     , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">nrow</span>(top_x_pct_fscore), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb244-18"><a href="watershed-segmentation-sensitivity-testing.html#cb244-18" tabindex="-1"></a>     , <span class="st">&quot;) &quot;</span></span>
<span id="cb244-19"><a href="watershed-segmentation-sensitivity-testing.html#cb244-19" tabindex="-1"></a>     , <span class="st">&quot;of parameter combinations by F-score using structural data only&quot;</span></span>
<span id="cb244-20"><a href="watershed-segmentation-sensitivity-testing.html#cb244-20" tabindex="-1"></a>  )</span>
<span id="cb244-21"><a href="watershed-segmentation-sensitivity-testing.html#cb244-21" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-203-1.png" width="1008" /></p>
<p>if we look at only the top 5% of parameter combinations by F-score, what is the distribution of individual parameter settings?</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="watershed-segmentation-sensitivity-testing.html#cb245-1" tabindex="-1"></a>pal_param <span class="ot">&lt;-</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">begin =</span> <span class="fl">0.1</span>, <span class="at">end =</span> <span class="fl">0.9</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>)</span>
<span id="cb245-2"><a href="watershed-segmentation-sensitivity-testing.html#cb245-2" tabindex="-1"></a>top_x_pct_fscore <span class="sc">%&gt;%</span></span>
<span id="cb245-3"><a href="watershed-segmentation-sensitivity-testing.html#cb245-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;f_score&quot;</span>), max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct) <span class="sc">%&gt;%</span> </span>
<span id="cb245-4"><a href="watershed-segmentation-sensitivity-testing.html#cb245-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb245-5"><a href="watershed-segmentation-sensitivity-testing.html#cb245-5" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct)</span>
<span id="cb245-6"><a href="watershed-segmentation-sensitivity-testing.html#cb245-6" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb245-7"><a href="watershed-segmentation-sensitivity-testing.html#cb245-7" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb245-8"><a href="watershed-segmentation-sensitivity-testing.html#cb245-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb245-9"><a href="watershed-segmentation-sensitivity-testing.html#cb245-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(metric, value) <span class="sc">%&gt;%</span> </span>
<span id="cb245-10"><a href="watershed-segmentation-sensitivity-testing.html#cb245-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(metric) <span class="sc">%&gt;%</span> </span>
<span id="cb245-11"><a href="watershed-segmentation-sensitivity-testing.html#cb245-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb245-12"><a href="watershed-segmentation-sensitivity-testing.html#cb245-12" tabindex="-1"></a>    <span class="at">pct=</span>n<span class="sc">/</span><span class="fu">sum</span>(n)</span>
<span id="cb245-13"><a href="watershed-segmentation-sensitivity-testing.html#cb245-13" tabindex="-1"></a>    , <span class="at">lab =</span> <span class="fu">paste0</span>(scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">n=&quot;</span>, scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>))</span>
<span id="cb245-14"><a href="watershed-segmentation-sensitivity-testing.html#cb245-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb245-15"><a href="watershed-segmentation-sensitivity-testing.html#cb245-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb245-16"><a href="watershed-segmentation-sensitivity-testing.html#cb245-16" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(value), <span class="at">y=</span>pct, <span class="at">label=</span>lab, <span class="at">fill =</span> metric)</span>
<span id="cb245-17"><a href="watershed-segmentation-sensitivity-testing.html#cb245-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb245-18"><a href="watershed-segmentation-sensitivity-testing.html#cb245-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb245-19"><a href="watershed-segmentation-sensitivity-testing.html#cb245-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb245-20"><a href="watershed-segmentation-sensitivity-testing.html#cb245-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb245-21"><a href="watershed-segmentation-sensitivity-testing.html#cb245-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb245-22"><a href="watershed-segmentation-sensitivity-testing.html#cb245-22" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.2</span>)</span>
<span id="cb245-23"><a href="watershed-segmentation-sensitivity-testing.html#cb245-23" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb245-24"><a href="watershed-segmentation-sensitivity-testing.html#cb245-24" tabindex="-1"></a>    , <span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb245-25"><a href="watershed-segmentation-sensitivity-testing.html#cb245-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb245-26"><a href="watershed-segmentation-sensitivity-testing.html#cb245-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_param[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">+</span></span>
<span id="cb245-27"><a href="watershed-segmentation-sensitivity-testing.html#cb245-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb245-28"><a href="watershed-segmentation-sensitivity-testing.html#cb245-28" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;parameter setting&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb245-29"><a href="watershed-segmentation-sensitivity-testing.html#cb245-29" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb245-30"><a href="watershed-segmentation-sensitivity-testing.html#cb245-30" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb245-31"><a href="watershed-segmentation-sensitivity-testing.html#cb245-31" tabindex="-1"></a>       <span class="st">&quot;parameter settings of top &quot;</span></span>
<span id="cb245-32"><a href="watershed-segmentation-sensitivity-testing.html#cb245-32" tabindex="-1"></a>       , scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_top,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb245-33"><a href="watershed-segmentation-sensitivity-testing.html#cb245-33" tabindex="-1"></a>       , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb245-34"><a href="watershed-segmentation-sensitivity-testing.html#cb245-34" tabindex="-1"></a>       , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">nrow</span>(top_x_pct_fscore), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb245-35"><a href="watershed-segmentation-sensitivity-testing.html#cb245-35" tabindex="-1"></a>       , <span class="st">&quot;) &quot;</span></span>
<span id="cb245-36"><a href="watershed-segmentation-sensitivity-testing.html#cb245-36" tabindex="-1"></a>       , <span class="st">&quot;of parameter combinations by F-score using structural data only&quot;</span></span>
<span id="cb245-37"><a href="watershed-segmentation-sensitivity-testing.html#cb245-37" tabindex="-1"></a>    )</span>
<span id="cb245-38"><a href="watershed-segmentation-sensitivity-testing.html#cb245-38" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb245-39"><a href="watershed-segmentation-sensitivity-testing.html#cb245-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb245-40"><a href="watershed-segmentation-sensitivity-testing.html#cb245-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb245-41"><a href="watershed-segmentation-sensitivity-testing.html#cb245-41" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb245-42"><a href="watershed-segmentation-sensitivity-testing.html#cb245-42" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb245-43"><a href="watershed-segmentation-sensitivity-testing.html#cb245-43" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb245-44"><a href="watershed-segmentation-sensitivity-testing.html#cb245-44" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb245-45"><a href="watershed-segmentation-sensitivity-testing.html#cb245-45" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb245-46"><a href="watershed-segmentation-sensitivity-testing.html#cb245-46" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-204-1.png" width="1008" /></p>
</div>
<div id="best-results-quantification-accuracy" class="section level3 hasAnchor" number="6.3.6">
<h3><span class="header-section-number">6.3.6</span> Best results: quantification accuracy<a href="watershed-segmentation-sensitivity-testing.html#best-results-quantification-accuracy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we can cut to the chase and just look at the parameter combinations that achieved the best results based on the form quantification accuracy metrics</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="watershed-segmentation-sensitivity-testing.html#cb246-1" tabindex="-1"></a>pct_rank_th_temp <span class="ot">&lt;-</span> <span class="fl">0.99</span></span>
<span id="cb246-2"><a href="watershed-segmentation-sensitivity-testing.html#cb246-2" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span></span>
<span id="cb246-3"><a href="watershed-segmentation-sensitivity-testing.html#cb246-3" tabindex="-1"></a>  param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb246-4"><a href="watershed-segmentation-sensitivity-testing.html#cb246-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(pct_diff_volume_field_mape, pct_diff_diameter_mape, pct_diff_area_field_mape, pct_diff_height_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb246-5"><a href="watershed-segmentation-sensitivity-testing.html#cb246-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb246-6"><a href="watershed-segmentation-sensitivity-testing.html#cb246-6" tabindex="-1"></a>    <span class="co"># label combining params</span></span>
<span id="cb246-7"><a href="watershed-segmentation-sensitivity-testing.html#cb246-7" tabindex="-1"></a>    <span class="at">lab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct, <span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)</span>
<span id="cb246-8"><a href="watershed-segmentation-sensitivity-testing.html#cb246-8" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb246-9"><a href="watershed-segmentation-sensitivity-testing.html#cb246-9" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb246-10"><a href="watershed-segmentation-sensitivity-testing.html#cb246-10" tabindex="-1"></a>      , <span class="at">.fn =</span> dplyr<span class="sc">::</span>percent_rank</span>
<span id="cb246-11"><a href="watershed-segmentation-sensitivity-testing.html#cb246-11" tabindex="-1"></a>      , <span class="at">.names =</span> <span class="st">&quot;pct_rank_{.col}&quot;</span></span>
<span id="cb246-12"><a href="watershed-segmentation-sensitivity-testing.html#cb246-12" tabindex="-1"></a>    )</span>
<span id="cb246-13"><a href="watershed-segmentation-sensitivity-testing.html#cb246-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb246-14"><a href="watershed-segmentation-sensitivity-testing.html#cb246-14" tabindex="-1"></a>  <span class="co"># dplyr::arrange(pct_diff_diameter_mape) %&gt;% </span></span>
<span id="cb246-15"><a href="watershed-segmentation-sensitivity-testing.html#cb246-15" tabindex="-1"></a>  <span class="co"># dplyr::select(pct_diff_diameter_mape, pct_rank_pct_diff_diameter_mape) %&gt;% </span></span>
<span id="cb246-16"><a href="watershed-segmentation-sensitivity-testing.html#cb246-16" tabindex="-1"></a>  <span class="co"># now get the max of these pct ranks by row</span></span>
<span id="cb246-17"><a href="watershed-segmentation-sensitivity-testing.html#cb246-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb246-18"><a href="watershed-segmentation-sensitivity-testing.html#cb246-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb246-19"><a href="watershed-segmentation-sensitivity-testing.html#cb246-19" tabindex="-1"></a>    <span class="at">pct_rank_min =</span> <span class="fu">min</span>(</span>
<span id="cb246-20"><a href="watershed-segmentation-sensitivity-testing.html#cb246-20" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">c_across</span>(</span>
<span id="cb246-21"><a href="watershed-segmentation-sensitivity-testing.html#cb246-21" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb246-22"><a href="watershed-segmentation-sensitivity-testing.html#cb246-22" tabindex="-1"></a>      )</span>
<span id="cb246-23"><a href="watershed-segmentation-sensitivity-testing.html#cb246-23" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb246-24"><a href="watershed-segmentation-sensitivity-testing.html#cb246-24" tabindex="-1"></a>    )</span>
<span id="cb246-25"><a href="watershed-segmentation-sensitivity-testing.html#cb246-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb246-26"><a href="watershed-segmentation-sensitivity-testing.html#cb246-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb246-27"><a href="watershed-segmentation-sensitivity-testing.html#cb246-27" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_rank_min<span class="sc">&lt;=</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp)) <span class="sc">%&gt;%</span> </span>
<span id="cb246-28"><a href="watershed-segmentation-sensitivity-testing.html#cb246-28" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb246-29"><a href="watershed-segmentation-sensitivity-testing.html#cb246-29" tabindex="-1"></a>    max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb246-30"><a href="watershed-segmentation-sensitivity-testing.html#cb246-30" tabindex="-1"></a>    , lab</span>
<span id="cb246-31"><a href="watershed-segmentation-sensitivity-testing.html#cb246-31" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb246-32"><a href="watershed-segmentation-sensitivity-testing.html#cb246-32" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_diff&quot;</span>)</span>
<span id="cb246-33"><a href="watershed-segmentation-sensitivity-testing.html#cb246-33" tabindex="-1"></a>    , <span class="sc">-</span><span class="fu">c</span>(pct_rank_min)</span>
<span id="cb246-34"><a href="watershed-segmentation-sensitivity-testing.html#cb246-34" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb246-35"><a href="watershed-segmentation-sensitivity-testing.html#cb246-35" tabindex="-1"></a>  <span class="co"># get sort for lab</span></span>
<span id="cb246-36"><a href="watershed-segmentation-sensitivity-testing.html#cb246-36" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(lab) <span class="sc">%&gt;%</span> </span>
<span id="cb246-37"><a href="watershed-segmentation-sensitivity-testing.html#cb246-37" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sort_lab =</span> pct_rank_pct_diff_volume_field_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb246-38"><a href="watershed-segmentation-sensitivity-testing.html#cb246-38" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb246-39"><a href="watershed-segmentation-sensitivity-testing.html#cb246-39" tabindex="-1"></a>  <span class="co"># expand data to unique lab, pct_rank</span></span>
<span id="cb246-40"><a href="watershed-segmentation-sensitivity-testing.html#cb246-40" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb246-41"><a href="watershed-segmentation-sensitivity-testing.html#cb246-41" tabindex="-1"></a>    <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb246-42"><a href="watershed-segmentation-sensitivity-testing.html#cb246-42" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb246-43"><a href="watershed-segmentation-sensitivity-testing.html#cb246-43" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb246-44"><a href="watershed-segmentation-sensitivity-testing.html#cb246-44" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb246-45"><a href="watershed-segmentation-sensitivity-testing.html#cb246-45" tabindex="-1"></a>  <span class="co"># keep only relevant records </span></span>
<span id="cb246-46"><a href="watershed-segmentation-sensitivity-testing.html#cb246-46" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(value<span class="sc">&lt;=</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp)) <span class="sc">%&gt;%</span> </span>
<span id="cb246-47"><a href="watershed-segmentation-sensitivity-testing.html#cb246-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(metric) <span class="sc">%&gt;%</span> </span>
<span id="cb246-48"><a href="watershed-segmentation-sensitivity-testing.html#cb246-48" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(pct_diff_volume_field_mape, pct_diff_diameter_mape, pct_diff_area_field_mape, pct_diff_height_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb246-49"><a href="watershed-segmentation-sensitivity-testing.html#cb246-49" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span><span class="dv">11</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb246-50"><a href="watershed-segmentation-sensitivity-testing.html#cb246-50" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb246-51"><a href="watershed-segmentation-sensitivity-testing.html#cb246-51" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb246-52"><a href="watershed-segmentation-sensitivity-testing.html#cb246-52" tabindex="-1"></a>    <span class="at">rank_lab =</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(metric,<span class="st">&quot;pct_rank_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb246-53"><a href="watershed-segmentation-sensitivity-testing.html#cb246-53" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb246-54"><a href="watershed-segmentation-sensitivity-testing.html#cb246-54" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb246-55"><a href="watershed-segmentation-sensitivity-testing.html#cb246-55" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb246-56"><a href="watershed-segmentation-sensitivity-testing.html#cb246-56" tabindex="-1"></a>          <span class="st">&quot;pct_diff_volume_field_mape&quot;</span></span>
<span id="cb246-57"><a href="watershed-segmentation-sensitivity-testing.html#cb246-57" tabindex="-1"></a>          , <span class="st">&quot;pct_diff_paraboloid_volume_field_mape&quot;</span></span>
<span id="cb246-58"><a href="watershed-segmentation-sensitivity-testing.html#cb246-58" tabindex="-1"></a>          , <span class="st">&quot;pct_diff_area_field_mape&quot;</span></span>
<span id="cb246-59"><a href="watershed-segmentation-sensitivity-testing.html#cb246-59" tabindex="-1"></a>          , <span class="st">&quot;pct_diff_height_mape&quot;</span></span>
<span id="cb246-60"><a href="watershed-segmentation-sensitivity-testing.html#cb246-60" tabindex="-1"></a>          , <span class="st">&quot;pct_diff_diameter_mape&quot;</span></span>
<span id="cb246-61"><a href="watershed-segmentation-sensitivity-testing.html#cb246-61" tabindex="-1"></a>        )</span>
<span id="cb246-62"><a href="watershed-segmentation-sensitivity-testing.html#cb246-62" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb246-63"><a href="watershed-segmentation-sensitivity-testing.html#cb246-63" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Volume irregular&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb246-64"><a href="watershed-segmentation-sensitivity-testing.html#cb246-64" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Volume paraboloid&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb246-65"><a href="watershed-segmentation-sensitivity-testing.html#cb246-65" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Area&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb246-66"><a href="watershed-segmentation-sensitivity-testing.html#cb246-66" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Height&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb246-67"><a href="watershed-segmentation-sensitivity-testing.html#cb246-67" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Diameter&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_wrap</span>(<span class="at">width =</span> <span class="dv">14</span>)</span>
<span id="cb246-68"><a href="watershed-segmentation-sensitivity-testing.html#cb246-68" tabindex="-1"></a>        )</span>
<span id="cb246-69"><a href="watershed-segmentation-sensitivity-testing.html#cb246-69" tabindex="-1"></a>      )</span>
<span id="cb246-70"><a href="watershed-segmentation-sensitivity-testing.html#cb246-70" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb246-71"><a href="watershed-segmentation-sensitivity-testing.html#cb246-71" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(metric,value))</span>
<span id="cb246-72"><a href="watershed-segmentation-sensitivity-testing.html#cb246-72" tabindex="-1"></a></span>
<span id="cb246-73"><a href="watershed-segmentation-sensitivity-testing.html#cb246-73" tabindex="-1"></a>  <span class="co"># dplyr::group_by(lab) %&gt;% </span></span>
<span id="cb246-74"><a href="watershed-segmentation-sensitivity-testing.html#cb246-74" tabindex="-1"></a>  <span class="co"># dplyr::mutate(xxx = dplyr::n()) %&gt;% </span></span>
<span id="cb246-75"><a href="watershed-segmentation-sensitivity-testing.html#cb246-75" tabindex="-1"></a>  <span class="co"># dplyr::ungroup() %&gt;% </span></span>
<span id="cb246-76"><a href="watershed-segmentation-sensitivity-testing.html#cb246-76" tabindex="-1"></a>  <span class="co"># dplyr::arrange(desc(xxx), lab) %&gt;% </span></span>
<span id="cb246-77"><a href="watershed-segmentation-sensitivity-testing.html#cb246-77" tabindex="-1"></a>  <span class="co"># View()</span></span>
<span id="cb246-78"><a href="watershed-segmentation-sensitivity-testing.html#cb246-78" tabindex="-1"></a><span class="co"># df_temp %&gt;% dplyr::glimpse()</span></span>
<span id="cb246-79"><a href="watershed-segmentation-sensitivity-testing.html#cb246-79" tabindex="-1"></a></span>
<span id="cb246-80"><a href="watershed-segmentation-sensitivity-testing.html#cb246-80" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb246-81"><a href="watershed-segmentation-sensitivity-testing.html#cb246-81" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb246-82"><a href="watershed-segmentation-sensitivity-testing.html#cb246-82" tabindex="-1"></a>    <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_diff_&quot;</span>)</span>
<span id="cb246-83"><a href="watershed-segmentation-sensitivity-testing.html#cb246-83" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb246-84"><a href="watershed-segmentation-sensitivity-testing.html#cb246-84" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb246-85"><a href="watershed-segmentation-sensitivity-testing.html#cb246-85" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb246-86"><a href="watershed-segmentation-sensitivity-testing.html#cb246-86" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb246-87"><a href="watershed-segmentation-sensitivity-testing.html#cb246-87" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb246-88"><a href="watershed-segmentation-sensitivity-testing.html#cb246-88" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;pct_diff_volume_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb246-89"><a href="watershed-segmentation-sensitivity-testing.html#cb246-89" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_paraboloid_volume_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb246-90"><a href="watershed-segmentation-sensitivity-testing.html#cb246-90" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_area_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb246-91"><a href="watershed-segmentation-sensitivity-testing.html#cb246-91" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_height_mape&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb246-92"><a href="watershed-segmentation-sensitivity-testing.html#cb246-92" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_diameter_mape&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb246-93"><a href="watershed-segmentation-sensitivity-testing.html#cb246-93" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb246-94"><a href="watershed-segmentation-sensitivity-testing.html#cb246-94" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb246-95"><a href="watershed-segmentation-sensitivity-testing.html#cb246-95" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb246-96"><a href="watershed-segmentation-sensitivity-testing.html#cb246-96" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb246-97"><a href="watershed-segmentation-sensitivity-testing.html#cb246-97" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb246-98"><a href="watershed-segmentation-sensitivity-testing.html#cb246-98" tabindex="-1"></a>          <span class="st">&quot;MAPE Volume irregular&quot;</span></span>
<span id="cb246-99"><a href="watershed-segmentation-sensitivity-testing.html#cb246-99" tabindex="-1"></a>          , <span class="st">&quot;MAPE Volume paraboloid&quot;</span></span>
<span id="cb246-100"><a href="watershed-segmentation-sensitivity-testing.html#cb246-100" tabindex="-1"></a>          , <span class="st">&quot;MAPE Area&quot;</span></span>
<span id="cb246-101"><a href="watershed-segmentation-sensitivity-testing.html#cb246-101" tabindex="-1"></a>          , <span class="st">&quot;MAPE Height&quot;</span></span>
<span id="cb246-102"><a href="watershed-segmentation-sensitivity-testing.html#cb246-102" tabindex="-1"></a>          , <span class="st">&quot;MAPE Diameter&quot;</span></span>
<span id="cb246-103"><a href="watershed-segmentation-sensitivity-testing.html#cb246-103" tabindex="-1"></a>        )</span>
<span id="cb246-104"><a href="watershed-segmentation-sensitivity-testing.html#cb246-104" tabindex="-1"></a>      )</span>
<span id="cb246-105"><a href="watershed-segmentation-sensitivity-testing.html#cb246-105" tabindex="-1"></a>    , <span class="at">lab =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(lab, sort_lab) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb246-106"><a href="watershed-segmentation-sensitivity-testing.html#cb246-106" tabindex="-1"></a>    , <span class="at">val_lab =</span> scales<span class="sc">::</span><span class="fu">percent</span>(value, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb246-107"><a href="watershed-segmentation-sensitivity-testing.html#cb246-107" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb246-108"><a href="watershed-segmentation-sensitivity-testing.html#cb246-108" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb246-109"><a href="watershed-segmentation-sensitivity-testing.html#cb246-109" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> lab, <span class="at">fill =</span> metric, <span class="at">label =</span> val_lab)</span>
<span id="cb246-110"><a href="watershed-segmentation-sensitivity-testing.html#cb246-110" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb246-111"><a href="watershed-segmentation-sensitivity-testing.html#cb246-111" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb246-112"><a href="watershed-segmentation-sensitivity-testing.html#cb246-112" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb246-113"><a href="watershed-segmentation-sensitivity-testing.html#cb246-113" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb246-114"><a href="watershed-segmentation-sensitivity-testing.html#cb246-114" tabindex="-1"></a>  <span class="co"># ggplot2::scale_fill_manual(values = pal_get_pairs_fn(6)[1:5][c(1,3,5)]) +</span></span>
<span id="cb246-115"><a href="watershed-segmentation-sensitivity-testing.html#cb246-115" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb246-116"><a href="watershed-segmentation-sensitivity-testing.html#cb246-116" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb246-117"><a href="watershed-segmentation-sensitivity-testing.html#cb246-117" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.05</span>)</span>
<span id="cb246-118"><a href="watershed-segmentation-sensitivity-testing.html#cb246-118" tabindex="-1"></a>    <span class="co"># , expand = expansion(mult = c(0, .08))</span></span>
<span id="cb246-119"><a href="watershed-segmentation-sensitivity-testing.html#cb246-119" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb246-120"><a href="watershed-segmentation-sensitivity-testing.html#cb246-120" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(rank_lab), <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb246-121"><a href="watershed-segmentation-sensitivity-testing.html#cb246-121" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb246-122"><a href="watershed-segmentation-sensitivity-testing.html#cb246-122" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;max_ht_m : max_area_m2 : convexity_pct : circle_fit_iou_pct&quot;</span></span>
<span id="cb246-123"><a href="watershed-segmentation-sensitivity-testing.html#cb246-123" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb246-124"><a href="watershed-segmentation-sensitivity-testing.html#cb246-124" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb246-125"><a href="watershed-segmentation-sensitivity-testing.html#cb246-125" tabindex="-1"></a>       <span class="st">&quot;pile shape quantification accuracy for top &quot;</span></span>
<span id="cb246-126"><a href="watershed-segmentation-sensitivity-testing.html#cb246-126" tabindex="-1"></a>       , scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb246-127"><a href="watershed-segmentation-sensitivity-testing.html#cb246-127" tabindex="-1"></a>       , <span class="st">&quot; of parameter combinations&quot;</span></span>
<span id="cb246-128"><a href="watershed-segmentation-sensitivity-testing.html#cb246-128" tabindex="-1"></a>    )</span>
<span id="cb246-129"><a href="watershed-segmentation-sensitivity-testing.html#cb246-129" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb246-130"><a href="watershed-segmentation-sensitivity-testing.html#cb246-130" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb246-131"><a href="watershed-segmentation-sensitivity-testing.html#cb246-131" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb246-132"><a href="watershed-segmentation-sensitivity-testing.html#cb246-132" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb246-133"><a href="watershed-segmentation-sensitivity-testing.html#cb246-133" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb246-134"><a href="watershed-segmentation-sensitivity-testing.html#cb246-134" tabindex="-1"></a>    , <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb246-135"><a href="watershed-segmentation-sensitivity-testing.html#cb246-135" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-205-1.png" width="1008" /></p>
<p>let’s make a table of these results</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="watershed-segmentation-sensitivity-testing.html#cb247-1" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb247-2"><a href="watershed-segmentation-sensitivity-testing.html#cb247-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb247-3"><a href="watershed-segmentation-sensitivity-testing.html#cb247-3" tabindex="-1"></a>    rank_lab</span>
<span id="cb247-4"><a href="watershed-segmentation-sensitivity-testing.html#cb247-4" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb247-5"><a href="watershed-segmentation-sensitivity-testing.html#cb247-5" tabindex="-1"></a>    , pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape, pct_diff_diameter_mape</span>
<span id="cb247-6"><a href="watershed-segmentation-sensitivity-testing.html#cb247-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb247-7"><a href="watershed-segmentation-sensitivity-testing.html#cb247-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb247-8"><a href="watershed-segmentation-sensitivity-testing.html#cb247-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(rank_lab,pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape, pct_diff_diameter_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb247-9"><a href="watershed-segmentation-sensitivity-testing.html#cb247-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb247-10"><a href="watershed-segmentation-sensitivity-testing.html#cb247-10" tabindex="-1"></a>    <span class="at">.cols =</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_diff_&quot;</span>)</span>
<span id="cb247-11"><a href="watershed-segmentation-sensitivity-testing.html#cb247-11" tabindex="-1"></a>    , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb247-12"><a href="watershed-segmentation-sensitivity-testing.html#cb247-12" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb247-13"><a href="watershed-segmentation-sensitivity-testing.html#cb247-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">blank=</span> <span class="st">&quot;   &quot;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb247-14"><a href="watershed-segmentation-sensitivity-testing.html#cb247-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(blank, <span class="at">.before =</span> pct_diff_volume_field_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb247-15"><a href="watershed-segmentation-sensitivity-testing.html#cb247-15" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb247-16"><a href="watershed-segmentation-sensitivity-testing.html#cb247-16" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;parameter combinations that achieved the best slash pile form quantification results&quot;</span></span>
<span id="cb247-17"><a href="watershed-segmentation-sensitivity-testing.html#cb247-17" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb247-18"><a href="watershed-segmentation-sensitivity-testing.html#cb247-18" tabindex="-1"></a>      <span class="st">&quot;.&quot;</span></span>
<span id="cb247-19"><a href="watershed-segmentation-sensitivity-testing.html#cb247-19" tabindex="-1"></a>      ,<span class="st">&quot;max_ht_m&quot;</span>,<span class="st">&quot;max_area_m2&quot;</span>,<span class="st">&quot;convexity_pct&quot;</span>,<span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb247-20"><a href="watershed-segmentation-sensitivity-testing.html#cb247-20" tabindex="-1"></a>      , <span class="st">&quot;   &quot;</span></span>
<span id="cb247-21"><a href="watershed-segmentation-sensitivity-testing.html#cb247-21" tabindex="-1"></a>      , <span class="st">&quot;MAPE Volume irregular&quot;</span></span>
<span id="cb247-22"><a href="watershed-segmentation-sensitivity-testing.html#cb247-22" tabindex="-1"></a>      , <span class="st">&quot;MAPE Area&quot;</span></span>
<span id="cb247-23"><a href="watershed-segmentation-sensitivity-testing.html#cb247-23" tabindex="-1"></a>      , <span class="st">&quot;MAPE Height&quot;</span></span>
<span id="cb247-24"><a href="watershed-segmentation-sensitivity-testing.html#cb247-24" tabindex="-1"></a>      , <span class="st">&quot;MAPE Diameter&quot;</span></span>
<span id="cb247-25"><a href="watershed-segmentation-sensitivity-testing.html#cb247-25" tabindex="-1"></a>    )</span>
<span id="cb247-26"><a href="watershed-segmentation-sensitivity-testing.html#cb247-26" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb247-27"><a href="watershed-segmentation-sensitivity-testing.html#cb247-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb247-28"><a href="watershed-segmentation-sensitivity-testing.html#cb247-28" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">11</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb247-29"><a href="watershed-segmentation-sensitivity-testing.html#cb247-29" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb247-30"><a href="watershed-segmentation-sensitivity-testing.html#cb247-30" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">6</span>, <span class="st">&quot;Evaluation Metric&quot;</span> <span class="ot">=</span> <span class="dv">4</span>))</span></code></pre></div>
<table class="table" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-206">Table 6.2: </span>parameter combinations that achieved the best slash pile form quantification results
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="6">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="4">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Evaluation Metric
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
.
</th>
<th style="text-align:right;">
max_ht_m
</th>
<th style="text-align:right;">
max_area_m2
</th>
<th style="text-align:right;">
convexity_pct
</th>
<th style="text-align:right;">
circle_fit_iou_pct
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
MAPE Volume irregular
</th>
<th style="text-align:left;">
MAPE Area
</th>
<th style="text-align:left;">
MAPE Height
</th>
<th style="text-align:left;">
MAPE Diameter
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="11">
top 1%
MAPE Volume
irregular
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
23%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
23%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
23%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
23%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
23%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="11">
top 1% MAPE
Area
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="11">
top 1% MAPE
Height
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
24%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
24%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
24%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
24%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
24%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
24%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
29%
</td>
<td style="text-align:left;">
26%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
26%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
29%
</td>
<td style="text-align:left;">
26%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
26%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
29%
</td>
<td style="text-align:left;">
26%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
26%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
29%
</td>
<td style="text-align:left;">
26%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
26%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
29%
</td>
<td style="text-align:left;">
26%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
26%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="11">
top 1% MAPE
Diameter
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
13%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
</tbody>
</table>
<p>if we look at only the top 5% of parameter combinations by F-score, which quantifies the method’s ability to accurately detect slash piles, what is the distribution of the pile form quantification accuracy metrics?</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="watershed-segmentation-sensitivity-testing.html#cb248-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb248-2"><a href="watershed-segmentation-sensitivity-testing.html#cb248-2" tabindex="-1"></a><span class="fu">plt_form_quantification_dist</span>(</span>
<span id="cb248-3"><a href="watershed-segmentation-sensitivity-testing.html#cb248-3" tabindex="-1"></a>  <span class="at">df =</span> top_x_pct_fscore</span>
<span id="cb248-4"><a href="watershed-segmentation-sensitivity-testing.html#cb248-4" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb248-5"><a href="watershed-segmentation-sensitivity-testing.html#cb248-5" tabindex="-1"></a>     <span class="st">&quot;distribution of pile form quantification metrics for the top &quot;</span></span>
<span id="cb248-6"><a href="watershed-segmentation-sensitivity-testing.html#cb248-6" tabindex="-1"></a>     , scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_top,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb248-7"><a href="watershed-segmentation-sensitivity-testing.html#cb248-7" tabindex="-1"></a>     , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb248-8"><a href="watershed-segmentation-sensitivity-testing.html#cb248-8" tabindex="-1"></a>     , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">nrow</span>(top_x_pct_fscore), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb248-9"><a href="watershed-segmentation-sensitivity-testing.html#cb248-9" tabindex="-1"></a>     , <span class="st">&quot;) &quot;</span></span>
<span id="cb248-10"><a href="watershed-segmentation-sensitivity-testing.html#cb248-10" tabindex="-1"></a>     , <span class="st">&quot;of parameter combinations by F-score using structural data only&quot;</span></span>
<span id="cb248-11"><a href="watershed-segmentation-sensitivity-testing.html#cb248-11" tabindex="-1"></a>  )</span>
<span id="cb248-12"><a href="watershed-segmentation-sensitivity-testing.html#cb248-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-208-1.png" width="1008" /></p>
<p>these don’t look much better than the overall form quantification accuracy metrics based on all parameter combinations tested</p>
</div>
<div id="wshed_best_best" class="section level3 hasAnchor" number="6.3.7">
<h3><span class="header-section-number">6.3.7</span> Best results: detection &amp; quantification<a href="watershed-segmentation-sensitivity-testing.html#wshed_best_best" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>as we saw immediately above, the form quantification accuracy metrics for the top 5% of parameter combinations by F-score don’t appear to be much better than the quantification accuracy metrics using all parameter combinations tested. let’s check to see if there is a relationship between the quantification and detection accuracy metrics using data from all parameter combinations tested</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="watershed-segmentation-sensitivity-testing.html#cb249-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb249-2"><a href="watershed-segmentation-sensitivity-testing.html#cb249-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb249-3"><a href="watershed-segmentation-sensitivity-testing.html#cb249-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb249-4"><a href="watershed-segmentation-sensitivity-testing.html#cb249-4" tabindex="-1"></a>    rn,max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb249-5"><a href="watershed-segmentation-sensitivity-testing.html#cb249-5" tabindex="-1"></a>    , f_score</span>
<span id="cb249-6"><a href="watershed-segmentation-sensitivity-testing.html#cb249-6" tabindex="-1"></a>    <span class="co"># quantification accuracy</span></span>
<span id="cb249-7"><a href="watershed-segmentation-sensitivity-testing.html#cb249-7" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb249-8"><a href="watershed-segmentation-sensitivity-testing.html#cb249-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb249-9"><a href="watershed-segmentation-sensitivity-testing.html#cb249-9" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb249-10"><a href="watershed-segmentation-sensitivity-testing.html#cb249-10" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb249-11"><a href="watershed-segmentation-sensitivity-testing.html#cb249-11" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb249-12"><a href="watershed-segmentation-sensitivity-testing.html#cb249-12" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb249-13"><a href="watershed-segmentation-sensitivity-testing.html#cb249-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb249-14"><a href="watershed-segmentation-sensitivity-testing.html#cb249-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb249-15"><a href="watershed-segmentation-sensitivity-testing.html#cb249-15" tabindex="-1"></a>    <span class="at">eval_metric =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(metric, <span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb249-16"><a href="watershed-segmentation-sensitivity-testing.html#cb249-16" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb249-17"><a href="watershed-segmentation-sensitivity-testing.html#cb249-17" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;me&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb249-18"><a href="watershed-segmentation-sensitivity-testing.html#cb249-18" tabindex="-1"></a>      <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb249-19"><a href="watershed-segmentation-sensitivity-testing.html#cb249-19" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb249-20"><a href="watershed-segmentation-sensitivity-testing.html#cb249-20" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb249-21"><a href="watershed-segmentation-sensitivity-testing.html#cb249-21" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb249-22"><a href="watershed-segmentation-sensitivity-testing.html#cb249-22" tabindex="-1"></a>      )</span>
<span id="cb249-23"><a href="watershed-segmentation-sensitivity-testing.html#cb249-23" tabindex="-1"></a>    , <span class="at">pile_metric =</span> metric <span class="sc">%&gt;%</span> </span>
<span id="cb249-24"><a href="watershed-segmentation-sensitivity-testing.html#cb249-24" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb249-25"><a href="watershed-segmentation-sensitivity-testing.html#cb249-25" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">&quot;(paraboloid_volume|volume|area|height|diameter)&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb249-26"><a href="watershed-segmentation-sensitivity-testing.html#cb249-26" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb249-27"><a href="watershed-segmentation-sensitivity-testing.html#cb249-27" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb249-28"><a href="watershed-segmentation-sensitivity-testing.html#cb249-28" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb249-29"><a href="watershed-segmentation-sensitivity-testing.html#cb249-29" tabindex="-1"></a>          <span class="st">&quot;volume&quot;</span></span>
<span id="cb249-30"><a href="watershed-segmentation-sensitivity-testing.html#cb249-30" tabindex="-1"></a>          , <span class="st">&quot;paraboloid_volume&quot;</span></span>
<span id="cb249-31"><a href="watershed-segmentation-sensitivity-testing.html#cb249-31" tabindex="-1"></a>          , <span class="st">&quot;area&quot;</span></span>
<span id="cb249-32"><a href="watershed-segmentation-sensitivity-testing.html#cb249-32" tabindex="-1"></a>          , <span class="st">&quot;height&quot;</span></span>
<span id="cb249-33"><a href="watershed-segmentation-sensitivity-testing.html#cb249-33" tabindex="-1"></a>          , <span class="st">&quot;diameter&quot;</span></span>
<span id="cb249-34"><a href="watershed-segmentation-sensitivity-testing.html#cb249-34" tabindex="-1"></a>        )</span>
<span id="cb249-35"><a href="watershed-segmentation-sensitivity-testing.html#cb249-35" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb249-36"><a href="watershed-segmentation-sensitivity-testing.html#cb249-36" tabindex="-1"></a>          <span class="st">&quot;Volume&quot;</span></span>
<span id="cb249-37"><a href="watershed-segmentation-sensitivity-testing.html#cb249-37" tabindex="-1"></a>          , <span class="st">&quot;Volume paraboloid&quot;</span></span>
<span id="cb249-38"><a href="watershed-segmentation-sensitivity-testing.html#cb249-38" tabindex="-1"></a>          , <span class="st">&quot;Area&quot;</span></span>
<span id="cb249-39"><a href="watershed-segmentation-sensitivity-testing.html#cb249-39" tabindex="-1"></a>          , <span class="st">&quot;Height&quot;</span></span>
<span id="cb249-40"><a href="watershed-segmentation-sensitivity-testing.html#cb249-40" tabindex="-1"></a>          , <span class="st">&quot;Diameter&quot;</span></span>
<span id="cb249-41"><a href="watershed-segmentation-sensitivity-testing.html#cb249-41" tabindex="-1"></a>        )</span>
<span id="cb249-42"><a href="watershed-segmentation-sensitivity-testing.html#cb249-42" tabindex="-1"></a>      )</span>
<span id="cb249-43"><a href="watershed-segmentation-sensitivity-testing.html#cb249-43" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb249-44"><a href="watershed-segmentation-sensitivity-testing.html#cb249-44" tabindex="-1"></a>  <span class="co"># plot</span></span>
<span id="cb249-45"><a href="watershed-segmentation-sensitivity-testing.html#cb249-45" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> f_score, <span class="at">y =</span> value, <span class="at">color =</span> pile_metric)) <span class="sc">+</span></span>
<span id="cb249-46"><a href="watershed-segmentation-sensitivity-testing.html#cb249-46" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb249-47"><a href="watershed-segmentation-sensitivity-testing.html#cb249-47" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(pile_metric)) <span class="sc">+</span></span>
<span id="cb249-48"><a href="watershed-segmentation-sensitivity-testing.html#cb249-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb249-49"><a href="watershed-segmentation-sensitivity-testing.html#cb249-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb249-50"><a href="watershed-segmentation-sensitivity-testing.html#cb249-50" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb249-51"><a href="watershed-segmentation-sensitivity-testing.html#cb249-51" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb249-52"><a href="watershed-segmentation-sensitivity-testing.html#cb249-52" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb249-53"><a href="watershed-segmentation-sensitivity-testing.html#cb249-53" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb249-54"><a href="watershed-segmentation-sensitivity-testing.html#cb249-54" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb249-55"><a href="watershed-segmentation-sensitivity-testing.html#cb249-55" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)</span>
<span id="cb249-56"><a href="watershed-segmentation-sensitivity-testing.html#cb249-56" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb249-57"><a href="watershed-segmentation-sensitivity-testing.html#cb249-57" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;F-Score&quot;</span>, <span class="at">y =</span> <span class="st">&quot;MAPE&quot;</span>) <span class="sc">+</span></span>
<span id="cb249-58"><a href="watershed-segmentation-sensitivity-testing.html#cb249-58" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb249-59"><a href="watershed-segmentation-sensitivity-testing.html#cb249-59" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb249-60"><a href="watershed-segmentation-sensitivity-testing.html#cb249-60" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb249-61"><a href="watershed-segmentation-sensitivity-testing.html#cb249-61" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb249-62"><a href="watershed-segmentation-sensitivity-testing.html#cb249-62" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-210-1.png" width="1008" /></p>
<p>aside from a distinct cluster of points at the lower end of the F-Score range, there does not appear to be a relationship between the pile form quantification and detection accuracy metrics</p>
<p>let’s look at only parameter combinations that are among the best in both detection and form quantification accuracy</p>
<p>we’ll use the F-Score and the average rank of the MAPE metrics across all form measurements to determine the best overall list</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="watershed-segmentation-sensitivity-testing.html#cb250-1" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span></span>
<span id="cb250-2"><a href="watershed-segmentation-sensitivity-testing.html#cb250-2" tabindex="-1"></a>  param_combos_gt_agg <span class="sc">%&gt;%</span></span>
<span id="cb250-3"><a href="watershed-segmentation-sensitivity-testing.html#cb250-3" tabindex="-1"></a>  <span class="co"># dplyr::select(c(tidyselect::ends_with(&quot;_mape&quot;) &amp; tidyselect::contains(&quot;volume&quot;))) %&gt;% names()</span></span>
<span id="cb250-4"><a href="watershed-segmentation-sensitivity-testing.html#cb250-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb250-5"><a href="watershed-segmentation-sensitivity-testing.html#cb250-5" tabindex="-1"></a>    <span class="co"># label combining params</span></span>
<span id="cb250-6"><a href="watershed-segmentation-sensitivity-testing.html#cb250-6" tabindex="-1"></a>    <span class="at">lab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct, <span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)</span>
<span id="cb250-7"><a href="watershed-segmentation-sensitivity-testing.html#cb250-7" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb250-8"><a href="watershed-segmentation-sensitivity-testing.html#cb250-8" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb250-9"><a href="watershed-segmentation-sensitivity-testing.html#cb250-9" tabindex="-1"></a>      <span class="co"># .cols = c(tidyselect::ends_with(&quot;_mape&quot;) &amp; tidyselect::contains(&quot;volume&quot;))</span></span>
<span id="cb250-10"><a href="watershed-segmentation-sensitivity-testing.html#cb250-10" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span>dplyr<span class="sc">::</span><span class="fu">percent_rank</span>(<span class="sc">-</span>.x)</span>
<span id="cb250-11"><a href="watershed-segmentation-sensitivity-testing.html#cb250-11" tabindex="-1"></a>      , <span class="at">.names =</span> <span class="st">&quot;pct_rank_quant_{.col}&quot;</span></span>
<span id="cb250-12"><a href="watershed-segmentation-sensitivity-testing.html#cb250-12" tabindex="-1"></a>    )</span>
<span id="cb250-13"><a href="watershed-segmentation-sensitivity-testing.html#cb250-13" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb250-14"><a href="watershed-segmentation-sensitivity-testing.html#cb250-14" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(f_score)</span>
<span id="cb250-15"><a href="watershed-segmentation-sensitivity-testing.html#cb250-15" tabindex="-1"></a>      <span class="co"># .cols = c(f_score,recall)</span></span>
<span id="cb250-16"><a href="watershed-segmentation-sensitivity-testing.html#cb250-16" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span>dplyr<span class="sc">::</span><span class="fu">percent_rank</span>(.x)</span>
<span id="cb250-17"><a href="watershed-segmentation-sensitivity-testing.html#cb250-17" tabindex="-1"></a>      , <span class="at">.names =</span> <span class="st">&quot;pct_rank_det_{.col}&quot;</span></span>
<span id="cb250-18"><a href="watershed-segmentation-sensitivity-testing.html#cb250-18" tabindex="-1"></a>    )</span>
<span id="cb250-19"><a href="watershed-segmentation-sensitivity-testing.html#cb250-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb250-20"><a href="watershed-segmentation-sensitivity-testing.html#cb250-20" tabindex="-1"></a>  <span class="co"># dplyr::arrange(pct_diff_diameter_mape) %&gt;%</span></span>
<span id="cb250-21"><a href="watershed-segmentation-sensitivity-testing.html#cb250-21" tabindex="-1"></a>  <span class="co"># dplyr::select(pct_diff_diameter_mape, pct_rank_pct_diff_diameter_mape) %&gt;%</span></span>
<span id="cb250-22"><a href="watershed-segmentation-sensitivity-testing.html#cb250-22" tabindex="-1"></a>  <span class="co"># View()</span></span>
<span id="cb250-23"><a href="watershed-segmentation-sensitivity-testing.html#cb250-23" tabindex="-1"></a>  <span class="co"># now get the max of these pct ranks by row</span></span>
<span id="cb250-24"><a href="watershed-segmentation-sensitivity-testing.html#cb250-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb250-25"><a href="watershed-segmentation-sensitivity-testing.html#cb250-25" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb250-26"><a href="watershed-segmentation-sensitivity-testing.html#cb250-26" tabindex="-1"></a>    <span class="at">pct_rank_quant_mean =</span> <span class="fu">mean</span>(</span>
<span id="cb250-27"><a href="watershed-segmentation-sensitivity-testing.html#cb250-27" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">c_across</span>(</span>
<span id="cb250-28"><a href="watershed-segmentation-sensitivity-testing.html#cb250-28" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank_quant_&quot;</span>)</span>
<span id="cb250-29"><a href="watershed-segmentation-sensitivity-testing.html#cb250-29" tabindex="-1"></a>      )</span>
<span id="cb250-30"><a href="watershed-segmentation-sensitivity-testing.html#cb250-30" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb250-31"><a href="watershed-segmentation-sensitivity-testing.html#cb250-31" tabindex="-1"></a>    )</span>
<span id="cb250-32"><a href="watershed-segmentation-sensitivity-testing.html#cb250-32" tabindex="-1"></a>    , <span class="at">pct_rank_det_mean =</span> <span class="fu">mean</span>(</span>
<span id="cb250-33"><a href="watershed-segmentation-sensitivity-testing.html#cb250-33" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">c_across</span>(</span>
<span id="cb250-34"><a href="watershed-segmentation-sensitivity-testing.html#cb250-34" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank_det_&quot;</span>)</span>
<span id="cb250-35"><a href="watershed-segmentation-sensitivity-testing.html#cb250-35" tabindex="-1"></a>      )</span>
<span id="cb250-36"><a href="watershed-segmentation-sensitivity-testing.html#cb250-36" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb250-37"><a href="watershed-segmentation-sensitivity-testing.html#cb250-37" tabindex="-1"></a>    )</span>
<span id="cb250-38"><a href="watershed-segmentation-sensitivity-testing.html#cb250-38" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb250-39"><a href="watershed-segmentation-sensitivity-testing.html#cb250-39" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb250-40"><a href="watershed-segmentation-sensitivity-testing.html#cb250-40" tabindex="-1"></a>  <span class="co"># now make quadrant var</span></span>
<span id="cb250-41"><a href="watershed-segmentation-sensitivity-testing.html#cb250-41" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb250-42"><a href="watershed-segmentation-sensitivity-testing.html#cb250-42" tabindex="-1"></a>    <span class="co"># this is for the quadrant plot</span></span>
<span id="cb250-43"><a href="watershed-segmentation-sensitivity-testing.html#cb250-43" tabindex="-1"></a>    <span class="at">overall_accuracy =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb250-44"><a href="watershed-segmentation-sensitivity-testing.html#cb250-44" tabindex="-1"></a>      pct_rank_det_mean<span class="sc">&gt;=</span><span class="fl">0.95</span> <span class="sc">&amp;</span> pct_rank_quant_mean<span class="sc">&gt;=</span><span class="fl">0.95</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb250-45"><a href="watershed-segmentation-sensitivity-testing.html#cb250-45" tabindex="-1"></a>      , pct_rank_det_mean<span class="sc">&gt;=</span><span class="fl">0.90</span> <span class="sc">&amp;</span> pct_rank_quant_mean<span class="sc">&gt;=</span><span class="fl">0.90</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb250-46"><a href="watershed-segmentation-sensitivity-testing.html#cb250-46" tabindex="-1"></a>      , pct_rank_det_mean<span class="sc">&gt;=</span><span class="fl">0.75</span> <span class="sc">&amp;</span> pct_rank_quant_mean<span class="sc">&gt;=</span><span class="fl">0.75</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb250-47"><a href="watershed-segmentation-sensitivity-testing.html#cb250-47" tabindex="-1"></a>      , pct_rank_det_mean<span class="sc">&gt;=</span><span class="fl">0.50</span> <span class="sc">&amp;</span> pct_rank_quant_mean<span class="sc">&gt;=</span><span class="fl">0.50</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb250-48"><a href="watershed-segmentation-sensitivity-testing.html#cb250-48" tabindex="-1"></a>      , pct_rank_det_mean<span class="sc">&gt;=</span><span class="fl">0.50</span> <span class="sc">&amp;</span> pct_rank_quant_mean<span class="sc">&lt;</span><span class="fl">0.50</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb250-49"><a href="watershed-segmentation-sensitivity-testing.html#cb250-49" tabindex="-1"></a>      , pct_rank_det_mean<span class="sc">&lt;</span><span class="fl">0.50</span> <span class="sc">&amp;</span> pct_rank_quant_mean<span class="sc">&gt;=</span><span class="fl">0.50</span> <span class="sc">~</span> <span class="dv">6</span></span>
<span id="cb250-50"><a href="watershed-segmentation-sensitivity-testing.html#cb250-50" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="dv">7</span></span>
<span id="cb250-51"><a href="watershed-segmentation-sensitivity-testing.html#cb250-51" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb250-52"><a href="watershed-segmentation-sensitivity-testing.html#cb250-52" tabindex="-1"></a>    <span class="fu">factor</span>(</span>
<span id="cb250-53"><a href="watershed-segmentation-sensitivity-testing.html#cb250-53" tabindex="-1"></a>      <span class="at">ordered =</span> T</span>
<span id="cb250-54"><a href="watershed-segmentation-sensitivity-testing.html#cb250-54" tabindex="-1"></a>      , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span></span>
<span id="cb250-55"><a href="watershed-segmentation-sensitivity-testing.html#cb250-55" tabindex="-1"></a>      , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb250-56"><a href="watershed-segmentation-sensitivity-testing.html#cb250-56" tabindex="-1"></a>        <span class="st">&quot;top 5% detection &amp; quantification&quot;</span> <span class="co"># pct_rank_mean&gt;=0.95 &amp; pct_rank_f_score&gt;=0.95 ~ 1</span></span>
<span id="cb250-57"><a href="watershed-segmentation-sensitivity-testing.html#cb250-57" tabindex="-1"></a>        , <span class="st">&quot;top 10% detection &amp; quantification&quot;</span> <span class="co"># pct_rank_mean&gt;=0.90 &amp; pct_rank_f_score&gt;=0.90 ~ 2</span></span>
<span id="cb250-58"><a href="watershed-segmentation-sensitivity-testing.html#cb250-58" tabindex="-1"></a>        , <span class="st">&quot;top 25% detection &amp; quantification&quot;</span> <span class="co"># pct_rank_mean&gt;=0.75 &amp; pct_rank_f_score&gt;=0.75 ~ 3</span></span>
<span id="cb250-59"><a href="watershed-segmentation-sensitivity-testing.html#cb250-59" tabindex="-1"></a>        , <span class="st">&quot;top 50% detection &amp; quantification&quot;</span> <span class="co"># pct_rank_mean&gt;=0.50 &amp; pct_rank_f_score&gt;=0.50 ~ 4</span></span>
<span id="cb250-60"><a href="watershed-segmentation-sensitivity-testing.html#cb250-60" tabindex="-1"></a>        , <span class="st">&quot;top 50% quantification&quot;</span> <span class="co"># pct_rank_mean&gt;=0.50 &amp; pct_rank_f_score&lt;0.50 ~ 5</span></span>
<span id="cb250-61"><a href="watershed-segmentation-sensitivity-testing.html#cb250-61" tabindex="-1"></a>        , <span class="st">&quot;top 50% detection&quot;</span> <span class="co"># pct_rank_mean&lt;0.50 &amp; pct_rank_f_score&gt;=0.50 ~ 6</span></span>
<span id="cb250-62"><a href="watershed-segmentation-sensitivity-testing.html#cb250-62" tabindex="-1"></a>        , <span class="st">&quot;bottom 50% detection &amp; quantification&quot;</span></span>
<span id="cb250-63"><a href="watershed-segmentation-sensitivity-testing.html#cb250-63" tabindex="-1"></a>      )</span>
<span id="cb250-64"><a href="watershed-segmentation-sensitivity-testing.html#cb250-64" tabindex="-1"></a>    )</span>
<span id="cb250-65"><a href="watershed-segmentation-sensitivity-testing.html#cb250-65" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb250-66"><a href="watershed-segmentation-sensitivity-testing.html#cb250-66" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb250-67"><a href="watershed-segmentation-sensitivity-testing.html#cb250-67" tabindex="-1"></a>    rn,max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb250-68"><a href="watershed-segmentation-sensitivity-testing.html#cb250-68" tabindex="-1"></a>    , lab</span>
<span id="cb250-69"><a href="watershed-segmentation-sensitivity-testing.html#cb250-69" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb250-70"><a href="watershed-segmentation-sensitivity-testing.html#cb250-70" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb250-71"><a href="watershed-segmentation-sensitivity-testing.html#cb250-71" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb250-72"><a href="watershed-segmentation-sensitivity-testing.html#cb250-72" tabindex="-1"></a>    , overall_accuracy</span>
<span id="cb250-73"><a href="watershed-segmentation-sensitivity-testing.html#cb250-73" tabindex="-1"></a>  )</span>
<span id="cb250-74"><a href="watershed-segmentation-sensitivity-testing.html#cb250-74" tabindex="-1"></a></span>
<span id="cb250-75"><a href="watershed-segmentation-sensitivity-testing.html#cb250-75" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb250-76"><a href="watershed-segmentation-sensitivity-testing.html#cb250-76" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span>   </span>
<span id="cb250-77"><a href="watershed-segmentation-sensitivity-testing.html#cb250-77" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb250-78"><a href="watershed-segmentation-sensitivity-testing.html#cb250-78" tabindex="-1"></a>    <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> pct_rank_det_mean, <span class="at">y =</span> pct_rank_quant_mean, <span class="at">color =</span> overall_accuracy)</span>
<span id="cb250-79"><a href="watershed-segmentation-sensitivity-testing.html#cb250-79" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb250-80"><a href="watershed-segmentation-sensitivity-testing.html#cb250-80" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">&quot;gray22&quot;</span>) <span class="sc">+</span></span>
<span id="cb250-81"><a href="watershed-segmentation-sensitivity-testing.html#cb250-81" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">&quot;gray22&quot;</span>) <span class="sc">+</span></span>
<span id="cb250-82"><a href="watershed-segmentation-sensitivity-testing.html#cb250-82" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.75</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>) <span class="sc">+</span></span>
<span id="cb250-83"><a href="watershed-segmentation-sensitivity-testing.html#cb250-83" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.75</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>) <span class="sc">+</span></span>
<span id="cb250-84"><a href="watershed-segmentation-sensitivity-testing.html#cb250-84" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.9</span>, <span class="at">color =</span> <span class="st">&quot;gray66&quot;</span>) <span class="sc">+</span></span>
<span id="cb250-85"><a href="watershed-segmentation-sensitivity-testing.html#cb250-85" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.9</span>, <span class="at">color =</span> <span class="st">&quot;gray66&quot;</span>) <span class="sc">+</span></span>
<span id="cb250-86"><a href="watershed-segmentation-sensitivity-testing.html#cb250-86" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb250-87"><a href="watershed-segmentation-sensitivity-testing.html#cb250-87" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_colour_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;inferno&quot;</span>, <span class="at">end =</span> <span class="fl">0.8</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb250-88"><a href="watershed-segmentation-sensitivity-testing.html#cb250-88" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb250-89"><a href="watershed-segmentation-sensitivity-testing.html#cb250-89" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb250-90"><a href="watershed-segmentation-sensitivity-testing.html#cb250-90" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb250-91"><a href="watershed-segmentation-sensitivity-testing.html#cb250-91" tabindex="-1"></a>  ) <span class="sc">+</span>  </span>
<span id="cb250-92"><a href="watershed-segmentation-sensitivity-testing.html#cb250-92" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb250-93"><a href="watershed-segmentation-sensitivity-testing.html#cb250-93" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb250-94"><a href="watershed-segmentation-sensitivity-testing.html#cb250-94" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb250-95"><a href="watershed-segmentation-sensitivity-testing.html#cb250-95" tabindex="-1"></a>  ) <span class="sc">+</span>  </span>
<span id="cb250-96"><a href="watershed-segmentation-sensitivity-testing.html#cb250-96" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb250-97"><a href="watershed-segmentation-sensitivity-testing.html#cb250-97" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Percentile F-Score&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Percentile MAPE (mean)&quot;</span></span>
<span id="cb250-98"><a href="watershed-segmentation-sensitivity-testing.html#cb250-98" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb250-99"><a href="watershed-segmentation-sensitivity-testing.html#cb250-99" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb250-100"><a href="watershed-segmentation-sensitivity-testing.html#cb250-100" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb250-101"><a href="watershed-segmentation-sensitivity-testing.html#cb250-101" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb250-102"><a href="watershed-segmentation-sensitivity-testing.html#cb250-102" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span></span>
<span id="cb250-103"><a href="watershed-segmentation-sensitivity-testing.html#cb250-103" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb250-104"><a href="watershed-segmentation-sensitivity-testing.html#cb250-104" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb250-105"><a href="watershed-segmentation-sensitivity-testing.html#cb250-105" tabindex="-1"></a>    , <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb250-106"><a href="watershed-segmentation-sensitivity-testing.html#cb250-106" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb250-107"><a href="watershed-segmentation-sensitivity-testing.html#cb250-107" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb250-108"><a href="watershed-segmentation-sensitivity-testing.html#cb250-108" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">linetype =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="dv">1</span>))</span>
<span id="cb250-109"><a href="watershed-segmentation-sensitivity-testing.html#cb250-109" tabindex="-1"></a>    , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb250-110"><a href="watershed-segmentation-sensitivity-testing.html#cb250-110" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-211-1.png" width="1008" /></p>
<p>let’s look at the parameter combinations that are in the upper-right of the quadrant plot. That is, the parameter combinations that performed best at both pile detection accuracy and pile form quantification accuracy</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="watershed-segmentation-sensitivity-testing.html#cb251-1" tabindex="-1"></a><span class="co"># filter</span></span>
<span id="cb251-2"><a href="watershed-segmentation-sensitivity-testing.html#cb251-2" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb251-3"><a href="watershed-segmentation-sensitivity-testing.html#cb251-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb251-4"><a href="watershed-segmentation-sensitivity-testing.html#cb251-4" tabindex="-1"></a>    pct_rank_det_mean<span class="sc">&gt;=</span><span class="fl">0.75</span> <span class="sc">&amp;</span> pct_rank_quant_mean<span class="sc">&gt;=</span><span class="fl">0.75</span></span>
<span id="cb251-5"><a href="watershed-segmentation-sensitivity-testing.html#cb251-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb251-6"><a href="watershed-segmentation-sensitivity-testing.html#cb251-6" tabindex="-1"></a>  <span class="co"># nrow()</span></span>
<span id="cb251-7"><a href="watershed-segmentation-sensitivity-testing.html#cb251-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb251-8"><a href="watershed-segmentation-sensitivity-testing.html#cb251-8" tabindex="-1"></a>    <span class="at">pct_rank_overall =</span> (pct_rank_det_mean<span class="sc">+</span>pct_rank_quant_mean)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb251-9"><a href="watershed-segmentation-sensitivity-testing.html#cb251-9" tabindex="-1"></a>    , <span class="at">lab =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(lab, pct_rank_overall)</span>
<span id="cb251-10"><a href="watershed-segmentation-sensitivity-testing.html#cb251-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb251-11"><a href="watershed-segmentation-sensitivity-testing.html#cb251-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(pct_rank_overall)) <span class="sc">%&gt;%</span> </span>
<span id="cb251-12"><a href="watershed-segmentation-sensitivity-testing.html#cb251-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rank_overall =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb251-13"><a href="watershed-segmentation-sensitivity-testing.html#cb251-13" tabindex="-1"></a><span class="co"># save the best overall param_combo_df record numbers</span></span>
<span id="cb251-14"><a href="watershed-segmentation-sensitivity-testing.html#cb251-14" tabindex="-1"></a>best_pile_detect_rn <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb251-15"><a href="watershed-segmentation-sensitivity-testing.html#cb251-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,lab,rank_overall,pct_rank_overall,pct_rank_det_mean,pct_rank_quant_mean)</span>
<span id="cb251-16"><a href="watershed-segmentation-sensitivity-testing.html#cb251-16" tabindex="-1"></a><span class="co"># best_pile_detect_rn %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="watershed-segmentation-sensitivity-testing.html#cb252-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb252-2"><a href="watershed-segmentation-sensitivity-testing.html#cb252-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb252-3"><a href="watershed-segmentation-sensitivity-testing.html#cb252-3" tabindex="-1"></a>  <span class="co"># filter for the best </span></span>
<span id="cb252-4"><a href="watershed-segmentation-sensitivity-testing.html#cb252-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb252-5"><a href="watershed-segmentation-sensitivity-testing.html#cb252-5" tabindex="-1"></a>    best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_best=</span>T)</span>
<span id="cb252-6"><a href="watershed-segmentation-sensitivity-testing.html#cb252-6" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb252-7"><a href="watershed-segmentation-sensitivity-testing.html#cb252-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb252-8"><a href="watershed-segmentation-sensitivity-testing.html#cb252-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_best =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_best,F)) <span class="sc">%&gt;%</span> </span>
<span id="cb252-9"><a href="watershed-segmentation-sensitivity-testing.html#cb252-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb252-10"><a href="watershed-segmentation-sensitivity-testing.html#cb252-10" tabindex="-1"></a>    rn,max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb252-11"><a href="watershed-segmentation-sensitivity-testing.html#cb252-11" tabindex="-1"></a>    , is_best</span>
<span id="cb252-12"><a href="watershed-segmentation-sensitivity-testing.html#cb252-12" tabindex="-1"></a>    , f_score</span>
<span id="cb252-13"><a href="watershed-segmentation-sensitivity-testing.html#cb252-13" tabindex="-1"></a>    <span class="co"># quantification accuracy</span></span>
<span id="cb252-14"><a href="watershed-segmentation-sensitivity-testing.html#cb252-14" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb252-15"><a href="watershed-segmentation-sensitivity-testing.html#cb252-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb252-16"><a href="watershed-segmentation-sensitivity-testing.html#cb252-16" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb252-17"><a href="watershed-segmentation-sensitivity-testing.html#cb252-17" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb252-18"><a href="watershed-segmentation-sensitivity-testing.html#cb252-18" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb252-19"><a href="watershed-segmentation-sensitivity-testing.html#cb252-19" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb252-20"><a href="watershed-segmentation-sensitivity-testing.html#cb252-20" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb252-21"><a href="watershed-segmentation-sensitivity-testing.html#cb252-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb252-22"><a href="watershed-segmentation-sensitivity-testing.html#cb252-22" tabindex="-1"></a>    <span class="at">eval_metric =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(metric, <span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb252-23"><a href="watershed-segmentation-sensitivity-testing.html#cb252-23" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb252-24"><a href="watershed-segmentation-sensitivity-testing.html#cb252-24" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;me&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb252-25"><a href="watershed-segmentation-sensitivity-testing.html#cb252-25" tabindex="-1"></a>      <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb252-26"><a href="watershed-segmentation-sensitivity-testing.html#cb252-26" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb252-27"><a href="watershed-segmentation-sensitivity-testing.html#cb252-27" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb252-28"><a href="watershed-segmentation-sensitivity-testing.html#cb252-28" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb252-29"><a href="watershed-segmentation-sensitivity-testing.html#cb252-29" tabindex="-1"></a>      )</span>
<span id="cb252-30"><a href="watershed-segmentation-sensitivity-testing.html#cb252-30" tabindex="-1"></a>    , <span class="at">pile_metric =</span> metric <span class="sc">%&gt;%</span> </span>
<span id="cb252-31"><a href="watershed-segmentation-sensitivity-testing.html#cb252-31" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb252-32"><a href="watershed-segmentation-sensitivity-testing.html#cb252-32" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">&quot;(paraboloid_volume|volume|area|height|diameter)&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb252-33"><a href="watershed-segmentation-sensitivity-testing.html#cb252-33" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb252-34"><a href="watershed-segmentation-sensitivity-testing.html#cb252-34" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb252-35"><a href="watershed-segmentation-sensitivity-testing.html#cb252-35" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb252-36"><a href="watershed-segmentation-sensitivity-testing.html#cb252-36" tabindex="-1"></a>          <span class="st">&quot;volume&quot;</span></span>
<span id="cb252-37"><a href="watershed-segmentation-sensitivity-testing.html#cb252-37" tabindex="-1"></a>          , <span class="st">&quot;paraboloid_volume&quot;</span></span>
<span id="cb252-38"><a href="watershed-segmentation-sensitivity-testing.html#cb252-38" tabindex="-1"></a>          , <span class="st">&quot;area&quot;</span></span>
<span id="cb252-39"><a href="watershed-segmentation-sensitivity-testing.html#cb252-39" tabindex="-1"></a>          , <span class="st">&quot;height&quot;</span></span>
<span id="cb252-40"><a href="watershed-segmentation-sensitivity-testing.html#cb252-40" tabindex="-1"></a>          , <span class="st">&quot;diameter&quot;</span></span>
<span id="cb252-41"><a href="watershed-segmentation-sensitivity-testing.html#cb252-41" tabindex="-1"></a>        )</span>
<span id="cb252-42"><a href="watershed-segmentation-sensitivity-testing.html#cb252-42" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb252-43"><a href="watershed-segmentation-sensitivity-testing.html#cb252-43" tabindex="-1"></a>          <span class="st">&quot;Volume&quot;</span></span>
<span id="cb252-44"><a href="watershed-segmentation-sensitivity-testing.html#cb252-44" tabindex="-1"></a>          , <span class="st">&quot;Volume paraboloid&quot;</span></span>
<span id="cb252-45"><a href="watershed-segmentation-sensitivity-testing.html#cb252-45" tabindex="-1"></a>          , <span class="st">&quot;Area&quot;</span></span>
<span id="cb252-46"><a href="watershed-segmentation-sensitivity-testing.html#cb252-46" tabindex="-1"></a>          , <span class="st">&quot;Height&quot;</span></span>
<span id="cb252-47"><a href="watershed-segmentation-sensitivity-testing.html#cb252-47" tabindex="-1"></a>          , <span class="st">&quot;Diameter&quot;</span></span>
<span id="cb252-48"><a href="watershed-segmentation-sensitivity-testing.html#cb252-48" tabindex="-1"></a>        )</span>
<span id="cb252-49"><a href="watershed-segmentation-sensitivity-testing.html#cb252-49" tabindex="-1"></a>      )</span>
<span id="cb252-50"><a href="watershed-segmentation-sensitivity-testing.html#cb252-50" tabindex="-1"></a>    , <span class="at">color_metric =</span> <span class="fu">ifelse</span>(is_best, pile_metric, <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">factor</span>()</span>
<span id="cb252-51"><a href="watershed-segmentation-sensitivity-testing.html#cb252-51" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb252-52"><a href="watershed-segmentation-sensitivity-testing.html#cb252-52" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(is_best) <span class="sc">%&gt;%</span> </span>
<span id="cb252-53"><a href="watershed-segmentation-sensitivity-testing.html#cb252-53" tabindex="-1"></a>  <span class="co"># plot</span></span>
<span id="cb252-54"><a href="watershed-segmentation-sensitivity-testing.html#cb252-54" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> f_score, <span class="at">y =</span> value, <span class="at">color =</span> color_metric)) <span class="sc">+</span></span>
<span id="cb252-55"><a href="watershed-segmentation-sensitivity-testing.html#cb252-55" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb252-56"><a href="watershed-segmentation-sensitivity-testing.html#cb252-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(pile_metric)) <span class="sc">+</span></span>
<span id="cb252-57"><a href="watershed-segmentation-sensitivity-testing.html#cb252-57" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;gray88&quot;</span>) <span class="sc">+</span></span>
<span id="cb252-58"><a href="watershed-segmentation-sensitivity-testing.html#cb252-58" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb252-59"><a href="watershed-segmentation-sensitivity-testing.html#cb252-59" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb252-60"><a href="watershed-segmentation-sensitivity-testing.html#cb252-60" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb252-61"><a href="watershed-segmentation-sensitivity-testing.html#cb252-61" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb252-62"><a href="watershed-segmentation-sensitivity-testing.html#cb252-62" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb252-63"><a href="watershed-segmentation-sensitivity-testing.html#cb252-63" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb252-64"><a href="watershed-segmentation-sensitivity-testing.html#cb252-64" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)</span>
<span id="cb252-65"><a href="watershed-segmentation-sensitivity-testing.html#cb252-65" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb252-66"><a href="watershed-segmentation-sensitivity-testing.html#cb252-66" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;F-Score&quot;</span>, <span class="at">y =</span> <span class="st">&quot;MAPE&quot;</span>, <span class="at">caption =</span> <span class="st">&quot;*records in gray not selected&quot;</span>) <span class="sc">+</span></span>
<span id="cb252-67"><a href="watershed-segmentation-sensitivity-testing.html#cb252-67" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb252-68"><a href="watershed-segmentation-sensitivity-testing.html#cb252-68" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb252-69"><a href="watershed-segmentation-sensitivity-testing.html#cb252-69" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb252-70"><a href="watershed-segmentation-sensitivity-testing.html#cb252-70" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb252-71"><a href="watershed-segmentation-sensitivity-testing.html#cb252-71" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-213-1.png" width="1008" /></p>
<p>if we look at these top parameter combinations only, what can we expect regarding detection accuracy</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="watershed-segmentation-sensitivity-testing.html#cb253-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb253-2"><a href="watershed-segmentation-sensitivity-testing.html#cb253-2" tabindex="-1"></a><span class="fu">plt_detection_dist</span>(</span>
<span id="cb253-3"><a href="watershed-segmentation-sensitivity-testing.html#cb253-3" tabindex="-1"></a>  <span class="at">df =</span> param_combos_gt_agg <span class="sc">%&gt;%</span></span>
<span id="cb253-4"><a href="watershed-segmentation-sensitivity-testing.html#cb253-4" tabindex="-1"></a>    <span class="co"># filter for best of best</span></span>
<span id="cb253-5"><a href="watershed-segmentation-sensitivity-testing.html#cb253-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb253-6"><a href="watershed-segmentation-sensitivity-testing.html#cb253-6" tabindex="-1"></a>      best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn)</span>
<span id="cb253-7"><a href="watershed-segmentation-sensitivity-testing.html#cb253-7" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb253-8"><a href="watershed-segmentation-sensitivity-testing.html#cb253-8" tabindex="-1"></a>    )</span>
<span id="cb253-9"><a href="watershed-segmentation-sensitivity-testing.html#cb253-9" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb253-10"><a href="watershed-segmentation-sensitivity-testing.html#cb253-10" tabindex="-1"></a>   <span class="st">&quot;distribution of pile detection accuracy metrics for the top&quot;</span></span>
<span id="cb253-11"><a href="watershed-segmentation-sensitivity-testing.html#cb253-11" tabindex="-1"></a>   , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb253-12"><a href="watershed-segmentation-sensitivity-testing.html#cb253-12" tabindex="-1"></a>   , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">nrow</span>(best_pile_detect_rn), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb253-13"><a href="watershed-segmentation-sensitivity-testing.html#cb253-13" tabindex="-1"></a>   , <span class="st">&quot;) &quot;</span></span>
<span id="cb253-14"><a href="watershed-segmentation-sensitivity-testing.html#cb253-14" tabindex="-1"></a>   , <span class="st">&quot;parameter combinations</span><span class="sc">\n</span><span class="st">based on both detection and quantification accuracy&quot;</span></span>
<span id="cb253-15"><a href="watershed-segmentation-sensitivity-testing.html#cb253-15" tabindex="-1"></a>  )</span>
<span id="cb253-16"><a href="watershed-segmentation-sensitivity-testing.html#cb253-16" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-214-1.png" width="1008" /></p>
<p>this is interesting, among the top performers in both detection (F-score) and quantification (overall MAPE), a few combinations had noticeably higher recall rates. assuming quantification accuracy is similar across this elite group, we should prioritize those with the highest recall.</p>
<p>but first, if we look at all these top combinations, what can we expect regarding their quantification accuracy?</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="watershed-segmentation-sensitivity-testing.html#cb254-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb254-2"><a href="watershed-segmentation-sensitivity-testing.html#cb254-2" tabindex="-1"></a><span class="fu">plt_form_quantification_dist</span>(</span>
<span id="cb254-3"><a href="watershed-segmentation-sensitivity-testing.html#cb254-3" tabindex="-1"></a>  <span class="at">df =</span> param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb254-4"><a href="watershed-segmentation-sensitivity-testing.html#cb254-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-5"><a href="watershed-segmentation-sensitivity-testing.html#cb254-5" tabindex="-1"></a>    <span class="co"># filter for best of best</span></span>
<span id="cb254-6"><a href="watershed-segmentation-sensitivity-testing.html#cb254-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb254-7"><a href="watershed-segmentation-sensitivity-testing.html#cb254-7" tabindex="-1"></a>      best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn)</span>
<span id="cb254-8"><a href="watershed-segmentation-sensitivity-testing.html#cb254-8" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb254-9"><a href="watershed-segmentation-sensitivity-testing.html#cb254-9" tabindex="-1"></a>    )</span>
<span id="cb254-10"><a href="watershed-segmentation-sensitivity-testing.html#cb254-10" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb254-11"><a href="watershed-segmentation-sensitivity-testing.html#cb254-11" tabindex="-1"></a>     <span class="st">&quot;distribution of pile form quantification accuracy metrics for the top&quot;</span></span>
<span id="cb254-12"><a href="watershed-segmentation-sensitivity-testing.html#cb254-12" tabindex="-1"></a>     <span class="co"># , scales::percent(1-pct_rank_th_top,accuracy=1)</span></span>
<span id="cb254-13"><a href="watershed-segmentation-sensitivity-testing.html#cb254-13" tabindex="-1"></a>     , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb254-14"><a href="watershed-segmentation-sensitivity-testing.html#cb254-14" tabindex="-1"></a>     , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">nrow</span>(best_pile_detect_rn), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb254-15"><a href="watershed-segmentation-sensitivity-testing.html#cb254-15" tabindex="-1"></a>     , <span class="st">&quot;) &quot;</span></span>
<span id="cb254-16"><a href="watershed-segmentation-sensitivity-testing.html#cb254-16" tabindex="-1"></a>     , <span class="st">&quot;parameter combinations</span><span class="sc">\n</span><span class="st">based on both detection and quantification accuracy&quot;</span></span>
<span id="cb254-17"><a href="watershed-segmentation-sensitivity-testing.html#cb254-17" tabindex="-1"></a>  )</span>
<span id="cb254-18"><a href="watershed-segmentation-sensitivity-testing.html#cb254-18" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-215-1.png" width="1008" /></p>
<p>the distributions of these form quantification accuracy metrics span a narrow range (x-axis), especially with respect to MAPE. as such, we’ll focus on the best overall parameter combinations that also achieved the highest recall rates</p>
</div>
</div>
<div id="final-recommended-settings" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Final recommended settings<a href="watershed-segmentation-sensitivity-testing.html#final-recommended-settings" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>our final step in this sensitivity testing is to identify the best-performing parameter combinations that not only balance detection and quantification accuracy but also achieve the highest recall rates. we’ll select these by choosing any combination whose recall rate is at least one standard deviation above the average for this top group. if no combinations meet this criterion, we will instead select the top 10 combinations based on their recall rates.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="watershed-segmentation-sensitivity-testing.html#cb255-1" tabindex="-1"></a><span class="co"># put a flag in our best_pile_detect_rn data</span></span>
<span id="cb255-2"><a href="watershed-segmentation-sensitivity-testing.html#cb255-2" tabindex="-1"></a>best_pile_detect_rn <span class="ot">&lt;-</span></span>
<span id="cb255-3"><a href="watershed-segmentation-sensitivity-testing.html#cb255-3" tabindex="-1"></a>  best_pile_detect_rn <span class="sc">%&gt;%</span> </span>
<span id="cb255-4"><a href="watershed-segmentation-sensitivity-testing.html#cb255-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb255-5"><a href="watershed-segmentation-sensitivity-testing.html#cb255-5" tabindex="-1"></a>    param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb255-6"><a href="watershed-segmentation-sensitivity-testing.html#cb255-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb255-7"><a href="watershed-segmentation-sensitivity-testing.html#cb255-7" tabindex="-1"></a>      <span class="co"># filter for best of best</span></span>
<span id="cb255-8"><a href="watershed-segmentation-sensitivity-testing.html#cb255-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb255-9"><a href="watershed-segmentation-sensitivity-testing.html#cb255-9" tabindex="-1"></a>        best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn)</span>
<span id="cb255-10"><a href="watershed-segmentation-sensitivity-testing.html#cb255-10" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb255-11"><a href="watershed-segmentation-sensitivity-testing.html#cb255-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb255-12"><a href="watershed-segmentation-sensitivity-testing.html#cb255-12" tabindex="-1"></a>      <span class="co"># check recall rate</span></span>
<span id="cb255-13"><a href="watershed-segmentation-sensitivity-testing.html#cb255-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(recall)) <span class="sc">%&gt;%</span> </span>
<span id="cb255-14"><a href="watershed-segmentation-sensitivity-testing.html#cb255-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb255-15"><a href="watershed-segmentation-sensitivity-testing.html#cb255-15" tabindex="-1"></a>        <span class="at">is_recall_above_mean =</span> recall <span class="sc">&gt;=</span> ( <span class="fu">mean</span>(recall) <span class="sc">+</span> <span class="fu">sd</span>(recall)<span class="sc">*</span><span class="fl">1.5</span> )</span>
<span id="cb255-16"><a href="watershed-segmentation-sensitivity-testing.html#cb255-16" tabindex="-1"></a>        <span class="co"># if no records have a recall at least one stdandard dev above the mean, just take the top ten</span></span>
<span id="cb255-17"><a href="watershed-segmentation-sensitivity-testing.html#cb255-17" tabindex="-1"></a>        , <span class="at">is_top_recall =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb255-18"><a href="watershed-segmentation-sensitivity-testing.html#cb255-18" tabindex="-1"></a>          <span class="fu">sum</span>(is_recall_above_mean)<span class="sc">&gt;</span><span class="dv">4</span> <span class="sc">~</span> is_recall_above_mean</span>
<span id="cb255-19"><a href="watershed-segmentation-sensitivity-testing.html#cb255-19" tabindex="-1"></a>          , T <span class="sc">~</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span><span class="dv">10</span></span>
<span id="cb255-20"><a href="watershed-segmentation-sensitivity-testing.html#cb255-20" tabindex="-1"></a>        )</span>
<span id="cb255-21"><a href="watershed-segmentation-sensitivity-testing.html#cb255-21" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb255-22"><a href="watershed-segmentation-sensitivity-testing.html#cb255-22" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(rn,is_top_recall)</span>
<span id="cb255-23"><a href="watershed-segmentation-sensitivity-testing.html#cb255-23" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb255-24"><a href="watershed-segmentation-sensitivity-testing.html#cb255-24" tabindex="-1"></a>  )</span>
<span id="cb255-25"><a href="watershed-segmentation-sensitivity-testing.html#cb255-25" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb255-26"><a href="watershed-segmentation-sensitivity-testing.html#cb255-26" tabindex="-1"></a><span class="co"># best_pile_detect_rn %&gt;% dplyr::glimpse()</span></span>
<span id="cb255-27"><a href="watershed-segmentation-sensitivity-testing.html#cb255-27" tabindex="-1"></a>best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">count</span>(is_top_recall)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   is_top_recall     n
##   &lt;lgl&gt;         &lt;int&gt;
## 1 FALSE             7
## 2 TRUE             10</code></pre>
<p>finally, let’s look at the pile detection accuracy metrics at the individual parameter combination level</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="watershed-segmentation-sensitivity-testing.html#cb257-1" tabindex="-1"></a><span class="co"># pal_temp %&gt;% scales::show_col()</span></span>
<span id="cb257-2"><a href="watershed-segmentation-sensitivity-testing.html#cb257-2" tabindex="-1"></a><span class="co"># filter and reshape</span></span>
<span id="cb257-3"><a href="watershed-segmentation-sensitivity-testing.html#cb257-3" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span> </span>
<span id="cb257-4"><a href="watershed-segmentation-sensitivity-testing.html#cb257-4" tabindex="-1"></a>  param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb257-5"><a href="watershed-segmentation-sensitivity-testing.html#cb257-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb257-6"><a href="watershed-segmentation-sensitivity-testing.html#cb257-6" tabindex="-1"></a>    best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_top_recall) <span class="sc">%&gt;%</span> </span>
<span id="cb257-7"><a href="watershed-segmentation-sensitivity-testing.html#cb257-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(rn,lab,rank_overall)</span>
<span id="cb257-8"><a href="watershed-segmentation-sensitivity-testing.html#cb257-8" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb257-9"><a href="watershed-segmentation-sensitivity-testing.html#cb257-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb257-10"><a href="watershed-segmentation-sensitivity-testing.html#cb257-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb257-11"><a href="watershed-segmentation-sensitivity-testing.html#cb257-11" tabindex="-1"></a>    max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb257-12"><a href="watershed-segmentation-sensitivity-testing.html#cb257-12" tabindex="-1"></a>    , lab</span>
<span id="cb257-13"><a href="watershed-segmentation-sensitivity-testing.html#cb257-13" tabindex="-1"></a>    <span class="co"># detection</span></span>
<span id="cb257-14"><a href="watershed-segmentation-sensitivity-testing.html#cb257-14" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb257-15"><a href="watershed-segmentation-sensitivity-testing.html#cb257-15" tabindex="-1"></a>    <span class="co"># quantification</span></span>
<span id="cb257-16"><a href="watershed-segmentation-sensitivity-testing.html#cb257-16" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb257-17"><a href="watershed-segmentation-sensitivity-testing.html#cb257-17" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rrmse&quot;</span>)</span>
<span id="cb257-18"><a href="watershed-segmentation-sensitivity-testing.html#cb257-18" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb257-19"><a href="watershed-segmentation-sensitivity-testing.html#cb257-19" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb257-20"><a href="watershed-segmentation-sensitivity-testing.html#cb257-20" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb257-21"><a href="watershed-segmentation-sensitivity-testing.html#cb257-21" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb257-22"><a href="watershed-segmentation-sensitivity-testing.html#cb257-22" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb257-23"><a href="watershed-segmentation-sensitivity-testing.html#cb257-23" tabindex="-1"></a>      f_score, recall, precision</span>
<span id="cb257-24"><a href="watershed-segmentation-sensitivity-testing.html#cb257-24" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb257-25"><a href="watershed-segmentation-sensitivity-testing.html#cb257-25" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rrmse&quot;</span>)</span>
<span id="cb257-26"><a href="watershed-segmentation-sensitivity-testing.html#cb257-26" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb257-27"><a href="watershed-segmentation-sensitivity-testing.html#cb257-27" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb257-28"><a href="watershed-segmentation-sensitivity-testing.html#cb257-28" tabindex="-1"></a>    )</span>
<span id="cb257-29"><a href="watershed-segmentation-sensitivity-testing.html#cb257-29" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb257-30"><a href="watershed-segmentation-sensitivity-testing.html#cb257-30" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb257-31"><a href="watershed-segmentation-sensitivity-testing.html#cb257-31" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb257-32"><a href="watershed-segmentation-sensitivity-testing.html#cb257-32" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb257-33"><a href="watershed-segmentation-sensitivity-testing.html#cb257-33" tabindex="-1"></a>    <span class="at">eval_metric =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(metric, <span class="st">&quot;(_rmse|_rrmse|_mean|_mape|f_score|recall|precision)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb257-34"><a href="watershed-segmentation-sensitivity-testing.html#cb257-34" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb257-35"><a href="watershed-segmentation-sensitivity-testing.html#cb257-35" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;me&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb257-36"><a href="watershed-segmentation-sensitivity-testing.html#cb257-36" tabindex="-1"></a>      <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb257-37"><a href="watershed-segmentation-sensitivity-testing.html#cb257-37" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb257-38"><a href="watershed-segmentation-sensitivity-testing.html#cb257-38" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb257-39"><a href="watershed-segmentation-sensitivity-testing.html#cb257-39" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;FSCORE&quot;</span>,<span class="st">&quot;RECALL&quot;</span>,<span class="st">&quot;PRECISION&quot;</span>, <span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb257-40"><a href="watershed-segmentation-sensitivity-testing.html#cb257-40" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;F-score&quot;</span>,<span class="st">&quot;Recall&quot;</span>,<span class="st">&quot;Precision&quot;</span>, <span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb257-41"><a href="watershed-segmentation-sensitivity-testing.html#cb257-41" tabindex="-1"></a>      )</span>
<span id="cb257-42"><a href="watershed-segmentation-sensitivity-testing.html#cb257-42" tabindex="-1"></a>    , <span class="at">pile_metric =</span> metric <span class="sc">%&gt;%</span> </span>
<span id="cb257-43"><a href="watershed-segmentation-sensitivity-testing.html#cb257-43" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb257-44"><a href="watershed-segmentation-sensitivity-testing.html#cb257-44" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">&quot;(paraboloid_volume|volume|area|height|diameter)&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb257-45"><a href="watershed-segmentation-sensitivity-testing.html#cb257-45" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="st">&quot;detection&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb257-46"><a href="watershed-segmentation-sensitivity-testing.html#cb257-46" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb257-47"><a href="watershed-segmentation-sensitivity-testing.html#cb257-47" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb257-48"><a href="watershed-segmentation-sensitivity-testing.html#cb257-48" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb257-49"><a href="watershed-segmentation-sensitivity-testing.html#cb257-49" tabindex="-1"></a>          <span class="st">&quot;detection&quot;</span></span>
<span id="cb257-50"><a href="watershed-segmentation-sensitivity-testing.html#cb257-50" tabindex="-1"></a>          , <span class="st">&quot;volume&quot;</span></span>
<span id="cb257-51"><a href="watershed-segmentation-sensitivity-testing.html#cb257-51" tabindex="-1"></a>          , <span class="st">&quot;paraboloid_volume&quot;</span></span>
<span id="cb257-52"><a href="watershed-segmentation-sensitivity-testing.html#cb257-52" tabindex="-1"></a>          , <span class="st">&quot;area&quot;</span></span>
<span id="cb257-53"><a href="watershed-segmentation-sensitivity-testing.html#cb257-53" tabindex="-1"></a>          , <span class="st">&quot;height&quot;</span></span>
<span id="cb257-54"><a href="watershed-segmentation-sensitivity-testing.html#cb257-54" tabindex="-1"></a>          , <span class="st">&quot;diameter&quot;</span></span>
<span id="cb257-55"><a href="watershed-segmentation-sensitivity-testing.html#cb257-55" tabindex="-1"></a>        )</span>
<span id="cb257-56"><a href="watershed-segmentation-sensitivity-testing.html#cb257-56" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb257-57"><a href="watershed-segmentation-sensitivity-testing.html#cb257-57" tabindex="-1"></a>          <span class="st">&quot;Detection&quot;</span></span>
<span id="cb257-58"><a href="watershed-segmentation-sensitivity-testing.html#cb257-58" tabindex="-1"></a>          , <span class="st">&quot;Volume&quot;</span></span>
<span id="cb257-59"><a href="watershed-segmentation-sensitivity-testing.html#cb257-59" tabindex="-1"></a>          , <span class="st">&quot;Volume paraboloid&quot;</span></span>
<span id="cb257-60"><a href="watershed-segmentation-sensitivity-testing.html#cb257-60" tabindex="-1"></a>          , <span class="st">&quot;Area&quot;</span></span>
<span id="cb257-61"><a href="watershed-segmentation-sensitivity-testing.html#cb257-61" tabindex="-1"></a>          , <span class="st">&quot;Height&quot;</span></span>
<span id="cb257-62"><a href="watershed-segmentation-sensitivity-testing.html#cb257-62" tabindex="-1"></a>          , <span class="st">&quot;Diameter&quot;</span></span>
<span id="cb257-63"><a href="watershed-segmentation-sensitivity-testing.html#cb257-63" tabindex="-1"></a>        )</span>
<span id="cb257-64"><a href="watershed-segmentation-sensitivity-testing.html#cb257-64" tabindex="-1"></a>      )</span>
<span id="cb257-65"><a href="watershed-segmentation-sensitivity-testing.html#cb257-65" tabindex="-1"></a>    , <span class="at">value_lab =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb257-66"><a href="watershed-segmentation-sensitivity-testing.html#cb257-66" tabindex="-1"></a>        eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;F-score&quot;</span>,<span class="st">&quot;Recall&quot;</span>,<span class="st">&quot;Precision&quot;</span>, <span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>) <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb257-67"><a href="watershed-segmentation-sensitivity-testing.html#cb257-67" tabindex="-1"></a>        , eval_metric <span class="sc">==</span> <span class="st">&quot;ME&quot;</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb257-68"><a href="watershed-segmentation-sensitivity-testing.html#cb257-68" tabindex="-1"></a>        , T <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb257-69"><a href="watershed-segmentation-sensitivity-testing.html#cb257-69" tabindex="-1"></a>      )</span>
<span id="cb257-70"><a href="watershed-segmentation-sensitivity-testing.html#cb257-70" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb257-71"><a href="watershed-segmentation-sensitivity-testing.html#cb257-71" tabindex="-1"></a>  <span class="co"># make var for color</span></span>
<span id="cb257-72"><a href="watershed-segmentation-sensitivity-testing.html#cb257-72" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(pile_metric, eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb257-73"><a href="watershed-segmentation-sensitivity-testing.html#cb257-73" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb257-74"><a href="watershed-segmentation-sensitivity-testing.html#cb257-74" tabindex="-1"></a>    <span class="co"># for ME, color by abs...for f-score,recall,precision color by -value so that higher means better...</span></span>
<span id="cb257-75"><a href="watershed-segmentation-sensitivity-testing.html#cb257-75" tabindex="-1"></a>      <span class="co"># ...since higher means worse for quantification accuracy metrics</span></span>
<span id="cb257-76"><a href="watershed-segmentation-sensitivity-testing.html#cb257-76" tabindex="-1"></a>    <span class="at">value_dir =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb257-77"><a href="watershed-segmentation-sensitivity-testing.html#cb257-77" tabindex="-1"></a>      eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;ME&quot;</span>) <span class="sc">~</span> <span class="fu">abs</span>(value)</span>
<span id="cb257-78"><a href="watershed-segmentation-sensitivity-testing.html#cb257-78" tabindex="-1"></a>      , eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;F-score&quot;</span>,<span class="st">&quot;Recall&quot;</span>,<span class="st">&quot;Precision&quot;</span>) <span class="sc">~</span> <span class="sc">-</span>value</span>
<span id="cb257-79"><a href="watershed-segmentation-sensitivity-testing.html#cb257-79" tabindex="-1"></a>      , T <span class="sc">~</span> value</span>
<span id="cb257-80"><a href="watershed-segmentation-sensitivity-testing.html#cb257-80" tabindex="-1"></a>    )</span>
<span id="cb257-81"><a href="watershed-segmentation-sensitivity-testing.html#cb257-81" tabindex="-1"></a>    , <span class="at">value_z =</span> (value_dir<span class="sc">-</span><span class="fu">mean</span>(value_dir,<span class="at">na.rm=</span>T))<span class="sc">/</span><span class="fu">sd</span>(value_dir,<span class="at">na.rm=</span>T) <span class="co"># this is the key to the different colors within facets</span></span>
<span id="cb257-82"><a href="watershed-segmentation-sensitivity-testing.html#cb257-82" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb257-83"><a href="watershed-segmentation-sensitivity-testing.html#cb257-83" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb257-84"><a href="watershed-segmentation-sensitivity-testing.html#cb257-84" tabindex="-1"></a>  </span>
<span id="cb257-85"><a href="watershed-segmentation-sensitivity-testing.html#cb257-85" tabindex="-1"></a><span class="co"># how to plot all of this (without patchwork)?????</span></span>
<span id="cb257-86"><a href="watershed-segmentation-sensitivity-testing.html#cb257-86" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb257-87"><a href="watershed-segmentation-sensitivity-testing.html#cb257-87" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb257-88"><a href="watershed-segmentation-sensitivity-testing.html#cb257-88" tabindex="-1"></a>  <span class="co"># View()</span></span>
<span id="cb257-89"><a href="watershed-segmentation-sensitivity-testing.html#cb257-89" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> eval_metric, <span class="at">y =</span> lab)) <span class="sc">+</span> </span>
<span id="cb257-90"><a href="watershed-segmentation-sensitivity-testing.html#cb257-90" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb257-91"><a href="watershed-segmentation-sensitivity-testing.html#cb257-91" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pile_metric, <span class="at">alpha =</span> <span class="sc">-</span>value_z)</span>
<span id="cb257-92"><a href="watershed-segmentation-sensitivity-testing.html#cb257-92" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;gray&quot;</span></span>
<span id="cb257-93"><a href="watershed-segmentation-sensitivity-testing.html#cb257-93" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb257-94"><a href="watershed-segmentation-sensitivity-testing.html#cb257-94" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb257-95"><a href="watershed-segmentation-sensitivity-testing.html#cb257-95" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">label =</span> value_lab, <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb257-96"><a href="watershed-segmentation-sensitivity-testing.html#cb257-96" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb257-97"><a href="watershed-segmentation-sensitivity-testing.html#cb257-97" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb257-98"><a href="watershed-segmentation-sensitivity-testing.html#cb257-98" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(pile_metric), <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span> </span>
<span id="cb257-99"><a href="watershed-segmentation-sensitivity-testing.html#cb257-99" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb257-100"><a href="watershed-segmentation-sensitivity-testing.html#cb257-100" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray33&quot;</span>, viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">4</span>))) <span class="sc">+</span></span>
<span id="cb257-101"><a href="watershed-segmentation-sensitivity-testing.html#cb257-101" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_alpha_binned</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.55</span>, <span class="dv">1</span>)) <span class="sc">+</span> <span class="co"># this is the key to the different colors within facets</span></span>
<span id="cb257-102"><a href="watershed-segmentation-sensitivity-testing.html#cb257-102" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb257-103"><a href="watershed-segmentation-sensitivity-testing.html#cb257-103" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb257-104"><a href="watershed-segmentation-sensitivity-testing.html#cb257-104" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb257-105"><a href="watershed-segmentation-sensitivity-testing.html#cb257-105" tabindex="-1"></a>    , <span class="at">y =</span> <span class="st">&quot;max_ht_m : max_area_m2 : convexity_pct : circle_fit_iou_pct&quot;</span></span>
<span id="cb257-106"><a href="watershed-segmentation-sensitivity-testing.html#cb257-106" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb257-107"><a href="watershed-segmentation-sensitivity-testing.html#cb257-107" tabindex="-1"></a>       <span class="st">&quot;pile detection and form quantification accuracy metrics for the top&quot;</span></span>
<span id="cb257-108"><a href="watershed-segmentation-sensitivity-testing.html#cb257-108" tabindex="-1"></a>       <span class="co"># , scales::percent(1-pct_rank_th_top,accuracy=1)</span></span>
<span id="cb257-109"><a href="watershed-segmentation-sensitivity-testing.html#cb257-109" tabindex="-1"></a>       , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb257-110"><a href="watershed-segmentation-sensitivity-testing.html#cb257-110" tabindex="-1"></a>       , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">sum</span>(best_pile_detect_rn<span class="sc">$</span>is_top_recall,<span class="at">na.rm=</span>T), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb257-111"><a href="watershed-segmentation-sensitivity-testing.html#cb257-111" tabindex="-1"></a>       , <span class="st">&quot;) &quot;</span></span>
<span id="cb257-112"><a href="watershed-segmentation-sensitivity-testing.html#cb257-112" tabindex="-1"></a>       , <span class="st">&quot;overall parameter combinations</span><span class="sc">\n</span><span class="st">based on both detection and quantification accuracy&quot;</span></span>
<span id="cb257-113"><a href="watershed-segmentation-sensitivity-testing.html#cb257-113" tabindex="-1"></a>      )</span>
<span id="cb257-114"><a href="watershed-segmentation-sensitivity-testing.html#cb257-114" tabindex="-1"></a>    , <span class="at">caption =</span> <span class="st">&quot;*darker colors indicate relatively higher accuracy values&quot;</span></span>
<span id="cb257-115"><a href="watershed-segmentation-sensitivity-testing.html#cb257-115" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb257-116"><a href="watershed-segmentation-sensitivity-testing.html#cb257-116" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb257-117"><a href="watershed-segmentation-sensitivity-testing.html#cb257-117" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb257-118"><a href="watershed-segmentation-sensitivity-testing.html#cb257-118" tabindex="-1"></a>    , <span class="at">panel.grid =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb257-119"><a href="watershed-segmentation-sensitivity-testing.html#cb257-119" tabindex="-1"></a>    , <span class="at">strip.placement =</span> <span class="st">&quot;outside&quot;</span></span>
<span id="cb257-120"><a href="watershed-segmentation-sensitivity-testing.html#cb257-120" tabindex="-1"></a>    , <span class="at">strip.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb257-121"><a href="watershed-segmentation-sensitivity-testing.html#cb257-121" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb257-122"><a href="watershed-segmentation-sensitivity-testing.html#cb257-122" tabindex="-1"></a>    , <span class="at">axis.title.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb257-123"><a href="watershed-segmentation-sensitivity-testing.html#cb257-123" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb257-124"><a href="watershed-segmentation-sensitivity-testing.html#cb257-124" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-218-1.png" width="1008" /></p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="watershed-segmentation-sensitivity-testing.html#cb258-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/bestofthebest_watersheddetectever.jpg&quot;</span>, <span class="at">height =</span> <span class="fl">8.2</span>, <span class="at">width =</span> <span class="fl">10.5</span>)</span></code></pre></div>
<p>this plot allows for a simultaneous comparison of all metrics for pile detection and pile form quantification. it includes only the parameter combinations that achieved the best balanced accuracy, helping users identify the optimal settings by evaluating the trade-offs between detection and form quantification.</p>
<p>let’s table this</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="watershed-segmentation-sensitivity-testing.html#cb259-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb259-2"><a href="watershed-segmentation-sensitivity-testing.html#cb259-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb259-3"><a href="watershed-segmentation-sensitivity-testing.html#cb259-3" tabindex="-1"></a>    best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_top_recall) <span class="sc">%&gt;%</span> </span>
<span id="cb259-4"><a href="watershed-segmentation-sensitivity-testing.html#cb259-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(rn,lab,rank_overall)</span>
<span id="cb259-5"><a href="watershed-segmentation-sensitivity-testing.html#cb259-5" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb259-6"><a href="watershed-segmentation-sensitivity-testing.html#cb259-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-7"><a href="watershed-segmentation-sensitivity-testing.html#cb259-7" tabindex="-1"></a>  <span class="co"># first select to arrange eval_metric</span></span>
<span id="cb259-8"><a href="watershed-segmentation-sensitivity-testing.html#cb259-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb259-9"><a href="watershed-segmentation-sensitivity-testing.html#cb259-9" tabindex="-1"></a>    lab</span>
<span id="cb259-10"><a href="watershed-segmentation-sensitivity-testing.html#cb259-10" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb259-11"><a href="watershed-segmentation-sensitivity-testing.html#cb259-11" tabindex="-1"></a>    <span class="co"># detection</span></span>
<span id="cb259-12"><a href="watershed-segmentation-sensitivity-testing.html#cb259-12" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb259-13"><a href="watershed-segmentation-sensitivity-testing.html#cb259-13" tabindex="-1"></a>    <span class="co"># quantification</span></span>
<span id="cb259-14"><a href="watershed-segmentation-sensitivity-testing.html#cb259-14" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb259-15"><a href="watershed-segmentation-sensitivity-testing.html#cb259-15" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb259-16"><a href="watershed-segmentation-sensitivity-testing.html#cb259-16" tabindex="-1"></a>    <span class="co"># , tidyselect::ends_with(&quot;_rrmse&quot;)</span></span>
<span id="cb259-17"><a href="watershed-segmentation-sensitivity-testing.html#cb259-17" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb259-18"><a href="watershed-segmentation-sensitivity-testing.html#cb259-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-19"><a href="watershed-segmentation-sensitivity-testing.html#cb259-19" tabindex="-1"></a>  <span class="co"># second select to arrange pile_metric</span></span>
<span id="cb259-20"><a href="watershed-segmentation-sensitivity-testing.html#cb259-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb259-21"><a href="watershed-segmentation-sensitivity-testing.html#cb259-21" tabindex="-1"></a>    lab</span>
<span id="cb259-22"><a href="watershed-segmentation-sensitivity-testing.html#cb259-22" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb259-23"><a href="watershed-segmentation-sensitivity-testing.html#cb259-23" tabindex="-1"></a>    <span class="co"># detection</span></span>
<span id="cb259-24"><a href="watershed-segmentation-sensitivity-testing.html#cb259-24" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb259-25"><a href="watershed-segmentation-sensitivity-testing.html#cb259-25" tabindex="-1"></a>    <span class="co"># quantification</span></span>
<span id="cb259-26"><a href="watershed-segmentation-sensitivity-testing.html#cb259-26" tabindex="-1"></a>    , <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;volume&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;paraboloid&quot;</span>))</span>
<span id="cb259-27"><a href="watershed-segmentation-sensitivity-testing.html#cb259-27" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;area&quot;</span>)</span>
<span id="cb259-28"><a href="watershed-segmentation-sensitivity-testing.html#cb259-28" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;height&quot;</span>)</span>
<span id="cb259-29"><a href="watershed-segmentation-sensitivity-testing.html#cb259-29" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;diameter&quot;</span>)</span>
<span id="cb259-30"><a href="watershed-segmentation-sensitivity-testing.html#cb259-30" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-31"><a href="watershed-segmentation-sensitivity-testing.html#cb259-31" tabindex="-1"></a>  <span class="co"># names()</span></span>
<span id="cb259-32"><a href="watershed-segmentation-sensitivity-testing.html#cb259-32" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb259-33"><a href="watershed-segmentation-sensitivity-testing.html#cb259-33" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb259-34"><a href="watershed-segmentation-sensitivity-testing.html#cb259-34" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(f_score, recall, precision, tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb259-35"><a href="watershed-segmentation-sensitivity-testing.html#cb259-35" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb259-36"><a href="watershed-segmentation-sensitivity-testing.html#cb259-36" tabindex="-1"></a>    )</span>
<span id="cb259-37"><a href="watershed-segmentation-sensitivity-testing.html#cb259-37" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb259-38"><a href="watershed-segmentation-sensitivity-testing.html#cb259-38" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>))</span>
<span id="cb259-39"><a href="watershed-segmentation-sensitivity-testing.html#cb259-39" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(.x, <span class="at">accuracy =</span> <span class="fl">0.01</span>)</span>
<span id="cb259-40"><a href="watershed-segmentation-sensitivity-testing.html#cb259-40" tabindex="-1"></a>    )</span>
<span id="cb259-41"><a href="watershed-segmentation-sensitivity-testing.html#cb259-41" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb259-42"><a href="watershed-segmentation-sensitivity-testing.html#cb259-42" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>))</span>
<span id="cb259-43"><a href="watershed-segmentation-sensitivity-testing.html#cb259-43" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(.x, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb259-44"><a href="watershed-segmentation-sensitivity-testing.html#cb259-44" tabindex="-1"></a>    )</span>
<span id="cb259-45"><a href="watershed-segmentation-sensitivity-testing.html#cb259-45" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-46"><a href="watershed-segmentation-sensitivity-testing.html#cb259-46" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">blank=</span> <span class="st">&quot;   &quot;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-47"><a href="watershed-segmentation-sensitivity-testing.html#cb259-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(blank, <span class="at">.before =</span> f_score) <span class="sc">%&gt;%</span> </span>
<span id="cb259-48"><a href="watershed-segmentation-sensitivity-testing.html#cb259-48" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(lab)) <span class="sc">%&gt;%</span> </span>
<span id="cb259-49"><a href="watershed-segmentation-sensitivity-testing.html#cb259-49" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb259-50"><a href="watershed-segmentation-sensitivity-testing.html#cb259-50" tabindex="-1"></a>    <span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb259-51"><a href="watershed-segmentation-sensitivity-testing.html#cb259-51" tabindex="-1"></a>       <span class="st">&quot;pile detection and form quantification accuracy metrics for the final recommended parameter settings&quot;</span></span>
<span id="cb259-52"><a href="watershed-segmentation-sensitivity-testing.html#cb259-52" tabindex="-1"></a>       <span class="co"># , scales::percent(1-pct_rank_th_top,accuracy=1)</span></span>
<span id="cb259-53"><a href="watershed-segmentation-sensitivity-testing.html#cb259-53" tabindex="-1"></a>       , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb259-54"><a href="watershed-segmentation-sensitivity-testing.html#cb259-54" tabindex="-1"></a>       , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">sum</span>(best_pile_detect_rn<span class="sc">$</span>is_top_recall,<span class="at">na.rm=</span>T), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb259-55"><a href="watershed-segmentation-sensitivity-testing.html#cb259-55" tabindex="-1"></a>       , <span class="st">&quot;)&quot;</span></span>
<span id="cb259-56"><a href="watershed-segmentation-sensitivity-testing.html#cb259-56" tabindex="-1"></a>      )</span>
<span id="cb259-57"><a href="watershed-segmentation-sensitivity-testing.html#cb259-57" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb259-58"><a href="watershed-segmentation-sensitivity-testing.html#cb259-58" tabindex="-1"></a>      <span class="st">&quot;&quot;</span></span>
<span id="cb259-59"><a href="watershed-segmentation-sensitivity-testing.html#cb259-59" tabindex="-1"></a>      ,<span class="st">&quot;max_ht_m&quot;</span>,<span class="st">&quot;max_area_m2&quot;</span>,<span class="st">&quot;convexity_pct&quot;</span>,<span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb259-60"><a href="watershed-segmentation-sensitivity-testing.html#cb259-60" tabindex="-1"></a>      , <span class="st">&quot;   &quot;</span></span>
<span id="cb259-61"><a href="watershed-segmentation-sensitivity-testing.html#cb259-61" tabindex="-1"></a>      , <span class="st">&quot;F-score&quot;</span>, <span class="st">&quot;Recall&quot;</span>, <span class="st">&quot;Precision&quot;</span></span>
<span id="cb259-62"><a href="watershed-segmentation-sensitivity-testing.html#cb259-62" tabindex="-1"></a>      , <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>), <span class="at">times =</span> <span class="dv">4</span>)</span>
<span id="cb259-63"><a href="watershed-segmentation-sensitivity-testing.html#cb259-63" tabindex="-1"></a>    )</span>
<span id="cb259-64"><a href="watershed-segmentation-sensitivity-testing.html#cb259-64" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb259-65"><a href="watershed-segmentation-sensitivity-testing.html#cb259-65" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-66"><a href="watershed-segmentation-sensitivity-testing.html#cb259-66" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">11</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb259-67"><a href="watershed-segmentation-sensitivity-testing.html#cb259-67" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(<span class="fu">c</span>(</span>
<span id="cb259-68"><a href="watershed-segmentation-sensitivity-testing.html#cb259-68" tabindex="-1"></a>    <span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">6</span></span>
<span id="cb259-69"><a href="watershed-segmentation-sensitivity-testing.html#cb259-69" tabindex="-1"></a>    , <span class="st">&quot;Detection&quot;</span> <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb259-70"><a href="watershed-segmentation-sensitivity-testing.html#cb259-70" tabindex="-1"></a>    , <span class="st">&quot;Volume&quot;</span> <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb259-71"><a href="watershed-segmentation-sensitivity-testing.html#cb259-71" tabindex="-1"></a>    , <span class="st">&quot;Area&quot;</span> <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb259-72"><a href="watershed-segmentation-sensitivity-testing.html#cb259-72" tabindex="-1"></a>    , <span class="st">&quot;Height&quot;</span> <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb259-73"><a href="watershed-segmentation-sensitivity-testing.html#cb259-73" tabindex="-1"></a>    , <span class="st">&quot;Diameter&quot;</span> <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb259-74"><a href="watershed-segmentation-sensitivity-testing.html#cb259-74" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb259-75"><a href="watershed-segmentation-sensitivity-testing.html#cb259-75" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">column_spec</span>(<span class="fu">seq</span>(<span class="dv">6</span>,<span class="dv">21</span>,<span class="at">by=</span><span class="dv">3</span>), <span class="at">border_right =</span> <span class="cn">TRUE</span>, <span class="at">include_thead =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb259-76"><a href="watershed-segmentation-sensitivity-testing.html#cb259-76" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">column_spec</span>(</span>
<span id="cb259-77"><a href="watershed-segmentation-sensitivity-testing.html#cb259-77" tabindex="-1"></a>    <span class="at">column =</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">21</span></span>
<span id="cb259-78"><a href="watershed-segmentation-sensitivity-testing.html#cb259-78" tabindex="-1"></a>    , <span class="at">extra_css =</span> <span class="st">&quot;font-size: 10px;&quot;</span></span>
<span id="cb259-79"><a href="watershed-segmentation-sensitivity-testing.html#cb259-79" tabindex="-1"></a>    , <span class="at">include_thead =</span> T</span>
<span id="cb259-80"><a href="watershed-segmentation-sensitivity-testing.html#cb259-80" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-81"><a href="watershed-segmentation-sensitivity-testing.html#cb259-81" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">scroll_box</span>(<span class="at">width =</span> <span class="st">&quot;740px&quot;</span>) </span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:740px; ">
<table class="table" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-219">Table 6.3: </span>pile detection and form quantification accuracy metrics for the final recommended parameter settings (n=10)
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="6">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Detection
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Volume
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Area
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Height
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Diameter
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
max_ht_m
</th>
<th style="text-align:right;">
max_area_m2
</th>
<th style="text-align:right;">
convexity_pct
</th>
<th style="text-align:right;">
circle_fit_iou_pct
</th>
<th style="text-align:left;border-right:1px solid;">
</th>
<th style="text-align:left;font-size: 10px;">
F-score
</th>
<th style="text-align:left;font-size: 10px;">
Recall
</th>
<th style="text-align:left;border-right:1px solid;font-size: 10px;">
Precision
</th>
<th style="text-align:left;font-size: 10px;">
ME
</th>
<th style="text-align:left;font-size: 10px;">
RMSE
</th>
<th style="text-align:left;border-right:1px solid;font-size: 10px;">
MAPE
</th>
<th style="text-align:left;font-size: 10px;">
ME
</th>
<th style="text-align:left;font-size: 10px;">
RMSE
</th>
<th style="text-align:left;border-right:1px solid;font-size: 10px;">
MAPE
</th>
<th style="text-align:left;font-size: 10px;">
ME
</th>
<th style="text-align:left;font-size: 10px;">
RMSE
</th>
<th style="text-align:left;border-right:1px solid;font-size: 10px;">
MAPE
</th>
<th style="text-align:left;font-size: 10px;">
ME
</th>
<th style="text-align:left;font-size: 10px;">
RMSE
</th>
<th style="text-align:left;border-right:1px solid;font-size: 10px;">
MAPE
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2:40:0.7:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
40
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
64%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
82%
</td>
<td style="text-align:left;font-size: 10px;">
-1.70
</td>
<td style="text-align:left;font-size: 10px;">
9.3
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
29%
</td>
<td style="text-align:left;font-size: 10px;">
-0.02
</td>
<td style="text-align:left;font-size: 10px;">
3.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
21%
</td>
<td style="text-align:left;font-size: 10px;">
-0.26
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
14%
</td>
<td style="text-align:left;font-size: 10px;">
0.70
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
24%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:30:0.7:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
64%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
82%
</td>
<td style="text-align:left;font-size: 10px;">
-1.70
</td>
<td style="text-align:left;font-size: 10px;">
9.3
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
29%
</td>
<td style="text-align:left;font-size: 10px;">
-0.02
</td>
<td style="text-align:left;font-size: 10px;">
3.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
21%
</td>
<td style="text-align:left;font-size: 10px;">
-0.26
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
14%
</td>
<td style="text-align:left;font-size: 10px;">
0.70
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
24%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:30:0.6:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
66%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
80%
</td>
<td style="text-align:left;font-size: 10px;">
-1.61
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
28%
</td>
<td style="text-align:left;font-size: 10px;">
0.04
</td>
<td style="text-align:left;font-size: 10px;">
3.1
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
14%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
24%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:30:0.5:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
66%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
80%
</td>
<td style="text-align:left;font-size: 10px;">
-1.61
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
28%
</td>
<td style="text-align:left;font-size: 10px;">
0.04
</td>
<td style="text-align:left;font-size: 10px;">
3.1
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
14%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
24%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:30:0.4:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
66%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
80%
</td>
<td style="text-align:left;font-size: 10px;">
-1.61
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
28%
</td>
<td style="text-align:left;font-size: 10px;">
0.04
</td>
<td style="text-align:left;font-size: 10px;">
3.1
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
14%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
24%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:30:0.3:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
66%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
80%
</td>
<td style="text-align:left;font-size: 10px;">
-1.61
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
28%
</td>
<td style="text-align:left;font-size: 10px;">
0.04
</td>
<td style="text-align:left;font-size: 10px;">
3.1
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
14%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
24%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:20:0.6:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
65%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
81%
</td>
<td style="text-align:left;font-size: 10px;">
-1.57
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
29%
</td>
<td style="text-align:left;font-size: 10px;">
0.06
</td>
<td style="text-align:left;font-size: 10px;">
3.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
13%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
25%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:20:0.5:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
65%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
81%
</td>
<td style="text-align:left;font-size: 10px;">
-1.57
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
29%
</td>
<td style="text-align:left;font-size: 10px;">
0.06
</td>
<td style="text-align:left;font-size: 10px;">
3.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
13%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
25%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:20:0.4:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
65%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
81%
</td>
<td style="text-align:left;font-size: 10px;">
-1.57
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
29%
</td>
<td style="text-align:left;font-size: 10px;">
0.06
</td>
<td style="text-align:left;font-size: 10px;">
3.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
13%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
25%
</td>
</tr>
<tr>
<td style="text-align:left;">
2:20:0.3:0.5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;">
</td>
<td style="text-align:left;font-size: 10px;">
72%
</td>
<td style="text-align:left;font-size: 10px;">
65%
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
81%
</td>
<td style="text-align:left;font-size: 10px;">
-1.57
</td>
<td style="text-align:left;font-size: 10px;">
9.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
29%
</td>
<td style="text-align:left;font-size: 10px;">
0.06
</td>
<td style="text-align:left;font-size: 10px;">
3.2
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
22%
</td>
<td style="text-align:left;font-size: 10px;">
-0.25
</td>
<td style="text-align:left;font-size: 10px;">
0.5
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
13%
</td>
<td style="text-align:left;font-size: 10px;">
0.72
</td>
<td style="text-align:left;font-size: 10px;">
0.9
</td>
<td style="text-align:left;border-right:1px solid;font-size: 10px;">
25%
</td>
</tr>
</tbody>
</table>
</div>
<p>what is the detection accuracy of these final recommended parameter settings?</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="watershed-segmentation-sensitivity-testing.html#cb260-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb260-2"><a href="watershed-segmentation-sensitivity-testing.html#cb260-2" tabindex="-1"></a><span class="fu">plt_detection_dist</span>(</span>
<span id="cb260-3"><a href="watershed-segmentation-sensitivity-testing.html#cb260-3" tabindex="-1"></a>  <span class="at">df =</span> param_combos_gt_agg <span class="sc">%&gt;%</span></span>
<span id="cb260-4"><a href="watershed-segmentation-sensitivity-testing.html#cb260-4" tabindex="-1"></a>    <span class="co"># filter for best of best</span></span>
<span id="cb260-5"><a href="watershed-segmentation-sensitivity-testing.html#cb260-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb260-6"><a href="watershed-segmentation-sensitivity-testing.html#cb260-6" tabindex="-1"></a>      best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_top_recall) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn)</span>
<span id="cb260-7"><a href="watershed-segmentation-sensitivity-testing.html#cb260-7" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb260-8"><a href="watershed-segmentation-sensitivity-testing.html#cb260-8" tabindex="-1"></a>    )</span>
<span id="cb260-9"><a href="watershed-segmentation-sensitivity-testing.html#cb260-9" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb260-10"><a href="watershed-segmentation-sensitivity-testing.html#cb260-10" tabindex="-1"></a>       <span class="st">&quot;distribution of pile detection accuracy metrics for the final recommended parameter settings&quot;</span></span>
<span id="cb260-11"><a href="watershed-segmentation-sensitivity-testing.html#cb260-11" tabindex="-1"></a>       <span class="co"># , scales::percent(1-pct_rank_th_top,accuracy=1)</span></span>
<span id="cb260-12"><a href="watershed-segmentation-sensitivity-testing.html#cb260-12" tabindex="-1"></a>       , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb260-13"><a href="watershed-segmentation-sensitivity-testing.html#cb260-13" tabindex="-1"></a>       , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">sum</span>(best_pile_detect_rn<span class="sc">$</span>is_top_recall,<span class="at">na.rm=</span>T), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb260-14"><a href="watershed-segmentation-sensitivity-testing.html#cb260-14" tabindex="-1"></a>       , <span class="st">&quot;)&quot;</span></span>
<span id="cb260-15"><a href="watershed-segmentation-sensitivity-testing.html#cb260-15" tabindex="-1"></a>      )</span>
<span id="cb260-16"><a href="watershed-segmentation-sensitivity-testing.html#cb260-16" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-220-1.png" width="1008" /></p>
<p>what is the quantification accuracy of these final recommended parameter settings?</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="watershed-segmentation-sensitivity-testing.html#cb261-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb261-2"><a href="watershed-segmentation-sensitivity-testing.html#cb261-2" tabindex="-1"></a><span class="fu">plt_form_quantification_dist</span>(</span>
<span id="cb261-3"><a href="watershed-segmentation-sensitivity-testing.html#cb261-3" tabindex="-1"></a>  <span class="at">df =</span> param_combos_gt_agg <span class="sc">%&gt;%</span></span>
<span id="cb261-4"><a href="watershed-segmentation-sensitivity-testing.html#cb261-4" tabindex="-1"></a>    <span class="co"># filter for best of best</span></span>
<span id="cb261-5"><a href="watershed-segmentation-sensitivity-testing.html#cb261-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb261-6"><a href="watershed-segmentation-sensitivity-testing.html#cb261-6" tabindex="-1"></a>      best_pile_detect_rn <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_top_recall) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn)</span>
<span id="cb261-7"><a href="watershed-segmentation-sensitivity-testing.html#cb261-7" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb261-8"><a href="watershed-segmentation-sensitivity-testing.html#cb261-8" tabindex="-1"></a>    )</span>
<span id="cb261-9"><a href="watershed-segmentation-sensitivity-testing.html#cb261-9" tabindex="-1"></a>  , <span class="fu">paste0</span>(</span>
<span id="cb261-10"><a href="watershed-segmentation-sensitivity-testing.html#cb261-10" tabindex="-1"></a>       <span class="st">&quot;distribution of pile form quantification accuracy metrics for the final recommended parameter settings&quot;</span></span>
<span id="cb261-11"><a href="watershed-segmentation-sensitivity-testing.html#cb261-11" tabindex="-1"></a>       <span class="co"># , scales::percent(1-pct_rank_th_top,accuracy=1)</span></span>
<span id="cb261-12"><a href="watershed-segmentation-sensitivity-testing.html#cb261-12" tabindex="-1"></a>       , <span class="st">&quot; (n=&quot;</span></span>
<span id="cb261-13"><a href="watershed-segmentation-sensitivity-testing.html#cb261-13" tabindex="-1"></a>       , scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">sum</span>(best_pile_detect_rn<span class="sc">$</span>is_top_recall,<span class="at">na.rm=</span>T), <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb261-14"><a href="watershed-segmentation-sensitivity-testing.html#cb261-14" tabindex="-1"></a>       , <span class="st">&quot;)&quot;</span></span>
<span id="cb261-15"><a href="watershed-segmentation-sensitivity-testing.html#cb261-15" tabindex="-1"></a>      )</span>
<span id="cb261-16"><a href="watershed-segmentation-sensitivity-testing.html#cb261-16" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-221-1.png" width="1008" /></p>
</div>
<div id="appendix-parameter-combination-drill-downs" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Appendix: Parameter combination drill-downs<a href="watershed-segmentation-sensitivity-testing.html#appendix-parameter-combination-drill-downs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The objective of these combination drill-down plots is to convey the pile detection evaluation results for a given set of the <code>convexity_pct</code>, <code>circle_fit_iou_pct</code>, and <code>max_area_m2</code> parameter settings while holding the <code>max_ht_m</code> and <code>min_area_m2</code> parameters constant since these should be defined based on the expected values of the treatment area. Based on our validation data, it was clear that the optimal <code>max_ht_m</code> value was 3.0 and that setting the value above this level resulted in understory trees being incorrectly detected as slash piles.</p>
<div id="f-score" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> F-score<a href="watershed-segmentation-sensitivity-testing.html#f-score" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="watershed-segmentation-sensitivity-testing.html#cb262-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb262-2"><a href="watershed-segmentation-sensitivity-testing.html#cb262-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb262-3"><a href="watershed-segmentation-sensitivity-testing.html#cb262-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb262-4"><a href="watershed-segmentation-sensitivity-testing.html#cb262-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb262-5"><a href="watershed-segmentation-sensitivity-testing.html#cb262-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb262-6"><a href="watershed-segmentation-sensitivity-testing.html#cb262-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb262-7"><a href="watershed-segmentation-sensitivity-testing.html#cb262-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb262-8"><a href="watershed-segmentation-sensitivity-testing.html#cb262-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb262-9"><a href="watershed-segmentation-sensitivity-testing.html#cb262-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb262-10"><a href="watershed-segmentation-sensitivity-testing.html#cb262-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb262-11"><a href="watershed-segmentation-sensitivity-testing.html#cb262-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb262-12"><a href="watershed-segmentation-sensitivity-testing.html#cb262-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb262-13"><a href="watershed-segmentation-sensitivity-testing.html#cb262-13" tabindex="-1"></a>      , <span class="at">fill =</span> f_score</span>
<span id="cb262-14"><a href="watershed-segmentation-sensitivity-testing.html#cb262-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(f_score,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb262-15"><a href="watershed-segmentation-sensitivity-testing.html#cb262-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb262-16"><a href="watershed-segmentation-sensitivity-testing.html#cb262-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb262-17"><a href="watershed-segmentation-sensitivity-testing.html#cb262-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb262-18"><a href="watershed-segmentation-sensitivity-testing.html#cb262-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb262-19"><a href="watershed-segmentation-sensitivity-testing.html#cb262-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(</span>
<span id="cb262-20"><a href="watershed-segmentation-sensitivity-testing.html#cb262-20" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;Oranges&quot;</span></span>
<span id="cb262-21"><a href="watershed-segmentation-sensitivity-testing.html#cb262-21" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb262-22"><a href="watershed-segmentation-sensitivity-testing.html#cb262-22" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb262-23"><a href="watershed-segmentation-sensitivity-testing.html#cb262-23" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb262-24"><a href="watershed-segmentation-sensitivity-testing.html#cb262-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb262-25"><a href="watershed-segmentation-sensitivity-testing.html#cb262-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb262-26"><a href="watershed-segmentation-sensitivity-testing.html#cb262-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb262-27"><a href="watershed-segmentation-sensitivity-testing.html#cb262-27" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb262-28"><a href="watershed-segmentation-sensitivity-testing.html#cb262-28" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;F-score by parameter setting combination levels&quot;</span></span>
<span id="cb262-29"><a href="watershed-segmentation-sensitivity-testing.html#cb262-29" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb262-30"><a href="watershed-segmentation-sensitivity-testing.html#cb262-30" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb262-31"><a href="watershed-segmentation-sensitivity-testing.html#cb262-31" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb262-32"><a href="watershed-segmentation-sensitivity-testing.html#cb262-32" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb262-33"><a href="watershed-segmentation-sensitivity-testing.html#cb262-33" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb262-34"><a href="watershed-segmentation-sensitivity-testing.html#cb262-34" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb262-35"><a href="watershed-segmentation-sensitivity-testing.html#cb262-35" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb262-36"><a href="watershed-segmentation-sensitivity-testing.html#cb262-36" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb262-37"><a href="watershed-segmentation-sensitivity-testing.html#cb262-37" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb262-38"><a href="watershed-segmentation-sensitivity-testing.html#cb262-38" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb262-39"><a href="watershed-segmentation-sensitivity-testing.html#cb262-39" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-224-1.png" width="1008" /></p>
</div>
<div id="recall" class="section level3 hasAnchor" number="6.5.2">
<h3><span class="header-section-number">6.5.2</span> Recall<a href="watershed-segmentation-sensitivity-testing.html#recall" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="watershed-segmentation-sensitivity-testing.html#cb263-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb263-2"><a href="watershed-segmentation-sensitivity-testing.html#cb263-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb263-3"><a href="watershed-segmentation-sensitivity-testing.html#cb263-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb263-4"><a href="watershed-segmentation-sensitivity-testing.html#cb263-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb263-5"><a href="watershed-segmentation-sensitivity-testing.html#cb263-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb263-6"><a href="watershed-segmentation-sensitivity-testing.html#cb263-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb263-7"><a href="watershed-segmentation-sensitivity-testing.html#cb263-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb263-8"><a href="watershed-segmentation-sensitivity-testing.html#cb263-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb263-9"><a href="watershed-segmentation-sensitivity-testing.html#cb263-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb263-10"><a href="watershed-segmentation-sensitivity-testing.html#cb263-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb263-11"><a href="watershed-segmentation-sensitivity-testing.html#cb263-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb263-12"><a href="watershed-segmentation-sensitivity-testing.html#cb263-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb263-13"><a href="watershed-segmentation-sensitivity-testing.html#cb263-13" tabindex="-1"></a>      , <span class="at">fill =</span> recall</span>
<span id="cb263-14"><a href="watershed-segmentation-sensitivity-testing.html#cb263-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(recall,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb263-15"><a href="watershed-segmentation-sensitivity-testing.html#cb263-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb263-16"><a href="watershed-segmentation-sensitivity-testing.html#cb263-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb263-17"><a href="watershed-segmentation-sensitivity-testing.html#cb263-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb263-18"><a href="watershed-segmentation-sensitivity-testing.html#cb263-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb263-19"><a href="watershed-segmentation-sensitivity-testing.html#cb263-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_gradient</span>(</span>
<span id="cb263-20"><a href="watershed-segmentation-sensitivity-testing.html#cb263-20" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">&quot;gray97&quot;</span>, <span class="at">high =</span> <span class="st">&quot;gray27&quot;</span></span>
<span id="cb263-21"><a href="watershed-segmentation-sensitivity-testing.html#cb263-21" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb263-22"><a href="watershed-segmentation-sensitivity-testing.html#cb263-22" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb263-23"><a href="watershed-segmentation-sensitivity-testing.html#cb263-23" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb263-24"><a href="watershed-segmentation-sensitivity-testing.html#cb263-24" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb263-25"><a href="watershed-segmentation-sensitivity-testing.html#cb263-25" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb263-26"><a href="watershed-segmentation-sensitivity-testing.html#cb263-26" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb263-27"><a href="watershed-segmentation-sensitivity-testing.html#cb263-27" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Recall by parameter setting combination levels&quot;</span></span>
<span id="cb263-28"><a href="watershed-segmentation-sensitivity-testing.html#cb263-28" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb263-29"><a href="watershed-segmentation-sensitivity-testing.html#cb263-29" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb263-30"><a href="watershed-segmentation-sensitivity-testing.html#cb263-30" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb263-31"><a href="watershed-segmentation-sensitivity-testing.html#cb263-31" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb263-32"><a href="watershed-segmentation-sensitivity-testing.html#cb263-32" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb263-33"><a href="watershed-segmentation-sensitivity-testing.html#cb263-33" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb263-34"><a href="watershed-segmentation-sensitivity-testing.html#cb263-34" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb263-35"><a href="watershed-segmentation-sensitivity-testing.html#cb263-35" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb263-36"><a href="watershed-segmentation-sensitivity-testing.html#cb263-36" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb263-37"><a href="watershed-segmentation-sensitivity-testing.html#cb263-37" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb263-38"><a href="watershed-segmentation-sensitivity-testing.html#cb263-38" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-225-1.png" width="1008" /></p>
</div>
<div id="precision" class="section level3 hasAnchor" number="6.5.3">
<h3><span class="header-section-number">6.5.3</span> Precision<a href="watershed-segmentation-sensitivity-testing.html#precision" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="watershed-segmentation-sensitivity-testing.html#cb264-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb264-2"><a href="watershed-segmentation-sensitivity-testing.html#cb264-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb264-3"><a href="watershed-segmentation-sensitivity-testing.html#cb264-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb264-4"><a href="watershed-segmentation-sensitivity-testing.html#cb264-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb264-5"><a href="watershed-segmentation-sensitivity-testing.html#cb264-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb264-6"><a href="watershed-segmentation-sensitivity-testing.html#cb264-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb264-7"><a href="watershed-segmentation-sensitivity-testing.html#cb264-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb264-8"><a href="watershed-segmentation-sensitivity-testing.html#cb264-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb264-9"><a href="watershed-segmentation-sensitivity-testing.html#cb264-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb264-10"><a href="watershed-segmentation-sensitivity-testing.html#cb264-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb264-11"><a href="watershed-segmentation-sensitivity-testing.html#cb264-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb264-12"><a href="watershed-segmentation-sensitivity-testing.html#cb264-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb264-13"><a href="watershed-segmentation-sensitivity-testing.html#cb264-13" tabindex="-1"></a>      , <span class="at">fill =</span> precision</span>
<span id="cb264-14"><a href="watershed-segmentation-sensitivity-testing.html#cb264-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(precision,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb264-15"><a href="watershed-segmentation-sensitivity-testing.html#cb264-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb264-16"><a href="watershed-segmentation-sensitivity-testing.html#cb264-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb264-17"><a href="watershed-segmentation-sensitivity-testing.html#cb264-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb264-18"><a href="watershed-segmentation-sensitivity-testing.html#cb264-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb264-19"><a href="watershed-segmentation-sensitivity-testing.html#cb264-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(</span>
<span id="cb264-20"><a href="watershed-segmentation-sensitivity-testing.html#cb264-20" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;Purples&quot;</span></span>
<span id="cb264-21"><a href="watershed-segmentation-sensitivity-testing.html#cb264-21" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb264-22"><a href="watershed-segmentation-sensitivity-testing.html#cb264-22" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb264-23"><a href="watershed-segmentation-sensitivity-testing.html#cb264-23" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb264-24"><a href="watershed-segmentation-sensitivity-testing.html#cb264-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb264-25"><a href="watershed-segmentation-sensitivity-testing.html#cb264-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb264-26"><a href="watershed-segmentation-sensitivity-testing.html#cb264-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb264-27"><a href="watershed-segmentation-sensitivity-testing.html#cb264-27" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb264-28"><a href="watershed-segmentation-sensitivity-testing.html#cb264-28" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Precision by parameter setting combination levels&quot;</span></span>
<span id="cb264-29"><a href="watershed-segmentation-sensitivity-testing.html#cb264-29" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb264-30"><a href="watershed-segmentation-sensitivity-testing.html#cb264-30" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb264-31"><a href="watershed-segmentation-sensitivity-testing.html#cb264-31" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb264-32"><a href="watershed-segmentation-sensitivity-testing.html#cb264-32" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb264-33"><a href="watershed-segmentation-sensitivity-testing.html#cb264-33" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb264-34"><a href="watershed-segmentation-sensitivity-testing.html#cb264-34" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb264-35"><a href="watershed-segmentation-sensitivity-testing.html#cb264-35" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb264-36"><a href="watershed-segmentation-sensitivity-testing.html#cb264-36" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb264-37"><a href="watershed-segmentation-sensitivity-testing.html#cb264-37" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb264-38"><a href="watershed-segmentation-sensitivity-testing.html#cb264-38" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb264-39"><a href="watershed-segmentation-sensitivity-testing.html#cb264-39" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-226-1.png" width="1008" /></p>
</div>
<div id="mape-volume-irregular" class="section level3 hasAnchor" number="6.5.4">
<h3><span class="header-section-number">6.5.4</span> MAPE Volume irregular<a href="watershed-segmentation-sensitivity-testing.html#mape-volume-irregular" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="watershed-segmentation-sensitivity-testing.html#cb265-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb265-2"><a href="watershed-segmentation-sensitivity-testing.html#cb265-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb265-3"><a href="watershed-segmentation-sensitivity-testing.html#cb265-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb265-4"><a href="watershed-segmentation-sensitivity-testing.html#cb265-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb265-5"><a href="watershed-segmentation-sensitivity-testing.html#cb265-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb265-6"><a href="watershed-segmentation-sensitivity-testing.html#cb265-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb265-7"><a href="watershed-segmentation-sensitivity-testing.html#cb265-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb265-8"><a href="watershed-segmentation-sensitivity-testing.html#cb265-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb265-9"><a href="watershed-segmentation-sensitivity-testing.html#cb265-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb265-10"><a href="watershed-segmentation-sensitivity-testing.html#cb265-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb265-11"><a href="watershed-segmentation-sensitivity-testing.html#cb265-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb265-12"><a href="watershed-segmentation-sensitivity-testing.html#cb265-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb265-13"><a href="watershed-segmentation-sensitivity-testing.html#cb265-13" tabindex="-1"></a>      <span class="co"># , fill = pct_diff_volume_field_mape</span></span>
<span id="cb265-14"><a href="watershed-segmentation-sensitivity-testing.html#cb265-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_diff_volume_field_mape,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb265-15"><a href="watershed-segmentation-sensitivity-testing.html#cb265-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb265-16"><a href="watershed-segmentation-sensitivity-testing.html#cb265-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">alpha =</span> <span class="sc">-</span>pct_diff_volume_field_mape), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">fill =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">4</span>)[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb265-17"><a href="watershed-segmentation-sensitivity-testing.html#cb265-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb265-18"><a href="watershed-segmentation-sensitivity-testing.html#cb265-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb265-19"><a href="watershed-segmentation-sensitivity-testing.html#cb265-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_binned</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.4</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb265-20"><a href="watershed-segmentation-sensitivity-testing.html#cb265-20" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb265-21"><a href="watershed-segmentation-sensitivity-testing.html#cb265-21" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb265-22"><a href="watershed-segmentation-sensitivity-testing.html#cb265-22" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb265-23"><a href="watershed-segmentation-sensitivity-testing.html#cb265-23" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;MAPE field-collected volume versus irregular form prediction volume by parameter setting combination levels&quot;</span></span>
<span id="cb265-24"><a href="watershed-segmentation-sensitivity-testing.html#cb265-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb265-25"><a href="watershed-segmentation-sensitivity-testing.html#cb265-25" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb265-26"><a href="watershed-segmentation-sensitivity-testing.html#cb265-26" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb265-27"><a href="watershed-segmentation-sensitivity-testing.html#cb265-27" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb265-28"><a href="watershed-segmentation-sensitivity-testing.html#cb265-28" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb265-29"><a href="watershed-segmentation-sensitivity-testing.html#cb265-29" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb265-30"><a href="watershed-segmentation-sensitivity-testing.html#cb265-30" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb265-31"><a href="watershed-segmentation-sensitivity-testing.html#cb265-31" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb265-32"><a href="watershed-segmentation-sensitivity-testing.html#cb265-32" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb265-33"><a href="watershed-segmentation-sensitivity-testing.html#cb265-33" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb265-34"><a href="watershed-segmentation-sensitivity-testing.html#cb265-34" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-227-1.png" width="1008" /></p>
</div>
<div id="mape-diameter" class="section level3 hasAnchor" number="6.5.5">
<h3><span class="header-section-number">6.5.5</span> MAPE Diameter<a href="watershed-segmentation-sensitivity-testing.html#mape-diameter" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="watershed-segmentation-sensitivity-testing.html#cb266-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb266-2"><a href="watershed-segmentation-sensitivity-testing.html#cb266-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb266-3"><a href="watershed-segmentation-sensitivity-testing.html#cb266-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb266-4"><a href="watershed-segmentation-sensitivity-testing.html#cb266-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb266-5"><a href="watershed-segmentation-sensitivity-testing.html#cb266-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb266-6"><a href="watershed-segmentation-sensitivity-testing.html#cb266-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb266-7"><a href="watershed-segmentation-sensitivity-testing.html#cb266-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb266-8"><a href="watershed-segmentation-sensitivity-testing.html#cb266-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb266-9"><a href="watershed-segmentation-sensitivity-testing.html#cb266-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb266-10"><a href="watershed-segmentation-sensitivity-testing.html#cb266-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb266-11"><a href="watershed-segmentation-sensitivity-testing.html#cb266-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb266-12"><a href="watershed-segmentation-sensitivity-testing.html#cb266-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb266-13"><a href="watershed-segmentation-sensitivity-testing.html#cb266-13" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_diff_diameter_mape,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb266-14"><a href="watershed-segmentation-sensitivity-testing.html#cb266-14" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb266-15"><a href="watershed-segmentation-sensitivity-testing.html#cb266-15" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">alpha =</span> <span class="sc">-</span>pct_diff_diameter_mape), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">fill =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">4</span>)[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb266-16"><a href="watershed-segmentation-sensitivity-testing.html#cb266-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb266-17"><a href="watershed-segmentation-sensitivity-testing.html#cb266-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb266-18"><a href="watershed-segmentation-sensitivity-testing.html#cb266-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_binned</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.4</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb266-19"><a href="watershed-segmentation-sensitivity-testing.html#cb266-19" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb266-20"><a href="watershed-segmentation-sensitivity-testing.html#cb266-20" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb266-21"><a href="watershed-segmentation-sensitivity-testing.html#cb266-21" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb266-22"><a href="watershed-segmentation-sensitivity-testing.html#cb266-22" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;MAPE field-collected diameter versus prediction diameter by parameter setting combination levels&quot;</span></span>
<span id="cb266-23"><a href="watershed-segmentation-sensitivity-testing.html#cb266-23" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb266-24"><a href="watershed-segmentation-sensitivity-testing.html#cb266-24" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb266-25"><a href="watershed-segmentation-sensitivity-testing.html#cb266-25" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb266-26"><a href="watershed-segmentation-sensitivity-testing.html#cb266-26" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb266-27"><a href="watershed-segmentation-sensitivity-testing.html#cb266-27" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb266-28"><a href="watershed-segmentation-sensitivity-testing.html#cb266-28" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb266-29"><a href="watershed-segmentation-sensitivity-testing.html#cb266-29" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb266-30"><a href="watershed-segmentation-sensitivity-testing.html#cb266-30" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb266-31"><a href="watershed-segmentation-sensitivity-testing.html#cb266-31" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb266-32"><a href="watershed-segmentation-sensitivity-testing.html#cb266-32" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb266-33"><a href="watershed-segmentation-sensitivity-testing.html#cb266-33" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-228-1.png" width="1008" /></p>
</div>
<div id="mape-area" class="section level3 hasAnchor" number="6.5.6">
<h3><span class="header-section-number">6.5.6</span> MAPE Area<a href="watershed-segmentation-sensitivity-testing.html#mape-area" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="watershed-segmentation-sensitivity-testing.html#cb267-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb267-2"><a href="watershed-segmentation-sensitivity-testing.html#cb267-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb267-3"><a href="watershed-segmentation-sensitivity-testing.html#cb267-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb267-4"><a href="watershed-segmentation-sensitivity-testing.html#cb267-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb267-5"><a href="watershed-segmentation-sensitivity-testing.html#cb267-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb267-6"><a href="watershed-segmentation-sensitivity-testing.html#cb267-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb267-7"><a href="watershed-segmentation-sensitivity-testing.html#cb267-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb267-8"><a href="watershed-segmentation-sensitivity-testing.html#cb267-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb267-9"><a href="watershed-segmentation-sensitivity-testing.html#cb267-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb267-10"><a href="watershed-segmentation-sensitivity-testing.html#cb267-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb267-11"><a href="watershed-segmentation-sensitivity-testing.html#cb267-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb267-12"><a href="watershed-segmentation-sensitivity-testing.html#cb267-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb267-13"><a href="watershed-segmentation-sensitivity-testing.html#cb267-13" tabindex="-1"></a>      <span class="co"># , fill = pct_diff_area_field_mape</span></span>
<span id="cb267-14"><a href="watershed-segmentation-sensitivity-testing.html#cb267-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_diff_area_field_mape,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb267-15"><a href="watershed-segmentation-sensitivity-testing.html#cb267-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb267-16"><a href="watershed-segmentation-sensitivity-testing.html#cb267-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">alpha =</span> <span class="sc">-</span>pct_diff_area_field_mape), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">fill =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">4</span>)[<span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb267-17"><a href="watershed-segmentation-sensitivity-testing.html#cb267-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb267-18"><a href="watershed-segmentation-sensitivity-testing.html#cb267-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb267-19"><a href="watershed-segmentation-sensitivity-testing.html#cb267-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_binned</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.4</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb267-20"><a href="watershed-segmentation-sensitivity-testing.html#cb267-20" tabindex="-1"></a>    <span class="co"># ggplot2::scale_fill_distiller(</span></span>
<span id="cb267-21"><a href="watershed-segmentation-sensitivity-testing.html#cb267-21" tabindex="-1"></a>    <span class="co">#   palette = &quot;YlGn&quot;</span></span>
<span id="cb267-22"><a href="watershed-segmentation-sensitivity-testing.html#cb267-22" tabindex="-1"></a>    <span class="co">#   , direction = 1</span></span>
<span id="cb267-23"><a href="watershed-segmentation-sensitivity-testing.html#cb267-23" tabindex="-1"></a>    <span class="co">#   , labels = scales::percent_format(accuracy = 1)</span></span>
<span id="cb267-24"><a href="watershed-segmentation-sensitivity-testing.html#cb267-24" tabindex="-1"></a>    <span class="co">#   , limits = c(0,1)</span></span>
<span id="cb267-25"><a href="watershed-segmentation-sensitivity-testing.html#cb267-25" tabindex="-1"></a>    <span class="co"># ) +</span></span>
<span id="cb267-26"><a href="watershed-segmentation-sensitivity-testing.html#cb267-26" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb267-27"><a href="watershed-segmentation-sensitivity-testing.html#cb267-27" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb267-28"><a href="watershed-segmentation-sensitivity-testing.html#cb267-28" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb267-29"><a href="watershed-segmentation-sensitivity-testing.html#cb267-29" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;MAPE field-collected area versus prediction area by parameter setting combination levels&quot;</span></span>
<span id="cb267-30"><a href="watershed-segmentation-sensitivity-testing.html#cb267-30" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb267-31"><a href="watershed-segmentation-sensitivity-testing.html#cb267-31" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb267-32"><a href="watershed-segmentation-sensitivity-testing.html#cb267-32" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb267-33"><a href="watershed-segmentation-sensitivity-testing.html#cb267-33" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb267-34"><a href="watershed-segmentation-sensitivity-testing.html#cb267-34" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb267-35"><a href="watershed-segmentation-sensitivity-testing.html#cb267-35" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb267-36"><a href="watershed-segmentation-sensitivity-testing.html#cb267-36" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb267-37"><a href="watershed-segmentation-sensitivity-testing.html#cb267-37" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb267-38"><a href="watershed-segmentation-sensitivity-testing.html#cb267-38" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb267-39"><a href="watershed-segmentation-sensitivity-testing.html#cb267-39" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb267-40"><a href="watershed-segmentation-sensitivity-testing.html#cb267-40" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-229-1.png" width="1008" /></p>
</div>
<div id="mape-height" class="section level3 hasAnchor" number="6.5.7">
<h3><span class="header-section-number">6.5.7</span> MAPE Height<a href="watershed-segmentation-sensitivity-testing.html#mape-height" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="watershed-segmentation-sensitivity-testing.html#cb268-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb268-2"><a href="watershed-segmentation-sensitivity-testing.html#cb268-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb268-3"><a href="watershed-segmentation-sensitivity-testing.html#cb268-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb268-4"><a href="watershed-segmentation-sensitivity-testing.html#cb268-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb268-5"><a href="watershed-segmentation-sensitivity-testing.html#cb268-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb268-6"><a href="watershed-segmentation-sensitivity-testing.html#cb268-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb268-7"><a href="watershed-segmentation-sensitivity-testing.html#cb268-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb268-8"><a href="watershed-segmentation-sensitivity-testing.html#cb268-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb268-9"><a href="watershed-segmentation-sensitivity-testing.html#cb268-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb268-10"><a href="watershed-segmentation-sensitivity-testing.html#cb268-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb268-11"><a href="watershed-segmentation-sensitivity-testing.html#cb268-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb268-12"><a href="watershed-segmentation-sensitivity-testing.html#cb268-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb268-13"><a href="watershed-segmentation-sensitivity-testing.html#cb268-13" tabindex="-1"></a>      <span class="co"># , fill = pct_diff_height_mape</span></span>
<span id="cb268-14"><a href="watershed-segmentation-sensitivity-testing.html#cb268-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_diff_height_mape,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb268-15"><a href="watershed-segmentation-sensitivity-testing.html#cb268-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb268-16"><a href="watershed-segmentation-sensitivity-testing.html#cb268-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">alpha =</span> <span class="sc">-</span>pct_diff_height_mape), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">fill =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n=</span><span class="dv">4</span>)[<span class="dv">4</span>]) <span class="sc">+</span></span>
<span id="cb268-17"><a href="watershed-segmentation-sensitivity-testing.html#cb268-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb268-18"><a href="watershed-segmentation-sensitivity-testing.html#cb268-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb268-19"><a href="watershed-segmentation-sensitivity-testing.html#cb268-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_binned</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.4</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb268-20"><a href="watershed-segmentation-sensitivity-testing.html#cb268-20" tabindex="-1"></a>    <span class="co"># ggplot2::scale_fill_distiller(</span></span>
<span id="cb268-21"><a href="watershed-segmentation-sensitivity-testing.html#cb268-21" tabindex="-1"></a>    <span class="co">#   palette = &quot;Reds&quot;</span></span>
<span id="cb268-22"><a href="watershed-segmentation-sensitivity-testing.html#cb268-22" tabindex="-1"></a>    <span class="co">#   , direction = 1</span></span>
<span id="cb268-23"><a href="watershed-segmentation-sensitivity-testing.html#cb268-23" tabindex="-1"></a>    <span class="co">#   , labels = scales::percent_format(accuracy = 1)</span></span>
<span id="cb268-24"><a href="watershed-segmentation-sensitivity-testing.html#cb268-24" tabindex="-1"></a>    <span class="co">#   , limits = c(0,1)</span></span>
<span id="cb268-25"><a href="watershed-segmentation-sensitivity-testing.html#cb268-25" tabindex="-1"></a>    <span class="co"># ) +</span></span>
<span id="cb268-26"><a href="watershed-segmentation-sensitivity-testing.html#cb268-26" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb268-27"><a href="watershed-segmentation-sensitivity-testing.html#cb268-27" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb268-28"><a href="watershed-segmentation-sensitivity-testing.html#cb268-28" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb268-29"><a href="watershed-segmentation-sensitivity-testing.html#cb268-29" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;MAPE field-collected height versus prediction area by parameter setting combination levels&quot;</span></span>
<span id="cb268-30"><a href="watershed-segmentation-sensitivity-testing.html#cb268-30" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb268-31"><a href="watershed-segmentation-sensitivity-testing.html#cb268-31" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb268-32"><a href="watershed-segmentation-sensitivity-testing.html#cb268-32" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb268-33"><a href="watershed-segmentation-sensitivity-testing.html#cb268-33" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb268-34"><a href="watershed-segmentation-sensitivity-testing.html#cb268-34" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb268-35"><a href="watershed-segmentation-sensitivity-testing.html#cb268-35" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb268-36"><a href="watershed-segmentation-sensitivity-testing.html#cb268-36" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb268-37"><a href="watershed-segmentation-sensitivity-testing.html#cb268-37" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb268-38"><a href="watershed-segmentation-sensitivity-testing.html#cb268-38" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb268-39"><a href="watershed-segmentation-sensitivity-testing.html#cb268-39" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb268-40"><a href="watershed-segmentation-sensitivity-testing.html#cb268-40" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-230-1.png" width="1008" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="raster_watershed.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data_fusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
