<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 7 Sensitivity Testing Method | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 7 Sensitivity Testing Method | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 7 Sensitivity Testing Method | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data_fusion.html"/>
<link rel="next" href="chm_sens_test.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script src="libs/. - 1_d2f159-1/data_stars_1b1597e.txt"></script>
<script src="libs/joda-0.0.1/joda.js"></script>
<script src="libs/joda-0.0.1/addImageQuery-bindings.js"></script>
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<link href="libs/study sites-CSS-0.0.1/study sites_home-button.css" rel="stylesheet" />
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#analysis-plan"><i class="fa fa-check"></i><b>1.3</b> Analysis Plan</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="training-data.html"><a href="training-data.html"><i class="fa fa-check"></i><b>2</b> Training Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="training-data.html"><a href="training-data.html#site-introduction"><i class="fa fa-check"></i><b>2.1</b> Site Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="training-data.html"><a href="training-data.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.2</b> Slash Pile Vector Data</a></li>
<li class="chapter" data-level="2.3" data-path="training-data.html"><a href="training-data.html#rgb-orthomosaic"><i class="fa fa-check"></i><b>2.3</b> RGB orthomosaic</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="training-data.html"><a href="training-data.html#example-ratio-based-index"><i class="fa fa-check"></i><b>2.3.1</b> Example ratio-based index</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="training-data.html"><a href="training-data.html#study-area-imagery"><i class="fa fa-check"></i><b>2.4</b> Study area imagery</a></li>
<li class="chapter" data-level="2.5" data-path="training-data.html"><a href="training-data.html#point-cloud-data"><i class="fa fa-check"></i><b>2.5</b> Point Cloud Data</a></li>
<li class="chapter" data-level="2.6" data-path="training-data.html"><a href="training-data.html#check-out-one-pile"><i class="fa fa-check"></i><b>2.6</b> Check out one pile</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="method-evaluation.html"><a href="method-evaluation.html"><i class="fa fa-check"></i><b>3</b> Method Evaluation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="method-evaluation.html"><a href="method-evaluation.html#iou_match"><i class="fa fa-check"></i><b>3.1</b> Instance Matching</a></li>
<li class="chapter" data-level="3.2" data-path="method-evaluation.html"><a href="method-evaluation.html#detect_metrics_form"><i class="fa fa-check"></i><b>3.2</b> Detection Accuracy Metrics</a></li>
<li class="chapter" data-level="3.3" data-path="method-evaluation.html"><a href="method-evaluation.html#quant_metrics_form"><i class="fa fa-check"></i><b>3.3</b> Quantification Accuracy Metrics</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ptcld_process.html"><a href="ptcld_process.html"><i class="fa fa-check"></i><b>4</b> Point Cloud Processing and Pile Segmentation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ptcld_process.html"><a href="ptcld_process.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>4.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ptcld_process.html"><a href="ptcld_process.html#dtm-and-chm-piles"><i class="fa fa-check"></i><b>4.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="raster_watershed.html"><a href="raster_watershed.html"><i class="fa fa-check"></i><b>5</b> Structural Detection from CHM</a>
<ul>
<li class="chapter" data-level="5.1" data-path="raster_watershed.html"><a href="raster_watershed.html#method-demonstration"><i class="fa fa-check"></i><b>5.1</b> Method Demonstration</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-irregularity-filtering"><i class="fa fa-check"></i><b>5.1.1</b> Geometric filtering: Irregularity Filtering</a></li>
<li class="chapter" data-level="5.1.2" data-path="raster_watershed.html"><a href="raster_watershed.html#area-filtering"><i class="fa fa-check"></i><b>5.1.2</b> Area Filtering</a></li>
<li class="chapter" data-level="5.1.3" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-circularity-filtering"><i class="fa fa-check"></i><b>5.1.3</b> Geometric filtering: Circularity Filtering</a></li>
<li class="chapter" data-level="5.1.4" data-path="raster_watershed.html"><a href="raster_watershed.html#area-and-volume-from-chm"><i class="fa fa-check"></i><b>5.1.4</b> Area and Volume from CHM</a></li>
<li class="chapter" data-level="5.1.5" data-path="raster_watershed.html"><a href="raster_watershed.html#shape-refinement"><i class="fa fa-check"></i><b>5.1.5</b> Shape Refinement</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="raster_watershed.html"><a href="raster_watershed.html#instance-matching"><i class="fa fa-check"></i><b>5.2</b> Instance Matching</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="raster_watershed.html"><a href="raster_watershed.html#example-area"><i class="fa fa-check"></i><b>5.2.1</b> Example Area</a></li>
<li class="chapter" data-level="5.2.2" data-path="raster_watershed.html"><a href="raster_watershed.html#full-study-area"><i class="fa fa-check"></i><b>5.2.2</b> Full Study Area</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="raster_watershed.html"><a href="raster_watershed.html#slash_pile_detect_watershed"><i class="fa fa-check"></i><b>5.3</b> Watershed Pile Detection Function</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data_fusion.html"><a href="data_fusion.html"><i class="fa fa-check"></i><b>6</b> Data Fusion</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data_fusion.html"><a href="data_fusion.html#rgb-indices"><i class="fa fa-check"></i><b>6.1</b> RGB Indices</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-functions"><i class="fa fa-check"></i><b>6.1.1</b> Spectral Index Functions</a></li>
<li class="chapter" data-level="6.1.2" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-of-polygons"><i class="fa fa-check"></i><b>6.1.2</b> Spectral Index of Polygons</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data_fusion.html"><a href="data_fusion.html#ground-truth-pile-spectral-summary"><i class="fa fa-check"></i><b>6.2</b> Ground Truth Pile Spectral Summary</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="data_fusion.html"><a href="data_fusion.html#voting-system"><i class="fa fa-check"></i><b>6.2.1</b> Voting System</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="data_fusion.html"><a href="data_fusion.html#polygon_spectral_filtering"><i class="fa fa-check"></i><b>6.3</b> Candidate Polygon Spectral Filtering Function</a></li>
<li class="chapter" data-level="6.4" data-path="data_fusion.html"><a href="data_fusion.html#data-fusion-example"><i class="fa fa-check"></i><b>6.4</b> Data Fusion Example</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="data_fusion.html"><a href="data_fusion.html#instance-matching-1"><i class="fa fa-check"></i><b>6.4.1</b> Instance Matching</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="wshed_params_test.html"><a href="wshed_params_test.html"><i class="fa fa-check"></i><b>7</b> Sensitivity Testing Method</a>
<ul>
<li class="chapter" data-level="7.1" data-path="wshed_params_test.html"><a href="wshed_params_test.html#all_the_combos"><i class="fa fa-check"></i><b>7.1</b> Workflow over parameter combinations</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-workflow"><i class="fa fa-check"></i><b>7.1.1</b> Test Workflow</a></li>
<li class="chapter" data-level="7.1.2" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-instance-matching"><i class="fa fa-check"></i><b>7.1.2</b> Test Instance Matching</a></li>
<li class="chapter" data-level="7.1.3" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-accuracy"><i class="fa fa-check"></i><b>7.1.3</b> Test Accuracy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="chm_sens_test.html"><a href="chm_sens_test.html"><i class="fa fa-check"></i><b>8</b> Sensitivity Testing Results</a>
<ul>
<li class="chapter" data-level="8.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#process-raw-point-cloud-1"><i class="fa fa-check"></i><b>8.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="8.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#structural-only-parameter-testing"><i class="fa fa-check"></i><b>8.2</b> Structural Only: Parameter Testing</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#validation-over-parameter-combinations"><i class="fa fa-check"></i><b>8.2.1</b> Validation over parameter combinations</a></li>
<li class="chapter" data-level="8.2.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#aggregate-validation-metrics-to-parameter-combination"><i class="fa fa-check"></i><b>8.2.2</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion-parameter-testing"><i class="fa fa-check"></i><b>8.3</b> Data Fusion: Parameter Testing</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#aggregate-validation-metrics-to-parameter-combination-1"><i class="fa fa-check"></i><b>8.3.1</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="chm_sens_test.html"><a href="chm_sens_test.html#read-data-for-analysis"><i class="fa fa-check"></i><b>8.4</b> Read Data for Analysis</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#structural-only"><i class="fa fa-check"></i><b>8.4.1</b> Structural Only</a></li>
<li class="chapter" data-level="8.4.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion"><i class="fa fa-check"></i><b>8.4.2</b> Data Fusion</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="chm_sens_test.html"><a href="chm_sens_test.html#allthetests"><i class="fa fa-check"></i><b>8.5</b> Structural Only: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#detect_trends"><i class="fa fa-check"></i><b>8.5.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="8.5.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#quant_trends"><i class="fa fa-check"></i><b>8.5.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="8.5.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#best-settings"><i class="fa fa-check"></i><b>8.5.3</b> Best settings</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion-sensitivity-testing"><i class="fa fa-check"></i><b>8.6</b> Data Fusion: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#main-effects-pile-detection"><i class="fa fa-check"></i><b>8.6.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="8.6.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#main-effects-form-quantification"><i class="fa fa-check"></i><b>8.6.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="8.6.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#balanced_acc_assess"><i class="fa fa-check"></i><b>8.6.3</b> Top settings</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="chm_sens_test.html"><a href="chm_sens_test.html#save-the-data"><i class="fa fa-check"></i><b>8.7</b> save the data</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="stats_method.html"><a href="stats_method.html"><i class="fa fa-check"></i><b>9</b> Statistical Testing of Method Settings</a>
<ul>
<li class="chapter" data-level="9.1" data-path="stats_method.html"><a href="stats_method.html#bayesian-glm---f-score"><i class="fa fa-check"></i><b>9.1</b> Bayesian GLM - F-score</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="stats_method.html"><a href="stats_method.html#model-selection"><i class="fa fa-check"></i><b>9.1.1</b> Model selection</a></li>
<li class="chapter" data-level="9.1.2" data-path="stats_method.html"><a href="stats_method.html#modeling"><i class="fa fa-check"></i><b>9.1.2</b> Modeling</a></li>
<li class="chapter" data-level="9.1.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks"><i class="fa fa-check"></i><b>9.1.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.1.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects"><i class="fa fa-check"></i><b>9.1.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.1.5" data-path="stats_method.html"><a href="stats_method.html#f_score_epred"><i class="fa fa-check"></i><b>9.1.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape"><i class="fa fa-check"></i><b>9.2</b> Bayesian GLM - Diameter MAPE</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-1"><i class="fa fa-check"></i><b>9.2.1</b> Model selection</a></li>
<li class="chapter" data-level="9.2.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape2"><i class="fa fa-check"></i><b>9.2.2</b> Modeling</a></li>
<li class="chapter" data-level="9.2.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-1"><i class="fa fa-check"></i><b>9.2.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.2.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-1"><i class="fa fa-check"></i><b>9.2.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.2.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation"><i class="fa fa-check"></i><b>9.2.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="stats_method.html"><a href="stats_method.html#bayesian-glm---height-mape"><i class="fa fa-check"></i><b>9.3</b> Bayesian GLM - Height MAPE</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-2"><i class="fa fa-check"></i><b>9.3.1</b> Model selection</a></li>
<li class="chapter" data-level="9.3.2" data-path="stats_method.html"><a href="stats_method.html#modeling-1"><i class="fa fa-check"></i><b>9.3.2</b> Modeling</a></li>
<li class="chapter" data-level="9.3.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-2"><i class="fa fa-check"></i><b>9.3.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.3.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-2"><i class="fa fa-check"></i><b>9.3.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.3.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation-1"><i class="fa fa-check"></i><b>9.3.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="stats_method.html"><a href="stats_method.html#hey_balanced_acc"><i class="fa fa-check"></i><b>9.4</b> Balanced Accuracy Bayesian Optimization</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="stats_method.html"><a href="stats_method.html#balanced-accuracy-selection"><i class="fa fa-check"></i><b>9.4.1</b> Balanced Accuracy Selection</a></li>
<li class="chapter" data-level="9.4.2" data-path="stats_method.html"><a href="stats_method.html#overall-across-chm-resolution-2"><i class="fa fa-check"></i><b>9.4.2</b> Overall (across CHM resolution)</a></li>
<li class="chapter" data-level="9.4.3" data-path="stats_method.html"><a href="stats_method.html#by-chm-resolution-2"><i class="fa fa-check"></i><b>9.4.3</b> by CHM resolution</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="stats_method.html"><a href="stats_method.html#training_detect_final"><i class="fa fa-check"></i><b>9.5</b> Balanced Accuracy Validation</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="stats_method.html"><a href="stats_method.html#detection"><i class="fa fa-check"></i><b>9.5.1</b> Detection</a></li>
<li class="chapter" data-level="9.5.2" data-path="stats_method.html"><a href="stats_method.html#instance-match-accuracy-assessment"><i class="fa fa-check"></i><b>9.5.2</b> Instance Match &amp; Accuracy Assessment</a></li>
<li class="chapter" data-level="9.5.3" data-path="stats_method.html"><a href="stats_method.html#training_detect_final_volcomp"><i class="fa fa-check"></i><b>9.5.3</b> Volume Comparison</a></li>
<li class="chapter" data-level="9.5.4" data-path="stats_method.html"><a href="stats_method.html#stand-level-aggregation"><i class="fa fa-check"></i><b>9.5.4</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html"><i class="fa fa-check"></i><b>10</b> Method Validation: Pinyon-Juniper</a>
<ul>
<li class="chapter" data-level="10.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#site-introduction-1"><i class="fa fa-check"></i><b>10.1</b> Site Introduction</a></li>
<li class="chapter" data-level="10.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#data-processing"><i class="fa fa-check"></i><b>10.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#vector-data"><i class="fa fa-check"></i><b>10.2.1</b> Vector Data</a></li>
<li class="chapter" data-level="10.2.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#rgb-data"><i class="fa fa-check"></i><b>10.2.2</b> RGB Data</a></li>
<li class="chapter" data-level="10.2.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#process-raw-point-cloud-2"><i class="fa fa-check"></i><b>10.2.3</b> Process Raw Point Cloud</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#pj_detect_fusion"><i class="fa fa-check"></i><b>10.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#structural-candidate-segments"><i class="fa fa-check"></i><b>10.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="10.3.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#accuracy-of-these-structural-settings"><i class="fa fa-check"></i><b>10.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="10.3.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#spect_filtering_final_pj"><i class="fa fa-check"></i><b>10.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="10.3.4" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#detection-and-quantification-accuracy"><i class="fa fa-check"></i><b>10.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="10.3.5" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#validation_detect_final_volcomp"><i class="fa fa-check"></i><b>10.3.5</b> Volume Comparison</a></li>
<li class="chapter" data-level="10.3.6" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#stand-level-aggregation-1"><i class="fa fa-check"></i><b>10.3.6</b> Stand-level Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#pj_detect_struct"><i class="fa fa-check"></i><b>10.4</b> Pile Detection: Structural Only</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#structural-detection"><i class="fa fa-check"></i><b>10.4.1</b> Structural Detection</a></li>
<li class="chapter" data-level="10.4.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#detection-and-quantification-accuracy-1"><i class="fa fa-check"></i><b>10.4.2</b> Detection and Quantification Accuracy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html"><i class="fa fa-check"></i><b>11</b> Method Validation: BHEF Machine Piles</a>
<ul>
<li class="chapter" data-level="11.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#site-introduction-2"><i class="fa fa-check"></i><b>11.1</b> Site Introduction</a></li>
<li class="chapter" data-level="11.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#data-processing-1"><i class="fa fa-check"></i><b>11.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#rgb-data-1"><i class="fa fa-check"></i><b>11.2.1</b> RGB Data</a></li>
<li class="chapter" data-level="11.2.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#process-raw-point-cloud-3"><i class="fa fa-check"></i><b>11.2.2</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="11.2.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#vector-data-1"><i class="fa fa-check"></i><b>11.2.3</b> Vector Data</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#bhef_detect_fusion"><i class="fa fa-check"></i><b>11.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#structural-candidate-segments-1"><i class="fa fa-check"></i><b>11.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="11.3.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#accuracy-of-these-structural-settings-1"><i class="fa fa-check"></i><b>11.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="11.3.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#spect_filtering_final_bhef"><i class="fa fa-check"></i><b>11.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="11.3.4" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#detection-and-quantification-accuracy-2"><i class="fa fa-check"></i><b>11.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="11.3.5" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#stand-level-aggregation-2"><i class="fa fa-check"></i><b>11.3.5</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html"><i class="fa fa-check"></i><b>12</b> Method Validation: ARNF Machine Piles</a>
<ul>
<li class="chapter" data-level="12.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#site-introduction-3"><i class="fa fa-check"></i><b>12.1</b> Site Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#data-processing-2"><i class="fa fa-check"></i><b>12.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#process-raw-point-cloud-4"><i class="fa fa-check"></i><b>12.2.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="12.2.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#vector-data-2"><i class="fa fa-check"></i><b>12.2.2</b> Vector Data</a></li>
<li class="chapter" data-level="12.2.3" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#rgb-data-2"><i class="fa fa-check"></i><b>12.2.3</b> RGB Data</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#arnf_detect_fusion"><i class="fa fa-check"></i><b>12.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#structural-candidate-segments-2"><i class="fa fa-check"></i><b>12.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="12.3.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#accuracy-of-these-structural-settings-2"><i class="fa fa-check"></i><b>12.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="12.3.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#spect_filtering_final_bhef"><i class="fa fa-check"></i><b>12.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="12.3.4" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#detection-and-quantification-accuracy-3"><i class="fa fa-check"></i><b>12.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="12.3.5" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#stand-level-aggregation-3"><i class="fa fa-check"></i><b>12.3.5</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="validation_summary.html"><a href="validation_summary.html"><i class="fa fa-check"></i><b>13</b> Method Validation: Summary</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="wshed_params_test" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Section 7</span> Sensitivity Testing Method<a href="wshed_params_test.html#wshed_params_test" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this section we introduce a slash pile detection workflow to perform parameter sensitivity testing to obtain a set of point estimates for both the detection and quantification accuracy metrics of the method. In the <a href="chm_sens_test.html#chm_sens_test">next section</a>, we’ll use this workflow with different resolution CHM data as input to generate the data used for analysis to evaluate the method performance.</p>
<p>Parameter sensitivity testing is a systematic process for evaluating how changes to the specific thresholds and settings within the detection methodology impact the final results. Since our method is rules-based and does not use training data, its performance is highly dependent on these manually defined parameters. The objective of this testing is to understand the robustness of the methodology and identify the optimal combination of settings that yields the best detection performance, balancing factors like detection rate (recall), accuracy of positive predictions (precision), and form quantification (e.g., height or diameter MAPE and RMSE).</p>
<p>The primary objective of the sensitivity testing is to obtain a set of point estimates for both the detection and quantification accuracy metrics, which will then serve as the input dataset for subsequent statistical modeling to quantify the influence of parameters and input data on accuracy. Sensitivity testing is performed by repeatedly executing the entire rules-based detection method while systematically varying the values of one or more of its parameters (such as minimum area or maximum height) to generate a range of empirical results. The results of the sensitivity tests are individual point estimates of detection accuracy (F-score) and quantification accuracy (e.g. RMSE and MAPE) for each parameter combination. These sensitivity test results are distinct from the statistical modeling, which does not calculate accuracy itself but instead uses these point estimates as dependent variables to statistically model the functional relationship between the tested detection parameters and the resulting accuracy. This modeling approach will provide insight into the potentially complex interactions between the input data and parameter settings, while allowing us to generalize which parameter combinations optimize the methodology’s performance and to probabilistically quantify parameter influence while accounting for uncertainty.</p>
<p>here are the general steps for sensitivity testing and statistical modeling that we’ll follow:</p>
<ul>
<li><strong>Define Parameter Ranges and Increments</strong>: For each parameter in the rules-based method, determine a reasonable range of values to test and the step size for incrementing through that range. For example, if a threshold is currently 0.5, you might test from 0.3 to 0.7 in increments of 0.05.</li>
<li><strong>Automate the Detection Workflow</strong>: Create a script or automated process that can run the entire rules-based slash pile detection method using different combinations of these parameter values.</li>
<li><strong>Execute Tests</strong>: Run the automated workflow for each defined parameter combination.</li>
<li><strong>Collect Performance Metrics</strong>: For every run, calculate the key performance metrics against the ground truth data (e.g., recall, precision, F-score, and height/diameter MAPE). These calculated metrics will be used as the point estimates for our statistical models.</li>
<li><strong>Statistical Modeling</strong>: Models will be built with the detection and quantification accuracy metrics as the dependent variables. These models will provide insight into the complex relationships between different input data and parameter settings. They will be used to help visualize trends, identify sweet spots where performance is maximized, and understand trade-offs. For example, increasing recall might decrease precision, or one parameter change might be particularly impactful on form quantification accuracy.</li>
<li><strong>Select Optimal Parameters</strong>: Based on the statistical analysis and the specific goals of the project (e.g., maximizing detection accuracy versus maximizing overall accuracy F-score or maximizing form quantification accuracy), select the parameter set that provides the most desirable performance balance.</li>
</ul>
<div id="all_the_combos" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Workflow over parameter combinations<a href="wshed_params_test.html#all_the_combos" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>let’s define parameter ranges and increments for our sensitivity testing and store them in a data frame</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="wshed_params_test.html#cb201-1" tabindex="-1"></a>param_combos_df <span class="ot">&lt;-</span></span>
<span id="cb201-2"><a href="wshed_params_test.html#cb201-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">crossing</span>(</span>
<span id="cb201-3"><a href="wshed_params_test.html#cb201-3" tabindex="-1"></a>    <span class="at">max_ht_m =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2</span>, <span class="at">to =</span>  <span class="dv">5</span>, <span class="at">by =</span> <span class="dv">1</span>) <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb201-4"><a href="wshed_params_test.html#cb201-4" tabindex="-1"></a>    , <span class="at">min_area_m2 =</span> <span class="fu">c</span>(<span class="dv">2</span>) <span class="co"># fixed in workflow defined below so only use one value</span></span>
<span id="cb201-5"><a href="wshed_params_test.html#cb201-5" tabindex="-1"></a>    , <span class="at">max_area_m2 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">10</span>, <span class="at">to =</span> <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">10</span>) <span class="co"># set the max expected pile area</span></span>
<span id="cb201-6"><a href="wshed_params_test.html#cb201-6" tabindex="-1"></a>    , <span class="at">convexity_pct =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.1</span>, <span class="at">to =</span>  <span class="fl">0.9</span>, <span class="at">by =</span> <span class="fl">0.2</span>) <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb201-7"><a href="wshed_params_test.html#cb201-7" tabindex="-1"></a>    , <span class="at">circle_fit_iou_pct =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.1</span>, <span class="at">to =</span> <span class="fl">0.9</span>, <span class="at">by =</span> <span class="fl">0.2</span>) </span>
<span id="cb201-8"><a href="wshed_params_test.html#cb201-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb201-9"><a href="wshed_params_test.html#cb201-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb201-10"><a href="wshed_params_test.html#cb201-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(rn)</span>
<span id="cb201-11"><a href="wshed_params_test.html#cb201-11" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb201-12"><a href="wshed_params_test.html#cb201-12" tabindex="-1"></a>param_combos_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 600
## Columns: 6
## $ rn                 &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, …
## $ max_ht_m           &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ min_area_m2        &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ max_area_m2        &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,…
## $ convexity_pct      &lt;dbl&gt; 0.1, 0.1, 0.1, 0.1, 0.1, 0.3, 0.3, 0.3, 0.3, 0.3, 0…
## $ circle_fit_iou_pct &lt;dbl&gt; 0.1, 0.3, 0.5, 0.7, 0.9, 0.1, 0.3, 0.5, 0.7, 0.9, 0…</code></pre>
<p>to automate the detection workflow we can simply map these combinations over our <code>slash_pile_detect_watershed()</code> function. however, that would result in us running the same watershed segmentation process repeatedly with the same settings. as such, let’s make a function to efficiently perform the detection workflow using the same watershed segmentation and circle fitting for use with the different filtering combinations.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="wshed_params_test.html#cb203-1" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb203-2"><a href="wshed_params_test.html#cb203-2" tabindex="-1"></a><span class="co"># 1)</span></span>
<span id="cb203-3"><a href="wshed_params_test.html#cb203-3" tabindex="-1"></a><span class="co"># function to apply watershed seg over a list of max_ht_m</span></span>
<span id="cb203-4"><a href="wshed_params_test.html#cb203-4" tabindex="-1"></a><span class="co"># function to apply watershed segmentation over a list of different maximum height threshold (`max_ht_m`) which determines the &quot;slice&quot; of the CHM to use</span></span>
<span id="cb203-5"><a href="wshed_params_test.html#cb203-5" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb203-6"><a href="wshed_params_test.html#cb203-6" tabindex="-1"></a>chm_watershed_seg_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(chm_rast,max_ht_m) {</span>
<span id="cb203-7"><a href="wshed_params_test.html#cb203-7" tabindex="-1"></a>  <span class="co"># get unique hts</span></span>
<span id="cb203-8"><a href="wshed_params_test.html#cb203-8" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.numeric</span>(max_ht_m))</span>
<span id="cb203-9"><a href="wshed_params_test.html#cb203-9" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> max_ht_m[<span class="sc">!</span><span class="fu">is.na</span>(max_ht_m)]</span>
<span id="cb203-10"><a href="wshed_params_test.html#cb203-10" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb203-11"><a href="wshed_params_test.html#cb203-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">length</span>(max_ht_m),<span class="dv">0</span>)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb203-12"><a href="wshed_params_test.html#cb203-12" tabindex="-1"></a>  ){<span class="fu">stop</span>(<span class="st">&quot;could not detect `max_ht_m` parameter setting which should be numeric list&quot;</span>)}</span>
<span id="cb203-13"><a href="wshed_params_test.html#cb203-13" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb203-14"><a href="wshed_params_test.html#cb203-14" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb203-15"><a href="wshed_params_test.html#cb203-15" tabindex="-1"></a>  <span class="co"># just get the first layer</span></span>
<span id="cb203-16"><a href="wshed_params_test.html#cb203-16" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>)</span>
<span id="cb203-17"><a href="wshed_params_test.html#cb203-17" tabindex="-1"></a>  <span class="co"># # first, calculate the area of each cell</span></span>
<span id="cb203-18"><a href="wshed_params_test.html#cb203-18" tabindex="-1"></a>  <span class="co"># area_rast &lt;- terra::cellSize(chm_rast)</span></span>
<span id="cb203-19"><a href="wshed_params_test.html#cb203-19" tabindex="-1"></a>  <span class="co"># names(area_rast) &lt;- &quot;area_m2&quot;</span></span>
<span id="cb203-20"><a href="wshed_params_test.html#cb203-20" tabindex="-1"></a>  </span>
<span id="cb203-21"><a href="wshed_params_test.html#cb203-21" tabindex="-1"></a>  <span class="co"># map over the max_ht_m to get the raster slice</span></span>
<span id="cb203-22"><a href="wshed_params_test.html#cb203-22" tabindex="-1"></a>  chm_ret_rast <span class="ot">&lt;-</span> max_ht_m <span class="sc">%&gt;%</span> </span>
<span id="cb203-23"><a href="wshed_params_test.html#cb203-23" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb203-24"><a href="wshed_params_test.html#cb203-24" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">clamp</span>(chm_rast, <span class="at">upper =</span> x, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb203-25"><a href="wshed_params_test.html#cb203-25" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-26"><a href="wshed_params_test.html#cb203-26" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb203-27"><a href="wshed_params_test.html#cb203-27" tabindex="-1"></a>  <span class="co"># name</span></span>
<span id="cb203-28"><a href="wshed_params_test.html#cb203-28" tabindex="-1"></a>  <span class="fu">names</span>(chm_ret_rast) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(max_ht_m)</span>
<span id="cb203-29"><a href="wshed_params_test.html#cb203-29" tabindex="-1"></a>  </span>
<span id="cb203-30"><a href="wshed_params_test.html#cb203-30" tabindex="-1"></a>  <span class="co"># chm_ret_rast</span></span>
<span id="cb203-31"><a href="wshed_params_test.html#cb203-31" tabindex="-1"></a>  <span class="co"># chm_ret_rast %&gt;% terra::subset(1) %&gt;% terra::plot()</span></span>
<span id="cb203-32"><a href="wshed_params_test.html#cb203-32" tabindex="-1"></a>  <span class="co"># chm_ret_rast %&gt;% terra::subset(2) %&gt;% terra::plot()</span></span>
<span id="cb203-33"><a href="wshed_params_test.html#cb203-33" tabindex="-1"></a>  <span class="co"># chm_rast[[1]]</span></span>
<span id="cb203-34"><a href="wshed_params_test.html#cb203-34" tabindex="-1"></a>  </span>
<span id="cb203-35"><a href="wshed_params_test.html#cb203-35" tabindex="-1"></a>  <span class="co"># # map over the volume</span></span>
<span id="cb203-36"><a href="wshed_params_test.html#cb203-36" tabindex="-1"></a>  <span class="co"># # then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb203-37"><a href="wshed_params_test.html#cb203-37" tabindex="-1"></a>  <span class="co"># vol_ret_rast &lt;- </span></span>
<span id="cb203-38"><a href="wshed_params_test.html#cb203-38" tabindex="-1"></a>  <span class="co">#   1:terra::nlyr(chm_ret_rast) %&gt;% </span></span>
<span id="cb203-39"><a href="wshed_params_test.html#cb203-39" tabindex="-1"></a>  <span class="co">#   purrr::map(function(x){</span></span>
<span id="cb203-40"><a href="wshed_params_test.html#cb203-40" tabindex="-1"></a>  <span class="co">#     vol_rast &lt;- area_rast*chm_ret_rast[[x]]</span></span>
<span id="cb203-41"><a href="wshed_params_test.html#cb203-41" tabindex="-1"></a>  <span class="co">#     names(vol_rast) &lt;- &quot;volume_m3&quot;</span></span>
<span id="cb203-42"><a href="wshed_params_test.html#cb203-42" tabindex="-1"></a>  <span class="co">#     return(vol_rast)</span></span>
<span id="cb203-43"><a href="wshed_params_test.html#cb203-43" tabindex="-1"></a>  <span class="co">#   }) %&gt;% </span></span>
<span id="cb203-44"><a href="wshed_params_test.html#cb203-44" tabindex="-1"></a>  <span class="co">#   terra::rast()</span></span>
<span id="cb203-45"><a href="wshed_params_test.html#cb203-45" tabindex="-1"></a>  <span class="co"># # name</span></span>
<span id="cb203-46"><a href="wshed_params_test.html#cb203-46" tabindex="-1"></a>  <span class="co"># names(vol_ret_rast) &lt;- as.character(max_ht_m)</span></span>
<span id="cb203-47"><a href="wshed_params_test.html#cb203-47" tabindex="-1"></a>  </span>
<span id="cb203-48"><a href="wshed_params_test.html#cb203-48" tabindex="-1"></a>  <span class="co"># map over the watershed</span></span>
<span id="cb203-49"><a href="wshed_params_test.html#cb203-49" tabindex="-1"></a>  <span class="co"># let&#39;s run watershed segmentation using `lidR::watershed()` which is based on the bioconductor package `EBIimage`</span></span>
<span id="cb203-50"><a href="wshed_params_test.html#cb203-50" tabindex="-1"></a>  <span class="co"># return is a raster with the first layer representing the identified watershed segments</span></span>
<span id="cb203-51"><a href="wshed_params_test.html#cb203-51" tabindex="-1"></a>  ret_rast <span class="ot">&lt;-</span> </span>
<span id="cb203-52"><a href="wshed_params_test.html#cb203-52" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(chm_ret_rast) <span class="sc">%&gt;%</span> </span>
<span id="cb203-53"><a href="wshed_params_test.html#cb203-53" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb203-54"><a href="wshed_params_test.html#cb203-54" tabindex="-1"></a>      lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb203-55"><a href="wshed_params_test.html#cb203-55" tabindex="-1"></a>        <span class="at">chm =</span> chm_ret_rast[[x]]</span>
<span id="cb203-56"><a href="wshed_params_test.html#cb203-56" tabindex="-1"></a>        , <span class="at">th_tree =</span> <span class="fl">0.1</span></span>
<span id="cb203-57"><a href="wshed_params_test.html#cb203-57" tabindex="-1"></a>      )()</span>
<span id="cb203-58"><a href="wshed_params_test.html#cb203-58" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-59"><a href="wshed_params_test.html#cb203-59" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb203-60"><a href="wshed_params_test.html#cb203-60" tabindex="-1"></a>  <span class="co"># name</span></span>
<span id="cb203-61"><a href="wshed_params_test.html#cb203-61" tabindex="-1"></a>  <span class="fu">names</span>(ret_rast) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(max_ht_m)</span>
<span id="cb203-62"><a href="wshed_params_test.html#cb203-62" tabindex="-1"></a>  </span>
<span id="cb203-63"><a href="wshed_params_test.html#cb203-63" tabindex="-1"></a>  <span class="co"># ret_rast</span></span>
<span id="cb203-64"><a href="wshed_params_test.html#cb203-64" tabindex="-1"></a>  <span class="co"># ret_rast %&gt;% terra::subset(1) %&gt;% terra::as.factor() %&gt;% terra::plot()</span></span>
<span id="cb203-65"><a href="wshed_params_test.html#cb203-65" tabindex="-1"></a>  <span class="co"># ret_rast %&gt;% terra::subset(2) %&gt;% terra::as.factor() %&gt;% terra::plot()</span></span>
<span id="cb203-66"><a href="wshed_params_test.html#cb203-66" tabindex="-1"></a>  </span>
<span id="cb203-67"><a href="wshed_params_test.html#cb203-67" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb203-68"><a href="wshed_params_test.html#cb203-68" tabindex="-1"></a>    <span class="at">chm_rast =</span> chm_ret_rast <span class="co"># length = length(max_ht_m)</span></span>
<span id="cb203-69"><a href="wshed_params_test.html#cb203-69" tabindex="-1"></a>    <span class="co"># , area_rast = area_rast # length = 1</span></span>
<span id="cb203-70"><a href="wshed_params_test.html#cb203-70" tabindex="-1"></a>    <span class="co"># , volume_rast = vol_ret_rast # length = length(max_ht_m)</span></span>
<span id="cb203-71"><a href="wshed_params_test.html#cb203-71" tabindex="-1"></a>    , <span class="at">watershed_rast =</span> ret_rast <span class="co"># length = length(max_ht_m)</span></span>
<span id="cb203-72"><a href="wshed_params_test.html#cb203-72" tabindex="-1"></a>  ))</span>
<span id="cb203-73"><a href="wshed_params_test.html#cb203-73" tabindex="-1"></a>}</span>
<span id="cb203-74"><a href="wshed_params_test.html#cb203-74" tabindex="-1"></a><span class="co"># xxx &lt;- chm_watershed_seg_fn(</span></span>
<span id="cb203-75"><a href="wshed_params_test.html#cb203-75" tabindex="-1"></a><span class="co">#   cloud2raster_ans$chm_rast %&gt;%</span></span>
<span id="cb203-76"><a href="wshed_params_test.html#cb203-76" tabindex="-1"></a><span class="co">#     terra::crop(</span></span>
<span id="cb203-77"><a href="wshed_params_test.html#cb203-77" tabindex="-1"></a><span class="co">#       stand_boundary %&gt;%</span></span>
<span id="cb203-78"><a href="wshed_params_test.html#cb203-78" tabindex="-1"></a><span class="co">#         dplyr::slice(1) %&gt;%</span></span>
<span id="cb203-79"><a href="wshed_params_test.html#cb203-79" tabindex="-1"></a><span class="co">#         sf::st_buffer(-80) %&gt;%</span></span>
<span id="cb203-80"><a href="wshed_params_test.html#cb203-80" tabindex="-1"></a><span class="co">#         sf::st_transform(terra::crs(cloud2raster_ans$chm_rast)) %&gt;%</span></span>
<span id="cb203-81"><a href="wshed_params_test.html#cb203-81" tabindex="-1"></a><span class="co">#         terra::vect()</span></span>
<span id="cb203-82"><a href="wshed_params_test.html#cb203-82" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb203-83"><a href="wshed_params_test.html#cb203-83" tabindex="-1"></a><span class="co">#   ,c(4,5)</span></span>
<span id="cb203-84"><a href="wshed_params_test.html#cb203-84" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb203-85"><a href="wshed_params_test.html#cb203-85" tabindex="-1"></a></span>
<span id="cb203-86"><a href="wshed_params_test.html#cb203-86" tabindex="-1"></a><span class="co"># xxx$chm_rast %&gt;% terra::subset( as.character(unique(c(4,5))[1]) ) %&gt;% terra::plot()</span></span>
<span id="cb203-87"><a href="wshed_params_test.html#cb203-87" tabindex="-1"></a><span class="co"># xxx$watershed_rast %&gt;% terra::subset( as.character(unique(c(4,5))[1]) ) %&gt;% terra::as.factor() %&gt;% terra::plot()</span></span>
<span id="cb203-88"><a href="wshed_params_test.html#cb203-88" tabindex="-1"></a><span class="co"># # xxx$volume_rast %&gt;% terra::subset( as.character(unique(c(4,5))[1]) ) %&gt;% terra::plot()</span></span>
<span id="cb203-89"><a href="wshed_params_test.html#cb203-89" tabindex="-1"></a><span class="co"># # xxx$area_rast[[1]] %&gt;% terra::minmax()</span></span>
<span id="cb203-90"><a href="wshed_params_test.html#cb203-90" tabindex="-1"></a><span class="co"># # xxx$area_rast %&gt;% terra::plot()</span></span>
<span id="cb203-91"><a href="wshed_params_test.html#cb203-91" tabindex="-1"></a></span>
<span id="cb203-92"><a href="wshed_params_test.html#cb203-92" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb203-93"><a href="wshed_params_test.html#cb203-93" tabindex="-1"></a><span class="co"># 2)</span></span>
<span id="cb203-94"><a href="wshed_params_test.html#cb203-94" tabindex="-1"></a><span class="co"># now we need to define a function to apply the filters to the resulting watershed segmented rasters </span></span>
<span id="cb203-95"><a href="wshed_params_test.html#cb203-95" tabindex="-1"></a><span class="co"># based on a data frame of difference combinations of filters for irregularity using the comparison to the convex hull</span></span>
<span id="cb203-96"><a href="wshed_params_test.html#cb203-96" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb203-97"><a href="wshed_params_test.html#cb203-97" tabindex="-1"></a>param_combos_detect_convexity_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb203-98"><a href="wshed_params_test.html#cb203-98" tabindex="-1"></a>  chm_watershed_seg_fn_ans</span>
<span id="cb203-99"><a href="wshed_params_test.html#cb203-99" tabindex="-1"></a>  <span class="do">#### height and area thresholds for the detected piles</span></span>
<span id="cb203-100"><a href="wshed_params_test.html#cb203-100" tabindex="-1"></a>  <span class="co"># these should be based on data from the literature or expectations based on the prescription</span></span>
<span id="cb203-101"><a href="wshed_params_test.html#cb203-101" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span> <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb203-102"><a href="wshed_params_test.html#cb203-102" tabindex="-1"></a>  <span class="do">#### irregularity filtering</span></span>
<span id="cb203-103"><a href="wshed_params_test.html#cb203-103" tabindex="-1"></a>  <span class="co"># 1 = perfectly convex (no inward angles); 0 = so many inward angles</span></span>
<span id="cb203-104"><a href="wshed_params_test.html#cb203-104" tabindex="-1"></a>  <span class="co"># values closer to 1 remove more irregular segments; </span></span>
<span id="cb203-105"><a href="wshed_params_test.html#cb203-105" tabindex="-1"></a>    <span class="co"># values closer to 0 keep more irregular segments (and also regular segments)</span></span>
<span id="cb203-106"><a href="wshed_params_test.html#cb203-106" tabindex="-1"></a>  <span class="co"># these will all be further filtered for their circularity and later smoothed to remove blocky edges</span></span>
<span id="cb203-107"><a href="wshed_params_test.html#cb203-107" tabindex="-1"></a>  <span class="co"># and most inward angles by applying a convex hull to the original detected segment</span></span>
<span id="cb203-108"><a href="wshed_params_test.html#cb203-108" tabindex="-1"></a>  , <span class="at">convexity_pct =</span> <span class="fl">0.7</span> <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb203-109"><a href="wshed_params_test.html#cb203-109" tabindex="-1"></a>) {</span>
<span id="cb203-110"><a href="wshed_params_test.html#cb203-110" tabindex="-1"></a>  <span class="co"># extract individual elements from chm_watershed_seg_fn</span></span>
<span id="cb203-111"><a href="wshed_params_test.html#cb203-111" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb203-112"><a href="wshed_params_test.html#cb203-112" tabindex="-1"></a>  watershed_ans <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>watershed_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb203-113"><a href="wshed_params_test.html#cb203-113" tabindex="-1"></a>  <span class="fu">names</span>(watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb203-114"><a href="wshed_params_test.html#cb203-114" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb203-115"><a href="wshed_params_test.html#cb203-115" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb203-116"><a href="wshed_params_test.html#cb203-116" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(watershed_ans,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`watershed_ans` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb203-117"><a href="wshed_params_test.html#cb203-117" tabindex="-1"></a>  </span>
<span id="cb203-118"><a href="wshed_params_test.html#cb203-118" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-119"><a href="wshed_params_test.html#cb203-119" tabindex="-1"></a>  <span class="do">## convert to polys and area filters</span></span>
<span id="cb203-120"><a href="wshed_params_test.html#cb203-120" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-121"><a href="wshed_params_test.html#cb203-121" tabindex="-1"></a>    <span class="co"># let&#39;s convert the watershed-detected segments from raster to vector data </span></span>
<span id="cb203-122"><a href="wshed_params_test.html#cb203-122" tabindex="-1"></a>    <span class="co"># and create a convex hull of the shapes for comparison</span></span>
<span id="cb203-123"><a href="wshed_params_test.html#cb203-123" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb203-124"><a href="wshed_params_test.html#cb203-124" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb203-125"><a href="wshed_params_test.html#cb203-125" tabindex="-1"></a>      watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb203-126"><a href="wshed_params_test.html#cb203-126" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb203-127"><a href="wshed_params_test.html#cb203-127" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-128"><a href="wshed_params_test.html#cb203-128" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-129"><a href="wshed_params_test.html#cb203-129" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-130"><a href="wshed_params_test.html#cb203-130" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb203-131"><a href="wshed_params_test.html#cb203-131" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb203-132"><a href="wshed_params_test.html#cb203-132" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-133"><a href="wshed_params_test.html#cb203-133" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb203-134"><a href="wshed_params_test.html#cb203-134" tabindex="-1"></a>    </span>
<span id="cb203-135"><a href="wshed_params_test.html#cb203-135" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">&lt;</span><span class="dv">1</span>){</span>
<span id="cb203-136"><a href="wshed_params_test.html#cb203-136" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb203-137"><a href="wshed_params_test.html#cb203-137" tabindex="-1"></a>    }</span>
<span id="cb203-138"><a href="wshed_params_test.html#cb203-138" tabindex="-1"></a>    </span>
<span id="cb203-139"><a href="wshed_params_test.html#cb203-139" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-140"><a href="wshed_params_test.html#cb203-140" tabindex="-1"></a>  <span class="do">## 2) irregularity filtering</span></span>
<span id="cb203-141"><a href="wshed_params_test.html#cb203-141" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-142"><a href="wshed_params_test.html#cb203-142" tabindex="-1"></a>    <span class="co"># let&#39;s first filter out segments that have holes in them </span></span>
<span id="cb203-143"><a href="wshed_params_test.html#cb203-143" tabindex="-1"></a>    <span class="co"># or are very irregularly shaped by comparing the area of the polygon and convex hull</span></span>
<span id="cb203-144"><a href="wshed_params_test.html#cb203-144" tabindex="-1"></a>    <span class="co"># convexity_pct = min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb203-145"><a href="wshed_params_test.html#cb203-145" tabindex="-1"></a>    <span class="cf">if</span>(convexity_pct<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb203-146"><a href="wshed_params_test.html#cb203-146" tabindex="-1"></a>      <span class="co"># apply the irregularity filtering on the polygons</span></span>
<span id="cb203-147"><a href="wshed_params_test.html#cb203-147" tabindex="-1"></a>      watershed_ans_poly <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb203-148"><a href="wshed_params_test.html#cb203-148" tabindex="-1"></a>        <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> convexity_pct)</span>
<span id="cb203-149"><a href="wshed_params_test.html#cb203-149" tabindex="-1"></a>    }</span>
<span id="cb203-150"><a href="wshed_params_test.html#cb203-150" tabindex="-1"></a>    </span>
<span id="cb203-151"><a href="wshed_params_test.html#cb203-151" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb203-152"><a href="wshed_params_test.html#cb203-152" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb203-153"><a href="wshed_params_test.html#cb203-153" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb203-154"><a href="wshed_params_test.html#cb203-154" tabindex="-1"></a>      <span class="fu">return</span>(watershed_ans_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">max_ht_m =</span> max_ht_m, <span class="at">convexity_pct =</span> convexity_pct))</span>
<span id="cb203-155"><a href="wshed_params_test.html#cb203-155" tabindex="-1"></a>    }</span>
<span id="cb203-156"><a href="wshed_params_test.html#cb203-156" tabindex="-1"></a>}</span>
<span id="cb203-157"><a href="wshed_params_test.html#cb203-157" tabindex="-1"></a></span>
<span id="cb203-158"><a href="wshed_params_test.html#cb203-158" tabindex="-1"></a><span class="co"># # just get the unique combinations needed for this param_combos_detect_convexity_fn function</span></span>
<span id="cb203-159"><a href="wshed_params_test.html#cb203-159" tabindex="-1"></a><span class="co"># param_combos_convexity_df &lt;-</span></span>
<span id="cb203-160"><a href="wshed_params_test.html#cb203-160" tabindex="-1"></a><span class="co">#   param_combos_df %&gt;% </span></span>
<span id="cb203-161"><a href="wshed_params_test.html#cb203-161" tabindex="-1"></a><span class="co">#   dplyr::filter(max_ht_m %in% as.numeric(names(xxx$chm_rast))) %&gt;% ## !!!!!!!!!!take this out</span></span>
<span id="cb203-162"><a href="wshed_params_test.html#cb203-162" tabindex="-1"></a><span class="co">#   dplyr::distinct(max_ht_m,convexity_pct)</span></span>
<span id="cb203-163"><a href="wshed_params_test.html#cb203-163" tabindex="-1"></a><span class="co"># # apply this using our data frame to map over the combinations</span></span>
<span id="cb203-164"><a href="wshed_params_test.html#cb203-164" tabindex="-1"></a><span class="co"># </span><span class="al">###</span><span class="co"> takes ~40 mins</span></span>
<span id="cb203-165"><a href="wshed_params_test.html#cb203-165" tabindex="-1"></a><span class="co"># param_combos_detect_convexity_ans &lt;- </span></span>
<span id="cb203-166"><a href="wshed_params_test.html#cb203-166" tabindex="-1"></a><span class="co">#   1:nrow(param_combos_convexity_df) %&gt;% </span></span>
<span id="cb203-167"><a href="wshed_params_test.html#cb203-167" tabindex="-1"></a><span class="co">#   sample(2) %&gt;% </span></span>
<span id="cb203-168"><a href="wshed_params_test.html#cb203-168" tabindex="-1"></a><span class="co">#   purrr::map(\(x)</span></span>
<span id="cb203-169"><a href="wshed_params_test.html#cb203-169" tabindex="-1"></a><span class="co">#     param_combos_detect_convexity_fn(</span></span>
<span id="cb203-170"><a href="wshed_params_test.html#cb203-170" tabindex="-1"></a><span class="co">#         chm_watershed_seg_fn_ans = xxx  ## !!!!!!!!!!change this</span></span>
<span id="cb203-171"><a href="wshed_params_test.html#cb203-171" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_convexity_df$max_ht_m[x]</span></span>
<span id="cb203-172"><a href="wshed_params_test.html#cb203-172" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_convexity_df$convexity_pct[x]</span></span>
<span id="cb203-173"><a href="wshed_params_test.html#cb203-173" tabindex="-1"></a><span class="co">#       )</span></span>
<span id="cb203-174"><a href="wshed_params_test.html#cb203-174" tabindex="-1"></a><span class="co">#     , .progress = T</span></span>
<span id="cb203-175"><a href="wshed_params_test.html#cb203-175" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb203-176"><a href="wshed_params_test.html#cb203-176" tabindex="-1"></a><span class="co">#   dplyr::bind_rows()</span></span>
<span id="cb203-177"><a href="wshed_params_test.html#cb203-177" tabindex="-1"></a><span class="co"># # param_combos_detect_convexity_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-178"><a href="wshed_params_test.html#cb203-178" tabindex="-1"></a><span class="co"># # param_combos_detect_convexity_ans %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(max_ht_m,convexity_pct)</span></span>
<span id="cb203-179"><a href="wshed_params_test.html#cb203-179" tabindex="-1"></a><span class="co"># # param_combos_detect_convexity_ans %&gt;% </span></span>
<span id="cb203-180"><a href="wshed_params_test.html#cb203-180" tabindex="-1"></a><span class="co"># #   dplyr::mutate(area_xxxx = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb203-181"><a href="wshed_params_test.html#cb203-181" tabindex="-1"></a><span class="co"># #   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb203-182"><a href="wshed_params_test.html#cb203-182" tabindex="-1"></a><span class="co"># #   dplyr::group_by(max_ht_m,convexity_pct) %&gt;% </span></span>
<span id="cb203-183"><a href="wshed_params_test.html#cb203-183" tabindex="-1"></a><span class="co"># #   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb203-184"><a href="wshed_params_test.html#cb203-184" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb203-185"><a href="wshed_params_test.html#cb203-185" tabindex="-1"></a><span class="co"># # now just join to filter for area</span></span>
<span id="cb203-186"><a href="wshed_params_test.html#cb203-186" tabindex="-1"></a><span class="co"># # expands to row unique by max_ht_m,convexity_pct,min_area_m2,max_area_m2,pred_id</span></span>
<span id="cb203-187"><a href="wshed_params_test.html#cb203-187" tabindex="-1"></a><span class="co"># param_combos_area &lt;- </span></span>
<span id="cb203-188"><a href="wshed_params_test.html#cb203-188" tabindex="-1"></a><span class="co">#   param_combos_detect_convexity_ans %&gt;% </span></span>
<span id="cb203-189"><a href="wshed_params_test.html#cb203-189" tabindex="-1"></a><span class="co">#   dplyr::mutate(area_xxxx = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb203-190"><a href="wshed_params_test.html#cb203-190" tabindex="-1"></a><span class="co">#   dplyr::inner_join(</span></span>
<span id="cb203-191"><a href="wshed_params_test.html#cb203-191" tabindex="-1"></a><span class="co">#     # add area ranges</span></span>
<span id="cb203-192"><a href="wshed_params_test.html#cb203-192" tabindex="-1"></a><span class="co">#     param_combos_df %&gt;% </span></span>
<span id="cb203-193"><a href="wshed_params_test.html#cb203-193" tabindex="-1"></a><span class="co">#       dplyr::distinct(max_ht_m,convexity_pct,min_area_m2,max_area_m2)</span></span>
<span id="cb203-194"><a href="wshed_params_test.html#cb203-194" tabindex="-1"></a><span class="co">#     , by = dplyr::join_by(</span></span>
<span id="cb203-195"><a href="wshed_params_test.html#cb203-195" tabindex="-1"></a><span class="co">#       max_ht_m, convexity_pct</span></span>
<span id="cb203-196"><a href="wshed_params_test.html#cb203-196" tabindex="-1"></a><span class="co">#       , area_xxxx&gt;=min_area_m2</span></span>
<span id="cb203-197"><a href="wshed_params_test.html#cb203-197" tabindex="-1"></a><span class="co">#       , area_xxxx&lt;=max_area_m2</span></span>
<span id="cb203-198"><a href="wshed_params_test.html#cb203-198" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb203-199"><a href="wshed_params_test.html#cb203-199" tabindex="-1"></a><span class="co">#     , relationship = &quot;many-to-many&quot;</span></span>
<span id="cb203-200"><a href="wshed_params_test.html#cb203-200" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb203-201"><a href="wshed_params_test.html#cb203-201" tabindex="-1"></a><span class="co">#   # dplyr::filter(</span></span>
<span id="cb203-202"><a href="wshed_params_test.html#cb203-202" tabindex="-1"></a><span class="co">#   #   area_xxxx&gt;=min_area_m2</span></span>
<span id="cb203-203"><a href="wshed_params_test.html#cb203-203" tabindex="-1"></a><span class="co">#   #   , area_xxxx&lt;=max_area_m2</span></span>
<span id="cb203-204"><a href="wshed_params_test.html#cb203-204" tabindex="-1"></a><span class="co">#   # )</span></span>
<span id="cb203-205"><a href="wshed_params_test.html#cb203-205" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-206"><a href="wshed_params_test.html#cb203-206" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb203-207"><a href="wshed_params_test.html#cb203-207" tabindex="-1"></a><span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb203-208"><a href="wshed_params_test.html#cb203-208" tabindex="-1"></a><span class="co">#   dplyr::group_by(max_ht_m,convexity_pct,min_area_m2,max_area_m2) %&gt;% </span></span>
<span id="cb203-209"><a href="wshed_params_test.html#cb203-209" tabindex="-1"></a><span class="co">#   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb203-210"><a href="wshed_params_test.html#cb203-210" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb203-211"><a href="wshed_params_test.html#cb203-211" tabindex="-1"></a><span class="co"># # geometries are unique by max_ht_m,pred_id</span></span>
<span id="cb203-212"><a href="wshed_params_test.html#cb203-212" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb203-213"><a href="wshed_params_test.html#cb203-213" tabindex="-1"></a><span class="co">#   dplyr::filter(</span></span>
<span id="cb203-214"><a href="wshed_params_test.html#cb203-214" tabindex="-1"></a><span class="co">#     pred_id == param_combos_area$pred_id[111]</span></span>
<span id="cb203-215"><a href="wshed_params_test.html#cb203-215" tabindex="-1"></a><span class="co">#     , max_ht_m == param_combos_area$max_ht_m[111]</span></span>
<span id="cb203-216"><a href="wshed_params_test.html#cb203-216" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb203-217"><a href="wshed_params_test.html#cb203-217" tabindex="-1"></a><span class="co">#   dplyr::mutate(lab = stringr::str_c(max_ht_m,convexity_pct,min_area_m2,max_area_m2, sep = &quot;:&quot;)) %&gt;% </span></span>
<span id="cb203-218"><a href="wshed_params_test.html#cb203-218" tabindex="-1"></a><span class="co">#   ggplot() + geom_sf(aes(linetype = lab, color = lab),fill=NA) + facet_wrap(facets = dplyr::vars(lab)) + theme_void()</span></span>
<span id="cb203-219"><a href="wshed_params_test.html#cb203-219" tabindex="-1"></a><span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb203-220"><a href="wshed_params_test.html#cb203-220" tabindex="-1"></a><span class="co">#   dplyr::group_by(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb203-221"><a href="wshed_params_test.html#cb203-221" tabindex="-1"></a><span class="co">#   dplyr::filter(dplyr::row_number()==1) %&gt;%</span></span>
<span id="cb203-222"><a href="wshed_params_test.html#cb203-222" tabindex="-1"></a><span class="co">#   dplyr::select(max_ht_m,pred_id) %&gt;% </span></span>
<span id="cb203-223"><a href="wshed_params_test.html#cb203-223" tabindex="-1"></a><span class="co">#   dplyr::ungroup() %&gt;% </span></span>
<span id="cb203-224"><a href="wshed_params_test.html#cb203-224" tabindex="-1"></a><span class="co">#   # dplyr::glimpse()</span></span>
<span id="cb203-225"><a href="wshed_params_test.html#cb203-225" tabindex="-1"></a><span class="co">#   ggplot() + geom_sf(aes(color = factor(max_ht_m)),fill=NA) + facet_wrap(facets = dplyr::vars(max_ht_m))</span></span>
<span id="cb203-226"><a href="wshed_params_test.html#cb203-226" tabindex="-1"></a></span>
<span id="cb203-227"><a href="wshed_params_test.html#cb203-227" tabindex="-1"></a><span class="co"># unique_geometries_cf &lt;- sf_data_circle_fit(</span></span>
<span id="cb203-228"><a href="wshed_params_test.html#cb203-228" tabindex="-1"></a><span class="co">#   param_combos_area %&gt;% </span></span>
<span id="cb203-229"><a href="wshed_params_test.html#cb203-229" tabindex="-1"></a><span class="co">#   dplyr::group_by(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb203-230"><a href="wshed_params_test.html#cb203-230" tabindex="-1"></a><span class="co">#   dplyr::filter(dplyr::row_number()==1) %&gt;%</span></span>
<span id="cb203-231"><a href="wshed_params_test.html#cb203-231" tabindex="-1"></a><span class="co">#   dplyr::select(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb203-232"><a href="wshed_params_test.html#cb203-232" tabindex="-1"></a><span class="co">#   dplyr::ungroup()</span></span>
<span id="cb203-233"><a href="wshed_params_test.html#cb203-233" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb203-234"><a href="wshed_params_test.html#cb203-234" tabindex="-1"></a><span class="co"># unique_geometries_cf %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-235"><a href="wshed_params_test.html#cb203-235" tabindex="-1"></a></span>
<span id="cb203-236"><a href="wshed_params_test.html#cb203-236" tabindex="-1"></a><span class="co"># function to smooth</span></span>
<span id="cb203-237"><a href="wshed_params_test.html#cb203-237" tabindex="-1"></a>raster_smooth_smoother <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb203-238"><a href="wshed_params_test.html#cb203-238" tabindex="-1"></a>  chm_watershed_seg_fn_ans</span>
<span id="cb203-239"><a href="wshed_params_test.html#cb203-239" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span></span>
<span id="cb203-240"><a href="wshed_params_test.html#cb203-240" tabindex="-1"></a>  , watershed_ans_poly</span>
<span id="cb203-241"><a href="wshed_params_test.html#cb203-241" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="dv">2</span></span>
<span id="cb203-242"><a href="wshed_params_test.html#cb203-242" tabindex="-1"></a>) {</span>
<span id="cb203-243"><a href="wshed_params_test.html#cb203-243" tabindex="-1"></a>  min_ht_m <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="do">## !!!!!!!!!!!!!!!! fixed for testing</span></span>
<span id="cb203-244"><a href="wshed_params_test.html#cb203-244" tabindex="-1"></a>  <span class="co"># extract individual elements from chm_watershed_seg_fn</span></span>
<span id="cb203-245"><a href="wshed_params_test.html#cb203-245" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb203-246"><a href="wshed_params_test.html#cb203-246" tabindex="-1"></a>  watershed_ans <span class="ot">&lt;-</span> chm_watershed_seg_fn_ans<span class="sc">$</span>watershed_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb203-247"><a href="wshed_params_test.html#cb203-247" tabindex="-1"></a>  <span class="fu">names</span>(watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb203-248"><a href="wshed_params_test.html#cb203-248" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb203-249"><a href="wshed_params_test.html#cb203-249" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb203-250"><a href="wshed_params_test.html#cb203-250" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(watershed_ans,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`watershed_ans` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb203-251"><a href="wshed_params_test.html#cb203-251" tabindex="-1"></a>  </span>
<span id="cb203-252"><a href="wshed_params_test.html#cb203-252" tabindex="-1"></a>  chm_res <span class="ot">&lt;-</span> <span class="fu">max</span>(terra<span class="sc">::</span><span class="fu">res</span>(chm_rast)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">na.rm =</span> T)</span>
<span id="cb203-253"><a href="wshed_params_test.html#cb203-253" tabindex="-1"></a>  </span>
<span id="cb203-254"><a href="wshed_params_test.html#cb203-254" tabindex="-1"></a>  ws_for_smooth <span class="ot">&lt;-</span> <span class="fu">ws_for_smooth_fn</span>(<span class="at">chm_res =</span> chm_res, <span class="at">min_area_m2 =</span> min_area_m2) <span class="co"># 3 # needs to be the same for the watershed seg and CHM smooth</span></span>
<span id="cb203-255"><a href="wshed_params_test.html#cb203-255" tabindex="-1"></a>  <span class="co"># search_area = (res^2) * (ws^2)</span></span>
<span id="cb203-256"><a href="wshed_params_test.html#cb203-256" tabindex="-1"></a>  </span>
<span id="cb203-257"><a href="wshed_params_test.html#cb203-257" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-258"><a href="wshed_params_test.html#cb203-258" tabindex="-1"></a>  <span class="do">## 5) raster smoothing</span></span>
<span id="cb203-259"><a href="wshed_params_test.html#cb203-259" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-260"><a href="wshed_params_test.html#cb203-260" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb203-261"><a href="wshed_params_test.html#cb203-261" tabindex="-1"></a>    <span class="co"># use the remaining segments that meet the geometric and area filtering</span></span>
<span id="cb203-262"><a href="wshed_params_test.html#cb203-262" tabindex="-1"></a>    <span class="co"># to smooth the watershed raster</span></span>
<span id="cb203-263"><a href="wshed_params_test.html#cb203-263" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb203-264"><a href="wshed_params_test.html#cb203-264" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb203-265"><a href="wshed_params_test.html#cb203-265" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb203-266"><a href="wshed_params_test.html#cb203-266" tabindex="-1"></a>        watershed_ans_poly <span class="sc">%&gt;%</span> <span class="co">#these are irregularity and area filtered already</span></span>
<span id="cb203-267"><a href="wshed_params_test.html#cb203-267" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb203-268"><a href="wshed_params_test.html#cb203-268" tabindex="-1"></a>        , <span class="at">updatevalue=</span><span class="cn">NA</span></span>
<span id="cb203-269"><a href="wshed_params_test.html#cb203-269" tabindex="-1"></a>      )</span>
<span id="cb203-270"><a href="wshed_params_test.html#cb203-270" tabindex="-1"></a>  </span>
<span id="cb203-271"><a href="wshed_params_test.html#cb203-271" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb203-272"><a href="wshed_params_test.html#cb203-272" tabindex="-1"></a>      <span class="co"># smooths the raster using the majority value</span></span>
<span id="cb203-273"><a href="wshed_params_test.html#cb203-273" tabindex="-1"></a>      smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb203-274"><a href="wshed_params_test.html#cb203-274" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;modal&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co"># only fill NA cells  </span></span>
<span id="cb203-275"><a href="wshed_params_test.html#cb203-275" tabindex="-1"></a>    }</span>
<span id="cb203-276"><a href="wshed_params_test.html#cb203-276" tabindex="-1"></a></span>
<span id="cb203-277"><a href="wshed_params_test.html#cb203-277" tabindex="-1"></a>    <span class="fu">names</span>(smooth_watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb203-278"><a href="wshed_params_test.html#cb203-278" tabindex="-1"></a></span>
<span id="cb203-279"><a href="wshed_params_test.html#cb203-279" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb203-280"><a href="wshed_params_test.html#cb203-280" tabindex="-1"></a>    <span class="co"># mask the chm rast to these remaining segments and smooth to match the smoothing for the segments</span></span>
<span id="cb203-281"><a href="wshed_params_test.html#cb203-281" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb203-282"><a href="wshed_params_test.html#cb203-282" tabindex="-1"></a>    smooth_chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb203-283"><a href="wshed_params_test.html#cb203-283" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_watershed_ans)</span>
<span id="cb203-284"><a href="wshed_params_test.html#cb203-284" tabindex="-1"></a>    </span>
<span id="cb203-285"><a href="wshed_params_test.html#cb203-285" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb203-286"><a href="wshed_params_test.html#cb203-286" tabindex="-1"></a>      <span class="co"># smooths the raster to match the smoothing in the watershed segments</span></span>
<span id="cb203-287"><a href="wshed_params_test.html#cb203-287" tabindex="-1"></a>      smooth_chm_rast <span class="ot">&lt;-</span> smooth_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb203-288"><a href="wshed_params_test.html#cb203-288" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co">#only for cells that are NA</span></span>
<span id="cb203-289"><a href="wshed_params_test.html#cb203-289" tabindex="-1"></a>    }</span>
<span id="cb203-290"><a href="wshed_params_test.html#cb203-290" tabindex="-1"></a></span>
<span id="cb203-291"><a href="wshed_params_test.html#cb203-291" tabindex="-1"></a>    <span class="co"># now mask the watershed_ans raster to only keep cells that are in the originating CHM</span></span>
<span id="cb203-292"><a href="wshed_params_test.html#cb203-292" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb203-293"><a href="wshed_params_test.html#cb203-293" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_chm_rast)</span>
<span id="cb203-294"><a href="wshed_params_test.html#cb203-294" tabindex="-1"></a></span>
<span id="cb203-295"><a href="wshed_params_test.html#cb203-295" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-296"><a href="wshed_params_test.html#cb203-296" tabindex="-1"></a>  <span class="do">## calculate raster-based area and volume </span></span>
<span id="cb203-297"><a href="wshed_params_test.html#cb203-297" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-298"><a href="wshed_params_test.html#cb203-298" tabindex="-1"></a>    <span class="co"># first, calculate the area of each cell</span></span>
<span id="cb203-299"><a href="wshed_params_test.html#cb203-299" tabindex="-1"></a>    area_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(smooth_chm_rast)</span>
<span id="cb203-300"><a href="wshed_params_test.html#cb203-300" tabindex="-1"></a>    <span class="fu">names</span>(area_rast) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb203-301"><a href="wshed_params_test.html#cb203-301" tabindex="-1"></a>    <span class="co"># area_rast %&gt;% terra::plot()</span></span>
<span id="cb203-302"><a href="wshed_params_test.html#cb203-302" tabindex="-1"></a>    <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb203-303"><a href="wshed_params_test.html#cb203-303" tabindex="-1"></a>    vol_rast <span class="ot">&lt;-</span> area_rast<span class="sc">*</span>smooth_chm_rast</span>
<span id="cb203-304"><a href="wshed_params_test.html#cb203-304" tabindex="-1"></a>    <span class="fu">names</span>(vol_rast) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb203-305"><a href="wshed_params_test.html#cb203-305" tabindex="-1"></a>    <span class="co"># vol_rast %&gt;% terra::plot()</span></span>
<span id="cb203-306"><a href="wshed_params_test.html#cb203-306" tabindex="-1"></a>    <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb203-307"><a href="wshed_params_test.html#cb203-307" tabindex="-1"></a>    area_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> area_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb203-308"><a href="wshed_params_test.html#cb203-308" tabindex="-1"></a>    <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb203-309"><a href="wshed_params_test.html#cb203-309" tabindex="-1"></a>    vol_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> vol_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb203-310"><a href="wshed_params_test.html#cb203-310" tabindex="-1"></a>    <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb203-311"><a href="wshed_params_test.html#cb203-311" tabindex="-1"></a>    ht_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> smooth_chm_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb203-312"><a href="wshed_params_test.html#cb203-312" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">max_height_m=</span><span class="dv">2</span>)</span>
<span id="cb203-313"><a href="wshed_params_test.html#cb203-313" tabindex="-1"></a>      </span>
<span id="cb203-314"><a href="wshed_params_test.html#cb203-314" tabindex="-1"></a>    <span class="co"># let&#39;s convert the smoothed and filtered watershed-detected segments from raster to vector data </span></span>
<span id="cb203-315"><a href="wshed_params_test.html#cb203-315" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb203-316"><a href="wshed_params_test.html#cb203-316" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb203-317"><a href="wshed_params_test.html#cb203-317" tabindex="-1"></a>      smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb203-318"><a href="wshed_params_test.html#cb203-318" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb203-319"><a href="wshed_params_test.html#cb203-319" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-320"><a href="wshed_params_test.html#cb203-320" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-321"><a href="wshed_params_test.html#cb203-321" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-322"><a href="wshed_params_test.html#cb203-322" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb203-323"><a href="wshed_params_test.html#cb203-323" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb203-324"><a href="wshed_params_test.html#cb203-324" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-325"><a href="wshed_params_test.html#cb203-325" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb203-326"><a href="wshed_params_test.html#cb203-326" tabindex="-1"></a></span>
<span id="cb203-327"><a href="wshed_params_test.html#cb203-327" tabindex="-1"></a>    <span class="co"># add area and volume to our vector data  </span></span>
<span id="cb203-328"><a href="wshed_params_test.html#cb203-328" tabindex="-1"></a>    <span class="co"># we&#39;ll do this with a slick trick to perform multiple joins succinctly using purrr::reduce</span></span>
<span id="cb203-329"><a href="wshed_params_test.html#cb203-329" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb203-330"><a href="wshed_params_test.html#cb203-330" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">reduce</span>(</span>
<span id="cb203-331"><a href="wshed_params_test.html#cb203-331" tabindex="-1"></a>        <span class="fu">list</span>(watershed_ans_poly, area_df, vol_df, ht_df)</span>
<span id="cb203-332"><a href="wshed_params_test.html#cb203-332" tabindex="-1"></a>        , dplyr<span class="sc">::</span>left_join</span>
<span id="cb203-333"><a href="wshed_params_test.html#cb203-333" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&#39;pred_id&#39;</span></span>
<span id="cb203-334"><a href="wshed_params_test.html#cb203-334" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-335"><a href="wshed_params_test.html#cb203-335" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb203-336"><a href="wshed_params_test.html#cb203-336" tabindex="-1"></a>        <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb203-337"><a href="wshed_params_test.html#cb203-337" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-338"><a href="wshed_params_test.html#cb203-338" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb203-339"><a href="wshed_params_test.html#cb203-339" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(max_height_m,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_ht_m</span>
<span id="cb203-340"><a href="wshed_params_test.html#cb203-340" tabindex="-1"></a>      )</span>
<span id="cb203-341"><a href="wshed_params_test.html#cb203-341" tabindex="-1"></a>      <span class="co"># # filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb203-342"><a href="wshed_params_test.html#cb203-342" tabindex="-1"></a>      <span class="co"># dplyr::filter(</span></span>
<span id="cb203-343"><a href="wshed_params_test.html#cb203-343" tabindex="-1"></a>      <span class="co">#   dplyr::coalesce(area_m2,0) &gt;= min_area_m2</span></span>
<span id="cb203-344"><a href="wshed_params_test.html#cb203-344" tabindex="-1"></a>      <span class="co">#   &amp; dplyr::coalesce(area_m2,0) &lt;= max_area_m2</span></span>
<span id="cb203-345"><a href="wshed_params_test.html#cb203-345" tabindex="-1"></a>      <span class="co"># ) %&gt;% </span></span>
<span id="cb203-346"><a href="wshed_params_test.html#cb203-346" tabindex="-1"></a>      <span class="co"># # do one more pass of the irregularity filtering</span></span>
<span id="cb203-347"><a href="wshed_params_test.html#cb203-347" tabindex="-1"></a>      <span class="co"># st_irregular_remove(pct_chull_overlap = convexity_pct)</span></span>
<span id="cb203-348"><a href="wshed_params_test.html#cb203-348" tabindex="-1"></a>      </span>
<span id="cb203-349"><a href="wshed_params_test.html#cb203-349" tabindex="-1"></a>      <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb203-350"><a href="wshed_params_test.html#cb203-350" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb203-351"><a href="wshed_params_test.html#cb203-351" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb203-352"><a href="wshed_params_test.html#cb203-352" tabindex="-1"></a>        <span class="fu">return</span>(watershed_ans_poly)</span>
<span id="cb203-353"><a href="wshed_params_test.html#cb203-353" tabindex="-1"></a>      }</span>
<span id="cb203-354"><a href="wshed_params_test.html#cb203-354" tabindex="-1"></a>   </span>
<span id="cb203-355"><a href="wshed_params_test.html#cb203-355" tabindex="-1"></a>}</span>
<span id="cb203-356"><a href="wshed_params_test.html#cb203-356" tabindex="-1"></a></span>
<span id="cb203-357"><a href="wshed_params_test.html#cb203-357" tabindex="-1"></a><span class="co"># function to do the whole thing</span></span>
<span id="cb203-358"><a href="wshed_params_test.html#cb203-358" tabindex="-1"></a>param_combos_piles_detect_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb203-359"><a href="wshed_params_test.html#cb203-359" tabindex="-1"></a>  chm</span>
<span id="cb203-360"><a href="wshed_params_test.html#cb203-360" tabindex="-1"></a>  , param_combos_df</span>
<span id="cb203-361"><a href="wshed_params_test.html#cb203-361" tabindex="-1"></a>  , <span class="at">smooth_segs =</span> T</span>
<span id="cb203-362"><a href="wshed_params_test.html#cb203-362" tabindex="-1"></a>  , <span class="at">ofile =</span> <span class="st">&quot;../data/param_combos_piles.gpkg&quot;</span></span>
<span id="cb203-363"><a href="wshed_params_test.html#cb203-363" tabindex="-1"></a>) {</span>
<span id="cb203-364"><a href="wshed_params_test.html#cb203-364" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-365"><a href="wshed_params_test.html#cb203-365" tabindex="-1"></a>  <span class="do">## 1) chm slice and watershed segmentation</span></span>
<span id="cb203-366"><a href="wshed_params_test.html#cb203-366" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-367"><a href="wshed_params_test.html#cb203-367" tabindex="-1"></a>  <span class="co"># apply chm_watershed_seg_fn</span></span>
<span id="cb203-368"><a href="wshed_params_test.html#cb203-368" tabindex="-1"></a>  <span class="do">### takes ~37 mins</span></span>
<span id="cb203-369"><a href="wshed_params_test.html#cb203-369" tabindex="-1"></a>  chm_watershed_seg_ans <span class="ot">&lt;-</span> <span class="fu">chm_watershed_seg_fn</span>(chm, <span class="at">max_ht_m =</span> <span class="fu">unique</span>(param_combos_df<span class="sc">$</span>max_ht_m))</span>
<span id="cb203-370"><a href="wshed_params_test.html#cb203-370" tabindex="-1"></a>  <span class="co"># # what did we get?</span></span>
<span id="cb203-371"><a href="wshed_params_test.html#cb203-371" tabindex="-1"></a>  <span class="co"># chm_watershed_seg_ans %&gt;% </span></span>
<span id="cb203-372"><a href="wshed_params_test.html#cb203-372" tabindex="-1"></a>  <span class="co">#   terra::subset( as.character(unique(param_combos_df$max_ht_m)[3]) ) %&gt;% </span></span>
<span id="cb203-373"><a href="wshed_params_test.html#cb203-373" tabindex="-1"></a>  <span class="co">#   terra::plot()</span></span>
<span id="cb203-374"><a href="wshed_params_test.html#cb203-374" tabindex="-1"></a>  </span>
<span id="cb203-375"><a href="wshed_params_test.html#cb203-375" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-376"><a href="wshed_params_test.html#cb203-376" tabindex="-1"></a>  <span class="do">## 2) irregularity filter</span></span>
<span id="cb203-377"><a href="wshed_params_test.html#cb203-377" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-378"><a href="wshed_params_test.html#cb203-378" tabindex="-1"></a>  <span class="co"># just get the unique combinations needed for this param_combos_detect_convexity_fn function</span></span>
<span id="cb203-379"><a href="wshed_params_test.html#cb203-379" tabindex="-1"></a>    param_combos_convexity_df <span class="ot">&lt;-</span></span>
<span id="cb203-380"><a href="wshed_params_test.html#cb203-380" tabindex="-1"></a>      param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb203-381"><a href="wshed_params_test.html#cb203-381" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(max_ht_m,convexity_pct)</span>
<span id="cb203-382"><a href="wshed_params_test.html#cb203-382" tabindex="-1"></a>    </span>
<span id="cb203-383"><a href="wshed_params_test.html#cb203-383" tabindex="-1"></a>    <span class="co"># apply this using our data frame to map over the combinations</span></span>
<span id="cb203-384"><a href="wshed_params_test.html#cb203-384" tabindex="-1"></a>    <span class="do">### takes ~40 mins</span></span>
<span id="cb203-385"><a href="wshed_params_test.html#cb203-385" tabindex="-1"></a>    param_combos_detect_convexity_ans <span class="ot">&lt;-</span> </span>
<span id="cb203-386"><a href="wshed_params_test.html#cb203-386" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_combos_convexity_df) <span class="sc">%&gt;%</span> </span>
<span id="cb203-387"><a href="wshed_params_test.html#cb203-387" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb203-388"><a href="wshed_params_test.html#cb203-388" tabindex="-1"></a>        <span class="fu">param_combos_detect_convexity_fn</span>(</span>
<span id="cb203-389"><a href="wshed_params_test.html#cb203-389" tabindex="-1"></a>            <span class="at">chm_watershed_seg_fn_ans =</span> chm_watershed_seg_ans</span>
<span id="cb203-390"><a href="wshed_params_test.html#cb203-390" tabindex="-1"></a>            , <span class="at">max_ht_m =</span> param_combos_convexity_df<span class="sc">$</span>max_ht_m[x]</span>
<span id="cb203-391"><a href="wshed_params_test.html#cb203-391" tabindex="-1"></a>            , <span class="at">convexity_pct =</span> param_combos_convexity_df<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb203-392"><a href="wshed_params_test.html#cb203-392" tabindex="-1"></a>          )</span>
<span id="cb203-393"><a href="wshed_params_test.html#cb203-393" tabindex="-1"></a>        , <span class="at">.progress =</span> <span class="st">&quot;convexity filtering&quot;</span></span>
<span id="cb203-394"><a href="wshed_params_test.html#cb203-394" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-395"><a href="wshed_params_test.html#cb203-395" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb203-396"><a href="wshed_params_test.html#cb203-396" tabindex="-1"></a>    <span class="co"># param_combos_detect_convexity_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-397"><a href="wshed_params_test.html#cb203-397" tabindex="-1"></a>    <span class="co"># param_combos_detect_convexity_ans %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(max_ht_m,convexity_pct)</span></span>
<span id="cb203-398"><a href="wshed_params_test.html#cb203-398" tabindex="-1"></a>    <span class="co"># param_combos_detect_convexity_ans %&gt;% </span></span>
<span id="cb203-399"><a href="wshed_params_test.html#cb203-399" tabindex="-1"></a>    <span class="co">#   dplyr::mutate(area_xxxx = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb203-400"><a href="wshed_params_test.html#cb203-400" tabindex="-1"></a>    <span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb203-401"><a href="wshed_params_test.html#cb203-401" tabindex="-1"></a>    <span class="co">#   dplyr::group_by(max_ht_m,convexity_pct) %&gt;% </span></span>
<span id="cb203-402"><a href="wshed_params_test.html#cb203-402" tabindex="-1"></a>    <span class="co">#   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb203-403"><a href="wshed_params_test.html#cb203-403" tabindex="-1"></a>  </span>
<span id="cb203-404"><a href="wshed_params_test.html#cb203-404" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-405"><a href="wshed_params_test.html#cb203-405" tabindex="-1"></a>  <span class="do">## 3) area filter</span></span>
<span id="cb203-406"><a href="wshed_params_test.html#cb203-406" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-407"><a href="wshed_params_test.html#cb203-407" tabindex="-1"></a>    <span class="co"># now just join to filter for area</span></span>
<span id="cb203-408"><a href="wshed_params_test.html#cb203-408" tabindex="-1"></a>    <span class="co"># expands to row unique by max_ht_m,convexity_pct,min_area_m2,max_area_m2,pred_id</span></span>
<span id="cb203-409"><a href="wshed_params_test.html#cb203-409" tabindex="-1"></a>    param_combos_area <span class="ot">&lt;-</span> </span>
<span id="cb203-410"><a href="wshed_params_test.html#cb203-410" tabindex="-1"></a>      param_combos_detect_convexity_ans <span class="sc">%&gt;%</span> </span>
<span id="cb203-411"><a href="wshed_params_test.html#cb203-411" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb203-412"><a href="wshed_params_test.html#cb203-412" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-413"><a href="wshed_params_test.html#cb203-413" tabindex="-1"></a>        <span class="co"># add area ranges</span></span>
<span id="cb203-414"><a href="wshed_params_test.html#cb203-414" tabindex="-1"></a>        param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb203-415"><a href="wshed_params_test.html#cb203-415" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">distinct</span>(max_ht_m,convexity_pct,min_area_m2,max_area_m2)</span>
<span id="cb203-416"><a href="wshed_params_test.html#cb203-416" tabindex="-1"></a>        , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(</span>
<span id="cb203-417"><a href="wshed_params_test.html#cb203-417" tabindex="-1"></a>          max_ht_m, convexity_pct</span>
<span id="cb203-418"><a href="wshed_params_test.html#cb203-418" tabindex="-1"></a>          , area_xxxx<span class="sc">&gt;=</span>min_area_m2</span>
<span id="cb203-419"><a href="wshed_params_test.html#cb203-419" tabindex="-1"></a>          , area_xxxx<span class="sc">&lt;=</span>max_area_m2</span>
<span id="cb203-420"><a href="wshed_params_test.html#cb203-420" tabindex="-1"></a>        )</span>
<span id="cb203-421"><a href="wshed_params_test.html#cb203-421" tabindex="-1"></a>        , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb203-422"><a href="wshed_params_test.html#cb203-422" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-423"><a href="wshed_params_test.html#cb203-423" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>area_xxxx)</span>
<span id="cb203-424"><a href="wshed_params_test.html#cb203-424" tabindex="-1"></a>      <span class="co"># dplyr::filter(</span></span>
<span id="cb203-425"><a href="wshed_params_test.html#cb203-425" tabindex="-1"></a>      <span class="co">#   area_xxxx&gt;=min_area_m2</span></span>
<span id="cb203-426"><a href="wshed_params_test.html#cb203-426" tabindex="-1"></a>      <span class="co">#   , area_xxxx&lt;=max_area_m2</span></span>
<span id="cb203-427"><a href="wshed_params_test.html#cb203-427" tabindex="-1"></a>      <span class="co"># )</span></span>
<span id="cb203-428"><a href="wshed_params_test.html#cb203-428" tabindex="-1"></a>    </span>
<span id="cb203-429"><a href="wshed_params_test.html#cb203-429" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-430"><a href="wshed_params_test.html#cb203-430" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb203-431"><a href="wshed_params_test.html#cb203-431" tabindex="-1"></a>    <span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb203-432"><a href="wshed_params_test.html#cb203-432" tabindex="-1"></a>    <span class="co">#   dplyr::group_by(max_ht_m,convexity_pct,min_area_m2,max_area_m2) %&gt;% </span></span>
<span id="cb203-433"><a href="wshed_params_test.html#cb203-433" tabindex="-1"></a>    <span class="co">#   dplyr::summarise(dplyr::across(area_xxxx,  list(min = min, max = max), .names = &quot;{.col}.{.fn}&quot;))</span></span>
<span id="cb203-434"><a href="wshed_params_test.html#cb203-434" tabindex="-1"></a>    </span>
<span id="cb203-435"><a href="wshed_params_test.html#cb203-435" tabindex="-1"></a>    <span class="co"># !!!!!!!!!!!!!!!!!!!!!!geometries are unique by max_ht_m,pred_id!!!!!!!!!!!!!!!!!!!!!!</span></span>
<span id="cb203-436"><a href="wshed_params_test.html#cb203-436" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb203-437"><a href="wshed_params_test.html#cb203-437" tabindex="-1"></a>    <span class="co">#   dplyr::filter(</span></span>
<span id="cb203-438"><a href="wshed_params_test.html#cb203-438" tabindex="-1"></a>    <span class="co">#     pred_id == param_combos_area$pred_id[111]</span></span>
<span id="cb203-439"><a href="wshed_params_test.html#cb203-439" tabindex="-1"></a>    <span class="co">#     , max_ht_m == param_combos_area$max_ht_m[111]</span></span>
<span id="cb203-440"><a href="wshed_params_test.html#cb203-440" tabindex="-1"></a>    <span class="co">#   ) %&gt;% </span></span>
<span id="cb203-441"><a href="wshed_params_test.html#cb203-441" tabindex="-1"></a>    <span class="co">#   dplyr::mutate(lab = stringr::str_c(max_ht_m,convexity_pct,min_area_m2,max_area_m2, sep = &quot;:&quot;)) %&gt;% </span></span>
<span id="cb203-442"><a href="wshed_params_test.html#cb203-442" tabindex="-1"></a>    <span class="co">#   ggplot() + geom_sf(aes(linetype = lab, color = lab),fill=NA) + facet_wrap(facets = dplyr::vars(lab)) + theme_void()</span></span>
<span id="cb203-443"><a href="wshed_params_test.html#cb203-443" tabindex="-1"></a>    <span class="co"># param_combos_area %&gt;% </span></span>
<span id="cb203-444"><a href="wshed_params_test.html#cb203-444" tabindex="-1"></a>    <span class="co">#   dplyr::group_by(max_ht_m,pred_id) %&gt;%</span></span>
<span id="cb203-445"><a href="wshed_params_test.html#cb203-445" tabindex="-1"></a>    <span class="co">#   dplyr::filter(dplyr::row_number()==1) %&gt;%</span></span>
<span id="cb203-446"><a href="wshed_params_test.html#cb203-446" tabindex="-1"></a>    <span class="co">#   dplyr::select(max_ht_m,pred_id) %&gt;% </span></span>
<span id="cb203-447"><a href="wshed_params_test.html#cb203-447" tabindex="-1"></a>    <span class="co">#   dplyr::ungroup() %&gt;% </span></span>
<span id="cb203-448"><a href="wshed_params_test.html#cb203-448" tabindex="-1"></a>    <span class="co">#   # dplyr::glimpse()</span></span>
<span id="cb203-449"><a href="wshed_params_test.html#cb203-449" tabindex="-1"></a>    <span class="co">#   ggplot() + geom_sf(aes(color = factor(max_ht_m)),fill=NA) + facet_wrap(facets = dplyr::vars(max_ht_m))</span></span>
<span id="cb203-450"><a href="wshed_params_test.html#cb203-450" tabindex="-1"></a>    </span>
<span id="cb203-451"><a href="wshed_params_test.html#cb203-451" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-452"><a href="wshed_params_test.html#cb203-452" tabindex="-1"></a>  <span class="do">## 4) circle filter</span></span>
<span id="cb203-453"><a href="wshed_params_test.html#cb203-453" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb203-454"><a href="wshed_params_test.html#cb203-454" tabindex="-1"></a>    <span class="co"># !!!!!!!!!!!!!!!!!!!!!!geometries are unique by max_ht_m,pred_id!!!!!!!!!!!!!!!!!!!!!!</span></span>
<span id="cb203-455"><a href="wshed_params_test.html#cb203-455" tabindex="-1"></a>    unique_geometries <span class="ot">&lt;-</span> param_combos_area <span class="sc">%&gt;%</span> </span>
<span id="cb203-456"><a href="wshed_params_test.html#cb203-456" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(max_ht_m,pred_id) <span class="sc">%&gt;%</span></span>
<span id="cb203-457"><a href="wshed_params_test.html#cb203-457" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb203-458"><a href="wshed_params_test.html#cb203-458" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-459"><a href="wshed_params_test.html#cb203-459" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(max_ht_m,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb203-460"><a href="wshed_params_test.html#cb203-460" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">record_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb203-461"><a href="wshed_params_test.html#cb203-461" tabindex="-1"></a>  </span>
<span id="cb203-462"><a href="wshed_params_test.html#cb203-462" tabindex="-1"></a>  <span class="co"># param_combos_detect_convexity_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-463"><a href="wshed_params_test.html#cb203-463" tabindex="-1"></a>  <span class="co"># and we&#39;ll apply the circle fitting to this spatial data</span></span>
<span id="cb203-464"><a href="wshed_params_test.html#cb203-464" tabindex="-1"></a>  <span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb203-465"><a href="wshed_params_test.html#cb203-465" tabindex="-1"></a>  unique_geometries_cf <span class="ot">&lt;-</span> <span class="fu">sf_data_circle_fit</span>(unique_geometries)</span>
<span id="cb203-466"><a href="wshed_params_test.html#cb203-466" tabindex="-1"></a>  <span class="co"># param_combos_detect_cf_ans %&gt;% sf::st_write(&quot;../data/param_combos_detect_cf_ans.gpkg&quot;)</span></span>
<span id="cb203-467"><a href="wshed_params_test.html#cb203-467" tabindex="-1"></a>  <span class="co"># param_combos_detect_cf_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-468"><a href="wshed_params_test.html#cb203-468" tabindex="-1"></a>  <span class="co"># nrow(param_combos_detect_cf_ans)</span></span>
<span id="cb203-469"><a href="wshed_params_test.html#cb203-469" tabindex="-1"></a>  <span class="co"># nrow(param_combos_detect_convexity_ans)</span></span>
<span id="cb203-470"><a href="wshed_params_test.html#cb203-470" tabindex="-1"></a>  </span>
<span id="cb203-471"><a href="wshed_params_test.html#cb203-471" tabindex="-1"></a>  <span class="co"># we&#39;ll use the IoU function we defined </span></span>
<span id="cb203-472"><a href="wshed_params_test.html#cb203-472" tabindex="-1"></a>    <span class="co"># we map over this to only compare the segment to it&#39;s own best circle fit...not all</span></span>
<span id="cb203-473"><a href="wshed_params_test.html#cb203-473" tabindex="-1"></a>    <span class="co"># we should consider doing this in bulk.....another day</span></span>
<span id="cb203-474"><a href="wshed_params_test.html#cb203-474" tabindex="-1"></a>    param_combos_detect_cf_iou <span class="ot">&lt;-</span> </span>
<span id="cb203-475"><a href="wshed_params_test.html#cb203-475" tabindex="-1"></a>      unique_geometries<span class="sc">$</span>record_id <span class="sc">%&gt;%</span> </span>
<span id="cb203-476"><a href="wshed_params_test.html#cb203-476" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb203-477"><a href="wshed_params_test.html#cb203-477" tabindex="-1"></a>        <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb203-478"><a href="wshed_params_test.html#cb203-478" tabindex="-1"></a>          <span class="at">gt_inst =</span> unique_geometries <span class="sc">%&gt;%</span> </span>
<span id="cb203-479"><a href="wshed_params_test.html#cb203-479" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(record_id <span class="sc">==</span> x)</span>
<span id="cb203-480"><a href="wshed_params_test.html#cb203-480" tabindex="-1"></a>          , <span class="at">gt_id =</span> <span class="st">&quot;record_id&quot;</span></span>
<span id="cb203-481"><a href="wshed_params_test.html#cb203-481" tabindex="-1"></a>          , <span class="at">predictions =</span> unique_geometries_cf <span class="sc">%&gt;%</span> </span>
<span id="cb203-482"><a href="wshed_params_test.html#cb203-482" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(record_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb203-483"><a href="wshed_params_test.html#cb203-483" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(record_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb203-484"><a href="wshed_params_test.html#cb203-484" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_record_id =</span> record_id)</span>
<span id="cb203-485"><a href="wshed_params_test.html#cb203-485" tabindex="-1"></a>          , <span class="at">pred_id =</span> <span class="st">&quot;circ_record_id&quot;</span></span>
<span id="cb203-486"><a href="wshed_params_test.html#cb203-486" tabindex="-1"></a>          , <span class="at">min_iou_pct =</span> <span class="dv">0</span> <span class="co"># set to 0 just to return pct</span></span>
<span id="cb203-487"><a href="wshed_params_test.html#cb203-487" tabindex="-1"></a>        )    </span>
<span id="cb203-488"><a href="wshed_params_test.html#cb203-488" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-489"><a href="wshed_params_test.html#cb203-489" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb203-490"><a href="wshed_params_test.html#cb203-490" tabindex="-1"></a>    </span>
<span id="cb203-491"><a href="wshed_params_test.html#cb203-491" tabindex="-1"></a>    <span class="co"># param_combos_detect_cf_iou %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-492"><a href="wshed_params_test.html#cb203-492" tabindex="-1"></a>  </span>
<span id="cb203-493"><a href="wshed_params_test.html#cb203-493" tabindex="-1"></a>  <span class="do">### now we need a function to map over all the different filters for circularity by combination of the other settings</span></span>
<span id="cb203-494"><a href="wshed_params_test.html#cb203-494" tabindex="-1"></a>    <span class="do">### this is going to be highly custom to this particular task :\</span></span>
<span id="cb203-495"><a href="wshed_params_test.html#cb203-495" tabindex="-1"></a>  param_combos_circle_fit <span class="ot">&lt;-</span> </span>
<span id="cb203-496"><a href="wshed_params_test.html#cb203-496" tabindex="-1"></a>    param_combos_area <span class="sc">%&gt;%</span> </span>
<span id="cb203-497"><a href="wshed_params_test.html#cb203-497" tabindex="-1"></a>    <span class="co"># expands row to unique by max_ht_m,min_area_m2,max_area_m2,convexity_pct,circle_fit_iou_pct,pred_id</span></span>
<span id="cb203-498"><a href="wshed_params_test.html#cb203-498" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-499"><a href="wshed_params_test.html#cb203-499" tabindex="-1"></a>      param_combos_df</span>
<span id="cb203-500"><a href="wshed_params_test.html#cb203-500" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(max_ht_m,min_area_m2,max_area_m2,convexity_pct)</span>
<span id="cb203-501"><a href="wshed_params_test.html#cb203-501" tabindex="-1"></a>      , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb203-502"><a href="wshed_params_test.html#cb203-502" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-503"><a href="wshed_params_test.html#cb203-503" tabindex="-1"></a>    <span class="co"># join unique geoms</span></span>
<span id="cb203-504"><a href="wshed_params_test.html#cb203-504" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-505"><a href="wshed_params_test.html#cb203-505" tabindex="-1"></a>      unique_geometries <span class="sc">%&gt;%</span> </span>
<span id="cb203-506"><a href="wshed_params_test.html#cb203-506" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-507"><a href="wshed_params_test.html#cb203-507" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(max_ht_m,pred_id,record_id)</span>
<span id="cb203-508"><a href="wshed_params_test.html#cb203-508" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(max_ht_m,pred_id)</span>
<span id="cb203-509"><a href="wshed_params_test.html#cb203-509" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-510"><a href="wshed_params_test.html#cb203-510" tabindex="-1"></a>    <span class="co"># join circle fits</span></span>
<span id="cb203-511"><a href="wshed_params_test.html#cb203-511" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb203-512"><a href="wshed_params_test.html#cb203-512" tabindex="-1"></a>      param_combos_detect_cf_iou <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(record_id,iou)</span>
<span id="cb203-513"><a href="wshed_params_test.html#cb203-513" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;record_id&quot;</span></span>
<span id="cb203-514"><a href="wshed_params_test.html#cb203-514" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-515"><a href="wshed_params_test.html#cb203-515" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(iou,<span class="dv">0</span>)<span class="sc">&gt;=</span>circle_fit_iou_pct)</span>
<span id="cb203-516"><a href="wshed_params_test.html#cb203-516" tabindex="-1"></a>  <span class="do">############################################################</span></span>
<span id="cb203-517"><a href="wshed_params_test.html#cb203-517" tabindex="-1"></a>  <span class="co"># get unique sets of pred_id by height so we only need to smooth the raster for these sets</span></span>
<span id="cb203-518"><a href="wshed_params_test.html#cb203-518" tabindex="-1"></a>  <span class="do">############################################################</span></span>
<span id="cb203-519"><a href="wshed_params_test.html#cb203-519" tabindex="-1"></a>    rn_geom_lookup <span class="ot">&lt;-</span> param_combos_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb203-520"><a href="wshed_params_test.html#cb203-520" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-521"><a href="wshed_params_test.html#cb203-521" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(rn,max_ht_m,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb203-522"><a href="wshed_params_test.html#cb203-522" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(rn,max_ht_m) <span class="sc">%&gt;%</span> </span>
<span id="cb203-523"><a href="wshed_params_test.html#cb203-523" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">preds =</span> <span class="fu">paste</span>(<span class="fu">sort</span>(pred_id), <span class="at">collapse =</span> <span class="st">&quot;_&quot;</span>),<span class="at">n=</span>dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb203-524"><a href="wshed_params_test.html#cb203-524" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-525"><a href="wshed_params_test.html#cb203-525" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(max_ht_m,<span class="fu">desc</span>(n))</span>
<span id="cb203-526"><a href="wshed_params_test.html#cb203-526" tabindex="-1"></a></span>
<span id="cb203-527"><a href="wshed_params_test.html#cb203-527" tabindex="-1"></a>    <span class="co"># now just get the unique sets by max_ht_m</span></span>
<span id="cb203-528"><a href="wshed_params_test.html#cb203-528" tabindex="-1"></a>    rn_geom_lookup <span class="ot">&lt;-</span> rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb203-529"><a href="wshed_params_test.html#cb203-529" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-530"><a href="wshed_params_test.html#cb203-530" tabindex="-1"></a>        rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb203-531"><a href="wshed_params_test.html#cb203-531" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">distinct</span>(max_ht_m,preds) <span class="sc">%&gt;%</span> </span>
<span id="cb203-532"><a href="wshed_params_test.html#cb203-532" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">set_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb203-533"><a href="wshed_params_test.html#cb203-533" tabindex="-1"></a>        , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(max_ht_m,preds)</span>
<span id="cb203-534"><a href="wshed_params_test.html#cb203-534" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-535"><a href="wshed_params_test.html#cb203-535" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(set_id,rn,max_ht_m)</span>
<span id="cb203-536"><a href="wshed_params_test.html#cb203-536" tabindex="-1"></a>    <span class="co"># rn_geom_lookup %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-537"><a href="wshed_params_test.html#cb203-537" tabindex="-1"></a>    <span class="co"># now just get the unique max_ht_m and actual geoms</span></span>
<span id="cb203-538"><a href="wshed_params_test.html#cb203-538" tabindex="-1"></a>    geom_sets <span class="ot">&lt;-</span></span>
<span id="cb203-539"><a href="wshed_params_test.html#cb203-539" tabindex="-1"></a>      param_combos_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb203-540"><a href="wshed_params_test.html#cb203-540" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(rn,max_ht_m,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb203-541"><a href="wshed_params_test.html#cb203-541" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-542"><a href="wshed_params_test.html#cb203-542" tabindex="-1"></a>          rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb203-543"><a href="wshed_params_test.html#cb203-543" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">group_by</span>(set_id) <span class="sc">%&gt;%</span> </span>
<span id="cb203-544"><a href="wshed_params_test.html#cb203-544" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb203-545"><a href="wshed_params_test.html#cb203-545" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-546"><a href="wshed_params_test.html#cb203-546" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb203-547"><a href="wshed_params_test.html#cb203-547" tabindex="-1"></a>          , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn)</span>
<span id="cb203-548"><a href="wshed_params_test.html#cb203-548" tabindex="-1"></a>        )</span>
<span id="cb203-549"><a href="wshed_params_test.html#cb203-549" tabindex="-1"></a>        <span class="co"># dplyr::relocate(set_id) %&gt;% </span></span>
<span id="cb203-550"><a href="wshed_params_test.html#cb203-550" tabindex="-1"></a>        <span class="co"># dplyr::arrange(set_id,pred_id) %&gt;% </span></span>
<span id="cb203-551"><a href="wshed_params_test.html#cb203-551" tabindex="-1"></a>        <span class="co"># dplyr::glimpse()</span></span>
<span id="cb203-552"><a href="wshed_params_test.html#cb203-552" tabindex="-1"></a>    <span class="do">######## </span></span>
<span id="cb203-553"><a href="wshed_params_test.html#cb203-553" tabindex="-1"></a>  </span>
<span id="cb203-554"><a href="wshed_params_test.html#cb203-554" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-555"><a href="wshed_params_test.html#cb203-555" tabindex="-1"></a>    <span class="do">## 6) raster smooth</span></span>
<span id="cb203-556"><a href="wshed_params_test.html#cb203-556" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-557"><a href="wshed_params_test.html#cb203-557" tabindex="-1"></a>      geom_sets_smooth <span class="ot">&lt;-</span> </span>
<span id="cb203-558"><a href="wshed_params_test.html#cb203-558" tabindex="-1"></a>        geom_sets<span class="sc">$</span>set_id <span class="sc">%&gt;%</span> </span>
<span id="cb203-559"><a href="wshed_params_test.html#cb203-559" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-560"><a href="wshed_params_test.html#cb203-560" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb203-561"><a href="wshed_params_test.html#cb203-561" tabindex="-1"></a>          <span class="fu">raster_smooth_smoother</span>(</span>
<span id="cb203-562"><a href="wshed_params_test.html#cb203-562" tabindex="-1"></a>              <span class="at">chm_watershed_seg_fn_ans =</span> chm_watershed_seg_ans</span>
<span id="cb203-563"><a href="wshed_params_test.html#cb203-563" tabindex="-1"></a>              , <span class="at">max_ht_m =</span> (geom_sets <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(max_ht_m))</span>
<span id="cb203-564"><a href="wshed_params_test.html#cb203-564" tabindex="-1"></a>              , <span class="at">watershed_ans_poly =</span> geom_sets <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x)</span>
<span id="cb203-565"><a href="wshed_params_test.html#cb203-565" tabindex="-1"></a>              , <span class="at">min_area_m2 =</span> <span class="fu">min</span>(param_combos_df<span class="sc">$</span>min_area_m2,<span class="at">na.rm=</span>T) <span class="do">##### this fixes the parameter </span></span>
<span id="cb203-566"><a href="wshed_params_test.html#cb203-566" tabindex="-1"></a>                <span class="co"># .......... so won&#39;t work if param_combos_df contains multiple values #ohwell...just don&#39;t test min_area_m2</span></span>
<span id="cb203-567"><a href="wshed_params_test.html#cb203-567" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-568"><a href="wshed_params_test.html#cb203-568" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb203-569"><a href="wshed_params_test.html#cb203-569" tabindex="-1"></a>              <span class="at">set_id =</span> x</span>
<span id="cb203-570"><a href="wshed_params_test.html#cb203-570" tabindex="-1"></a>              , <span class="at">max_ht_m =</span> (geom_sets <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(max_ht_m))</span>
<span id="cb203-571"><a href="wshed_params_test.html#cb203-571" tabindex="-1"></a>            )</span>
<span id="cb203-572"><a href="wshed_params_test.html#cb203-572" tabindex="-1"></a>          , <span class="at">.progress =</span> <span class="st">&quot;smooth smoothing it&quot;</span></span>
<span id="cb203-573"><a href="wshed_params_test.html#cb203-573" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-574"><a href="wshed_params_test.html#cb203-574" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb203-575"><a href="wshed_params_test.html#cb203-575" tabindex="-1"></a>    </span>
<span id="cb203-576"><a href="wshed_params_test.html#cb203-576" tabindex="-1"></a>    <span class="co"># geom_sets_smooth %&gt;% dplyr::glimpse()  </span></span>
<span id="cb203-577"><a href="wshed_params_test.html#cb203-577" tabindex="-1"></a>    <span class="co"># ggplot() +</span></span>
<span id="cb203-578"><a href="wshed_params_test.html#cb203-578" tabindex="-1"></a>    <span class="co">#   geom_sf(</span></span>
<span id="cb203-579"><a href="wshed_params_test.html#cb203-579" tabindex="-1"></a>    <span class="co">#     data = geom_sets_smooth %&gt;% dplyr::filter(set_id == geom_sets_smooth$set_id[1])</span></span>
<span id="cb203-580"><a href="wshed_params_test.html#cb203-580" tabindex="-1"></a>    <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb203-581"><a href="wshed_params_test.html#cb203-581" tabindex="-1"></a>    <span class="co">#     , alpha = 0.8</span></span>
<span id="cb203-582"><a href="wshed_params_test.html#cb203-582" tabindex="-1"></a>    <span class="co">#   ) +</span></span>
<span id="cb203-583"><a href="wshed_params_test.html#cb203-583" tabindex="-1"></a>    <span class="co">#   geom_sf(</span></span>
<span id="cb203-584"><a href="wshed_params_test.html#cb203-584" tabindex="-1"></a>    <span class="co">#     data = geom_sets %&gt;% dplyr::filter(set_id == geom_sets_smooth$set_id[1])</span></span>
<span id="cb203-585"><a href="wshed_params_test.html#cb203-585" tabindex="-1"></a>    <span class="co">#     , fill = NA</span></span>
<span id="cb203-586"><a href="wshed_params_test.html#cb203-586" tabindex="-1"></a>    <span class="co">#     , color = &quot;gold&quot;</span></span>
<span id="cb203-587"><a href="wshed_params_test.html#cb203-587" tabindex="-1"></a>    <span class="co">#   ) +</span></span>
<span id="cb203-588"><a href="wshed_params_test.html#cb203-588" tabindex="-1"></a>    <span class="co">#   theme_void()</span></span>
<span id="cb203-589"><a href="wshed_params_test.html#cb203-589" tabindex="-1"></a>    </span>
<span id="cb203-590"><a href="wshed_params_test.html#cb203-590" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-591"><a href="wshed_params_test.html#cb203-591" tabindex="-1"></a>    <span class="do">## 6.3) second irregular filter</span></span>
<span id="cb203-592"><a href="wshed_params_test.html#cb203-592" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-593"><a href="wshed_params_test.html#cb203-593" tabindex="-1"></a>    <span class="co"># get set, convexity combinations to map over st_irregular_remove</span></span>
<span id="cb203-594"><a href="wshed_params_test.html#cb203-594" tabindex="-1"></a>    set_convexity_combo <span class="ot">&lt;-</span> </span>
<span id="cb203-595"><a href="wshed_params_test.html#cb203-595" tabindex="-1"></a>      rn_geom_lookup <span class="sc">%&gt;%</span>  </span>
<span id="cb203-596"><a href="wshed_params_test.html#cb203-596" tabindex="-1"></a>        <span class="co"># add in convexity pct to get unique set_id, convexity</span></span>
<span id="cb203-597"><a href="wshed_params_test.html#cb203-597" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-598"><a href="wshed_params_test.html#cb203-598" tabindex="-1"></a>          param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb203-599"><a href="wshed_params_test.html#cb203-599" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(rn,convexity_pct)</span>
<span id="cb203-600"><a href="wshed_params_test.html#cb203-600" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb203-601"><a href="wshed_params_test.html#cb203-601" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-602"><a href="wshed_params_test.html#cb203-602" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(set_id,convexity_pct)</span>
<span id="cb203-603"><a href="wshed_params_test.html#cb203-603" tabindex="-1"></a>    </span>
<span id="cb203-604"><a href="wshed_params_test.html#cb203-604" tabindex="-1"></a>    <span class="co"># filter for convexity</span></span>
<span id="cb203-605"><a href="wshed_params_test.html#cb203-605" tabindex="-1"></a>      geom_sets_convexity <span class="ot">&lt;-</span> </span>
<span id="cb203-606"><a href="wshed_params_test.html#cb203-606" tabindex="-1"></a>        <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(set_convexity_combo) <span class="sc">%&gt;%</span> </span>
<span id="cb203-607"><a href="wshed_params_test.html#cb203-607" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb203-608"><a href="wshed_params_test.html#cb203-608" tabindex="-1"></a>          <span class="fu">st_irregular_remove</span>(</span>
<span id="cb203-609"><a href="wshed_params_test.html#cb203-609" tabindex="-1"></a>            <span class="at">sf_data =</span> geom_sets_smooth <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>set_convexity_combo<span class="sc">$</span>set_id[x])</span>
<span id="cb203-610"><a href="wshed_params_test.html#cb203-610" tabindex="-1"></a>            , <span class="at">pct_chull_overlap =</span> set_convexity_combo<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb203-611"><a href="wshed_params_test.html#cb203-611" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-612"><a href="wshed_params_test.html#cb203-612" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb203-613"><a href="wshed_params_test.html#cb203-613" tabindex="-1"></a>              <span class="at">set_id =</span> set_convexity_combo<span class="sc">$</span>set_id[x]</span>
<span id="cb203-614"><a href="wshed_params_test.html#cb203-614" tabindex="-1"></a>              , <span class="at">convexity_pct =</span> set_convexity_combo<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb203-615"><a href="wshed_params_test.html#cb203-615" tabindex="-1"></a>            )</span>
<span id="cb203-616"><a href="wshed_params_test.html#cb203-616" tabindex="-1"></a>          , <span class="at">.progress =</span> <span class="st">&quot;second irregularity filter&quot;</span></span>
<span id="cb203-617"><a href="wshed_params_test.html#cb203-617" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-618"><a href="wshed_params_test.html#cb203-618" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb203-619"><a href="wshed_params_test.html#cb203-619" tabindex="-1"></a>    </span>
<span id="cb203-620"><a href="wshed_params_test.html#cb203-620" tabindex="-1"></a>    <span class="co"># row is unique by set_id,convexity_pct,pred_id</span></span>
<span id="cb203-621"><a href="wshed_params_test.html#cb203-621" tabindex="-1"></a>    <span class="co"># geom_sets_convexity %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-622"><a href="wshed_params_test.html#cb203-622" tabindex="-1"></a>    <span class="co"># geom_sets_convexity %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(set_id,convexity_pct)</span></span>
<span id="cb203-623"><a href="wshed_params_test.html#cb203-623" tabindex="-1"></a>    </span>
<span id="cb203-624"><a href="wshed_params_test.html#cb203-624" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-625"><a href="wshed_params_test.html#cb203-625" tabindex="-1"></a>    <span class="do">## 6.6) second area filter</span></span>
<span id="cb203-626"><a href="wshed_params_test.html#cb203-626" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-627"><a href="wshed_params_test.html#cb203-627" tabindex="-1"></a>    <span class="co"># filter for area</span></span>
<span id="cb203-628"><a href="wshed_params_test.html#cb203-628" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;expanding to final param combos.....&quot;</span>)</span>
<span id="cb203-629"><a href="wshed_params_test.html#cb203-629" tabindex="-1"></a>      filtered_final <span class="ot">&lt;-</span> </span>
<span id="cb203-630"><a href="wshed_params_test.html#cb203-630" tabindex="-1"></a>        geom_sets_convexity <span class="sc">%&gt;%</span> </span>
<span id="cb203-631"><a href="wshed_params_test.html#cb203-631" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(max_ht_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb203-632"><a href="wshed_params_test.html#cb203-632" tabindex="-1"></a>        <span class="co"># expand to full param_combos_df</span></span>
<span id="cb203-633"><a href="wshed_params_test.html#cb203-633" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-634"><a href="wshed_params_test.html#cb203-634" tabindex="-1"></a>          param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb203-635"><a href="wshed_params_test.html#cb203-635" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-636"><a href="wshed_params_test.html#cb203-636" tabindex="-1"></a>              rn_geom_lookup <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb203-637"><a href="wshed_params_test.html#cb203-637" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb203-638"><a href="wshed_params_test.html#cb203-638" tabindex="-1"></a>            )</span>
<span id="cb203-639"><a href="wshed_params_test.html#cb203-639" tabindex="-1"></a>          , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id,convexity_pct)</span>
<span id="cb203-640"><a href="wshed_params_test.html#cb203-640" tabindex="-1"></a>          , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb203-641"><a href="wshed_params_test.html#cb203-641" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-642"><a href="wshed_params_test.html#cb203-642" tabindex="-1"></a>        <span class="co"># filter for area</span></span>
<span id="cb203-643"><a href="wshed_params_test.html#cb203-643" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb203-644"><a href="wshed_params_test.html#cb203-644" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb203-645"><a href="wshed_params_test.html#cb203-645" tabindex="-1"></a>          <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb203-646"><a href="wshed_params_test.html#cb203-646" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-647"><a href="wshed_params_test.html#cb203-647" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(set_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb203-648"><a href="wshed_params_test.html#cb203-648" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">relocate</span>(<span class="fu">names</span>(param_combos_df))</span>
<span id="cb203-649"><a href="wshed_params_test.html#cb203-649" tabindex="-1"></a>    <span class="co"># filtered_final %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-650"><a href="wshed_params_test.html#cb203-650" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-651"><a href="wshed_params_test.html#cb203-651" tabindex="-1"></a>    <span class="do">## 7) shape refinement &amp; overlap removal</span></span>
<span id="cb203-652"><a href="wshed_params_test.html#cb203-652" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb203-653"><a href="wshed_params_test.html#cb203-653" tabindex="-1"></a>      <span class="co"># use the convex hull shapes of our remaining segments. </span></span>
<span id="cb203-654"><a href="wshed_params_test.html#cb203-654" tabindex="-1"></a>      <span class="co"># This helps to smooth out the often &#39;blocky&#39; edges of raster-based segments</span></span>
<span id="cb203-655"><a href="wshed_params_test.html#cb203-655" tabindex="-1"></a>      <span class="co"># , which can look like they were generated in Minecraft. </span></span>
<span id="cb203-656"><a href="wshed_params_test.html#cb203-656" tabindex="-1"></a>      <span class="co"># Additionally, by removing any segments with overlapping convex hull shapes, </span></span>
<span id="cb203-657"><a href="wshed_params_test.html#cb203-657" tabindex="-1"></a>      <span class="co"># we can likely reduce false detections that are actually groups of small trees or shrubs, </span></span>
<span id="cb203-658"><a href="wshed_params_test.html#cb203-658" tabindex="-1"></a>      <span class="co"># ensuring our results represent singular slash piles.</span></span>
<span id="cb203-659"><a href="wshed_params_test.html#cb203-659" tabindex="-1"></a>      smooth_segs <span class="ot">&lt;-</span> T</span>
<span id="cb203-660"><a href="wshed_params_test.html#cb203-660" tabindex="-1"></a>      </span>
<span id="cb203-661"><a href="wshed_params_test.html#cb203-661" tabindex="-1"></a>      <span class="cf">if</span>(smooth_segs){</span>
<span id="cb203-662"><a href="wshed_params_test.html#cb203-662" tabindex="-1"></a>        <span class="co"># smooth unique polygons </span></span>
<span id="cb203-663"><a href="wshed_params_test.html#cb203-663" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;shape refinement and diametering.....&quot;</span>)</span>
<span id="cb203-664"><a href="wshed_params_test.html#cb203-664" tabindex="-1"></a>        <span class="do">##### just work with unique polygons</span></span>
<span id="cb203-665"><a href="wshed_params_test.html#cb203-665" tabindex="-1"></a>        <span class="do">##### geom_sets_smooth row is unique by: set_id,pred_id</span></span>
<span id="cb203-666"><a href="wshed_params_test.html#cb203-666" tabindex="-1"></a>        geom_sets_final <span class="ot">&lt;-</span> geom_sets_smooth <span class="sc">%&gt;%</span> </span>
<span id="cb203-667"><a href="wshed_params_test.html#cb203-667" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb203-668"><a href="wshed_params_test.html#cb203-668" tabindex="-1"></a>            <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb203-669"><a href="wshed_params_test.html#cb203-669" tabindex="-1"></a>            , <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb203-670"><a href="wshed_params_test.html#cb203-670" tabindex="-1"></a>          ))) <span class="sc">%&gt;%</span> </span>
<span id="cb203-671"><a href="wshed_params_test.html#cb203-671" tabindex="-1"></a>          <span class="co"># join to filter geoms</span></span>
<span id="cb203-672"><a href="wshed_params_test.html#cb203-672" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-673"><a href="wshed_params_test.html#cb203-673" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb203-674"><a href="wshed_params_test.html#cb203-674" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-675"><a href="wshed_params_test.html#cb203-675" tabindex="-1"></a>                filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb203-676"><a href="wshed_params_test.html#cb203-676" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-677"><a href="wshed_params_test.html#cb203-677" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb203-678"><a href="wshed_params_test.html#cb203-678" tabindex="-1"></a>                , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn)</span>
<span id="cb203-679"><a href="wshed_params_test.html#cb203-679" tabindex="-1"></a>                , <span class="at">relationship =</span> <span class="st">&quot;one-to-many&quot;</span></span>
<span id="cb203-680"><a href="wshed_params_test.html#cb203-680" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-681"><a href="wshed_params_test.html#cb203-681" tabindex="-1"></a>              <span class="co"># just get the unique geoms now</span></span>
<span id="cb203-682"><a href="wshed_params_test.html#cb203-682" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(set_id,pred_id)</span>
<span id="cb203-683"><a href="wshed_params_test.html#cb203-683" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id,pred_id)</span>
<span id="cb203-684"><a href="wshed_params_test.html#cb203-684" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb203-685"><a href="wshed_params_test.html#cb203-685" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-686"><a href="wshed_params_test.html#cb203-686" tabindex="-1"></a>          <span class="co"># smooth</span></span>
<span id="cb203-687"><a href="wshed_params_test.html#cb203-687" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-688"><a href="wshed_params_test.html#cb203-688" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-689"><a href="wshed_params_test.html#cb203-689" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-690"><a href="wshed_params_test.html#cb203-690" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb203-691"><a href="wshed_params_test.html#cb203-691" tabindex="-1"></a>          <span class="co"># diameter</span></span>
<span id="cb203-692"><a href="wshed_params_test.html#cb203-692" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-693"><a href="wshed_params_test.html#cb203-693" tabindex="-1"></a>          <span class="fu">st_calculate_diameter</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-694"><a href="wshed_params_test.html#cb203-694" tabindex="-1"></a>          <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb203-695"><a href="wshed_params_test.html#cb203-695" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb203-696"><a href="wshed_params_test.html#cb203-696" tabindex="-1"></a>            <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb203-697"><a href="wshed_params_test.html#cb203-697" tabindex="-1"></a>            , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb203-698"><a href="wshed_params_test.html#cb203-698" tabindex="-1"></a>          )</span>
<span id="cb203-699"><a href="wshed_params_test.html#cb203-699" tabindex="-1"></a>        </span>
<span id="cb203-700"><a href="wshed_params_test.html#cb203-700" tabindex="-1"></a>        <span class="co"># ##### geom_sets_final row is unique by: set_id,pred_id</span></span>
<span id="cb203-701"><a href="wshed_params_test.html#cb203-701" tabindex="-1"></a>        <span class="co"># geom_sets_final %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-702"><a href="wshed_params_test.html#cb203-702" tabindex="-1"></a>        <span class="co"># ggplot() +</span></span>
<span id="cb203-703"><a href="wshed_params_test.html#cb203-703" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb203-704"><a href="wshed_params_test.html#cb203-704" tabindex="-1"></a>        <span class="co">#     # post smooth (should be slightly larger)</span></span>
<span id="cb203-705"><a href="wshed_params_test.html#cb203-705" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final %&gt;% dplyr::filter(set_id == geom_sets_final$set_id[1])</span></span>
<span id="cb203-706"><a href="wshed_params_test.html#cb203-706" tabindex="-1"></a>        <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb203-707"><a href="wshed_params_test.html#cb203-707" tabindex="-1"></a>        <span class="co">#     , alpha = 0.8</span></span>
<span id="cb203-708"><a href="wshed_params_test.html#cb203-708" tabindex="-1"></a>        <span class="co">#     , color = &quot;gray&quot;</span></span>
<span id="cb203-709"><a href="wshed_params_test.html#cb203-709" tabindex="-1"></a>        <span class="co">#     , lwd = 0.2</span></span>
<span id="cb203-710"><a href="wshed_params_test.html#cb203-710" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb203-711"><a href="wshed_params_test.html#cb203-711" tabindex="-1"></a>        <span class="co">#   theme_void()</span></span>
<span id="cb203-712"><a href="wshed_params_test.html#cb203-712" tabindex="-1"></a>        <span class="co"># ggplot() +</span></span>
<span id="cb203-713"><a href="wshed_params_test.html#cb203-713" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb203-714"><a href="wshed_params_test.html#cb203-714" tabindex="-1"></a>        <span class="co">#     # post smooth (should be slightly larger)</span></span>
<span id="cb203-715"><a href="wshed_params_test.html#cb203-715" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final %&gt;% dplyr::filter(set_id == geom_sets_final$set_id[1])</span></span>
<span id="cb203-716"><a href="wshed_params_test.html#cb203-716" tabindex="-1"></a>        <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb203-717"><a href="wshed_params_test.html#cb203-717" tabindex="-1"></a>        <span class="co">#     , alpha = 0.8</span></span>
<span id="cb203-718"><a href="wshed_params_test.html#cb203-718" tabindex="-1"></a>        <span class="co">#     , color = &quot;gray&quot;</span></span>
<span id="cb203-719"><a href="wshed_params_test.html#cb203-719" tabindex="-1"></a>        <span class="co">#     , lwd = 0.2</span></span>
<span id="cb203-720"><a href="wshed_params_test.html#cb203-720" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb203-721"><a href="wshed_params_test.html#cb203-721" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb203-722"><a href="wshed_params_test.html#cb203-722" tabindex="-1"></a>        <span class="co">#     # pre-smooth</span></span>
<span id="cb203-723"><a href="wshed_params_test.html#cb203-723" tabindex="-1"></a>        <span class="co">#     data = geom_sets %&gt;% dplyr::filter(set_id == geom_sets_final$set_id[1])</span></span>
<span id="cb203-724"><a href="wshed_params_test.html#cb203-724" tabindex="-1"></a>        <span class="co">#     , fill = NA</span></span>
<span id="cb203-725"><a href="wshed_params_test.html#cb203-725" tabindex="-1"></a>        <span class="co">#     , color = &quot;gold&quot;</span></span>
<span id="cb203-726"><a href="wshed_params_test.html#cb203-726" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb203-727"><a href="wshed_params_test.html#cb203-727" tabindex="-1"></a>        <span class="co">#   theme_void()</span></span>
<span id="cb203-728"><a href="wshed_params_test.html#cb203-728" tabindex="-1"></a>        </span>
<span id="cb203-729"><a href="wshed_params_test.html#cb203-729" tabindex="-1"></a>        <span class="co"># sf::st_read(&quot;c:/data/usfs/manitou_slash_piles/data/param_combos_piles_chm0.45m.gpkg&quot;) %&gt;% </span></span>
<span id="cb203-730"><a href="wshed_params_test.html#cb203-730" tabindex="-1"></a>        <span class="co">#   dplyr::mutate(xxxarea_m2 = sf::st_area(.) %&gt;% as.numeric()) %&gt;% </span></span>
<span id="cb203-731"><a href="wshed_params_test.html#cb203-731" tabindex="-1"></a>        <span class="co">#   sf::st_drop_geometry() %&gt;% </span></span>
<span id="cb203-732"><a href="wshed_params_test.html#cb203-732" tabindex="-1"></a>        <span class="co">#   dplyr::slice_sample(n=33333) %&gt;% </span></span>
<span id="cb203-733"><a href="wshed_params_test.html#cb203-733" tabindex="-1"></a>        <span class="co">#   ggplot2::ggplot(mapping = ggplot2::aes(x = xxxarea_m2, y =area_m2)) +</span></span>
<span id="cb203-734"><a href="wshed_params_test.html#cb203-734" tabindex="-1"></a>        <span class="co">#   ggplot2::geom_abline(lwd = 1) +</span></span>
<span id="cb203-735"><a href="wshed_params_test.html#cb203-735" tabindex="-1"></a>        <span class="co">#   ggplot2::geom_point() +</span></span>
<span id="cb203-736"><a href="wshed_params_test.html#cb203-736" tabindex="-1"></a>        <span class="co">#   ggplot2::geom_smooth(method = &quot;lm&quot;, se=F, color = &quot;tomato&quot;, linetype = &quot;dashed&quot;) +</span></span>
<span id="cb203-737"><a href="wshed_params_test.html#cb203-737" tabindex="-1"></a>        <span class="co">#   ggplot2::scale_color_viridis_c(option = &quot;mako&quot;, direction = -1, alpha = 0.8) +</span></span>
<span id="cb203-738"><a href="wshed_params_test.html#cb203-738" tabindex="-1"></a>        <span class="co">#   ggplot2::theme_light()</span></span>
<span id="cb203-739"><a href="wshed_params_test.html#cb203-739" tabindex="-1"></a>          </span>
<span id="cb203-740"><a href="wshed_params_test.html#cb203-740" tabindex="-1"></a>        </span>
<span id="cb203-741"><a href="wshed_params_test.html#cb203-741" tabindex="-1"></a>        <span class="co"># ##### geom_sets_final row is unique by: set_id,pred_id</span></span>
<span id="cb203-742"><a href="wshed_params_test.html#cb203-742" tabindex="-1"></a>        <span class="co"># overlapping convex hull shapes are then removed to prevent false positives from clustered small trees or shrubs</span></span>
<span id="cb203-743"><a href="wshed_params_test.html#cb203-743" tabindex="-1"></a>        <span class="co"># have to map over this to do overlaps only on one set at a time</span></span>
<span id="cb203-744"><a href="wshed_params_test.html#cb203-744" tabindex="-1"></a>        geom_sets_final_olaps <span class="ot">&lt;-</span> </span>
<span id="cb203-745"><a href="wshed_params_test.html#cb203-745" tabindex="-1"></a>            geom_sets_final<span class="sc">$</span>set_id <span class="sc">%&gt;%</span> </span>
<span id="cb203-746"><a href="wshed_params_test.html#cb203-746" tabindex="-1"></a>            <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-747"><a href="wshed_params_test.html#cb203-747" tabindex="-1"></a>            purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb203-748"><a href="wshed_params_test.html#cb203-748" tabindex="-1"></a>              geom_sets_final <span class="sc">%&gt;%</span> </span>
<span id="cb203-749"><a href="wshed_params_test.html#cb203-749" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(set_id<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb203-750"><a href="wshed_params_test.html#cb203-750" tabindex="-1"></a>                <span class="fu">st_remove_overlaps</span>()</span>
<span id="cb203-751"><a href="wshed_params_test.html#cb203-751" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-752"><a href="wshed_params_test.html#cb203-752" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb203-753"><a href="wshed_params_test.html#cb203-753" tabindex="-1"></a>          </span>
<span id="cb203-754"><a href="wshed_params_test.html#cb203-754" tabindex="-1"></a>        <span class="co"># ##### geom_sets_final_olaps row is unique by: set_id,pred_id</span></span>
<span id="cb203-755"><a href="wshed_params_test.html#cb203-755" tabindex="-1"></a>        <span class="co"># geom_sets_final %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-756"><a href="wshed_params_test.html#cb203-756" tabindex="-1"></a>        <span class="co"># geom_sets_final_olaps %&gt;% dplyr::glimpse()</span></span>
<span id="cb203-757"><a href="wshed_params_test.html#cb203-757" tabindex="-1"></a>        <span class="co"># ggplot() +</span></span>
<span id="cb203-758"><a href="wshed_params_test.html#cb203-758" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb203-759"><a href="wshed_params_test.html#cb203-759" tabindex="-1"></a>        <span class="co">#     # post smooth (should be slightly larger)</span></span>
<span id="cb203-760"><a href="wshed_params_test.html#cb203-760" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final_olaps %&gt;% dplyr::filter(set_id == geom_sets_final_olaps$set_id[1])</span></span>
<span id="cb203-761"><a href="wshed_params_test.html#cb203-761" tabindex="-1"></a>        <span class="co">#     , fill = &quot;navy&quot;</span></span>
<span id="cb203-762"><a href="wshed_params_test.html#cb203-762" tabindex="-1"></a>        <span class="co">#     , alpha = 0.8</span></span>
<span id="cb203-763"><a href="wshed_params_test.html#cb203-763" tabindex="-1"></a>        <span class="co">#     , color = &quot;gray&quot;</span></span>
<span id="cb203-764"><a href="wshed_params_test.html#cb203-764" tabindex="-1"></a>        <span class="co">#     , lwd = 0.2</span></span>
<span id="cb203-765"><a href="wshed_params_test.html#cb203-765" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb203-766"><a href="wshed_params_test.html#cb203-766" tabindex="-1"></a>        <span class="co">#   geom_sf(</span></span>
<span id="cb203-767"><a href="wshed_params_test.html#cb203-767" tabindex="-1"></a>        <span class="co">#     # pre-smooth</span></span>
<span id="cb203-768"><a href="wshed_params_test.html#cb203-768" tabindex="-1"></a>        <span class="co">#     data = geom_sets_final %&gt;% dplyr::filter(set_id == geom_sets_final_olaps$set_id[1])</span></span>
<span id="cb203-769"><a href="wshed_params_test.html#cb203-769" tabindex="-1"></a>        <span class="co">#     , fill = NA</span></span>
<span id="cb203-770"><a href="wshed_params_test.html#cb203-770" tabindex="-1"></a>        <span class="co">#     , color = &quot;gold&quot;</span></span>
<span id="cb203-771"><a href="wshed_params_test.html#cb203-771" tabindex="-1"></a>        <span class="co">#     , lwd = 1</span></span>
<span id="cb203-772"><a href="wshed_params_test.html#cb203-772" tabindex="-1"></a>        <span class="co">#   ) +</span></span>
<span id="cb203-773"><a href="wshed_params_test.html#cb203-773" tabindex="-1"></a>        <span class="co">#   theme_void()</span></span>
<span id="cb203-774"><a href="wshed_params_test.html#cb203-774" tabindex="-1"></a>        </span>
<span id="cb203-775"><a href="wshed_params_test.html#cb203-775" tabindex="-1"></a>        </span>
<span id="cb203-776"><a href="wshed_params_test.html#cb203-776" tabindex="-1"></a>        <span class="co"># join back to param_combos list</span></span>
<span id="cb203-777"><a href="wshed_params_test.html#cb203-777" tabindex="-1"></a>        final_ans <span class="ot">&lt;-</span> geom_sets_final_olaps <span class="sc">%&gt;%</span> </span>
<span id="cb203-778"><a href="wshed_params_test.html#cb203-778" tabindex="-1"></a>          <span class="co"># join to lookup</span></span>
<span id="cb203-779"><a href="wshed_params_test.html#cb203-779" tabindex="-1"></a>          <span class="co"># expands row to unique by set_id,rn,pred_id</span></span>
<span id="cb203-780"><a href="wshed_params_test.html#cb203-780" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-781"><a href="wshed_params_test.html#cb203-781" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb203-782"><a href="wshed_params_test.html#cb203-782" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb203-783"><a href="wshed_params_test.html#cb203-783" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id)</span>
<span id="cb203-784"><a href="wshed_params_test.html#cb203-784" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb203-785"><a href="wshed_params_test.html#cb203-785" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-786"><a href="wshed_params_test.html#cb203-786" tabindex="-1"></a>          <span class="co"># join with filtered_final which have pred_id</span></span>
<span id="cb203-787"><a href="wshed_params_test.html#cb203-787" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-788"><a href="wshed_params_test.html#cb203-788" tabindex="-1"></a>            filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb203-789"><a href="wshed_params_test.html#cb203-789" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-790"><a href="wshed_params_test.html#cb203-790" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb203-791"><a href="wshed_params_test.html#cb203-791" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb203-792"><a href="wshed_params_test.html#cb203-792" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb203-793"><a href="wshed_params_test.html#cb203-793" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-794"><a href="wshed_params_test.html#cb203-794" tabindex="-1"></a>          <span class="co"># add param_combos_df data</span></span>
<span id="cb203-795"><a href="wshed_params_test.html#cb203-795" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-796"><a href="wshed_params_test.html#cb203-796" tabindex="-1"></a>            param_combos_df</span>
<span id="cb203-797"><a href="wshed_params_test.html#cb203-797" tabindex="-1"></a>            , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb203-798"><a href="wshed_params_test.html#cb203-798" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-one&quot;</span></span>
<span id="cb203-799"><a href="wshed_params_test.html#cb203-799" tabindex="-1"></a>          )</span>
<span id="cb203-800"><a href="wshed_params_test.html#cb203-800" tabindex="-1"></a>        </span>
<span id="cb203-801"><a href="wshed_params_test.html#cb203-801" tabindex="-1"></a>        <span class="co"># nrow(filtered_final)</span></span>
<span id="cb203-802"><a href="wshed_params_test.html#cb203-802" tabindex="-1"></a>        <span class="co"># nrow(final_ans) # should be less</span></span>
<span id="cb203-803"><a href="wshed_params_test.html#cb203-803" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb203-804"><a href="wshed_params_test.html#cb203-804" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;diametering.....&quot;</span>)</span>
<span id="cb203-805"><a href="wshed_params_test.html#cb203-805" tabindex="-1"></a>        <span class="do">##### just work with unique polygons</span></span>
<span id="cb203-806"><a href="wshed_params_test.html#cb203-806" tabindex="-1"></a>        <span class="do">##### geom_sets_smooth row is unique by: set_id,pred_id</span></span>
<span id="cb203-807"><a href="wshed_params_test.html#cb203-807" tabindex="-1"></a>        geom_sets_final <span class="ot">&lt;-</span> geom_sets_smooth <span class="sc">%&gt;%</span> </span>
<span id="cb203-808"><a href="wshed_params_test.html#cb203-808" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb203-809"><a href="wshed_params_test.html#cb203-809" tabindex="-1"></a>            <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb203-810"><a href="wshed_params_test.html#cb203-810" tabindex="-1"></a>            , <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb203-811"><a href="wshed_params_test.html#cb203-811" tabindex="-1"></a>          ))) <span class="sc">%&gt;%</span> </span>
<span id="cb203-812"><a href="wshed_params_test.html#cb203-812" tabindex="-1"></a>          <span class="co"># join to filter geoms</span></span>
<span id="cb203-813"><a href="wshed_params_test.html#cb203-813" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-814"><a href="wshed_params_test.html#cb203-814" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb203-815"><a href="wshed_params_test.html#cb203-815" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-816"><a href="wshed_params_test.html#cb203-816" tabindex="-1"></a>                filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb203-817"><a href="wshed_params_test.html#cb203-817" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-818"><a href="wshed_params_test.html#cb203-818" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb203-819"><a href="wshed_params_test.html#cb203-819" tabindex="-1"></a>                , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn)</span>
<span id="cb203-820"><a href="wshed_params_test.html#cb203-820" tabindex="-1"></a>                , <span class="at">relationship =</span> <span class="st">&quot;one-to-many&quot;</span></span>
<span id="cb203-821"><a href="wshed_params_test.html#cb203-821" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-822"><a href="wshed_params_test.html#cb203-822" tabindex="-1"></a>              <span class="co"># just get the unique geoms now</span></span>
<span id="cb203-823"><a href="wshed_params_test.html#cb203-823" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(set_id,pred_id)</span>
<span id="cb203-824"><a href="wshed_params_test.html#cb203-824" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id,pred_id)</span>
<span id="cb203-825"><a href="wshed_params_test.html#cb203-825" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb203-826"><a href="wshed_params_test.html#cb203-826" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-827"><a href="wshed_params_test.html#cb203-827" tabindex="-1"></a>          <span class="co"># diameter</span></span>
<span id="cb203-828"><a href="wshed_params_test.html#cb203-828" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-829"><a href="wshed_params_test.html#cb203-829" tabindex="-1"></a>          <span class="fu">st_calculate_diameter</span>()</span>
<span id="cb203-830"><a href="wshed_params_test.html#cb203-830" tabindex="-1"></a>        </span>
<span id="cb203-831"><a href="wshed_params_test.html#cb203-831" tabindex="-1"></a>        <span class="co"># join back to param_combos list</span></span>
<span id="cb203-832"><a href="wshed_params_test.html#cb203-832" tabindex="-1"></a>        final_ans <span class="ot">&lt;-</span> geom_sets_final <span class="sc">%&gt;%</span> </span>
<span id="cb203-833"><a href="wshed_params_test.html#cb203-833" tabindex="-1"></a>          <span class="co"># join to lookup</span></span>
<span id="cb203-834"><a href="wshed_params_test.html#cb203-834" tabindex="-1"></a>          <span class="co"># expands row to unique by set_id,rn,pred_id</span></span>
<span id="cb203-835"><a href="wshed_params_test.html#cb203-835" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-836"><a href="wshed_params_test.html#cb203-836" tabindex="-1"></a>            rn_geom_lookup <span class="sc">%&gt;%</span> </span>
<span id="cb203-837"><a href="wshed_params_test.html#cb203-837" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(rn,set_id)</span>
<span id="cb203-838"><a href="wshed_params_test.html#cb203-838" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(set_id)</span>
<span id="cb203-839"><a href="wshed_params_test.html#cb203-839" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb203-840"><a href="wshed_params_test.html#cb203-840" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-841"><a href="wshed_params_test.html#cb203-841" tabindex="-1"></a>          <span class="co"># join with filtered_final which have pred_id</span></span>
<span id="cb203-842"><a href="wshed_params_test.html#cb203-842" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-843"><a href="wshed_params_test.html#cb203-843" tabindex="-1"></a>            filtered_final <span class="sc">%&gt;%</span> </span>
<span id="cb203-844"><a href="wshed_params_test.html#cb203-844" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb203-845"><a href="wshed_params_test.html#cb203-845" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">distinct</span>(rn,pred_id)</span>
<span id="cb203-846"><a href="wshed_params_test.html#cb203-846" tabindex="-1"></a>            , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb203-847"><a href="wshed_params_test.html#cb203-847" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb203-848"><a href="wshed_params_test.html#cb203-848" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-849"><a href="wshed_params_test.html#cb203-849" tabindex="-1"></a>          <span class="co"># add param_combos_df data</span></span>
<span id="cb203-850"><a href="wshed_params_test.html#cb203-850" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb203-851"><a href="wshed_params_test.html#cb203-851" tabindex="-1"></a>            param_combos_df</span>
<span id="cb203-852"><a href="wshed_params_test.html#cb203-852" tabindex="-1"></a>            , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb203-853"><a href="wshed_params_test.html#cb203-853" tabindex="-1"></a>            , <span class="at">relationship =</span> <span class="st">&quot;many-to-one&quot;</span></span>
<span id="cb203-854"><a href="wshed_params_test.html#cb203-854" tabindex="-1"></a>          )</span>
<span id="cb203-855"><a href="wshed_params_test.html#cb203-855" tabindex="-1"></a>        </span>
<span id="cb203-856"><a href="wshed_params_test.html#cb203-856" tabindex="-1"></a>      }</span>
<span id="cb203-857"><a href="wshed_params_test.html#cb203-857" tabindex="-1"></a>      </span>
<span id="cb203-858"><a href="wshed_params_test.html#cb203-858" tabindex="-1"></a>      <span class="cf">if</span>(stringr<span class="sc">::</span><span class="fu">str_length</span>(ofile)<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb203-859"><a href="wshed_params_test.html#cb203-859" tabindex="-1"></a>        final_ans <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_write</span>(ofile, <span class="at">append =</span> F, <span class="at">quiet =</span> T)</span>
<span id="cb203-860"><a href="wshed_params_test.html#cb203-860" tabindex="-1"></a>      }</span>
<span id="cb203-861"><a href="wshed_params_test.html#cb203-861" tabindex="-1"></a>      </span>
<span id="cb203-862"><a href="wshed_params_test.html#cb203-862" tabindex="-1"></a>    <span class="co"># return</span></span>
<span id="cb203-863"><a href="wshed_params_test.html#cb203-863" tabindex="-1"></a>      <span class="fu">return</span>(final_ans)</span>
<span id="cb203-864"><a href="wshed_params_test.html#cb203-864" tabindex="-1"></a>}</span>
<span id="cb203-865"><a href="wshed_params_test.html#cb203-865" tabindex="-1"></a></span>
<span id="cb203-866"><a href="wshed_params_test.html#cb203-866" tabindex="-1"></a><span class="co"># param_combos_piles &lt;- </span></span>
<span id="cb203-867"><a href="wshed_params_test.html#cb203-867" tabindex="-1"></a><span class="co">#   param_combos_df$rn %&gt;% </span></span>
<span id="cb203-868"><a href="wshed_params_test.html#cb203-868" tabindex="-1"></a><span class="co">#   # sample(3) %&gt;% ## !!!!!!!!!!!!!!!!!!!! remove after testing</span></span>
<span id="cb203-869"><a href="wshed_params_test.html#cb203-869" tabindex="-1"></a><span class="co">#   purrr::map(\(x)</span></span>
<span id="cb203-870"><a href="wshed_params_test.html#cb203-870" tabindex="-1"></a><span class="co">#     slash_pile_detect_watershed(</span></span>
<span id="cb203-871"><a href="wshed_params_test.html#cb203-871" tabindex="-1"></a><span class="co">#         chm_rast = cloud2raster_ans$chm_rast</span></span>
<span id="cb203-872"><a href="wshed_params_test.html#cb203-872" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_df$max_ht_m[x]</span></span>
<span id="cb203-873"><a href="wshed_params_test.html#cb203-873" tabindex="-1"></a><span class="co">#         , min_area_m2 = param_combos_df$min_area_m2[x]</span></span>
<span id="cb203-874"><a href="wshed_params_test.html#cb203-874" tabindex="-1"></a><span class="co">#         , max_area_m2 = param_combos_df$max_area_m2[x]</span></span>
<span id="cb203-875"><a href="wshed_params_test.html#cb203-875" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_df$convexity_pct[x]</span></span>
<span id="cb203-876"><a href="wshed_params_test.html#cb203-876" tabindex="-1"></a><span class="co">#         , circle_fit_iou_pct = param_combos_df$circle_fit_iou_pct[x]</span></span>
<span id="cb203-877"><a href="wshed_params_test.html#cb203-877" tabindex="-1"></a><span class="co">#       ) %&gt;% </span></span>
<span id="cb203-878"><a href="wshed_params_test.html#cb203-878" tabindex="-1"></a><span class="co">#       dplyr::mutate(</span></span>
<span id="cb203-879"><a href="wshed_params_test.html#cb203-879" tabindex="-1"></a><span class="co">#         rn = param_combos_df$rn[x]</span></span>
<span id="cb203-880"><a href="wshed_params_test.html#cb203-880" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_df$max_ht_m[x]</span></span>
<span id="cb203-881"><a href="wshed_params_test.html#cb203-881" tabindex="-1"></a><span class="co">#         , min_area_m2 = param_combos_df$min_area_m2[x]</span></span>
<span id="cb203-882"><a href="wshed_params_test.html#cb203-882" tabindex="-1"></a><span class="co">#         , max_area_m2 = param_combos_df$max_area_m2[x]</span></span>
<span id="cb203-883"><a href="wshed_params_test.html#cb203-883" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_df$convexity_pct[x]</span></span>
<span id="cb203-884"><a href="wshed_params_test.html#cb203-884" tabindex="-1"></a><span class="co">#         , circle_fit_iou_pct = param_combos_df$circle_fit_iou_pct[x]</span></span>
<span id="cb203-885"><a href="wshed_params_test.html#cb203-885" tabindex="-1"></a><span class="co">#       )</span></span>
<span id="cb203-886"><a href="wshed_params_test.html#cb203-886" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb203-887"><a href="wshed_params_test.html#cb203-887" tabindex="-1"></a><span class="co">#   dplyr::bind_rows()</span></span>
<span id="cb203-888"><a href="wshed_params_test.html#cb203-888" tabindex="-1"></a></span>
<span id="cb203-889"><a href="wshed_params_test.html#cb203-889" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% </span></span>
<span id="cb203-890"><a href="wshed_params_test.html#cb203-890" tabindex="-1"></a><span class="co">#   sf::st_write(&quot;../data/param_combos_piles.gpkg&quot;, append = F)</span></span>
<span id="cb203-891"><a href="wshed_params_test.html#cb203-891" tabindex="-1"></a><span class="co"># # param_combos_piles &lt;- sf::st_read(&quot;../data/param_combos_piles.gpkg&quot;)</span></span></code></pre></div>
<div id="test-workflow" class="section level3 hasAnchor" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> Test Workflow<a href="wshed_params_test.html#test-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we’ll test our apply our function using a sample from the data frame of the parameter combinations</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="wshed_params_test.html#cb204-1" tabindex="-1"></a>f_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/testtest_param_combos_piles.gpkg&quot;</span></span>
<span id="cb204-2"><a href="wshed_params_test.html#cb204-2" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(f_temp)){</span>
<span id="cb204-3"><a href="wshed_params_test.html#cb204-3" tabindex="-1"></a>  param_combos_piles <span class="ot">&lt;-</span> <span class="fu">param_combos_piles_detect_fn</span>(</span>
<span id="cb204-4"><a href="wshed_params_test.html#cb204-4" tabindex="-1"></a>    <span class="at">chm =</span> cloud2raster_ans<span class="sc">$</span>chm_rast</span>
<span id="cb204-5"><a href="wshed_params_test.html#cb204-5" tabindex="-1"></a>    , <span class="at">param_combos_df =</span> param_combos_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">17</span>)</span>
<span id="cb204-6"><a href="wshed_params_test.html#cb204-6" tabindex="-1"></a>    , <span class="at">smooth_segs =</span> T</span>
<span id="cb204-7"><a href="wshed_params_test.html#cb204-7" tabindex="-1"></a>    , <span class="at">ofile =</span> f_temp</span>
<span id="cb204-8"><a href="wshed_params_test.html#cb204-8" tabindex="-1"></a>  )</span>
<span id="cb204-9"><a href="wshed_params_test.html#cb204-9" tabindex="-1"></a>  <span class="co"># param_combos_piles %&gt;% dplyr::glimpse()</span></span>
<span id="cb204-10"><a href="wshed_params_test.html#cb204-10" tabindex="-1"></a>  </span>
<span id="cb204-11"><a href="wshed_params_test.html#cb204-11" tabindex="-1"></a>  <span class="co"># save it</span></span>
<span id="cb204-12"><a href="wshed_params_test.html#cb204-12" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(param_combos_piles, f_temp, <span class="at">append =</span> F, <span class="at">quiet =</span> T)</span>
<span id="cb204-13"><a href="wshed_params_test.html#cb204-13" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb204-14"><a href="wshed_params_test.html#cb204-14" tabindex="-1"></a>  param_combos_piles <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(f_temp, <span class="at">quiet =</span> T)</span>
<span id="cb204-15"><a href="wshed_params_test.html#cb204-15" tabindex="-1"></a>}</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="wshed_params_test.html#cb205-1" tabindex="-1"></a>param_combos_piles <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 8,441
## Columns: 14
## $ pred_id            &lt;dbl&gt; 418, 991, 1745, 2416, 2624, 2640, 3111, 3160, 3482,…
## $ area_m2            &lt;dbl&gt; 2.56, 3.76, 3.36, 2.52, 4.86, 7.92, 3.90, 3.12, 2.4…
## $ volume_m3          &lt;dbl&gt; 9.913314, 12.710141, 12.714443, 4.286529, 13.488759…
## $ max_height_m       &lt;dbl&gt; 4.990000, 4.970000, 4.933000, 4.889250, 4.873667, 4…
## $ volume_per_area    &lt;dbl&gt; 3.872388, 3.380357, 3.784060, 1.701004, 2.775465, 3…
## $ set_id             &lt;int&gt; 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17,…
## $ diameter_m         &lt;dbl&gt; 2.163331, 2.690725, 2.720294, 2.000000, 3.440930, 4…
## $ rn                 &lt;int&gt; 473, 473, 473, 473, 473, 473, 473, 473, 473, 473, 4…
## $ max_ht_m           &lt;dbl&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, …
## $ min_area_m2        &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ max_area_m2        &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,…
## $ convexity_pct      &lt;dbl&gt; 0.9, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9, 0…
## $ circle_fit_iou_pct &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0…
## $ geom               &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((499555 4317..., MULTIP…</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="wshed_params_test.html#cb207-1" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(rn) %&gt;% dplyr::slice_head(n=6)</span></span>
<span id="cb207-2"><a href="wshed_params_test.html#cb207-2" tabindex="-1"></a><span class="co"># terra::plot(cloud2raster_ans$chm_rast, col = viridis::plasma(100), axes = F)</span></span>
<span id="cb207-3"><a href="wshed_params_test.html#cb207-3" tabindex="-1"></a><span class="co"># terra::plot(param_combos_piles %&gt;% dplyr::filter(rn==param_combos_piles$rn[2222]) %&gt;% terra::vect(),add = T, border = &quot;gray44&quot;, col = NA, lwd = 3)</span></span></code></pre></div>
<p>we should have predicted piles for each parameter combination tested so a row is unique by the combination of all of the variables in the <code>param_combos_df</code> data frame and the pile detected. we expect the number of piles detected to vary by these different parameter settings where the number of parameter settings should match the number of samples we selected.</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="wshed_params_test.html#cb208-1" tabindex="-1"></a>param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb208-2"><a href="wshed_params_test.html#cb208-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb208-3"><a href="wshed_params_test.html#cb208-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(rn)</span></code></pre></div>
<pre><code>##     rn    n
## 1    1  597
## 2   13  331
## 3   94  141
## 4  173  149
## 5  199  133
## 6  246  190
## 7  276  796
## 8  313  575
## 9  338  601
## 10 361  984
## 11 408  619
## 12 423  203
## 13 473  192
## 14 508  733
## 15 526 1169
## 16 559  287
## 17 588  741</code></pre>
<p>which is equivalent to</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="wshed_params_test.html#cb210-1" tabindex="-1"></a>param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb210-2"><a href="wshed_params_test.html#cb210-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb210-3"><a href="wshed_params_test.html#cb210-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(max_ht_m,min_area_m2,max_area_m2,convexity_pct,circle_fit_iou_pct)</span></code></pre></div>
<pre><code>##    max_ht_m min_area_m2 max_area_m2 convexity_pct circle_fit_iou_pct    n
## 1         2           2          10           0.1                0.1  597
## 2         2           2          10           0.5                0.5  331
## 3         2           2          40           0.7                0.7  141
## 4         3           2          10           0.9                0.5  149
## 5         3           2          20           0.9                0.7  133
## 6         3           2          40           0.9                0.1  190
## 7         3           2          60           0.1                0.1  796
## 8         4           2          10           0.5                0.5  575
## 9         4           2          20           0.5                0.5  601
## 10        4           2          30           0.5                0.1  984
## 11        4           2          50           0.3                0.5  619
## 12        4           2          50           0.9                0.5  203
## 13        5           2          10           0.9                0.5  192
## 14        5           2          30           0.3                0.5  733
## 15        5           2          40           0.1                0.1 1169
## 16        5           2          50           0.3                0.7  287
## 17        5           2          60           0.5                0.5  741</code></pre>
</div>
<div id="test-instance-matching" class="section level3 hasAnchor" number="7.1.2">
<h3><span class="header-section-number">7.1.2</span> Test Instance Matching<a href="wshed_params_test.html#test-instance-matching" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s see how we did with the full data fusion predictions compared to the ground truth data using the instance matching process we outlined in this <a href="method-evaluation.html#iou_match">earlier section</a>. here we validate the segments from these combinations against the ground truth data and we can map over the <code>ground_truth_prediction_match()</code> function to get true positive, false positive (commission), and false negative (omission) classifications for the predicted and ground truth piles</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="wshed_params_test.html#cb212-1" tabindex="-1"></a>f_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/testtest_param_combos_gt.csv&quot;</span></span>
<span id="cb212-2"><a href="wshed_params_test.html#cb212-2" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(f_temp)){</span>
<span id="cb212-3"><a href="wshed_params_test.html#cb212-3" tabindex="-1"></a>  param_combos_gt <span class="ot">&lt;-</span> </span>
<span id="cb212-4"><a href="wshed_params_test.html#cb212-4" tabindex="-1"></a>    <span class="fu">unique</span>(param_combos_piles<span class="sc">$</span>rn) <span class="sc">%&gt;%</span> </span>
<span id="cb212-5"><a href="wshed_params_test.html#cb212-5" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb212-6"><a href="wshed_params_test.html#cb212-6" tabindex="-1"></a>      <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb212-7"><a href="wshed_params_test.html#cb212-7" tabindex="-1"></a>        <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb212-8"><a href="wshed_params_test.html#cb212-8" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb212-9"><a href="wshed_params_test.html#cb212-9" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(field_diameter_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb212-10"><a href="wshed_params_test.html#cb212-10" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb212-11"><a href="wshed_params_test.html#cb212-11" tabindex="-1"></a>        , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb212-12"><a href="wshed_params_test.html#cb212-12" tabindex="-1"></a>        , <span class="at">predictions =</span> param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb212-13"><a href="wshed_params_test.html#cb212-13" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb212-14"><a href="wshed_params_test.html#cb212-14" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb212-15"><a href="wshed_params_test.html#cb212-15" tabindex="-1"></a>            pred_id <span class="sc">%in%</span> (param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb212-16"><a href="wshed_params_test.html#cb212-16" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb212-17"><a href="wshed_params_test.html#cb212-17" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb212-18"><a href="wshed_params_test.html#cb212-18" tabindex="-1"></a>                stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb212-19"><a href="wshed_params_test.html#cb212-19" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb212-20"><a href="wshed_params_test.html#cb212-20" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-21"><a href="wshed_params_test.html#cb212-21" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb212-22"><a href="wshed_params_test.html#cb212-22" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id))</span>
<span id="cb212-23"><a href="wshed_params_test.html#cb212-23" tabindex="-1"></a>          )</span>
<span id="cb212-24"><a href="wshed_params_test.html#cb212-24" tabindex="-1"></a>        , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb212-25"><a href="wshed_params_test.html#cb212-25" tabindex="-1"></a>        , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb212-26"><a href="wshed_params_test.html#cb212-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-27"><a href="wshed_params_test.html#cb212-27" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn=</span>x)</span>
<span id="cb212-28"><a href="wshed_params_test.html#cb212-28" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-29"><a href="wshed_params_test.html#cb212-29" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb212-30"><a href="wshed_params_test.html#cb212-30" tabindex="-1"></a>  param_combos_gt <span class="sc">%&gt;%</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(f_temp, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span>
<span id="cb212-31"><a href="wshed_params_test.html#cb212-31" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb212-32"><a href="wshed_params_test.html#cb212-32" tabindex="-1"></a>  param_combos_gt <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(f_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb212-33"><a href="wshed_params_test.html#cb212-33" tabindex="-1"></a>}</span>
<span id="cb212-34"><a href="wshed_params_test.html#cb212-34" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb212-35"><a href="wshed_params_test.html#cb212-35" tabindex="-1"></a>param_combos_gt <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span>
<span id="cb212-36"><a href="wshed_params_test.html#cb212-36" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::filter(pile_id==120)</span></span></code></pre></div>
</div>
<div id="test-accuracy" class="section level3 hasAnchor" number="7.1.3">
<h3><span class="header-section-number">7.1.3</span> Test Accuracy<a href="wshed_params_test.html#test-accuracy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><a href="method-evaluation.html#quant_metrics_form">earlier</a>, we defined a function (<code>agg_ground_truth_match()</code>) to prepare our results for analysis by developing a function that aggregates the single-pile-level data into a single record for each parameter combination. this function will calculate detection performance metrics such as F-score, precision, and recall (using the <code>confusion_matrix_scores_fn()</code> we defined above), as well as quantification accuracy metrics including Root Mean Squared Error (RMSE), Mean Error (ME), and Mean Absolute Percentage Error (MAPE) to assess the accuracy of our pile form measurements. this could be a valuable function for any future analysis comparing predictions to ground truth data.</p>
<p>the <code>agg_ground_truth_match()</code> function looks for columns with the prefix “diff_” to calculate the mean error (ME) and the RMSE while columns with the prefix “pct_diff_” enable the function to calculate the mean absolute percent error (MAPE)…let’s make those columns</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="wshed_params_test.html#cb213-1" tabindex="-1"></a><span class="co"># let&#39;s attach a flag to only work with piles that intersect with the stand boundary</span></span>
<span id="cb213-2"><a href="wshed_params_test.html#cb213-2" tabindex="-1"></a><span class="co"># and caclulate the &quot;diameter&quot; of the piles</span></span>
<span id="cb213-3"><a href="wshed_params_test.html#cb213-3" tabindex="-1"></a><span class="co"># add in/out to piles data</span></span>
<span id="cb213-4"><a href="wshed_params_test.html#cb213-4" tabindex="-1"></a>param_combos_piles <span class="ot">&lt;-</span> </span>
<span id="cb213-5"><a href="wshed_params_test.html#cb213-5" tabindex="-1"></a>  param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb213-6"><a href="wshed_params_test.html#cb213-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb213-7"><a href="wshed_params_test.html#cb213-7" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb213-8"><a href="wshed_params_test.html#cb213-8" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb213-9"><a href="wshed_params_test.html#cb213-9" tabindex="-1"></a>        stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb213-10"><a href="wshed_params_test.html#cb213-10" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb213-11"><a href="wshed_params_test.html#cb213-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb213-12"><a href="wshed_params_test.html#cb213-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb213-13"><a href="wshed_params_test.html#cb213-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(rn,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb213-14"><a href="wshed_params_test.html#cb213-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_in_stand =</span> T)</span>
<span id="cb213-15"><a href="wshed_params_test.html#cb213-15" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb213-16"><a href="wshed_params_test.html#cb213-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb213-17"><a href="wshed_params_test.html#cb213-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb213-18"><a href="wshed_params_test.html#cb213-18" tabindex="-1"></a>    <span class="at">is_in_stand =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_in_stand,F)</span>
<span id="cb213-19"><a href="wshed_params_test.html#cb213-19" tabindex="-1"></a>  )</span>
<span id="cb213-20"><a href="wshed_params_test.html#cb213-20" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% dplyr::glimpse()</span></span>
<span id="cb213-21"><a href="wshed_params_test.html#cb213-21" tabindex="-1"></a></span>
<span id="cb213-22"><a href="wshed_params_test.html#cb213-22" tabindex="-1"></a><span class="co"># add it to validation</span></span>
<span id="cb213-23"><a href="wshed_params_test.html#cb213-23" tabindex="-1"></a>param_combos_gt <span class="ot">&lt;-</span></span>
<span id="cb213-24"><a href="wshed_params_test.html#cb213-24" tabindex="-1"></a>  param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb213-25"><a href="wshed_params_test.html#cb213-25" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id =</span> <span class="fu">as.numeric</span>(pile_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb213-26"><a href="wshed_params_test.html#cb213-26" tabindex="-1"></a>  <span class="co"># add area of gt</span></span>
<span id="cb213-27"><a href="wshed_params_test.html#cb213-27" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb213-28"><a href="wshed_params_test.html#cb213-28" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb213-29"><a href="wshed_params_test.html#cb213-29" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb213-30"><a href="wshed_params_test.html#cb213-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,image_gt_area_m2,height_m,field_diameter_m) <span class="sc">%&gt;%</span> </span>
<span id="cb213-31"><a href="wshed_params_test.html#cb213-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb213-32"><a href="wshed_params_test.html#cb213-32" tabindex="-1"></a>        <span class="at">gt_height_m =</span> height_m</span>
<span id="cb213-33"><a href="wshed_params_test.html#cb213-33" tabindex="-1"></a>        , <span class="at">gt_diameter_m =</span> field_diameter_m</span>
<span id="cb213-34"><a href="wshed_params_test.html#cb213-34" tabindex="-1"></a>        , <span class="at">gt_area_m2 =</span> image_gt_area_m2</span>
<span id="cb213-35"><a href="wshed_params_test.html#cb213-35" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb213-36"><a href="wshed_params_test.html#cb213-36" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id=</span><span class="fu">as.numeric</span>(pile_id))</span>
<span id="cb213-37"><a href="wshed_params_test.html#cb213-37" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb213-38"><a href="wshed_params_test.html#cb213-38" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb213-39"><a href="wshed_params_test.html#cb213-39" tabindex="-1"></a>  <span class="co"># add info from predictions</span></span>
<span id="cb213-40"><a href="wshed_params_test.html#cb213-40" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb213-41"><a href="wshed_params_test.html#cb213-41" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span></span>
<span id="cb213-42"><a href="wshed_params_test.html#cb213-42" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb213-43"><a href="wshed_params_test.html#cb213-43" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb213-44"><a href="wshed_params_test.html#cb213-44" tabindex="-1"></a>        rn,pred_id</span>
<span id="cb213-45"><a href="wshed_params_test.html#cb213-45" tabindex="-1"></a>        ,is_in_stand</span>
<span id="cb213-46"><a href="wshed_params_test.html#cb213-46" tabindex="-1"></a>        , area_m2, volume_m3, max_height_m, diameter_m</span>
<span id="cb213-47"><a href="wshed_params_test.html#cb213-47" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb213-48"><a href="wshed_params_test.html#cb213-48" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb213-49"><a href="wshed_params_test.html#cb213-49" tabindex="-1"></a>        <span class="at">pred_area_m2 =</span> area_m2</span>
<span id="cb213-50"><a href="wshed_params_test.html#cb213-50" tabindex="-1"></a>        , <span class="at">pred_height_m =</span> max_height_m</span>
<span id="cb213-51"><a href="wshed_params_test.html#cb213-51" tabindex="-1"></a>        , <span class="at">pred_diameter_m =</span> diameter_m</span>
<span id="cb213-52"><a href="wshed_params_test.html#cb213-52" tabindex="-1"></a>      )</span>
<span id="cb213-53"><a href="wshed_params_test.html#cb213-53" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb213-54"><a href="wshed_params_test.html#cb213-54" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb213-55"><a href="wshed_params_test.html#cb213-55" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb213-56"><a href="wshed_params_test.html#cb213-56" tabindex="-1"></a>    <span class="at">is_in_stand =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb213-57"><a href="wshed_params_test.html#cb213-57" tabindex="-1"></a>      is_in_stand <span class="sc">==</span> T <span class="sc">~</span> T</span>
<span id="cb213-58"><a href="wshed_params_test.html#cb213-58" tabindex="-1"></a>      , is_in_stand <span class="sc">==</span> F <span class="sc">~</span> F</span>
<span id="cb213-59"><a href="wshed_params_test.html#cb213-59" tabindex="-1"></a>      , match_grp <span class="sc">==</span> <span class="st">&quot;omission&quot;</span> <span class="sc">~</span> T</span>
<span id="cb213-60"><a href="wshed_params_test.html#cb213-60" tabindex="-1"></a>      , T <span class="sc">~</span> F</span>
<span id="cb213-61"><a href="wshed_params_test.html#cb213-61" tabindex="-1"></a>    )</span>
<span id="cb213-62"><a href="wshed_params_test.html#cb213-62" tabindex="-1"></a>    <span class="do">### calculate these based on the formulas below...agg_ground_truth_match() depends on those formulas</span></span>
<span id="cb213-63"><a href="wshed_params_test.html#cb213-63" tabindex="-1"></a>    <span class="co"># ht diffs</span></span>
<span id="cb213-64"><a href="wshed_params_test.html#cb213-64" tabindex="-1"></a>    , <span class="at">diff_height_m =</span> pred_height_m<span class="sc">-</span>gt_height_m</span>
<span id="cb213-65"><a href="wshed_params_test.html#cb213-65" tabindex="-1"></a>    , <span class="at">pct_diff_height_m =</span> (gt_height_m<span class="sc">-</span>pred_height_m)<span class="sc">/</span>gt_height_m</span>
<span id="cb213-66"><a href="wshed_params_test.html#cb213-66" tabindex="-1"></a>    <span class="co"># diameter</span></span>
<span id="cb213-67"><a href="wshed_params_test.html#cb213-67" tabindex="-1"></a>    , <span class="at">diff_diameter_m =</span> pred_diameter_m<span class="sc">-</span>gt_diameter_m</span>
<span id="cb213-68"><a href="wshed_params_test.html#cb213-68" tabindex="-1"></a>    , <span class="at">pct_diff_diameter_m =</span> (gt_diameter_m<span class="sc">-</span>pred_diameter_m)<span class="sc">/</span>gt_diameter_m</span>
<span id="cb213-69"><a href="wshed_params_test.html#cb213-69" tabindex="-1"></a>    <span class="co"># area diffs</span></span>
<span id="cb213-70"><a href="wshed_params_test.html#cb213-70" tabindex="-1"></a>    , <span class="at">diff_area_m2 =</span> pred_area_m2<span class="sc">-</span>gt_area_m2</span>
<span id="cb213-71"><a href="wshed_params_test.html#cb213-71" tabindex="-1"></a>    , <span class="at">pct_diff_area_m2 =</span> (gt_area_m2<span class="sc">-</span>pred_area_m2)<span class="sc">/</span>gt_area_m2</span>
<span id="cb213-72"><a href="wshed_params_test.html#cb213-72" tabindex="-1"></a>  )</span>
<span id="cb213-73"><a href="wshed_params_test.html#cb213-73" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb213-74"><a href="wshed_params_test.html#cb213-74" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>now let’s apply the <code>agg_ground_truth_match()</code> function at the parameter combination level</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="wshed_params_test.html#cb214-1" tabindex="-1"></a>param_combos_gt_agg <span class="ot">&lt;-</span> <span class="fu">unique</span>(param_combos_gt<span class="sc">$</span>rn) <span class="sc">%&gt;%</span> </span>
<span id="cb214-2"><a href="wshed_params_test.html#cb214-2" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb214-3"><a href="wshed_params_test.html#cb214-3" tabindex="-1"></a>    <span class="fu">agg_ground_truth_match</span>(</span>
<span id="cb214-4"><a href="wshed_params_test.html#cb214-4" tabindex="-1"></a>      param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb214-5"><a href="wshed_params_test.html#cb214-5" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb214-6"><a href="wshed_params_test.html#cb214-6" tabindex="-1"></a>          is_in_stand</span>
<span id="cb214-7"><a href="wshed_params_test.html#cb214-7" tabindex="-1"></a>          <span class="sc">&amp;</span> rn <span class="sc">==</span> x</span>
<span id="cb214-8"><a href="wshed_params_test.html#cb214-8" tabindex="-1"></a>        )</span>
<span id="cb214-9"><a href="wshed_params_test.html#cb214-9" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb214-10"><a href="wshed_params_test.html#cb214-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn =</span> x)</span>
<span id="cb214-11"><a href="wshed_params_test.html#cb214-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb214-12"><a href="wshed_params_test.html#cb214-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb214-13"><a href="wshed_params_test.html#cb214-13" tabindex="-1"></a>  <span class="co"># add in info on all parameter combinations</span></span>
<span id="cb214-14"><a href="wshed_params_test.html#cb214-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb214-15"><a href="wshed_params_test.html#cb214-15" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb214-16"><a href="wshed_params_test.html#cb214-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb214-17"><a href="wshed_params_test.html#cb214-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(</span>
<span id="cb214-18"><a href="wshed_params_test.html#cb214-18" tabindex="-1"></a>      rn,max_ht_m,min_area_m2,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb214-19"><a href="wshed_params_test.html#cb214-19" tabindex="-1"></a>    )</span>
<span id="cb214-20"><a href="wshed_params_test.html#cb214-20" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb214-21"><a href="wshed_params_test.html#cb214-21" tabindex="-1"></a>    , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb214-22"><a href="wshed_params_test.html#cb214-22" tabindex="-1"></a>  )</span>
<span id="cb214-23"><a href="wshed_params_test.html#cb214-23" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb214-24"><a href="wshed_params_test.html#cb214-24" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 17
## Columns: 23
## $ tp_n                     &lt;dbl&gt; 83, 66, 116, 114, 78, 113, 94, 103, 95, 80, 7…
## $ fp_n                     &lt;dbl&gt; 33, 10, 156, 329, 53, 258, 138, 140, 14, 12, …
## $ fn_n                     &lt;dbl&gt; 38, 55, 5, 7, 43, 8, 27, 18, 26, 41, 45, 10, …
## $ omission_rate            &lt;dbl&gt; 0.31404959, 0.45454545, 0.04132231, 0.0578512…
## $ commission_rate          &lt;dbl&gt; 0.28448276, 0.13157895, 0.57352941, 0.7426636…
## $ precision                &lt;dbl&gt; 0.7155172, 0.8684211, 0.4264706, 0.2573363, 0…
## $ recall                   &lt;dbl&gt; 0.6859504, 0.5454545, 0.9586777, 0.9421488, 0…
## $ f_score                  &lt;dbl&gt; 0.7004219, 0.6700508, 0.5903308, 0.4042553, 0…
## $ diff_area_m2_rmse        &lt;dbl&gt; 0.9177856, 1.0318250, 2.7307986, 2.0816764, 1…
## $ diff_diameter_m_rmse     &lt;dbl&gt; 0.5356816, 0.5909564, 0.8223519, 0.8535298, 0…
## $ diff_height_m_rmse       &lt;dbl&gt; 0.4736971, 0.4941902, 0.7271534, 0.6431814, 0…
## $ diff_area_m2_mean        &lt;dbl&gt; 0.4754762, 0.6257658, 0.6015038, 0.7216610, 0…
## $ diff_diameter_m_mean     &lt;dbl&gt; 0.3976082, 0.4047071, 0.5242729, 0.5515058, 0…
## $ diff_height_m_mean       &lt;dbl&gt; 0.026860245, -0.274133330, -0.116632762, 0.00…
## $ pct_diff_area_m2_mape    &lt;dbl&gt; 0.1116297, 0.1209130, 0.1491131, 0.1503765, 0…
## $ pct_diff_diameter_m_mape &lt;dbl&gt; 0.1512180, 0.1615222, 0.1834563, 0.1948854, 0…
## $ pct_diff_height_m_mape   &lt;dbl&gt; 0.1904217, 0.1385338, 0.2001751, 0.2095256, 0…
## $ rn                       &lt;dbl&gt; 473, 94, 276, 526, 13, 361, 313, 338, 246, 17…
## $ max_ht_m                 &lt;dbl&gt; 5, 2, 3, 5, 2, 4, 4, 4, 3, 3, 3, 5, 4, 5, 5, …
## $ min_area_m2              &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ max_area_m2              &lt;dbl&gt; 10, 40, 60, 40, 10, 30, 10, 20, 40, 10, 20, 6…
## $ convexity_pct            &lt;dbl&gt; 0.9, 0.7, 0.1, 0.1, 0.5, 0.5, 0.5, 0.5, 0.9, …
## $ circle_fit_iou_pct       &lt;dbl&gt; 0.5, 0.7, 0.1, 0.1, 0.5, 0.1, 0.5, 0.5, 0.1, …</code></pre>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="wshed_params_test.html#cb216-1" tabindex="-1"></a><span class="co"># param_combos_gt_agg %&gt;% readr::write_csv(&quot;c:/Users/georg/Downloads/param_combos_gt_agg.csv&quot;)</span></span>
<span id="cb216-2"><a href="wshed_params_test.html#cb216-2" tabindex="-1"></a><span class="co"># param_combos_gt_agg %&gt;% dplyr::select(f_score,precision,recall,tidyselect::ends_with(&quot;_n&quot;)) %&gt;% dplyr::mutate(gt_n=tp_n+fn_n)</span></span></code></pre></div>
<div id="test-accuracy-insights" class="section level4 hasAnchor" number="7.1.3.1">
<h4><span class="header-section-number">7.1.3.1</span> Test Accuracy Insights<a href="wshed_params_test.html#test-accuracy-insights" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>lets’ make some plotting functions to glean some insight into the distribution of the accuracies obtained from our full set of sensitivity testing point estimates</p>
<p>first, we’ll make a function to plot the distribution of F-score, Recall, and Precision values obtained in our sensitivity testing</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="wshed_params_test.html#cb217-1" tabindex="-1"></a><span class="co"># this is a lot of work, so we&#39;re going to make it a function</span></span>
<span id="cb217-2"><a href="wshed_params_test.html#cb217-2" tabindex="-1"></a>plt_detection_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb217-3"><a href="wshed_params_test.html#cb217-3" tabindex="-1"></a>  df</span>
<span id="cb217-4"><a href="wshed_params_test.html#cb217-4" tabindex="-1"></a>  , <span class="at">my_subtitle =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb217-5"><a href="wshed_params_test.html#cb217-5" tabindex="-1"></a>  , <span class="at">show_rug =</span> T</span>
<span id="cb217-6"><a href="wshed_params_test.html#cb217-6" tabindex="-1"></a>) {</span>
<span id="cb217-7"><a href="wshed_params_test.html#cb217-7" tabindex="-1"></a>  pal_eval_metric <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb217-8"><a href="wshed_params_test.html#cb217-8" tabindex="-1"></a>    RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Oranges&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb217-9"><a href="wshed_params_test.html#cb217-9" tabindex="-1"></a>    , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Greys&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb217-10"><a href="wshed_params_test.html#cb217-10" tabindex="-1"></a>    , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Purples&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb217-11"><a href="wshed_params_test.html#cb217-11" tabindex="-1"></a>  )</span>
<span id="cb217-12"><a href="wshed_params_test.html#cb217-12" tabindex="-1"></a>  </span>
<span id="cb217-13"><a href="wshed_params_test.html#cb217-13" tabindex="-1"></a>  df_temp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb217-14"><a href="wshed_params_test.html#cb217-14" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb217-15"><a href="wshed_params_test.html#cb217-15" tabindex="-1"></a>      <span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)</span>
<span id="cb217-16"><a href="wshed_params_test.html#cb217-16" tabindex="-1"></a>      , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb217-17"><a href="wshed_params_test.html#cb217-17" tabindex="-1"></a>      , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb217-18"><a href="wshed_params_test.html#cb217-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb217-19"><a href="wshed_params_test.html#cb217-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb217-20"><a href="wshed_params_test.html#cb217-20" tabindex="-1"></a>      <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb217-21"><a href="wshed_params_test.html#cb217-21" tabindex="-1"></a>          metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb217-22"><a href="wshed_params_test.html#cb217-22" tabindex="-1"></a>          , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb217-23"><a href="wshed_params_test.html#cb217-23" tabindex="-1"></a>          , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb217-24"><a href="wshed_params_test.html#cb217-24" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb217-25"><a href="wshed_params_test.html#cb217-25" tabindex="-1"></a>        <span class="fu">factor</span>(</span>
<span id="cb217-26"><a href="wshed_params_test.html#cb217-26" tabindex="-1"></a>          <span class="at">ordered =</span> T</span>
<span id="cb217-27"><a href="wshed_params_test.html#cb217-27" tabindex="-1"></a>          , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb217-28"><a href="wshed_params_test.html#cb217-28" tabindex="-1"></a>          , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb217-29"><a href="wshed_params_test.html#cb217-29" tabindex="-1"></a>            <span class="st">&quot;F-score&quot;</span></span>
<span id="cb217-30"><a href="wshed_params_test.html#cb217-30" tabindex="-1"></a>            , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb217-31"><a href="wshed_params_test.html#cb217-31" tabindex="-1"></a>            , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb217-32"><a href="wshed_params_test.html#cb217-32" tabindex="-1"></a>          )</span>
<span id="cb217-33"><a href="wshed_params_test.html#cb217-33" tabindex="-1"></a>        )</span>
<span id="cb217-34"><a href="wshed_params_test.html#cb217-34" tabindex="-1"></a>    ) </span>
<span id="cb217-35"><a href="wshed_params_test.html#cb217-35" tabindex="-1"></a>  </span>
<span id="cb217-36"><a href="wshed_params_test.html#cb217-36" tabindex="-1"></a>  <span class="co"># plot </span></span>
<span id="cb217-37"><a href="wshed_params_test.html#cb217-37" tabindex="-1"></a>  <span class="co"># if(nrow(df)&lt;=15 &amp;&amp; (df_temp %&gt;% dplyr::count(metric,value) %&gt;% dplyr::pull(n) %&gt;% max())&gt;1 ){</span></span>
<span id="cb217-38"><a href="wshed_params_test.html#cb217-38" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(df)<span class="sc">&lt;=</span><span class="dv">15</span>){</span>
<span id="cb217-39"><a href="wshed_params_test.html#cb217-39" tabindex="-1"></a>    <span class="co"># round</span></span>
<span id="cb217-40"><a href="wshed_params_test.html#cb217-40" tabindex="-1"></a>    df_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb217-41"><a href="wshed_params_test.html#cb217-41" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb217-42"><a href="wshed_params_test.html#cb217-42" tabindex="-1"></a>        <span class="at">value =</span> <span class="fu">round</span>(value,<span class="dv">2</span>)</span>
<span id="cb217-43"><a href="wshed_params_test.html#cb217-43" tabindex="-1"></a>      )</span>
<span id="cb217-44"><a href="wshed_params_test.html#cb217-44" tabindex="-1"></a>    <span class="co"># agg for median plotting</span></span>
<span id="cb217-45"><a href="wshed_params_test.html#cb217-45" tabindex="-1"></a>      xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb217-46"><a href="wshed_params_test.html#cb217-46" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(metric) <span class="sc">%&gt;%</span> </span>
<span id="cb217-47"><a href="wshed_params_test.html#cb217-47" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb217-48"><a href="wshed_params_test.html#cb217-48" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb217-49"><a href="wshed_params_test.html#cb217-49" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb217-50"><a href="wshed_params_test.html#cb217-50" tabindex="-1"></a>          <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb217-51"><a href="wshed_params_test.html#cb217-51" tabindex="-1"></a>            <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb217-52"><a href="wshed_params_test.html#cb217-52" tabindex="-1"></a>            , scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb217-53"><a href="wshed_params_test.html#cb217-53" tabindex="-1"></a>          )</span>
<span id="cb217-54"><a href="wshed_params_test.html#cb217-54" tabindex="-1"></a>        )</span>
<span id="cb217-55"><a href="wshed_params_test.html#cb217-55" tabindex="-1"></a>    </span>
<span id="cb217-56"><a href="wshed_params_test.html#cb217-56" tabindex="-1"></a>    <span class="co"># plot </span></span>
<span id="cb217-57"><a href="wshed_params_test.html#cb217-57" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb217-58"><a href="wshed_params_test.html#cb217-58" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">count</span>(metric,value) <span class="sc">%&gt;%</span> </span>
<span id="cb217-59"><a href="wshed_params_test.html#cb217-59" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb217-60"><a href="wshed_params_test.html#cb217-60" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric, <span class="at">color =</span> metric)</span>
<span id="cb217-61"><a href="wshed_params_test.html#cb217-61" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-62"><a href="wshed_params_test.html#cb217-62" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb217-63"><a href="wshed_params_test.html#cb217-63" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb217-64"><a href="wshed_params_test.html#cb217-64" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb217-65"><a href="wshed_params_test.html#cb217-65" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb217-66"><a href="wshed_params_test.html#cb217-66" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-67"><a href="wshed_params_test.html#cb217-67" tabindex="-1"></a>      <span class="co"># ggplot2::geom_jitter(mapping = ggplot2::aes(y=-0.2), width = 0, height = 0.1) +</span></span>
<span id="cb217-68"><a href="wshed_params_test.html#cb217-68" tabindex="-1"></a>      <span class="co"># ggplot2::geom_boxplot(width = 0.1, color = &quot;black&quot;, fill = NA, outliers = F) +</span></span>
<span id="cb217-69"><a href="wshed_params_test.html#cb217-69" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb217-70"><a href="wshed_params_test.html#cb217-70" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">yend=</span><span class="dv">0</span>)</span>
<span id="cb217-71"><a href="wshed_params_test.html#cb217-71" tabindex="-1"></a>        , <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb217-72"><a href="wshed_params_test.html#cb217-72" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-73"><a href="wshed_params_test.html#cb217-73" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb217-74"><a href="wshed_params_test.html#cb217-74" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n)</span>
<span id="cb217-75"><a href="wshed_params_test.html#cb217-75" tabindex="-1"></a>        , <span class="at">alpha =</span> <span class="dv">1</span></span>
<span id="cb217-76"><a href="wshed_params_test.html#cb217-76" tabindex="-1"></a>        , <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb217-77"><a href="wshed_params_test.html#cb217-77" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-78"><a href="wshed_params_test.html#cb217-78" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb217-79"><a href="wshed_params_test.html#cb217-79" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">label=</span>n)</span>
<span id="cb217-80"><a href="wshed_params_test.html#cb217-80" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb217-81"><a href="wshed_params_test.html#cb217-81" tabindex="-1"></a>        <span class="co"># , vjust = -0.01</span></span>
<span id="cb217-82"><a href="wshed_params_test.html#cb217-82" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-83"><a href="wshed_params_test.html#cb217-83" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb217-84"><a href="wshed_params_test.html#cb217-84" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb217-85"><a href="wshed_params_test.html#cb217-85" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb217-86"><a href="wshed_params_test.html#cb217-86" tabindex="-1"></a>          <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb217-87"><a href="wshed_params_test.html#cb217-87" tabindex="-1"></a>          <span class="co"># x = value, y = 0</span></span>
<span id="cb217-88"><a href="wshed_params_test.html#cb217-88" tabindex="-1"></a>          , <span class="at">label =</span> value_lab</span>
<span id="cb217-89"><a href="wshed_params_test.html#cb217-89" tabindex="-1"></a>        )</span>
<span id="cb217-90"><a href="wshed_params_test.html#cb217-90" tabindex="-1"></a>        , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb217-91"><a href="wshed_params_test.html#cb217-91" tabindex="-1"></a>        <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb217-92"><a href="wshed_params_test.html#cb217-92" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb217-93"><a href="wshed_params_test.html#cb217-93" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-94"><a href="wshed_params_test.html#cb217-94" tabindex="-1"></a>      <span class="co"># ggplot2::geom_rug() +</span></span>
<span id="cb217-95"><a href="wshed_params_test.html#cb217-95" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb217-96"><a href="wshed_params_test.html#cb217-96" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb217-97"><a href="wshed_params_test.html#cb217-97" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb217-98"><a href="wshed_params_test.html#cb217-98" tabindex="-1"></a>        <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb217-99"><a href="wshed_params_test.html#cb217-99" tabindex="-1"></a>        <span class="co"># , limits = c(0,1)</span></span>
<span id="cb217-100"><a href="wshed_params_test.html#cb217-100" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-101"><a href="wshed_params_test.html#cb217-101" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb217-102"><a href="wshed_params_test.html#cb217-102" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb217-103"><a href="wshed_params_test.html#cb217-103" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb217-104"><a href="wshed_params_test.html#cb217-104" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb217-105"><a href="wshed_params_test.html#cb217-105" tabindex="-1"></a>        , <span class="at">subtitle =</span> my_subtitle</span>
<span id="cb217-106"><a href="wshed_params_test.html#cb217-106" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-107"><a href="wshed_params_test.html#cb217-107" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb217-108"><a href="wshed_params_test.html#cb217-108" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb217-109"><a href="wshed_params_test.html#cb217-109" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb217-110"><a href="wshed_params_test.html#cb217-110" tabindex="-1"></a>        , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb217-111"><a href="wshed_params_test.html#cb217-111" tabindex="-1"></a>        , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb217-112"><a href="wshed_params_test.html#cb217-112" tabindex="-1"></a>        , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-113"><a href="wshed_params_test.html#cb217-113" tabindex="-1"></a>        , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-114"><a href="wshed_params_test.html#cb217-114" tabindex="-1"></a>        , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-115"><a href="wshed_params_test.html#cb217-115" tabindex="-1"></a>        , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-116"><a href="wshed_params_test.html#cb217-116" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb217-117"><a href="wshed_params_test.html#cb217-117" tabindex="-1"></a>      )</span>
<span id="cb217-118"><a href="wshed_params_test.html#cb217-118" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb217-119"><a href="wshed_params_test.html#cb217-119" tabindex="-1"></a>    <span class="co"># agg for median plotting</span></span>
<span id="cb217-120"><a href="wshed_params_test.html#cb217-120" tabindex="-1"></a>      xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb217-121"><a href="wshed_params_test.html#cb217-121" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(metric) <span class="sc">%&gt;%</span> </span>
<span id="cb217-122"><a href="wshed_params_test.html#cb217-122" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb217-123"><a href="wshed_params_test.html#cb217-123" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb217-124"><a href="wshed_params_test.html#cb217-124" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb217-125"><a href="wshed_params_test.html#cb217-125" tabindex="-1"></a>          <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb217-126"><a href="wshed_params_test.html#cb217-126" tabindex="-1"></a>            <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb217-127"><a href="wshed_params_test.html#cb217-127" tabindex="-1"></a>            , scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb217-128"><a href="wshed_params_test.html#cb217-128" tabindex="-1"></a>          )</span>
<span id="cb217-129"><a href="wshed_params_test.html#cb217-129" tabindex="-1"></a>        )</span>
<span id="cb217-130"><a href="wshed_params_test.html#cb217-130" tabindex="-1"></a>  </span>
<span id="cb217-131"><a href="wshed_params_test.html#cb217-131" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb217-132"><a href="wshed_params_test.html#cb217-132" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb217-133"><a href="wshed_params_test.html#cb217-133" tabindex="-1"></a>        <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric, <span class="at">color =</span> metric)</span>
<span id="cb217-134"><a href="wshed_params_test.html#cb217-134" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-135"><a href="wshed_params_test.html#cb217-135" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb217-136"><a href="wshed_params_test.html#cb217-136" tabindex="-1"></a>      <span class="co"># ggplot2::geom_rug(</span></span>
<span id="cb217-137"><a href="wshed_params_test.html#cb217-137" tabindex="-1"></a>      <span class="co">#   # # setting these makes the plotting more computationally intensive</span></span>
<span id="cb217-138"><a href="wshed_params_test.html#cb217-138" tabindex="-1"></a>      <span class="co">#   # alpha = 0.5</span></span>
<span id="cb217-139"><a href="wshed_params_test.html#cb217-139" tabindex="-1"></a>      <span class="co">#   # , length = ggplot2::unit(0.01, &quot;npc&quot;)</span></span>
<span id="cb217-140"><a href="wshed_params_test.html#cb217-140" tabindex="-1"></a>      <span class="co"># ) +</span></span>
<span id="cb217-141"><a href="wshed_params_test.html#cb217-141" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb217-142"><a href="wshed_params_test.html#cb217-142" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb217-143"><a href="wshed_params_test.html#cb217-143" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb217-144"><a href="wshed_params_test.html#cb217-144" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb217-145"><a href="wshed_params_test.html#cb217-145" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-146"><a href="wshed_params_test.html#cb217-146" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb217-147"><a href="wshed_params_test.html#cb217-147" tabindex="-1"></a>        <span class="at">data =</span> xxxdf_temp</span>
<span id="cb217-148"><a href="wshed_params_test.html#cb217-148" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb217-149"><a href="wshed_params_test.html#cb217-149" tabindex="-1"></a>          <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb217-150"><a href="wshed_params_test.html#cb217-150" tabindex="-1"></a>          <span class="co"># x = value, y = 0</span></span>
<span id="cb217-151"><a href="wshed_params_test.html#cb217-151" tabindex="-1"></a>          , <span class="at">label =</span> value_lab</span>
<span id="cb217-152"><a href="wshed_params_test.html#cb217-152" tabindex="-1"></a>        )</span>
<span id="cb217-153"><a href="wshed_params_test.html#cb217-153" tabindex="-1"></a>        , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb217-154"><a href="wshed_params_test.html#cb217-154" tabindex="-1"></a>        <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb217-155"><a href="wshed_params_test.html#cb217-155" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb217-156"><a href="wshed_params_test.html#cb217-156" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-157"><a href="wshed_params_test.html#cb217-157" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb217-158"><a href="wshed_params_test.html#cb217-158" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb217-159"><a href="wshed_params_test.html#cb217-159" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb217-160"><a href="wshed_params_test.html#cb217-160" tabindex="-1"></a>        <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb217-161"><a href="wshed_params_test.html#cb217-161" tabindex="-1"></a>        <span class="co"># , limits = c(0,1)</span></span>
<span id="cb217-162"><a href="wshed_params_test.html#cb217-162" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-163"><a href="wshed_params_test.html#cb217-163" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb217-164"><a href="wshed_params_test.html#cb217-164" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb217-165"><a href="wshed_params_test.html#cb217-165" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb217-166"><a href="wshed_params_test.html#cb217-166" tabindex="-1"></a>        , <span class="at">subtitle =</span> my_subtitle</span>
<span id="cb217-167"><a href="wshed_params_test.html#cb217-167" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb217-168"><a href="wshed_params_test.html#cb217-168" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb217-169"><a href="wshed_params_test.html#cb217-169" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb217-170"><a href="wshed_params_test.html#cb217-170" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb217-171"><a href="wshed_params_test.html#cb217-171" tabindex="-1"></a>        , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb217-172"><a href="wshed_params_test.html#cb217-172" tabindex="-1"></a>        , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb217-173"><a href="wshed_params_test.html#cb217-173" tabindex="-1"></a>        , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-174"><a href="wshed_params_test.html#cb217-174" tabindex="-1"></a>        , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-175"><a href="wshed_params_test.html#cb217-175" tabindex="-1"></a>        , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-176"><a href="wshed_params_test.html#cb217-176" tabindex="-1"></a>        , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb217-177"><a href="wshed_params_test.html#cb217-177" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb217-178"><a href="wshed_params_test.html#cb217-178" tabindex="-1"></a>      )</span>
<span id="cb217-179"><a href="wshed_params_test.html#cb217-179" tabindex="-1"></a>    <span class="cf">if</span>(show_rug){</span>
<span id="cb217-180"><a href="wshed_params_test.html#cb217-180" tabindex="-1"></a>      plt <span class="ot">&lt;-</span> plt <span class="sc">+</span> </span>
<span id="cb217-181"><a href="wshed_params_test.html#cb217-181" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">geom_rug</span>(</span>
<span id="cb217-182"><a href="wshed_params_test.html#cb217-182" tabindex="-1"></a>          <span class="co"># # setting these makes the plotting more computationally intensive</span></span>
<span id="cb217-183"><a href="wshed_params_test.html#cb217-183" tabindex="-1"></a>          <span class="co"># alpha = 0.5</span></span>
<span id="cb217-184"><a href="wshed_params_test.html#cb217-184" tabindex="-1"></a>          <span class="co"># , length = ggplot2::unit(0.01, &quot;npc&quot;)</span></span>
<span id="cb217-185"><a href="wshed_params_test.html#cb217-185" tabindex="-1"></a>        )</span>
<span id="cb217-186"><a href="wshed_params_test.html#cb217-186" tabindex="-1"></a>    }</span>
<span id="cb217-187"><a href="wshed_params_test.html#cb217-187" tabindex="-1"></a>  }</span>
<span id="cb217-188"><a href="wshed_params_test.html#cb217-188" tabindex="-1"></a>  <span class="fu">return</span>(plt)</span>
<span id="cb217-189"><a href="wshed_params_test.html#cb217-189" tabindex="-1"></a>}</span></code></pre></div>
<p>that is a lot of plotting, try isolating the <code>ggplot2::ggplot()</code> command from the function to see what it does</p>
<p>now plot the distribution of F-score, Recall, and Precision values obtained in our <em>test</em> sensitivity testing</p>
<p><em>this is only a test</em></p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="wshed_params_test.html#cb218-1" tabindex="-1"></a><span class="fu">plt_detection_dist</span>(param_combos_gt_agg)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-193-1.png" width="1008" /></p>
<p>we put in a special plot format if we only have a few observations (i.e. &lt;=15)</p>
<p><em>this is only a test</em></p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="wshed_params_test.html#cb219-1" tabindex="-1"></a><span class="fu">plt_detection_dist</span>(param_combos_gt_agg <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">11</span>))</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-194-1.png" width="1008" /></p>
<p>neat.</p>
<p>now, we’ll make a function to plot the distribution of MAPE, RMSE, and ME values obtained in our sensitivity testing. this one is a little more complex than the detection accuracy plotting because the values are on different scales (i.e. MAPE is a percentage value, RMSE is positive in the units of the measurement, and ME is positive or negative in the units of the measurement)</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="wshed_params_test.html#cb220-1" tabindex="-1"></a><span class="co"># this is a lot of work, so we&#39;re going to make it a function</span></span>
<span id="cb220-2"><a href="wshed_params_test.html#cb220-2" tabindex="-1"></a>plt_form_quantification_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb220-3"><a href="wshed_params_test.html#cb220-3" tabindex="-1"></a>  df</span>
<span id="cb220-4"><a href="wshed_params_test.html#cb220-4" tabindex="-1"></a>  , <span class="at">my_subtitle =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb220-5"><a href="wshed_params_test.html#cb220-5" tabindex="-1"></a>  , <span class="at">show_rug =</span> T</span>
<span id="cb220-6"><a href="wshed_params_test.html#cb220-6" tabindex="-1"></a>) {</span>
<span id="cb220-7"><a href="wshed_params_test.html#cb220-7" tabindex="-1"></a>  <span class="co"># reshape data to go long by evaluation metric</span></span>
<span id="cb220-8"><a href="wshed_params_test.html#cb220-8" tabindex="-1"></a>  df_temp <span class="ot">&lt;-</span></span>
<span id="cb220-9"><a href="wshed_params_test.html#cb220-9" tabindex="-1"></a>    df <span class="sc">%&gt;%</span> </span>
<span id="cb220-10"><a href="wshed_params_test.html#cb220-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb220-11"><a href="wshed_params_test.html#cb220-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb220-12"><a href="wshed_params_test.html#cb220-12" tabindex="-1"></a>      <span class="co"># label combining params</span></span>
<span id="cb220-13"><a href="wshed_params_test.html#cb220-13" tabindex="-1"></a>      <span class="at">lab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct, <span class="at">sep =</span> <span class="st">&quot;:&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-14"><a href="wshed_params_test.html#cb220-14" tabindex="-1"></a>        forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(f_score) <span class="co"># %&gt;% forcats::fct_rev()</span></span>
<span id="cb220-15"><a href="wshed_params_test.html#cb220-15" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-16"><a href="wshed_params_test.html#cb220-16" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb220-17"><a href="wshed_params_test.html#cb220-17" tabindex="-1"></a>      max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb220-18"><a href="wshed_params_test.html#cb220-18" tabindex="-1"></a>      , lab</span>
<span id="cb220-19"><a href="wshed_params_test.html#cb220-19" tabindex="-1"></a>      <span class="co"># quantification</span></span>
<span id="cb220-20"><a href="wshed_params_test.html#cb220-20" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb220-21"><a href="wshed_params_test.html#cb220-21" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rrmse&quot;</span>)</span>
<span id="cb220-22"><a href="wshed_params_test.html#cb220-22" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb220-23"><a href="wshed_params_test.html#cb220-23" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb220-24"><a href="wshed_params_test.html#cb220-24" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-25"><a href="wshed_params_test.html#cb220-25" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb220-26"><a href="wshed_params_test.html#cb220-26" tabindex="-1"></a>      <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb220-27"><a href="wshed_params_test.html#cb220-27" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb220-28"><a href="wshed_params_test.html#cb220-28" tabindex="-1"></a>        , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rrmse&quot;</span>)</span>
<span id="cb220-29"><a href="wshed_params_test.html#cb220-29" tabindex="-1"></a>        , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb220-30"><a href="wshed_params_test.html#cb220-30" tabindex="-1"></a>        , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb220-31"><a href="wshed_params_test.html#cb220-31" tabindex="-1"></a>      )</span>
<span id="cb220-32"><a href="wshed_params_test.html#cb220-32" tabindex="-1"></a>      , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb220-33"><a href="wshed_params_test.html#cb220-33" tabindex="-1"></a>      , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb220-34"><a href="wshed_params_test.html#cb220-34" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-35"><a href="wshed_params_test.html#cb220-35" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb220-36"><a href="wshed_params_test.html#cb220-36" tabindex="-1"></a>      <span class="at">eval_metric =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(metric, <span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-37"><a href="wshed_params_test.html#cb220-37" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-38"><a href="wshed_params_test.html#cb220-38" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;me&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-39"><a href="wshed_params_test.html#cb220-39" tabindex="-1"></a>        <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb220-40"><a href="wshed_params_test.html#cb220-40" tabindex="-1"></a>        <span class="fu">factor</span>(</span>
<span id="cb220-41"><a href="wshed_params_test.html#cb220-41" tabindex="-1"></a>          <span class="at">ordered =</span> T</span>
<span id="cb220-42"><a href="wshed_params_test.html#cb220-42" tabindex="-1"></a>          , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb220-43"><a href="wshed_params_test.html#cb220-43" tabindex="-1"></a>        )</span>
<span id="cb220-44"><a href="wshed_params_test.html#cb220-44" tabindex="-1"></a>      , <span class="at">pile_metric =</span> metric <span class="sc">%&gt;%</span> </span>
<span id="cb220-45"><a href="wshed_params_test.html#cb220-45" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-46"><a href="wshed_params_test.html#cb220-46" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">&quot;(paraboloid_volume|volume|area|height|diameter)&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-47"><a href="wshed_params_test.html#cb220-47" tabindex="-1"></a>        <span class="fu">factor</span>(</span>
<span id="cb220-48"><a href="wshed_params_test.html#cb220-48" tabindex="-1"></a>          <span class="at">ordered =</span> T</span>
<span id="cb220-49"><a href="wshed_params_test.html#cb220-49" tabindex="-1"></a>          , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb220-50"><a href="wshed_params_test.html#cb220-50" tabindex="-1"></a>            <span class="st">&quot;volume&quot;</span></span>
<span id="cb220-51"><a href="wshed_params_test.html#cb220-51" tabindex="-1"></a>            , <span class="st">&quot;paraboloid_volume&quot;</span></span>
<span id="cb220-52"><a href="wshed_params_test.html#cb220-52" tabindex="-1"></a>            , <span class="st">&quot;area&quot;</span></span>
<span id="cb220-53"><a href="wshed_params_test.html#cb220-53" tabindex="-1"></a>            , <span class="st">&quot;height&quot;</span></span>
<span id="cb220-54"><a href="wshed_params_test.html#cb220-54" tabindex="-1"></a>            , <span class="st">&quot;diameter&quot;</span></span>
<span id="cb220-55"><a href="wshed_params_test.html#cb220-55" tabindex="-1"></a>          )</span>
<span id="cb220-56"><a href="wshed_params_test.html#cb220-56" tabindex="-1"></a>          , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb220-57"><a href="wshed_params_test.html#cb220-57" tabindex="-1"></a>            <span class="st">&quot;Volume&quot;</span></span>
<span id="cb220-58"><a href="wshed_params_test.html#cb220-58" tabindex="-1"></a>            , <span class="st">&quot;Volume paraboloid&quot;</span></span>
<span id="cb220-59"><a href="wshed_params_test.html#cb220-59" tabindex="-1"></a>            , <span class="st">&quot;Area&quot;</span></span>
<span id="cb220-60"><a href="wshed_params_test.html#cb220-60" tabindex="-1"></a>            , <span class="st">&quot;Height&quot;</span></span>
<span id="cb220-61"><a href="wshed_params_test.html#cb220-61" tabindex="-1"></a>            , <span class="st">&quot;Diameter&quot;</span></span>
<span id="cb220-62"><a href="wshed_params_test.html#cb220-62" tabindex="-1"></a>          )</span>
<span id="cb220-63"><a href="wshed_params_test.html#cb220-63" tabindex="-1"></a>        )</span>
<span id="cb220-64"><a href="wshed_params_test.html#cb220-64" tabindex="-1"></a>    )</span>
<span id="cb220-65"><a href="wshed_params_test.html#cb220-65" tabindex="-1"></a>  </span>
<span id="cb220-66"><a href="wshed_params_test.html#cb220-66" tabindex="-1"></a>  <span class="co"># plot</span></span>
<span id="cb220-67"><a href="wshed_params_test.html#cb220-67" tabindex="-1"></a>  <span class="co"># !!! we map over the ggplot function to allow for differnt formatting of the x axis</span></span>
<span id="cb220-68"><a href="wshed_params_test.html#cb220-68" tabindex="-1"></a>  <span class="co"># !!! and to allow for different axis ranges for each individual panel which is not possible when faceting</span></span>
<span id="cb220-69"><a href="wshed_params_test.html#cb220-69" tabindex="-1"></a>  plt_list_temp <span class="ot">&lt;-</span> </span>
<span id="cb220-70"><a href="wshed_params_test.html#cb220-70" tabindex="-1"></a>    <span class="co"># get factors in order</span></span>
<span id="cb220-71"><a href="wshed_params_test.html#cb220-71" tabindex="-1"></a>    df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb220-72"><a href="wshed_params_test.html#cb220-72" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">!=</span><span class="st">&quot;RRMSE&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-73"><a href="wshed_params_test.html#cb220-73" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">count</span>(eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb220-74"><a href="wshed_params_test.html#cb220-74" tabindex="-1"></a>    <span class="fu">pull</span>(eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb220-75"><a href="wshed_params_test.html#cb220-75" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x, <span class="at">my_show_rug=</span>show_rug){</span>
<span id="cb220-76"><a href="wshed_params_test.html#cb220-76" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(df)<span class="sc">&lt;=</span><span class="dv">15</span>){</span>
<span id="cb220-77"><a href="wshed_params_test.html#cb220-77" tabindex="-1"></a>        df_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb220-78"><a href="wshed_params_test.html#cb220-78" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb220-79"><a href="wshed_params_test.html#cb220-79" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb220-80"><a href="wshed_params_test.html#cb220-80" tabindex="-1"></a>            <span class="at">value =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb220-81"><a href="wshed_params_test.html#cb220-81" tabindex="-1"></a>              eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>) <span class="sc">~</span> <span class="fu">round</span>(value,<span class="dv">2</span>)</span>
<span id="cb220-82"><a href="wshed_params_test.html#cb220-82" tabindex="-1"></a>              , T <span class="sc">~</span> <span class="fu">round</span>(value,<span class="dv">1</span>)</span>
<span id="cb220-83"><a href="wshed_params_test.html#cb220-83" tabindex="-1"></a>            )</span>
<span id="cb220-84"><a href="wshed_params_test.html#cb220-84" tabindex="-1"></a>          )</span>
<span id="cb220-85"><a href="wshed_params_test.html#cb220-85" tabindex="-1"></a>        <span class="co"># aggregate</span></span>
<span id="cb220-86"><a href="wshed_params_test.html#cb220-86" tabindex="-1"></a>        xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb220-87"><a href="wshed_params_test.html#cb220-87" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">group_by</span>(pile_metric,eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb220-88"><a href="wshed_params_test.html#cb220-88" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb220-89"><a href="wshed_params_test.html#cb220-89" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb220-90"><a href="wshed_params_test.html#cb220-90" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb220-91"><a href="wshed_params_test.html#cb220-91" tabindex="-1"></a>            <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb220-92"><a href="wshed_params_test.html#cb220-92" tabindex="-1"></a>                <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb220-93"><a href="wshed_params_test.html#cb220-93" tabindex="-1"></a>              , dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb220-94"><a href="wshed_params_test.html#cb220-94" tabindex="-1"></a>                eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>) <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb220-95"><a href="wshed_params_test.html#cb220-95" tabindex="-1"></a>                , eval_metric <span class="sc">==</span> <span class="st">&quot;ME&quot;</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb220-96"><a href="wshed_params_test.html#cb220-96" tabindex="-1"></a>                , T <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb220-97"><a href="wshed_params_test.html#cb220-97" tabindex="-1"></a>              )</span>
<span id="cb220-98"><a href="wshed_params_test.html#cb220-98" tabindex="-1"></a>            )</span>
<span id="cb220-99"><a href="wshed_params_test.html#cb220-99" tabindex="-1"></a>          )</span>
<span id="cb220-100"><a href="wshed_params_test.html#cb220-100" tabindex="-1"></a>        <span class="co"># plot </span></span>
<span id="cb220-101"><a href="wshed_params_test.html#cb220-101" tabindex="-1"></a>        p <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb220-102"><a href="wshed_params_test.html#cb220-102" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">count</span>(eval_metric,pile_metric,value) <span class="sc">%&gt;%</span> </span>
<span id="cb220-103"><a href="wshed_params_test.html#cb220-103" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb220-104"><a href="wshed_params_test.html#cb220-104" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> pile_metric, <span class="at">color =</span> pile_metric)</span>
<span id="cb220-105"><a href="wshed_params_test.html#cb220-105" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-106"><a href="wshed_params_test.html#cb220-106" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb220-107"><a href="wshed_params_test.html#cb220-107" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp</span>
<span id="cb220-108"><a href="wshed_params_test.html#cb220-108" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb220-109"><a href="wshed_params_test.html#cb220-109" tabindex="-1"></a>            , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb220-110"><a href="wshed_params_test.html#cb220-110" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-111"><a href="wshed_params_test.html#cb220-111" tabindex="-1"></a>          <span class="co"># ggplot2::geom_jitter(mapping = ggplot2::aes(y=-0.2), width = 0, height = 0.1) +</span></span>
<span id="cb220-112"><a href="wshed_params_test.html#cb220-112" tabindex="-1"></a>          <span class="co"># ggplot2::geom_boxplot(width = 0.1, color = &quot;black&quot;, fill = NA, outliers = F) +</span></span>
<span id="cb220-113"><a href="wshed_params_test.html#cb220-113" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb220-114"><a href="wshed_params_test.html#cb220-114" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">yend=</span><span class="dv">0</span>)</span>
<span id="cb220-115"><a href="wshed_params_test.html#cb220-115" tabindex="-1"></a>            , <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb220-116"><a href="wshed_params_test.html#cb220-116" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-117"><a href="wshed_params_test.html#cb220-117" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb220-118"><a href="wshed_params_test.html#cb220-118" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n)</span>
<span id="cb220-119"><a href="wshed_params_test.html#cb220-119" tabindex="-1"></a>            , <span class="at">alpha =</span> <span class="dv">1</span></span>
<span id="cb220-120"><a href="wshed_params_test.html#cb220-120" tabindex="-1"></a>            , <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb220-121"><a href="wshed_params_test.html#cb220-121" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-122"><a href="wshed_params_test.html#cb220-122" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb220-123"><a href="wshed_params_test.html#cb220-123" tabindex="-1"></a>            <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>n,<span class="at">label=</span>n)</span>
<span id="cb220-124"><a href="wshed_params_test.html#cb220-124" tabindex="-1"></a>            , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb220-125"><a href="wshed_params_test.html#cb220-125" tabindex="-1"></a>            <span class="co"># , vjust = -0.01</span></span>
<span id="cb220-126"><a href="wshed_params_test.html#cb220-126" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-127"><a href="wshed_params_test.html#cb220-127" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb220-128"><a href="wshed_params_test.html#cb220-128" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp</span>
<span id="cb220-129"><a href="wshed_params_test.html#cb220-129" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb220-130"><a href="wshed_params_test.html#cb220-130" tabindex="-1"></a>              <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb220-131"><a href="wshed_params_test.html#cb220-131" tabindex="-1"></a>              <span class="co"># x = value, y = 0</span></span>
<span id="cb220-132"><a href="wshed_params_test.html#cb220-132" tabindex="-1"></a>              , <span class="at">label =</span> value_lab</span>
<span id="cb220-133"><a href="wshed_params_test.html#cb220-133" tabindex="-1"></a>            )</span>
<span id="cb220-134"><a href="wshed_params_test.html#cb220-134" tabindex="-1"></a>            , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb220-135"><a href="wshed_params_test.html#cb220-135" tabindex="-1"></a>            <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb220-136"><a href="wshed_params_test.html#cb220-136" tabindex="-1"></a>            , <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb220-137"><a href="wshed_params_test.html#cb220-137" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-138"><a href="wshed_params_test.html#cb220-138" tabindex="-1"></a>          <span class="co"># ggplot2::geom_rug() +</span></span>
<span id="cb220-139"><a href="wshed_params_test.html#cb220-139" tabindex="-1"></a>          harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp_d</span>(<span class="at">option =</span> <span class="st">&quot;hermionegranger&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-140"><a href="wshed_params_test.html#cb220-140" tabindex="-1"></a>          harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="at">option =</span> <span class="st">&quot;hermionegranger&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-141"><a href="wshed_params_test.html#cb220-141" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">33</span>))) <span class="sc">+</span></span>
<span id="cb220-142"><a href="wshed_params_test.html#cb220-142" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(</span>
<span id="cb220-143"><a href="wshed_params_test.html#cb220-143" tabindex="-1"></a>            <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(pile_metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(eval_metric)</span>
<span id="cb220-144"><a href="wshed_params_test.html#cb220-144" tabindex="-1"></a>            , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb220-145"><a href="wshed_params_test.html#cb220-145" tabindex="-1"></a>            , <span class="at">switch =</span> <span class="st">&quot;y&quot;</span> <span class="co"># moves y facet label to left</span></span>
<span id="cb220-146"><a href="wshed_params_test.html#cb220-146" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-147"><a href="wshed_params_test.html#cb220-147" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-148"><a href="wshed_params_test.html#cb220-148" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb220-149"><a href="wshed_params_test.html#cb220-149" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb220-150"><a href="wshed_params_test.html#cb220-150" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb220-151"><a href="wshed_params_test.html#cb220-151" tabindex="-1"></a>            , <span class="at">strip.placement =</span> <span class="st">&quot;outside&quot;</span></span>
<span id="cb220-152"><a href="wshed_params_test.html#cb220-152" tabindex="-1"></a>            , <span class="at">strip.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb220-153"><a href="wshed_params_test.html#cb220-153" tabindex="-1"></a>            , <span class="at">strip.text.y.left =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb220-154"><a href="wshed_params_test.html#cb220-154" tabindex="-1"></a>            , <span class="at">strip.background.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb220-155"><a href="wshed_params_test.html#cb220-155" tabindex="-1"></a>            , <span class="at">strip.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb220-156"><a href="wshed_params_test.html#cb220-156" tabindex="-1"></a>            , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">6.5</span>)</span>
<span id="cb220-157"><a href="wshed_params_test.html#cb220-157" tabindex="-1"></a>            , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-158"><a href="wshed_params_test.html#cb220-158" tabindex="-1"></a>            , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-159"><a href="wshed_params_test.html#cb220-159" tabindex="-1"></a>            , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-160"><a href="wshed_params_test.html#cb220-160" tabindex="-1"></a>            , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-161"><a href="wshed_params_test.html#cb220-161" tabindex="-1"></a>          )</span>
<span id="cb220-162"><a href="wshed_params_test.html#cb220-162" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb220-163"><a href="wshed_params_test.html#cb220-163" tabindex="-1"></a>        <span class="co"># aggregate</span></span>
<span id="cb220-164"><a href="wshed_params_test.html#cb220-164" tabindex="-1"></a>        xxxdf_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb220-165"><a href="wshed_params_test.html#cb220-165" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">group_by</span>(pile_metric,eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb220-166"><a href="wshed_params_test.html#cb220-166" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb220-167"><a href="wshed_params_test.html#cb220-167" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb220-168"><a href="wshed_params_test.html#cb220-168" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb220-169"><a href="wshed_params_test.html#cb220-169" tabindex="-1"></a>            <span class="at">value_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb220-170"><a href="wshed_params_test.html#cb220-170" tabindex="-1"></a>                <span class="st">&quot;median:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb220-171"><a href="wshed_params_test.html#cb220-171" tabindex="-1"></a>              , dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb220-172"><a href="wshed_params_test.html#cb220-172" tabindex="-1"></a>                eval_metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>) <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb220-173"><a href="wshed_params_test.html#cb220-173" tabindex="-1"></a>                , eval_metric <span class="sc">==</span> <span class="st">&quot;ME&quot;</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb220-174"><a href="wshed_params_test.html#cb220-174" tabindex="-1"></a>                , T <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb220-175"><a href="wshed_params_test.html#cb220-175" tabindex="-1"></a>              )</span>
<span id="cb220-176"><a href="wshed_params_test.html#cb220-176" tabindex="-1"></a>            )</span>
<span id="cb220-177"><a href="wshed_params_test.html#cb220-177" tabindex="-1"></a>          )</span>
<span id="cb220-178"><a href="wshed_params_test.html#cb220-178" tabindex="-1"></a>        p <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb220-179"><a href="wshed_params_test.html#cb220-179" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb220-180"><a href="wshed_params_test.html#cb220-180" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb220-181"><a href="wshed_params_test.html#cb220-181" tabindex="-1"></a>          <span class="co"># ggplot2::geom_vline(xintercept = 0, color = &quot;gray&quot;) +</span></span>
<span id="cb220-182"><a href="wshed_params_test.html#cb220-182" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> pile_metric), <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb220-183"><a href="wshed_params_test.html#cb220-183" tabindex="-1"></a>          <span class="co"># ggplot2::geom_rug(mapping = ggplot2::aes(x = value, color = pile_metric)) +</span></span>
<span id="cb220-184"><a href="wshed_params_test.html#cb220-184" tabindex="-1"></a>          harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp_d</span>(<span class="at">option =</span> <span class="st">&quot;hermionegranger&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-185"><a href="wshed_params_test.html#cb220-185" tabindex="-1"></a>          harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="at">option =</span> <span class="st">&quot;hermionegranger&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-186"><a href="wshed_params_test.html#cb220-186" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb220-187"><a href="wshed_params_test.html#cb220-187" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x)</span>
<span id="cb220-188"><a href="wshed_params_test.html#cb220-188" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value)</span>
<span id="cb220-189"><a href="wshed_params_test.html#cb220-189" tabindex="-1"></a>            , <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span></span>
<span id="cb220-190"><a href="wshed_params_test.html#cb220-190" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-191"><a href="wshed_params_test.html#cb220-191" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(</span>
<span id="cb220-192"><a href="wshed_params_test.html#cb220-192" tabindex="-1"></a>            <span class="at">data =</span> xxxdf_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(eval_metric<span class="sc">==</span>x)</span>
<span id="cb220-193"><a href="wshed_params_test.html#cb220-193" tabindex="-1"></a>            , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb220-194"><a href="wshed_params_test.html#cb220-194" tabindex="-1"></a>              <span class="at">x =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span> <span class="co"># always in upper left?</span></span>
<span id="cb220-195"><a href="wshed_params_test.html#cb220-195" tabindex="-1"></a>              <span class="co"># x = value, y = 0</span></span>
<span id="cb220-196"><a href="wshed_params_test.html#cb220-196" tabindex="-1"></a>              , <span class="at">label =</span> value_lab</span>
<span id="cb220-197"><a href="wshed_params_test.html#cb220-197" tabindex="-1"></a>            )</span>
<span id="cb220-198"><a href="wshed_params_test.html#cb220-198" tabindex="-1"></a>            , <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">vjust =</span> <span class="dv">1</span> <span class="co"># always in upper left?</span></span>
<span id="cb220-199"><a href="wshed_params_test.html#cb220-199" tabindex="-1"></a>            <span class="co"># , hjust = -0.1, vjust = -5</span></span>
<span id="cb220-200"><a href="wshed_params_test.html#cb220-200" tabindex="-1"></a>            , <span class="at">size =</span> <span class="fl">2.5</span></span>
<span id="cb220-201"><a href="wshed_params_test.html#cb220-201" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-202"><a href="wshed_params_test.html#cb220-202" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(</span>
<span id="cb220-203"><a href="wshed_params_test.html#cb220-203" tabindex="-1"></a>            <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(pile_metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(eval_metric)</span>
<span id="cb220-204"><a href="wshed_params_test.html#cb220-204" tabindex="-1"></a>            , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb220-205"><a href="wshed_params_test.html#cb220-205" tabindex="-1"></a>            , <span class="at">switch =</span> <span class="st">&quot;y&quot;</span> <span class="co"># moves y facet label to left</span></span>
<span id="cb220-206"><a href="wshed_params_test.html#cb220-206" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb220-207"><a href="wshed_params_test.html#cb220-207" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-208"><a href="wshed_params_test.html#cb220-208" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb220-209"><a href="wshed_params_test.html#cb220-209" tabindex="-1"></a>          ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb220-210"><a href="wshed_params_test.html#cb220-210" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb220-211"><a href="wshed_params_test.html#cb220-211" tabindex="-1"></a>            , <span class="at">strip.placement =</span> <span class="st">&quot;outside&quot;</span></span>
<span id="cb220-212"><a href="wshed_params_test.html#cb220-212" tabindex="-1"></a>            , <span class="at">strip.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb220-213"><a href="wshed_params_test.html#cb220-213" tabindex="-1"></a>            , <span class="at">strip.text.y.left =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb220-214"><a href="wshed_params_test.html#cb220-214" tabindex="-1"></a>            , <span class="at">strip.background.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb220-215"><a href="wshed_params_test.html#cb220-215" tabindex="-1"></a>            , <span class="at">strip.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb220-216"><a href="wshed_params_test.html#cb220-216" tabindex="-1"></a>            , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">6.5</span>)</span>
<span id="cb220-217"><a href="wshed_params_test.html#cb220-217" tabindex="-1"></a>            , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-218"><a href="wshed_params_test.html#cb220-218" tabindex="-1"></a>            , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-219"><a href="wshed_params_test.html#cb220-219" tabindex="-1"></a>            , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-220"><a href="wshed_params_test.html#cb220-220" tabindex="-1"></a>            , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb220-221"><a href="wshed_params_test.html#cb220-221" tabindex="-1"></a>          )</span>
<span id="cb220-222"><a href="wshed_params_test.html#cb220-222" tabindex="-1"></a>        </span>
<span id="cb220-223"><a href="wshed_params_test.html#cb220-223" tabindex="-1"></a>        <span class="cf">if</span>(my_show_rug){</span>
<span id="cb220-224"><a href="wshed_params_test.html#cb220-224" tabindex="-1"></a>          p <span class="ot">&lt;-</span> p <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">geom_rug</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> pile_metric))</span>
<span id="cb220-225"><a href="wshed_params_test.html#cb220-225" tabindex="-1"></a>        }</span>
<span id="cb220-226"><a href="wshed_params_test.html#cb220-226" tabindex="-1"></a>      }</span>
<span id="cb220-227"><a href="wshed_params_test.html#cb220-227" tabindex="-1"></a>      </span>
<span id="cb220-228"><a href="wshed_params_test.html#cb220-228" tabindex="-1"></a>      <span class="cf">if</span>(x <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;RRMSE&quot;</span>, <span class="st">&quot;MAPE&quot;</span>)){</span>
<span id="cb220-229"><a href="wshed_params_test.html#cb220-229" tabindex="-1"></a>        <span class="fu">return</span>(p<span class="sc">+</span>ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)))</span>
<span id="cb220-230"><a href="wshed_params_test.html#cb220-230" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb220-231"><a href="wshed_params_test.html#cb220-231" tabindex="-1"></a>        <span class="fu">return</span>(p)</span>
<span id="cb220-232"><a href="wshed_params_test.html#cb220-232" tabindex="-1"></a>      }</span>
<span id="cb220-233"><a href="wshed_params_test.html#cb220-233" tabindex="-1"></a>    })</span>
<span id="cb220-234"><a href="wshed_params_test.html#cb220-234" tabindex="-1"></a>  <span class="co"># combine</span></span>
<span id="cb220-235"><a href="wshed_params_test.html#cb220-235" tabindex="-1"></a>  <span class="co"># plt_list_temp</span></span>
<span id="cb220-236"><a href="wshed_params_test.html#cb220-236" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb220-237"><a href="wshed_params_test.html#cb220-237" tabindex="-1"></a>      plt_list_temp</span>
<span id="cb220-238"><a href="wshed_params_test.html#cb220-238" tabindex="-1"></a>      , <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb220-239"><a href="wshed_params_test.html#cb220-239" tabindex="-1"></a>  ) <span class="sc">+</span> patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb220-240"><a href="wshed_params_test.html#cb220-240" tabindex="-1"></a>      <span class="co"># title = paste0(aoi_sf$study_site_lab, &quot; - ALS&quot;)</span></span>
<span id="cb220-241"><a href="wshed_params_test.html#cb220-241" tabindex="-1"></a>      <span class="at">subtitle =</span> my_subtitle</span>
<span id="cb220-242"><a href="wshed_params_test.html#cb220-242" tabindex="-1"></a>        <span class="co"># paste0(</span></span>
<span id="cb220-243"><a href="wshed_params_test.html#cb220-243" tabindex="-1"></a>        <span class="co">#      &quot;distribution of pile form quantification accuracy metrics for all&quot;</span></span>
<span id="cb220-244"><a href="wshed_params_test.html#cb220-244" tabindex="-1"></a>        <span class="co">#      # , scales::percent(1-pct_rank_th_top,accuracy=1)</span></span>
<span id="cb220-245"><a href="wshed_params_test.html#cb220-245" tabindex="-1"></a>        <span class="co">#      , &quot; (n=&quot;</span></span>
<span id="cb220-246"><a href="wshed_params_test.html#cb220-246" tabindex="-1"></a>        <span class="co">#      , scales::comma(nrow(param_combos_gt_agg), accuracy = 1)</span></span>
<span id="cb220-247"><a href="wshed_params_test.html#cb220-247" tabindex="-1"></a>        <span class="co">#      , &quot;) &quot;</span></span>
<span id="cb220-248"><a href="wshed_params_test.html#cb220-248" tabindex="-1"></a>        <span class="co">#      , &quot;parameter combinations tested&quot;</span></span>
<span id="cb220-249"><a href="wshed_params_test.html#cb220-249" tabindex="-1"></a>        <span class="co">#   )</span></span>
<span id="cb220-250"><a href="wshed_params_test.html#cb220-250" tabindex="-1"></a>      <span class="co"># , caption = &quot;hey&quot;</span></span>
<span id="cb220-251"><a href="wshed_params_test.html#cb220-251" tabindex="-1"></a>      , <span class="at">theme =</span> ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb220-252"><a href="wshed_params_test.html#cb220-252" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb220-253"><a href="wshed_params_test.html#cb220-253" tabindex="-1"></a>      )</span>
<span id="cb220-254"><a href="wshed_params_test.html#cb220-254" tabindex="-1"></a>    )</span>
<span id="cb220-255"><a href="wshed_params_test.html#cb220-255" tabindex="-1"></a>}</span></code></pre></div>
<p>now plot the distribution of F-score, Recall, and Precision values obtained in our <em>test</em> sensitivity testing</p>
<p><em>this is only a test</em></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="wshed_params_test.html#cb221-1" tabindex="-1"></a><span class="fu">plt_form_quantification_dist</span>(param_combos_gt_agg)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-196-1.png" width="1008" /></p>
<p>we put in a special plot format if we only have a few observations (i.e. &lt;=15)</p>
<p><em>this is only a test</em></p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="wshed_params_test.html#cb222-1" tabindex="-1"></a><span class="fu">plt_form_quantification_dist</span>(param_combos_gt_agg <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">11</span>))</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-197-1.png" width="1008" /></p>
<p>ok.</p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data_fusion.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="chm_sens_test.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
