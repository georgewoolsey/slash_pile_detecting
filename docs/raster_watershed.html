<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 5 Structural Detection from CHM | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 5 Structural Detection from CHM | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 5 Structural Detection from CHM | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ptcld_process.html"/>
<link rel="next" href="data_fusion.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script src="libs/. - 1_d2f159-1/data_stars_1b1597e.txt"></script>
<script src="libs/joda-0.0.1/joda.js"></script>
<script src="libs/joda-0.0.1/addImageQuery-bindings.js"></script>
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<link href="libs/study sites-CSS-0.0.1/study sites_home-button.css" rel="stylesheet" />
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#analysis-plan"><i class="fa fa-check"></i><b>1.3</b> Analysis Plan</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="training-data.html"><a href="training-data.html"><i class="fa fa-check"></i><b>2</b> Training Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="training-data.html"><a href="training-data.html#site-introduction"><i class="fa fa-check"></i><b>2.1</b> Site Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="training-data.html"><a href="training-data.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.2</b> Slash Pile Vector Data</a></li>
<li class="chapter" data-level="2.3" data-path="training-data.html"><a href="training-data.html#rgb-orthomosaic"><i class="fa fa-check"></i><b>2.3</b> RGB orthomosaic</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="training-data.html"><a href="training-data.html#example-ratio-based-index"><i class="fa fa-check"></i><b>2.3.1</b> Example ratio-based index</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="training-data.html"><a href="training-data.html#study-area-imagery"><i class="fa fa-check"></i><b>2.4</b> Study area imagery</a></li>
<li class="chapter" data-level="2.5" data-path="training-data.html"><a href="training-data.html#point-cloud-data"><i class="fa fa-check"></i><b>2.5</b> Point Cloud Data</a></li>
<li class="chapter" data-level="2.6" data-path="training-data.html"><a href="training-data.html#check-out-one-pile"><i class="fa fa-check"></i><b>2.6</b> Check out one pile</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="method-evaluation.html"><a href="method-evaluation.html"><i class="fa fa-check"></i><b>3</b> Method Evaluation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="method-evaluation.html"><a href="method-evaluation.html#iou_match"><i class="fa fa-check"></i><b>3.1</b> Instance Matching</a></li>
<li class="chapter" data-level="3.2" data-path="method-evaluation.html"><a href="method-evaluation.html#detect_metrics_form"><i class="fa fa-check"></i><b>3.2</b> Detection Accuracy Metrics</a></li>
<li class="chapter" data-level="3.3" data-path="method-evaluation.html"><a href="method-evaluation.html#quant_metrics_form"><i class="fa fa-check"></i><b>3.3</b> Quantification Accuracy Metrics</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ptcld_process.html"><a href="ptcld_process.html"><i class="fa fa-check"></i><b>4</b> Point Cloud Processing and Pile Segmentation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ptcld_process.html"><a href="ptcld_process.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>4.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ptcld_process.html"><a href="ptcld_process.html#dtm-and-chm-piles"><i class="fa fa-check"></i><b>4.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="raster_watershed.html"><a href="raster_watershed.html"><i class="fa fa-check"></i><b>5</b> Structural Detection from CHM</a>
<ul>
<li class="chapter" data-level="5.1" data-path="raster_watershed.html"><a href="raster_watershed.html#method-demonstration"><i class="fa fa-check"></i><b>5.1</b> Method Demonstration</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-irregularity-filtering"><i class="fa fa-check"></i><b>5.1.1</b> Geometric filtering: Irregularity Filtering</a></li>
<li class="chapter" data-level="5.1.2" data-path="raster_watershed.html"><a href="raster_watershed.html#area-filtering"><i class="fa fa-check"></i><b>5.1.2</b> Area Filtering</a></li>
<li class="chapter" data-level="5.1.3" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-circularity-filtering"><i class="fa fa-check"></i><b>5.1.3</b> Geometric filtering: Circularity Filtering</a></li>
<li class="chapter" data-level="5.1.4" data-path="raster_watershed.html"><a href="raster_watershed.html#area-and-volume-from-chm"><i class="fa fa-check"></i><b>5.1.4</b> Area and Volume from CHM</a></li>
<li class="chapter" data-level="5.1.5" data-path="raster_watershed.html"><a href="raster_watershed.html#shape-refinement"><i class="fa fa-check"></i><b>5.1.5</b> Shape Refinement</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="raster_watershed.html"><a href="raster_watershed.html#instance-matching"><i class="fa fa-check"></i><b>5.2</b> Instance Matching</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="raster_watershed.html"><a href="raster_watershed.html#example-area"><i class="fa fa-check"></i><b>5.2.1</b> Example Area</a></li>
<li class="chapter" data-level="5.2.2" data-path="raster_watershed.html"><a href="raster_watershed.html#full-study-area"><i class="fa fa-check"></i><b>5.2.2</b> Full Study Area</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="raster_watershed.html"><a href="raster_watershed.html#slash_pile_detect_watershed"><i class="fa fa-check"></i><b>5.3</b> Watershed Pile Detection Function</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data_fusion.html"><a href="data_fusion.html"><i class="fa fa-check"></i><b>6</b> Data Fusion</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data_fusion.html"><a href="data_fusion.html#rgb-indices"><i class="fa fa-check"></i><b>6.1</b> RGB Indices</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-functions"><i class="fa fa-check"></i><b>6.1.1</b> Spectral Index Functions</a></li>
<li class="chapter" data-level="6.1.2" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-of-polygons"><i class="fa fa-check"></i><b>6.1.2</b> Spectral Index of Polygons</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data_fusion.html"><a href="data_fusion.html#ground-truth-pile-spectral-summary"><i class="fa fa-check"></i><b>6.2</b> Ground Truth Pile Spectral Summary</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="data_fusion.html"><a href="data_fusion.html#voting-system"><i class="fa fa-check"></i><b>6.2.1</b> Voting System</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="data_fusion.html"><a href="data_fusion.html#polygon_spectral_filtering"><i class="fa fa-check"></i><b>6.3</b> Candidate Polygon Spectral Filtering Function</a></li>
<li class="chapter" data-level="6.4" data-path="data_fusion.html"><a href="data_fusion.html#data-fusion-example"><i class="fa fa-check"></i><b>6.4</b> Data Fusion Example</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="data_fusion.html"><a href="data_fusion.html#instance-matching-1"><i class="fa fa-check"></i><b>6.4.1</b> Instance Matching</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="wshed_params_test.html"><a href="wshed_params_test.html"><i class="fa fa-check"></i><b>7</b> Sensitivity Testing Method</a>
<ul>
<li class="chapter" data-level="7.1" data-path="wshed_params_test.html"><a href="wshed_params_test.html#all_the_combos"><i class="fa fa-check"></i><b>7.1</b> Workflow over parameter combinations</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-workflow"><i class="fa fa-check"></i><b>7.1.1</b> Test Workflow</a></li>
<li class="chapter" data-level="7.1.2" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-instance-matching"><i class="fa fa-check"></i><b>7.1.2</b> Test Instance Matching</a></li>
<li class="chapter" data-level="7.1.3" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-accuracy"><i class="fa fa-check"></i><b>7.1.3</b> Test Accuracy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="chm_sens_test.html"><a href="chm_sens_test.html"><i class="fa fa-check"></i><b>8</b> Sensitivity Testing Results</a>
<ul>
<li class="chapter" data-level="8.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#process-raw-point-cloud-1"><i class="fa fa-check"></i><b>8.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="8.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#structural-only-parameter-testing"><i class="fa fa-check"></i><b>8.2</b> Structural Only: Parameter Testing</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#validation-over-parameter-combinations"><i class="fa fa-check"></i><b>8.2.1</b> Validation over parameter combinations</a></li>
<li class="chapter" data-level="8.2.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#aggregate-validation-metrics-to-parameter-combination"><i class="fa fa-check"></i><b>8.2.2</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion-parameter-testing"><i class="fa fa-check"></i><b>8.3</b> Data Fusion: Parameter Testing</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#aggregate-validation-metrics-to-parameter-combination-1"><i class="fa fa-check"></i><b>8.3.1</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="chm_sens_test.html"><a href="chm_sens_test.html#read-data-for-analysis"><i class="fa fa-check"></i><b>8.4</b> Read Data for Analysis</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#structural-only"><i class="fa fa-check"></i><b>8.4.1</b> Structural Only</a></li>
<li class="chapter" data-level="8.4.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion"><i class="fa fa-check"></i><b>8.4.2</b> Data Fusion</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="chm_sens_test.html"><a href="chm_sens_test.html#allthetests"><i class="fa fa-check"></i><b>8.5</b> Structural Only: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#detect_trends"><i class="fa fa-check"></i><b>8.5.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="8.5.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#quant_trends"><i class="fa fa-check"></i><b>8.5.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="8.5.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#best-settings"><i class="fa fa-check"></i><b>8.5.3</b> Best settings</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion-sensitivity-testing"><i class="fa fa-check"></i><b>8.6</b> Data Fusion: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#main-effects-pile-detection"><i class="fa fa-check"></i><b>8.6.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="8.6.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#main-effects-form-quantification"><i class="fa fa-check"></i><b>8.6.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="8.6.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#balanced_acc_assess"><i class="fa fa-check"></i><b>8.6.3</b> Top settings</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="chm_sens_test.html"><a href="chm_sens_test.html#save-the-data"><i class="fa fa-check"></i><b>8.7</b> save the data</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="stats_method.html"><a href="stats_method.html"><i class="fa fa-check"></i><b>9</b> Statistical Testing of Method Settings</a>
<ul>
<li class="chapter" data-level="9.1" data-path="stats_method.html"><a href="stats_method.html#bayesian-glm---f-score"><i class="fa fa-check"></i><b>9.1</b> Bayesian GLM - F-score</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="stats_method.html"><a href="stats_method.html#model-selection"><i class="fa fa-check"></i><b>9.1.1</b> Model selection</a></li>
<li class="chapter" data-level="9.1.2" data-path="stats_method.html"><a href="stats_method.html#modeling"><i class="fa fa-check"></i><b>9.1.2</b> Modeling</a></li>
<li class="chapter" data-level="9.1.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks"><i class="fa fa-check"></i><b>9.1.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.1.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects"><i class="fa fa-check"></i><b>9.1.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.1.5" data-path="stats_method.html"><a href="stats_method.html#f_score_epred"><i class="fa fa-check"></i><b>9.1.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape"><i class="fa fa-check"></i><b>9.2</b> Bayesian GLM - Diameter MAPE</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-1"><i class="fa fa-check"></i><b>9.2.1</b> Model selection</a></li>
<li class="chapter" data-level="9.2.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape2"><i class="fa fa-check"></i><b>9.2.2</b> Modeling</a></li>
<li class="chapter" data-level="9.2.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-1"><i class="fa fa-check"></i><b>9.2.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.2.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-1"><i class="fa fa-check"></i><b>9.2.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.2.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation"><i class="fa fa-check"></i><b>9.2.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="stats_method.html"><a href="stats_method.html#bayesian-glm---height-mape"><i class="fa fa-check"></i><b>9.3</b> Bayesian GLM - Height MAPE</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-2"><i class="fa fa-check"></i><b>9.3.1</b> Model selection</a></li>
<li class="chapter" data-level="9.3.2" data-path="stats_method.html"><a href="stats_method.html#modeling-1"><i class="fa fa-check"></i><b>9.3.2</b> Modeling</a></li>
<li class="chapter" data-level="9.3.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-2"><i class="fa fa-check"></i><b>9.3.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.3.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-2"><i class="fa fa-check"></i><b>9.3.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.3.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation-1"><i class="fa fa-check"></i><b>9.3.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="stats_method.html"><a href="stats_method.html#hey_balanced_acc"><i class="fa fa-check"></i><b>9.4</b> Balanced Accuracy Bayesian Optimization</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="stats_method.html"><a href="stats_method.html#balanced-accuracy-selection"><i class="fa fa-check"></i><b>9.4.1</b> Balanced Accuracy Selection</a></li>
<li class="chapter" data-level="9.4.2" data-path="stats_method.html"><a href="stats_method.html#overall-across-chm-resolution-2"><i class="fa fa-check"></i><b>9.4.2</b> Overall (across CHM resolution)</a></li>
<li class="chapter" data-level="9.4.3" data-path="stats_method.html"><a href="stats_method.html#by-chm-resolution-2"><i class="fa fa-check"></i><b>9.4.3</b> by CHM resolution</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="stats_method.html"><a href="stats_method.html#training_detect_final"><i class="fa fa-check"></i><b>9.5</b> Balanced Accuracy Validation</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="stats_method.html"><a href="stats_method.html#detection"><i class="fa fa-check"></i><b>9.5.1</b> Detection</a></li>
<li class="chapter" data-level="9.5.2" data-path="stats_method.html"><a href="stats_method.html#instance-match-accuracy-assessment"><i class="fa fa-check"></i><b>9.5.2</b> Instance Match &amp; Accuracy Assessment</a></li>
<li class="chapter" data-level="9.5.3" data-path="stats_method.html"><a href="stats_method.html#training_detect_final_volcomp"><i class="fa fa-check"></i><b>9.5.3</b> Volume Comparison</a></li>
<li class="chapter" data-level="9.5.4" data-path="stats_method.html"><a href="stats_method.html#stand-level-aggregation"><i class="fa fa-check"></i><b>9.5.4</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html"><i class="fa fa-check"></i><b>10</b> Method Validation: Pinyon-Juniper</a>
<ul>
<li class="chapter" data-level="10.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#site-introduction-1"><i class="fa fa-check"></i><b>10.1</b> Site Introduction</a></li>
<li class="chapter" data-level="10.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#data-processing"><i class="fa fa-check"></i><b>10.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#vector-data"><i class="fa fa-check"></i><b>10.2.1</b> Vector Data</a></li>
<li class="chapter" data-level="10.2.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#rgb-data"><i class="fa fa-check"></i><b>10.2.2</b> RGB Data</a></li>
<li class="chapter" data-level="10.2.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#process-raw-point-cloud-2"><i class="fa fa-check"></i><b>10.2.3</b> Process Raw Point Cloud</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#pj_detect_fusion"><i class="fa fa-check"></i><b>10.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#structural-candidate-segments"><i class="fa fa-check"></i><b>10.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="10.3.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#accuracy-of-these-structural-settings"><i class="fa fa-check"></i><b>10.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="10.3.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#spect_filtering_final_pj"><i class="fa fa-check"></i><b>10.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="10.3.4" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#detection-and-quantification-accuracy"><i class="fa fa-check"></i><b>10.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="10.3.5" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#validation_detect_final_volcomp"><i class="fa fa-check"></i><b>10.3.5</b> Volume Comparison</a></li>
<li class="chapter" data-level="10.3.6" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#stand-level-aggregation-1"><i class="fa fa-check"></i><b>10.3.6</b> Stand-level Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#pj_detect_struct"><i class="fa fa-check"></i><b>10.4</b> Pile Detection: Structural Only</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#structural-detection"><i class="fa fa-check"></i><b>10.4.1</b> Structural Detection</a></li>
<li class="chapter" data-level="10.4.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#detection-and-quantification-accuracy-1"><i class="fa fa-check"></i><b>10.4.2</b> Detection and Quantification Accuracy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html"><i class="fa fa-check"></i><b>11</b> Method Validation: BHEF Machine Piles</a>
<ul>
<li class="chapter" data-level="11.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#site-introduction-2"><i class="fa fa-check"></i><b>11.1</b> Site Introduction</a></li>
<li class="chapter" data-level="11.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#data-processing-1"><i class="fa fa-check"></i><b>11.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#rgb-data-1"><i class="fa fa-check"></i><b>11.2.1</b> RGB Data</a></li>
<li class="chapter" data-level="11.2.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#process-raw-point-cloud-3"><i class="fa fa-check"></i><b>11.2.2</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="11.2.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#vector-data-1"><i class="fa fa-check"></i><b>11.2.3</b> Vector Data</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#bhef_detect_fusion"><i class="fa fa-check"></i><b>11.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#structural-candidate-segments-1"><i class="fa fa-check"></i><b>11.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="11.3.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#accuracy-of-these-structural-settings-1"><i class="fa fa-check"></i><b>11.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="11.3.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#spect_filtering_final_bhef"><i class="fa fa-check"></i><b>11.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="11.3.4" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#detection-and-quantification-accuracy-2"><i class="fa fa-check"></i><b>11.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="11.3.5" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#stand-level-aggregation-2"><i class="fa fa-check"></i><b>11.3.5</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html"><i class="fa fa-check"></i><b>12</b> Method Validation: ARNF Machine Piles</a>
<ul>
<li class="chapter" data-level="12.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#site-introduction-3"><i class="fa fa-check"></i><b>12.1</b> Site Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#data-processing-2"><i class="fa fa-check"></i><b>12.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#process-raw-point-cloud-4"><i class="fa fa-check"></i><b>12.2.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="12.2.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#vector-data-2"><i class="fa fa-check"></i><b>12.2.2</b> Vector Data</a></li>
<li class="chapter" data-level="12.2.3" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#rgb-data-2"><i class="fa fa-check"></i><b>12.2.3</b> RGB Data</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#arnf_detect_fusion"><i class="fa fa-check"></i><b>12.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#structural-candidate-segments-2"><i class="fa fa-check"></i><b>12.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="12.3.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#accuracy-of-these-structural-settings-2"><i class="fa fa-check"></i><b>12.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="12.3.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#spect_filtering_final_bhef"><i class="fa fa-check"></i><b>12.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="12.3.4" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#detection-and-quantification-accuracy-3"><i class="fa fa-check"></i><b>12.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="12.3.5" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#stand-level-aggregation-3"><i class="fa fa-check"></i><b>12.3.5</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="validation_summary.html"><a href="validation_summary.html"><i class="fa fa-check"></i><b>13</b> Method Validation: Summary</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="raster_watershed" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Section 5</span> Structural Detection from CHM<a href="raster_watershed.html#raster_watershed" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We’ll first attempt to detect slash piles using raster-based methods with the DTM and CHM. These raster-based approaches are simple and efficient but can be limited in complex forest structures where piles might be occluded by overstory trees while rasterization simplifies/removes some of the rich 3D information in the point cloud.</p>
<p>When used for individual tree detection (ITD) the watershed segmentation technique treats the CHM as a topographic surface, where local maxima represent tree tops and valleys represent crown boundaries. A “water source” is conceptually placed at each local lowest point, and the surface is “flooded.” Barriers are generated where different “water sources” meet, forming watershed lines that delineate individual tree crowns.</p>
<p>two possible approaches for segmenting piles are to: 1) segment individual trees using a top-down approach and then use the canopy cover as a mask to then identify slash piles; 2) use a bottoms-up approach to perform slash pile segmentation on a lower “slice” of the CHM based on an expected maximum height of a pile</p>
<p>we’ll first try the bottoms-up approach using a CHM slice with a user-defined maximum height which should be set based on the pile construction prescription or expectation from the treatment type.</p>
<p>the first step in this approach is to isolate the lower slice of the CHM based on a maximum height threshold defined by the upper limit of the expected slash pile height. the expected height range to search for slash piles should be based on the pile construction prescription and potentially adjusted based on a sample of field-measured values after treatment completion</p>
<p>we’ll set a maximum height threshold which filters the CHM to only include raster cells lower than this threshold. we’ll also set a lower height limit based on the expected slash pile height for use later in removing candidate segments that are shorter than this lower limit.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="raster_watershed.html#cb75-1" tabindex="-1"></a><span class="co"># set the max and min expected pile height</span></span>
<span id="cb75-2"><a href="raster_watershed.html#cb75-2" tabindex="-1"></a>max_ht_m <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb75-3"><a href="raster_watershed.html#cb75-3" tabindex="-1"></a>min_ht_m <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb75-4"><a href="raster_watershed.html#cb75-4" tabindex="-1"></a><span class="co"># lower CHM slice</span></span>
<span id="cb75-5"><a href="raster_watershed.html#cb75-5" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb75-6"><a href="raster_watershed.html#cb75-6" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb75-7"><a href="raster_watershed.html#cb75-7" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-65-1.png" width="1008" /></p>
<p>already, it looks like the piles should be distinguishable objects from this data</p>
<div id="method-demonstration" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Method Demonstration<a href="raster_watershed.html#method-demonstration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>let’s run watershed segmentation using <code>lidR::watershed()</code> which is based on the bioconductor package <code>EBIimage</code></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="raster_watershed.html#cb76-1" tabindex="-1"></a>watershed_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb76-2"><a href="raster_watershed.html#cb76-2" tabindex="-1"></a>    <span class="at">chm =</span> cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="raster_watershed.html#cb76-3" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb76-4"><a href="raster_watershed.html#cb76-4" tabindex="-1"></a>    , <span class="at">th_tree =</span> <span class="fl">0.1</span></span>
<span id="cb76-5"><a href="raster_watershed.html#cb76-5" tabindex="-1"></a>  )()</span>
<span id="cb76-6"><a href="raster_watershed.html#cb76-6" tabindex="-1"></a><span class="co"># this is a raster</span></span>
<span id="cb76-7"><a href="raster_watershed.html#cb76-7" tabindex="-1"></a>watershed_ans</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 2740, 3473, 1  (nrow, ncol, nlyr)
## resolution  : 0.2, 0.2  (x, y)
## extent      : 499264.2, 499958.8, 4317599, 4318147  (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N (EPSG:32613) 
## source(s)   : memory
## varname     : chm_0.2m 
## name        : focal_mean 
## min value   :          1 
## max value   :       9892</code></pre>
<p>each value should be a unique “segment” which we can refine based on rules of expected size and shape of piles</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="raster_watershed.html#cb78-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(watershed_ans) <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="raster_watershed.html#cb78-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>##    layer value count
## 1      1  6409    17
## 2      1  2976    61
## 3      1  4232    15
## 4      1  2522    63
## 5      1  2831     4
## 6      1  6699   169
## 7      1  6871   556
## 8      1  7036   241
## 9      1  7154    14
## 10     1  3127     7</code></pre>
<p>where the “value” is the segment identifier and the count is the number of raster cells assigned to that segment</p>
<p>how many predicted segments are there?</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="raster_watershed.html#cb80-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(watershed_ans) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 9892</code></pre>
<p>let’s plot the raster return from the watershed segmentation</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="raster_watershed.html#cb82-1" tabindex="-1"></a>watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb82-2"><a href="raster_watershed.html#cb82-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb82-3"><a href="raster_watershed.html#cb82-3" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">c</span>(</span>
<span id="cb82-4"><a href="raster_watershed.html#cb82-4" tabindex="-1"></a>      viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb82-5"><a href="raster_watershed.html#cb82-5" tabindex="-1"></a>      , viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb82-6"><a href="raster_watershed.html#cb82-6" tabindex="-1"></a>      , viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb82-7"><a href="raster_watershed.html#cb82-7" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">sample</span>()</span>
<span id="cb82-8"><a href="raster_watershed.html#cb82-8" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb82-9"><a href="raster_watershed.html#cb82-9" tabindex="-1"></a>    , <span class="at">axes =</span> F</span>
<span id="cb82-10"><a href="raster_watershed.html#cb82-10" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-69-1.png" width="1008" /></p>
<p>plot it with the watershed segmented piles (brown) and the actual piles (blue)</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="raster_watershed.html#cb83-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb83-2"><a href="raster_watershed.html#cb83-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb83-3"><a href="raster_watershed.html#cb83-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb83-4"><a href="raster_watershed.html#cb83-4" tabindex="-1"></a>  watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb83-5"><a href="raster_watershed.html#cb83-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T)</span>
<span id="cb83-6"><a href="raster_watershed.html#cb83-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb83-7"><a href="raster_watershed.html#cb83-7" tabindex="-1"></a>)</span>
<span id="cb83-8"><a href="raster_watershed.html#cb83-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb83-9"><a href="raster_watershed.html#cb83-9" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb83-10"><a href="raster_watershed.html#cb83-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb83-11"><a href="raster_watershed.html#cb83-11" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb83-12"><a href="raster_watershed.html#cb83-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-70-1.png" width="1008" /></p>
<p>nice…we are getting close.</p>
<p>ideally, we want objects that: i) meet the height threshold over the entire surface of the segment (no doughnuts); ii) are not irregularly shaped (relatively few inward angles); iii) are circular in shape; and iv) meet an expected pile area threshold (minimum/maximum expected area)</p>
<div id="geometric-filtering-irregularity-filtering" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Geometric filtering: Irregularity Filtering<a href="raster_watershed.html#geometric-filtering-irregularity-filtering" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>now let’s try to filter based on the geometric properties of the watershed-detected segments.</p>
<p>we’ll make a convex hull of the polygons generated from a raster to smooth out the square edges and any inward curves or indentations, resulting in a boundary that’s always convex (no inward angles). using a convex hull we will be able to filter out:</p>
<ol style="list-style-type: decimal">
<li>watershed detected segments that were actually lower branches of a tree. these will be shaped like a doughnut with circular shape but a hole in the center</li>
<li>watershed detected segments that are irregularly shaped like coarse woody debris that was not organized into piles by humans</li>
</ol>
<p>let’s convert the watershed-detected segments from raster to vector data and create a convex hull of the shapes for comparison</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="raster_watershed.html#cb84-1" tabindex="-1"></a><span class="co"># vectors of segments</span></span>
<span id="cb84-2"><a href="raster_watershed.html#cb84-2" tabindex="-1"></a>watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb84-3"><a href="raster_watershed.html#cb84-3" tabindex="-1"></a>  watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb84-4"><a href="raster_watershed.html#cb84-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb84-5"><a href="raster_watershed.html#cb84-5" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-6"><a href="raster_watershed.html#cb84-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-7"><a href="raster_watershed.html#cb84-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-8"><a href="raster_watershed.html#cb84-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-9"><a href="raster_watershed.html#cb84-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-10"><a href="raster_watershed.html#cb84-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb84-11"><a href="raster_watershed.html#cb84-11" tabindex="-1"></a>  cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-12"><a href="raster_watershed.html#cb84-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb84-13"><a href="raster_watershed.html#cb84-13" tabindex="-1"></a><span class="co"># convex hulls of segments</span></span>
<span id="cb84-14"><a href="raster_watershed.html#cb84-14" tabindex="-1"></a>watershed_ans_poly_chull <span class="ot">&lt;-</span></span>
<span id="cb84-15"><a href="raster_watershed.html#cb84-15" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb84-16"><a href="raster_watershed.html#cb84-16" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-17"><a href="raster_watershed.html#cb84-17" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-18"><a href="raster_watershed.html#cb84-18" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-19"><a href="raster_watershed.html#cb84-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span></code></pre></div>
<p>lets make an example area that we’ll use to demonstrate the filtering process of the watershed detected segments</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="raster_watershed.html#cb85-1" tabindex="-1"></a>example_aoi <span class="ot">&lt;-</span></span>
<span id="cb85-2"><a href="raster_watershed.html#cb85-2" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb85-3"><a href="raster_watershed.html#cb85-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pile_id <span class="sc">==</span> <span class="dv">91</span>) <span class="sc">%&gt;%</span></span>
<span id="cb85-4"><a href="raster_watershed.html#cb85-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-5"><a href="raster_watershed.html#cb85-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb85-6"><a href="raster_watershed.html#cb85-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">55</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-7"><a href="raster_watershed.html#cb85-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-8"><a href="raster_watershed.html#cb85-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-9"><a href="raster_watershed.html#cb85-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span>
<span id="cb85-10"><a href="raster_watershed.html#cb85-10" tabindex="-1"></a>  <span class="co"># watershed_ans_poly %&gt;% </span></span>
<span id="cb85-11"><a href="raster_watershed.html#cb85-11" tabindex="-1"></a>  <span class="co"># # dplyr::filter(pred_id==241) %&gt;%</span></span>
<span id="cb85-12"><a href="raster_watershed.html#cb85-12" tabindex="-1"></a>  <span class="co"># dplyr::filter(pred_id==11916) %&gt;%</span></span>
<span id="cb85-13"><a href="raster_watershed.html#cb85-13" tabindex="-1"></a>  <span class="co"># # dplyr::slice_sample(n = 1) %&gt;%</span></span>
<span id="cb85-14"><a href="raster_watershed.html#cb85-14" tabindex="-1"></a>  <span class="co"># sf::st_bbox() %&gt;% </span></span>
<span id="cb85-15"><a href="raster_watershed.html#cb85-15" tabindex="-1"></a>  <span class="co"># sf::st_as_sfc() %&gt;% </span></span>
<span id="cb85-16"><a href="raster_watershed.html#cb85-16" tabindex="-1"></a>  <span class="co"># sf::st_buffer(55)</span></span>
<span id="cb85-17"><a href="raster_watershed.html#cb85-17" tabindex="-1"></a><span class="co"># chm of example</span></span>
<span id="cb85-18"><a href="raster_watershed.html#cb85-18" tabindex="-1"></a>buff_temp <span class="ot">&lt;-</span> <span class="fl">7.3</span></span>
<span id="cb85-19"><a href="raster_watershed.html#cb85-19" tabindex="-1"></a>example_aoi_chm <span class="ot">&lt;-</span> cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb85-20"><a href="raster_watershed.html#cb85-20" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb85-21"><a href="raster_watershed.html#cb85-21" tabindex="-1"></a>    example_aoi <span class="sc">%&gt;%</span> </span>
<span id="cb85-22"><a href="raster_watershed.html#cb85-22" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_buffer</span>(buff_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb85-23"><a href="raster_watershed.html#cb85-23" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb85-24"><a href="raster_watershed.html#cb85-24" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb85-25"><a href="raster_watershed.html#cb85-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb85-26"><a href="raster_watershed.html#cb85-26" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb85-27"><a href="raster_watershed.html#cb85-27" tabindex="-1"></a>    example_aoi <span class="sc">%&gt;%</span> </span>
<span id="cb85-28"><a href="raster_watershed.html#cb85-28" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_buffer</span>(buff_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb85-29"><a href="raster_watershed.html#cb85-29" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb85-30"><a href="raster_watershed.html#cb85-30" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb85-31"><a href="raster_watershed.html#cb85-31" tabindex="-1"></a>  )</span>
<span id="cb85-32"><a href="raster_watershed.html#cb85-32" tabindex="-1"></a><span class="co"># list of examples</span></span>
<span id="cb85-33"><a href="raster_watershed.html#cb85-33" tabindex="-1"></a>pred_id_temp <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb85-34"><a href="raster_watershed.html#cb85-34" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb85-35"><a href="raster_watershed.html#cb85-35" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span>
<span id="cb85-36"><a href="raster_watershed.html#cb85-36" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb85-37"><a href="raster_watershed.html#cb85-37" tabindex="-1"></a>plt_ortho_example <span class="ot">&lt;-</span> </span>
<span id="cb85-38"><a href="raster_watershed.html#cb85-38" tabindex="-1"></a>  <span class="fu">ortho_plt_fn</span>(</span>
<span id="cb85-39"><a href="raster_watershed.html#cb85-39" tabindex="-1"></a>    <span class="at">my_ortho_rast =</span> ortho_rast, <span class="at">stand =</span> example_aoi</span>
<span id="cb85-40"><a href="raster_watershed.html#cb85-40" tabindex="-1"></a>    , <span class="at">buffer =</span> buff_temp</span>
<span id="cb85-41"><a href="raster_watershed.html#cb85-41" tabindex="-1"></a>  )</span></code></pre></div>
<p>here is the CHM of the example area. can you pick out the slash piles?</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="raster_watershed.html#cb86-1" tabindex="-1"></a>example_aoi_chm <span class="sc">%&gt;%</span> </span>
<span id="cb86-2"><a href="raster_watershed.html#cb86-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb86-3"><a href="raster_watershed.html#cb86-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-4"><a href="raster_watershed.html#cb86-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb86-5"><a href="raster_watershed.html#cb86-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span>f)) <span class="sc">+</span></span>
<span id="cb86-6"><a href="raster_watershed.html#cb86-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb86-7"><a href="raster_watershed.html#cb86-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="sc">+</span></span>
<span id="cb86-8"><a href="raster_watershed.html#cb86-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;CHM (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb86-9"><a href="raster_watershed.html#cb86-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb86-10"><a href="raster_watershed.html#cb86-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb86-11"><a href="raster_watershed.html#cb86-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb86-12"><a href="raster_watershed.html#cb86-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-73-1.png" width="1008" /></p>
<p>here is the RGB of the example area. can you pick out the slash piles?</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="raster_watershed.html#cb87-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span> </span>
<span id="cb87-2"><a href="raster_watershed.html#cb87-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-75-1.png" width="1008" /></p>
<p>we’ll add on the ground truth piles in blue on the RGB. how many did you find? be honest.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="raster_watershed.html#cb88-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb88-2"><a href="raster_watershed.html#cb88-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb88-3"><a href="raster_watershed.html#cb88-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb88-4"><a href="raster_watershed.html#cb88-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb88-5"><a href="raster_watershed.html#cb88-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb88-6"><a href="raster_watershed.html#cb88-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb88-7"><a href="raster_watershed.html#cb88-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb88-8"><a href="raster_watershed.html#cb88-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb88-9"><a href="raster_watershed.html#cb88-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb88-10"><a href="raster_watershed.html#cb88-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb88-11"><a href="raster_watershed.html#cb88-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb88-12"><a href="raster_watershed.html#cb88-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb88-13"><a href="raster_watershed.html#cb88-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb88-14"><a href="raster_watershed.html#cb88-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb88-15"><a href="raster_watershed.html#cb88-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb88-16"><a href="raster_watershed.html#cb88-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-77-1.png" width="1008" /></p>
<p>would you have done better if you had both the CHM and RGB data?</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="raster_watershed.html#cb89-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb89-2"><a href="raster_watershed.html#cb89-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb89-3"><a href="raster_watershed.html#cb89-3" tabindex="-1"></a>    <span class="at">data =</span> example_aoi_chm <span class="sc">%&gt;%</span> </span>
<span id="cb89-4"><a href="raster_watershed.html#cb89-4" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb89-5"><a href="raster_watershed.html#cb89-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb89-6"><a href="raster_watershed.html#cb89-6" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span>f)</span>
<span id="cb89-7"><a href="raster_watershed.html#cb89-7" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.4</span></span>
<span id="cb89-8"><a href="raster_watershed.html#cb89-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb89-9"><a href="raster_watershed.html#cb89-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="sc">+</span></span>
<span id="cb89-10"><a href="raster_watershed.html#cb89-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb89-11"><a href="raster_watershed.html#cb89-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb89-12"><a href="raster_watershed.html#cb89-12" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb89-13"><a href="raster_watershed.html#cb89-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb89-14"><a href="raster_watershed.html#cb89-14" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb89-15"><a href="raster_watershed.html#cb89-15" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-16"><a href="raster_watershed.html#cb89-16" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb89-17"><a href="raster_watershed.html#cb89-17" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb89-18"><a href="raster_watershed.html#cb89-18" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb89-19"><a href="raster_watershed.html#cb89-19" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb89-20"><a href="raster_watershed.html#cb89-20" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb89-21"><a href="raster_watershed.html#cb89-21" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb89-22"><a href="raster_watershed.html#cb89-22" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb89-23"><a href="raster_watershed.html#cb89-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb89-24"><a href="raster_watershed.html#cb89-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-79-1.png" width="1008" /></p>
<p>now, we’ll plot our example watershed detected segments as vectors (brown) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="raster_watershed.html#cb90-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb90-2"><a href="raster_watershed.html#cb90-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb90-3"><a href="raster_watershed.html#cb90-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb90-4"><a href="raster_watershed.html#cb90-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb90-5"><a href="raster_watershed.html#cb90-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb90-6"><a href="raster_watershed.html#cb90-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb90-7"><a href="raster_watershed.html#cb90-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb90-8"><a href="raster_watershed.html#cb90-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb90-9"><a href="raster_watershed.html#cb90-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb90-10"><a href="raster_watershed.html#cb90-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb90-11"><a href="raster_watershed.html#cb90-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb90-12"><a href="raster_watershed.html#cb90-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb90-13"><a href="raster_watershed.html#cb90-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb90-14"><a href="raster_watershed.html#cb90-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb90-15"><a href="raster_watershed.html#cb90-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb90-16"><a href="raster_watershed.html#cb90-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span></span>
<span id="cb90-17"><a href="raster_watershed.html#cb90-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb90-18"><a href="raster_watershed.html#cb90-18" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb90-19"><a href="raster_watershed.html#cb90-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb90-20"><a href="raster_watershed.html#cb90-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb90-21"><a href="raster_watershed.html#cb90-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb90-22"><a href="raster_watershed.html#cb90-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-81-1.png" width="1008" /></p>
<p>notice how the watershed detected segments have “blocky” outlines since they were generated from the CHM raster</p>
<p>let’s plot our example watershed detected segments as vectors (brown) and convex hull of the segments (orange) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="raster_watershed.html#cb91-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb91-2"><a href="raster_watershed.html#cb91-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb91-3"><a href="raster_watershed.html#cb91-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb91-4"><a href="raster_watershed.html#cb91-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb91-5"><a href="raster_watershed.html#cb91-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb91-6"><a href="raster_watershed.html#cb91-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb91-7"><a href="raster_watershed.html#cb91-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-8"><a href="raster_watershed.html#cb91-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb91-9"><a href="raster_watershed.html#cb91-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb91-10"><a href="raster_watershed.html#cb91-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb91-11"><a href="raster_watershed.html#cb91-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb91-12"><a href="raster_watershed.html#cb91-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb91-13"><a href="raster_watershed.html#cb91-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb91-14"><a href="raster_watershed.html#cb91-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-15"><a href="raster_watershed.html#cb91-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb91-16"><a href="raster_watershed.html#cb91-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span></span>
<span id="cb91-17"><a href="raster_watershed.html#cb91-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb91-18"><a href="raster_watershed.html#cb91-18" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb91-19"><a href="raster_watershed.html#cb91-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb91-20"><a href="raster_watershed.html#cb91-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-21"><a href="raster_watershed.html#cb91-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb91-22"><a href="raster_watershed.html#cb91-22" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span></span>
<span id="cb91-23"><a href="raster_watershed.html#cb91-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb91-24"><a href="raster_watershed.html#cb91-24" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb91-25"><a href="raster_watershed.html#cb91-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-26"><a href="raster_watershed.html#cb91-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb91-27"><a href="raster_watershed.html#cb91-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-83-1.png" width="1008" /></p>
<p>notice how the most irregularly-shaped predicted segments have much less overlap with the convex hull shapes than the more regularly shaped segments</p>
<p>let’s filter out segments that have holes in them or are very irregularly shaped by comparing the area of the polygon and convex hull</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="raster_watershed.html#cb92-1" tabindex="-1"></a><span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb92-2"><a href="raster_watershed.html#cb92-2" tabindex="-1"></a>pct_chull_overlap <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb92-3"><a href="raster_watershed.html#cb92-3" tabindex="-1"></a><span class="co"># compare areas</span></span>
<span id="cb92-4"><a href="raster_watershed.html#cb92-4" tabindex="-1"></a>watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb92-5"><a href="raster_watershed.html#cb92-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">poly_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb92-6"><a href="raster_watershed.html#cb92-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb92-7"><a href="raster_watershed.html#cb92-7" tabindex="-1"></a>    watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb92-8"><a href="raster_watershed.html#cb92-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb92-9"><a href="raster_watershed.html#cb92-9" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb92-10"><a href="raster_watershed.html#cb92-10" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb92-11"><a href="raster_watershed.html#cb92-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb92-12"><a href="raster_watershed.html#cb92-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb92-13"><a href="raster_watershed.html#cb92-13" tabindex="-1"></a>    <span class="at">pct_chull =</span> poly_area_m2<span class="sc">/</span>chull_area_m2</span>
<span id="cb92-14"><a href="raster_watershed.html#cb92-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb92-15"><a href="raster_watershed.html#cb92-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb92-16"><a href="raster_watershed.html#cb92-16" tabindex="-1"></a>    pct_chull <span class="sc">&gt;=</span> pct_chull_overlap</span>
<span id="cb92-17"><a href="raster_watershed.html#cb92-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb92-18"><a href="raster_watershed.html#cb92-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span></code></pre></div>
<p>let’s make a function to ingest a spatial data frame and return polygons filtered for irregularity using this convex hull process</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="raster_watershed.html#cb93-1" tabindex="-1"></a>st_irregular_remove <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb93-2"><a href="raster_watershed.html#cb93-2" tabindex="-1"></a>  sf_data</span>
<span id="cb93-3"><a href="raster_watershed.html#cb93-3" tabindex="-1"></a>  <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb93-4"><a href="raster_watershed.html#cb93-4" tabindex="-1"></a>  , <span class="at">pct_chull_overlap =</span> <span class="fl">0.7</span></span>
<span id="cb93-5"><a href="raster_watershed.html#cb93-5" tabindex="-1"></a>) {</span>
<span id="cb93-6"><a href="raster_watershed.html#cb93-6" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb93-7"><a href="raster_watershed.html#cb93-7" tabindex="-1"></a>  <span class="co"># if not polygons</span></span>
<span id="cb93-8"><a href="raster_watershed.html#cb93-8" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">all</span>()) ){</span>
<span id="cb93-9"><a href="raster_watershed.html#cb93-9" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb93-10"><a href="raster_watershed.html#cb93-10" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb93-11"><a href="raster_watershed.html#cb93-11" tabindex="-1"></a>    ))</span>
<span id="cb93-12"><a href="raster_watershed.html#cb93-12" tabindex="-1"></a>  }</span>
<span id="cb93-13"><a href="raster_watershed.html#cb93-13" tabindex="-1"></a>  <span class="co"># convex hulls of segments</span></span>
<span id="cb93-14"><a href="raster_watershed.html#cb93-14" tabindex="-1"></a>  poly_chull <span class="ot">&lt;-</span></span>
<span id="cb93-15"><a href="raster_watershed.html#cb93-15" tabindex="-1"></a>    sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb93-16"><a href="raster_watershed.html#cb93-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb93-17"><a href="raster_watershed.html#cb93-17" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb93-18"><a href="raster_watershed.html#cb93-18" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb93-19"><a href="raster_watershed.html#cb93-19" tabindex="-1"></a>    <span class="co"># dplyr::filter(sf::st_is_valid(.))</span></span>
<span id="cb93-20"><a href="raster_watershed.html#cb93-20" tabindex="-1"></a>  <span class="co"># compare areas</span></span>
<span id="cb93-21"><a href="raster_watershed.html#cb93-21" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(poly_chull)<span class="sc">!=</span><span class="fu">nrow</span>(sf_data)){</span>
<span id="cb93-22"><a href="raster_watershed.html#cb93-22" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;could not make valid convex hulls from provided polygon data&quot;</span>)</span>
<span id="cb93-23"><a href="raster_watershed.html#cb93-23" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb93-24"><a href="raster_watershed.html#cb93-24" tabindex="-1"></a>    area_comp <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb93-25"><a href="raster_watershed.html#cb93-25" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb93-26"><a href="raster_watershed.html#cb93-26" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb93-27"><a href="raster_watershed.html#cb93-27" tabindex="-1"></a>        poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb93-28"><a href="raster_watershed.html#cb93-28" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb93-29"><a href="raster_watershed.html#cb93-29" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(chull_area_xxxx) <span class="sc">%&gt;%</span> </span>
<span id="cb93-30"><a href="raster_watershed.html#cb93-30" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb93-31"><a href="raster_watershed.html#cb93-31" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb93-32"><a href="raster_watershed.html#cb93-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb93-33"><a href="raster_watershed.html#cb93-33" tabindex="-1"></a>        <span class="at">pct_chull =</span> area_xxxx<span class="sc">/</span>chull_area_xxxx</span>
<span id="cb93-34"><a href="raster_watershed.html#cb93-34" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb93-35"><a href="raster_watershed.html#cb93-35" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb93-36"><a href="raster_watershed.html#cb93-36" tabindex="-1"></a>        pct_chull <span class="sc">&gt;=</span> pct_chull_overlap</span>
<span id="cb93-37"><a href="raster_watershed.html#cb93-37" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb93-38"><a href="raster_watershed.html#cb93-38" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(area_xxxx,chull_area_xxxx))</span>
<span id="cb93-39"><a href="raster_watershed.html#cb93-39" tabindex="-1"></a>    <span class="fu">return</span>(area_comp)</span>
<span id="cb93-40"><a href="raster_watershed.html#cb93-40" tabindex="-1"></a>  }</span>
<span id="cb93-41"><a href="raster_watershed.html#cb93-41" tabindex="-1"></a>}</span></code></pre></div>
<p>run it</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="raster_watershed.html#cb94-1" tabindex="-1"></a><span class="co"># run it</span></span>
<span id="cb94-2"><a href="raster_watershed.html#cb94-2" tabindex="-1"></a>watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span></span>
<span id="cb94-3"><a href="raster_watershed.html#cb94-3" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb94-4"><a href="raster_watershed.html#cb94-4" tabindex="-1"></a>    <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> pct_chull_overlap) <span class="sc">%&gt;%</span> </span>
<span id="cb94-5"><a href="raster_watershed.html#cb94-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span></code></pre></div>
<p>how many piles are remaining after this shape irregularity filtering?</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="raster_watershed.html#cb95-1" tabindex="-1"></a><span class="fu">length</span>(watershed_keep_overlaps_chull_pred_id)</span></code></pre></div>
<pre><code>## [1] 9163</code></pre>
<p>now, we’ll look at which piles meet the minimum overlap threshold (black outline) between the segmented polygon and the convex hull and will be kept compared to those that did not meet the irregularity threshold (red) and will be removed</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="raster_watershed.html#cb97-1" tabindex="-1"></a>p_temp <span class="ot">&lt;-</span> plt_ortho_example <span class="sc">+</span></span>
<span id="cb97-2"><a href="raster_watershed.html#cb97-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb97-3"><a href="raster_watershed.html#cb97-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb97-4"><a href="raster_watershed.html#cb97-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb97-5"><a href="raster_watershed.html#cb97-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb97-6"><a href="raster_watershed.html#cb97-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb97-7"><a href="raster_watershed.html#cb97-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb97-8"><a href="raster_watershed.html#cb97-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb97-9"><a href="raster_watershed.html#cb97-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb97-10"><a href="raster_watershed.html#cb97-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb97-11"><a href="raster_watershed.html#cb97-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb97-12"><a href="raster_watershed.html#cb97-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb97-13"><a href="raster_watershed.html#cb97-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb97-14"><a href="raster_watershed.html#cb97-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-15"><a href="raster_watershed.html#cb97-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb97-16"><a href="raster_watershed.html#cb97-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span></span>
<span id="cb97-17"><a href="raster_watershed.html#cb97-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb97-18"><a href="raster_watershed.html#cb97-18" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb97-19"><a href="raster_watershed.html#cb97-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb97-20"><a href="raster_watershed.html#cb97-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-21"><a href="raster_watershed.html#cb97-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb97-22"><a href="raster_watershed.html#cb97-22" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb97-23"><a href="raster_watershed.html#cb97-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb97-24"><a href="raster_watershed.html#cb97-24" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb97-25"><a href="raster_watershed.html#cb97-25" tabindex="-1"></a>        <span class="at">meets_overlap =</span> pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id</span>
<span id="cb97-26"><a href="raster_watershed.html#cb97-26" tabindex="-1"></a>      )</span>
<span id="cb97-27"><a href="raster_watershed.html#cb97-27" tabindex="-1"></a>    , ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> meets_overlap)</span>
<span id="cb97-28"><a href="raster_watershed.html#cb97-28" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb97-29"><a href="raster_watershed.html#cb97-29" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-30"><a href="raster_watershed.html#cb97-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb97-31"><a href="raster_watershed.html#cb97-31" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb97-32"><a href="raster_watershed.html#cb97-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span>
<span id="cb97-33"><a href="raster_watershed.html#cb97-33" tabindex="-1"></a>p_temp</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-89-1.png" width="1008" /></p>
<p>let’s see which predictions we are left with after filtering for segment shape irregularity with based on the overlap with the convex hull</p>
<p>plot the remaining example watershed detected segments as vectors (brown) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="raster_watershed.html#cb98-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb98-2"><a href="raster_watershed.html#cb98-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb98-3"><a href="raster_watershed.html#cb98-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb98-4"><a href="raster_watershed.html#cb98-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb98-5"><a href="raster_watershed.html#cb98-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb98-6"><a href="raster_watershed.html#cb98-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb98-7"><a href="raster_watershed.html#cb98-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-8"><a href="raster_watershed.html#cb98-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb98-9"><a href="raster_watershed.html#cb98-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb98-10"><a href="raster_watershed.html#cb98-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb98-11"><a href="raster_watershed.html#cb98-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb98-12"><a href="raster_watershed.html#cb98-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb98-13"><a href="raster_watershed.html#cb98-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb98-14"><a href="raster_watershed.html#cb98-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-15"><a href="raster_watershed.html#cb98-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb98-16"><a href="raster_watershed.html#cb98-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span></span>
<span id="cb98-17"><a href="raster_watershed.html#cb98-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb98-18"><a href="raster_watershed.html#cb98-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id)</span>
<span id="cb98-19"><a href="raster_watershed.html#cb98-19" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb98-20"><a href="raster_watershed.html#cb98-20" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb98-21"><a href="raster_watershed.html#cb98-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-22"><a href="raster_watershed.html#cb98-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb98-23"><a href="raster_watershed.html#cb98-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-91-1.png" width="1008" /></p>
<p>it looks like the filtering using convex hulls successfully removed most segments with irregular shapes and holes.</p>
<p>following this, we’ll apply an area filter based on the expected minimum and maximum pile areas and then we will apply a circularity filter that uses least squares circle fitting to remove non-circular shapes. this expected area and geometric shape filtering is performed to ensure that only the most likely slash pile candidates are retained.</p>
</div>
<div id="area-filtering" class="section level3 hasAnchor" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Area Filtering<a href="raster_watershed.html#area-filtering" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>apply an area filter based on the minimum and maximum expected pile areas. in practice, the expected area range defined here would be based on the pile construction prescription and potentially adjusted based on a sample of field-measured values after treatment completion</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="raster_watershed.html#cb99-1" tabindex="-1"></a><span class="do">##### area thresholds</span></span>
<span id="cb99-2"><a href="raster_watershed.html#cb99-2" tabindex="-1"></a>min_area_m2 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb99-3"><a href="raster_watershed.html#cb99-3" tabindex="-1"></a><span class="co"># Two standard US parking spaces, typically measuring 9 feet by 18 feet, </span></span>
<span id="cb99-4"><a href="raster_watershed.html#cb99-4" tabindex="-1"></a><span class="co"># are roughly equivalent to 30.25 square meters. Each space is approximately 15.125 square meters.</span></span>
<span id="cb99-5"><a href="raster_watershed.html#cb99-5" tabindex="-1"></a><span class="co"># 15.125*3</span></span>
<span id="cb99-6"><a href="raster_watershed.html#cb99-6" tabindex="-1"></a>max_area_m2 <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb99-7"><a href="raster_watershed.html#cb99-7" tabindex="-1"></a></span>
<span id="cb99-8"><a href="raster_watershed.html#cb99-8" tabindex="-1"></a><span class="co"># filter the remaining segments by area and st_irregular_remove removes irregular preds</span></span>
<span id="cb99-9"><a href="raster_watershed.html#cb99-9" tabindex="-1"></a>watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb99-10"><a href="raster_watershed.html#cb99-10" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb99-11"><a href="raster_watershed.html#cb99-11" tabindex="-1"></a>    <span class="co"># dplyr::filter(pred_id %in% watershed_keep_overlaps_chull_pred_id) %&gt;% </span></span>
<span id="cb99-12"><a href="raster_watershed.html#cb99-12" tabindex="-1"></a>    <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> pct_chull_overlap) <span class="sc">%&gt;%</span></span>
<span id="cb99-13"><a href="raster_watershed.html#cb99-13" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb99-14"><a href="raster_watershed.html#cb99-14" tabindex="-1"></a>    <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb99-15"><a href="raster_watershed.html#cb99-15" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb99-16"><a href="raster_watershed.html#cb99-16" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb99-17"><a href="raster_watershed.html#cb99-17" tabindex="-1"></a>      <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb99-18"><a href="raster_watershed.html#cb99-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb99-19"><a href="raster_watershed.html#cb99-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(area_xxxx))</span></code></pre></div>
<p>how many piles are remaining after the shape irregularity filtering and area filtering?</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="raster_watershed.html#cb100-1" tabindex="-1"></a>watershed_ans_poly <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 1289</code></pre>
<p>example of watershed detected segments as vectors (brown) filtered to remove irregular shapes and segments outside of the expected area thresholds; compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="raster_watershed.html#cb102-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb102-2"><a href="raster_watershed.html#cb102-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb102-3"><a href="raster_watershed.html#cb102-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb102-4"><a href="raster_watershed.html#cb102-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb102-5"><a href="raster_watershed.html#cb102-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb102-6"><a href="raster_watershed.html#cb102-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb102-7"><a href="raster_watershed.html#cb102-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb102-8"><a href="raster_watershed.html#cb102-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb102-9"><a href="raster_watershed.html#cb102-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb102-10"><a href="raster_watershed.html#cb102-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb102-11"><a href="raster_watershed.html#cb102-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb102-12"><a href="raster_watershed.html#cb102-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb102-13"><a href="raster_watershed.html#cb102-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb102-14"><a href="raster_watershed.html#cb102-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-15"><a href="raster_watershed.html#cb102-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb102-16"><a href="raster_watershed.html#cb102-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb102-17"><a href="raster_watershed.html#cb102-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb102-18"><a href="raster_watershed.html#cb102-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id)</span>
<span id="cb102-19"><a href="raster_watershed.html#cb102-19" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb102-20"><a href="raster_watershed.html#cb102-20" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb102-21"><a href="raster_watershed.html#cb102-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-22"><a href="raster_watershed.html#cb102-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb102-23"><a href="raster_watershed.html#cb102-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-95-1.png" width="1008" /></p>
<p>it looks like we are on the right track. now we need to remove the remaining candidate segments that do not meet our expectations for having a circular base</p>
</div>
<div id="geometric-filtering-circularity-filtering" class="section level3 hasAnchor" number="5.1.3">
<h3><span class="header-section-number">5.1.3</span> Geometric filtering: Circularity Filtering<a href="raster_watershed.html#geometric-filtering-circularity-filtering" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>now, let’s apply a circle-fitting algorithm to remove non-circular segments from the remaining segments</p>
<p>Least squares circle fitting is a method to find the circle that best approximates a set of data points by minimizing the sum of the squared distances between the points and the circle. The <code>lidR::fit_circle()</code> function finds the best-fitting flat, horizontal circle for a group of 3D points, even if some of those points are messy or don’t quite fit. It determines the circle’s center and size, and also provides an “angular range” to show how much of a complete circle the points actually form, which is a more reliable measure than a simple error value (e.g. RMSE).</p>
<p>The “angular range” tells you how much of a complete circle the points in the watershed-detected segment actually cover. Imagine drawing a circle, and then only having points along a part of its edge, here’s how to interpret it:</p>
<ul>
<li>360 degrees suggests the points form a full, unbroken circle, like the base of a perfectly round slash pile.</li>
<li>180 degrees would mean the points only form a half-circle or a semi-circle.</li>
</ul>
<p>A smaller range (e.g., 90 degrees) indicates just a partial arc or a small curve. This can help us determine if a group of points truly represents a circular shape, which is useful for identifying objects like slash piles that are expected to have a round base.</p>
<p>we’ll define a function to pass our <code>sf</code> polygon data of watershed detected segments and return a <code>sf</code> data of the fitted circles</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="raster_watershed.html#cb103-1" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-2"><a href="raster_watershed.html#cb103-2" tabindex="-1"></a><span class="co"># 1)</span></span>
<span id="cb103-3"><a href="raster_watershed.html#cb103-3" tabindex="-1"></a><span class="co"># function to return sf circle from xy center and radius in given crs</span></span>
<span id="cb103-4"><a href="raster_watershed.html#cb103-4" tabindex="-1"></a><span class="co"># to handle return from common circle fitting algorithms</span></span>
<span id="cb103-5"><a href="raster_watershed.html#cb103-5" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-6"><a href="raster_watershed.html#cb103-6" tabindex="-1"></a>point_xy_radius_to_circle_sf <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb103-7"><a href="raster_watershed.html#cb103-7" tabindex="-1"></a>  center_x</span>
<span id="cb103-8"><a href="raster_watershed.html#cb103-8" tabindex="-1"></a>  , center_y</span>
<span id="cb103-9"><a href="raster_watershed.html#cb103-9" tabindex="-1"></a>  , radius</span>
<span id="cb103-10"><a href="raster_watershed.html#cb103-10" tabindex="-1"></a>  , <span class="at">crs =</span> <span class="cn">NULL</span></span>
<span id="cb103-11"><a href="raster_watershed.html#cb103-11" tabindex="-1"></a>) {</span>
<span id="cb103-12"><a href="raster_watershed.html#cb103-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(crs)){<span class="fu">stop</span>(<span class="st">&quot;need a crs, guy&quot;</span>)}</span>
<span id="cb103-13"><a href="raster_watershed.html#cb103-13" tabindex="-1"></a>  <span class="co"># create a point geometry object</span></span>
<span id="cb103-14"><a href="raster_watershed.html#cb103-14" tabindex="-1"></a>  center_point <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(center_x, center_y))</span>
<span id="cb103-15"><a href="raster_watershed.html#cb103-15" tabindex="-1"></a>  <span class="co"># create an sf object from the point</span></span>
<span id="cb103-16"><a href="raster_watershed.html#cb103-16" tabindex="-1"></a>  center_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_sf</span>(</span>
<span id="cb103-17"><a href="raster_watershed.html#cb103-17" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb103-18"><a href="raster_watershed.html#cb103-18" tabindex="-1"></a>      <span class="at">center_x =</span> center_x</span>
<span id="cb103-19"><a href="raster_watershed.html#cb103-19" tabindex="-1"></a>      , <span class="at">center_y =</span> center_y</span>
<span id="cb103-20"><a href="raster_watershed.html#cb103-20" tabindex="-1"></a>      , <span class="at">radius =</span> radius</span>
<span id="cb103-21"><a href="raster_watershed.html#cb103-21" tabindex="-1"></a>    )</span>
<span id="cb103-22"><a href="raster_watershed.html#cb103-22" tabindex="-1"></a>    , <span class="at">geometry =</span> sf<span class="sc">::</span><span class="fu">st_sfc</span>(center_point)</span>
<span id="cb103-23"><a href="raster_watershed.html#cb103-23" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb103-24"><a href="raster_watershed.html#cb103-24" tabindex="-1"></a>  )</span>
<span id="cb103-25"><a href="raster_watershed.html#cb103-25" tabindex="-1"></a>  <span class="co"># create the circle geometry by buffering the point</span></span>
<span id="cb103-26"><a href="raster_watershed.html#cb103-26" tabindex="-1"></a>  circle_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(center_sf, <span class="at">dist =</span> radius)</span>
<span id="cb103-27"><a href="raster_watershed.html#cb103-27" tabindex="-1"></a>  <span class="fu">return</span>(circle_sf)</span>
<span id="cb103-28"><a href="raster_watershed.html#cb103-28" tabindex="-1"></a>}</span>
<span id="cb103-29"><a href="raster_watershed.html#cb103-29" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-30"><a href="raster_watershed.html#cb103-30" tabindex="-1"></a><span class="co"># 2)</span></span>
<span id="cb103-31"><a href="raster_watershed.html#cb103-31" tabindex="-1"></a><span class="co"># function to generate 2d xy points from polygon feature</span></span>
<span id="cb103-32"><a href="raster_watershed.html#cb103-32" tabindex="-1"></a><span class="co"># to pass to common circle fitting algorithms</span></span>
<span id="cb103-33"><a href="raster_watershed.html#cb103-33" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb103-34"><a href="raster_watershed.html#cb103-34" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-35"><a href="raster_watershed.html#cb103-35" tabindex="-1"></a>poly_to_points <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb103-36"><a href="raster_watershed.html#cb103-36" tabindex="-1"></a>  sf_data</span>
<span id="cb103-37"><a href="raster_watershed.html#cb103-37" tabindex="-1"></a>  , <span class="at">as_spatial =</span> F <span class="co"># if set to F, returns xy dataframe; if T returns sf data</span></span>
<span id="cb103-38"><a href="raster_watershed.html#cb103-38" tabindex="-1"></a>  , <span class="at">simplify_multipolygons =</span> F <span class="co"># if set to T, multipolygons are simplified by keeping the largest segment</span></span>
<span id="cb103-39"><a href="raster_watershed.html#cb103-39" tabindex="-1"></a>) {</span>
<span id="cb103-40"><a href="raster_watershed.html#cb103-40" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb103-41"><a href="raster_watershed.html#cb103-41" tabindex="-1"></a>  <span class="co"># just work with the first</span></span>
<span id="cb103-42"><a href="raster_watershed.html#cb103-42" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(sf_data)<span class="sc">&gt;</span><span class="dv">1</span>){<span class="fu">stop</span>(<span class="st">&quot;this function only works with a single record at a time&quot;</span>)}</span>
<span id="cb103-43"><a href="raster_watershed.html#cb103-43" tabindex="-1"></a>  <span class="co"># simplify_multipolygons</span></span>
<span id="cb103-44"><a href="raster_watershed.html#cb103-44" tabindex="-1"></a>  <span class="cf">if</span>(simplify_multipolygons){</span>
<span id="cb103-45"><a href="raster_watershed.html#cb103-45" tabindex="-1"></a>    sf_data <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb103-46"><a href="raster_watershed.html#cb103-46" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-47"><a href="raster_watershed.html#cb103-47" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb103-48"><a href="raster_watershed.html#cb103-48" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb103-49"><a href="raster_watershed.html#cb103-49" tabindex="-1"></a>  }</span>
<span id="cb103-50"><a href="raster_watershed.html#cb103-50" tabindex="-1"></a>  <span class="co"># get point coordinates</span></span>
<span id="cb103-51"><a href="raster_watershed.html#cb103-51" tabindex="-1"></a>  xy_temp <span class="ot">&lt;-</span> </span>
<span id="cb103-52"><a href="raster_watershed.html#cb103-52" tabindex="-1"></a>    sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb103-53"><a href="raster_watershed.html#cb103-53" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb103-54"><a href="raster_watershed.html#cb103-54" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb103-55"><a href="raster_watershed.html#cb103-55" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span> </span>
<span id="cb103-56"><a href="raster_watershed.html#cb103-56" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(x,y) <span class="sc">%&gt;%</span> </span>
<span id="cb103-57"><a href="raster_watershed.html#cb103-57" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">z=</span><span class="dv">0</span>)</span>
<span id="cb103-58"><a href="raster_watershed.html#cb103-58" tabindex="-1"></a>  <span class="co"># as_spatial</span></span>
<span id="cb103-59"><a href="raster_watershed.html#cb103-59" tabindex="-1"></a>  <span class="cf">if</span>(as_spatial){</span>
<span id="cb103-60"><a href="raster_watershed.html#cb103-60" tabindex="-1"></a>    xy_temp <span class="ot">&lt;-</span> xy_temp <span class="sc">%&gt;%</span> </span>
<span id="cb103-61"><a href="raster_watershed.html#cb103-61" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data), <span class="at">remove =</span> F)</span>
<span id="cb103-62"><a href="raster_watershed.html#cb103-62" tabindex="-1"></a>  }</span>
<span id="cb103-63"><a href="raster_watershed.html#cb103-63" tabindex="-1"></a>  <span class="fu">return</span>(xy_temp)</span>
<span id="cb103-64"><a href="raster_watershed.html#cb103-64" tabindex="-1"></a>}</span>
<span id="cb103-65"><a href="raster_watershed.html#cb103-65" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;% </span></span>
<span id="cb103-66"><a href="raster_watershed.html#cb103-66" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id %in% c(7717)) %&gt;%</span></span>
<span id="cb103-67"><a href="raster_watershed.html#cb103-67" tabindex="-1"></a><span class="co">#   # poly_to_points(as_spatial = T) %&gt;% </span></span>
<span id="cb103-68"><a href="raster_watershed.html#cb103-68" tabindex="-1"></a><span class="co">#   poly_to_points(as_spatial = F) %&gt;% </span></span>
<span id="cb103-69"><a href="raster_watershed.html#cb103-69" tabindex="-1"></a><span class="co">#   ggplot() + </span></span>
<span id="cb103-70"><a href="raster_watershed.html#cb103-70" tabindex="-1"></a><span class="co">#     # geom_sf()</span></span>
<span id="cb103-71"><a href="raster_watershed.html#cb103-71" tabindex="-1"></a><span class="co">#     geom_point(aes(x=x,y=y))</span></span>
<span id="cb103-72"><a href="raster_watershed.html#cb103-72" tabindex="-1"></a></span>
<span id="cb103-73"><a href="raster_watershed.html#cb103-73" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-74"><a href="raster_watershed.html#cb103-74" tabindex="-1"></a><span class="co"># 3)</span></span>
<span id="cb103-75"><a href="raster_watershed.html#cb103-75" tabindex="-1"></a><span class="co"># function to combine poly_to_points, lidR::fit_circle, and point_xy_radius_to_circle_sf</span></span>
<span id="cb103-76"><a href="raster_watershed.html#cb103-76" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb103-77"><a href="raster_watershed.html#cb103-77" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-78"><a href="raster_watershed.html#cb103-78" tabindex="-1"></a>poly_circle_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb103-79"><a href="raster_watershed.html#cb103-79" tabindex="-1"></a>  poly</span>
<span id="cb103-80"><a href="raster_watershed.html#cb103-80" tabindex="-1"></a>  <span class="co"># if set to T, multipolygons are simplified by keeping the largest segment</span></span>
<span id="cb103-81"><a href="raster_watershed.html#cb103-81" tabindex="-1"></a>  , <span class="at">simplify_multipolygons =</span> F</span>
<span id="cb103-82"><a href="raster_watershed.html#cb103-82" tabindex="-1"></a>  <span class="co"># number of iterations for the RANSAC fitting algorithm</span></span>
<span id="cb103-83"><a href="raster_watershed.html#cb103-83" tabindex="-1"></a>  , <span class="at">num_iterations =</span> <span class="dv">100</span></span>
<span id="cb103-84"><a href="raster_watershed.html#cb103-84" tabindex="-1"></a>  <span class="co"># threshold value; points are considered inliers if their residuals are below this value</span></span>
<span id="cb103-85"><a href="raster_watershed.html#cb103-85" tabindex="-1"></a>  , <span class="at">inlier_threshold =</span> <span class="fl">0.01</span></span>
<span id="cb103-86"><a href="raster_watershed.html#cb103-86" tabindex="-1"></a>) {</span>
<span id="cb103-87"><a href="raster_watershed.html#cb103-87" tabindex="-1"></a>  <span class="co"># poly_to_points</span></span>
<span id="cb103-88"><a href="raster_watershed.html#cb103-88" tabindex="-1"></a>  poly_to_points_ans <span class="ot">&lt;-</span> <span class="fu">poly_to_points</span>(poly, <span class="at">as_spatial =</span> F, <span class="at">simplify_multipolygons =</span> simplify_multipolygons)</span>
<span id="cb103-89"><a href="raster_watershed.html#cb103-89" tabindex="-1"></a>  <span class="co"># fit_circle</span></span>
<span id="cb103-90"><a href="raster_watershed.html#cb103-90" tabindex="-1"></a>  fit_circle_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">fit_circle</span>(</span>
<span id="cb103-91"><a href="raster_watershed.html#cb103-91" tabindex="-1"></a>    <span class="at">points =</span> poly_to_points_ans <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb103-92"><a href="raster_watershed.html#cb103-92" tabindex="-1"></a>    <span class="co"># number of iterations for the RANSAC fitting algorithm</span></span>
<span id="cb103-93"><a href="raster_watershed.html#cb103-93" tabindex="-1"></a>    , <span class="at">num_iterations =</span> num_iterations</span>
<span id="cb103-94"><a href="raster_watershed.html#cb103-94" tabindex="-1"></a>    <span class="co"># threshold value; points are considered inliers if their residuals are below this value</span></span>
<span id="cb103-95"><a href="raster_watershed.html#cb103-95" tabindex="-1"></a>    , <span class="at">inlier_threshold =</span> inlier_threshold</span>
<span id="cb103-96"><a href="raster_watershed.html#cb103-96" tabindex="-1"></a>  )</span>
<span id="cb103-97"><a href="raster_watershed.html#cb103-97" tabindex="-1"></a>  <span class="co"># point_xy_radius_to_circle_sf</span></span>
<span id="cb103-98"><a href="raster_watershed.html#cb103-98" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> <span class="fu">point_xy_radius_to_circle_sf</span>(</span>
<span id="cb103-99"><a href="raster_watershed.html#cb103-99" tabindex="-1"></a>    <span class="at">center_x =</span> fit_circle_ans<span class="sc">$</span>center_x</span>
<span id="cb103-100"><a href="raster_watershed.html#cb103-100" tabindex="-1"></a>    , <span class="at">center_y =</span> fit_circle_ans<span class="sc">$</span>center_y</span>
<span id="cb103-101"><a href="raster_watershed.html#cb103-101" tabindex="-1"></a>    , <span class="at">radius =</span> fit_circle_ans<span class="sc">$</span>radius</span>
<span id="cb103-102"><a href="raster_watershed.html#cb103-102" tabindex="-1"></a>    , <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(poly)</span>
<span id="cb103-103"><a href="raster_watershed.html#cb103-103" tabindex="-1"></a>  )</span>
<span id="cb103-104"><a href="raster_watershed.html#cb103-104" tabindex="-1"></a>  <span class="co"># add other vars</span></span>
<span id="cb103-105"><a href="raster_watershed.html#cb103-105" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> ans <span class="sc">%&gt;%</span> </span>
<span id="cb103-106"><a href="raster_watershed.html#cb103-106" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-107"><a href="raster_watershed.html#cb103-107" tabindex="-1"></a>      <span class="at">covered_arc_degree =</span> fit_circle_ans<span class="sc">$</span>covered_arc_degree</span>
<span id="cb103-108"><a href="raster_watershed.html#cb103-108" tabindex="-1"></a>      , <span class="at">percentage_inlier =</span> fit_circle_ans<span class="sc">$</span>percentage_inlier</span>
<span id="cb103-109"><a href="raster_watershed.html#cb103-109" tabindex="-1"></a>      , <span class="at">percentage_inside =</span> fit_circle_ans<span class="sc">$</span>percentage_inside</span>
<span id="cb103-110"><a href="raster_watershed.html#cb103-110" tabindex="-1"></a>      <span class="co"># , inliers = fit_circle_ans$inliers</span></span>
<span id="cb103-111"><a href="raster_watershed.html#cb103-111" tabindex="-1"></a>    )</span>
<span id="cb103-112"><a href="raster_watershed.html#cb103-112" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb103-113"><a href="raster_watershed.html#cb103-113" tabindex="-1"></a>  <span class="fu">return</span>(ans)</span>
<span id="cb103-114"><a href="raster_watershed.html#cb103-114" tabindex="-1"></a>}</span>
<span id="cb103-115"><a href="raster_watershed.html#cb103-115" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;%</span></span>
<span id="cb103-116"><a href="raster_watershed.html#cb103-116" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id == 7717) %&gt;%</span></span>
<span id="cb103-117"><a href="raster_watershed.html#cb103-117" tabindex="-1"></a><span class="co">#   poly_circle_fit() %&gt;%</span></span>
<span id="cb103-118"><a href="raster_watershed.html#cb103-118" tabindex="-1"></a><span class="co">#   ggplot() + geom_sf() + </span></span>
<span id="cb103-119"><a href="raster_watershed.html#cb103-119" tabindex="-1"></a><span class="co">#   geom_sf(</span></span>
<span id="cb103-120"><a href="raster_watershed.html#cb103-120" tabindex="-1"></a><span class="co">#     data = filtered_watershed_ans_poly %&gt;% dplyr::filter(pred_id == 7717) %&gt;% poly_to_points(as_spatial = T)</span></span>
<span id="cb103-121"><a href="raster_watershed.html#cb103-121" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb103-122"><a href="raster_watershed.html#cb103-122" tabindex="-1"></a></span>
<span id="cb103-123"><a href="raster_watershed.html#cb103-123" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;%</span></span>
<span id="cb103-124"><a href="raster_watershed.html#cb103-124" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id == 7717) %&gt;%</span></span>
<span id="cb103-125"><a href="raster_watershed.html#cb103-125" tabindex="-1"></a><span class="co">#   poly_circle_fit() %&gt;% </span></span>
<span id="cb103-126"><a href="raster_watershed.html#cb103-126" tabindex="-1"></a><span class="co">#   dplyr::glimpse()</span></span>
<span id="cb103-127"><a href="raster_watershed.html#cb103-127" tabindex="-1"></a></span>
<span id="cb103-128"><a href="raster_watershed.html#cb103-128" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-129"><a href="raster_watershed.html#cb103-129" tabindex="-1"></a><span class="co"># 4)</span></span>
<span id="cb103-130"><a href="raster_watershed.html#cb103-130" tabindex="-1"></a><span class="co"># function to combine poly_to_points, lidR::fit_circle, and point_xy_radius_to_circle_sf</span></span>
<span id="cb103-131"><a href="raster_watershed.html#cb103-131" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb103-132"><a href="raster_watershed.html#cb103-132" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb103-133"><a href="raster_watershed.html#cb103-133" tabindex="-1"></a>sf_data_circle_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data, <span class="at">num_iterations =</span> <span class="dv">100</span>) {</span>
<span id="cb103-134"><a href="raster_watershed.html#cb103-134" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb103-135"><a href="raster_watershed.html#cb103-135" tabindex="-1"></a>  <span class="co"># apply poly_circle_fit() to each row to get fitted circle sf data</span></span>
<span id="cb103-136"><a href="raster_watershed.html#cb103-136" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb103-137"><a href="raster_watershed.html#cb103-137" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb103-138"><a href="raster_watershed.html#cb103-138" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id_xxx =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb103-139"><a href="raster_watershed.html#cb103-139" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">nest_by</span>(id_xxx) <span class="sc">%&gt;%</span> </span>
<span id="cb103-140"><a href="raster_watershed.html#cb103-140" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-141"><a href="raster_watershed.html#cb103-141" tabindex="-1"></a>      <span class="at">circle_fit =</span> <span class="fu">poly_circle_fit</span>(<span class="at">poly =</span> data, <span class="at">num_iterations=</span>num_iterations)</span>
<span id="cb103-142"><a href="raster_watershed.html#cb103-142" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb103-143"><a href="raster_watershed.html#cb103-143" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(circle_fit)</span>
<span id="cb103-144"><a href="raster_watershed.html#cb103-144" tabindex="-1"></a>  <span class="co"># combine with original data but drop original geom</span></span>
<span id="cb103-145"><a href="raster_watershed.html#cb103-145" tabindex="-1"></a>  df <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb103-146"><a href="raster_watershed.html#cb103-146" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb103-147"><a href="raster_watershed.html#cb103-147" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(cf) <span class="sc">%&gt;%</span> </span>
<span id="cb103-148"><a href="raster_watershed.html#cb103-148" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data))</span>
<span id="cb103-149"><a href="raster_watershed.html#cb103-149" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb103-150"><a href="raster_watershed.html#cb103-150" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb103-151"><a href="raster_watershed.html#cb103-151" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s apply the <code>sf_data_circle_fit()</code> function we just defined fits the best circle using <code>lidR::fit_circle()</code> to each watershed detected segment to get a spatial data frame with the best fitting circle for each segment</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="raster_watershed.html#cb104-1" tabindex="-1"></a><span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb104-2"><a href="raster_watershed.html#cb104-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb104-3"><a href="raster_watershed.html#cb104-3" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="ot">&lt;-</span> <span class="fu">sf_data_circle_fit</span>(watershed_ans_poly, <span class="at">num_iterations =</span> <span class="dv">111</span>)</span>
<span id="cb104-4"><a href="raster_watershed.html#cb104-4" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb104-5"><a href="raster_watershed.html#cb104-5" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,289
## Columns: 9
## $ pred_id            &lt;dbl&gt; 8, 12, 20, 24, 26, 32, 38, 47, 50, 52, 53, 54, 55, …
## $ pct_chull          &lt;dbl&gt; 0.7577640, 0.7764706, 0.7197802, 0.8000000, 0.81012…
## $ center_x           &lt;dbl&gt; 499944.3, 499739.9, 499720.8, 499778.0, 499780.8, 4…
## $ center_y           &lt;dbl&gt; 4317698, 4317898, 4317853, 4318048, 4318065, 431761…
## $ radius             &lt;dbl&gt; 1.144859e+00, 1.305153e+00, 1.612613e+00, 4.499848e…
## $ covered_arc_degree &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, …
## $ percentage_inlier  &lt;dbl&gt; 0.22857143, 0.20000000, 0.12698413, 0.14583333, 0.2…
## $ percentage_inside  &lt;dbl&gt; 0.57142857, 0.45714286, 0.50793651, 0.10416667, 0.6…
## $ geometry           &lt;POLYGON [m]&gt; POLYGON ((499945.4 4317698,..., POLYGON ((4…</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="raster_watershed.html#cb106-1" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>let’s check out the distribution of the metrics that quantify the fit of the circle</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="raster_watershed.html#cb107-1" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="raster_watershed.html#cb107-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb107-3"><a href="raster_watershed.html#cb107-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(covered_arc_degree,percentage_inlier,percentage_inside) <span class="sc">%&gt;%</span></span>
<span id="cb107-4"><a href="raster_watershed.html#cb107-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb107-5"><a href="raster_watershed.html#cb107-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb107-6"><a href="raster_watershed.html#cb107-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb107-7"><a href="raster_watershed.html#cb107-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> ggplot2<span class="sc">::</span><span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb107-8"><a href="raster_watershed.html#cb107-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;rocket&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb107-9"><a href="raster_watershed.html#cb107-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb107-10"><a href="raster_watershed.html#cb107-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb107-11"><a href="raster_watershed.html#cb107-11" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb107-12"><a href="raster_watershed.html#cb107-12" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb107-13"><a href="raster_watershed.html#cb107-13" tabindex="-1"></a>      , <span class="at">axis.title.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb107-14"><a href="raster_watershed.html#cb107-14" tabindex="-1"></a>      , <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb107-15"><a href="raster_watershed.html#cb107-15" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb107-16"><a href="raster_watershed.html#cb107-16" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-99-1.png" width="1008" /></p>
<p>let’s look at the best fitting circles using the remaining piles from our example above</p>
<p>example of watershed detected segments as vectors (brown) filtered to remove irregular shapes and segments outside of the expected area thresholds; best fitting circle of the segments (orange); compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="raster_watershed.html#cb108-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb108-2"><a href="raster_watershed.html#cb108-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb108-3"><a href="raster_watershed.html#cb108-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb108-4"><a href="raster_watershed.html#cb108-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb108-5"><a href="raster_watershed.html#cb108-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb108-6"><a href="raster_watershed.html#cb108-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb108-7"><a href="raster_watershed.html#cb108-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb108-8"><a href="raster_watershed.html#cb108-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb108-9"><a href="raster_watershed.html#cb108-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb108-10"><a href="raster_watershed.html#cb108-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb108-11"><a href="raster_watershed.html#cb108-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb108-12"><a href="raster_watershed.html#cb108-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb108-13"><a href="raster_watershed.html#cb108-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb108-14"><a href="raster_watershed.html#cb108-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb108-15"><a href="raster_watershed.html#cb108-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb108-16"><a href="raster_watershed.html#cb108-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb108-17"><a href="raster_watershed.html#cb108-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb108-18"><a href="raster_watershed.html#cb108-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id)</span>
<span id="cb108-19"><a href="raster_watershed.html#cb108-19" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb108-20"><a href="raster_watershed.html#cb108-20" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb108-21"><a href="raster_watershed.html#cb108-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb108-22"><a href="raster_watershed.html#cb108-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb108-23"><a href="raster_watershed.html#cb108-23" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb108-24"><a href="raster_watershed.html#cb108-24" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb108-25"><a href="raster_watershed.html#cb108-25" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb108-26"><a href="raster_watershed.html#cb108-26" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb108-27"><a href="raster_watershed.html#cb108-27" tabindex="-1"></a>        <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_area</span>(.)) <span class="sc">&lt;</span> (<span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_area</span>(example_aoi))<span class="sc">*</span><span class="fl">0.5</span>)</span>
<span id="cb108-28"><a href="raster_watershed.html#cb108-28" tabindex="-1"></a>      )</span>
<span id="cb108-29"><a href="raster_watershed.html#cb108-29" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb108-30"><a href="raster_watershed.html#cb108-30" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb108-31"><a href="raster_watershed.html#cb108-31" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb108-32"><a href="raster_watershed.html#cb108-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-100-1.png" width="1008" /></p>
<p>the best fitting circles on the linear watershed detected segments are not very well fitting, we can filter using the intersection over union (IoU) between the circle and the predicted segment. we’ll use the IoU function we defined in this <a href="method-evaluation.html#iou_match">earlier section</a>.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="raster_watershed.html#cb109-1" tabindex="-1"></a>watershed_circle_fit_iou <span class="ot">&lt;-</span> </span>
<span id="cb109-2"><a href="raster_watershed.html#cb109-2" tabindex="-1"></a>  watershed_ans_poly<span class="sc">$</span>pred_id <span class="sc">%&gt;%</span> </span>
<span id="cb109-3"><a href="raster_watershed.html#cb109-3" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb109-4"><a href="raster_watershed.html#cb109-4" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb109-5"><a href="raster_watershed.html#cb109-5" tabindex="-1"></a>    <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb109-6"><a href="raster_watershed.html#cb109-6" tabindex="-1"></a>      <span class="at">gt_inst =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb109-7"><a href="raster_watershed.html#cb109-7" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x)</span>
<span id="cb109-8"><a href="raster_watershed.html#cb109-8" tabindex="-1"></a>      , <span class="at">gt_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb109-9"><a href="raster_watershed.html#cb109-9" tabindex="-1"></a>      , <span class="at">predictions =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb109-10"><a href="raster_watershed.html#cb109-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb109-11"><a href="raster_watershed.html#cb109-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span></span>
<span id="cb109-12"><a href="raster_watershed.html#cb109-12" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_pred_id =</span> pred_id)</span>
<span id="cb109-13"><a href="raster_watershed.html#cb109-13" tabindex="-1"></a>      , <span class="at">pred_id =</span> <span class="st">&quot;circ_pred_id&quot;</span></span>
<span id="cb109-14"><a href="raster_watershed.html#cb109-14" tabindex="-1"></a>      , <span class="at">min_iou_pct =</span> <span class="dv">0</span></span>
<span id="cb109-15"><a href="raster_watershed.html#cb109-15" tabindex="-1"></a>    )    </span>
<span id="cb109-16"><a href="raster_watershed.html#cb109-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb109-17"><a href="raster_watershed.html#cb109-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb109-18"><a href="raster_watershed.html#cb109-18" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb109-19"><a href="raster_watershed.html#cb109-19" tabindex="-1"></a>watershed_circle_fit_iou <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,279
## Columns: 5
## $ pred_id      &lt;dbl&gt; 8, 12, 20, 24, 26, 32, 38, 47, 52, 53, 54, 55, 56, 57, 76…
## $ i_area       &lt;dbl&gt; 2.28624273, 2.12113426, 3.82323811, 0.16347654, 2.5174554…
## $ u_area       &lt;dbl&gt; 4.269565, 5.867885, 9.582808, 4.952362, 4.961554, 12.6693…
## $ iou          &lt;dbl&gt; 0.535474346, 0.361481880, 0.398968460, 0.033009810, 0.507…
## $ circ_pred_id &lt;dbl&gt; 8, 12, 20, 24, 26, 32, 38, 47, 52, 53, 54, 55, 56, 57, 76…</code></pre>
<p>what is the distribution of IoU of the watershed segments and the best fit circle of those segments?</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="raster_watershed.html#cb111-1" tabindex="-1"></a>watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb111-2"><a href="raster_watershed.html#cb111-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> iou)) <span class="sc">+</span></span>
<span id="cb111-3"><a href="raster_watershed.html#cb111-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="st">&quot;navy&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb111-4"><a href="raster_watershed.html#cb111-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb111-5"><a href="raster_watershed.html#cb111-5" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;IoU of the watershed segments and the best fit circle&quot;</span></span>
<span id="cb111-6"><a href="raster_watershed.html#cb111-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb111-7"><a href="raster_watershed.html#cb111-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb111-8"><a href="raster_watershed.html#cb111-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb111-9"><a href="raster_watershed.html#cb111-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb111-10"><a href="raster_watershed.html#cb111-10" tabindex="-1"></a>    <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb111-11"><a href="raster_watershed.html#cb111-11" tabindex="-1"></a>    , <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb111-12"><a href="raster_watershed.html#cb111-12" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb111-13"><a href="raster_watershed.html#cb111-13" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-103-1.png" width="1008" /></p>
<p>let’s color our predicted segments by the IoU with the best fitting circle</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="raster_watershed.html#cb112-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb112-2"><a href="raster_watershed.html#cb112-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb112-3"><a href="raster_watershed.html#cb112-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb112-4"><a href="raster_watershed.html#cb112-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb112-5"><a href="raster_watershed.html#cb112-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb112-6"><a href="raster_watershed.html#cb112-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb112-7"><a href="raster_watershed.html#cb112-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb112-8"><a href="raster_watershed.html#cb112-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb112-9"><a href="raster_watershed.html#cb112-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-10"><a href="raster_watershed.html#cb112-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb112-11"><a href="raster_watershed.html#cb112-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb112-12"><a href="raster_watershed.html#cb112-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb112-13"><a href="raster_watershed.html#cb112-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb112-14"><a href="raster_watershed.html#cb112-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-15"><a href="raster_watershed.html#cb112-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb112-16"><a href="raster_watershed.html#cb112-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb112-17"><a href="raster_watershed.html#cb112-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb112-18"><a href="raster_watershed.html#cb112-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb112-19"><a href="raster_watershed.html#cb112-19" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(watershed_circle_fit_iou, <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span>)</span>
<span id="cb112-20"><a href="raster_watershed.html#cb112-20" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> iou)</span>
<span id="cb112-21"><a href="raster_watershed.html#cb112-21" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.9</span></span>
<span id="cb112-22"><a href="raster_watershed.html#cb112-22" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb112-23"><a href="raster_watershed.html#cb112-23" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb112-24"><a href="raster_watershed.html#cb112-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-25"><a href="raster_watershed.html#cb112-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb112-26"><a href="raster_watershed.html#cb112-26" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb112-27"><a href="raster_watershed.html#cb112-27" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb112-28"><a href="raster_watershed.html#cb112-28" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb112-29"><a href="raster_watershed.html#cb112-29" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb112-30"><a href="raster_watershed.html#cb112-30" tabindex="-1"></a>        <span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_area</span>(.)) <span class="sc">&lt;</span> (<span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_area</span>(example_aoi))<span class="sc">*</span><span class="fl">0.5</span>)</span>
<span id="cb112-31"><a href="raster_watershed.html#cb112-31" tabindex="-1"></a>      )</span>
<span id="cb112-32"><a href="raster_watershed.html#cb112-32" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb112-33"><a href="raster_watershed.html#cb112-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-34"><a href="raster_watershed.html#cb112-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_fermenter</span>(</span>
<span id="cb112-35"><a href="raster_watershed.html#cb112-35" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">10</span> <span class="co"># 10 use 10 if can go full range 0-1</span></span>
<span id="cb112-36"><a href="raster_watershed.html#cb112-36" tabindex="-1"></a>    , <span class="at">palette =</span> <span class="st">&quot;PuOr&quot;</span> <span class="co"># &quot;BrBG&quot;</span></span>
<span id="cb112-37"><a href="raster_watershed.html#cb112-37" tabindex="-1"></a>    , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb112-38"><a href="raster_watershed.html#cb112-38" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># use c(0,1) if can go full range 0-1</span></span>
<span id="cb112-39"><a href="raster_watershed.html#cb112-39" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb112-40"><a href="raster_watershed.html#cb112-40" tabindex="-1"></a>    , <span class="at">na.value =</span> <span class="st">&quot;sienna4&quot;</span></span>
<span id="cb112-41"><a href="raster_watershed.html#cb112-41" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-42"><a href="raster_watershed.html#cb112-42" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill=</span><span class="st">&quot;IoU&quot;</span>) <span class="sc">+</span></span>
<span id="cb112-43"><a href="raster_watershed.html#cb112-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb112-44"><a href="raster_watershed.html#cb112-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb112-45"><a href="raster_watershed.html#cb112-45" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb112-46"><a href="raster_watershed.html#cb112-46" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb112-47"><a href="raster_watershed.html#cb112-47" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-104-1.png" width="1008" /></p>
<p>we’ll set a threshold for the minimum IoU to further filter for segments that are approximately round, this filter should remove linear objects from the watershed detections</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="raster_watershed.html#cb113-1" tabindex="-1"></a><span class="co"># min required IoU between the predicted pile and the best fit circle of the predicted pile</span></span>
<span id="cb113-2"><a href="raster_watershed.html#cb113-2" tabindex="-1"></a>pct_iou_circle_fit <span class="ot">&lt;-</span> <span class="fl">0.55</span></span>
<span id="cb113-3"><a href="raster_watershed.html#cb113-3" tabindex="-1"></a><span class="co"># compare iou</span></span>
<span id="cb113-4"><a href="raster_watershed.html#cb113-4" tabindex="-1"></a>watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb113-5"><a href="raster_watershed.html#cb113-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(iou<span class="sc">&gt;=</span>pct_iou_circle_fit) <span class="sc">%&gt;%</span> </span>
<span id="cb113-6"><a href="raster_watershed.html#cb113-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span></code></pre></div>
<p>how many piles are remaining after the shape irregularity filtering, area threshold filtering, and circle fitting filtering?</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="raster_watershed.html#cb114-1" tabindex="-1"></a><span class="fu">length</span>(watershed_keep_circle_fit_pred_id)</span></code></pre></div>
<pre><code>## [1] 578</code></pre>
<p>let’s check out the remaining watershed detected piles after: 1) filtering out the irregularly shaped segments (filtered using the convex hull), 2) filtering for expected pile size, and 3) filtering out the non-circular segments (filtered using circle fitting)</p>
<p>example of watershed detected segments as vectors (brown) filtered to remove irregular shapes, segments outside of the expected area thresholds, and non-circular segments; compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="raster_watershed.html#cb116-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb116-2"><a href="raster_watershed.html#cb116-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb116-3"><a href="raster_watershed.html#cb116-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb116-4"><a href="raster_watershed.html#cb116-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb116-5"><a href="raster_watershed.html#cb116-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb116-6"><a href="raster_watershed.html#cb116-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb116-7"><a href="raster_watershed.html#cb116-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-8"><a href="raster_watershed.html#cb116-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb116-9"><a href="raster_watershed.html#cb116-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb116-10"><a href="raster_watershed.html#cb116-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb116-11"><a href="raster_watershed.html#cb116-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb116-12"><a href="raster_watershed.html#cb116-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb116-13"><a href="raster_watershed.html#cb116-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb116-14"><a href="raster_watershed.html#cb116-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb116-15"><a href="raster_watershed.html#cb116-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb116-16"><a href="raster_watershed.html#cb116-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb116-17"><a href="raster_watershed.html#cb116-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb116-18"><a href="raster_watershed.html#cb116-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb116-19"><a href="raster_watershed.html#cb116-19" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id)</span>
<span id="cb116-20"><a href="raster_watershed.html#cb116-20" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb116-21"><a href="raster_watershed.html#cb116-21" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb116-22"><a href="raster_watershed.html#cb116-22" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb116-23"><a href="raster_watershed.html#cb116-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb116-24"><a href="raster_watershed.html#cb116-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-108-1.png" width="1008" /></p>
</div>
<div id="area-and-volume-from-chm" class="section level3 hasAnchor" number="5.1.4">
<h3><span class="header-section-number">5.1.4</span> Area and Volume from CHM<a href="raster_watershed.html#area-and-volume-from-chm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’ll use the CHM raster to calculate area, height, and volume for each candidate pile to reflect the irregular pile footprints and elevation profiles that better represent real-world objects than assuming perfect geometric shapes as is common for quantifying slash pile structure</p>
<p>after we calculate the height of the pile based on the maximum height withing the lower CHM slice of the pile footprint, we will lastly apply our filter for the minimum expected pile height. this is the last filtering step to give us our final, structurally-detected slash pile prediction list</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="raster_watershed.html#cb117-1" tabindex="-1"></a><span class="do">########################################</span></span>
<span id="cb117-2"><a href="raster_watershed.html#cb117-2" tabindex="-1"></a><span class="co"># use the remaining segments that meet the geometric and area filtering</span></span>
<span id="cb117-3"><a href="raster_watershed.html#cb117-3" tabindex="-1"></a><span class="co"># to filter the watershed raster</span></span>
<span id="cb117-4"><a href="raster_watershed.html#cb117-4" tabindex="-1"></a><span class="do">########################################</span></span>
<span id="cb117-5"><a href="raster_watershed.html#cb117-5" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb117-6"><a href="raster_watershed.html#cb117-6" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb117-7"><a href="raster_watershed.html#cb117-7" tabindex="-1"></a>        watershed_ans_poly <span class="sc">%&gt;%</span> <span class="co">#these are irregularity and area filtered already</span></span>
<span id="cb117-8"><a href="raster_watershed.html#cb117-8" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb117-9"><a href="raster_watershed.html#cb117-9" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb117-10"><a href="raster_watershed.html#cb117-10" tabindex="-1"></a>        , <span class="at">updatevalue=</span><span class="cn">NA</span></span>
<span id="cb117-11"><a href="raster_watershed.html#cb117-11" tabindex="-1"></a>      )</span>
<span id="cb117-12"><a href="raster_watershed.html#cb117-12" tabindex="-1"></a>    <span class="fu">names</span>(smooth_watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb117-13"><a href="raster_watershed.html#cb117-13" tabindex="-1"></a></span>
<span id="cb117-14"><a href="raster_watershed.html#cb117-14" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb117-15"><a href="raster_watershed.html#cb117-15" tabindex="-1"></a>    <span class="co"># mask the chm rast to these remaining segments</span></span>
<span id="cb117-16"><a href="raster_watershed.html#cb117-16" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb117-17"><a href="raster_watershed.html#cb117-17" tabindex="-1"></a>    smooth_chm_rast <span class="ot">&lt;-</span> cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb117-18"><a href="raster_watershed.html#cb117-18" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb117-19"><a href="raster_watershed.html#cb117-19" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_watershed_ans)</span>
<span id="cb117-20"><a href="raster_watershed.html#cb117-20" tabindex="-1"></a>    <span class="co"># terra::plot(smooth_chm_rast)</span></span>
<span id="cb117-21"><a href="raster_watershed.html#cb117-21" tabindex="-1"></a>    <span class="co"># now mask the watershed_ans raster to only keep cells that are in the originating CHM</span></span>
<span id="cb117-22"><a href="raster_watershed.html#cb117-22" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">mask</span>(smooth_chm_rast)</span>
<span id="cb117-23"><a href="raster_watershed.html#cb117-23" tabindex="-1"></a>    <span class="co"># terra::plot(smooth_watershed_ans, col = viridis::turbo(555) %&gt;% sample(), legend = F)</span></span>
<span id="cb117-24"><a href="raster_watershed.html#cb117-24" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb117-25"><a href="raster_watershed.html#cb117-25" tabindex="-1"></a>  <span class="do">## calculate raster-based area and volume </span></span>
<span id="cb117-26"><a href="raster_watershed.html#cb117-26" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb117-27"><a href="raster_watershed.html#cb117-27" tabindex="-1"></a>    <span class="co"># first, calculate the area of each cell</span></span>
<span id="cb117-28"><a href="raster_watershed.html#cb117-28" tabindex="-1"></a>    area_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(smooth_chm_rast)</span>
<span id="cb117-29"><a href="raster_watershed.html#cb117-29" tabindex="-1"></a>    <span class="fu">names</span>(area_rast) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb117-30"><a href="raster_watershed.html#cb117-30" tabindex="-1"></a>    <span class="co"># area_rast %&gt;% terra::plot()</span></span>
<span id="cb117-31"><a href="raster_watershed.html#cb117-31" tabindex="-1"></a>    <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb117-32"><a href="raster_watershed.html#cb117-32" tabindex="-1"></a>    vol_rast <span class="ot">&lt;-</span> area_rast<span class="sc">*</span>smooth_chm_rast</span>
<span id="cb117-33"><a href="raster_watershed.html#cb117-33" tabindex="-1"></a>    <span class="fu">names</span>(vol_rast) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb117-34"><a href="raster_watershed.html#cb117-34" tabindex="-1"></a>    <span class="co"># vol_rast %&gt;% terra::plot()</span></span>
<span id="cb117-35"><a href="raster_watershed.html#cb117-35" tabindex="-1"></a>    <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb117-36"><a href="raster_watershed.html#cb117-36" tabindex="-1"></a>    area_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> area_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb117-37"><a href="raster_watershed.html#cb117-37" tabindex="-1"></a>    <span class="co"># area_df %&gt;% dplyr::glimpse()</span></span>
<span id="cb117-38"><a href="raster_watershed.html#cb117-38" tabindex="-1"></a>    <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb117-39"><a href="raster_watershed.html#cb117-39" tabindex="-1"></a>    vol_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> vol_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb117-40"><a href="raster_watershed.html#cb117-40" tabindex="-1"></a>    <span class="co"># vol_df %&gt;% dplyr::glimpse()</span></span>
<span id="cb117-41"><a href="raster_watershed.html#cb117-41" tabindex="-1"></a>    <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb117-42"><a href="raster_watershed.html#cb117-42" tabindex="-1"></a>    ht_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> smooth_chm_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb117-43"><a href="raster_watershed.html#cb117-43" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">max_height_m=</span><span class="dv">2</span>)</span>
<span id="cb117-44"><a href="raster_watershed.html#cb117-44" tabindex="-1"></a>      </span>
<span id="cb117-45"><a href="raster_watershed.html#cb117-45" tabindex="-1"></a>    <span class="co"># let&#39;s convert the smoothed and filtered watershed-detected segments from raster to vector data </span></span>
<span id="cb117-46"><a href="raster_watershed.html#cb117-46" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb117-47"><a href="raster_watershed.html#cb117-47" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb117-48"><a href="raster_watershed.html#cb117-48" tabindex="-1"></a>      smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb117-49"><a href="raster_watershed.html#cb117-49" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb117-50"><a href="raster_watershed.html#cb117-50" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb117-51"><a href="raster_watershed.html#cb117-51" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb117-52"><a href="raster_watershed.html#cb117-52" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb117-53"><a href="raster_watershed.html#cb117-53" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb117-54"><a href="raster_watershed.html#cb117-54" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb117-55"><a href="raster_watershed.html#cb117-55" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb117-56"><a href="raster_watershed.html#cb117-56" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb117-57"><a href="raster_watershed.html#cb117-57" tabindex="-1"></a></span>
<span id="cb117-58"><a href="raster_watershed.html#cb117-58" tabindex="-1"></a>    <span class="co"># add area and volume to our vector data  </span></span>
<span id="cb117-59"><a href="raster_watershed.html#cb117-59" tabindex="-1"></a>    <span class="co"># we&#39;ll do this with a slick trick to perform multiple joins succinctly using purrr::reduce</span></span>
<span id="cb117-60"><a href="raster_watershed.html#cb117-60" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb117-61"><a href="raster_watershed.html#cb117-61" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">reduce</span>(</span>
<span id="cb117-62"><a href="raster_watershed.html#cb117-62" tabindex="-1"></a>        <span class="fu">list</span>(watershed_ans_poly, area_df, vol_df, ht_df)</span>
<span id="cb117-63"><a href="raster_watershed.html#cb117-63" tabindex="-1"></a>        , dplyr<span class="sc">::</span>left_join</span>
<span id="cb117-64"><a href="raster_watershed.html#cb117-64" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&#39;pred_id&#39;</span></span>
<span id="cb117-65"><a href="raster_watershed.html#cb117-65" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb117-66"><a href="raster_watershed.html#cb117-66" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb117-67"><a href="raster_watershed.html#cb117-67" tabindex="-1"></a>        <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb117-68"><a href="raster_watershed.html#cb117-68" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb117-69"><a href="raster_watershed.html#cb117-69" tabindex="-1"></a>      <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb117-70"><a href="raster_watershed.html#cb117-70" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb117-71"><a href="raster_watershed.html#cb117-71" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb117-72"><a href="raster_watershed.html#cb117-72" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb117-73"><a href="raster_watershed.html#cb117-73" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(max_height_m,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_ht_m</span>
<span id="cb117-74"><a href="raster_watershed.html#cb117-74" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb117-75"><a href="raster_watershed.html#cb117-75" tabindex="-1"></a>      <span class="co"># do one more pass of the irregularity filtering</span></span>
<span id="cb117-76"><a href="raster_watershed.html#cb117-76" tabindex="-1"></a>      <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> pct_chull_overlap)</span></code></pre></div>
<p>what did we do?</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="raster_watershed.html#cb118-1" tabindex="-1"></a>watershed_ans_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 577
## Columns: 7
## $ pred_id         &lt;dbl&gt; 38, 55, 80, 89, 104, 121, 150, 151, 175, 233, 296, 313…
## $ area_m2         &lt;dbl&gt; 7.886308, 4.923938, 22.057642, 5.644515, 2.682145, 4.2…
## $ volume_m3       &lt;dbl&gt; 15.930993, 14.787953, 65.423964, 12.013256, 4.271128, …
## $ max_height_m    &lt;dbl&gt; 3.999429, 3.999000, 3.998000, 3.998000, 3.998000, 3.99…
## $ volume_per_area &lt;dbl&gt; 2.020083, 3.003277, 2.966045, 2.128306, 1.592430, 1.11…
## $ pct_chull       &lt;dbl&gt; 0.8509719, 0.8453608, 0.7118863, 0.8221574, 0.8993289,…
## $ geometry        &lt;POLYGON [m]&gt; POLYGON ((499303.8 4318063,..., POLYGON ((4998…</code></pre>
<p>how many piles are remaining after the shape irregularity filtering, area threshold filtering, and circle fitting filtering, and height filtering?</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="raster_watershed.html#cb120-1" tabindex="-1"></a><span class="fu">nrow</span>(watershed_ans_poly)</span></code></pre></div>
<pre><code>## [1] 577</code></pre>
<p>let’s look at the remaining piles which have now been: 1) filtered to remove irregular shapes, 2) filtered based on the expected area threshold, 3) filtered to remove non-circular shapes, 4) filtered to remove piles that don’t meet the expected vertical dimensions (i.e. pile height)</p>
<p>example of watershed detected segments as vectors (brown) filtered to remove irregular shapes, segments outside of the expected area and height thresholds, and non-circular segments; compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="raster_watershed.html#cb122-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb122-2"><a href="raster_watershed.html#cb122-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb122-3"><a href="raster_watershed.html#cb122-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb122-4"><a href="raster_watershed.html#cb122-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb122-5"><a href="raster_watershed.html#cb122-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb122-6"><a href="raster_watershed.html#cb122-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb122-7"><a href="raster_watershed.html#cb122-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb122-8"><a href="raster_watershed.html#cb122-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb122-9"><a href="raster_watershed.html#cb122-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb122-10"><a href="raster_watershed.html#cb122-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb122-11"><a href="raster_watershed.html#cb122-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb122-12"><a href="raster_watershed.html#cb122-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb122-13"><a href="raster_watershed.html#cb122-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb122-14"><a href="raster_watershed.html#cb122-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb122-15"><a href="raster_watershed.html#cb122-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb122-16"><a href="raster_watershed.html#cb122-16" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb122-17"><a href="raster_watershed.html#cb122-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb122-18"><a href="raster_watershed.html#cb122-18" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb122-19"><a href="raster_watershed.html#cb122-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb122-20"><a href="raster_watershed.html#cb122-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb122-21"><a href="raster_watershed.html#cb122-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb122-22"><a href="raster_watershed.html#cb122-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-113-1.png" width="1008" /></p>
</div>
<div id="shape-refinement" class="section level3 hasAnchor" number="5.1.5">
<h3><span class="header-section-number">5.1.5</span> Shape Refinement<a href="raster_watershed.html#shape-refinement" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As a final step, we’ll use the convex hull shapes of our remaining segments. This helps to smooth out the often “blocky” edges of raster-based segments, which can look like they were generated in Minecraft. Additionally, by removing any segments with overlapping convex hull shapes, we can likely reduce false detections that are actually groups of small trees or shrubs, ensuring our results represent singular slash piles.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="raster_watershed.html#cb123-1" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb123-2"><a href="raster_watershed.html#cb123-2" tabindex="-1"></a><span class="co"># dissolve groups of touching or overlapping polygons using st_union and st_cast</span></span>
<span id="cb123-3"><a href="raster_watershed.html#cb123-3" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb123-4"><a href="raster_watershed.html#cb123-4" tabindex="-1"></a>st_combine_touching <span class="ot">&lt;-</span> <span class="cf">function</span>(polygons_sf) {</span>
<span id="cb123-5"><a href="raster_watershed.html#cb123-5" tabindex="-1"></a>  <span class="co"># check if the input is an sf data frame</span></span>
<span id="cb123-6"><a href="raster_watershed.html#cb123-6" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(polygons_sf, <span class="st">&quot;sf&quot;</span>)) {</span>
<span id="cb123-7"><a href="raster_watershed.html#cb123-7" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;polygons_sf&#39; must be an sf data frame.&quot;</span>)</span>
<span id="cb123-8"><a href="raster_watershed.html#cb123-8" tabindex="-1"></a>  }</span>
<span id="cb123-9"><a href="raster_watershed.html#cb123-9" tabindex="-1"></a>  </span>
<span id="cb123-10"><a href="raster_watershed.html#cb123-10" tabindex="-1"></a>  <span class="co"># check if the geometry type is either polygon or multipolygon</span></span>
<span id="cb123-11"><a href="raster_watershed.html#cb123-11" tabindex="-1"></a>  geometry_types <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(polygons_sf)</span>
<span id="cb123-12"><a href="raster_watershed.html#cb123-12" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(geometry_types <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) {</span>
<span id="cb123-13"><a href="raster_watershed.html#cb123-13" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;polygons_sf&#39; must contain only POLYGON or MULTIPOLYGON geometries.&quot;</span>)</span>
<span id="cb123-14"><a href="raster_watershed.html#cb123-14" tabindex="-1"></a>  }</span>
<span id="cb123-15"><a href="raster_watershed.html#cb123-15" tabindex="-1"></a>  </span>
<span id="cb123-16"><a href="raster_watershed.html#cb123-16" tabindex="-1"></a>  <span class="co"># union then pull out separate polys</span></span>
<span id="cb123-17"><a href="raster_watershed.html#cb123-17" tabindex="-1"></a>  dissolved_sf <span class="ot">&lt;-</span> </span>
<span id="cb123-18"><a href="raster_watershed.html#cb123-18" tabindex="-1"></a>    polygons_sf <span class="sc">%&gt;%</span> </span>
<span id="cb123-19"><a href="raster_watershed.html#cb123-19" tabindex="-1"></a>    <span class="co"># 1. perform a full union to dissolve all contiguous polygons into a multipolygon.</span></span>
<span id="cb123-20"><a href="raster_watershed.html#cb123-20" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_union</span>(<span class="at">by_feature =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb123-21"><a href="raster_watershed.html#cb123-21" tabindex="-1"></a>    <span class="co"># 2. cast the multipolygon back to individual polygons, one for each component.</span></span>
<span id="cb123-22"><a href="raster_watershed.html#cb123-22" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-23"><a href="raster_watershed.html#cb123-23" tabindex="-1"></a>    <span class="co"># 3. return a new sf data frame with the dissolved components.</span></span>
<span id="cb123-24"><a href="raster_watershed.html#cb123-24" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-25"><a href="raster_watershed.html#cb123-25" tabindex="-1"></a>    <span class="co"># 4. ensure valid polygons</span></span>
<span id="cb123-26"><a href="raster_watershed.html#cb123-26" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-27"><a href="raster_watershed.html#cb123-27" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-28"><a href="raster_watershed.html#cb123-28" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-29"><a href="raster_watershed.html#cb123-29" tabindex="-1"></a>    <span class="co"># make id</span></span>
<span id="cb123-30"><a href="raster_watershed.html#cb123-30" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb123-31"><a href="raster_watershed.html#cb123-31" tabindex="-1"></a>  </span>
<span id="cb123-32"><a href="raster_watershed.html#cb123-32" tabindex="-1"></a>  <span class="fu">return</span>(dissolved_sf)</span>
<span id="cb123-33"><a href="raster_watershed.html#cb123-33" tabindex="-1"></a>}</span>
<span id="cb123-34"><a href="raster_watershed.html#cb123-34" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb123-35"><a href="raster_watershed.html#cb123-35" tabindex="-1"></a><span class="co"># dissolve only contiguous, non-overlapping polygons and combine with others.</span></span>
<span id="cb123-36"><a href="raster_watershed.html#cb123-36" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb123-37"><a href="raster_watershed.html#cb123-37" tabindex="-1"></a>st_dissolve_and_combine <span class="ot">&lt;-</span> <span class="cf">function</span>(polygons_sf) {</span>
<span id="cb123-38"><a href="raster_watershed.html#cb123-38" tabindex="-1"></a>  </span>
<span id="cb123-39"><a href="raster_watershed.html#cb123-39" tabindex="-1"></a>  <span class="co"># Input checks</span></span>
<span id="cb123-40"><a href="raster_watershed.html#cb123-40" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(polygons_sf, <span class="st">&quot;sf&quot;</span>)) <span class="fu">stop</span>(<span class="st">&quot;Input &#39;polygons_sf&#39; must be an sf data frame.&quot;</span>)</span>
<span id="cb123-41"><a href="raster_watershed.html#cb123-41" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(polygons_sf) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) {</span>
<span id="cb123-42"><a href="raster_watershed.html#cb123-42" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;polygons_sf&#39; must contain only POLYGON or MULTIPOLYGON geometries.&quot;</span>)</span>
<span id="cb123-43"><a href="raster_watershed.html#cb123-43" tabindex="-1"></a>  }</span>
<span id="cb123-44"><a href="raster_watershed.html#cb123-44" tabindex="-1"></a>  </span>
<span id="cb123-45"><a href="raster_watershed.html#cb123-45" tabindex="-1"></a>  <span class="co"># Identify touching and overlapping polygons using matrix operations</span></span>
<span id="cb123-46"><a href="raster_watershed.html#cb123-46" tabindex="-1"></a>  touches_matrix <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_touches</span>(polygons_sf, polygons_sf, <span class="at">sparse =</span> <span class="cn">FALSE</span>)</span>
<span id="cb123-47"><a href="raster_watershed.html#cb123-47" tabindex="-1"></a>  overlaps_matrix <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_overlaps</span>(polygons_sf, polygons_sf, <span class="at">sparse =</span> <span class="cn">FALSE</span>)</span>
<span id="cb123-48"><a href="raster_watershed.html#cb123-48" tabindex="-1"></a>  </span>
<span id="cb123-49"><a href="raster_watershed.html#cb123-49" tabindex="-1"></a>  <span class="co"># Exclude self-touching and self-overlapping relationships</span></span>
<span id="cb123-50"><a href="raster_watershed.html#cb123-50" tabindex="-1"></a>  <span class="fu">diag</span>(touches_matrix) <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb123-51"><a href="raster_watershed.html#cb123-51" tabindex="-1"></a>  <span class="fu">diag</span>(overlaps_matrix) <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb123-52"><a href="raster_watershed.html#cb123-52" tabindex="-1"></a>  </span>
<span id="cb123-53"><a href="raster_watershed.html#cb123-53" tabindex="-1"></a>  <span class="co"># Polygons that are part of a touching group (i.e., touch another polygon)</span></span>
<span id="cb123-54"><a href="raster_watershed.html#cb123-54" tabindex="-1"></a>  touching_ids <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">rowSums</span>(touches_matrix) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb123-55"><a href="raster_watershed.html#cb123-55" tabindex="-1"></a>  </span>
<span id="cb123-56"><a href="raster_watershed.html#cb123-56" tabindex="-1"></a>  <span class="co"># Polygons that are part of an overlapping group (i.e., overlap another polygon)</span></span>
<span id="cb123-57"><a href="raster_watershed.html#cb123-57" tabindex="-1"></a>  overlapping_ids <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">rowSums</span>(overlaps_matrix) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb123-58"><a href="raster_watershed.html#cb123-58" tabindex="-1"></a>  </span>
<span id="cb123-59"><a href="raster_watershed.html#cb123-59" tabindex="-1"></a>  <span class="co"># Polygons to be dissolved: only those that touch but do not overlap</span></span>
<span id="cb123-60"><a href="raster_watershed.html#cb123-60" tabindex="-1"></a>  to_dissolve_ids <span class="ot">&lt;-</span> touching_ids[<span class="sc">!</span>touching_ids <span class="sc">%in%</span> overlapping_ids]</span>
<span id="cb123-61"><a href="raster_watershed.html#cb123-61" tabindex="-1"></a>  </span>
<span id="cb123-62"><a href="raster_watershed.html#cb123-62" tabindex="-1"></a>  <span class="co"># Polygons to remain as-is: isolated polygons and overlapping polygons</span></span>
<span id="cb123-63"><a href="raster_watershed.html#cb123-63" tabindex="-1"></a>  to_keep_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(<span class="fu">which</span>(<span class="fu">rowSums</span>(touches_matrix) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">rowSums</span>(overlaps_matrix) <span class="sc">==</span> <span class="dv">0</span>), overlapping_ids))</span>
<span id="cb123-64"><a href="raster_watershed.html#cb123-64" tabindex="-1"></a>  </span>
<span id="cb123-65"><a href="raster_watershed.html#cb123-65" tabindex="-1"></a>  <span class="co"># Separate the datasets</span></span>
<span id="cb123-66"><a href="raster_watershed.html#cb123-66" tabindex="-1"></a>  to_dissolve_sf <span class="ot">&lt;-</span> polygons_sf[to_dissolve_ids, ]</span>
<span id="cb123-67"><a href="raster_watershed.html#cb123-67" tabindex="-1"></a>  to_keep_sf <span class="ot">&lt;-</span> polygons_sf[to_keep_ids, ]</span>
<span id="cb123-68"><a href="raster_watershed.html#cb123-68" tabindex="-1"></a>  </span>
<span id="cb123-69"><a href="raster_watershed.html#cb123-69" tabindex="-1"></a>  <span class="co"># # Dissolve the contiguous, non-overlapping polygons</span></span>
<span id="cb123-70"><a href="raster_watershed.html#cb123-70" tabindex="-1"></a>  <span class="co"># dissolved_sf &lt;- sf::st_union(to_dissolve_sf)</span></span>
<span id="cb123-71"><a href="raster_watershed.html#cb123-71" tabindex="-1"></a>  <span class="co"># dissolved_cast &lt;- sf::st_cast(dissolved_sf, &quot;POLYGON&quot;)</span></span>
<span id="cb123-72"><a href="raster_watershed.html#cb123-72" tabindex="-1"></a>  <span class="co"># dissolved_final &lt;- sf::st_sf(geometry = dissolved_cast)</span></span>
<span id="cb123-73"><a href="raster_watershed.html#cb123-73" tabindex="-1"></a>  dissolved_final <span class="ot">&lt;-</span> <span class="fu">st_combine_touching</span>(to_dissolve_sf)</span>
<span id="cb123-74"><a href="raster_watershed.html#cb123-74" tabindex="-1"></a>  </span>
<span id="cb123-75"><a href="raster_watershed.html#cb123-75" tabindex="-1"></a>  <span class="co"># Combine the dissolved polygons with the remaining polygons</span></span>
<span id="cb123-76"><a href="raster_watershed.html#cb123-76" tabindex="-1"></a>  final_result <span class="ot">&lt;-</span> </span>
<span id="cb123-77"><a href="raster_watershed.html#cb123-77" tabindex="-1"></a>    dissolved_final <span class="sc">%&gt;%</span> </span>
<span id="cb123-78"><a href="raster_watershed.html#cb123-78" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb123-79"><a href="raster_watershed.html#cb123-79" tabindex="-1"></a>      to_keep_sf <span class="sc">%&gt;%</span> </span>
<span id="cb123-80"><a href="raster_watershed.html#cb123-80" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb123-81"><a href="raster_watershed.html#cb123-81" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(id)</span>
<span id="cb123-82"><a href="raster_watershed.html#cb123-82" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb123-83"><a href="raster_watershed.html#cb123-83" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-84"><a href="raster_watershed.html#cb123-84" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-85"><a href="raster_watershed.html#cb123-85" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-86"><a href="raster_watershed.html#cb123-86" tabindex="-1"></a>    <span class="co"># make id</span></span>
<span id="cb123-87"><a href="raster_watershed.html#cb123-87" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb123-88"><a href="raster_watershed.html#cb123-88" tabindex="-1"></a>  </span>
<span id="cb123-89"><a href="raster_watershed.html#cb123-89" tabindex="-1"></a>  <span class="fu">return</span>(final_result)</span>
<span id="cb123-90"><a href="raster_watershed.html#cb123-90" tabindex="-1"></a>}</span>
<span id="cb123-91"><a href="raster_watershed.html#cb123-91" tabindex="-1"></a></span>
<span id="cb123-92"><a href="raster_watershed.html#cb123-92" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb123-93"><a href="raster_watershed.html#cb123-93" tabindex="-1"></a><span class="co"># make a function to remove overlapping polygons from a sf data frame</span></span>
<span id="cb123-94"><a href="raster_watershed.html#cb123-94" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb123-95"><a href="raster_watershed.html#cb123-95" tabindex="-1"></a>st_remove_overlaps <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data) {</span>
<span id="cb123-96"><a href="raster_watershed.html#cb123-96" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb123-97"><a href="raster_watershed.html#cb123-97" tabindex="-1"></a>  <span class="co"># if not polygons</span></span>
<span id="cb123-98"><a href="raster_watershed.html#cb123-98" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">all</span>()) ){</span>
<span id="cb123-99"><a href="raster_watershed.html#cb123-99" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb123-100"><a href="raster_watershed.html#cb123-100" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb123-101"><a href="raster_watershed.html#cb123-101" tabindex="-1"></a>    ))</span>
<span id="cb123-102"><a href="raster_watershed.html#cb123-102" tabindex="-1"></a>  }</span>
<span id="cb123-103"><a href="raster_watershed.html#cb123-103" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(sf_data)<span class="sc">&lt;=</span><span class="dv">1</span>){<span class="fu">return</span>(sf_data)}</span>
<span id="cb123-104"><a href="raster_watershed.html#cb123-104" tabindex="-1"></a>  <span class="co"># combine all touching polygons and keep the ones that overlap multiple from the original polygons</span></span>
<span id="cb123-105"><a href="raster_watershed.html#cb123-105" tabindex="-1"></a>  comb_temp <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb123-106"><a href="raster_watershed.html#cb123-106" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-107"><a href="raster_watershed.html#cb123-107" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_union</span>(<span class="at">by_feature =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb123-108"><a href="raster_watershed.html#cb123-108" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-109"><a href="raster_watershed.html#cb123-109" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-110"><a href="raster_watershed.html#cb123-110" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-111"><a href="raster_watershed.html#cb123-111" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_crs</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-112"><a href="raster_watershed.html#cb123-112" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">new_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb123-113"><a href="raster_watershed.html#cb123-113" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(new_id) </span>
<span id="cb123-114"><a href="raster_watershed.html#cb123-114" tabindex="-1"></a>  <span class="co"># identify overlaps</span></span>
<span id="cb123-115"><a href="raster_watershed.html#cb123-115" tabindex="-1"></a>  overlap_temp <span class="ot">&lt;-</span> comb_temp <span class="sc">%&gt;%</span> </span>
<span id="cb123-116"><a href="raster_watershed.html#cb123-116" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_intersection</span>(sf_data) <span class="sc">%&gt;%</span> </span>
<span id="cb123-117"><a href="raster_watershed.html#cb123-117" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-118"><a href="raster_watershed.html#cb123-118" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(new_id) <span class="sc">%&gt;%</span> </span>
<span id="cb123-119"><a href="raster_watershed.html#cb123-119" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n_orig =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb123-120"><a href="raster_watershed.html#cb123-120" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-121"><a href="raster_watershed.html#cb123-121" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(n_orig<span class="sc">&gt;=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-122"><a href="raster_watershed.html#cb123-122" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(new_id)</span>
<span id="cb123-123"><a href="raster_watershed.html#cb123-123" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(overlap_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(sf_data)}</span>
<span id="cb123-124"><a href="raster_watershed.html#cb123-124" tabindex="-1"></a>  <span class="co"># just get the overlaps</span></span>
<span id="cb123-125"><a href="raster_watershed.html#cb123-125" tabindex="-1"></a>  comb_temp <span class="ot">&lt;-</span> comb_temp <span class="sc">%&gt;%</span> </span>
<span id="cb123-126"><a href="raster_watershed.html#cb123-126" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(new_id <span class="sc">%in%</span> overlap_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb123-127"><a href="raster_watershed.html#cb123-127" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_union</span>()</span>
<span id="cb123-128"><a href="raster_watershed.html#cb123-128" tabindex="-1"></a>  <span class="co"># remove from the original data  </span></span>
<span id="cb123-129"><a href="raster_watershed.html#cb123-129" tabindex="-1"></a>  <span class="fu">return</span>(sf<span class="sc">::</span><span class="fu">st_difference</span>(sf_data,comb_temp))</span>
<span id="cb123-130"><a href="raster_watershed.html#cb123-130" tabindex="-1"></a>}</span></code></pre></div>
<p>save this filtered data as our predictions</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="raster_watershed.html#cb124-1" tabindex="-1"></a><span class="co"># save this filtered data as our predictions</span></span>
<span id="cb124-2"><a href="raster_watershed.html#cb124-2" tabindex="-1"></a>predicted_watershed_piles_sf <span class="ot">&lt;-</span> </span>
<span id="cb124-3"><a href="raster_watershed.html#cb124-3" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb124-4"><a href="raster_watershed.html#cb124-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb124-5"><a href="raster_watershed.html#cb124-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb124-6"><a href="raster_watershed.html#cb124-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb124-7"><a href="raster_watershed.html#cb124-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb124-8"><a href="raster_watershed.html#cb124-8" tabindex="-1"></a>  <span class="fu">st_remove_overlaps</span>()</span>
<span id="cb124-9"><a href="raster_watershed.html#cb124-9" tabindex="-1"></a><span class="co"># attach a flag for those in stand</span></span>
<span id="cb124-10"><a href="raster_watershed.html#cb124-10" tabindex="-1"></a>predicted_watershed_piles_sf <span class="ot">&lt;-</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb124-11"><a href="raster_watershed.html#cb124-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb124-12"><a href="raster_watershed.html#cb124-12" tabindex="-1"></a>    <span class="at">is_in_stand =</span> pred_id <span class="sc">%in%</span> (predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb124-13"><a href="raster_watershed.html#cb124-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(stand_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_watershed_piles_sf))) <span class="sc">%&gt;%</span> </span>
<span id="cb124-14"><a href="raster_watershed.html#cb124-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb124-15"><a href="raster_watershed.html#cb124-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id))</span>
<span id="cb124-16"><a href="raster_watershed.html#cb124-16" tabindex="-1"></a>  )</span></code></pre></div>
<p>let’s see how many segments were originally detected using the watershed method and how many we are left with after our filtering for shape irregularity, pile area and height expectations, circularity, and potential overlaps after smoothing?</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="raster_watershed.html#cb125-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb125-2"><a href="raster_watershed.html#cb125-2" tabindex="-1"></a>  <span class="at">n_segments =</span> <span class="fu">c</span>(</span>
<span id="cb125-3"><a href="raster_watershed.html#cb125-3" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">freq</span>(watershed_ans) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb125-4"><a href="raster_watershed.html#cb125-4" tabindex="-1"></a>    , <span class="fu">nrow</span>(predicted_watershed_piles_sf)</span>
<span id="cb125-5"><a href="raster_watershed.html#cb125-5" tabindex="-1"></a>  )</span>
<span id="cb125-6"><a href="raster_watershed.html#cb125-6" tabindex="-1"></a>  , <span class="at">which_segments =</span> <span class="fu">c</span>(<span class="st">&quot;original segments&quot;</span>, <span class="st">&quot;filtered segments&quot;</span>)</span>
<span id="cb125-7"><a href="raster_watershed.html#cb125-7" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   n_segments which_segments   
##        &lt;int&gt; &lt;chr&gt;            
## 1       9892 original segments
## 2        520 filtered segments</code></pre>
<p>wow that is a lot of filtering…but will it be enough?</p>
<p>now let’s look at our final detected segments (brown) compared with the ground truth piles (blue) in the example area we have been looking at</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="raster_watershed.html#cb127-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb127-2"><a href="raster_watershed.html#cb127-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb127-3"><a href="raster_watershed.html#cb127-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb127-4"><a href="raster_watershed.html#cb127-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb127-5"><a href="raster_watershed.html#cb127-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb127-6"><a href="raster_watershed.html#cb127-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb127-7"><a href="raster_watershed.html#cb127-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb127-8"><a href="raster_watershed.html#cb127-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb127-9"><a href="raster_watershed.html#cb127-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb127-10"><a href="raster_watershed.html#cb127-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb127-11"><a href="raster_watershed.html#cb127-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb127-12"><a href="raster_watershed.html#cb127-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly))</span>
<span id="cb127-13"><a href="raster_watershed.html#cb127-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb127-14"><a href="raster_watershed.html#cb127-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb127-15"><a href="raster_watershed.html#cb127-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb127-16"><a href="raster_watershed.html#cb127-16" tabindex="-1"></a>    <span class="at">data =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb127-17"><a href="raster_watershed.html#cb127-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb127-18"><a href="raster_watershed.html#cb127-18" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb127-19"><a href="raster_watershed.html#cb127-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb127-20"><a href="raster_watershed.html#cb127-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb127-21"><a href="raster_watershed.html#cb127-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb127-22"><a href="raster_watershed.html#cb127-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-119-1.png" width="1008" /></p>
<p>that looks like it did what we wanted it to do, though note there are a false negative predictions (omission) and false positive predictions (commissions) in this example area as well as many true positive matches</p>
<p>let’s look at the entire area again after applying this filter, plotting the remaining watershed segmented piles (brown) and the actual piles (blue)</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="raster_watershed.html#cb128-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb128-2"><a href="raster_watershed.html#cb128-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb128-3"><a href="raster_watershed.html#cb128-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb128-4"><a href="raster_watershed.html#cb128-4" tabindex="-1"></a>  predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb128-5"><a href="raster_watershed.html#cb128-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb128-6"><a href="raster_watershed.html#cb128-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb128-7"><a href="raster_watershed.html#cb128-7" tabindex="-1"></a>)</span>
<span id="cb128-8"><a href="raster_watershed.html#cb128-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb128-9"><a href="raster_watershed.html#cb128-9" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb128-10"><a href="raster_watershed.html#cb128-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb128-11"><a href="raster_watershed.html#cb128-11" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb128-12"><a href="raster_watershed.html#cb128-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-121-1.png" width="1008" /></p>
<p>nice! let’s save these data</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="raster_watershed.html#cb129-1" tabindex="-1"></a>predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb129-2"><a href="raster_watershed.html#cb129-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="st">&quot;../data/predicted_watershed_piles_sf.gpkg&quot;</span>, <span class="at">append =</span> F)</span>
<span id="cb129-3"><a href="raster_watershed.html#cb129-3" tabindex="-1"></a>watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb129-4"><a href="raster_watershed.html#cb129-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="st">&quot;../data/watershed_ans_poly.gpkg&quot;</span>, <span class="at">append =</span> F)</span></code></pre></div>
</div>
</div>
<div id="instance-matching" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Instance Matching<a href="raster_watershed.html#instance-matching" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We didn’t “train” any model here, just developed a rules-based method for detecting piles from aerial point cloud data. As such, we can evaluate the methods performance on the “full” set of ground truth pile data.</p>
<p>let’s see how we did given the list of predictions compared to the ground truth data using the instance matching process we outlined in this <a href="method-evaluation.html#iou_match">earlier section</a>.</p>
<div id="example-area" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Example Area<a href="raster_watershed.html#example-area" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>first, we’ll look at the example area that we have been working with</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="raster_watershed.html#cb130-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb130-2"><a href="raster_watershed.html#cb130-2" tabindex="-1"></a>  <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb130-3"><a href="raster_watershed.html#cb130-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb130-4"><a href="raster_watershed.html#cb130-4" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb130-5"><a href="raster_watershed.html#cb130-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb130-6"><a href="raster_watershed.html#cb130-6" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb130-7"><a href="raster_watershed.html#cb130-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb130-8"><a href="raster_watershed.html#cb130-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb130-9"><a href="raster_watershed.html#cb130-9" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb130-10"><a href="raster_watershed.html#cb130-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb130-11"><a href="raster_watershed.html#cb130-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(field_diameter_m))</span>
<span id="cb130-12"><a href="raster_watershed.html#cb130-12" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb130-13"><a href="raster_watershed.html#cb130-13" tabindex="-1"></a>  , <span class="at">predictions =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb130-14"><a href="raster_watershed.html#cb130-14" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb130-15"><a href="raster_watershed.html#cb130-15" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb130-16"><a href="raster_watershed.html#cb130-16" tabindex="-1"></a>)</span></code></pre></div>
<p>final plotting it</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="raster_watershed.html#cb131-1" tabindex="-1"></a>pal_match_grp <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb131-2"><a href="raster_watershed.html#cb131-2" tabindex="-1"></a>  <span class="st">&quot;omission&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">1</span>]</span>
<span id="cb131-3"><a href="raster_watershed.html#cb131-3" tabindex="-1"></a>  , <span class="st">&quot;commission&quot;</span><span class="ot">=</span> <span class="st">&quot;gray88&quot;</span> <span class="co">#viridis::cividis(3)[2]</span></span>
<span id="cb131-4"><a href="raster_watershed.html#cb131-4" tabindex="-1"></a>  , <span class="st">&quot;true positive&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">3</span>]</span>
<span id="cb131-5"><a href="raster_watershed.html#cb131-5" tabindex="-1"></a>)</span>
<span id="cb131-6"><a href="raster_watershed.html#cb131-6" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb131-7"><a href="raster_watershed.html#cb131-7" tabindex="-1"></a>p_temp <span class="ot">&lt;-</span> plt_ortho_example <span class="sc">+</span></span>
<span id="cb131-8"><a href="raster_watershed.html#cb131-8" tabindex="-1"></a><span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb131-9"><a href="raster_watershed.html#cb131-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast)), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb131-10"><a href="raster_watershed.html#cb131-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb131-11"><a href="raster_watershed.html#cb131-11" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb131-12"><a href="raster_watershed.html#cb131-12" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb131-13"><a href="raster_watershed.html#cb131-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb131-14"><a href="raster_watershed.html#cb131-14" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb131-15"><a href="raster_watershed.html#cb131-15" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb131-16"><a href="raster_watershed.html#cb131-16" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb131-17"><a href="raster_watershed.html#cb131-17" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-18"><a href="raster_watershed.html#cb131-18" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb131-19"><a href="raster_watershed.html#cb131-19" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb131-20"><a href="raster_watershed.html#cb131-20" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb131-21"><a href="raster_watershed.html#cb131-21" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb131-22"><a href="raster_watershed.html#cb131-22" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb131-23"><a href="raster_watershed.html#cb131-23" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb131-24"><a href="raster_watershed.html#cb131-24" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb131-25"><a href="raster_watershed.html#cb131-25" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast))</span>
<span id="cb131-26"><a href="raster_watershed.html#cb131-26" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb131-27"><a href="raster_watershed.html#cb131-27" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb131-28"><a href="raster_watershed.html#cb131-28" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb131-29"><a href="raster_watershed.html#cb131-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb131-30"><a href="raster_watershed.html#cb131-30" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb131-31"><a href="raster_watershed.html#cb131-31" tabindex="-1"></a>      predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb131-32"><a href="raster_watershed.html#cb131-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb131-33"><a href="raster_watershed.html#cb131-33" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb131-34"><a href="raster_watershed.html#cb131-34" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb131-35"><a href="raster_watershed.html#cb131-35" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb131-36"><a href="raster_watershed.html#cb131-36" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb131-37"><a href="raster_watershed.html#cb131-37" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb131-38"><a href="raster_watershed.html#cb131-38" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast))</span>
<span id="cb131-39"><a href="raster_watershed.html#cb131-39" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb131-40"><a href="raster_watershed.html#cb131-40" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb131-41"><a href="raster_watershed.html#cb131-41" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">0.8</span></span>
<span id="cb131-42"><a href="raster_watershed.html#cb131-42" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb131-43"><a href="raster_watershed.html#cb131-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb131-44"><a href="raster_watershed.html#cb131-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb131-45"><a href="raster_watershed.html#cb131-45" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb131-46"><a href="raster_watershed.html#cb131-46" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb131-47"><a href="raster_watershed.html#cb131-47" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,pal_match_grp[<span class="st">&quot;commission&quot;</span>])))</span>
<span id="cb131-48"><a href="raster_watershed.html#cb131-48" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb131-49"><a href="raster_watershed.html#cb131-49" tabindex="-1"></a>  )</span>
<span id="cb131-50"><a href="raster_watershed.html#cb131-50" tabindex="-1"></a>p_temp</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-125-1.png" width="1008" /></p>
</div>
<div id="full-study-area" class="section level3 hasAnchor" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Full Study Area<a href="raster_watershed.html#full-study-area" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we’ll look at only predicted and ground truth piles that intersect with the unit boundary for our instance matching</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="raster_watershed.html#cb132-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb132-2"><a href="raster_watershed.html#cb132-2" tabindex="-1"></a>  <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb132-3"><a href="raster_watershed.html#cb132-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb132-4"><a href="raster_watershed.html#cb132-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(field_diameter_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb132-5"><a href="raster_watershed.html#cb132-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_watershed_piles_sf))</span>
<span id="cb132-6"><a href="raster_watershed.html#cb132-6" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb132-7"><a href="raster_watershed.html#cb132-7" tabindex="-1"></a>  , <span class="at">predictions =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand)</span>
<span id="cb132-8"><a href="raster_watershed.html#cb132-8" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb132-9"><a href="raster_watershed.html#cb132-9" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb132-10"><a href="raster_watershed.html#cb132-10" tabindex="-1"></a>)</span></code></pre></div>
<p>let’s look at that spatially for the entire area</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="raster_watershed.html#cb133-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb133-2"><a href="raster_watershed.html#cb133-2" tabindex="-1"></a><span class="fu">ortho_plt_fn</span>(<span class="at">my_ortho_rast =</span> ortho_rast, <span class="at">stand =</span> stand_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast)), <span class="at">buffer =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb133-3"><a href="raster_watershed.html#cb133-3" tabindex="-1"></a><span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb133-4"><a href="raster_watershed.html#cb133-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> stand_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast)), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb133-5"><a href="raster_watershed.html#cb133-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb133-6"><a href="raster_watershed.html#cb133-6" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb133-7"><a href="raster_watershed.html#cb133-7" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb133-8"><a href="raster_watershed.html#cb133-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb133-9"><a href="raster_watershed.html#cb133-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb133-10"><a href="raster_watershed.html#cb133-10" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb133-11"><a href="raster_watershed.html#cb133-11" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb133-12"><a href="raster_watershed.html#cb133-12" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb133-13"><a href="raster_watershed.html#cb133-13" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb133-14"><a href="raster_watershed.html#cb133-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast))</span>
<span id="cb133-15"><a href="raster_watershed.html#cb133-15" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb133-16"><a href="raster_watershed.html#cb133-16" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb133-17"><a href="raster_watershed.html#cb133-17" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb133-18"><a href="raster_watershed.html#cb133-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb133-19"><a href="raster_watershed.html#cb133-19" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb133-20"><a href="raster_watershed.html#cb133-20" tabindex="-1"></a>      predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb133-21"><a href="raster_watershed.html#cb133-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb133-22"><a href="raster_watershed.html#cb133-22" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb133-23"><a href="raster_watershed.html#cb133-23" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb133-24"><a href="raster_watershed.html#cb133-24" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb133-25"><a href="raster_watershed.html#cb133-25" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb133-26"><a href="raster_watershed.html#cb133-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb133-27"><a href="raster_watershed.html#cb133-27" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast))</span>
<span id="cb133-28"><a href="raster_watershed.html#cb133-28" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb133-29"><a href="raster_watershed.html#cb133-29" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb133-30"><a href="raster_watershed.html#cb133-30" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb133-31"><a href="raster_watershed.html#cb133-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb133-32"><a href="raster_watershed.html#cb133-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb133-33"><a href="raster_watershed.html#cb133-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb133-34"><a href="raster_watershed.html#cb133-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb133-35"><a href="raster_watershed.html#cb133-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb133-36"><a href="raster_watershed.html#cb133-36" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,pal_match_grp[<span class="st">&quot;commission&quot;</span>])))</span>
<span id="cb133-37"><a href="raster_watershed.html#cb133-37" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb133-38"><a href="raster_watershed.html#cb133-38" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-128-1.png" width="1008" /></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="raster_watershed.html#cb134-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/watershed_pred_match.jpg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="fl">10.5</span>)</span></code></pre></div>
<p>counts of instance matching results</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="raster_watershed.html#cb135-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb135-2"><a href="raster_watershed.html#cb135-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb135-3"><a href="raster_watershed.html#cb135-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> (n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy=</span><span class="fl">0.1</span>))</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   match_grp         n pct  
##   &lt;ord&gt;         &lt;int&gt; &lt;chr&gt;
## 1 omission         13 5.5% 
## 2 commission      115 48.7%
## 3 true positive   108 45.8%</code></pre>
<p>it looks like we did a really good job correctly predicting the location of actual piles (yellow) but that we incorrectly predicted pile locations at a relatively high rate. Our false positive predictions (i.e. commmissions) were frequently located in areas with quaking aspen (<em>Populus tremuloides</em>) which has many more short trees than the treated conifer areas.</p>
<p>let’s quickly look at the IoU values on the true positives</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="raster_watershed.html#cb137-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(iou) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##       iou        
##  Min.   :0.5763  
##  1st Qu.:0.7836  
##  Median :0.8228  
##  Mean   :0.8050  
##  3rd Qu.:0.8458  
##  Max.   :0.9284  
##  NA&#39;s   :128</code></pre>
<div id="det_accuracy_wshed_ex" class="section level4 hasAnchor" number="5.2.2.1">
<h4><span class="header-section-number">5.2.2.1</span> Detection Accuracy<a href="raster_watershed.html#det_accuracy_wshed_ex" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>we’ll aggregate the raw instance match data to calculate our detection accuracy metrics</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="raster_watershed.html#cb139-1" tabindex="-1"></a><span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 8
##    tp_n  fp_n  fn_n omission_rate commission_rate precision recall f_score
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1   108   115    13         0.107           0.516     0.484  0.893   0.628</code></pre>
<p>let’s plot our confusion matrix</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="raster_watershed.html#cb141-1" tabindex="-1"></a>confusion_matrix_temp <span class="ot">&lt;-</span> <span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans)</span>
<span id="cb141-2"><a href="raster_watershed.html#cb141-2" tabindex="-1"></a>confusion_matrix_scores_temp <span class="ot">&lt;-</span> <span class="fu">confusion_matrix_scores_fn</span>(confusion_matrix_temp)</span>
<span id="cb141-3"><a href="raster_watershed.html#cb141-3" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb141-4"><a href="raster_watershed.html#cb141-4" tabindex="-1"></a>confusion_matrix_temp <span class="sc">%&gt;%</span> </span>
<span id="cb141-5"><a href="raster_watershed.html#cb141-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_n&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb141-6"><a href="raster_watershed.html#cb141-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb141-7"><a href="raster_watershed.html#cb141-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb141-8"><a href="raster_watershed.html#cb141-8" tabindex="-1"></a>    <span class="at">presence =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fn_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb141-9"><a href="raster_watershed.html#cb141-9" tabindex="-1"></a>    , <span class="at">estimate =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fp_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb141-10"><a href="raster_watershed.html#cb141-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb141-11"><a href="raster_watershed.html#cb141-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb141-12"><a href="raster_watershed.html#cb141-12" tabindex="-1"></a>    <span class="at">is_false =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(presence<span class="sc">!=</span>estimate,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb141-13"><a href="raster_watershed.html#cb141-13" tabindex="-1"></a>    , <span class="at">presence_fact =</span> <span class="fu">factor</span>(presence,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed Absent&quot;</span>, <span class="st">&quot;Observed Present&quot;</span>))</span>
<span id="cb141-14"><a href="raster_watershed.html#cb141-14" tabindex="-1"></a>    , <span class="at">estimate_fact =</span> <span class="fu">factor</span>(estimate,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Predicted Absent&quot;</span>, <span class="st">&quot;Predicted Present&quot;</span>))</span>
<span id="cb141-15"><a href="raster_watershed.html#cb141-15" tabindex="-1"></a>    , <span class="at">pct =</span> value<span class="sc">/</span><span class="fu">sum</span>(value)</span>
<span id="cb141-16"><a href="raster_watershed.html#cb141-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb141-17"><a href="raster_watershed.html#cb141-17" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> estimate_fact, <span class="at">x =</span> presence_fact)) <span class="sc">+</span></span>
<span id="cb141-18"><a href="raster_watershed.html#cb141-18" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> is_false), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>,<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb141-19"><a href="raster_watershed.html#cb141-19" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)), <span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb141-20"><a href="raster_watershed.html#cb141-20" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)), <span class="at">vjust =</span> <span class="fl">3.5</span>, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb141-21"><a href="raster_watershed.html#cb141-21" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;turquoise&quot;</span>,<span class="st">&quot;tomato2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb141-22"><a href="raster_watershed.html#cb141-22" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb141-23"><a href="raster_watershed.html#cb141-23" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb141-24"><a href="raster_watershed.html#cb141-24" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Predicted&quot;</span></span>
<span id="cb141-25"><a href="raster_watershed.html#cb141-25" tabindex="-1"></a>    , <span class="at">x =</span> <span class="st">&quot;Observed&quot;</span></span>
<span id="cb141-26"><a href="raster_watershed.html#cb141-26" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb141-27"><a href="raster_watershed.html#cb141-27" tabindex="-1"></a>      <span class="st">&quot;True positive rate (recall) = &quot;</span></span>
<span id="cb141-28"><a href="raster_watershed.html#cb141-28" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>recall <span class="sc">%&gt;%</span> </span>
<span id="cb141-29"><a href="raster_watershed.html#cb141-29" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb141-30"><a href="raster_watershed.html#cb141-30" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Precision (PPV) = &quot;</span></span>
<span id="cb141-31"><a href="raster_watershed.html#cb141-31" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>precision <span class="sc">%&gt;%</span> </span>
<span id="cb141-32"><a href="raster_watershed.html#cb141-32" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb141-33"><a href="raster_watershed.html#cb141-33" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">F1-score = &quot;</span></span>
<span id="cb141-34"><a href="raster_watershed.html#cb141-34" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>f_score <span class="sc">%&gt;%</span> </span>
<span id="cb141-35"><a href="raster_watershed.html#cb141-35" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb141-36"><a href="raster_watershed.html#cb141-36" tabindex="-1"></a>    )</span>
<span id="cb141-37"><a href="raster_watershed.html#cb141-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb141-38"><a href="raster_watershed.html#cb141-38" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb141-39"><a href="raster_watershed.html#cb141-39" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb141-40"><a href="raster_watershed.html#cb141-40" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb141-41"><a href="raster_watershed.html#cb141-41" tabindex="-1"></a>    , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb141-42"><a href="raster_watershed.html#cb141-42" tabindex="-1"></a>    , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb141-43"><a href="raster_watershed.html#cb141-43" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb141-44"><a href="raster_watershed.html#cb141-44" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-132-1.png" width="1008" /></p>
</div>
<div id="quantification-accuracy" class="section level4 hasAnchor" number="5.2.2.2">
<h4><span class="header-section-number">5.2.2.2</span> Quantification Accuracy<a href="raster_watershed.html#quantification-accuracy" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s add structural measurements to our instance matching data</p>
<p>first, we’ll review what structural information we already have for the predicted segments</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="raster_watershed.html#cb142-1" tabindex="-1"></a>predicted_watershed_piles_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 520
## Columns: 8
## $ pred_id         &lt;dbl&gt; 38, 55, 80, 104, 150, 151, 175, 233, 296, 313, 327, 33…
## $ area_m2         &lt;dbl&gt; 7.886308, 4.923938, 22.057642, 2.682145, 18.614888, 4.…
## $ volume_m3       &lt;dbl&gt; 15.930993, 14.787953, 65.423964, 4.271128, 27.613173, …
## $ max_height_m    &lt;dbl&gt; 3.999429, 3.999000, 3.998000, 3.998000, 3.997000, 3.99…
## $ volume_per_area &lt;dbl&gt; 2.020083, 3.003277, 2.966045, 1.592430, 1.483392, 2.51…
## $ pct_chull       &lt;dbl&gt; 0.8509719, 0.8453608, 0.7118863, 0.8993289, 0.7591837,…
## $ geometry        &lt;POLYGON [m]&gt; POLYGON ((499303.2 4318059,..., POLYGON ((4998…
## $ is_in_stand     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE,…</code></pre>
<p>Our quantification accuracy evaluation will be restricted to measurements that were directly collected across both sites (i.e. training and validation site). The ground truth dataset only includes direct data for field-measured height, field-measured diameter, and image-annotated area (based on pile perimeters). Accuracy and error metrics, such as ME, RMSE, and MAPE, will be only calculated for these direct measurements.</p>
<p>We exclude quantification accuracy metrics for derived values, such as volume, because the resulting value would not constitute a true “error”. Comparing our predicted volume to a volume that was <em>not</em> directly measured, but instead calculated using a geometric assumption (like assuming a perfectly circular base and paraboloid shape) would be inappropriate. This is because any resulting difference between the prediction and the ground truth would be a blend of three inseparable factors: the error of the remote-sensing prediction method, the error in the direct field measurements (diameter/height), and the error introduced by the geometric shape assumption. Reporting such combined errors would be misleading, as it would be impossible to isolate the true performance of our remote-sensing method alone.</p>
<p>Instead, data involving these derived values (e.g., predicted volume versus the volume based on field measurements and a shape assumption) will be treated simply as data points for insight into the differences. Using geometric shape assumptions for estimating pile volume is the standard practice when implementing prescriptions or preparing for slash pile burning (<a href="https://permanent.fdlp.gov/gpo45282/index.htm">Hardy 1996</a>; <a href="https://doi.org/10.5849/forsci.13-501">Long &amp; Boston 2014</a>). This comparison will help us understand the discrepancy between our irregularly shaped CHM-derived volume and the volume calculated assuming a perfectly circular base and paraboloid shape with field-measured height and diameter. This approach will still provide valuable context about the impact of the perfectly circular base and paraboloid geometric assumptions without falsely attributing the error of the simplified model to the remote-sensing method itself.</p>
<p>tl;dr: we already have height and area for our predicted piles, we need to calculate diameter. we will not use volume of the ground truth piles to calculate the error in volume measurement of predicted piles because we did not directly measure volume of the ground truth piles.</p>
<p>use our <code>st_calculate_diameter()</code> function to add diameter to the predicted piles</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="raster_watershed.html#cb144-1" tabindex="-1"></a>predicted_watershed_piles_sf <span class="ot">&lt;-</span> <span class="fu">st_calculate_diameter</span>(predicted_watershed_piles_sf)</span>
<span id="cb144-2"><a href="raster_watershed.html#cb144-2" tabindex="-1"></a><span class="co"># predicted_watershed_piles_sf %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>now, we’ll add pile measurement data for both the ground truth and prediction data to our instance matched data. we’ll also calculate difference columns for the different measurements based on the formulas in this <a href="method-evaluation.html#quant_metrics_form">prior section</a></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="raster_watershed.html#cb145-1" tabindex="-1"></a><span class="co"># add pile measurement data</span></span>
<span id="cb145-2"><a href="raster_watershed.html#cb145-2" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> </span>
<span id="cb145-3"><a href="raster_watershed.html#cb145-3" tabindex="-1"></a>  ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb145-4"><a href="raster_watershed.html#cb145-4" tabindex="-1"></a>  <span class="co"># join on gt area data</span></span>
<span id="cb145-5"><a href="raster_watershed.html#cb145-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb145-6"><a href="raster_watershed.html#cb145-6" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb145-7"><a href="raster_watershed.html#cb145-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb145-8"><a href="raster_watershed.html#cb145-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id, height_m, image_gt_area_m2, field_diameter_m) <span class="sc">%&gt;%</span> </span>
<span id="cb145-9"><a href="raster_watershed.html#cb145-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb145-10"><a href="raster_watershed.html#cb145-10" tabindex="-1"></a>        <span class="at">gt_height_m =</span> height_m</span>
<span id="cb145-11"><a href="raster_watershed.html#cb145-11" tabindex="-1"></a>        , <span class="at">gt_area_m2 =</span> image_gt_area_m2</span>
<span id="cb145-12"><a href="raster_watershed.html#cb145-12" tabindex="-1"></a>        , <span class="at">gt_diameter_m =</span> field_diameter_m</span>
<span id="cb145-13"><a href="raster_watershed.html#cb145-13" tabindex="-1"></a>      )</span>
<span id="cb145-14"><a href="raster_watershed.html#cb145-14" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb145-15"><a href="raster_watershed.html#cb145-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb145-16"><a href="raster_watershed.html#cb145-16" tabindex="-1"></a>  <span class="co"># join on pred area data</span></span>
<span id="cb145-17"><a href="raster_watershed.html#cb145-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb145-18"><a href="raster_watershed.html#cb145-18" tabindex="-1"></a>    predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb145-19"><a href="raster_watershed.html#cb145-19" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb145-20"><a href="raster_watershed.html#cb145-20" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id, max_height_m, area_m2, diameter_m) <span class="sc">%&gt;%</span> </span>
<span id="cb145-21"><a href="raster_watershed.html#cb145-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb145-22"><a href="raster_watershed.html#cb145-22" tabindex="-1"></a>        <span class="at">pred_height_m =</span> max_height_m</span>
<span id="cb145-23"><a href="raster_watershed.html#cb145-23" tabindex="-1"></a>        , <span class="at">pred_area_m2 =</span> area_m2</span>
<span id="cb145-24"><a href="raster_watershed.html#cb145-24" tabindex="-1"></a>        , <span class="at">pred_diameter_m =</span> diameter_m</span>
<span id="cb145-25"><a href="raster_watershed.html#cb145-25" tabindex="-1"></a>      )</span>
<span id="cb145-26"><a href="raster_watershed.html#cb145-26" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb145-27"><a href="raster_watershed.html#cb145-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb145-28"><a href="raster_watershed.html#cb145-28" tabindex="-1"></a>  <span class="co"># calculate difference columns</span></span>
<span id="cb145-29"><a href="raster_watershed.html#cb145-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb145-30"><a href="raster_watershed.html#cb145-30" tabindex="-1"></a>    <span class="co"># area_m2</span></span>
<span id="cb145-31"><a href="raster_watershed.html#cb145-31" tabindex="-1"></a>    <span class="at">diff_area_m2 =</span> pred_area_m2<span class="sc">-</span>gt_area_m2</span>
<span id="cb145-32"><a href="raster_watershed.html#cb145-32" tabindex="-1"></a>    , <span class="at">pct_diff_area_m2 =</span> (gt_area_m2<span class="sc">-</span>pred_area_m2)<span class="sc">/</span>gt_area_m2</span>
<span id="cb145-33"><a href="raster_watershed.html#cb145-33" tabindex="-1"></a>    <span class="co"># height_m</span></span>
<span id="cb145-34"><a href="raster_watershed.html#cb145-34" tabindex="-1"></a>    , <span class="at">diff_height_m =</span> pred_height_m<span class="sc">-</span>gt_height_m</span>
<span id="cb145-35"><a href="raster_watershed.html#cb145-35" tabindex="-1"></a>    , <span class="at">pct_diff_height_m =</span> (gt_height_m<span class="sc">-</span>pred_height_m)<span class="sc">/</span>gt_height_m</span>
<span id="cb145-36"><a href="raster_watershed.html#cb145-36" tabindex="-1"></a>    <span class="co"># diameter_m</span></span>
<span id="cb145-37"><a href="raster_watershed.html#cb145-37" tabindex="-1"></a>    , <span class="at">diff_diameter_m =</span> pred_diameter_m<span class="sc">-</span>gt_diameter_m</span>
<span id="cb145-38"><a href="raster_watershed.html#cb145-38" tabindex="-1"></a>    , <span class="at">pct_diff_diameter_m =</span> (gt_diameter_m<span class="sc">-</span>pred_diameter_m)<span class="sc">/</span>gt_diameter_m</span>
<span id="cb145-39"><a href="raster_watershed.html#cb145-39" tabindex="-1"></a>  )</span></code></pre></div>
<p>let’s check out the relationship between our predictions and the ground truth data</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="raster_watershed.html#cb146-1" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span> ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb146-2"><a href="raster_watershed.html#cb146-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(match_grp <span class="sc">==</span> <span class="st">&quot;true positive&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb146-3"><a href="raster_watershed.html#cb146-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb146-4"><a href="raster_watershed.html#cb146-4" tabindex="-1"></a>    pile_id</span>
<span id="cb146-5"><a href="raster_watershed.html#cb146-5" tabindex="-1"></a>    , (tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pred_&quot;</span>) <span class="sc">|</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;gt_&quot;</span>))</span>
<span id="cb146-6"><a href="raster_watershed.html#cb146-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb146-7"><a href="raster_watershed.html#cb146-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(pred_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb146-8"><a href="raster_watershed.html#cb146-8" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>pile_id) <span class="sc">%&gt;%</span> </span>
<span id="cb146-9"><a href="raster_watershed.html#cb146-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb146-10"><a href="raster_watershed.html#cb146-10" tabindex="-1"></a>    <span class="at">which_data =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(name, <span class="st">&quot;^[^_]+&quot;</span>)</span>
<span id="cb146-11"><a href="raster_watershed.html#cb146-11" tabindex="-1"></a>    , <span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(name, <span class="fu">paste0</span>(which_data,<span class="st">&quot;_&quot;</span>))</span>
<span id="cb146-12"><a href="raster_watershed.html#cb146-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb146-13"><a href="raster_watershed.html#cb146-13" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb146-14"><a href="raster_watershed.html#cb146-14" tabindex="-1"></a>    <span class="at">names_from =</span> which_data</span>
<span id="cb146-15"><a href="raster_watershed.html#cb146-15" tabindex="-1"></a>    , <span class="at">values_from =</span> value</span>
<span id="cb146-16"><a href="raster_watershed.html#cb146-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb146-17"><a href="raster_watershed.html#cb146-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb146-18"><a href="raster_watershed.html#cb146-18" tabindex="-1"></a>    <span class="at">name =</span> dplyr<span class="sc">::</span><span class="fu">case_match</span>(</span>
<span id="cb146-19"><a href="raster_watershed.html#cb146-19" tabindex="-1"></a>      name</span>
<span id="cb146-20"><a href="raster_watershed.html#cb146-20" tabindex="-1"></a>      , <span class="st">&quot;height_m&quot;</span> <span class="sc">~</span> <span class="st">&quot;Height (m)&quot;</span></span>
<span id="cb146-21"><a href="raster_watershed.html#cb146-21" tabindex="-1"></a>      , <span class="st">&quot;area_m2&quot;</span> <span class="sc">~</span> <span class="st">&quot;Area (m2)&quot;</span></span>
<span id="cb146-22"><a href="raster_watershed.html#cb146-22" tabindex="-1"></a>      , <span class="st">&quot;diameter_m&quot;</span> <span class="sc">~</span> <span class="st">&quot;Diameter (m)&quot;</span></span>
<span id="cb146-23"><a href="raster_watershed.html#cb146-23" tabindex="-1"></a>    )</span>
<span id="cb146-24"><a href="raster_watershed.html#cb146-24" tabindex="-1"></a>  )</span>
<span id="cb146-25"><a href="raster_watershed.html#cb146-25" tabindex="-1"></a>plt_list_temp <span class="ot">&lt;-</span> </span>
<span id="cb146-26"><a href="raster_watershed.html#cb146-26" tabindex="-1"></a>  <span class="fu">unique</span>(df_temp<span class="sc">$</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb146-27"><a href="raster_watershed.html#cb146-27" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb146-28"><a href="raster_watershed.html#cb146-28" tabindex="-1"></a>    <span class="co"># get limit</span></span>
<span id="cb146-29"><a href="raster_watershed.html#cb146-29" tabindex="-1"></a>    max_val <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-30"><a href="raster_watershed.html#cb146-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-31"><a href="raster_watershed.html#cb146-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb146-32"><a href="raster_watershed.html#cb146-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">max_gt =</span> <span class="fu">max</span>(gt,<span class="at">na.rm =</span> T),<span class="at">max_pred =</span> <span class="fu">max</span>(pred,<span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb146-33"><a href="raster_watershed.html#cb146-33" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb146-34"><a href="raster_watershed.html#cb146-34" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(value) <span class="sc">%&gt;%</span> </span>
<span id="cb146-35"><a href="raster_watershed.html#cb146-35" tabindex="-1"></a>      <span class="fu">max</span>(<span class="at">na.rm =</span> T)</span>
<span id="cb146-36"><a href="raster_watershed.html#cb146-36" tabindex="-1"></a>    </span>
<span id="cb146-37"><a href="raster_watershed.html#cb146-37" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb146-38"><a href="raster_watershed.html#cb146-38" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb146-39"><a href="raster_watershed.html#cb146-39" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> gt, <span class="at">y =</span> pred)) <span class="sc">+</span></span>
<span id="cb146-40"><a href="raster_watershed.html#cb146-40" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb146-41"><a href="raster_watershed.html#cb146-41" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">&quot;navy&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb146-42"><a href="raster_watershed.html#cb146-42" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se=</span>F, <span class="at">color =</span> <span class="st">&quot;tomato&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb146-43"><a href="raster_watershed.html#cb146-43" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb146-44"><a href="raster_watershed.html#cb146-44" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb146-45"><a href="raster_watershed.html#cb146-45" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,max_val), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb146-46"><a href="raster_watershed.html#cb146-46" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,max_val), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb146-47"><a href="raster_watershed.html#cb146-47" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb146-48"><a href="raster_watershed.html#cb146-48" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;ground truth&quot;</span></span>
<span id="cb146-49"><a href="raster_watershed.html#cb146-49" tabindex="-1"></a>        , <span class="at">y =</span> <span class="st">&quot;predicted&quot;</span></span>
<span id="cb146-50"><a href="raster_watershed.html#cb146-50" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb146-51"><a href="raster_watershed.html#cb146-51" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb146-52"><a href="raster_watershed.html#cb146-52" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb146-53"><a href="raster_watershed.html#cb146-53" tabindex="-1"></a>        <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb146-54"><a href="raster_watershed.html#cb146-54" tabindex="-1"></a>      )</span>
<span id="cb146-55"><a href="raster_watershed.html#cb146-55" tabindex="-1"></a>    <span class="fu">return</span>(plt)</span>
<span id="cb146-56"><a href="raster_watershed.html#cb146-56" tabindex="-1"></a>  })</span>
<span id="cb146-57"><a href="raster_watershed.html#cb146-57" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb146-58"><a href="raster_watershed.html#cb146-58" tabindex="-1"></a>  plt_list_temp</span>
<span id="cb146-59"><a href="raster_watershed.html#cb146-59" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">3</span></span>
<span id="cb146-60"><a href="raster_watershed.html#cb146-60" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-136-1.png" width="1008" /></p>
<p>the method performed well at extracting the diameter of the pile when compared to the field-measured value with a slight overestimation overall. with respect to pile area, the method performed very well compared to the image-annotated pile perimeters but tended to under-predict area for the largest piles. the method’s height estimation was more variable in it’s accuracy when compared to the field-measured values and, on-average, performed well for the shorter and intermediate height piles but under-predicted pile height for the tallest piles, this suggests that we set our maximum height threshold too low (set at 4 for this demonstration) for these larger piles.</p>
<p>let’s look closer at the difference in area for each pile spatially</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="raster_watershed.html#cb147-1" tabindex="-1"></a><span class="co"># look at this spatially</span></span>
<span id="cb147-2"><a href="raster_watershed.html#cb147-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb147-3"><a href="raster_watershed.html#cb147-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb147-4"><a href="raster_watershed.html#cb147-4" tabindex="-1"></a>    <span class="at">data =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb147-5"><a href="raster_watershed.html#cb147-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb147-6"><a href="raster_watershed.html#cb147-6" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,diff_area_m2,pct_diff_area_m2)</span>
<span id="cb147-7"><a href="raster_watershed.html#cb147-7" tabindex="-1"></a>      )</span>
<span id="cb147-8"><a href="raster_watershed.html#cb147-8" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pct_diff_area_m2)</span>
<span id="cb147-9"><a href="raster_watershed.html#cb147-9" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb147-10"><a href="raster_watershed.html#cb147-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb147-11"><a href="raster_watershed.html#cb147-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb147-12"><a href="raster_watershed.html#cb147-12" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb147-13"><a href="raster_watershed.html#cb147-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb147-14"><a href="raster_watershed.html#cb147-14" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb147-15"><a href="raster_watershed.html#cb147-15" tabindex="-1"></a>      )</span>
<span id="cb147-16"><a href="raster_watershed.html#cb147-16" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span></span>
<span id="cb147-17"><a href="raster_watershed.html#cb147-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb147-18"><a href="raster_watershed.html#cb147-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_stepsn</span>(</span>
<span id="cb147-19"><a href="raster_watershed.html#cb147-19" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">7</span></span>
<span id="cb147-20"><a href="raster_watershed.html#cb147-20" tabindex="-1"></a>    , <span class="at">colors =</span> scales<span class="sc">::</span><span class="fu">pal_div_gradient</span>()(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="at">length.out =</span> <span class="dv">7</span>))</span>
<span id="cb147-21"><a href="raster_watershed.html#cb147-21" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">fivenum</span>(ground_truth_prediction_match_ans<span class="sc">$</span>pct_diff_area_m2))),<span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">fivenum</span>(ground_truth_prediction_match_ans<span class="sc">$</span>pct_diff_area_m2))))</span>
<span id="cb147-22"><a href="raster_watershed.html#cb147-22" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb147-23"><a href="raster_watershed.html#cb147-23" tabindex="-1"></a>    , <span class="at">show.limits =</span> T</span>
<span id="cb147-24"><a href="raster_watershed.html#cb147-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb147-25"><a href="raster_watershed.html#cb147-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;% difference area&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-26"><a href="raster_watershed.html#cb147-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-137-1.png" width="1008" /></p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="raster_watershed.html#cb148-1" tabindex="-1"></a><span class="co"># and get a summary of the percent error</span></span>
<span id="cb148-2"><a href="raster_watershed.html#cb148-2" tabindex="-1"></a><span class="fu">summary</span>(ground_truth_prediction_match_ans<span class="sc">$</span>pct_diff_area_m2)</span></code></pre></div>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA&#39;s 
## -0.47831 -0.07621  0.00767  0.00729  0.08151  0.42779      128</code></pre>
<p>the ground truth, image-annotated area is well aligned with the predicted area for most piles (negative values indicate the predicted area is larger than the ground truth area and vice-versa)</p>
<p>and let’s look at the distribution of the difference in area (m2) calculated as the predicted area minus the image-annotated area so that negative difference values mean our predictions were smaller and positive values mean our predictions were larger (this is opposite of our percent difference value)</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="raster_watershed.html#cb150-1" tabindex="-1"></a><span class="co"># plot the difference of the area</span></span>
<span id="cb150-2"><a href="raster_watershed.html#cb150-2" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb150-3"><a href="raster_watershed.html#cb150-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb150-4"><a href="raster_watershed.html#cb150-4" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> diff_area_m2)</span>
<span id="cb150-5"><a href="raster_watershed.html#cb150-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb150-6"><a href="raster_watershed.html#cb150-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&quot;gray&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb150-7"><a href="raster_watershed.html#cb150-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(ground_truth_prediction_match_ans<span class="sc">$</span>diff_area_m2,<span class="at">na.rm=</span>T)) <span class="sc">+</span></span>
<span id="cb150-8"><a href="raster_watershed.html#cb150-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">annotate</span>(</span>
<span id="cb150-9"><a href="raster_watershed.html#cb150-9" tabindex="-1"></a>    <span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">median</span>(ground_truth_prediction_match_ans<span class="sc">$</span>diff_area_m2,<span class="at">na.rm=</span>T), <span class="at">y =</span> <span class="dv">0</span></span>
<span id="cb150-10"><a href="raster_watershed.html#cb150-10" tabindex="-1"></a>    , <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">&quot;median:&quot;</span>,scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">median</span>(ground_truth_prediction_match_ans<span class="sc">$</span>diff_area_m2,<span class="at">na.rm=</span>T),<span class="at">accuracy=</span><span class="fl">0.1</span>),<span class="st">&quot;m2&quot;</span>)</span>
<span id="cb150-11"><a href="raster_watershed.html#cb150-11" tabindex="-1"></a>    , <span class="at">hjust =</span> <span class="fl">1.01</span>, <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb150-12"><a href="raster_watershed.html#cb150-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb150-13"><a href="raster_watershed.html#cb150-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;density&quot;</span>,<span class="at">x=</span><span class="st">&quot;area difference (m2)&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;Difference in area between predicted and image-annotated slash piles (m2)&quot;</span>) <span class="sc">+</span></span>
<span id="cb150-14"><a href="raster_watershed.html#cb150-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb150-15"><a href="raster_watershed.html#cb150-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-138-1.png" width="1008" /></p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="raster_watershed.html#cb151-1" tabindex="-1"></a>  <span class="co"># ggplot2::geom_boxplot(outliers = F)</span></span></code></pre></div>
<p>O_O nice</p>
<p>finally, we’ll aggregate the raw instance matches to calculate quantification accuracy metrics</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="raster_watershed.html#cb152-1" tabindex="-1"></a><span class="co"># agg_ground_truth_match()</span></span>
<span id="cb152-2"><a href="raster_watershed.html#cb152-2" tabindex="-1"></a><span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans) <span class="sc">%&gt;%</span> </span>
<span id="cb152-3"><a href="raster_watershed.html#cb152-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 17
## $ tp_n                     &lt;dbl&gt; 108
## $ fp_n                     &lt;dbl&gt; 115
## $ fn_n                     &lt;dbl&gt; 13
## $ omission_rate            &lt;dbl&gt; 0.107438
## $ commission_rate          &lt;dbl&gt; 0.5156951
## $ precision                &lt;dbl&gt; 0.4843049
## $ recall                   &lt;dbl&gt; 0.892562
## $ f_score                  &lt;dbl&gt; 0.627907
## $ diff_area_m2_rmse        &lt;dbl&gt; 2.442577
## $ diff_diameter_m_rmse     &lt;dbl&gt; 0.7078588
## $ diff_height_m_rmse       &lt;dbl&gt; 0.655133
## $ diff_area_m2_mean        &lt;dbl&gt; -0.4566056
## $ diff_diameter_m_mean     &lt;dbl&gt; 0.4777459
## $ diff_height_m_mean       &lt;dbl&gt; -0.09372698
## $ pct_diff_area_m2_mape    &lt;dbl&gt; 0.1060726
## $ pct_diff_diameter_m_mape &lt;dbl&gt; 0.1708208
## $ pct_diff_height_m_mape   &lt;dbl&gt; 0.1924974</code></pre>
<p>our area predictions are not very good, we’ll have to check out if those image-annotated areas are accurate</p>
<p>also, we can make a pretty table of these detection and quantification accuracy metrics</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="raster_watershed.html#cb154-1" tabindex="-1"></a><span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans) <span class="sc">%&gt;%</span> </span>
<span id="cb154-2"><a href="raster_watershed.html#cb154-2" tabindex="-1"></a>  <span class="co"># first select to arrange eval_metric</span></span>
<span id="cb154-3"><a href="raster_watershed.html#cb154-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb154-4"><a href="raster_watershed.html#cb154-4" tabindex="-1"></a>    <span class="co"># detection</span></span>
<span id="cb154-5"><a href="raster_watershed.html#cb154-5" tabindex="-1"></a>    f_score, recall, precision</span>
<span id="cb154-6"><a href="raster_watershed.html#cb154-6" tabindex="-1"></a>    <span class="co"># quantification</span></span>
<span id="cb154-7"><a href="raster_watershed.html#cb154-7" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb154-8"><a href="raster_watershed.html#cb154-8" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb154-9"><a href="raster_watershed.html#cb154-9" tabindex="-1"></a>    <span class="co"># , tidyselect::ends_with(&quot;_rrmse&quot;)</span></span>
<span id="cb154-10"><a href="raster_watershed.html#cb154-10" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb154-11"><a href="raster_watershed.html#cb154-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb154-12"><a href="raster_watershed.html#cb154-12" tabindex="-1"></a>  <span class="co"># second select to arrange pile_metric</span></span>
<span id="cb154-13"><a href="raster_watershed.html#cb154-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb154-14"><a href="raster_watershed.html#cb154-14" tabindex="-1"></a>    <span class="co"># detection</span></span>
<span id="cb154-15"><a href="raster_watershed.html#cb154-15" tabindex="-1"></a>    f_score, recall, precision</span>
<span id="cb154-16"><a href="raster_watershed.html#cb154-16" tabindex="-1"></a>    <span class="co"># quantification</span></span>
<span id="cb154-17"><a href="raster_watershed.html#cb154-17" tabindex="-1"></a>    , <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;volume&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;paraboloid&quot;</span>))</span>
<span id="cb154-18"><a href="raster_watershed.html#cb154-18" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;area&quot;</span>)</span>
<span id="cb154-19"><a href="raster_watershed.html#cb154-19" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;height&quot;</span>)</span>
<span id="cb154-20"><a href="raster_watershed.html#cb154-20" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;diameter&quot;</span>)</span>
<span id="cb154-21"><a href="raster_watershed.html#cb154-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb154-22"><a href="raster_watershed.html#cb154-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb154-23"><a href="raster_watershed.html#cb154-23" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb154-24"><a href="raster_watershed.html#cb154-24" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(f_score, recall, precision, tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb154-25"><a href="raster_watershed.html#cb154-25" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb154-26"><a href="raster_watershed.html#cb154-26" tabindex="-1"></a>    )</span>
<span id="cb154-27"><a href="raster_watershed.html#cb154-27" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb154-28"><a href="raster_watershed.html#cb154-28" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>))</span>
<span id="cb154-29"><a href="raster_watershed.html#cb154-29" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(.x, <span class="at">accuracy =</span> <span class="fl">0.01</span>)</span>
<span id="cb154-30"><a href="raster_watershed.html#cb154-30" tabindex="-1"></a>    )</span>
<span id="cb154-31"><a href="raster_watershed.html#cb154-31" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb154-32"><a href="raster_watershed.html#cb154-32" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>))</span>
<span id="cb154-33"><a href="raster_watershed.html#cb154-33" tabindex="-1"></a>      , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(.x, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb154-34"><a href="raster_watershed.html#cb154-34" tabindex="-1"></a>    )</span>
<span id="cb154-35"><a href="raster_watershed.html#cb154-35" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb154-36"><a href="raster_watershed.html#cb154-36" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb154-37"><a href="raster_watershed.html#cb154-37" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb154-38"><a href="raster_watershed.html#cb154-38" tabindex="-1"></a>      f_score, recall, precision</span>
<span id="cb154-39"><a href="raster_watershed.html#cb154-39" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>)</span>
<span id="cb154-40"><a href="raster_watershed.html#cb154-40" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rrmse&quot;</span>)</span>
<span id="cb154-41"><a href="raster_watershed.html#cb154-41" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>)</span>
<span id="cb154-42"><a href="raster_watershed.html#cb154-42" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)</span>
<span id="cb154-43"><a href="raster_watershed.html#cb154-43" tabindex="-1"></a>    )</span>
<span id="cb154-44"><a href="raster_watershed.html#cb154-44" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb154-45"><a href="raster_watershed.html#cb154-45" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb154-46"><a href="raster_watershed.html#cb154-46" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb154-47"><a href="raster_watershed.html#cb154-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb154-48"><a href="raster_watershed.html#cb154-48" tabindex="-1"></a>    <span class="at">eval_metric =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(metric, <span class="st">&quot;(_rmse|_rrmse|_mean|_mape|f_score|recall|precision)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-49"><a href="raster_watershed.html#cb154-49" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-50"><a href="raster_watershed.html#cb154-50" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;me&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-51"><a href="raster_watershed.html#cb154-51" tabindex="-1"></a>      <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb154-52"><a href="raster_watershed.html#cb154-52" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb154-53"><a href="raster_watershed.html#cb154-53" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb154-54"><a href="raster_watershed.html#cb154-54" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;FSCORE&quot;</span>,<span class="st">&quot;RECALL&quot;</span>,<span class="st">&quot;PRECISION&quot;</span>, <span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb154-55"><a href="raster_watershed.html#cb154-55" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;F-score&quot;</span>,<span class="st">&quot;Recall&quot;</span>,<span class="st">&quot;Precision&quot;</span>, <span class="st">&quot;ME&quot;</span>,<span class="st">&quot;RMSE&quot;</span>,<span class="st">&quot;RRMSE&quot;</span>,<span class="st">&quot;MAPE&quot;</span>)</span>
<span id="cb154-56"><a href="raster_watershed.html#cb154-56" tabindex="-1"></a>      )</span>
<span id="cb154-57"><a href="raster_watershed.html#cb154-57" tabindex="-1"></a>    , <span class="at">pile_metric =</span> metric <span class="sc">%&gt;%</span> </span>
<span id="cb154-58"><a href="raster_watershed.html#cb154-58" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;(_rmse|_rrmse|_mean|_mape)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-59"><a href="raster_watershed.html#cb154-59" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">&quot;(paraboloid_volume|volume|area|height|diameter)&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-60"><a href="raster_watershed.html#cb154-60" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="st">&quot;detection&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-61"><a href="raster_watershed.html#cb154-61" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_c</span>(</span>
<span id="cb154-62"><a href="raster_watershed.html#cb154-62" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb154-63"><a href="raster_watershed.html#cb154-63" tabindex="-1"></a>          stringr<span class="sc">::</span><span class="fu">str_detect</span>(metric,<span class="st">&quot;(field|image)&quot;</span>) <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">&quot; (&quot;</span>, stringr<span class="sc">::</span><span class="fu">str_extract</span>(metric,<span class="st">&quot;(field|image)&quot;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb154-64"><a href="raster_watershed.html#cb154-64" tabindex="-1"></a>          , T <span class="sc">~</span> <span class="st">&quot;&quot;</span></span>
<span id="cb154-65"><a href="raster_watershed.html#cb154-65" tabindex="-1"></a>        )</span>
<span id="cb154-66"><a href="raster_watershed.html#cb154-66" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb154-67"><a href="raster_watershed.html#cb154-67" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace</span>(<span class="st">&quot;area&quot;</span>, <span class="st">&quot;area m&lt;sup&gt;2&lt;/sup&gt;&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-68"><a href="raster_watershed.html#cb154-68" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace</span>(<span class="st">&quot;volume&quot;</span>, <span class="st">&quot;volume m&lt;sup&gt;3&lt;/sup&gt;&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-69"><a href="raster_watershed.html#cb154-69" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace</span>(<span class="st">&quot;diameter&quot;</span>, <span class="st">&quot;diameter m&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-70"><a href="raster_watershed.html#cb154-70" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace</span>(<span class="st">&quot;height&quot;</span>, <span class="st">&quot;height m&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-71"><a href="raster_watershed.html#cb154-71" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_to_sentence</span>()</span>
<span id="cb154-72"><a href="raster_watershed.html#cb154-72" tabindex="-1"></a>    , <span class="at">sorter =</span> <span class="fu">ifelse</span>(pile_metric<span class="sc">==</span><span class="st">&quot;Detection&quot;</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb154-73"><a href="raster_watershed.html#cb154-73" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb154-74"><a href="raster_watershed.html#cb154-74" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(sorter, pile_metric, eval_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb154-75"><a href="raster_watershed.html#cb154-75" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(pile_metric,eval_metric,value) <span class="sc">%&gt;%</span> </span>
<span id="cb154-76"><a href="raster_watershed.html#cb154-76" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb154-77"><a href="raster_watershed.html#cb154-77" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;pile detection and form quantification accuracy metrics&quot;</span></span>
<span id="cb154-78"><a href="raster_watershed.html#cb154-78" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb154-79"><a href="raster_watershed.html#cb154-79" tabindex="-1"></a>      <span class="st">&quot;.&quot;</span>, <span class="st">&quot;&quot;</span></span>
<span id="cb154-80"><a href="raster_watershed.html#cb154-80" tabindex="-1"></a>      , <span class="st">&quot;value&quot;</span></span>
<span id="cb154-81"><a href="raster_watershed.html#cb154-81" tabindex="-1"></a>    )</span>
<span id="cb154-82"><a href="raster_watershed.html#cb154-82" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb154-83"><a href="raster_watershed.html#cb154-83" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb154-84"><a href="raster_watershed.html#cb154-84" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">12</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-85"><a href="raster_watershed.html#cb154-85" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<table class="table" style="font-size: 12px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-140">Table 5.1: </span>pile detection and form quantification accuracy metrics
</caption>
<thead>
<tr>
<th style="text-align:left;">
.
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
Detection
</td>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
63%
</td>
</tr>
<tr>
<td style="text-align:left;">
Recall
</td>
<td style="text-align:left;">
89%
</td>
</tr>
<tr>
<td style="text-align:left;">
Precision
</td>
<td style="text-align:left;">
48%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
Area m<sup>2</sup>
</td>
<td style="text-align:left;">
ME
</td>
<td style="text-align:left;">
-0.46
</td>
</tr>
<tr>
<td style="text-align:left;">
RMSE
</td>
<td style="text-align:left;">
2.4
</td>
</tr>
<tr>
<td style="text-align:left;">
MAPE
</td>
<td style="text-align:left;">
11%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
Diameter m
</td>
<td style="text-align:left;">
ME
</td>
<td style="text-align:left;">
0.48
</td>
</tr>
<tr>
<td style="text-align:left;">
RMSE
</td>
<td style="text-align:left;">
0.7
</td>
</tr>
<tr>
<td style="text-align:left;">
MAPE
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
Height m
</td>
<td style="text-align:left;">
ME
</td>
<td style="text-align:left;">
-0.09
</td>
</tr>
<tr>
<td style="text-align:left;">
RMSE
</td>
<td style="text-align:left;">
0.7
</td>
</tr>
<tr>
<td style="text-align:left;">
MAPE
</td>
<td style="text-align:left;">
19%
</td>
</tr>
</tbody>
</table>
<p>remember, these metrics are just for a test case of the method we just outlined. we’re going to formalize this detection method and then explore different parameterizations of the method to determine a range of expected accuracies based on the input data and settings.</p>
</div>
</div>
</div>
<div id="slash_pile_detect_watershed" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Watershed Pile Detection Function<a href="raster_watershed.html#slash_pile_detect_watershed" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The rule-based method for slash pile detection using CHM raster data we reviewed above generally follows this outline:</p>
<ul>
<li><em>CHM Generation</em>: A Canopy Height Model (CHM) is generated from the point cloud data. The CHM is generated by removing the ground surface effectively representing a Digital Surface Model (DSM) without ground, ensuring all values are heights above bare earth.</li>
<li><em>CHM Height Filtering</em>: A maximum height filter is applied to the CHM to retaining only raster cells below a maximum expected slash pile height (e.g. 4 m), isolating a “slice” of the CHM. A final step includes filtering candidate segments based on an expected minimum height threshold as well to remove any piles shorter than this expectation.</li>
<li><em>Candidate Segmentation</em>: Watershed segmentation is performed on the filtered CHM raster to identify and delineate initial candidate piles based on their structural form.</li>
<li><em>First Irregularity Filtering</em>: Candidate pile locations are initially filtered to remove highly irregular shapes by assessing their overlap with their convex hull (e.g. &gt;70% overlap). This step helps exclude lower tree branches (objects with holes in the lower CHM slice) and unorganized coarse woody debris.</li>
<li><em>Area Filtering</em>: A filter is applied based on the minimum and maximum expected pile areas.</li>
<li><em>Circularity Filtering</em>: A final geometric screen uses least squares circle fitting on each candidate pile, removing any that do not have a strong overlap (based on an Intersection over Union, or IoU, threshold) with the best-fit circle (e.g., &gt;50%). This removes non-circular features such as rectangular boulders and downed tree stems.</li>
<li><em>Shape Refinement &amp; Overlap Removal</em>: Lastly, segments are smoothed using their convex hull to remove the “blocky” raster edges (like they were made in Minecraft). Overlapping convex hull shapes are then removed to prevent false positives from clustered small trees or shrubs, ensuring singular pile detections.</li>
</ul>
<p>Let’s package all of the steps we demonstrated when <a href="raster_watershed.html#raster_watershed">formulating the methodology</a> into a single function which can possibly be integrated into the <code>cloud2trees</code> package.</p>
<p>The parameters are defined as follows:</p>
<ul>
<li><code>max_ht_m</code> : numeric. The maximum height (in meters) a slash pile is expected to be. This value helps us focus on a specific “slice” of the data, ignoring anything taller than a typical pile.</li>
<li><code>min_ht_m</code> : numeric. The minimum height (in meters) a detected pile must reach to be considered valid.</li>
<li><code>min_area_m2</code> : numeric. The smallest 2D area (in square meters) a detected pile must cover to be considered valid.</li>
<li><code>max_area_m2</code> : numeric. The largest 2D area (in square meters) a detected pile can cover to be considered valid.</li>
<li><code>convexity_pct</code> : numeric. A value between 0 and 1 that controls how strict the filtering is for regularly shaped piles. A value of 1 means only piles that are perfectly smooth and rounded, with no dents or inward curves are kept. A value of 0 allows for both perfectly regular and very irregular shapes. This filter works alongside <code>circle_fit_iou_pct</code> to refine the pile’s overall shape.</li>
<li><code>circle_fit_iou_pct</code> : numeric. A value between 0 and 1 that controls how the filtering is for circular pile shapes. Setting it to 1 means only piles that are perfectly circular are kept. A value of 0 allows for a wide range of shapes, including very circular and non-circular ones (like long, straight lines).</li>
<li><code>smooth_segs</code> : logical. Setting this option to TRUE will: 1) smooth out the “blocky” edges of detected piles (which can look like they were made in Minecraft) by using their overall shape; and 2) remove any detected piles that overlap significantly with other smoothed piles to help ensure each detection is a single slash pile, not a cluster of small trees or shrubs.</li>
</ul>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="raster_watershed.html#cb155-1" tabindex="-1"></a><span class="co"># detect funciton</span></span>
<span id="cb155-2"><a href="raster_watershed.html#cb155-2" tabindex="-1"></a>slash_pile_detect_watershed <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb155-3"><a href="raster_watershed.html#cb155-3" tabindex="-1"></a>  chm_rast</span>
<span id="cb155-4"><a href="raster_watershed.html#cb155-4" tabindex="-1"></a>  <span class="do">#### height and area thresholds for the detected piles</span></span>
<span id="cb155-5"><a href="raster_watershed.html#cb155-5" tabindex="-1"></a>  <span class="co"># these should be based on data from the literature or expectations based on the prescription</span></span>
<span id="cb155-6"><a href="raster_watershed.html#cb155-6" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span> <span class="co"># set the max expected pile height</span></span>
<span id="cb155-7"><a href="raster_watershed.html#cb155-7" tabindex="-1"></a>  , <span class="at">min_ht_m =</span> <span class="fl">0.5</span> <span class="co"># set the min expected pile height</span></span>
<span id="cb155-8"><a href="raster_watershed.html#cb155-8" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="dv">2</span> <span class="co"># set the min expected pile area</span></span>
<span id="cb155-9"><a href="raster_watershed.html#cb155-9" tabindex="-1"></a>  , <span class="at">max_area_m2 =</span> <span class="dv">50</span> <span class="co"># set the max expected pile area</span></span>
<span id="cb155-10"><a href="raster_watershed.html#cb155-10" tabindex="-1"></a>  <span class="do">#### irregularity filtering</span></span>
<span id="cb155-11"><a href="raster_watershed.html#cb155-11" tabindex="-1"></a>  <span class="co"># 1 = perfectly convex (no inward angles); 0 = so many inward angles</span></span>
<span id="cb155-12"><a href="raster_watershed.html#cb155-12" tabindex="-1"></a>  <span class="co"># values closer to 1 remove more irregular segments; </span></span>
<span id="cb155-13"><a href="raster_watershed.html#cb155-13" tabindex="-1"></a>    <span class="co"># values closer to 0 keep more irregular segments (and also regular segments)</span></span>
<span id="cb155-14"><a href="raster_watershed.html#cb155-14" tabindex="-1"></a>  <span class="co"># these will all be further filtered for their circularity and later smoothed to remove blocky edges</span></span>
<span id="cb155-15"><a href="raster_watershed.html#cb155-15" tabindex="-1"></a>  <span class="co"># and most inward angles by applying a convex hull to the original detected segment</span></span>
<span id="cb155-16"><a href="raster_watershed.html#cb155-16" tabindex="-1"></a>  , <span class="at">convexity_pct =</span> <span class="fl">0.7</span> <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb155-17"><a href="raster_watershed.html#cb155-17" tabindex="-1"></a>  <span class="do">#### circularity filtering</span></span>
<span id="cb155-18"><a href="raster_watershed.html#cb155-18" tabindex="-1"></a>  <span class="co"># 1 = perfectly circular; 0 = not circular (e.g. linear) but also circular</span></span>
<span id="cb155-19"><a href="raster_watershed.html#cb155-19" tabindex="-1"></a>  <span class="co"># min required IoU between the predicted pile and the best fit circle of the predicted pile</span></span>
<span id="cb155-20"><a href="raster_watershed.html#cb155-20" tabindex="-1"></a>  , <span class="at">circle_fit_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb155-21"><a href="raster_watershed.html#cb155-21" tabindex="-1"></a>  <span class="do">#### shape refinement &amp; overlap removal</span></span>
<span id="cb155-22"><a href="raster_watershed.html#cb155-22" tabindex="-1"></a>  <span class="do">## smooth_segs = T ... convex hulls of raster detected segments are returned, any that overlap are removed</span></span>
<span id="cb155-23"><a href="raster_watershed.html#cb155-23" tabindex="-1"></a>  <span class="do">## smooth_segs = F ... raster detected segments are returned (blocky) if they meet all prior rules</span></span>
<span id="cb155-24"><a href="raster_watershed.html#cb155-24" tabindex="-1"></a>  , <span class="at">smooth_segs =</span> T</span>
<span id="cb155-25"><a href="raster_watershed.html#cb155-25" tabindex="-1"></a>) {</span>
<span id="cb155-26"><a href="raster_watershed.html#cb155-26" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb155-27"><a href="raster_watershed.html#cb155-27" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb155-28"><a href="raster_watershed.html#cb155-28" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> max_ht_m[<span class="dv">1</span>] </span>
<span id="cb155-29"><a href="raster_watershed.html#cb155-29" tabindex="-1"></a>  min_ht_m <span class="ot">&lt;-</span> min_ht_m[<span class="dv">1</span>] </span>
<span id="cb155-30"><a href="raster_watershed.html#cb155-30" tabindex="-1"></a>  min_area_m2 <span class="ot">&lt;-</span> min_area_m2[<span class="dv">1</span>] </span>
<span id="cb155-31"><a href="raster_watershed.html#cb155-31" tabindex="-1"></a>  max_area_m2 <span class="ot">&lt;-</span> max_area_m2[<span class="dv">1</span>] </span>
<span id="cb155-32"><a href="raster_watershed.html#cb155-32" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb155-33"><a href="raster_watershed.html#cb155-33" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb155-34"><a href="raster_watershed.html#cb155-34" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(max_ht_m), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb155-35"><a href="raster_watershed.html#cb155-35" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb155-36"><a href="raster_watershed.html#cb155-36" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb155-37"><a href="raster_watershed.html#cb155-37" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(min_ht_m), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb155-38"><a href="raster_watershed.html#cb155-38" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb155-39"><a href="raster_watershed.html#cb155-39" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb155-40"><a href="raster_watershed.html#cb155-40" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb155-41"><a href="raster_watershed.html#cb155-41" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb155-42"><a href="raster_watershed.html#cb155-42" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb155-43"><a href="raster_watershed.html#cb155-43" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb155-44"><a href="raster_watershed.html#cb155-44" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb155-45"><a href="raster_watershed.html#cb155-45" tabindex="-1"></a>    <span class="sc">!</span>(<span class="fu">as.numeric</span>(max_ht_m) <span class="sc">&gt;</span> <span class="fu">as.numeric</span>(min_ht_m)) <span class="sc">||</span></span>
<span id="cb155-46"><a href="raster_watershed.html#cb155-46" tabindex="-1"></a>    <span class="sc">!</span>(<span class="fu">as.numeric</span>(max_area_m2) <span class="sc">&gt;</span> <span class="fu">as.numeric</span>(min_area_m2)) <span class="sc">||</span></span>
<span id="cb155-47"><a href="raster_watershed.html#cb155-47" tabindex="-1"></a>    <span class="fu">as.numeric</span>(max_ht_m)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb155-48"><a href="raster_watershed.html#cb155-48" tabindex="-1"></a>    <span class="fu">as.numeric</span>(min_ht_m)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb155-49"><a href="raster_watershed.html#cb155-49" tabindex="-1"></a>    <span class="fu">as.numeric</span>(min_area_m2)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb155-50"><a href="raster_watershed.html#cb155-50" tabindex="-1"></a>    <span class="fu">as.numeric</span>(max_area_m2)<span class="sc">&lt;</span><span class="dv">0</span></span>
<span id="cb155-51"><a href="raster_watershed.html#cb155-51" tabindex="-1"></a>  ){</span>
<span id="cb155-52"><a href="raster_watershed.html#cb155-52" tabindex="-1"></a>    <span class="co"># Code to execute if any condition is met (e.g., print an error message)</span></span>
<span id="cb155-53"><a href="raster_watershed.html#cb155-53" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Error: One or more of `max_ht_m`,`min_ht_m`,`min_area_m2`,`max_area_m2` are not valid numbers, or the conditions max_area_m2&gt;min_area_m2 or max_ht_m&gt;min_ht_m are not met.&quot;</span>)</span>
<span id="cb155-54"><a href="raster_watershed.html#cb155-54" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb155-55"><a href="raster_watershed.html#cb155-55" tabindex="-1"></a>    max_ht_m <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(max_ht_m)[<span class="dv">1</span>] </span>
<span id="cb155-56"><a href="raster_watershed.html#cb155-56" tabindex="-1"></a>    min_ht_m <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(min_ht_m)[<span class="dv">1</span>] </span>
<span id="cb155-57"><a href="raster_watershed.html#cb155-57" tabindex="-1"></a>    min_area_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(min_area_m2)[<span class="dv">1</span>] </span>
<span id="cb155-58"><a href="raster_watershed.html#cb155-58" tabindex="-1"></a>    max_area_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(max_area_m2)[<span class="dv">1</span>] </span>
<span id="cb155-59"><a href="raster_watershed.html#cb155-59" tabindex="-1"></a>  }</span>
<span id="cb155-60"><a href="raster_watershed.html#cb155-60" tabindex="-1"></a>  <span class="co"># just get the first layer and &quot;slice&quot; the raster based on the height threshold</span></span>
<span id="cb155-61"><a href="raster_watershed.html#cb155-61" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb155-62"><a href="raster_watershed.html#cb155-62" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb155-63"><a href="raster_watershed.html#cb155-63" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb155-64"><a href="raster_watershed.html#cb155-64" tabindex="-1"></a>  </span>
<span id="cb155-65"><a href="raster_watershed.html#cb155-65" tabindex="-1"></a>  <span class="co"># could make this a parameter</span></span>
<span id="cb155-66"><a href="raster_watershed.html#cb155-66" tabindex="-1"></a>  <span class="co"># could automatically adjust for raster cell size: </span></span>
<span id="cb155-67"><a href="raster_watershed.html#cb155-67" tabindex="-1"></a>    <span class="co"># higher res (smaller cell size) get bigger ws, lower res (larger cell size) get smaller/no ws???</span></span>
<span id="cb155-68"><a href="raster_watershed.html#cb155-68" tabindex="-1"></a>  <span class="co"># get resolution which will be used to test against the minimum expected pile area</span></span>
<span id="cb155-69"><a href="raster_watershed.html#cb155-69" tabindex="-1"></a>  chm_res <span class="ot">&lt;-</span> <span class="fu">max</span>(terra<span class="sc">::</span><span class="fu">res</span>(chm_rast)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">na.rm =</span> T)</span>
<span id="cb155-70"><a href="raster_watershed.html#cb155-70" tabindex="-1"></a>  </span>
<span id="cb155-71"><a href="raster_watershed.html#cb155-71" tabindex="-1"></a>  ws_for_smooth <span class="ot">&lt;-</span> <span class="fu">ws_for_smooth_fn</span>(<span class="at">chm_res =</span> chm_res, <span class="at">min_area_m2 =</span> min_area_m2) <span class="co"># 3 # needs to be the same for the watershed seg and CHM smooth</span></span>
<span id="cb155-72"><a href="raster_watershed.html#cb155-72" tabindex="-1"></a>  <span class="co"># search_area = (res^2) * (ws^2)</span></span>
<span id="cb155-73"><a href="raster_watershed.html#cb155-73" tabindex="-1"></a>  </span>
<span id="cb155-74"><a href="raster_watershed.html#cb155-74" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-75"><a href="raster_watershed.html#cb155-75" tabindex="-1"></a>  <span class="do">## 1) watershed segmentation</span></span>
<span id="cb155-76"><a href="raster_watershed.html#cb155-76" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-77"><a href="raster_watershed.html#cb155-77" tabindex="-1"></a>    <span class="co"># let&#39;s run watershed segmentation using `lidR::watershed()` which is based on the bioconductor package `EBIimage`</span></span>
<span id="cb155-78"><a href="raster_watershed.html#cb155-78" tabindex="-1"></a>    <span class="co"># return is a raster with the first layer representing the identified watershed segments</span></span>
<span id="cb155-79"><a href="raster_watershed.html#cb155-79" tabindex="-1"></a>    watershed_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb155-80"><a href="raster_watershed.html#cb155-80" tabindex="-1"></a>        <span class="at">chm =</span> chm_rast</span>
<span id="cb155-81"><a href="raster_watershed.html#cb155-81" tabindex="-1"></a>        , <span class="at">th_tree =</span> <span class="fu">min</span>(<span class="fl">0.1</span>,min_ht_m)</span>
<span id="cb155-82"><a href="raster_watershed.html#cb155-82" tabindex="-1"></a>      )()</span>
<span id="cb155-83"><a href="raster_watershed.html#cb155-83" tabindex="-1"></a>    <span class="fu">names</span>(watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb155-84"><a href="raster_watershed.html#cb155-84" tabindex="-1"></a></span>
<span id="cb155-85"><a href="raster_watershed.html#cb155-85" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb155-86"><a href="raster_watershed.html#cb155-86" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb155-87"><a href="raster_watershed.html#cb155-87" tabindex="-1"></a>      watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb155-88"><a href="raster_watershed.html#cb155-88" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb155-89"><a href="raster_watershed.html#cb155-89" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-90"><a href="raster_watershed.html#cb155-90" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-91"><a href="raster_watershed.html#cb155-91" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-92"><a href="raster_watershed.html#cb155-92" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-93"><a href="raster_watershed.html#cb155-93" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb155-94"><a href="raster_watershed.html#cb155-94" tabindex="-1"></a>      <span class="co"># simplify multipolygons by keeping the largest polygon of each multipolygon</span></span>
<span id="cb155-95"><a href="raster_watershed.html#cb155-95" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb155-96"><a href="raster_watershed.html#cb155-96" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-97"><a href="raster_watershed.html#cb155-97" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb155-98"><a href="raster_watershed.html#cb155-98" tabindex="-1"></a></span>
<span id="cb155-99"><a href="raster_watershed.html#cb155-99" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-100"><a href="raster_watershed.html#cb155-100" tabindex="-1"></a>  <span class="do">## 2) irregularity filtering</span></span>
<span id="cb155-101"><a href="raster_watershed.html#cb155-101" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-102"><a href="raster_watershed.html#cb155-102" tabindex="-1"></a>    <span class="co"># let&#39;s first filter out segments that have holes in them </span></span>
<span id="cb155-103"><a href="raster_watershed.html#cb155-103" tabindex="-1"></a>    <span class="co"># or are very irregularly shaped by comparing the area of the polygon and convex hull</span></span>
<span id="cb155-104"><a href="raster_watershed.html#cb155-104" tabindex="-1"></a></span>
<span id="cb155-105"><a href="raster_watershed.html#cb155-105" tabindex="-1"></a>    <span class="co"># convexity_pct = min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb155-106"><a href="raster_watershed.html#cb155-106" tabindex="-1"></a>    <span class="cf">if</span>(convexity_pct<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb155-107"><a href="raster_watershed.html#cb155-107" tabindex="-1"></a>      <span class="co"># apply the irregularity filtering on the polygons</span></span>
<span id="cb155-108"><a href="raster_watershed.html#cb155-108" tabindex="-1"></a>      watershed_ans_poly <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-109"><a href="raster_watershed.html#cb155-109" tabindex="-1"></a>        <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> convexity_pct)</span>
<span id="cb155-110"><a href="raster_watershed.html#cb155-110" tabindex="-1"></a>    }</span>
<span id="cb155-111"><a href="raster_watershed.html#cb155-111" tabindex="-1"></a></span>
<span id="cb155-112"><a href="raster_watershed.html#cb155-112" tabindex="-1"></a>    <span class="co"># check return</span></span>
<span id="cb155-113"><a href="raster_watershed.html#cb155-113" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb155-114"><a href="raster_watershed.html#cb155-114" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb155-115"><a href="raster_watershed.html#cb155-115" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and irregularity expectations&quot;</span></span>
<span id="cb155-116"><a href="raster_watershed.html#cb155-116" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `convexity_pct` &quot;</span></span>
<span id="cb155-117"><a href="raster_watershed.html#cb155-117" tabindex="-1"></a>      ))</span>
<span id="cb155-118"><a href="raster_watershed.html#cb155-118" tabindex="-1"></a>    }</span>
<span id="cb155-119"><a href="raster_watershed.html#cb155-119" tabindex="-1"></a></span>
<span id="cb155-120"><a href="raster_watershed.html#cb155-120" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-121"><a href="raster_watershed.html#cb155-121" tabindex="-1"></a>  <span class="do">## 3) area filtering</span></span>
<span id="cb155-122"><a href="raster_watershed.html#cb155-122" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-123"><a href="raster_watershed.html#cb155-123" tabindex="-1"></a>    <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb155-124"><a href="raster_watershed.html#cb155-124" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-125"><a href="raster_watershed.html#cb155-125" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb155-126"><a href="raster_watershed.html#cb155-126" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb155-127"><a href="raster_watershed.html#cb155-127" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb155-128"><a href="raster_watershed.html#cb155-128" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb155-129"><a href="raster_watershed.html#cb155-129" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-130"><a href="raster_watershed.html#cb155-130" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(area_xxxx))</span>
<span id="cb155-131"><a href="raster_watershed.html#cb155-131" tabindex="-1"></a>   </span>
<span id="cb155-132"><a href="raster_watershed.html#cb155-132" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-133"><a href="raster_watershed.html#cb155-133" tabindex="-1"></a>  <span class="do">## 4) circularity filtering</span></span>
<span id="cb155-134"><a href="raster_watershed.html#cb155-134" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-135"><a href="raster_watershed.html#cb155-135" tabindex="-1"></a>    <span class="co"># let&#39;s apply a circle-fitting algorithm to remove non-circular segments from the remaining segments</span></span>
<span id="cb155-136"><a href="raster_watershed.html#cb155-136" tabindex="-1"></a>    <span class="co"># let&#39;s apply the `sf_data_circle_fit()` function that</span></span>
<span id="cb155-137"><a href="raster_watershed.html#cb155-137" tabindex="-1"></a>    <span class="co"># fits the best circle using `lidR::fit_circle()` to each watershed detected segment </span></span>
<span id="cb155-138"><a href="raster_watershed.html#cb155-138" tabindex="-1"></a>    <span class="co"># to get a spatial data frame with the best fitting circle for each segment</span></span>
<span id="cb155-139"><a href="raster_watershed.html#cb155-139" tabindex="-1"></a>    <span class="cf">if</span>(circle_fit_iou_pct<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb155-140"><a href="raster_watershed.html#cb155-140" tabindex="-1"></a>        watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> <span class="fu">unique</span>(watershed_ans_poly<span class="sc">$</span>pred_id)</span>
<span id="cb155-141"><a href="raster_watershed.html#cb155-141" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb155-142"><a href="raster_watershed.html#cb155-142" tabindex="-1"></a>      <span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb155-143"><a href="raster_watershed.html#cb155-143" tabindex="-1"></a>      watershed_ans_poly_circle_fit <span class="ot">&lt;-</span> <span class="fu">sf_data_circle_fit</span>(watershed_ans_poly)</span>
<span id="cb155-144"><a href="raster_watershed.html#cb155-144" tabindex="-1"></a>      </span>
<span id="cb155-145"><a href="raster_watershed.html#cb155-145" tabindex="-1"></a>      <span class="co"># filter using the intersection over union (IoU) between the circle and the predicted segment. </span></span>
<span id="cb155-146"><a href="raster_watershed.html#cb155-146" tabindex="-1"></a>      <span class="co"># we&#39;ll use the IoU function we defined </span></span>
<span id="cb155-147"><a href="raster_watershed.html#cb155-147" tabindex="-1"></a>      <span class="co"># we map over this to only compare the segment to it&#39;s own best circle fit...not all</span></span>
<span id="cb155-148"><a href="raster_watershed.html#cb155-148" tabindex="-1"></a>      <span class="co"># we should consider doing this in bulk.....another day</span></span>
<span id="cb155-149"><a href="raster_watershed.html#cb155-149" tabindex="-1"></a>      watershed_circle_fit_iou <span class="ot">&lt;-</span> </span>
<span id="cb155-150"><a href="raster_watershed.html#cb155-150" tabindex="-1"></a>        watershed_ans_poly<span class="sc">$</span>pred_id <span class="sc">%&gt;%</span> </span>
<span id="cb155-151"><a href="raster_watershed.html#cb155-151" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-152"><a href="raster_watershed.html#cb155-152" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb155-153"><a href="raster_watershed.html#cb155-153" tabindex="-1"></a>          <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb155-154"><a href="raster_watershed.html#cb155-154" tabindex="-1"></a>            <span class="at">gt_inst =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-155"><a href="raster_watershed.html#cb155-155" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x)</span>
<span id="cb155-156"><a href="raster_watershed.html#cb155-156" tabindex="-1"></a>            , <span class="at">gt_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb155-157"><a href="raster_watershed.html#cb155-157" tabindex="-1"></a>            , <span class="at">predictions =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb155-158"><a href="raster_watershed.html#cb155-158" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb155-159"><a href="raster_watershed.html#cb155-159" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb155-160"><a href="raster_watershed.html#cb155-160" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_pred_id =</span> pred_id)</span>
<span id="cb155-161"><a href="raster_watershed.html#cb155-161" tabindex="-1"></a>            , <span class="at">pred_id =</span> <span class="st">&quot;circ_pred_id&quot;</span></span>
<span id="cb155-162"><a href="raster_watershed.html#cb155-162" tabindex="-1"></a>            , <span class="at">min_iou_pct =</span> <span class="dv">0</span> <span class="co"># set to 0 just to return pct</span></span>
<span id="cb155-163"><a href="raster_watershed.html#cb155-163" tabindex="-1"></a>          )    </span>
<span id="cb155-164"><a href="raster_watershed.html#cb155-164" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-165"><a href="raster_watershed.html#cb155-165" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb155-166"><a href="raster_watershed.html#cb155-166" tabindex="-1"></a>      </span>
<span id="cb155-167"><a href="raster_watershed.html#cb155-167" tabindex="-1"></a>      <span class="co"># threshold for the minimum IoU to further filter for segments that are approximately round, </span></span>
<span id="cb155-168"><a href="raster_watershed.html#cb155-168" tabindex="-1"></a>      <span class="co"># this filter should remove linear objects from the watershed detections</span></span>
<span id="cb155-169"><a href="raster_watershed.html#cb155-169" tabindex="-1"></a>        <span class="co"># compare iou</span></span>
<span id="cb155-170"><a href="raster_watershed.html#cb155-170" tabindex="-1"></a>        watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb155-171"><a href="raster_watershed.html#cb155-171" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(iou<span class="sc">&gt;=</span>circle_fit_iou_pct) <span class="sc">%&gt;%</span> </span>
<span id="cb155-172"><a href="raster_watershed.html#cb155-172" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id) </span>
<span id="cb155-173"><a href="raster_watershed.html#cb155-173" tabindex="-1"></a>    }</span>
<span id="cb155-174"><a href="raster_watershed.html#cb155-174" tabindex="-1"></a>      </span>
<span id="cb155-175"><a href="raster_watershed.html#cb155-175" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb155-176"><a href="raster_watershed.html#cb155-176" tabindex="-1"></a>      <span class="fu">identical</span>(watershed_keep_circle_fit_pred_id, <span class="fu">numeric</span>(<span class="dv">0</span>))</span>
<span id="cb155-177"><a href="raster_watershed.html#cb155-177" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.null</span>(watershed_keep_circle_fit_pred_id))</span>
<span id="cb155-178"><a href="raster_watershed.html#cb155-178" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(watershed_keep_circle_fit_pred_id))</span>
<span id="cb155-179"><a href="raster_watershed.html#cb155-179" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">length</span>(watershed_keep_circle_fit_pred_id)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb155-180"><a href="raster_watershed.html#cb155-180" tabindex="-1"></a>    ){</span>
<span id="cb155-181"><a href="raster_watershed.html#cb155-181" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb155-182"><a href="raster_watershed.html#cb155-182" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and circularity expectations&quot;</span></span>
<span id="cb155-183"><a href="raster_watershed.html#cb155-183" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `circle_fit_iou_pct` &quot;</span></span>
<span id="cb155-184"><a href="raster_watershed.html#cb155-184" tabindex="-1"></a>      ))</span>
<span id="cb155-185"><a href="raster_watershed.html#cb155-185" tabindex="-1"></a>    }</span>
<span id="cb155-186"><a href="raster_watershed.html#cb155-186" tabindex="-1"></a>  </span>
<span id="cb155-187"><a href="raster_watershed.html#cb155-187" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-188"><a href="raster_watershed.html#cb155-188" tabindex="-1"></a>  <span class="do">## 5) raster smoothing</span></span>
<span id="cb155-189"><a href="raster_watershed.html#cb155-189" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-190"><a href="raster_watershed.html#cb155-190" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb155-191"><a href="raster_watershed.html#cb155-191" tabindex="-1"></a>    <span class="co"># use the remaining segments that meet the geometric and area filtering</span></span>
<span id="cb155-192"><a href="raster_watershed.html#cb155-192" tabindex="-1"></a>    <span class="co"># to smooth the watershed raster</span></span>
<span id="cb155-193"><a href="raster_watershed.html#cb155-193" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb155-194"><a href="raster_watershed.html#cb155-194" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb155-195"><a href="raster_watershed.html#cb155-195" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(</span>
<span id="cb155-196"><a href="raster_watershed.html#cb155-196" tabindex="-1"></a>        watershed_ans_poly <span class="sc">%&gt;%</span> <span class="co">#these are irregularity and area filtered already</span></span>
<span id="cb155-197"><a href="raster_watershed.html#cb155-197" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb155-198"><a href="raster_watershed.html#cb155-198" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb155-199"><a href="raster_watershed.html#cb155-199" tabindex="-1"></a>        , <span class="at">updatevalue=</span><span class="cn">NA</span></span>
<span id="cb155-200"><a href="raster_watershed.html#cb155-200" tabindex="-1"></a>      )</span>
<span id="cb155-201"><a href="raster_watershed.html#cb155-201" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb155-202"><a href="raster_watershed.html#cb155-202" tabindex="-1"></a>      <span class="co"># smooths the raster using the majority value</span></span>
<span id="cb155-203"><a href="raster_watershed.html#cb155-203" tabindex="-1"></a>      smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb155-204"><a href="raster_watershed.html#cb155-204" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;modal&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co"># only fill NA cells  </span></span>
<span id="cb155-205"><a href="raster_watershed.html#cb155-205" tabindex="-1"></a>    }</span>
<span id="cb155-206"><a href="raster_watershed.html#cb155-206" tabindex="-1"></a>    </span>
<span id="cb155-207"><a href="raster_watershed.html#cb155-207" tabindex="-1"></a>    <span class="fu">names</span>(smooth_watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb155-208"><a href="raster_watershed.html#cb155-208" tabindex="-1"></a></span>
<span id="cb155-209"><a href="raster_watershed.html#cb155-209" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb155-210"><a href="raster_watershed.html#cb155-210" tabindex="-1"></a>    <span class="co"># mask the chm rast to these remaining segments and smooth to match the smoothing for the segments</span></span>
<span id="cb155-211"><a href="raster_watershed.html#cb155-211" tabindex="-1"></a>    <span class="do">########################################</span></span>
<span id="cb155-212"><a href="raster_watershed.html#cb155-212" tabindex="-1"></a>    smooth_chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb155-213"><a href="raster_watershed.html#cb155-213" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_watershed_ans)</span>
<span id="cb155-214"><a href="raster_watershed.html#cb155-214" tabindex="-1"></a>    </span>
<span id="cb155-215"><a href="raster_watershed.html#cb155-215" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(ws_for_smooth,<span class="dv">0</span>)<span class="sc">&gt;=</span><span class="dv">3</span>){</span>
<span id="cb155-216"><a href="raster_watershed.html#cb155-216" tabindex="-1"></a>      <span class="co"># smooths the raster to match the smoothing in the watershed segments</span></span>
<span id="cb155-217"><a href="raster_watershed.html#cb155-217" tabindex="-1"></a>      smooth_chm_rast <span class="ot">&lt;-</span> smooth_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb155-218"><a href="raster_watershed.html#cb155-218" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">focal</span>(<span class="at">w =</span> ws_for_smooth, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> T, <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span>) <span class="co">#only for cells that are NA</span></span>
<span id="cb155-219"><a href="raster_watershed.html#cb155-219" tabindex="-1"></a>    }</span>
<span id="cb155-220"><a href="raster_watershed.html#cb155-220" tabindex="-1"></a></span>
<span id="cb155-221"><a href="raster_watershed.html#cb155-221" tabindex="-1"></a>    <span class="co"># now mask the watershed_ans raster to only keep cells that are in the originating CHM</span></span>
<span id="cb155-222"><a href="raster_watershed.html#cb155-222" tabindex="-1"></a>    smooth_watershed_ans <span class="ot">&lt;-</span> smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb155-223"><a href="raster_watershed.html#cb155-223" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">mask</span>(smooth_chm_rast)</span>
<span id="cb155-224"><a href="raster_watershed.html#cb155-224" tabindex="-1"></a></span>
<span id="cb155-225"><a href="raster_watershed.html#cb155-225" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-226"><a href="raster_watershed.html#cb155-226" tabindex="-1"></a>  <span class="do">## calculate raster-based area and volume </span></span>
<span id="cb155-227"><a href="raster_watershed.html#cb155-227" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-228"><a href="raster_watershed.html#cb155-228" tabindex="-1"></a>    <span class="co"># first, calculate the area of each cell</span></span>
<span id="cb155-229"><a href="raster_watershed.html#cb155-229" tabindex="-1"></a>    area_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(smooth_chm_rast)</span>
<span id="cb155-230"><a href="raster_watershed.html#cb155-230" tabindex="-1"></a>    <span class="fu">names</span>(area_rast) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb155-231"><a href="raster_watershed.html#cb155-231" tabindex="-1"></a>    <span class="co"># area_rast %&gt;% terra::plot()</span></span>
<span id="cb155-232"><a href="raster_watershed.html#cb155-232" tabindex="-1"></a>    <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb155-233"><a href="raster_watershed.html#cb155-233" tabindex="-1"></a>    vol_rast <span class="ot">&lt;-</span> area_rast<span class="sc">*</span>smooth_chm_rast</span>
<span id="cb155-234"><a href="raster_watershed.html#cb155-234" tabindex="-1"></a>    <span class="fu">names</span>(vol_rast) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb155-235"><a href="raster_watershed.html#cb155-235" tabindex="-1"></a>    <span class="co"># vol_rast %&gt;% terra::plot()</span></span>
<span id="cb155-236"><a href="raster_watershed.html#cb155-236" tabindex="-1"></a>    <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb155-237"><a href="raster_watershed.html#cb155-237" tabindex="-1"></a>    area_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> area_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb155-238"><a href="raster_watershed.html#cb155-238" tabindex="-1"></a>    <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb155-239"><a href="raster_watershed.html#cb155-239" tabindex="-1"></a>    vol_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> vol_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb155-240"><a href="raster_watershed.html#cb155-240" tabindex="-1"></a>    <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb155-241"><a href="raster_watershed.html#cb155-241" tabindex="-1"></a>    ht_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> smooth_chm_rast, <span class="at">z =</span> smooth_watershed_ans, <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb155-242"><a href="raster_watershed.html#cb155-242" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">max_height_m=</span><span class="dv">2</span>)</span>
<span id="cb155-243"><a href="raster_watershed.html#cb155-243" tabindex="-1"></a>      </span>
<span id="cb155-244"><a href="raster_watershed.html#cb155-244" tabindex="-1"></a>    <span class="co"># let&#39;s convert the smoothed and filtered watershed-detected segments from raster to vector data </span></span>
<span id="cb155-245"><a href="raster_watershed.html#cb155-245" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb155-246"><a href="raster_watershed.html#cb155-246" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb155-247"><a href="raster_watershed.html#cb155-247" tabindex="-1"></a>      smooth_watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb155-248"><a href="raster_watershed.html#cb155-248" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb155-249"><a href="raster_watershed.html#cb155-249" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-250"><a href="raster_watershed.html#cb155-250" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-251"><a href="raster_watershed.html#cb155-251" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-252"><a href="raster_watershed.html#cb155-252" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb155-253"><a href="raster_watershed.html#cb155-253" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb155-254"><a href="raster_watershed.html#cb155-254" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-255"><a href="raster_watershed.html#cb155-255" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb155-256"><a href="raster_watershed.html#cb155-256" tabindex="-1"></a></span>
<span id="cb155-257"><a href="raster_watershed.html#cb155-257" tabindex="-1"></a>    <span class="co"># add area and volume to our vector data  </span></span>
<span id="cb155-258"><a href="raster_watershed.html#cb155-258" tabindex="-1"></a>    <span class="co"># we&#39;ll do this with a slick trick to perform multiple joins succinctly using purrr::reduce</span></span>
<span id="cb155-259"><a href="raster_watershed.html#cb155-259" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb155-260"><a href="raster_watershed.html#cb155-260" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">reduce</span>(</span>
<span id="cb155-261"><a href="raster_watershed.html#cb155-261" tabindex="-1"></a>        <span class="fu">list</span>(watershed_ans_poly, area_df, vol_df, ht_df)</span>
<span id="cb155-262"><a href="raster_watershed.html#cb155-262" tabindex="-1"></a>        , dplyr<span class="sc">::</span>left_join</span>
<span id="cb155-263"><a href="raster_watershed.html#cb155-263" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&#39;pred_id&#39;</span></span>
<span id="cb155-264"><a href="raster_watershed.html#cb155-264" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-265"><a href="raster_watershed.html#cb155-265" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb155-266"><a href="raster_watershed.html#cb155-266" tabindex="-1"></a>        <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb155-267"><a href="raster_watershed.html#cb155-267" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-268"><a href="raster_watershed.html#cb155-268" tabindex="-1"></a>      <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb155-269"><a href="raster_watershed.html#cb155-269" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb155-270"><a href="raster_watershed.html#cb155-270" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb155-271"><a href="raster_watershed.html#cb155-271" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb155-272"><a href="raster_watershed.html#cb155-272" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(max_height_m,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_ht_m</span>
<span id="cb155-273"><a href="raster_watershed.html#cb155-273" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-274"><a href="raster_watershed.html#cb155-274" tabindex="-1"></a>      <span class="co"># do one more pass of the irregularity filtering</span></span>
<span id="cb155-275"><a href="raster_watershed.html#cb155-275" tabindex="-1"></a>      <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> convexity_pct)</span>
<span id="cb155-276"><a href="raster_watershed.html#cb155-276" tabindex="-1"></a>      </span>
<span id="cb155-277"><a href="raster_watershed.html#cb155-277" tabindex="-1"></a>      <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb155-278"><a href="raster_watershed.html#cb155-278" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb155-279"><a href="raster_watershed.html#cb155-279" tabindex="-1"></a>          <span class="st">&quot;no segments detected using the given CHM and expected size thresholds&quot;</span></span>
<span id="cb155-280"><a href="raster_watershed.html#cb155-280" tabindex="-1"></a>          , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `max_ht_m`, `min_area_m2`, `max_area_m2` &quot;</span></span>
<span id="cb155-281"><a href="raster_watershed.html#cb155-281" tabindex="-1"></a>        ))</span>
<span id="cb155-282"><a href="raster_watershed.html#cb155-282" tabindex="-1"></a>      }</span>
<span id="cb155-283"><a href="raster_watershed.html#cb155-283" tabindex="-1"></a>   </span>
<span id="cb155-284"><a href="raster_watershed.html#cb155-284" tabindex="-1"></a></span>
<span id="cb155-285"><a href="raster_watershed.html#cb155-285" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-286"><a href="raster_watershed.html#cb155-286" tabindex="-1"></a>  <span class="do">## 4) shape refinement &amp; overlap removal</span></span>
<span id="cb155-287"><a href="raster_watershed.html#cb155-287" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb155-288"><a href="raster_watershed.html#cb155-288" tabindex="-1"></a>    <span class="co"># use the convex hull shapes of our remaining segments. </span></span>
<span id="cb155-289"><a href="raster_watershed.html#cb155-289" tabindex="-1"></a>    <span class="co"># This helps to smooth out the often &#39;blocky&#39; edges of raster-based segments</span></span>
<span id="cb155-290"><a href="raster_watershed.html#cb155-290" tabindex="-1"></a>    <span class="co"># , which can look like they were generated in Minecraft. </span></span>
<span id="cb155-291"><a href="raster_watershed.html#cb155-291" tabindex="-1"></a>    <span class="co"># Additionally, by removing any segments with overlapping convex hull shapes, </span></span>
<span id="cb155-292"><a href="raster_watershed.html#cb155-292" tabindex="-1"></a>    <span class="co"># we can likely reduce false detections that are actually groups of small trees or shrubs, </span></span>
<span id="cb155-293"><a href="raster_watershed.html#cb155-293" tabindex="-1"></a>    <span class="co"># ensuring our results represent singular slash piles.</span></span>
<span id="cb155-294"><a href="raster_watershed.html#cb155-294" tabindex="-1"></a>    </span>
<span id="cb155-295"><a href="raster_watershed.html#cb155-295" tabindex="-1"></a>    <span class="cf">if</span>(smooth_segs){</span>
<span id="cb155-296"><a href="raster_watershed.html#cb155-296" tabindex="-1"></a>      <span class="do">### ORIGINAL didn&#39;t combine touching segments first</span></span>
<span id="cb155-297"><a href="raster_watershed.html#cb155-297" tabindex="-1"></a>      <span class="co"># return_dta &lt;- watershed_ans_poly %&gt;% </span></span>
<span id="cb155-298"><a href="raster_watershed.html#cb155-298" tabindex="-1"></a>      <span class="co">#   sf::st_convex_hull() %&gt;% </span></span>
<span id="cb155-299"><a href="raster_watershed.html#cb155-299" tabindex="-1"></a>      <span class="co">#   sf::st_simplify() %&gt;% </span></span>
<span id="cb155-300"><a href="raster_watershed.html#cb155-300" tabindex="-1"></a>      <span class="co">#   sf::st_make_valid() %&gt;% </span></span>
<span id="cb155-301"><a href="raster_watershed.html#cb155-301" tabindex="-1"></a>      <span class="co">#   dplyr::filter(sf::st_is_valid(.)) %&gt;% </span></span>
<span id="cb155-302"><a href="raster_watershed.html#cb155-302" tabindex="-1"></a>      <span class="co">#   dplyr::filter(pred_id %in% watershed_keep_circle_fit_pred_id) %&gt;% </span></span>
<span id="cb155-303"><a href="raster_watershed.html#cb155-303" tabindex="-1"></a>      <span class="co">#   st_remove_overlaps() %&gt;% </span></span>
<span id="cb155-304"><a href="raster_watershed.html#cb155-304" tabindex="-1"></a>      <span class="co">#   # now we need to re-do the volume and area calculations</span></span>
<span id="cb155-305"><a href="raster_watershed.html#cb155-305" tabindex="-1"></a>      <span class="co">#   dplyr::mutate(</span></span>
<span id="cb155-306"><a href="raster_watershed.html#cb155-306" tabindex="-1"></a>      <span class="co">#     area_m2 = sf::st_area(.) %&gt;% as.numeric()</span></span>
<span id="cb155-307"><a href="raster_watershed.html#cb155-307" tabindex="-1"></a>      <span class="co">#     , volume_m3 = area_m2*volume_per_area</span></span>
<span id="cb155-308"><a href="raster_watershed.html#cb155-308" tabindex="-1"></a>      <span class="co">#   ) %&gt;% </span></span>
<span id="cb155-309"><a href="raster_watershed.html#cb155-309" tabindex="-1"></a>      <span class="co">#   dplyr::filter(</span></span>
<span id="cb155-310"><a href="raster_watershed.html#cb155-310" tabindex="-1"></a>      <span class="co">#     dplyr::coalesce(area_m2,0) &gt;= min_area_m2</span></span>
<span id="cb155-311"><a href="raster_watershed.html#cb155-311" tabindex="-1"></a>      <span class="co">#     &amp; dplyr::coalesce(area_m2,0) &lt;= max_area_m2</span></span>
<span id="cb155-312"><a href="raster_watershed.html#cb155-312" tabindex="-1"></a>      <span class="co">#   )</span></span>
<span id="cb155-313"><a href="raster_watershed.html#cb155-313" tabindex="-1"></a>      </span>
<span id="cb155-314"><a href="raster_watershed.html#cb155-314" tabindex="-1"></a>      <span class="co"># combine polygons that share a common border but don&#39;t overlap</span></span>
<span id="cb155-315"><a href="raster_watershed.html#cb155-315" tabindex="-1"></a>        comb_watershed_ans_poly <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-316"><a href="raster_watershed.html#cb155-316" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb155-317"><a href="raster_watershed.html#cb155-317" tabindex="-1"></a>          <span class="fu">st_dissolve_and_combine</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-318"><a href="raster_watershed.html#cb155-318" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">id_comb_xxx =</span> id) </span>
<span id="cb155-319"><a href="raster_watershed.html#cb155-319" tabindex="-1"></a>      <span class="co"># recalculate metrics</span></span>
<span id="cb155-320"><a href="raster_watershed.html#cb155-320" tabindex="-1"></a>        agg_comb_watershed_ans_poly <span class="ot">&lt;-</span> comb_watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-321"><a href="raster_watershed.html#cb155-321" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb155-322"><a href="raster_watershed.html#cb155-322" tabindex="-1"></a>            watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-323"><a href="raster_watershed.html#cb155-323" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id)</span>
<span id="cb155-324"><a href="raster_watershed.html#cb155-324" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-325"><a href="raster_watershed.html#cb155-325" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-326"><a href="raster_watershed.html#cb155-326" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">group_by</span>(id_comb_xxx) <span class="sc">%&gt;%</span> </span>
<span id="cb155-327"><a href="raster_watershed.html#cb155-327" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb155-328"><a href="raster_watershed.html#cb155-328" tabindex="-1"></a>            <span class="at">area_m2 =</span> <span class="fu">sum</span>(area_m2, <span class="at">na.rm =</span> T)</span>
<span id="cb155-329"><a href="raster_watershed.html#cb155-329" tabindex="-1"></a>            , <span class="at">volume_m3 =</span> <span class="fu">sum</span>(volume_m3, <span class="at">na.rm =</span> T)</span>
<span id="cb155-330"><a href="raster_watershed.html#cb155-330" tabindex="-1"></a>            , <span class="at">max_height_m =</span> <span class="fu">max</span>(max_height_m, <span class="at">na.rm =</span> T)</span>
<span id="cb155-331"><a href="raster_watershed.html#cb155-331" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-332"><a href="raster_watershed.html#cb155-332" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb155-333"><a href="raster_watershed.html#cb155-333" tabindex="-1"></a>            <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb155-334"><a href="raster_watershed.html#cb155-334" tabindex="-1"></a>          )</span>
<span id="cb155-335"><a href="raster_watershed.html#cb155-335" tabindex="-1"></a>      <span class="co"># bring together</span></span>
<span id="cb155-336"><a href="raster_watershed.html#cb155-336" tabindex="-1"></a>        comb_watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb155-337"><a href="raster_watershed.html#cb155-337" tabindex="-1"></a>          comb_watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-338"><a href="raster_watershed.html#cb155-338" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(agg_comb_watershed_ans_poly, <span class="at">by =</span> <span class="st">&quot;id_comb_xxx&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb155-339"><a href="raster_watershed.html#cb155-339" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">pred_id =</span> id_comb_xxx) <span class="sc">%&gt;%</span> </span>
<span id="cb155-340"><a href="raster_watershed.html#cb155-340" tabindex="-1"></a>          <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb155-341"><a href="raster_watershed.html#cb155-341" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb155-342"><a href="raster_watershed.html#cb155-342" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb155-343"><a href="raster_watershed.html#cb155-343" tabindex="-1"></a>            <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb155-344"><a href="raster_watershed.html#cb155-344" tabindex="-1"></a>            <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(max_height_m,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_ht_m</span>
<span id="cb155-345"><a href="raster_watershed.html#cb155-345" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-346"><a href="raster_watershed.html#cb155-346" tabindex="-1"></a>          <span class="co"># do one more pass of the irregularity filtering</span></span>
<span id="cb155-347"><a href="raster_watershed.html#cb155-347" tabindex="-1"></a>          <span class="fu">st_irregular_remove</span>(<span class="at">pct_chull_overlap =</span> convexity_pct) <span class="sc">%&gt;%</span> </span>
<span id="cb155-348"><a href="raster_watershed.html#cb155-348" tabindex="-1"></a>          <span class="co"># simplify multipolygons</span></span>
<span id="cb155-349"><a href="raster_watershed.html#cb155-349" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb155-350"><a href="raster_watershed.html#cb155-350" tabindex="-1"></a>          cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-351"><a href="raster_watershed.html#cb155-351" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb155-352"><a href="raster_watershed.html#cb155-352" tabindex="-1"></a>        </span>
<span id="cb155-353"><a href="raster_watershed.html#cb155-353" tabindex="-1"></a>        <span class="co"># watershed_ans_poly %&gt;% dplyr::glimpse()</span></span>
<span id="cb155-354"><a href="raster_watershed.html#cb155-354" tabindex="-1"></a>        <span class="co"># comb_watershed_ans_poly %&gt;% dplyr::glimpse()</span></span>
<span id="cb155-355"><a href="raster_watershed.html#cb155-355" tabindex="-1"></a>      </span>
<span id="cb155-356"><a href="raster_watershed.html#cb155-356" tabindex="-1"></a>      <span class="co"># apply st_convex_hull</span></span>
<span id="cb155-357"><a href="raster_watershed.html#cb155-357" tabindex="-1"></a>        return_dta <span class="ot">&lt;-</span> comb_watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-358"><a href="raster_watershed.html#cb155-358" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-359"><a href="raster_watershed.html#cb155-359" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-360"><a href="raster_watershed.html#cb155-360" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-361"><a href="raster_watershed.html#cb155-361" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb155-362"><a href="raster_watershed.html#cb155-362" tabindex="-1"></a>          <span class="fu">st_remove_overlaps</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-363"><a href="raster_watershed.html#cb155-363" tabindex="-1"></a>          <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb155-364"><a href="raster_watershed.html#cb155-364" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb155-365"><a href="raster_watershed.html#cb155-365" tabindex="-1"></a>            <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb155-366"><a href="raster_watershed.html#cb155-366" tabindex="-1"></a>            , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb155-367"><a href="raster_watershed.html#cb155-367" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-368"><a href="raster_watershed.html#cb155-368" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb155-369"><a href="raster_watershed.html#cb155-369" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb155-370"><a href="raster_watershed.html#cb155-370" tabindex="-1"></a>            <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb155-371"><a href="raster_watershed.html#cb155-371" tabindex="-1"></a>          )</span>
<span id="cb155-372"><a href="raster_watershed.html#cb155-372" tabindex="-1"></a>      </span>
<span id="cb155-373"><a href="raster_watershed.html#cb155-373" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb155-374"><a href="raster_watershed.html#cb155-374" tabindex="-1"></a>      return_dta <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-375"><a href="raster_watershed.html#cb155-375" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id)</span>
<span id="cb155-376"><a href="raster_watershed.html#cb155-376" tabindex="-1"></a>    }</span>
<span id="cb155-377"><a href="raster_watershed.html#cb155-377" tabindex="-1"></a>    </span>
<span id="cb155-378"><a href="raster_watershed.html#cb155-378" tabindex="-1"></a>    <span class="co"># calculate diameter</span></span>
<span id="cb155-379"><a href="raster_watershed.html#cb155-379" tabindex="-1"></a>    return_dta <span class="ot">&lt;-</span> <span class="fu">st_calculate_diameter</span>(return_dta)</span>
<span id="cb155-380"><a href="raster_watershed.html#cb155-380" tabindex="-1"></a>      </span>
<span id="cb155-381"><a href="raster_watershed.html#cb155-381" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb155-382"><a href="raster_watershed.html#cb155-382" tabindex="-1"></a>    <span class="fu">return</span>(return_dta)</span>
<span id="cb155-383"><a href="raster_watershed.html#cb155-383" tabindex="-1"></a>}</span>
<span id="cb155-384"><a href="raster_watershed.html#cb155-384" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb155-385"><a href="raster_watershed.html#cb155-385" tabindex="-1"></a><span class="co"># intermediat functions</span></span>
<span id="cb155-386"><a href="raster_watershed.html#cb155-386" tabindex="-1"></a><span class="do">#################################################</span></span>
<span id="cb155-387"><a href="raster_watershed.html#cb155-387" tabindex="-1"></a><span class="co"># rounds to nearest odd since ws for terra::focal() only takes odd</span></span>
<span id="cb155-388"><a href="raster_watershed.html#cb155-388" tabindex="-1"></a>round_to_nearest_odd <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb155-389"><a href="raster_watershed.html#cb155-389" tabindex="-1"></a>  rounded_int <span class="ot">&lt;-</span> <span class="fu">round</span>(x)</span>
<span id="cb155-390"><a href="raster_watershed.html#cb155-390" tabindex="-1"></a></span>
<span id="cb155-391"><a href="raster_watershed.html#cb155-391" tabindex="-1"></a>  <span class="co"># step 2: check if the rounded integer is already odd</span></span>
<span id="cb155-392"><a href="raster_watershed.html#cb155-392" tabindex="-1"></a>  is_odd <span class="ot">&lt;-</span> (rounded_int <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb155-393"><a href="raster_watershed.html#cb155-393" tabindex="-1"></a></span>
<span id="cb155-394"><a href="raster_watershed.html#cb155-394" tabindex="-1"></a>  <span class="co"># step 3: for numbers that rounded to an even integer, find the nearest odd</span></span>
<span id="cb155-395"><a href="raster_watershed.html#cb155-395" tabindex="-1"></a>  odd_down <span class="ot">&lt;-</span> rounded_int <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb155-396"><a href="raster_watershed.html#cb155-396" tabindex="-1"></a>  odd_up <span class="ot">&lt;-</span> rounded_int <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb155-397"><a href="raster_watershed.html#cb155-397" tabindex="-1"></a></span>
<span id="cb155-398"><a href="raster_watershed.html#cb155-398" tabindex="-1"></a>  <span class="co"># calculate the absolute distances from the original number &#39;x&#39;</span></span>
<span id="cb155-399"><a href="raster_watershed.html#cb155-399" tabindex="-1"></a>  dist_down <span class="ot">&lt;-</span> <span class="fu">abs</span>(x <span class="sc">-</span> odd_down)</span>
<span id="cb155-400"><a href="raster_watershed.html#cb155-400" tabindex="-1"></a>  dist_up <span class="ot">&lt;-</span> <span class="fu">abs</span>(x <span class="sc">-</span> odd_up)</span>
<span id="cb155-401"><a href="raster_watershed.html#cb155-401" tabindex="-1"></a></span>
<span id="cb155-402"><a href="raster_watershed.html#cb155-402" tabindex="-1"></a>  <span class="co"># step 4: use ifelse for vectorized conditional logic</span></span>
<span id="cb155-403"><a href="raster_watershed.html#cb155-403" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb155-404"><a href="raster_watershed.html#cb155-404" tabindex="-1"></a>    is_odd</span>
<span id="cb155-405"><a href="raster_watershed.html#cb155-405" tabindex="-1"></a>    , rounded_int <span class="co"># if the initially rounded integer is odd, use it</span></span>
<span id="cb155-406"><a href="raster_watershed.html#cb155-406" tabindex="-1"></a>    , <span class="fu">ifelse</span>(</span>
<span id="cb155-407"><a href="raster_watershed.html#cb155-407" tabindex="-1"></a>      dist_down <span class="sc">&lt;</span> dist_up</span>
<span id="cb155-408"><a href="raster_watershed.html#cb155-408" tabindex="-1"></a>      , odd_down <span class="co"># if odd_down is strictly closer</span></span>
<span id="cb155-409"><a href="raster_watershed.html#cb155-409" tabindex="-1"></a>      , odd_up <span class="co"># if odd_up is closer or equidistant</span></span>
<span id="cb155-410"><a href="raster_watershed.html#cb155-410" tabindex="-1"></a>    )</span>
<span id="cb155-411"><a href="raster_watershed.html#cb155-411" tabindex="-1"></a>  )</span>
<span id="cb155-412"><a href="raster_watershed.html#cb155-412" tabindex="-1"></a></span>
<span id="cb155-413"><a href="raster_watershed.html#cb155-413" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb155-414"><a href="raster_watershed.html#cb155-414" tabindex="-1"></a>}</span>
<span id="cb155-415"><a href="raster_watershed.html#cb155-415" tabindex="-1"></a><span class="co"># round_to_nearest_odd(c(2,2.2,1.5,0))</span></span>
<span id="cb155-416"><a href="raster_watershed.html#cb155-416" tabindex="-1"></a></span>
<span id="cb155-417"><a href="raster_watershed.html#cb155-417" tabindex="-1"></a><span class="co"># find window size given res and min expected area</span></span>
<span id="cb155-418"><a href="raster_watershed.html#cb155-418" tabindex="-1"></a>ws_for_smooth_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(chm_res,min_area_m2){</span>
<span id="cb155-419"><a href="raster_watershed.html#cb155-419" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(min_area_m2)<span class="sc">&gt;</span><span class="dv">1</span>){<span class="fu">stop</span>(<span class="st">&quot;min_area_m2 must be a single numeric value&quot;</span>)}</span>
<span id="cb155-420"><a href="raster_watershed.html#cb155-420" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb155-421"><a href="raster_watershed.html#cb155-421" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">case_when</span>( </span>
<span id="cb155-422"><a href="raster_watershed.html#cb155-422" tabindex="-1"></a>    T <span class="sc">~</span> <span class="dv">0</span> <span class="do">## all will be 0 so smoothing won&#39;t happen</span></span>
<span id="cb155-423"><a href="raster_watershed.html#cb155-423" tabindex="-1"></a>    <span class="do">###!!!!!! original attempt down here...just remove T ~ 0 !!!!!!</span><span class="al">###</span></span>
<span id="cb155-424"><a href="raster_watershed.html#cb155-424" tabindex="-1"></a>    , (chm_res<span class="sc">*</span><span class="dv">3</span>) <span class="sc">&gt;</span> (min_area_m2<span class="sc">/</span><span class="dv">2</span>) <span class="sc">~</span> <span class="dv">0</span> <span class="co"># the minimum ws of 3 exceeds half of the expected area (coarse)</span></span>
<span id="cb155-425"><a href="raster_watershed.html#cb155-425" tabindex="-1"></a>    , T <span class="sc">~</span> <span class="fu">round</span>( (min_area_m2<span class="sc">/</span><span class="dv">4</span>) <span class="sc">/</span> chm_res ) <span class="sc">%&gt;%</span> <span class="fu">round_to_nearest_odd</span>() <span class="sc">%&gt;%</span> <span class="fu">max</span>(<span class="dv">3</span>) <span class="co"># has to be odd and at least 3</span></span>
<span id="cb155-426"><a href="raster_watershed.html#cb155-426" tabindex="-1"></a>  )</span>
<span id="cb155-427"><a href="raster_watershed.html#cb155-427" tabindex="-1"></a>}</span>
<span id="cb155-428"><a href="raster_watershed.html#cb155-428" tabindex="-1"></a><span class="co"># dplyr::tibble(res = seq(0.01,0.5,by=0.01)) %&gt;% </span></span>
<span id="cb155-429"><a href="raster_watershed.html#cb155-429" tabindex="-1"></a><span class="co">#   dplyr::rowwise() %&gt;% </span></span>
<span id="cb155-430"><a href="raster_watershed.html#cb155-430" tabindex="-1"></a><span class="co">#   dplyr::mutate(</span></span>
<span id="cb155-431"><a href="raster_watershed.html#cb155-431" tabindex="-1"></a><span class="co">#     ws = ws_for_smooth_fn(res, 2) # min_area_m2=2</span></span>
<span id="cb155-432"><a href="raster_watershed.html#cb155-432" tabindex="-1"></a><span class="co">#     , area = ifelse(ws==0, res*res,</span></span>
<span id="cb155-433"><a href="raster_watershed.html#cb155-433" tabindex="-1"></a><span class="co">#       (res^2) * (ws^2))</span></span>
<span id="cb155-434"><a href="raster_watershed.html#cb155-434" tabindex="-1"></a><span class="co">#     , area_prop = area/2 # min_area_m2=2</span></span>
<span id="cb155-435"><a href="raster_watershed.html#cb155-435" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb155-436"><a href="raster_watershed.html#cb155-436" tabindex="-1"></a><span class="co"># ggplot() +</span></span>
<span id="cb155-437"><a href="raster_watershed.html#cb155-437" tabindex="-1"></a><span class="co">#   # geom_line(aes(x=res,y=ws)) +</span></span>
<span id="cb155-438"><a href="raster_watershed.html#cb155-438" tabindex="-1"></a><span class="co">#   # geom_line(aes(x=res,y=area)) +</span></span>
<span id="cb155-439"><a href="raster_watershed.html#cb155-439" tabindex="-1"></a><span class="co">#   geom_line(aes(x=res,y=area_prop)) +</span></span>
<span id="cb155-440"><a href="raster_watershed.html#cb155-440" tabindex="-1"></a><span class="co">#   # scale_y_continuous(breaks = scales::breaks_extended(n=22)) +</span></span>
<span id="cb155-441"><a href="raster_watershed.html#cb155-441" tabindex="-1"></a><span class="co">#   scale_y_continuous(breaks = scales::breaks_extended(n=22), labels = scales::percent) +</span></span>
<span id="cb155-442"><a href="raster_watershed.html#cb155-442" tabindex="-1"></a><span class="co">#   scale_x_continuous(breaks = scales::breaks_extended(n=20))</span></span></code></pre></div>
<p>let’s test this real quick on our example area</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="raster_watershed.html#cb156-1" tabindex="-1"></a><span class="co"># terra::plot(example_aoi_chm, axes = F, legend = F)</span></span>
<span id="cb156-2"><a href="raster_watershed.html#cb156-2" tabindex="-1"></a><span class="co"># terra::plot(</span></span>
<span id="cb156-3"><a href="raster_watershed.html#cb156-3" tabindex="-1"></a><span class="co">#   example_aoi %&gt;% sf::st_transform(sf::st_crs(example_aoi_chm)) %&gt;% terra::vect()</span></span>
<span id="cb156-4"><a href="raster_watershed.html#cb156-4" tabindex="-1"></a><span class="co">#   , add = T, border = &quot;black&quot;, col = NA, lwd = 1.2</span></span>
<span id="cb156-5"><a href="raster_watershed.html#cb156-5" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb156-6"><a href="raster_watershed.html#cb156-6" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="ot">&lt;-</span> <span class="fu">slash_pile_detect_watershed</span>(</span>
<span id="cb156-7"><a href="raster_watershed.html#cb156-7" tabindex="-1"></a>  <span class="at">chm_rast =</span> example_aoi_chm</span>
<span id="cb156-8"><a href="raster_watershed.html#cb156-8" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="fl">4.5</span></span>
<span id="cb156-9"><a href="raster_watershed.html#cb156-9" tabindex="-1"></a>  , <span class="at">min_ht_m =</span> <span class="fl">0.5</span></span>
<span id="cb156-10"><a href="raster_watershed.html#cb156-10" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="dv">2</span></span>
<span id="cb156-11"><a href="raster_watershed.html#cb156-11" tabindex="-1"></a>  , <span class="at">max_area_m2 =</span> <span class="dv">50</span></span>
<span id="cb156-12"><a href="raster_watershed.html#cb156-12" tabindex="-1"></a>  , <span class="at">convexity_pct =</span> <span class="fl">0.8</span></span>
<span id="cb156-13"><a href="raster_watershed.html#cb156-13" tabindex="-1"></a>  , <span class="at">circle_fit_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb156-14"><a href="raster_watershed.html#cb156-14" tabindex="-1"></a>)</span>
<span id="cb156-15"><a href="raster_watershed.html#cb156-15" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb156-16"><a href="raster_watershed.html#cb156-16" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 34
## Columns: 8
## $ pred_id         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…
## $ area_m2         &lt;dbl&gt; 4.12, 4.84, 8.28, 9.12, 8.76, 9.06, 7.64, 10.70, 8.42,…
## $ volume_m3       &lt;dbl&gt; 3.436257, 3.979143, 9.554492, 9.208540, 10.130051, 9.7…
## $ max_height_m    &lt;dbl&gt; 4.460059, 4.264971, 2.684000, 2.520000, 2.418000, 2.36…
## $ volume_per_area &lt;dbl&gt; 0.8340429, 0.8221369, 1.1539241, 1.0097083, 1.1563985,…
## $ pct_chull       &lt;dbl&gt; 0.8349515, 0.8429752, 0.9178744, 0.9122807, 0.9223744,…
## $ geometry        &lt;POLYGON [m]&gt; POLYGON ((499484 4317759, 4..., POLYGON ((4995…
## $ diameter_m      &lt;dbl&gt; 3.162278, 3.052868, 3.605551, 3.720215, 3.544009, 3.72…</code></pre>
<p>how does it look overlaid on the CHM?</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="raster_watershed.html#cb158-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(example_aoi_chm, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span>
<span id="cb158-2"><a href="raster_watershed.html#cb158-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>(),<span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-143-1.png" width="1008" /></p>
<p>how do the form quantification measurements look?</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="raster_watershed.html#cb159-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb159-2"><a href="raster_watershed.html#cb159-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb159-3"><a href="raster_watershed.html#cb159-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> area_m2)) <span class="sc">+</span></span>
<span id="cb159-4"><a href="raster_watershed.html#cb159-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Blues&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb159-5"><a href="raster_watershed.html#cb159-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-6"><a href="raster_watershed.html#cb159-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb159-7"><a href="raster_watershed.html#cb159-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb159-8"><a href="raster_watershed.html#cb159-8" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb159-9"><a href="raster_watershed.html#cb159-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb159-10"><a href="raster_watershed.html#cb159-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> volume_m3)) <span class="sc">+</span></span>
<span id="cb159-11"><a href="raster_watershed.html#cb159-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;BuGn&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb159-12"><a href="raster_watershed.html#cb159-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-13"><a href="raster_watershed.html#cb159-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb159-14"><a href="raster_watershed.html#cb159-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb159-15"><a href="raster_watershed.html#cb159-15" tabindex="-1"></a>p3_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb159-16"><a href="raster_watershed.html#cb159-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb159-17"><a href="raster_watershed.html#cb159-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> max_height_m)) <span class="sc">+</span></span>
<span id="cb159-18"><a href="raster_watershed.html#cb159-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;YlOrBr&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb159-19"><a href="raster_watershed.html#cb159-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-20"><a href="raster_watershed.html#cb159-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb159-21"><a href="raster_watershed.html#cb159-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb159-22"><a href="raster_watershed.html#cb159-22" tabindex="-1"></a>p4_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb159-23"><a href="raster_watershed.html#cb159-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb159-24"><a href="raster_watershed.html#cb159-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> diameter_m)) <span class="sc">+</span></span>
<span id="cb159-25"><a href="raster_watershed.html#cb159-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;PuRd&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb159-26"><a href="raster_watershed.html#cb159-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb159-27"><a href="raster_watershed.html#cb159-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb159-28"><a href="raster_watershed.html#cb159-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb159-29"><a href="raster_watershed.html#cb159-29" tabindex="-1"></a>(p1_temp <span class="sc">+</span> p2_temp) <span class="sc">/</span> (p3_temp <span class="sc">+</span> p4_temp)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-144-1.png" width="1008" /></p>
<p>the volume per area ratio (<code>volume_per_area</code>) quantifies the “effective” height or depth of that volume relative to the area it occupies; this ratio may not be very useful for anything other than scaling estimates to relate a three-dimensional quantity (volume) to a two-dimensional quantity (area)</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ptcld_process.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data_fusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
