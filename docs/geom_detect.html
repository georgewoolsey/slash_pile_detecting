<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 4 Geometry-based Slash Pile Detection | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 4 Geometry-based Slash Pile Detection | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 4 Geometry-based Slash Pile Detection | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ptcld_process.html"/>
<link rel="next" href="data_fusion.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.9/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<link href="libs/study sites-CSS-0.0.1/study sites_home-button.css" rel="stylesheet" />
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data and Site Descriptions</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#silvicultural-prescriptions"><i class="fa fa-check"></i><b>1.2.1</b> Silvicultural Prescriptions</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#analysis-plan"><i class="fa fa-check"></i><b>1.3</b> Analysis Plan</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data_load.html"><a href="data_load.html"><i class="fa fa-check"></i><b>2</b> Data Overview</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data_load.html"><a href="data_load.html#study-units-vector-data"><i class="fa fa-check"></i><b>2.1</b> Study Units Vector Data</a></li>
<li class="chapter" data-level="2.2" data-path="data_load.html"><a href="data_load.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.2</b> Slash Pile Vector Data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data_load.html"><a href="data_load.html#standardize-pile-data"><i class="fa fa-check"></i><b>2.2.1</b> Standardize Pile Data</a></li>
<li class="chapter" data-level="2.2.2" data-path="data_load.html"><a href="data_load.html#pile-form-measurements"><i class="fa fa-check"></i><b>2.2.2</b> Pile Form Measurements</a></li>
<li class="chapter" data-level="2.2.3" data-path="data_load.html"><a href="data_load.html#image-annotation-comparison"><i class="fa fa-check"></i><b>2.2.3</b> Image-Annotation Comparison</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data_load.html"><a href="data_load.html#rgb-orthomosaic"><i class="fa fa-check"></i><b>2.3</b> RGB orthomosaic</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="data_load.html"><a href="data_load.html#psinf-mixed-conifer-site-1"><i class="fa fa-check"></i><b>2.3.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="2.3.2" data-path="data_load.html"><a href="data_load.html#trfo-blm-pinyon-juniper-site-1"><i class="fa fa-check"></i><b>2.3.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="2.3.3" data-path="data_load.html"><a href="data_load.html#bhef-ponderosa-pine-site-1"><i class="fa fa-check"></i><b>2.3.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="2.3.4" data-path="data_load.html"><a href="data_load.html#arnf-ponderosa-pine-site-1"><i class="fa fa-check"></i><b>2.3.4</b> ARNF Ponderosa Pine Site</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="data_load.html"><a href="data_load.html#slash-pile-rgb-imagery"><i class="fa fa-check"></i><b>2.4</b> Slash Pile RGB Imagery</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="data_load.html"><a href="data_load.html#psinf-mixed-conifer-site-2"><i class="fa fa-check"></i><b>2.4.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="2.4.2" data-path="data_load.html"><a href="data_load.html#trfo-blm-pinyon-juniper-site-2"><i class="fa fa-check"></i><b>2.4.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="2.4.3" data-path="data_load.html"><a href="data_load.html#bhef-ponderosa-pine-site-2"><i class="fa fa-check"></i><b>2.4.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="2.4.4" data-path="data_load.html"><a href="data_load.html#arnf-ponderosa-pine-site-2"><i class="fa fa-check"></i><b>2.4.4</b> ARNF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="2.4.5" data-path="data_load.html"><a href="data_load.html#all"><i class="fa fa-check"></i><b>2.4.5</b> All</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ptcld_process.html"><a href="ptcld_process.html"><i class="fa fa-check"></i><b>3</b> Point Cloud Processing</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ptcld_process.html"><a href="ptcld_process.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>3.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="ptcld_process.html"><a href="ptcld_process.html#ptcld_process_psinf"><i class="fa fa-check"></i><b>3.1.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="3.1.2" data-path="ptcld_process.html"><a href="ptcld_process.html#trfo-blm-pinyon-juniper-site-3"><i class="fa fa-check"></i><b>3.1.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="3.1.3" data-path="ptcld_process.html"><a href="ptcld_process.html#bhef-ponderosa-pine-site-3"><i class="fa fa-check"></i><b>3.1.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="3.1.4" data-path="ptcld_process.html"><a href="ptcld_process.html#arnf-ponderosa-pine-site-3"><i class="fa fa-check"></i><b>3.1.4</b> ARNF Ponderosa Pine Site</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="ptcld_process.html"><a href="ptcld_process.html#clean-up"><i class="fa fa-check"></i><b>3.2</b> Clean Up</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geom_detect.html"><a href="geom_detect.html"><i class="fa fa-check"></i><b>4</b> Geometry-based Slash Pile Detection</a>
<ul>
<li class="chapter" data-level="4.1" data-path="geom_detect.html"><a href="geom_detect.html#d_area"><i class="fa fa-check"></i><b>4.1</b> Demonstration Area</a></li>
<li class="chapter" data-level="4.2" data-path="geom_detect.html"><a href="geom_detect.html#segmentation-methods"><i class="fa fa-check"></i><b>4.2</b> Segmentation Methods</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="geom_detect.html"><a href="geom_detect.html#seg_methods"><i class="fa fa-check"></i><b>4.2.1</b> Overview of Methods</a></li>
<li class="chapter" data-level="4.2.2" data-path="geom_detect.html"><a href="geom_detect.html#watershed-segmentation-demonstration"><i class="fa fa-check"></i><b>4.2.2</b> Watershed Segmentation Demonstration</a></li>
<li class="chapter" data-level="4.2.3" data-path="geom_detect.html"><a href="geom_detect.html#dbscan-segmentation-demonstration"><i class="fa fa-check"></i><b>4.2.3</b> DBSCAN Segmentation Demonstration</a></li>
<li class="chapter" data-level="4.2.4" data-path="geom_detect.html"><a href="geom_detect.html#comparison-of-candidate-segments"><i class="fa fa-check"></i><b>4.2.4</b> Comparison of Candidate Segments</a></li>
<li class="chapter" data-level="4.2.5" data-path="geom_detect.html"><a href="geom_detect.html#segmentation-function"><i class="fa fa-check"></i><b>4.2.5</b> Segmentation Function</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="geom_detect.html"><a href="geom_detect.html#candidate-shape-refinement-and-area-filtering"><i class="fa fa-check"></i><b>4.3</b> Candidate Shape Refinement and Area filtering</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="geom_detect.html"><a href="geom_detect.html#watershed-segmentation"><i class="fa fa-check"></i><b>4.3.1</b> Watershed Segmentation</a></li>
<li class="chapter" data-level="4.3.2" data-path="geom_detect.html"><a href="geom_detect.html#dbscan-segmentation"><i class="fa fa-check"></i><b>4.3.2</b> DBSCAN Segmentation</a></li>
<li class="chapter" data-level="4.3.3" data-path="geom_detect.html"><a href="geom_detect.html#quick-methods-comparison"><i class="fa fa-check"></i><b>4.3.3</b> Quick methods comparison</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="geom_detect.html"><a href="geom_detect.html#candidate-geometric-filtering"><i class="fa fa-check"></i><b>4.4</b> Candidate Geometric filtering</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="geom_detect.html"><a href="geom_detect.html#shape-irregularity-convexity"><i class="fa fa-check"></i><b>4.4.1</b> Shape Irregularity: Convexity</a></li>
<li class="chapter" data-level="4.4.2" data-path="geom_detect.html"><a href="geom_detect.html#shape-irregularity-circularity"><i class="fa fa-check"></i><b>4.4.2</b> Shape Irregularity: Circularity</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="geom_detect.html"><a href="geom_detect.html#structural-metrics-from-chm"><i class="fa fa-check"></i><b>4.5</b> Structural Metrics from CHM</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="geom_detect.html"><a href="geom_detect.html#structural-rasters"><i class="fa fa-check"></i><b>4.5.1</b> Structural Rasters</a></li>
<li class="chapter" data-level="4.5.2" data-path="geom_detect.html"><a href="geom_detect.html#demonstration-candidate-segment-metrics"><i class="fa fa-check"></i><b>4.5.2</b> Demonstration Candidate Segment Metrics</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="geom_detect.html"><a href="geom_detect.html#final-shape-refinement"><i class="fa fa-check"></i><b>4.6</b> Final Shape Refinement</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="geom_detect.html"><a href="geom_detect.html#watershed-segmentation-3"><i class="fa fa-check"></i><b>4.6.1</b> Watershed Segmentation</a></li>
<li class="chapter" data-level="4.6.2" data-path="geom_detect.html"><a href="geom_detect.html#dbscan-segmentation-3"><i class="fa fa-check"></i><b>4.6.2</b> DBSCAN Segmentation</a></li>
<li class="chapter" data-level="4.6.3" data-path="geom_detect.html"><a href="geom_detect.html#quick-methods-comparison-2"><i class="fa fa-check"></i><b>4.6.3</b> Quick methods comparison</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="geom_detect.html"><a href="geom_detect.html#slash_pile_detect_fn"><i class="fa fa-check"></i><b>4.7</b> Pile Detection Function</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data_fusion.html"><a href="data_fusion.html"><i class="fa fa-check"></i><b>5</b> Data Fusion</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data_fusion.html"><a href="data_fusion.html#rgb-indices"><i class="fa fa-check"></i><b>5.1</b> RGB Indices</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-functions"><i class="fa fa-check"></i><b>5.1.1</b> Spectral Index Functions</a></li>
<li class="chapter" data-level="5.1.2" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-of-polygons"><i class="fa fa-check"></i><b>5.1.2</b> Spectral Index of Polygons</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data_fusion.html"><a href="data_fusion.html#demonstration-pile-spectral-summary"><i class="fa fa-check"></i><b>5.2</b> Demonstration Pile Spectral Summary</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="data_fusion.html"><a href="data_fusion.html#voting-system"><i class="fa fa-check"></i><b>5.2.1</b> Voting System</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="data_fusion.html"><a href="data_fusion.html#polygon_spectral_filtering"><i class="fa fa-check"></i><b>5.3</b> Candidate Polygon Spectral Filtering Function</a></li>
<li class="chapter" data-level="5.4" data-path="data_fusion.html"><a href="data_fusion.html#data-fusion-method-demonstration"><i class="fa fa-check"></i><b>5.4</b> Data Fusion Method Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="meth_eval.html"><a href="meth_eval.html"><i class="fa fa-check"></i><b>6</b> Method Evaluation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="meth_eval.html"><a href="meth_eval.html#iou_match"><i class="fa fa-check"></i><b>6.1</b> Instance Matching</a></li>
<li class="chapter" data-level="6.2" data-path="meth_eval.html"><a href="meth_eval.html#detect_metrics_form"><i class="fa fa-check"></i><b>6.2</b> Detection Accuracy Metrics</a></li>
<li class="chapter" data-level="6.3" data-path="meth_eval.html"><a href="meth_eval.html#quant_metrics_form"><i class="fa fa-check"></i><b>6.3</b> Quantification Accuracy Metrics</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="meth_preds.html"><a href="meth_preds.html"><i class="fa fa-check"></i><b>7</b> Method Predictions</a>
<ul>
<li class="chapter" data-level="7.1" data-path="meth_preds.html"><a href="meth_preds.html#size-and-geometric-parameter-settings"><i class="fa fa-check"></i><b>7.1</b> Size and Geometric Parameter Settings</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="meth_preds.html"><a href="meth_preds.html#psinf-mixed-conifer-site-3"><i class="fa fa-check"></i><b>7.1.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="7.1.2" data-path="meth_preds.html"><a href="meth_preds.html#trfo-blm-pinyon-juniper-site-4"><i class="fa fa-check"></i><b>7.1.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="7.1.3" data-path="meth_preds.html"><a href="meth_preds.html#bhef-ponderosa-pine-site-4"><i class="fa fa-check"></i><b>7.1.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="7.1.4" data-path="meth_preds.html"><a href="meth_preds.html#arnf-ponderosa-pine-site-4"><i class="fa fa-check"></i><b>7.1.4</b> ARNF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="7.1.5" data-path="meth_preds.html"><a href="meth_preds.html#study-paremeter-settings"><i class="fa fa-check"></i><b>7.1.5</b> Study Paremeter Settings</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="meth_preds.html"><a href="meth_preds.html#chm-based-slash-pile-candidates"><i class="fa fa-check"></i><b>7.2</b> CHM-based Slash Pile Candidates</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="meth_preds.html"><a href="meth_preds.html#dbscan-candidates"><i class="fa fa-check"></i><b>7.2.1</b> DBSCAN Candidates</a></li>
<li class="chapter" data-level="7.2.2" data-path="meth_preds.html"><a href="meth_preds.html#watershed-candidates"><i class="fa fa-check"></i><b>7.2.2</b> Watershed Candidates</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="meth_preds.html"><a href="meth_preds.html#spectral-filter-slash-pile-candidates"><i class="fa fa-check"></i><b>7.3</b> Spectral Filter Slash Pile Candidates</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="meth_preds.html"><a href="meth_preds.html#dbscan-predictions"><i class="fa fa-check"></i><b>7.3.1</b> DBSCAN Predictions</a></li>
<li class="chapter" data-level="7.3.2" data-path="meth_preds.html"><a href="meth_preds.html#watershed-predictions"><i class="fa fa-check"></i><b>7.3.2</b> Watershed Predictions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="preds_detect.html"><a href="preds_detect.html"><i class="fa fa-check"></i><b>8</b> Detection Accuracy</a>
<ul>
<li class="chapter" data-level="8.1" data-path="preds_detect.html"><a href="preds_detect.html#instance-matching"><i class="fa fa-check"></i><b>8.1</b> Instance Matching</a></li>
<li class="chapter" data-level="8.2" data-path="preds_detect.html"><a href="preds_detect.html#detection-accuracy-metrics"><i class="fa fa-check"></i><b>8.2</b> Detection Accuracy Metrics</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="preds_detect.html"><a href="preds_detect.html#agg_inst_match"><i class="fa fa-check"></i><b>8.2.1</b> Aggregate Instance Match Results</a></li>
<li class="chapter" data-level="8.2.2" data-path="preds_detect.html"><a href="preds_detect.html#detection-accuracy-results"><i class="fa fa-check"></i><b>8.2.2</b> Detection Accuracy Results</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="preds_detect.html"><a href="preds_detect.html#segmentation-method-accuracy-comparison"><i class="fa fa-check"></i><b>8.3</b> Segmentation Method Accuracy Comparison</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="preds_detect.html"><a href="preds_detect.html#paired-t-test"><i class="fa fa-check"></i><b>8.3.1</b> Paired T-Test</a></li>
<li class="chapter" data-level="8.3.2" data-path="preds_detect.html"><a href="preds_detect.html#bayesian-approach"><i class="fa fa-check"></i><b>8.3.2</b> Bayesian Approach</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="preds_detect.html"><a href="preds_detect.html#individual-pile-evaluation"><i class="fa fa-check"></i><b>8.4</b> Individual Pile Evaluation</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="preds_detect.html"><a href="preds_detect.html#true-positives"><i class="fa fa-check"></i><b>8.4.1</b> True Positives</a></li>
<li class="chapter" data-level="8.4.2" data-path="preds_detect.html"><a href="preds_detect.html#omissions-false-negatives"><i class="fa fa-check"></i><b>8.4.2</b> Omissions (False Negatives)</a></li>
<li class="chapter" data-level="8.4.3" data-path="preds_detect.html"><a href="preds_detect.html#commissions-false-positives"><i class="fa fa-check"></i><b>8.4.3</b> commissions (False Positives)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="preds_quantit.html"><a href="preds_quantit.html"><i class="fa fa-check"></i><b>9</b> Quantification Accuracy</a>
<ul>
<li class="chapter" data-level="9.1" data-path="preds_quantit.html"><a href="preds_quantit.html#height-and-diameter-accuracy"><i class="fa fa-check"></i><b>9.1</b> Height and Diameter Accuracy</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="preds_quantit.html"><a href="preds_quantit.html#stand-level-aggregation"><i class="fa fa-check"></i><b>9.1.1</b> Stand-level Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="preds_quantit.html"><a href="preds_quantit.html#area-accuracy"><i class="fa fa-check"></i><b>9.2</b> Area Accuracy</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="preds_quantit.html"><a href="preds_quantit.html#stand-level-aggregation-1"><i class="fa fa-check"></i><b>9.2.1</b> Stand-level Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="preds_quantit.html"><a href="preds_quantit.html#vol_comp"><i class="fa fa-check"></i><b>9.3</b> Volume Comparison</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="preds_quantit.html"><a href="preds_quantit.html#extreme-volume-disagreements"><i class="fa fa-check"></i><b>9.3.1</b> Extreme Volume Disagreements</a></li>
<li class="chapter" data-level="9.3.2" data-path="preds_quantit.html"><a href="preds_quantit.html#allometric-volume-comparison"><i class="fa fa-check"></i><b>9.3.2</b> Allometric Volume Comparison</a></li>
<li class="chapter" data-level="9.3.3" data-path="preds_quantit.html"><a href="preds_quantit.html#stand-level-aggregation-2"><i class="fa fa-check"></i><b>9.3.3</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="geom_detect" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Section 4</span> Geometry-based Slash Pile Detection<a href="geom_detect.html#geom_detect" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this section, we will demonstrate the geometry-based slash pile detection method which relies upon user-defined thresholds applied to geometric features from a Canopy Height Model (CHM) derived from UAS-DAP point cloud data. Since this is only a demonstration of the method, we will work with only a sample area from one of the study sites which we know includes slash piles. Full evaluation of the methodology will be performed later in the analysis.</p>
<p>We’ll attempt to detect slash piles using raster-based methods with the CHM. These raster-based approaches are simple and efficient but rasterization simplifies/removes some of the rich 3D information in the point cloud. However, raster-based approaches for detecting individual trees in forest stands and coarse woody debris are common.</p>
<p>Here is a section from the draft manuscript:</p>
<blockquote>
<p>These geometry-based approaches are supported by the demonstrated successes of object segmentation frameworks for both CWD and individual trees, which consistently provide high detection and quantification accuracy by utilizing rules to define expected target object morphology. Beyond their technical performance, the geometry-based methods utilizing a set of rules offer some key advantages. The inherent traceability of these methods ensures that reporting for regulatory oversight is more transparent and easier to describe compared to the “black box” nature of many model-based approaches. Geometry-based frameworks also do not rely on training datasets and can directly align with the explicit pile construction parameters which are generally known by land managers through silvicultural prescriptions. To address the current lack of automated methods for simultaneously detecting and quantifying slash piles from aerial remote sensing data, our objective in this work is to present a geometry-based approach that uses rules and user-defined thresholds applied to geometric features (such as area, shape, and height) to identify and quantify slash piles from UAS-DAP point cloud data.</p>
</blockquote>
<p>Geometric, rules-based object detection methods offer advantages over model-based approaches, primarily because they eliminate the need for extensive training data which might be limited in it’s transferability to unseen conditions. Models are often considered “black boxes” but rules-based methods rely on the inherent physical properties of the target objects themselves. This transparency allows for a high degree of interpretability as every segmentation result can be traced back to specific geometric constraints. Furthermore, this approach aligns perfectly with the expertise of land managers, as the input parameters like minimum height and area thresholds are the physical metrics commonly used in forest inventories and silvicultural prescriptions. By using these intuitive thresholds, the method becomes accessible to managers who possess a good understanding of the landscape they manage.</p>
<p>To attempt to identify slash piles from the CHM/DSM, we can use watershed segmentation or DBSCAN (Density-Based Spatial Clustering of Applications with Noise). Both of these methods are common in segmenting individual trees and coarse woody debris from CHM data.</p>
<div id="d_area" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Demonstration Area<a href="geom_detect.html#d_area" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>we’ll focus on an example area that is outside of the study unit boundary but was captured in our UAS data acquisition of the area. This demonstration area also included slash piles which were annotated in the same manner as previously described but did not have height and diameter measurements taken in the field.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="geom_detect.html#cb85-1" tabindex="-1"></a><span class="co"># boundary</span></span>
<span id="cb85-2"><a href="geom_detect.html#cb85-2" tabindex="-1"></a>aoi_boundary <span class="ot">&lt;-</span> </span>
<span id="cb85-3"><a href="geom_detect.html#cb85-3" tabindex="-1"></a>  psinf_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb85-4"><a href="geom_detect.html#cb85-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb85-5"><a href="geom_detect.html#cb85-5" tabindex="-1"></a>    <span class="sc">!</span>is_in_stand</span>
<span id="cb85-6"><a href="geom_detect.html#cb85-6" tabindex="-1"></a>    <span class="sc">&amp;</span> pile_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">53</span>,<span class="dv">52</span>,<span class="dv">63</span>,<span class="dv">20</span>,<span class="dv">17</span>,<span class="dv">11</span>,<span class="dv">6</span>,<span class="dv">75</span>)</span>
<span id="cb85-7"><a href="geom_detect.html#cb85-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb85-8"><a href="geom_detect.html#cb85-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-9"><a href="geom_detect.html#cb85-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-10"><a href="geom_detect.html#cb85-10" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-11"><a href="geom_detect.html#cb85-11" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">1.3</span>, <span class="at">joinStyle =</span> <span class="st">&quot;MITRE&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-12"><a href="geom_detect.html#cb85-12" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-13"><a href="geom_detect.html#cb85-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dummy=</span><span class="dv">1</span>)</span></code></pre></div>
<p>we cropped this section from our original RGB processing, so we’ll get it now</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="geom_detect.html#cb86-1" tabindex="-1"></a>dir_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/PFDP_Data/&quot;</span></span>
<span id="cb86-2"><a href="geom_detect.html#cb86-2" tabindex="-1"></a>rgb_fnm_temp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_temp,<span class="st">&quot;aoi_rgb_rast.tif&quot;</span>) <span class="co"># what should the compiled rgb be called?</span></span>
<span id="cb86-3"><a href="geom_detect.html#cb86-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(dir_temp)){<span class="fu">dir.create</span>(dir_temp, <span class="at">showWarnings =</span> F)}</span>
<span id="cb86-4"><a href="geom_detect.html#cb86-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(rgb_fnm_temp)){</span>
<span id="cb86-5"><a href="geom_detect.html#cb86-5" tabindex="-1"></a>  <span class="do">#### read RGB data keep only RGB</span></span>
<span id="cb86-6"><a href="geom_detect.html#cb86-6" tabindex="-1"></a>    aoi_rgb_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(</span>
<span id="cb86-7"><a href="geom_detect.html#cb86-7" tabindex="-1"></a>        <span class="fu">file.path</span>(</span>
<span id="cb86-8"><a href="geom_detect.html#cb86-8" tabindex="-1"></a>          <span class="st">&quot;f:</span><span class="sc">\\</span><span class="st">PFDP_Data</span><span class="sc">\\</span><span class="st">p4pro_images</span><span class="sc">\\</span><span class="st">P4Pro_06_17_2021_half_half_optimal</span><span class="sc">\\</span><span class="st">3_dsm_ortho</span><span class="sc">\\</span><span class="st">2_mosaic&quot;</span></span>
<span id="cb86-9"><a href="geom_detect.html#cb86-9" tabindex="-1"></a>          , <span class="st">&quot;P4Pro_06_17_2021_half_half_optimal_transparent_mosaic_group1.tif&quot;</span></span>
<span id="cb86-10"><a href="geom_detect.html#cb86-10" tabindex="-1"></a>        )</span>
<span id="cb86-11"><a href="geom_detect.html#cb86-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb86-12"><a href="geom_detect.html#cb86-12" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">subset</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb86-13"><a href="geom_detect.html#cb86-13" tabindex="-1"></a>    <span class="co"># rename bands</span></span>
<span id="cb86-14"><a href="geom_detect.html#cb86-14" tabindex="-1"></a>    <span class="fu">names</span>(aoi_rgb_rast) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;blue&quot;</span>)</span>
<span id="cb86-15"><a href="geom_detect.html#cb86-15" tabindex="-1"></a>  <span class="co"># Crop the raster to the rectangular extent of the polygon</span></span>
<span id="cb86-16"><a href="geom_detect.html#cb86-16" tabindex="-1"></a>  <span class="co"># Specify a filename to ensure the result is written to disk</span></span>
<span id="cb86-17"><a href="geom_detect.html#cb86-17" tabindex="-1"></a>  crop_rgb_rast_temp <span class="ot">&lt;-</span> aoi_rgb_rast <span class="sc">%&gt;%</span> </span>
<span id="cb86-18"><a href="geom_detect.html#cb86-18" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb86-19"><a href="geom_detect.html#cb86-19" tabindex="-1"></a>      aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb86-20"><a href="geom_detect.html#cb86-20" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb86-21"><a href="geom_detect.html#cb86-21" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-22"><a href="geom_detect.html#cb86-22" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-23"><a href="geom_detect.html#cb86-23" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb86-24"><a href="geom_detect.html#cb86-24" tabindex="-1"></a>      , <span class="at">mask =</span> T</span>
<span id="cb86-25"><a href="geom_detect.html#cb86-25" tabindex="-1"></a>      , <span class="at">filename =</span>  <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">&quot;.tif&quot;</span>)</span>
<span id="cb86-26"><a href="geom_detect.html#cb86-26" tabindex="-1"></a>      , <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb86-27"><a href="geom_detect.html#cb86-27" tabindex="-1"></a>    )</span>
<span id="cb86-28"><a href="geom_detect.html#cb86-28" tabindex="-1"></a>  </span>
<span id="cb86-29"><a href="geom_detect.html#cb86-29" tabindex="-1"></a>  <span class="do">## apply the change_res_fn for our analysis we don&#39;t need such finery</span></span>
<span id="cb86-30"><a href="geom_detect.html#cb86-30" tabindex="-1"></a>  <span class="co"># this takes too long...</span></span>
<span id="cb86-31"><a href="geom_detect.html#cb86-31" tabindex="-1"></a>  aoi_rgb_rast <span class="ot">&lt;-</span> <span class="fu">change_res_fn</span>(crop_rgb_rast_temp, <span class="at">my_res=</span>my_rgb_res_m, <span class="at">ofile =</span> rgb_fnm_temp)</span>
<span id="cb86-32"><a href="geom_detect.html#cb86-32" tabindex="-1"></a>  aoi_rgb_rast <span class="ot">&lt;-</span> aoi_rgb_rast <span class="sc">%&gt;%</span> </span>
<span id="cb86-33"><a href="geom_detect.html#cb86-33" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb86-34"><a href="geom_detect.html#cb86-34" tabindex="-1"></a>      aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb86-35"><a href="geom_detect.html#cb86-35" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-36"><a href="geom_detect.html#cb86-36" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-37"><a href="geom_detect.html#cb86-37" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb86-38"><a href="geom_detect.html#cb86-38" tabindex="-1"></a>      , <span class="at">mask =</span> T</span>
<span id="cb86-39"><a href="geom_detect.html#cb86-39" tabindex="-1"></a>    )</span>
<span id="cb86-40"><a href="geom_detect.html#cb86-40" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb86-41"><a href="geom_detect.html#cb86-41" tabindex="-1"></a>  aoi_rgb_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(rgb_fnm_temp)</span>
<span id="cb86-42"><a href="geom_detect.html#cb86-42" tabindex="-1"></a>  aoi_rgb_rast <span class="ot">&lt;-</span> aoi_rgb_rast <span class="sc">%&gt;%</span> </span>
<span id="cb86-43"><a href="geom_detect.html#cb86-43" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb86-44"><a href="geom_detect.html#cb86-44" tabindex="-1"></a>      aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb86-45"><a href="geom_detect.html#cb86-45" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-46"><a href="geom_detect.html#cb86-46" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-47"><a href="geom_detect.html#cb86-47" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb86-48"><a href="geom_detect.html#cb86-48" tabindex="-1"></a>      , <span class="at">mask =</span> T</span>
<span id="cb86-49"><a href="geom_detect.html#cb86-49" tabindex="-1"></a>    )</span>
<span id="cb86-50"><a href="geom_detect.html#cb86-50" tabindex="-1"></a>}</span>
<span id="cb86-51"><a href="geom_detect.html#cb86-51" tabindex="-1"></a><span class="co"># terra::res(aoi_rgb_rast)</span></span>
<span id="cb86-52"><a href="geom_detect.html#cb86-52" tabindex="-1"></a><span class="co"># terra::plotRGB(aoi_rgb_rast, stretch = &quot;lin&quot;)</span></span></code></pre></div>
<p>we cropped this section from our original CHM processing, so we’ll get it now</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="geom_detect.html#cb87-1" tabindex="-1"></a>dir_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/PFDP_Data/&quot;</span></span>
<span id="cb87-2"><a href="geom_detect.html#cb87-2" tabindex="-1"></a>chm_fnm_temp <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_temp,<span class="st">&quot;aoi_chm_rast.tif&quot;</span>) <span class="co"># what should the compiled chm be called?</span></span>
<span id="cb87-3"><a href="geom_detect.html#cb87-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(dir_temp)){<span class="fu">dir.create</span>(dir_temp, <span class="at">showWarnings =</span> F)}</span>
<span id="cb87-4"><a href="geom_detect.html#cb87-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(chm_fnm_temp)){</span>
<span id="cb87-5"><a href="geom_detect.html#cb87-5" tabindex="-1"></a>  <span class="do">#### read CHM</span></span>
<span id="cb87-6"><a href="geom_detect.html#cb87-6" tabindex="-1"></a>    aoi_chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(</span>
<span id="cb87-7"><a href="geom_detect.html#cb87-7" tabindex="-1"></a>        <span class="fu">file.path</span>(</span>
<span id="cb87-8"><a href="geom_detect.html#cb87-8" tabindex="-1"></a>          dir_temp</span>
<span id="cb87-9"><a href="geom_detect.html#cb87-9" tabindex="-1"></a>          , <span class="st">&quot;point_cloud_processing_delivery_chm0.1m&quot;</span></span>
<span id="cb87-10"><a href="geom_detect.html#cb87-10" tabindex="-1"></a>          , <span class="st">&quot;chm_0.1m.tif&quot;</span></span>
<span id="cb87-11"><a href="geom_detect.html#cb87-11" tabindex="-1"></a>        )</span>
<span id="cb87-12"><a href="geom_detect.html#cb87-12" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb87-13"><a href="geom_detect.html#cb87-13" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">1</span>)</span>
<span id="cb87-14"><a href="geom_detect.html#cb87-14" tabindex="-1"></a>  <span class="co"># Crop the raster to the rectangular extent of the polygon</span></span>
<span id="cb87-15"><a href="geom_detect.html#cb87-15" tabindex="-1"></a>  <span class="co"># Specify a filename to ensure the result is written to disk</span></span>
<span id="cb87-16"><a href="geom_detect.html#cb87-16" tabindex="-1"></a>  aoi_chm_rast <span class="ot">&lt;-</span> aoi_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb87-17"><a href="geom_detect.html#cb87-17" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb87-18"><a href="geom_detect.html#cb87-18" tabindex="-1"></a>      aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb87-19"><a href="geom_detect.html#cb87-19" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb87-20"><a href="geom_detect.html#cb87-20" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-21"><a href="geom_detect.html#cb87-21" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb87-22"><a href="geom_detect.html#cb87-22" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb87-23"><a href="geom_detect.html#cb87-23" tabindex="-1"></a>      , <span class="at">mask =</span> T</span>
<span id="cb87-24"><a href="geom_detect.html#cb87-24" tabindex="-1"></a>      , <span class="at">filename =</span> chm_fnm_temp</span>
<span id="cb87-25"><a href="geom_detect.html#cb87-25" tabindex="-1"></a>      , <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb87-26"><a href="geom_detect.html#cb87-26" tabindex="-1"></a>    )</span>
<span id="cb87-27"><a href="geom_detect.html#cb87-27" tabindex="-1"></a>  </span>
<span id="cb87-28"><a href="geom_detect.html#cb87-28" tabindex="-1"></a>  aoi_chm_rast <span class="ot">&lt;-</span> aoi_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb87-29"><a href="geom_detect.html#cb87-29" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb87-30"><a href="geom_detect.html#cb87-30" tabindex="-1"></a>      aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb87-31"><a href="geom_detect.html#cb87-31" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-32"><a href="geom_detect.html#cb87-32" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb87-33"><a href="geom_detect.html#cb87-33" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb87-34"><a href="geom_detect.html#cb87-34" tabindex="-1"></a>      , <span class="at">mask =</span> T</span>
<span id="cb87-35"><a href="geom_detect.html#cb87-35" tabindex="-1"></a>    )</span>
<span id="cb87-36"><a href="geom_detect.html#cb87-36" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb87-37"><a href="geom_detect.html#cb87-37" tabindex="-1"></a>  aoi_chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(chm_fnm_temp)</span>
<span id="cb87-38"><a href="geom_detect.html#cb87-38" tabindex="-1"></a>  aoi_chm_rast <span class="ot">&lt;-</span> aoi_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb87-39"><a href="geom_detect.html#cb87-39" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb87-40"><a href="geom_detect.html#cb87-40" tabindex="-1"></a>      aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb87-41"><a href="geom_detect.html#cb87-41" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-42"><a href="geom_detect.html#cb87-42" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb87-43"><a href="geom_detect.html#cb87-43" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb87-44"><a href="geom_detect.html#cb87-44" tabindex="-1"></a>      , <span class="at">mask =</span> T</span>
<span id="cb87-45"><a href="geom_detect.html#cb87-45" tabindex="-1"></a>    )</span>
<span id="cb87-46"><a href="geom_detect.html#cb87-46" tabindex="-1"></a>}</span>
<span id="cb87-47"><a href="geom_detect.html#cb87-47" tabindex="-1"></a><span class="co"># terra::res(aoi_chm_rast)</span></span>
<span id="cb87-48"><a href="geom_detect.html#cb87-48" tabindex="-1"></a><span class="co"># terra::plot(aoi_chm_rast)</span></span></code></pre></div>
<p>get the piles that intersect with our AOI boundary</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="geom_detect.html#cb88-1" tabindex="-1"></a><span class="co"># piles</span></span>
<span id="cb88-2"><a href="geom_detect.html#cb88-2" tabindex="-1"></a>aoi_slash_piles_polys <span class="ot">&lt;-</span> psinf_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb88-3"><a href="geom_detect.html#cb88-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb88-4"><a href="geom_detect.html#cb88-4" tabindex="-1"></a>    psinf_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb88-5"><a href="geom_detect.html#cb88-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_boundary) <span class="sc">%&gt;%</span> </span>
<span id="cb88-6"><a href="geom_detect.html#cb88-6" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb88-7"><a href="geom_detect.html#cb88-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb88-8"><a href="geom_detect.html#cb88-8" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb88-9"><a href="geom_detect.html#cb88-9" tabindex="-1"></a>  )</span>
<span id="cb88-10"><a href="geom_detect.html#cb88-10" tabindex="-1"></a><span class="co"># aoi_slash_piles_polys %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(is_in_stand)</span></span>
<span id="cb88-11"><a href="geom_detect.html#cb88-11" tabindex="-1"></a><span class="co"># ggplot base</span></span>
<span id="cb88-12"><a href="geom_detect.html#cb88-12" tabindex="-1"></a>aoi_plt_ortho <span class="ot">&lt;-</span> <span class="fu">ortho_plt_fn</span>(<span class="at">rgb_rast =</span> aoi_rgb_rast, <span class="at">stand =</span> aoi_boundary, <span class="at">buffer =</span> <span class="dv">3</span>)</span>
<span id="cb88-13"><a href="geom_detect.html#cb88-13" tabindex="-1"></a><span class="co"># aoi_plt_ortho</span></span></code></pre></div>
<p>look at the demonstration area (plots using <code>ggplot2</code> for maximum customization)</p>
<p>here is the CHM of the example area. can you pick out the slash piles?</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="geom_detect.html#cb89-1" tabindex="-1"></a>plt_aoi_chm <span class="ot">&lt;-</span> <span class="cf">function</span>(chm, <span class="at">opt=</span><span class="st">&quot;plasma&quot;</span>) {</span>
<span id="cb89-2"><a href="geom_detect.html#cb89-2" tabindex="-1"></a>  max_val <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(chm)[<span class="dv">2</span>]<span class="sc">*</span><span class="fl">1.02</span>)</span>
<span id="cb89-3"><a href="geom_detect.html#cb89-3" tabindex="-1"></a>  rng <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(max_val,<span class="dv">1</span>))</span>
<span id="cb89-4"><a href="geom_detect.html#cb89-4" tabindex="-1"></a>  pretty <span class="ot">&lt;-</span> scales<span class="sc">::</span><span class="fu">breaks_pretty</span>(<span class="at">n =</span> <span class="dv">4</span>)(rng)</span>
<span id="cb89-5"><a href="geom_detect.html#cb89-5" tabindex="-1"></a>  </span>
<span id="cb89-6"><a href="geom_detect.html#cb89-6" tabindex="-1"></a>  thrsh <span class="ot">&lt;-</span> <span class="fl">0.10</span> <span class="sc">*</span> (<span class="fu">max</span>(rng) <span class="sc">-</span> <span class="fu">min</span>(rng))</span>
<span id="cb89-7"><a href="geom_detect.html#cb89-7" tabindex="-1"></a>  filtered_pretty <span class="ot">&lt;-</span> pretty[</span>
<span id="cb89-8"><a href="geom_detect.html#cb89-8" tabindex="-1"></a>    <span class="fu">abs</span>(pretty <span class="sc">-</span> <span class="fu">min</span>(rng)) <span class="sc">&gt;</span> thrsh <span class="sc">&amp;</span> </span>
<span id="cb89-9"><a href="geom_detect.html#cb89-9" tabindex="-1"></a>    <span class="fu">abs</span>(pretty <span class="sc">-</span> <span class="fu">max</span>(rng)) <span class="sc">&gt;</span> thrsh</span>
<span id="cb89-10"><a href="geom_detect.html#cb89-10" tabindex="-1"></a>  ]</span>
<span id="cb89-11"><a href="geom_detect.html#cb89-11" tabindex="-1"></a>  brks <span class="ot">&lt;-</span> </span>
<span id="cb89-12"><a href="geom_detect.html#cb89-12" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb89-13"><a href="geom_detect.html#cb89-13" tabindex="-1"></a>      rng</span>
<span id="cb89-14"><a href="geom_detect.html#cb89-14" tabindex="-1"></a>      , filtered_pretty</span>
<span id="cb89-15"><a href="geom_detect.html#cb89-15" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb89-16"><a href="geom_detect.html#cb89-16" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb89-17"><a href="geom_detect.html#cb89-17" tabindex="-1"></a>    <span class="fu">sort</span>()</span>
<span id="cb89-18"><a href="geom_detect.html#cb89-18" tabindex="-1"></a>  </span>
<span id="cb89-19"><a href="geom_detect.html#cb89-19" tabindex="-1"></a>  chm <span class="sc">%&gt;%</span> </span>
<span id="cb89-20"><a href="geom_detect.html#cb89-20" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb89-21"><a href="geom_detect.html#cb89-21" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-22"><a href="geom_detect.html#cb89-22" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb89-23"><a href="geom_detect.html#cb89-23" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span>f)) <span class="sc">+</span></span>
<span id="cb89-24"><a href="geom_detect.html#cb89-24" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">3.8</span>), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.0</span>) <span class="sc">+</span> <span class="co"># so if chm is missing still same size</span></span>
<span id="cb89-25"><a href="geom_detect.html#cb89-25" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb89-26"><a href="geom_detect.html#cb89-26" tabindex="-1"></a>    <span class="co"># ggplot2::scale_fill_viridis_c(option = opt) +</span></span>
<span id="cb89-27"><a href="geom_detect.html#cb89-27" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> opt, <span class="at">limits =</span> rng, <span class="at">breaks =</span> brks) <span class="sc">+</span></span>
<span id="cb89-28"><a href="geom_detect.html#cb89-28" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;CHM (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb89-29"><a href="geom_detect.html#cb89-29" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb89-30"><a href="geom_detect.html#cb89-30" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb89-31"><a href="geom_detect.html#cb89-31" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb89-32"><a href="geom_detect.html#cb89-32" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb89-33"><a href="geom_detect.html#cb89-33" tabindex="-1"></a>      <span class="co"># legend.position = &quot;top&quot;</span></span>
<span id="cb89-34"><a href="geom_detect.html#cb89-34" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;inside&quot;</span></span>
<span id="cb89-35"><a href="geom_detect.html#cb89-35" tabindex="-1"></a>      , <span class="at">legend.position.inside =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>)</span>
<span id="cb89-36"><a href="geom_detect.html#cb89-36" tabindex="-1"></a>      , <span class="at">legend.justification.inside =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb89-37"><a href="geom_detect.html#cb89-37" tabindex="-1"></a>      , <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span></span>
<span id="cb89-38"><a href="geom_detect.html#cb89-38" tabindex="-1"></a>      , <span class="at">legend.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb89-39"><a href="geom_detect.html#cb89-39" tabindex="-1"></a>      , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="fl">6.5</span>, <span class="at">margin =</span> ggplot2<span class="sc">::</span><span class="fu">margin</span>(<span class="at">t =</span> <span class="sc">-</span><span class="fl">0.01</span>))</span>
<span id="cb89-40"><a href="geom_detect.html#cb89-40" tabindex="-1"></a>      , <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="fl">0.35</span>, <span class="st">&quot;cm&quot;</span>)</span>
<span id="cb89-41"><a href="geom_detect.html#cb89-41" tabindex="-1"></a>      , <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">&quot;cm&quot;</span>)</span>
<span id="cb89-42"><a href="geom_detect.html#cb89-42" tabindex="-1"></a>      , <span class="at">legend.background =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;gray95&quot;</span>) <span class="co">#, color = &quot;black&quot;)</span></span>
<span id="cb89-43"><a href="geom_detect.html#cb89-43" tabindex="-1"></a>      , <span class="at">legend.margin =</span> ggplot2<span class="sc">::</span><span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">r =</span> <span class="dv">7</span>, <span class="at">b =</span> <span class="dv">6</span>, <span class="at">l =</span> <span class="dv">7</span>, <span class="at">unit =</span> <span class="st">&quot;pt&quot;</span>)</span>
<span id="cb89-44"><a href="geom_detect.html#cb89-44" tabindex="-1"></a>    ) </span>
<span id="cb89-45"><a href="geom_detect.html#cb89-45" tabindex="-1"></a>}</span>
<span id="cb89-46"><a href="geom_detect.html#cb89-46" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-112-1.png" alt="" width="1008" /></p>
<p>here is the RGB of the example area. can you pick out the slash piles?</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="geom_detect.html#cb90-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span> </span>
<span id="cb90-2"><a href="geom_detect.html#cb90-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-114-1.png" alt="" width="1008" /></p>
<p>we’ll add on the ground truth piles in cyan on the RGB. how many did you find? be honest.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="geom_detect.html#cb91-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb91-2"><a href="geom_detect.html#cb91-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb91-3"><a href="geom_detect.html#cb91-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb91-4"><a href="geom_detect.html#cb91-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb91-5"><a href="geom_detect.html#cb91-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb91-6"><a href="geom_detect.html#cb91-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-7"><a href="geom_detect.html#cb91-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-116-1.png" alt="" width="1008" /></p>
<p>would you have done better if you had both the CHM and RGB data?</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="geom_detect.html#cb92-1" tabindex="-1"></a>plt_aoi_chm_rgb <span class="ot">&lt;-</span> <span class="cf">function</span>(chm) {</span>
<span id="cb92-2"><a href="geom_detect.html#cb92-2" tabindex="-1"></a> aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb92-3"><a href="geom_detect.html#cb92-3" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb92-4"><a href="geom_detect.html#cb92-4" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb92-5"><a href="geom_detect.html#cb92-5" tabindex="-1"></a>      <span class="at">data =</span> chm <span class="sc">%&gt;%</span></span>
<span id="cb92-6"><a href="geom_detect.html#cb92-6" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb92-7"><a href="geom_detect.html#cb92-7" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb92-8"><a href="geom_detect.html#cb92-8" tabindex="-1"></a>      , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span>f)</span>
<span id="cb92-9"><a href="geom_detect.html#cb92-9" tabindex="-1"></a>      , <span class="at">alpha =</span> <span class="fl">0.4</span></span>
<span id="cb92-10"><a href="geom_detect.html#cb92-10" tabindex="-1"></a>      , <span class="at">inherit.aes =</span> F</span>
<span id="cb92-11"><a href="geom_detect.html#cb92-11" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb92-12"><a href="geom_detect.html#cb92-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-13"><a href="geom_detect.html#cb92-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb92-14"><a href="geom_detect.html#cb92-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) </span>
<span id="cb92-15"><a href="geom_detect.html#cb92-15" tabindex="-1"></a>}</span>
<span id="cb92-16"><a href="geom_detect.html#cb92-16" tabindex="-1"></a><span class="fu">plt_aoi_chm_rgb</span>(aoi_chm_rast) <span class="sc">+</span></span>
<span id="cb92-17"><a href="geom_detect.html#cb92-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb92-18"><a href="geom_detect.html#cb92-18" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb92-19"><a href="geom_detect.html#cb92-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb92-20"><a href="geom_detect.html#cb92-20" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-119-1.png" alt="" width="1008" /></p>
</div>
<div id="segmentation-methods" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Segmentation Methods<a href="geom_detect.html#segmentation-methods" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Our slash pile detection approach will align with the land manager knowledge of physical metrics of slash pile form which are commonly used in forest inventories and silvicultural prescriptions. We’ll start with input parameters like height and area thresholds.</p>
<p>the first step in this approach is to isolate the lower “slice” of the CHM based on a maximum height threshold defined by the upper limit of the expected slash pile height. the expected height range to search for slash piles should be based on the pile construction prescription and potentially adjusted based on a sample of field-measured values after treatment completion</p>
<p>we’ll set a maximum height threshold (<code>max_ht_m</code>) which filters the CHM to only include raster cells lower than this threshold. we’ll also set a lower height limit (<code>min_ht_m</code>) based on the expected slash pile height for use later in removing candidate segments that are shorter than this lower limit.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="geom_detect.html#cb93-1" tabindex="-1"></a><span class="co"># set the max and min expected pile height</span></span>
<span id="cb93-2"><a href="geom_detect.html#cb93-2" tabindex="-1"></a>max_ht_m <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb93-3"><a href="geom_detect.html#cb93-3" tabindex="-1"></a>min_ht_m <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb93-4"><a href="geom_detect.html#cb93-4" tabindex="-1"></a><span class="co"># lower CHM slice</span></span>
<span id="cb93-5"><a href="geom_detect.html#cb93-5" tabindex="-1"></a>aoi_chm_rast_slice <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">clamp</span>(aoi_chm_rast, <span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span></code></pre></div>
<p>plot the lower slice, notice how the CHM height scale has changed</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="geom_detect.html#cb94-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb94-2"><a href="geom_detect.html#cb94-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb94-3"><a href="geom_detect.html#cb94-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb94-4"><a href="geom_detect.html#cb94-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb94-5"><a href="geom_detect.html#cb94-5" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-122-1.png" alt="" width="1008" /></p>
<p>already, it looks like the piles should be distinguishable objects from this data</p>
<p>our rules-based pile detection methodology will also rely on area thresholds to define a search space and filter candidate segments. like height, we’ll also set a minimum (<code>min_area_m2</code>) and maximum (<code>max_area_m2</code>) pile 2D area (in square meters) to search and filter for valid candidate objects. As with the height, these thresholds should be set based on the pile construction prescription or estimates or sample measurements from field visits.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="geom_detect.html#cb95-1" tabindex="-1"></a><span class="co"># set the max and min expected pile area</span></span>
<span id="cb95-2"><a href="geom_detect.html#cb95-2" tabindex="-1"></a>min_area_m2 <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb95-3"><a href="geom_detect.html#cb95-3" tabindex="-1"></a><span class="co"># Two standard US parking spaces, typically measuring 9 feet by 18 feet, </span></span>
<span id="cb95-4"><a href="geom_detect.html#cb95-4" tabindex="-1"></a><span class="co"># are roughly equivalent to 30.25 square meters. Each space is approximately 15.125 square meters.</span></span>
<span id="cb95-5"><a href="geom_detect.html#cb95-5" tabindex="-1"></a><span class="co"># 15.125*3</span></span>
<span id="cb95-6"><a href="geom_detect.html#cb95-6" tabindex="-1"></a>max_area_m2 <span class="ot">&lt;-</span> <span class="dv">50</span></span></code></pre></div>
<p>to summarize, the size-based thresholds of our geometric, rules-based approach for detecting slash piles from CHM data are:</p>
<ul>
<li><code>max_ht_m</code> : numeric. The maximum height (in meters) a slash pile is expected to be. This value helps us focus on a specific “slice” of the data, ignoring anything taller than a typical pile.</li>
<li><code>min_ht_m</code> : numeric. The minimum height (in meters) a detected pile must reach to be considered valid.</li>
<li><code>min_area_m2</code> : numeric. The smallest 2D area (in square meters) a detected pile must cover to be considered valid.</li>
<li><code>max_area_m2</code> : numeric. The largest 2D area (in square meters) a detected pile can cover to be considered valid.</li>
</ul>
<div id="seg_methods" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Overview of Methods<a href="geom_detect.html#seg_methods" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The two primary segmentation methods we’ll test are watershed segmentation and DBSCAN. Watershed segmentation, which we’ll implement with <code>lidR::watershed()</code>, is a raster-based technique that treats a CHM as a topographic surface where height values are inverted to create basins. The algorithm identifies local maxima as “seeds” and expands them until they reach a boundary or “watershed” line. This method requires a tolerance parameter (<code>tol</code>) which defines “the minimum height of the object…between its highest point (seed) and the point where it contacts another object…If the height is smaller than the tolerance, the object will be combined with one of its neighbors, which is the highest. Tolerance should be chosen according to the range of x.” An extent parameter (<code>ext</code>) is used to define the search window for object seeds.</p>
<p>The DBSCAN algorithm, which we’ll implement with <code>dbscan::dbscan()</code>, is typically a point-based clustering algorithm that groups points based on their spatial density but DBSCAN can also be applied to raster data by converting the raster cells into a 2D point set using the cell centroids. The algorithm relies on an epsilon parameter (<code>eps</code>), which defines the search radius around a point, and a minimum points parameter (<code>minPts</code>), which sets the threshold for how many neighbors must exist within that radius to form a core cluster.</p>
<p>Dynamically defining these parameters is critical for the usability and scalability of the method because it removes the guesswork typically required when moving between different datasets. For example, point clouds can vary in point density depending on the flight altitude or sensor, and rasters can vary in resolution. If parameters are kept static, a model tuned for a specific data structure or target object will be suboptimal for different data. We can link the segmentation algorithm parameters directly to the input data structure and the expected target object size so that the method automatically recalibrates itself.</p>
<p>In applying a similar, rules-based methodology for coarse woody debris detection from point cloud data, <a href="https://doi.org/10.3390/rs17040651">dos Santos et al. (2025)</a> recommend setting algorithm parameters based on minimum expected object size to be detected and point density.</p>
<p>We developed dynamic logic to automatically bridge the gap between the expectation of the target object form (height and area thresholds) and the representation of the object in the data by using geometric ratios. For watershed segmentation, the tolerance (<code>tol</code>) is scaled to the height range of the target objects to ensure sensitivity to the vertical variability. The extent (<code>ext</code>) is calculated by converting the physical radius of the smallest expected object into a pixel count based on the raster resolution. For DBSCAN, the epsilon parameter (<code>eps</code>) is calculated to bridge the average gap between points (or the distance between raster cell centroids) but is capped to prevent the merging of adjacent objects. The minimum points (<code>minPts</code>) parameter is scaled by the ratio of the search area (<code>eps</code>) to the total object area, ensuring that a cluster only forms if the local point density is representative of a valid target object.</p>
<table style="width:100%;">
<colgroup>
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Method</th>
<th align="left">Parameter</th>
<th align="left">Parameter Description</th>
<th align="left">Our Dynamic Logic (R-style pseudo-code)</th>
<th align="left">Logic Explanation</th>
<th align="left">Why our dynamic logic works</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>Watershed</strong></td>
<td align="left"><code>tol</code></td>
<td align="left">Minimum height difference to distinguish objects.</td>
<td align="left"><code>(max_ht_m - min_ht_m) * 0.50</code></td>
<td align="left">Sets the vertical threshold at 50% of the target’s defined Z search space.</td>
<td align="left">Prevents over-segmentation by requiring vertical “valleys” to be significant relative to the target’s height.</td>
</tr>
<tr class="even">
<td align="left"><strong>Watershed</strong></td>
<td align="left"><code>ext</code></td>
<td align="left">Radius of the search window for detecting seeds.</td>
<td align="left"><code>max(1, round((target_radius_m * 0.5) / rast_res_m))</code></td>
<td align="left">Uses 50% of the target radius as the search window, converted to pixels with a 1-pixel minimum.</td>
<td align="left">Maintains a consistent physical search area regardless of raster resolution, ensuring seeds are centered on objects.</td>
</tr>
<tr class="odd">
<td align="left"><strong>DBSCAN</strong></td>
<td align="left"><code>eps</code></td>
<td align="left">Maximum distance to consider points as neighbors.</td>
<td align="left"><code>min(1.5 * (1/sqrt(pts_per_m2)), (target_radius_m * 0.5 * 0.5))</code></td>
<td align="left">Selects the smaller of 1.5-times the point spacing or 50% of the effective radius (25% of target radius).</td>
<td align="left">Ensures the point-search stays localized, effectively preventing separate objects from “bridging” together.</td>
</tr>
<tr class="even">
<td align="left"><strong>DBSCAN</strong></td>
<td align="left"><code>minPts</code></td>
<td align="left">Minimum points required to form a cluster core.</td>
<td align="left"><code>round((min_area_m2 * pts_per_m2) * (eps^2 / (target_radius_m^2)))</code></td>
<td align="left">Scales total expected points by the ratio of the search circle area to the total target area.</td>
<td align="left">Dynamically adjusts the density threshold based on the search radius, allowing for consistent detection across varying data densities.</td>
</tr>
</tbody>
</table>
<p>let’s define a function to get these parameters based on the user-defined size thresholds and the input data description</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="geom_detect.html#cb96-1" tabindex="-1"></a><span class="co"># function to get segmentation parameters</span></span>
<span id="cb96-2"><a href="geom_detect.html#cb96-2" tabindex="-1"></a>get_segmentation_params <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb96-3"><a href="geom_detect.html#cb96-3" tabindex="-1"></a>  min_ht_m</span>
<span id="cb96-4"><a href="geom_detect.html#cb96-4" tabindex="-1"></a>  , max_ht_m</span>
<span id="cb96-5"><a href="geom_detect.html#cb96-5" tabindex="-1"></a>  , min_area_m2</span>
<span id="cb96-6"><a href="geom_detect.html#cb96-6" tabindex="-1"></a>  , max_area_m2</span>
<span id="cb96-7"><a href="geom_detect.html#cb96-7" tabindex="-1"></a>  , <span class="at">pts_per_m2 =</span> <span class="cn">NULL</span></span>
<span id="cb96-8"><a href="geom_detect.html#cb96-8" tabindex="-1"></a>  , <span class="at">rast_res_m =</span> <span class="cn">NULL</span></span>
<span id="cb96-9"><a href="geom_detect.html#cb96-9" tabindex="-1"></a>){</span>
<span id="cb96-10"><a href="geom_detect.html#cb96-10" tabindex="-1"></a>  </span>
<span id="cb96-11"><a href="geom_detect.html#cb96-11" tabindex="-1"></a>  <span class="co"># check for missing required values</span></span>
<span id="cb96-12"><a href="geom_detect.html#cb96-12" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">missing</span>(max_ht_m) <span class="sc">||</span> <span class="fu">missing</span>(min_ht_m) <span class="sc">||</span> </span>
<span id="cb96-13"><a href="geom_detect.html#cb96-13" tabindex="-1"></a>      <span class="fu">missing</span>(min_area_m2) <span class="sc">||</span> <span class="fu">missing</span>(max_area_m2)) {</span>
<span id="cb96-14"><a href="geom_detect.html#cb96-14" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;all geometric constraints (max_ht_m, min_ht_m, min_area_m2, max_area_m2) must be defined.&quot;</span>)</span>
<span id="cb96-15"><a href="geom_detect.html#cb96-15" tabindex="-1"></a>  }</span>
<span id="cb96-16"><a href="geom_detect.html#cb96-16" tabindex="-1"></a>  </span>
<span id="cb96-17"><a href="geom_detect.html#cb96-17" tabindex="-1"></a>  <span class="co"># geometric param validation</span></span>
<span id="cb96-18"><a href="geom_detect.html#cb96-18" tabindex="-1"></a>  <span class="cf">if</span> (max_ht_m <span class="sc">&lt;=</span> min_ht_m) {</span>
<span id="cb96-19"><a href="geom_detect.html#cb96-19" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;max_ht_m must be greater than min_ht_m.&quot;</span>)</span>
<span id="cb96-20"><a href="geom_detect.html#cb96-20" tabindex="-1"></a>  }</span>
<span id="cb96-21"><a href="geom_detect.html#cb96-21" tabindex="-1"></a>  <span class="cf">if</span> (max_area_m2 <span class="sc">&lt;=</span> min_area_m2) {</span>
<span id="cb96-22"><a href="geom_detect.html#cb96-22" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;max_area_m2 must be greater than min_area_m2.&quot;</span>)</span>
<span id="cb96-23"><a href="geom_detect.html#cb96-23" tabindex="-1"></a>  }</span>
<span id="cb96-24"><a href="geom_detect.html#cb96-24" tabindex="-1"></a>  <span class="cf">if</span> (min_ht_m <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">||</span> min_area_m2 <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb96-25"><a href="geom_detect.html#cb96-25" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;height and area constraints must be positive values.&quot;</span>)</span>
<span id="cb96-26"><a href="geom_detect.html#cb96-26" tabindex="-1"></a>  }</span>
<span id="cb96-27"><a href="geom_detect.html#cb96-27" tabindex="-1"></a>  </span>
<span id="cb96-28"><a href="geom_detect.html#cb96-28" tabindex="-1"></a>  <span class="co"># data structure validation and calculation</span></span>
<span id="cb96-29"><a href="geom_detect.html#cb96-29" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(pts_per_m2) <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(rast_res_m)) {</span>
<span id="cb96-30"><a href="geom_detect.html#cb96-30" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;must provide either &#39;pts_per_m2&#39; (pts/m2) or &#39;rast_res_m&#39; (m/pixel).&quot;</span>)</span>
<span id="cb96-31"><a href="geom_detect.html#cb96-31" tabindex="-1"></a>  }</span>
<span id="cb96-32"><a href="geom_detect.html#cb96-32" tabindex="-1"></a>  </span>
<span id="cb96-33"><a href="geom_detect.html#cb96-33" tabindex="-1"></a>  <span class="co"># calculate and validate data str values</span></span>
<span id="cb96-34"><a href="geom_detect.html#cb96-34" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(pts_per_m2)) {</span>
<span id="cb96-35"><a href="geom_detect.html#cb96-35" tabindex="-1"></a>    <span class="cf">if</span> (rast_res_m <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">&quot;rast_res_m must be a positive value.&quot;</span>)</span>
<span id="cb96-36"><a href="geom_detect.html#cb96-36" tabindex="-1"></a>    pts_per_m2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (rast_res_m<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb96-37"><a href="geom_detect.html#cb96-37" tabindex="-1"></a>  }</span>
<span id="cb96-38"><a href="geom_detect.html#cb96-38" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(rast_res_m)) {</span>
<span id="cb96-39"><a href="geom_detect.html#cb96-39" tabindex="-1"></a>    <span class="cf">if</span> (pts_per_m2 <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">&quot;pts_per_m2 must be a positive value.&quot;</span>)</span>
<span id="cb96-40"><a href="geom_detect.html#cb96-40" tabindex="-1"></a>    rast_res_m <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(pts_per_m2)</span>
<span id="cb96-41"><a href="geom_detect.html#cb96-41" tabindex="-1"></a>  }</span>
<span id="cb96-42"><a href="geom_detect.html#cb96-42" tabindex="-1"></a>  <span class="do">################################################</span></span>
<span id="cb96-43"><a href="geom_detect.html#cb96-43" tabindex="-1"></a>  <span class="co"># lidR::watershed / EBImage::watershed</span></span>
<span id="cb96-44"><a href="geom_detect.html#cb96-44" tabindex="-1"></a>  <span class="do">################################################</span></span>
<span id="cb96-45"><a href="geom_detect.html#cb96-45" tabindex="-1"></a>  <span class="co"># lidR::watershed `tol`</span></span>
<span id="cb96-46"><a href="geom_detect.html#cb96-46" tabindex="-1"></a>  <span class="co"># set based on the height range</span></span>
<span id="cb96-47"><a href="geom_detect.html#cb96-47" tabindex="-1"></a>  height_range <span class="ot">&lt;-</span> max_ht_m <span class="sc">-</span> min_ht_m</span>
<span id="cb96-48"><a href="geom_detect.html#cb96-48" tabindex="-1"></a>  <span class="co"># scale it to increase the sensitivity to distinguish smaller objects</span></span>
<span id="cb96-49"><a href="geom_detect.html#cb96-49" tabindex="-1"></a>  tol_val <span class="ot">&lt;-</span> height_range <span class="sc">*</span> <span class="fl">0.5</span></span>
<span id="cb96-50"><a href="geom_detect.html#cb96-50" tabindex="-1"></a>  </span>
<span id="cb96-51"><a href="geom_detect.html#cb96-51" tabindex="-1"></a>  <span class="co"># lidR::watershed `ext`</span></span>
<span id="cb96-52"><a href="geom_detect.html#cb96-52" tabindex="-1"></a>  <span class="co"># use ~half~ quarter the radius of the minimum object to increase sensitivity</span></span>
<span id="cb96-53"><a href="geom_detect.html#cb96-53" tabindex="-1"></a>  <span class="co"># this helps prevent merging nearby objects (under-segmentation)</span></span>
<span id="cb96-54"><a href="geom_detect.html#cb96-54" tabindex="-1"></a>  target_radius_m <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(min_area_m2 <span class="sc">/</span> pi)</span>
<span id="cb96-55"><a href="geom_detect.html#cb96-55" tabindex="-1"></a>  effective_radius_m <span class="ot">&lt;-</span> target_radius_m <span class="sc">*</span> <span class="fl">0.25</span></span>
<span id="cb96-56"><a href="geom_detect.html#cb96-56" tabindex="-1"></a>  ext_val <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(effective_radius_m <span class="sc">/</span> rast_res_m))</span>
<span id="cb96-57"><a href="geom_detect.html#cb96-57" tabindex="-1"></a>  </span>
<span id="cb96-58"><a href="geom_detect.html#cb96-58" tabindex="-1"></a>  <span class="do">################################################</span></span>
<span id="cb96-59"><a href="geom_detect.html#cb96-59" tabindex="-1"></a>  <span class="co"># dbscan::dbscan</span></span>
<span id="cb96-60"><a href="geom_detect.html#cb96-60" tabindex="-1"></a>  <span class="do">################################################</span></span>
<span id="cb96-61"><a href="geom_detect.html#cb96-61" tabindex="-1"></a>  <span class="co"># dbscan::dbscan `eps` (epsilon)</span></span>
<span id="cb96-62"><a href="geom_detect.html#cb96-62" tabindex="-1"></a>  <span class="co"># [dos Santos et al. (2025)](https://doi.org/10.3390/rs17040651) recommended to set this value based:</span></span>
<span id="cb96-63"><a href="geom_detect.html#cb96-63" tabindex="-1"></a>    <span class="co"># &quot;on the minimum cluster size to be detected and point density&quot;</span></span>
<span id="cb96-64"><a href="geom_detect.html#cb96-64" tabindex="-1"></a>  </span>
<span id="cb96-65"><a href="geom_detect.html#cb96-65" tabindex="-1"></a>  <span class="co"># start by scaling based on point spacing (1.5x average distance between points).</span></span>
<span id="cb96-66"><a href="geom_detect.html#cb96-66" tabindex="-1"></a>  spacing <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(pts_per_m2)</span>
<span id="cb96-67"><a href="geom_detect.html#cb96-67" tabindex="-1"></a>  connectivity_eps <span class="ot">&lt;-</span> <span class="fl">1.5</span> <span class="sc">*</span> spacing</span>
<span id="cb96-68"><a href="geom_detect.html#cb96-68" tabindex="-1"></a>  <span class="co"># eps should not exceed 50% of the minimum object radius to avoid merging separate objects into one cluster.</span></span>
<span id="cb96-69"><a href="geom_detect.html#cb96-69" tabindex="-1"></a>  max_allowable_eps <span class="ot">&lt;-</span> target_radius_m <span class="sc">*</span> <span class="fl">0.25</span></span>
<span id="cb96-70"><a href="geom_detect.html#cb96-70" tabindex="-1"></a>  <span class="co"># cap eps by the object size constraint</span></span>
<span id="cb96-71"><a href="geom_detect.html#cb96-71" tabindex="-1"></a>  eps_val <span class="ot">&lt;-</span> <span class="fu">min</span>(connectivity_eps, max_allowable_eps)</span>
<span id="cb96-72"><a href="geom_detect.html#cb96-72" tabindex="-1"></a>  </span>
<span id="cb96-73"><a href="geom_detect.html#cb96-73" tabindex="-1"></a>  <span class="co"># dbscan::dbscan `minPts`</span></span>
<span id="cb96-74"><a href="geom_detect.html#cb96-74" tabindex="-1"></a>  <span class="co"># based on expected points within the epsilon neighborhood area</span></span>
<span id="cb96-75"><a href="geom_detect.html#cb96-75" tabindex="-1"></a>  </span>
<span id="cb96-76"><a href="geom_detect.html#cb96-76" tabindex="-1"></a>  <span class="co"># get expected number of points in an object of min_area_m2</span></span>
<span id="cb96-77"><a href="geom_detect.html#cb96-77" tabindex="-1"></a>  expected_pts_in_min_object <span class="ot">&lt;-</span> min_area_m2 <span class="sc">*</span> pts_per_m2</span>
<span id="cb96-78"><a href="geom_detect.html#cb96-78" tabindex="-1"></a>  </span>
<span id="cb96-79"><a href="geom_detect.html#cb96-79" tabindex="-1"></a>  <span class="co"># ensure a core point is surrounded by a density of points based on min_area_m2 size at point density</span></span>
<span id="cb96-80"><a href="geom_detect.html#cb96-80" tabindex="-1"></a>  <span class="co"># scale the total expected points of the minimum object </span></span>
<span id="cb96-81"><a href="geom_detect.html#cb96-81" tabindex="-1"></a>    <span class="co"># by the ratio of the epsilon-neighborhood area to the total minimum object area</span></span>
<span id="cb96-82"><a href="geom_detect.html#cb96-82" tabindex="-1"></a>    <span class="co"># to ensure a core point meets the expected density of the target object</span></span>
<span id="cb96-83"><a href="geom_detect.html#cb96-83" tabindex="-1"></a>  pts_ratio_calc <span class="ot">&lt;-</span> expected_pts_in_min_object <span class="sc">*</span> (eps_val<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> target_radius_m<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb96-84"><a href="geom_detect.html#cb96-84" tabindex="-1"></a>  min_pts_val <span class="ot">&lt;-</span> <span class="fu">max</span>(</span>
<span id="cb96-85"><a href="geom_detect.html#cb96-85" tabindex="-1"></a>    <span class="dv">5</span> <span class="co"># don&#39;t go any lower than the dbscan::dbscan() default</span></span>
<span id="cb96-86"><a href="geom_detect.html#cb96-86" tabindex="-1"></a>    , <span class="fu">round</span>(pts_ratio_calc)</span>
<span id="cb96-87"><a href="geom_detect.html#cb96-87" tabindex="-1"></a>  )</span>
<span id="cb96-88"><a href="geom_detect.html#cb96-88" tabindex="-1"></a>  </span>
<span id="cb96-89"><a href="geom_detect.html#cb96-89" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb96-90"><a href="geom_detect.html#cb96-90" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb96-91"><a href="geom_detect.html#cb96-91" tabindex="-1"></a>    <span class="at">data_summary =</span> <span class="fu">list</span>(<span class="at">pts_per_m2 =</span> pts_per_m2, <span class="at">rast_res_m =</span> rast_res_m),</span>
<span id="cb96-92"><a href="geom_detect.html#cb96-92" tabindex="-1"></a>    <span class="at">watershed =</span> <span class="fu">list</span>(<span class="at">tol =</span> tol_val, <span class="at">ext =</span> ext_val),</span>
<span id="cb96-93"><a href="geom_detect.html#cb96-93" tabindex="-1"></a>    <span class="at">dbscan =</span> <span class="fu">list</span>(<span class="at">eps =</span> eps_val, <span class="at">minPts =</span> min_pts_val)</span>
<span id="cb96-94"><a href="geom_detect.html#cb96-94" tabindex="-1"></a>  ))</span>
<span id="cb96-95"><a href="geom_detect.html#cb96-95" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s test our <code>get_segmentation_params()</code> function using the size threshold parameters we defined above: <code>max_ht_m</code>, <code>min_ht_m</code>, <code>min_area_m2</code>, <code>max_area_m2</code> and we can get the raster resolution directly from our input CHM</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="geom_detect.html#cb97-1" tabindex="-1"></a><span class="co"># get_segmentation_params</span></span>
<span id="cb97-2"><a href="geom_detect.html#cb97-2" tabindex="-1"></a>get_segmentation_params_ans <span class="ot">&lt;-</span> <span class="fu">get_segmentation_params</span>(</span>
<span id="cb97-3"><a href="geom_detect.html#cb97-3" tabindex="-1"></a>    <span class="at">max_ht_m =</span> max_ht_m</span>
<span id="cb97-4"><a href="geom_detect.html#cb97-4" tabindex="-1"></a>    , <span class="at">min_ht_m =</span> min_ht_m</span>
<span id="cb97-5"><a href="geom_detect.html#cb97-5" tabindex="-1"></a>    , <span class="at">min_area_m2 =</span> min_area_m2</span>
<span id="cb97-6"><a href="geom_detect.html#cb97-6" tabindex="-1"></a>    , <span class="at">max_area_m2 =</span> max_area_m2</span>
<span id="cb97-7"><a href="geom_detect.html#cb97-7" tabindex="-1"></a>    <span class="co"># , pts_per_m2 = NULL</span></span>
<span id="cb97-8"><a href="geom_detect.html#cb97-8" tabindex="-1"></a>    , <span class="at">rast_res_m =</span> terra<span class="sc">::</span><span class="fu">res</span>(aoi_chm_rast_slice)[<span class="dv">1</span>]</span>
<span id="cb97-9"><a href="geom_detect.html#cb97-9" tabindex="-1"></a>  )</span>
<span id="cb97-10"><a href="geom_detect.html#cb97-10" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb97-11"><a href="geom_detect.html#cb97-11" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">glimpse</span>(get_segmentation_params_ans)</span></code></pre></div>
<pre><code>## List of 3
##  $ data_summary:List of 2
##   ..$ pts_per_m2: num 100
##   ..$ rast_res_m: num 0.1
##  $ watershed   :List of 2
##   ..$ tol: num 2.75
##   ..$ ext: num 2
##  $ dbscan      :List of 2
##   ..$ eps   : num 0.15
##   ..$ minPts: num 7</code></pre>
<p>we can see how these parameters change if the CHM resolution changes</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="geom_detect.html#cb99-1" tabindex="-1"></a><span class="fu">get_segmentation_params</span>(</span>
<span id="cb99-2"><a href="geom_detect.html#cb99-2" tabindex="-1"></a>    <span class="at">max_ht_m =</span> max_ht_m</span>
<span id="cb99-3"><a href="geom_detect.html#cb99-3" tabindex="-1"></a>    , <span class="at">min_ht_m =</span> min_ht_m</span>
<span id="cb99-4"><a href="geom_detect.html#cb99-4" tabindex="-1"></a>    , <span class="at">min_area_m2 =</span> min_area_m2</span>
<span id="cb99-5"><a href="geom_detect.html#cb99-5" tabindex="-1"></a>    , <span class="at">max_area_m2 =</span> max_area_m2</span>
<span id="cb99-6"><a href="geom_detect.html#cb99-6" tabindex="-1"></a>    <span class="co"># , pts_per_m2 = NULL</span></span>
<span id="cb99-7"><a href="geom_detect.html#cb99-7" tabindex="-1"></a>    , <span class="at">rast_res_m =</span> <span class="fl">0.5</span></span>
<span id="cb99-8"><a href="geom_detect.html#cb99-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb99-9"><a href="geom_detect.html#cb99-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## List of 3
##  $ data_summary:List of 2
##   ..$ pts_per_m2: num 4
##   ..$ rast_res_m: num 0.5
##  $ watershed   :List of 2
##   ..$ tol: num 2.75
##   ..$ ext: num 1
##  $ dbscan      :List of 2
##   ..$ eps   : num 0.173
##   ..$ minPts: num 5</code></pre>
<p>and we can see how these parameters change using our CHM data but change the expected minimum pile 2D area</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="geom_detect.html#cb101-1" tabindex="-1"></a><span class="fu">get_segmentation_params</span>(</span>
<span id="cb101-2"><a href="geom_detect.html#cb101-2" tabindex="-1"></a>    <span class="at">max_ht_m =</span> max_ht_m</span>
<span id="cb101-3"><a href="geom_detect.html#cb101-3" tabindex="-1"></a>    , <span class="at">min_ht_m =</span> min_ht_m</span>
<span id="cb101-4"><a href="geom_detect.html#cb101-4" tabindex="-1"></a>    , <span class="at">min_area_m2 =</span> <span class="dv">22</span></span>
<span id="cb101-5"><a href="geom_detect.html#cb101-5" tabindex="-1"></a>    , <span class="at">max_area_m2 =</span> max_area_m2</span>
<span id="cb101-6"><a href="geom_detect.html#cb101-6" tabindex="-1"></a>    <span class="co"># , pts_per_m2 = NULL</span></span>
<span id="cb101-7"><a href="geom_detect.html#cb101-7" tabindex="-1"></a>    , <span class="at">rast_res_m =</span> terra<span class="sc">::</span><span class="fu">res</span>(aoi_chm_rast_slice)[<span class="dv">1</span>]</span>
<span id="cb101-8"><a href="geom_detect.html#cb101-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb101-9"><a href="geom_detect.html#cb101-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## List of 3
##  $ data_summary:List of 2
##   ..$ pts_per_m2: num 100
##   ..$ rast_res_m: num 0.1
##  $ watershed   :List of 2
##   ..$ tol: num 2.75
##   ..$ ext: num 7
##  $ dbscan      :List of 2
##   ..$ eps   : num 0.15
##   ..$ minPts: num 7</code></pre>
<p>the table summarizes how our rules-based approach creates dynamic parameters for use in watershed and DBSCAN segmentation. The height parameters manage vertical noise, the area parameters manage horizontal separation, and the data resolution parameters ensure the math stays consistent regardless of data density (raster resolution or point cloud point density).</p>
<table>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Dynamic Parameter</th>
<th align="left">Impact of Height (<code>max_ht_m</code> / <code>min_ht_m</code>)</th>
<th align="left">Impact of Target Area (<code>min_area_m2</code>)</th>
<th align="left">Impact of Data Structure (<code>rast_res_m</code> / <code>pts_per_m2</code>)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>Watershed <code>tol</code></strong></td>
<td align="left"><strong>Direct Driver:</strong> Sets the vertical threshold at 50% of the target’s defined Z search space.</td>
<td align="left"><strong>None:</strong> Vertical tolerance is independent of horizontal footprint.</td>
<td align="left"><strong>None:</strong> Vertical sensitivity is independent of horizontal resolution.</td>
</tr>
<tr class="even">
<td align="left"><strong>Watershed <code>ext</code></strong></td>
<td align="left"><strong>None:</strong> Horizontal search window is independent of vertical range.</td>
<td align="left"><strong>Geometric Baseline:</strong> Defines the physical radius used to scale the search window at a 1:2 ratio.</td>
<td align="left"><strong>Spatial Divider:</strong> Converts the physical radius into a pixel count using <code>rast_res_m</code> with a 1-pixel minimum.</td>
</tr>
<tr class="odd">
<td align="left"><strong>DBSCAN <code>eps</code></strong></td>
<td align="left"><strong>None:</strong> Point-to-point connectivity is independent of height.</td>
<td align="left"><strong>Physical Cap:</strong> Limits search distance to 50% of the effective radius (25% of target radius) to ensure separation.</td>
<td align="left"><strong>Connectivity Anchor:</strong> Sets the search radius at 1.5-times the spacing derived from <code>pts_per_m2</code> to maintain tight clusters.</td>
</tr>
<tr class="even">
<td align="left"><strong>DBSCAN <code>minPts</code></strong></td>
<td align="left"><strong>None:</strong> Required point mass is independent of vertical range.</td>
<td align="left"><strong>Total Mass Baseline:</strong> Defines the total expected points for the smallest valid target.</td>
<td align="left"><strong>Density Multiplier:</strong> Calculates the local point count requirement relative to the <code>pts_per_m2</code> value.</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="geom_detect.html#cb103-1" tabindex="-1"></a>sim_df_temp <span class="ot">&lt;-</span></span>
<span id="cb103-2"><a href="geom_detect.html#cb103-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">crossing</span>(</span>
<span id="cb103-3"><a href="geom_detect.html#cb103-3" tabindex="-1"></a>    <span class="at">rast_res_m =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">1.3</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb103-4"><a href="geom_detect.html#cb103-4" tabindex="-1"></a>    , <span class="at">min_area_m2 =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">50</span>, <span class="at">length.out =</span> <span class="dv">33</span>)</span>
<span id="cb103-5"><a href="geom_detect.html#cb103-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb103-6"><a href="geom_detect.html#cb103-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-7"><a href="geom_detect.html#cb103-7" tabindex="-1"></a>    <span class="co"># Call the pre-defined function directly to ensure logic alignment</span></span>
<span id="cb103-8"><a href="geom_detect.html#cb103-8" tabindex="-1"></a>    <span class="at">params =</span> purrr<span class="sc">::</span><span class="fu">map2</span>(</span>
<span id="cb103-9"><a href="geom_detect.html#cb103-9" tabindex="-1"></a>      rast_res_m, min_area_m2, <span class="sc">~</span> <span class="fu">get_segmentation_params</span>(</span>
<span id="cb103-10"><a href="geom_detect.html#cb103-10" tabindex="-1"></a>        <span class="at">max_ht_m =</span> max_ht_m</span>
<span id="cb103-11"><a href="geom_detect.html#cb103-11" tabindex="-1"></a>        , <span class="at">min_ht_m =</span> min_ht_m</span>
<span id="cb103-12"><a href="geom_detect.html#cb103-12" tabindex="-1"></a>        , <span class="at">min_area_m2 =</span> .y</span>
<span id="cb103-13"><a href="geom_detect.html#cb103-13" tabindex="-1"></a>        , <span class="at">max_area_m2 =</span> .y <span class="sc">*</span> <span class="dv">5</span></span>
<span id="cb103-14"><a href="geom_detect.html#cb103-14" tabindex="-1"></a>        , <span class="at">rast_res_m =</span> .x</span>
<span id="cb103-15"><a href="geom_detect.html#cb103-15" tabindex="-1"></a>      )</span>
<span id="cb103-16"><a href="geom_detect.html#cb103-16" tabindex="-1"></a>    )</span>
<span id="cb103-17"><a href="geom_detect.html#cb103-17" tabindex="-1"></a>    </span>
<span id="cb103-18"><a href="geom_detect.html#cb103-18" tabindex="-1"></a>    <span class="co"># Extract values into individual columns for plotting</span></span>
<span id="cb103-19"><a href="geom_detect.html#cb103-19" tabindex="-1"></a>    , <span class="at">ext =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(params, <span class="sc">~</span> .x<span class="sc">$</span>watershed<span class="sc">$</span>ext)</span>
<span id="cb103-20"><a href="geom_detect.html#cb103-20" tabindex="-1"></a>    , <span class="at">eps =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(params, <span class="sc">~</span> .x<span class="sc">$</span>dbscan<span class="sc">$</span>eps)</span>
<span id="cb103-21"><a href="geom_detect.html#cb103-21" tabindex="-1"></a>    , <span class="at">min_pts =</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(params, <span class="sc">~</span> .x<span class="sc">$</span>dbscan<span class="sc">$</span>minPts)</span>
<span id="cb103-22"><a href="geom_detect.html#cb103-22" tabindex="-1"></a>  )</span>
<span id="cb103-23"><a href="geom_detect.html#cb103-23" tabindex="-1"></a>  <span class="co"># # Pivot to long format for faceted plotting</span></span>
<span id="cb103-24"><a href="geom_detect.html#cb103-24" tabindex="-1"></a>  <span class="co"># tidyr::pivot_longer(</span></span>
<span id="cb103-25"><a href="geom_detect.html#cb103-25" tabindex="-1"></a>  <span class="co">#   cols = c(ext, eps, min_pts),</span></span>
<span id="cb103-26"><a href="geom_detect.html#cb103-26" tabindex="-1"></a>  <span class="co">#   names_to = &quot;parameter&quot;,</span></span>
<span id="cb103-27"><a href="geom_detect.html#cb103-27" tabindex="-1"></a>  <span class="co">#   values_to = &quot;value&quot;</span></span>
<span id="cb103-28"><a href="geom_detect.html#cb103-28" tabindex="-1"></a>  <span class="co"># )</span></span>
<span id="cb103-29"><a href="geom_detect.html#cb103-29" tabindex="-1"></a><span class="co"># sim_df_temp %&gt;% dplyr::glimpse()</span></span>
<span id="cb103-30"><a href="geom_detect.html#cb103-30" tabindex="-1"></a></span>
<span id="cb103-31"><a href="geom_detect.html#cb103-31" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb103-32"><a href="geom_detect.html#cb103-32" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span></span>
<span id="cb103-33"><a href="geom_detect.html#cb103-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(sim_df_temp, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> rast_res_m, <span class="at">y =</span> min_area_m2, <span class="at">fill =</span> ext)) <span class="sc">+</span></span>
<span id="cb103-34"><a href="geom_detect.html#cb103-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">col =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-35"><a href="geom_detect.html#cb103-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-36"><a href="geom_detect.html#cb103-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb103-37"><a href="geom_detect.html#cb103-37" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb103-38"><a href="geom_detect.html#cb103-38" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Watershed: `ext` (pixels)&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;pixels&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-39"><a href="geom_detect.html#cb103-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb103-40"><a href="geom_detect.html#cb103-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb103-41"><a href="geom_detect.html#cb103-41" tabindex="-1"></a></span>
<span id="cb103-42"><a href="geom_detect.html#cb103-42" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span></span>
<span id="cb103-43"><a href="geom_detect.html#cb103-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(sim_df_temp, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> rast_res_m, <span class="at">y =</span> min_area_m2, <span class="at">fill =</span> eps)) <span class="sc">+</span></span>
<span id="cb103-44"><a href="geom_detect.html#cb103-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">col =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-45"><a href="geom_detect.html#cb103-45" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-46"><a href="geom_detect.html#cb103-46" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb103-47"><a href="geom_detect.html#cb103-47" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb103-48"><a href="geom_detect.html#cb103-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;DBSCAN: `eps` (meters)&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;meters&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-49"><a href="geom_detect.html#cb103-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb103-50"><a href="geom_detect.html#cb103-50" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb103-51"><a href="geom_detect.html#cb103-51" tabindex="-1"></a></span>
<span id="cb103-52"><a href="geom_detect.html#cb103-52" tabindex="-1"></a>p3_temp <span class="ot">&lt;-</span></span>
<span id="cb103-53"><a href="geom_detect.html#cb103-53" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(sim_df_temp, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> rast_res_m, <span class="at">y =</span> min_area_m2, <span class="at">fill =</span> min_pts)) <span class="sc">+</span></span>
<span id="cb103-54"><a href="geom_detect.html#cb103-54" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">col =</span> <span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-55"><a href="geom_detect.html#cb103-55" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-56"><a href="geom_detect.html#cb103-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb103-57"><a href="geom_detect.html#cb103-57" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb103-58"><a href="geom_detect.html#cb103-58" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;DBSCAN: `minPts` (count)&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;count&quot;</span>) <span class="sc">+</span></span>
<span id="cb103-59"><a href="geom_detect.html#cb103-59" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb103-60"><a href="geom_detect.html#cb103-60" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb103-61"><a href="geom_detect.html#cb103-61" tabindex="-1"></a></span>
<span id="cb103-62"><a href="geom_detect.html#cb103-62" tabindex="-1"></a><span class="co"># 5. Combine using patchwork</span></span>
<span id="cb103-63"><a href="geom_detect.html#cb103-63" tabindex="-1"></a>(p1_temp <span class="sc">+</span> p2_temp <span class="sc">+</span> p3_temp) <span class="sc">+</span> </span>
<span id="cb103-64"><a href="geom_detect.html#cb103-64" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb103-65"><a href="geom_detect.html#cb103-65" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Dynamic Watershed and DBSCAN Parameter Definition&quot;</span></span>
<span id="cb103-66"><a href="geom_detect.html#cb103-66" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;across raster resolution and minimum target area gradients&quot;</span></span>
<span id="cb103-67"><a href="geom_detect.html#cb103-67" tabindex="-1"></a>    , <span class="at">theme =</span> ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),<span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>))</span>
<span id="cb103-68"><a href="geom_detect.html#cb103-68" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb103-69"><a href="geom_detect.html#cb103-69" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-129-1.png" alt="" width="1008" /></p>
</div>
<div id="watershed-segmentation-demonstration" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Watershed Segmentation Demonstration<a href="geom_detect.html#watershed-segmentation-demonstration" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s go through the watershed segmentation process using <code>lidR::watershed()</code> which is based on the bioconductor package <code>EBIimage</code></p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="geom_detect.html#cb104-1" tabindex="-1"></a><span class="co"># ?EBImage::watershed</span></span>
<span id="cb104-2"><a href="geom_detect.html#cb104-2" tabindex="-1"></a>watershed_segs <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb104-3"><a href="geom_detect.html#cb104-3" tabindex="-1"></a>    <span class="at">chm =</span> aoi_chm_rast_slice</span>
<span id="cb104-4"><a href="geom_detect.html#cb104-4" tabindex="-1"></a>    <span class="co"># th_tree = Threshold below which a pixel cannot be a tree. Default is 2.</span></span>
<span id="cb104-5"><a href="geom_detect.html#cb104-5" tabindex="-1"></a>    , <span class="at">th_tree =</span> <span class="fl">0.01</span></span>
<span id="cb104-6"><a href="geom_detect.html#cb104-6" tabindex="-1"></a>    <span class="co"># tol = minimum height of the object in the units of image intensity between its highest point (seed) </span></span>
<span id="cb104-7"><a href="geom_detect.html#cb104-7" tabindex="-1"></a>      <span class="co"># and the point where it contacts another object (checked for every contact pixel). </span></span>
<span id="cb104-8"><a href="geom_detect.html#cb104-8" tabindex="-1"></a>      <span class="co"># If the height is smaller than the tolerance, the object will be combined with one of its neighbors, which is the highest.</span></span>
<span id="cb104-9"><a href="geom_detect.html#cb104-9" tabindex="-1"></a>      <span class="co"># Tolerance should be chosen according to the range of x</span></span>
<span id="cb104-10"><a href="geom_detect.html#cb104-10" tabindex="-1"></a>    , <span class="at">tol =</span> get_segmentation_params_ans<span class="sc">$</span>watershed<span class="sc">$</span>tol <span class="co"># max_ht_m-min_ht_m</span></span>
<span id="cb104-11"><a href="geom_detect.html#cb104-11" tabindex="-1"></a>    <span class="co"># ext = Radius of the neighborhood in pixels for the detection of neighboring objects. </span></span>
<span id="cb104-12"><a href="geom_detect.html#cb104-12" tabindex="-1"></a>      <span class="co"># Higher value smoothes out small objects.</span></span>
<span id="cb104-13"><a href="geom_detect.html#cb104-13" tabindex="-1"></a>    , <span class="at">ext =</span> get_segmentation_params_ans<span class="sc">$</span>watershed<span class="sc">$</span>ext <span class="co"># 1</span></span>
<span id="cb104-14"><a href="geom_detect.html#cb104-14" tabindex="-1"></a>  )()</span></code></pre></div>
<p>the result is a raster with cells segmented and given a unique identifier</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="geom_detect.html#cb105-1" tabindex="-1"></a><span class="co"># this is a raster</span></span>
<span id="cb105-2"><a href="geom_detect.html#cb105-2" tabindex="-1"></a>watershed_segs</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 1483, 768, 1  (nrow, ncol, nlyr)
## resolution  : 0.1, 0.1  (x, y)
## extent      : 499310.2, 499387, 4317710, 4317858  (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N (EPSG:32613) 
## source(s)   : memory
## varname     : aoi_chm_rast 
## name        : focal_mean 
## min value   :          1 
## max value   :        214</code></pre>
<p>each value should be a unique “segment” which we can refine based on rules of expected size and shape of piles</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="geom_detect.html#cb107-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(watershed_segs) <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="geom_detect.html#cb107-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>##    layer value count
## 1      1   199     9
## 2      1   177    21
## 3      1    22   737
## 4      1    19    26
## 5      1   143  1785
## 6      1     6     4
## 7      1    59    27
## 8      1    34     6
## 9      1    40     4
## 10     1   100     9</code></pre>
<p>where the “value” is the segment identifier and the count is the number of raster cells assigned to that segment</p>
<p>how many predicted segments are there?</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="geom_detect.html#cb109-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(watershed_segs) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 214</code></pre>
<p>let’s plot the raster return from the watershed segmentation</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="geom_detect.html#cb111-1" tabindex="-1"></a>watershed_segs <span class="sc">%&gt;%</span> </span>
<span id="cb111-2"><a href="geom_detect.html#cb111-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.factor</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb111-3"><a href="geom_detect.html#cb111-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb111-4"><a href="geom_detect.html#cb111-4" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">c</span>(</span>
<span id="cb111-5"><a href="geom_detect.html#cb111-5" tabindex="-1"></a>      viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n =</span> terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_segs)[<span class="dv">2</span>])</span>
<span id="cb111-6"><a href="geom_detect.html#cb111-6" tabindex="-1"></a>      <span class="co"># , viridis::viridis(n = floor(terra::minmax(watershed_segs)[2]/3))</span></span>
<span id="cb111-7"><a href="geom_detect.html#cb111-7" tabindex="-1"></a>      <span class="co"># , viridis::cividis(n = floor(terra::minmax(watershed_segs)[2]/3))</span></span>
<span id="cb111-8"><a href="geom_detect.html#cb111-8" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">sample</span>()</span>
<span id="cb111-9"><a href="geom_detect.html#cb111-9" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb111-10"><a href="geom_detect.html#cb111-10" tabindex="-1"></a>    , <span class="at">axes =</span> F</span>
<span id="cb111-11"><a href="geom_detect.html#cb111-11" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-135-1.png" alt="" width="1008" /></p>
<p>plot the watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="geom_detect.html#cb112-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb112-2"><a href="geom_detect.html#cb112-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb112-3"><a href="geom_detect.html#cb112-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb112-4"><a href="geom_detect.html#cb112-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb112-5"><a href="geom_detect.html#cb112-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb112-6"><a href="geom_detect.html#cb112-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-7"><a href="geom_detect.html#cb112-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb112-8"><a href="geom_detect.html#cb112-8" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs <span class="sc">%&gt;%</span> </span>
<span id="cb112-9"><a href="geom_detect.html#cb112-9" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb112-10"><a href="geom_detect.html#cb112-10" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb112-11"><a href="geom_detect.html#cb112-11" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-12"><a href="geom_detect.html#cb112-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-13"><a href="geom_detect.html#cb112-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-14"><a href="geom_detect.html#cb112-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb112-15"><a href="geom_detect.html#cb112-15" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb112-16"><a href="geom_detect.html#cb112-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb112-17"><a href="geom_detect.html#cb112-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-136-1.png" alt="" width="1008" /></p>
<p>plot the watershed candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="geom_detect.html#cb113-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb113-2"><a href="geom_detect.html#cb113-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb113-3"><a href="geom_detect.html#cb113-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb113-4"><a href="geom_detect.html#cb113-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb113-5"><a href="geom_detect.html#cb113-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb113-6"><a href="geom_detect.html#cb113-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb113-7"><a href="geom_detect.html#cb113-7" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs <span class="sc">%&gt;%</span> </span>
<span id="cb113-8"><a href="geom_detect.html#cb113-8" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb113-9"><a href="geom_detect.html#cb113-9" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb113-10"><a href="geom_detect.html#cb113-10" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb113-11"><a href="geom_detect.html#cb113-11" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb113-12"><a href="geom_detect.html#cb113-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb113-13"><a href="geom_detect.html#cb113-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb113-14"><a href="geom_detect.html#cb113-14" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb113-15"><a href="geom_detect.html#cb113-15" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-138-1.png" alt="" width="1008" /></p>
<p>nice…we are getting close.</p>
</div>
<div id="dbscan-segmentation-demonstration" class="section level3 hasAnchor" number="4.2.3">
<h3><span class="header-section-number">4.2.3</span> DBSCAN Segmentation Demonstration<a href="geom_detect.html#dbscan-segmentation-demonstration" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s go through the DBSCAN segmentation process using <code>dbscan::dbscan()</code> which uses a kd-tree for efficient processing. As an aside, the <code>RANN</code> <a href="https://jefferislab.github.io/RANN/">package</a> enables KD-tree searching/processing using the X and Y coordinates of the entire point cloud to build the tree which is a super-fast way to find the <code>x</code> number of near neighbors for each point in an input dataset (see <code>RANN::nn2()</code>).</p>
<p>because the DBSCAN process is a point-based clustering algorithm that groups points based on their spatial density we need to convert the raster cells into a 2D point set using the cell centroids first</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="geom_detect.html#cb114-1" tabindex="-1"></a><span class="do">## XY df</span></span>
<span id="cb114-2"><a href="geom_detect.html#cb114-2" tabindex="-1"></a>xy_df_temp <span class="ot">&lt;-</span> </span>
<span id="cb114-3"><a href="geom_detect.html#cb114-3" tabindex="-1"></a>  aoi_chm_rast_slice <span class="sc">%&gt;%</span> </span>
<span id="cb114-4"><a href="geom_detect.html#cb114-4" tabindex="-1"></a>  <span class="co"># na.rm = T ensures we only process cells with CHM data</span></span>
<span id="cb114-5"><a href="geom_detect.html#cb114-5" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy =</span> T, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb114-6"><a href="geom_detect.html#cb114-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb114-7"><a href="geom_detect.html#cb114-7" tabindex="-1"></a>    <span class="at">X=</span>x,<span class="at">Y=</span>y</span>
<span id="cb114-8"><a href="geom_detect.html#cb114-8" tabindex="-1"></a>    , <span class="at">f=</span><span class="dv">3</span></span>
<span id="cb114-9"><a href="geom_detect.html#cb114-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb114-10"><a href="geom_detect.html#cb114-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y)</span>
<span id="cb114-11"><a href="geom_detect.html#cb114-11" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb114-12"><a href="geom_detect.html#cb114-12" tabindex="-1"></a>xy_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 27,616
## Columns: 2
## $ X &lt;dbl&gt; 499324.0, 499324.0, 499324.0, 499330.2, 499330.4, 499330.5, 499324.0…
## $ Y &lt;dbl&gt; 4317856, 4317856, 4317856, 4317856, 4317856, 4317856, 4317856, 43178…</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="geom_detect.html#cb116-1" tabindex="-1"></a><span class="co"># ggplot2::ggplot(data = xy_df_temp, mapping = ggplot2::aes(x=X,y=Y)) + ggplot2::geom_point(shape=&quot;.&quot;)</span></span></code></pre></div>
<p>now, we can apply the <code>dbscan::dbscan()</code> function using the parameters we identified using our dynamic process defined in <code>get_segmentation_params()</code></p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="geom_detect.html#cb117-1" tabindex="-1"></a><span class="co"># get_segmentation_params_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb117-2"><a href="geom_detect.html#cb117-2" tabindex="-1"></a><span class="co"># ?dbscan::dbscan</span></span>
<span id="cb117-3"><a href="geom_detect.html#cb117-3" tabindex="-1"></a>dbscan_ans_temp <span class="ot">&lt;-</span> dbscan<span class="sc">::</span><span class="fu">dbscan</span>(</span>
<span id="cb117-4"><a href="geom_detect.html#cb117-4" tabindex="-1"></a>  <span class="at">x =</span> xy_df_temp</span>
<span id="cb117-5"><a href="geom_detect.html#cb117-5" tabindex="-1"></a>  <span class="co"># eps primarily controls the spatial extent of a cluster, </span></span>
<span id="cb117-6"><a href="geom_detect.html#cb117-6" tabindex="-1"></a>  <span class="co"># as it defines how far points can be from each other to be considered part of the same dense region.</span></span>
<span id="cb117-7"><a href="geom_detect.html#cb117-7" tabindex="-1"></a>  , <span class="at">eps =</span> get_segmentation_params_ans<span class="sc">$</span>dbscan<span class="sc">$</span>eps</span>
<span id="cb117-8"><a href="geom_detect.html#cb117-8" tabindex="-1"></a>  <span class="co"># minPts primarily controls the minimum density of a cluster, </span></span>
<span id="cb117-9"><a href="geom_detect.html#cb117-9" tabindex="-1"></a>  <span class="co"># as it dictates how many points must be packed together within that eps radius.</span></span>
<span id="cb117-10"><a href="geom_detect.html#cb117-10" tabindex="-1"></a>  , <span class="at">minPts =</span> get_segmentation_params_ans<span class="sc">$</span>dbscan<span class="sc">$</span>minPts</span>
<span id="cb117-11"><a href="geom_detect.html#cb117-11" tabindex="-1"></a>)</span>
<span id="cb117-12"><a href="geom_detect.html#cb117-12" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb117-13"><a href="geom_detect.html#cb117-13" tabindex="-1"></a>dbscan_ans_temp <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code></pre></div>
<pre><code>## List of 5
##  $ cluster     : int [1:27616] 0 0 0 1 1 1 0 1 1 1 ...
##  $ eps         : num 0.15
##  $ minPts      : num 7
##  $ metric      : chr &quot;euclidean&quot;
##  $ borderPoints: logi TRUE
##  - attr(*, &quot;class&quot;)= chr [1:2] &quot;dbscan_fast&quot; &quot;dbscan&quot;</code></pre>
<p>the result is a vector with a <code>cluster</code> identifier for each point we provided to the algorithm</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="geom_detect.html#cb119-1" tabindex="-1"></a><span class="fu">identical</span>(</span>
<span id="cb119-2"><a href="geom_detect.html#cb119-2" tabindex="-1"></a>  <span class="fu">length</span>(dbscan_ans_temp<span class="sc">$</span>cluster)</span>
<span id="cb119-3"><a href="geom_detect.html#cb119-3" tabindex="-1"></a>  , <span class="fu">nrow</span>(xy_df_temp)</span>
<span id="cb119-4"><a href="geom_detect.html#cb119-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>add the cluster identifier to the XY point data</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="geom_detect.html#cb121-1" tabindex="-1"></a><span class="co"># add the cluster to the data</span></span>
<span id="cb121-2"><a href="geom_detect.html#cb121-2" tabindex="-1"></a>xy_df_temp<span class="sc">$</span>cluster <span class="ot">&lt;-</span> dbscan_ans_temp<span class="sc">$</span>cluster</span>
<span id="cb121-3"><a href="geom_detect.html#cb121-3" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb121-4"><a href="geom_detect.html#cb121-4" tabindex="-1"></a>xy_df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb121-5"><a href="geom_detect.html#cb121-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb121-6"><a href="geom_detect.html#cb121-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb121-7"><a href="geom_detect.html#cb121-7" tabindex="-1"></a>  <span class="fu">head</span>()</span></code></pre></div>
<pre><code>##   cluster    n
## 1     102 2398
## 2     118 2303
## 3     119 1821
## 4     181 1785
## 5     108 1754
## 6     107 1539</code></pre>
<p>to maintain processing consistency with the watershed result, we’ll rasterize the XY data back to the original CHM grid. this will result in a raster with cells segmented and given the unique identifier.</p>
<p><em>Note</em>: the cells/segments classified as noise from the <code>dbscan::dbscan()</code> algorithm are marked with a cluster identifier as “0”…we’ll remove these prior to rasterizing</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="geom_detect.html#cb123-1" tabindex="-1"></a><span class="co"># fill the rast with the cluster values</span></span>
<span id="cb123-2"><a href="geom_detect.html#cb123-2" tabindex="-1"></a>dbscan_segs <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb123-3"><a href="geom_detect.html#cb123-3" tabindex="-1"></a>  <span class="at">x =</span> xy_df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb123-4"><a href="geom_detect.html#cb123-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cluster<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-5"><a href="geom_detect.html#cb123-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>), <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast_slice), <span class="at">remove =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb123-6"><a href="geom_detect.html#cb123-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb123-7"><a href="geom_detect.html#cb123-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb123-8"><a href="geom_detect.html#cb123-8" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb123-9"><a href="geom_detect.html#cb123-9" tabindex="-1"></a>  , <span class="at">y =</span> aoi_chm_rast_slice</span>
<span id="cb123-10"><a href="geom_detect.html#cb123-10" tabindex="-1"></a>  , <span class="at">field =</span> <span class="st">&quot;cluster&quot;</span></span>
<span id="cb123-11"><a href="geom_detect.html#cb123-11" tabindex="-1"></a>)</span></code></pre></div>
<p>the result is a raster with cells segmented and given a unique identifier</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="geom_detect.html#cb124-1" tabindex="-1"></a><span class="co"># this is a raster</span></span>
<span id="cb124-2"><a href="geom_detect.html#cb124-2" tabindex="-1"></a>dbscan_segs</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 1483, 768, 1  (nrow, ncol, nlyr)
## resolution  : 0.1, 0.1  (x, y)
## extent      : 499310.2, 499387, 4317710, 4317858  (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N (EPSG:32613) 
## source(s)   : memory
## varname     : aoi_chm_rast 
## name        : last 
## min value   :    1 
## max value   :  200</code></pre>
<p>each value should be a unique “segment” which we can refine based on rules of expected size and shape of piles</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="geom_detect.html#cb126-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(dbscan_segs) <span class="sc">%&gt;%</span> </span>
<span id="cb126-2"><a href="geom_detect.html#cb126-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(count)) <span class="sc">%&gt;%</span> </span>
<span id="cb126-3"><a href="geom_detect.html#cb126-3" tabindex="-1"></a>  <span class="fu">head</span>()</span></code></pre></div>
<pre><code>##   layer value count
## 1     1   102  2398
## 2     1   118  2303
## 3     1   119  1821
## 4     1   181  1785
## 5     1   108  1754
## 6     1   107  1539</code></pre>
<p>where the “value” is the segment identifier and the count is the number of raster cells assigned to that segment (compare to the count of the segmented points above ;)</p>
<p>how many predicted segments are there?</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="geom_detect.html#cb128-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(dbscan_segs) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 200</code></pre>
<p>let’s plot the raster of the dbscan segmentation</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="geom_detect.html#cb130-1" tabindex="-1"></a>dbscan_segs <span class="sc">%&gt;%</span> </span>
<span id="cb130-2"><a href="geom_detect.html#cb130-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.factor</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb130-3"><a href="geom_detect.html#cb130-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb130-4"><a href="geom_detect.html#cb130-4" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">c</span>(</span>
<span id="cb130-5"><a href="geom_detect.html#cb130-5" tabindex="-1"></a>      viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n =</span> terra<span class="sc">::</span><span class="fu">minmax</span>(dbscan_segs)[<span class="dv">2</span>])</span>
<span id="cb130-6"><a href="geom_detect.html#cb130-6" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">sample</span>()</span>
<span id="cb130-7"><a href="geom_detect.html#cb130-7" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb130-8"><a href="geom_detect.html#cb130-8" tabindex="-1"></a>    , <span class="at">axes =</span> F</span>
<span id="cb130-9"><a href="geom_detect.html#cb130-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-150-1.png" alt="" width="1008" /></p>
<p>plot the watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="geom_detect.html#cb131-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb131-2"><a href="geom_detect.html#cb131-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb131-3"><a href="geom_detect.html#cb131-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb131-4"><a href="geom_detect.html#cb131-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb131-5"><a href="geom_detect.html#cb131-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb131-6"><a href="geom_detect.html#cb131-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb131-7"><a href="geom_detect.html#cb131-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb131-8"><a href="geom_detect.html#cb131-8" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs <span class="sc">%&gt;%</span> </span>
<span id="cb131-9"><a href="geom_detect.html#cb131-9" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb131-10"><a href="geom_detect.html#cb131-10" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-11"><a href="geom_detect.html#cb131-11" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-12"><a href="geom_detect.html#cb131-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-13"><a href="geom_detect.html#cb131-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-14"><a href="geom_detect.html#cb131-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb131-15"><a href="geom_detect.html#cb131-15" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb131-16"><a href="geom_detect.html#cb131-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb131-17"><a href="geom_detect.html#cb131-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-151-1.png" alt="" width="1008" /></p>
<p>plot the watershed candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="geom_detect.html#cb132-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb132-2"><a href="geom_detect.html#cb132-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb132-3"><a href="geom_detect.html#cb132-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb132-4"><a href="geom_detect.html#cb132-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb132-5"><a href="geom_detect.html#cb132-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb132-6"><a href="geom_detect.html#cb132-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb132-7"><a href="geom_detect.html#cb132-7" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs <span class="sc">%&gt;%</span> </span>
<span id="cb132-8"><a href="geom_detect.html#cb132-8" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb132-9"><a href="geom_detect.html#cb132-9" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-10"><a href="geom_detect.html#cb132-10" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb132-11"><a href="geom_detect.html#cb132-11" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb132-12"><a href="geom_detect.html#cb132-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb132-13"><a href="geom_detect.html#cb132-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb132-14"><a href="geom_detect.html#cb132-14" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb132-15"><a href="geom_detect.html#cb132-15" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-153-1.png" alt="" width="1008" /></p>
<p>nice…we are getting close.</p>
</div>
<div id="comparison-of-candidate-segments" class="section level3 hasAnchor" number="4.2.4">
<h3><span class="header-section-number">4.2.4</span> Comparison of Candidate Segments<a href="geom_detect.html#comparison-of-candidate-segments" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we’ll start by converting the candidate segments to polygons</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="geom_detect.html#cb133-1" tabindex="-1"></a><span class="co"># watershed_segs</span></span>
<span id="cb133-2"><a href="geom_detect.html#cb133-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span></span>
<span id="cb133-3"><a href="geom_detect.html#cb133-3" tabindex="-1"></a>  watershed_segs <span class="sc">%&gt;%</span> </span>
<span id="cb133-4"><a href="geom_detect.html#cb133-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb133-5"><a href="geom_detect.html#cb133-5" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb133-6"><a href="geom_detect.html#cb133-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-7"><a href="geom_detect.html#cb133-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-8"><a href="geom_detect.html#cb133-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span></span>
<span id="cb133-9"><a href="geom_detect.html#cb133-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb133-10"><a href="geom_detect.html#cb133-10" tabindex="-1"></a><span class="co"># dbscan_segs</span></span>
<span id="cb133-11"><a href="geom_detect.html#cb133-11" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb133-12"><a href="geom_detect.html#cb133-12" tabindex="-1"></a>  dbscan_segs <span class="sc">%&gt;%</span> </span>
<span id="cb133-13"><a href="geom_detect.html#cb133-13" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb133-14"><a href="geom_detect.html#cb133-14" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb133-15"><a href="geom_detect.html#cb133-15" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-16"><a href="geom_detect.html#cb133-16" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-17"><a href="geom_detect.html#cb133-17" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb133-18"><a href="geom_detect.html#cb133-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span></code></pre></div>
<p>count the number of unique candidate segments from each method and summarize the area covered by all segments</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="geom_detect.html#cb134-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb134-2"><a href="geom_detect.html#cb134-2" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;watershed&quot;</span>, <span class="st">&quot;DBSCAN&quot;</span>)</span>
<span id="cb134-3"><a href="geom_detect.html#cb134-3" tabindex="-1"></a>    , <span class="at">segments =</span> <span class="fu">c</span>(</span>
<span id="cb134-4"><a href="geom_detect.html#cb134-4" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">freq</span>(watershed_segs) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb134-5"><a href="geom_detect.html#cb134-5" tabindex="-1"></a>      , terra<span class="sc">::</span><span class="fu">freq</span>(dbscan_segs) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb134-6"><a href="geom_detect.html#cb134-6" tabindex="-1"></a>    )</span>
<span id="cb134-7"><a href="geom_detect.html#cb134-7" tabindex="-1"></a>    , <span class="at">area =</span> <span class="fu">c</span>(</span>
<span id="cb134-8"><a href="geom_detect.html#cb134-8" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb134-9"><a href="geom_detect.html#cb134-9" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb134-10"><a href="geom_detect.html#cb134-10" tabindex="-1"></a>    )</span>
<span id="cb134-11"><a href="geom_detect.html#cb134-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb134-12"><a href="geom_detect.html#cb134-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb134-13"><a href="geom_detect.html#cb134-13" tabindex="-1"></a>    <span class="at">segments =</span> scales<span class="sc">::</span><span class="fu">comma</span>(segments,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb134-14"><a href="geom_detect.html#cb134-14" tabindex="-1"></a>    , <span class="at">area =</span> scales<span class="sc">::</span><span class="fu">comma</span>(area,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb134-15"><a href="geom_detect.html#cb134-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb134-16"><a href="geom_detect.html#cb134-16" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb134-17"><a href="geom_detect.html#cb134-17" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Demonstration area candidate segments by method&quot;</span></span>
<span id="cb134-18"><a href="geom_detect.html#cb134-18" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb134-19"><a href="geom_detect.html#cb134-19" tabindex="-1"></a>      <span class="st">&quot;method&quot;</span>, <span class="st">&quot;candidate segments&quot;</span>, <span class="st">&quot;area (m&lt;sup&gt;2&lt;/sup&gt;)&quot;</span></span>
<span id="cb134-20"><a href="geom_detect.html#cb134-20" tabindex="-1"></a>    )</span>
<span id="cb134-21"><a href="geom_detect.html#cb134-21" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb134-22"><a href="geom_detect.html#cb134-22" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb134-23"><a href="geom_detect.html#cb134-23" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-157">Table 4.1: </span>Demonstration area candidate segments by method
</caption>
<thead>
<tr>
<th style="text-align:left;">
method
</th>
<th style="text-align:left;">
candidate segments
</th>
<th style="text-align:left;">
area (m<sup>2</sup>)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
watershed
</td>
<td style="text-align:left;">
214
</td>
<td style="text-align:left;">
276.16
</td>
</tr>
<tr>
<td style="text-align:left;">
DBSCAN
</td>
<td style="text-align:left;">
200
</td>
<td style="text-align:left;">
274.16
</td>
</tr>
</tbody>
</table>
<p>notice the dbscan segments cover a smaller area because noise points are identified and removed as part of the algorithm. in the next stage of our method, we’ll include additional noise removal applied to both methodologies. In fact, all processing will be the same from here forward for both segementation methodologies.</p>
</div>
<div id="segmentation-function" class="section level3 hasAnchor" number="4.2.5">
<h3><span class="header-section-number">4.2.5</span> Segmentation Function<a href="geom_detect.html#segmentation-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s make a function to perform either the watershed (<code>lidR::watershed()</code>) or DBSCAN (<code>dbscan::dbscan()</code>) segmentation given an input CHM raster, target height range, and target area range. the output will include a raster and <code>sf</code> polygons of the candidate segments</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="geom_detect.html#cb135-1" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-2"><a href="geom_detect.html#cb135-2" tabindex="-1"></a><span class="co"># DBSCAN function</span></span>
<span id="cb135-3"><a href="geom_detect.html#cb135-3" tabindex="-1"></a><span class="co"># to align input of raster and output of raster as in lidR::watershed()</span></span>
<span id="cb135-4"><a href="geom_detect.html#cb135-4" tabindex="-1"></a><span class="co"># this enables dbscan, typically a point-based method, </span></span>
<span id="cb135-5"><a href="geom_detect.html#cb135-5" tabindex="-1"></a><span class="co"># to be implemented with raster input data by using cell centroids</span></span>
<span id="cb135-6"><a href="geom_detect.html#cb135-6" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-7"><a href="geom_detect.html#cb135-7" tabindex="-1"></a>get_segs_dbscan <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb135-8"><a href="geom_detect.html#cb135-8" tabindex="-1"></a>  chm_rast</span>
<span id="cb135-9"><a href="geom_detect.html#cb135-9" tabindex="-1"></a>  , eps</span>
<span id="cb135-10"><a href="geom_detect.html#cb135-10" tabindex="-1"></a>  , minPts</span>
<span id="cb135-11"><a href="geom_detect.html#cb135-11" tabindex="-1"></a>) {</span>
<span id="cb135-12"><a href="geom_detect.html#cb135-12" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-13"><a href="geom_detect.html#cb135-13" tabindex="-1"></a>  <span class="co"># check raster</span></span>
<span id="cb135-14"><a href="geom_detect.html#cb135-14" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-15"><a href="geom_detect.html#cb135-15" tabindex="-1"></a>  <span class="co"># convert to SpatRaster if input is from &#39;raster&#39; package</span></span>
<span id="cb135-16"><a href="geom_detect.html#cb135-16" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-17"><a href="geom_detect.html#cb135-17" tabindex="-1"></a>    <span class="fu">inherits</span>(chm_rast, <span class="st">&quot;RasterStack&quot;</span>) </span>
<span id="cb135-18"><a href="geom_detect.html#cb135-18" tabindex="-1"></a>    <span class="sc">||</span> <span class="fu">inherits</span>(chm_rast, <span class="st">&quot;RasterBrick&quot;</span>)</span>
<span id="cb135-19"><a href="geom_detect.html#cb135-19" tabindex="-1"></a>  ){</span>
<span id="cb135-20"><a href="geom_detect.html#cb135-20" tabindex="-1"></a>    chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(chm_rast)</span>
<span id="cb135-21"><a href="geom_detect.html#cb135-21" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb135-22"><a href="geom_detect.html#cb135-22" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; must be a SpatRaster from the `terra` package&quot;</span>)</span>
<span id="cb135-23"><a href="geom_detect.html#cb135-23" tabindex="-1"></a>  }</span>
<span id="cb135-24"><a href="geom_detect.html#cb135-24" tabindex="-1"></a>  <span class="co"># first layer only</span></span>
<span id="cb135-25"><a href="geom_detect.html#cb135-25" tabindex="-1"></a>  <span class="cf">if</span>(terra<span class="sc">::</span><span class="fu">nlyr</span>(chm_rast)<span class="sc">&gt;</span><span class="dv">1</span>){<span class="fu">warning</span>(<span class="st">&quot;...only using first layer of raster stack for segmentation&quot;</span>)}</span>
<span id="cb135-26"><a href="geom_detect.html#cb135-26" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>)</span>
<span id="cb135-27"><a href="geom_detect.html#cb135-27" tabindex="-1"></a>  <span class="co"># na check</span></span>
<span id="cb135-28"><a href="geom_detect.html#cb135-28" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-29"><a href="geom_detect.html#cb135-29" tabindex="-1"></a>    <span class="fu">as.numeric</span>(terra<span class="sc">::</span><span class="fu">global</span>(chm_rast, <span class="at">fun =</span> <span class="st">&quot;isNA&quot;</span>)) <span class="sc">==</span> terra<span class="sc">::</span><span class="fu">ncell</span>(chm_rast) </span>
<span id="cb135-30"><a href="geom_detect.html#cb135-30" tabindex="-1"></a>    <span class="co"># || as.numeric(terra::global(chm_rast, fun = &quot;isNA&quot;)) &gt;= round(terra::ncell(chm_rast)*0.98)</span></span>
<span id="cb135-31"><a href="geom_detect.html#cb135-31" tabindex="-1"></a>  ){</span>
<span id="cb135-32"><a href="geom_detect.html#cb135-32" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; has all missing values&quot;</span>)</span>
<span id="cb135-33"><a href="geom_detect.html#cb135-33" tabindex="-1"></a>  }</span>
<span id="cb135-34"><a href="geom_detect.html#cb135-34" tabindex="-1"></a>  </span>
<span id="cb135-35"><a href="geom_detect.html#cb135-35" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-36"><a href="geom_detect.html#cb135-36" tabindex="-1"></a>  <span class="co"># get cell centroids as points</span></span>
<span id="cb135-37"><a href="geom_detect.html#cb135-37" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-38"><a href="geom_detect.html#cb135-38" tabindex="-1"></a>  <span class="do">## XY df</span></span>
<span id="cb135-39"><a href="geom_detect.html#cb135-39" tabindex="-1"></a>  xy_df_temp <span class="ot">&lt;-</span> </span>
<span id="cb135-40"><a href="geom_detect.html#cb135-40" tabindex="-1"></a>    chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb135-41"><a href="geom_detect.html#cb135-41" tabindex="-1"></a>    <span class="co"># na.rm = T ensures we only process cells with CHM data</span></span>
<span id="cb135-42"><a href="geom_detect.html#cb135-42" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy =</span> T, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb135-43"><a href="geom_detect.html#cb135-43" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb135-44"><a href="geom_detect.html#cb135-44" tabindex="-1"></a>      <span class="at">X=</span>x,<span class="at">Y=</span>y</span>
<span id="cb135-45"><a href="geom_detect.html#cb135-45" tabindex="-1"></a>      , <span class="at">f=</span><span class="dv">3</span></span>
<span id="cb135-46"><a href="geom_detect.html#cb135-46" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-47"><a href="geom_detect.html#cb135-47" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y)</span>
<span id="cb135-48"><a href="geom_detect.html#cb135-48" tabindex="-1"></a>  <span class="co"># huh?</span></span>
<span id="cb135-49"><a href="geom_detect.html#cb135-49" tabindex="-1"></a>  <span class="co"># xy_df_temp %&gt;% dplyr::glimpse()</span></span>
<span id="cb135-50"><a href="geom_detect.html#cb135-50" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot(data = xy_df_temp, mapping = ggplot2::aes(x=X,y=Y)) + ggplot2::geom_point(shape=&quot;.&quot;)</span></span>
<span id="cb135-51"><a href="geom_detect.html#cb135-51" tabindex="-1"></a>  </span>
<span id="cb135-52"><a href="geom_detect.html#cb135-52" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(xy_df_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; has all missing values&quot;</span>)}</span>
<span id="cb135-53"><a href="geom_detect.html#cb135-53" tabindex="-1"></a>  </span>
<span id="cb135-54"><a href="geom_detect.html#cb135-54" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-55"><a href="geom_detect.html#cb135-55" tabindex="-1"></a>  <span class="co"># dbscan::dbscan()</span></span>
<span id="cb135-56"><a href="geom_detect.html#cb135-56" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-57"><a href="geom_detect.html#cb135-57" tabindex="-1"></a>  <span class="co"># ?dbscan::dbscan</span></span>
<span id="cb135-58"><a href="geom_detect.html#cb135-58" tabindex="-1"></a>  dbscan_ans_temp <span class="ot">&lt;-</span> dbscan<span class="sc">::</span><span class="fu">dbscan</span>(</span>
<span id="cb135-59"><a href="geom_detect.html#cb135-59" tabindex="-1"></a>    <span class="at">x =</span> xy_df_temp</span>
<span id="cb135-60"><a href="geom_detect.html#cb135-60" tabindex="-1"></a>    <span class="co"># eps primarily controls the spatial extent of a cluster, </span></span>
<span id="cb135-61"><a href="geom_detect.html#cb135-61" tabindex="-1"></a>    <span class="co"># as it defines how far points can be from each other to be considered part of the same dense region.</span></span>
<span id="cb135-62"><a href="geom_detect.html#cb135-62" tabindex="-1"></a>    , <span class="at">eps =</span> eps</span>
<span id="cb135-63"><a href="geom_detect.html#cb135-63" tabindex="-1"></a>    <span class="co"># minPts primarily controls the minimum density of a cluster, </span></span>
<span id="cb135-64"><a href="geom_detect.html#cb135-64" tabindex="-1"></a>    <span class="co"># as it dictates how many points must be packed together within that eps radius.</span></span>
<span id="cb135-65"><a href="geom_detect.html#cb135-65" tabindex="-1"></a>    , <span class="at">minPts =</span> minPts</span>
<span id="cb135-66"><a href="geom_detect.html#cb135-66" tabindex="-1"></a>  )</span>
<span id="cb135-67"><a href="geom_detect.html#cb135-67" tabindex="-1"></a>  <span class="co"># ensure the result is a vector with a `cluster` identifier for each point we provided to the algorithm</span></span>
<span id="cb135-68"><a href="geom_detect.html#cb135-68" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-69"><a href="geom_detect.html#cb135-69" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">identical</span>(</span>
<span id="cb135-70"><a href="geom_detect.html#cb135-70" tabindex="-1"></a>      <span class="fu">length</span>(dbscan_ans_temp<span class="sc">$</span>cluster)</span>
<span id="cb135-71"><a href="geom_detect.html#cb135-71" tabindex="-1"></a>      , <span class="fu">nrow</span>(xy_df_temp)</span>
<span id="cb135-72"><a href="geom_detect.html#cb135-72" tabindex="-1"></a>    )</span>
<span id="cb135-73"><a href="geom_detect.html#cb135-73" tabindex="-1"></a>  ){</span>
<span id="cb135-74"><a href="geom_detect.html#cb135-74" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;dbscan::dbscan() length mismatch&quot;</span>)</span>
<span id="cb135-75"><a href="geom_detect.html#cb135-75" tabindex="-1"></a>  }</span>
<span id="cb135-76"><a href="geom_detect.html#cb135-76" tabindex="-1"></a>  <span class="co"># add the cluster identifier to the XY point data</span></span>
<span id="cb135-77"><a href="geom_detect.html#cb135-77" tabindex="-1"></a>  xy_df_temp<span class="sc">$</span>cluster <span class="ot">&lt;-</span> dbscan_ans_temp<span class="sc">$</span>cluster</span>
<span id="cb135-78"><a href="geom_detect.html#cb135-78" tabindex="-1"></a>  <span class="co"># # what?</span></span>
<span id="cb135-79"><a href="geom_detect.html#cb135-79" tabindex="-1"></a>  <span class="co"># xy_df_temp %&gt;% </span></span>
<span id="cb135-80"><a href="geom_detect.html#cb135-80" tabindex="-1"></a>  <span class="co">#   dplyr::count(cluster) %&gt;% </span></span>
<span id="cb135-81"><a href="geom_detect.html#cb135-81" tabindex="-1"></a>  <span class="co">#   dplyr::arrange(desc(n)) %&gt;% </span></span>
<span id="cb135-82"><a href="geom_detect.html#cb135-82" tabindex="-1"></a>  <span class="co">#   head()</span></span>
<span id="cb135-83"><a href="geom_detect.html#cb135-83" tabindex="-1"></a>  </span>
<span id="cb135-84"><a href="geom_detect.html#cb135-84" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-85"><a href="geom_detect.html#cb135-85" tabindex="-1"></a>    <span class="fu">nrow</span>( xy_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(cluster<span class="sc">!=</span><span class="dv">0</span>) ) <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb135-86"><a href="geom_detect.html#cb135-86" tabindex="-1"></a>  ){</span>
<span id="cb135-87"><a href="geom_detect.html#cb135-87" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;dbscan::dbscan() result is all noise based on &#39;eps&#39; and &#39;minPts&#39;. try adjusting these parameters.&quot;</span>)</span>
<span id="cb135-88"><a href="geom_detect.html#cb135-88" tabindex="-1"></a>  }</span>
<span id="cb135-89"><a href="geom_detect.html#cb135-89" tabindex="-1"></a>  </span>
<span id="cb135-90"><a href="geom_detect.html#cb135-90" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-91"><a href="geom_detect.html#cb135-91" tabindex="-1"></a>  <span class="co"># back to raster data</span></span>
<span id="cb135-92"><a href="geom_detect.html#cb135-92" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-93"><a href="geom_detect.html#cb135-93" tabindex="-1"></a>  <span class="co"># to maintain processing consistency with the watershed result</span></span>
<span id="cb135-94"><a href="geom_detect.html#cb135-94" tabindex="-1"></a>    <span class="co"># we&#39;ll rasterize the XY data back to the original CHM grid</span></span>
<span id="cb135-95"><a href="geom_detect.html#cb135-95" tabindex="-1"></a>    <span class="co"># this will result in a raster with cells segmented and given the unique identifier. </span></span>
<span id="cb135-96"><a href="geom_detect.html#cb135-96" tabindex="-1"></a>    <span class="co"># *Note*: the cells/segments classified as noise from the `dbscan::dbscan()` </span></span>
<span id="cb135-97"><a href="geom_detect.html#cb135-97" tabindex="-1"></a>    <span class="co"># algorithm are marked with a cluster identifier as &quot;0&quot;...we&#39;ll remove these prior to rasterizing</span></span>
<span id="cb135-98"><a href="geom_detect.html#cb135-98" tabindex="-1"></a>  <span class="co"># fill the rast with the cluster values</span></span>
<span id="cb135-99"><a href="geom_detect.html#cb135-99" tabindex="-1"></a>  dbscan_segs <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb135-100"><a href="geom_detect.html#cb135-100" tabindex="-1"></a>    <span class="at">x =</span> xy_df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb135-101"><a href="geom_detect.html#cb135-101" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(cluster<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-102"><a href="geom_detect.html#cb135-102" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>), <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(chm_rast), <span class="at">remove =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb135-103"><a href="geom_detect.html#cb135-103" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb135-104"><a href="geom_detect.html#cb135-104" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb135-105"><a href="geom_detect.html#cb135-105" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb135-106"><a href="geom_detect.html#cb135-106" tabindex="-1"></a>    , <span class="at">y =</span> chm_rast</span>
<span id="cb135-107"><a href="geom_detect.html#cb135-107" tabindex="-1"></a>    , <span class="at">field =</span> <span class="st">&quot;cluster&quot;</span></span>
<span id="cb135-108"><a href="geom_detect.html#cb135-108" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-109"><a href="geom_detect.html#cb135-109" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;cluster&quot;</span>)</span>
<span id="cb135-110"><a href="geom_detect.html#cb135-110" tabindex="-1"></a>  <span class="co"># the result is a raster with cells segmented and given a unique identifier</span></span>
<span id="cb135-111"><a href="geom_detect.html#cb135-111" tabindex="-1"></a>  <span class="co"># this is a raster</span></span>
<span id="cb135-112"><a href="geom_detect.html#cb135-112" tabindex="-1"></a>  <span class="co"># dbscan_segs</span></span>
<span id="cb135-113"><a href="geom_detect.html#cb135-113" tabindex="-1"></a>  <span class="fu">return</span>(dbscan_segs)</span>
<span id="cb135-114"><a href="geom_detect.html#cb135-114" tabindex="-1"></a>}</span>
<span id="cb135-115"><a href="geom_detect.html#cb135-115" tabindex="-1"></a><span class="co"># # ?dbscan::dbscan</span></span>
<span id="cb135-116"><a href="geom_detect.html#cb135-116" tabindex="-1"></a><span class="co"># get_segs_dbscan(aoi_chm_rast_slice, minPts = 5, eps = 1) %&gt;% </span></span>
<span id="cb135-117"><a href="geom_detect.html#cb135-117" tabindex="-1"></a><span class="co">#   terra::as.factor() %&gt;% </span></span>
<span id="cb135-118"><a href="geom_detect.html#cb135-118" tabindex="-1"></a><span class="co">#   terra::plot(legend = F, col = grDevices::rainbow(n=111) %&gt;% sample() )</span></span>
<span id="cb135-119"><a href="geom_detect.html#cb135-119" tabindex="-1"></a></span>
<span id="cb135-120"><a href="geom_detect.html#cb135-120" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-121"><a href="geom_detect.html#cb135-121" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-122"><a href="geom_detect.html#cb135-122" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-123"><a href="geom_detect.html#cb135-123" tabindex="-1"></a><span class="co"># handle !inMemory input rasters</span></span>
<span id="cb135-124"><a href="geom_detect.html#cb135-124" tabindex="-1"></a><span class="co"># !terra::inMemory(rast) means that the raster is not loaded into RAM and is (potentially) too large to do so</span></span>
<span id="cb135-125"><a href="geom_detect.html#cb135-125" tabindex="-1"></a><span class="co"># `lidR::watershed()` &quot;Cannot segment the trees from a raster stored on disk. Use segment_trees() or load the raster in memory&quot;</span></span>
<span id="cb135-126"><a href="geom_detect.html#cb135-126" tabindex="-1"></a><span class="co"># make a workflow to:</span></span>
<span id="cb135-127"><a href="geom_detect.html#cb135-127" tabindex="-1"></a><span class="co"># 1) check terra::inMemory():</span></span>
<span id="cb135-128"><a href="geom_detect.html#cb135-128" tabindex="-1"></a><span class="co">#   - if already loaded, run lidR::watershed() as-is to bypass tiling step and return watershed segments</span></span>
<span id="cb135-129"><a href="geom_detect.html#cb135-129" tabindex="-1"></a><span class="co"># 2) if !inMemory, use terra::makeTiles() to make raster chunks with buffers that overlap neighboring tiles</span></span>
<span id="cb135-130"><a href="geom_detect.html#cb135-130" tabindex="-1"></a><span class="co"># 3) each tile is processed individually using lidR::watershed() with segments converted to polygons</span></span>
<span id="cb135-131"><a href="geom_detect.html#cb135-131" tabindex="-1"></a><span class="co"># 4) separate segments into &quot;hold out&quot; (entirely within the core, non-buffer) and &quot;boundary&quot; (any overlap with buffer) groups</span></span>
<span id="cb135-132"><a href="geom_detect.html#cb135-132" tabindex="-1"></a><span class="co"># 5) for boundary segments: any segments that overlap are compared with only the largest segment kept (smaller, overlapping discarded) using terra::pairs()</span></span>
<span id="cb135-133"><a href="geom_detect.html#cb135-133" tabindex="-1"></a><span class="co"># 6) final set of segments combines the hold outs with the processed boundary segments and return rasterized segments to match lidR::watershed() output</span></span>
<span id="cb135-134"><a href="geom_detect.html#cb135-134" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-135"><a href="geom_detect.html#cb135-135" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-136"><a href="geom_detect.html#cb135-136" tabindex="-1"></a></span>
<span id="cb135-137"><a href="geom_detect.html#cb135-137" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-138"><a href="geom_detect.html#cb135-138" tabindex="-1"></a><span class="co"># intermediate function to set tile size based on raster size and mem available</span></span>
<span id="cb135-139"><a href="geom_detect.html#cb135-139" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-140"><a href="geom_detect.html#cb135-140" tabindex="-1"></a>get_tile_size <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb135-141"><a href="geom_detect.html#cb135-141" tabindex="-1"></a>  rast</span>
<span id="cb135-142"><a href="geom_detect.html#cb135-142" tabindex="-1"></a>  , <span class="at">memory_risk =</span> <span class="fl">0.35</span></span>
<span id="cb135-143"><a href="geom_detect.html#cb135-143" tabindex="-1"></a>  <span class="co"># low risk (0.01 – 0.20): creates more tiles but is unlikely to crash R</span></span>
<span id="cb135-144"><a href="geom_detect.html#cb135-144" tabindex="-1"></a>  <span class="co"># med risk (0.2-0.5): reserves ~95% of free RAM for the remaining calculations</span></span>
<span id="cb135-145"><a href="geom_detect.html#cb135-145" tabindex="-1"></a>  <span class="co"># high risk (0.5-0.7): fewer tiles but more likely to crash R</span></span>
<span id="cb135-146"><a href="geom_detect.html#cb135-146" tabindex="-1"></a>  <span class="co"># dangerous (&gt;0.7): very likely to crash R</span></span>
<span id="cb135-147"><a href="geom_detect.html#cb135-147" tabindex="-1"></a>){</span>
<span id="cb135-148"><a href="geom_detect.html#cb135-148" tabindex="-1"></a>  <span class="co"># is file path or current terra obj?</span></span>
<span id="cb135-149"><a href="geom_detect.html#cb135-149" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">inherits</span>(rast, <span class="st">&quot;character&quot;</span>) <span class="sc">&amp;&amp;</span> stringr<span class="sc">::</span><span class="fu">str_ends</span>(rast,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.tif$|</span><span class="sc">\\</span><span class="st">.tiff$&quot;</span>)) {</span>
<span id="cb135-150"><a href="geom_detect.html#cb135-150" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(rast)) {</span>
<span id="cb135-151"><a href="geom_detect.html#cb135-151" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;the provided file path does not exist.&quot;</span>)</span>
<span id="cb135-152"><a href="geom_detect.html#cb135-152" tabindex="-1"></a>    }</span>
<span id="cb135-153"><a href="geom_detect.html#cb135-153" tabindex="-1"></a>    my_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(rast)</span>
<span id="cb135-154"><a href="geom_detect.html#cb135-154" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">inherits</span>(rast, <span class="st">&quot;SpatRaster&quot;</span>)) {</span>
<span id="cb135-155"><a href="geom_detect.html#cb135-155" tabindex="-1"></a>    my_rast <span class="ot">&lt;-</span> rast</span>
<span id="cb135-156"><a href="geom_detect.html#cb135-156" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb135-157"><a href="geom_detect.html#cb135-157" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;&#39;rast&#39; must be a .tif|.tiff file path string or a SpatRaster object.&quot;</span>)</span>
<span id="cb135-158"><a href="geom_detect.html#cb135-158" tabindex="-1"></a>  }</span>
<span id="cb135-159"><a href="geom_detect.html#cb135-159" tabindex="-1"></a>  </span>
<span id="cb135-160"><a href="geom_detect.html#cb135-160" tabindex="-1"></a>  <span class="co"># terra::free_RAM() returns the amount of RAM that is available in Bytes</span></span>
<span id="cb135-161"><a href="geom_detect.html#cb135-161" tabindex="-1"></a>  <span class="co"># ?terra::free_RAM</span></span>
<span id="cb135-162"><a href="geom_detect.html#cb135-162" tabindex="-1"></a>  free_ram <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">free_RAM</span>()</span>
<span id="cb135-163"><a href="geom_detect.html#cb135-163" tabindex="-1"></a>  </span>
<span id="cb135-164"><a href="geom_detect.html#cb135-164" tabindex="-1"></a>  <span class="co"># logic: (available ram * risk tolerance) / bytes per double-precision pixel (8)</span></span>
<span id="cb135-165"><a href="geom_detect.html#cb135-165" tabindex="-1"></a>  <span class="co"># higher risk tolerance allows more pixels per tile, reducing total tile count</span></span>
<span id="cb135-166"><a href="geom_detect.html#cb135-166" tabindex="-1"></a>  max_pixels <span class="ot">&lt;-</span> (free_ram <span class="sc">*</span> memory_risk) <span class="sc">/</span> <span class="dv">8</span></span>
<span id="cb135-167"><a href="geom_detect.html#cb135-167" tabindex="-1"></a>  </span>
<span id="cb135-168"><a href="geom_detect.html#cb135-168" tabindex="-1"></a>  <span class="co"># calculate tile dimension</span></span>
<span id="cb135-169"><a href="geom_detect.html#cb135-169" tabindex="-1"></a>  <span class="co"># sqrt to define side length in pixels</span></span>
<span id="cb135-170"><a href="geom_detect.html#cb135-170" tabindex="-1"></a>  optimal_side <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(max_pixels))</span>
<span id="cb135-171"><a href="geom_detect.html#cb135-171" tabindex="-1"></a>  </span>
<span id="cb135-172"><a href="geom_detect.html#cb135-172" tabindex="-1"></a>  <span class="co"># specify the number of rows and columns for each tile (1 or 2 numbers if the number of rows and columns is not the same)</span></span>
<span id="cb135-173"><a href="geom_detect.html#cb135-173" tabindex="-1"></a>  <span class="co"># ?terra::makeTiles &#39;y&#39; argument</span></span>
<span id="cb135-174"><a href="geom_detect.html#cb135-174" tabindex="-1"></a>  <span class="co"># limit the tile size at the actual raster dimensions</span></span>
<span id="cb135-175"><a href="geom_detect.html#cb135-175" tabindex="-1"></a>  optimal_side <span class="ot">&lt;-</span> <span class="fu">min</span>(optimal_side, terra<span class="sc">::</span><span class="fu">nrow</span>(my_rast), terra<span class="sc">::</span><span class="fu">ncol</span>(my_rast))</span>
<span id="cb135-176"><a href="geom_detect.html#cb135-176" tabindex="-1"></a>  </span>
<span id="cb135-177"><a href="geom_detect.html#cb135-177" tabindex="-1"></a>  <span class="co"># total tile count based on rast size</span></span>
<span id="cb135-178"><a href="geom_detect.html#cb135-178" tabindex="-1"></a>  n_tiles_cols <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(terra<span class="sc">::</span><span class="fu">ncol</span>(my_rast) <span class="sc">/</span> optimal_side)</span>
<span id="cb135-179"><a href="geom_detect.html#cb135-179" tabindex="-1"></a>  n_tiles_rows <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(terra<span class="sc">::</span><span class="fu">nrow</span>(my_rast) <span class="sc">/</span> optimal_side)</span>
<span id="cb135-180"><a href="geom_detect.html#cb135-180" tabindex="-1"></a>  </span>
<span id="cb135-181"><a href="geom_detect.html#cb135-181" tabindex="-1"></a>  <span class="co"># message(paste0(&quot;current free ram: &quot;, round(free_ram / 1e9, 2), &quot; gb&quot;))</span></span>
<span id="cb135-182"><a href="geom_detect.html#cb135-182" tabindex="-1"></a>  <span class="co"># message(paste0(&quot;memory risk: &quot;, memory_risk))</span></span>
<span id="cb135-183"><a href="geom_detect.html#cb135-183" tabindex="-1"></a>  <span class="co"># message(paste0(&quot;my tile size: &quot;, optimal_side, &quot; pixels&quot;))</span></span>
<span id="cb135-184"><a href="geom_detect.html#cb135-184" tabindex="-1"></a>  </span>
<span id="cb135-185"><a href="geom_detect.html#cb135-185" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb135-186"><a href="geom_detect.html#cb135-186" tabindex="-1"></a>    <span class="co"># tile_size = number of rows and columns for each zone in terra::makeTiles &#39;y&#39; argument</span></span>
<span id="cb135-187"><a href="geom_detect.html#cb135-187" tabindex="-1"></a>    <span class="at">tile_size =</span> optimal_side</span>
<span id="cb135-188"><a href="geom_detect.html#cb135-188" tabindex="-1"></a>    , <span class="at">total_tiles =</span> n_tiles_cols <span class="sc">*</span> n_tiles_rows</span>
<span id="cb135-189"><a href="geom_detect.html#cb135-189" tabindex="-1"></a>  ))</span>
<span id="cb135-190"><a href="geom_detect.html#cb135-190" tabindex="-1"></a>}</span>
<span id="cb135-191"><a href="geom_detect.html#cb135-191" tabindex="-1"></a><span class="co"># get_tile_size(bhef_chm_rast)</span></span>
<span id="cb135-192"><a href="geom_detect.html#cb135-192" tabindex="-1"></a><span class="co"># get_tile_size(bhef_chm_rast, memory_risk = 0.3)</span></span>
<span id="cb135-193"><a href="geom_detect.html#cb135-193" tabindex="-1"></a><span class="co"># get_tile_size(psinf_chm_rast, memory_risk = 0.3)</span></span>
<span id="cb135-194"><a href="geom_detect.html#cb135-194" tabindex="-1"></a><span class="co"># get_tile_size(psinf_chm_rast, memory_risk = 0.3)[[&quot;tile_size&quot;]]</span></span>
<span id="cb135-195"><a href="geom_detect.html#cb135-195" tabindex="-1"></a></span>
<span id="cb135-196"><a href="geom_detect.html#cb135-196" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-197"><a href="geom_detect.html#cb135-197" tabindex="-1"></a><span class="co"># lidR::watershed or tile and lidR::watershed</span></span>
<span id="cb135-198"><a href="geom_detect.html#cb135-198" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-199"><a href="geom_detect.html#cb135-199" tabindex="-1"></a><span class="co"># lidR::watershed(chm = aoi_chm_rast)() %&gt;% terra::freq() %&gt;% dplyr::glimpse()</span></span>
<span id="cb135-200"><a href="geom_detect.html#cb135-200" tabindex="-1"></a>get_segs_watershed <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb135-201"><a href="geom_detect.html#cb135-201" tabindex="-1"></a>  chm_rast</span>
<span id="cb135-202"><a href="geom_detect.html#cb135-202" tabindex="-1"></a>  , tol</span>
<span id="cb135-203"><a href="geom_detect.html#cb135-203" tabindex="-1"></a>  , ext</span>
<span id="cb135-204"><a href="geom_detect.html#cb135-204" tabindex="-1"></a>  <span class="co"># in case file is not in-memory, how big should tile buffers be?</span></span>
<span id="cb135-205"><a href="geom_detect.html#cb135-205" tabindex="-1"></a>  <span class="co"># set to maximum expected target object diameter</span></span>
<span id="cb135-206"><a href="geom_detect.html#cb135-206" tabindex="-1"></a>  , <span class="at">buffer_m =</span> <span class="dv">10</span></span>
<span id="cb135-207"><a href="geom_detect.html#cb135-207" tabindex="-1"></a>){</span>
<span id="cb135-208"><a href="geom_detect.html#cb135-208" tabindex="-1"></a>  <span class="co"># is file path or current terra obj?</span></span>
<span id="cb135-209"><a href="geom_detect.html#cb135-209" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">inherits</span>(chm_rast, <span class="st">&quot;character&quot;</span>) <span class="sc">&amp;&amp;</span> stringr<span class="sc">::</span><span class="fu">str_ends</span>(chm_rast,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.tif$|</span><span class="sc">\\</span><span class="st">.tiff$&quot;</span>)) {</span>
<span id="cb135-210"><a href="geom_detect.html#cb135-210" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(chm_rast)) {</span>
<span id="cb135-211"><a href="geom_detect.html#cb135-211" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;the provided file path does not exist.&quot;</span>)</span>
<span id="cb135-212"><a href="geom_detect.html#cb135-212" tabindex="-1"></a>    }</span>
<span id="cb135-213"><a href="geom_detect.html#cb135-213" tabindex="-1"></a>    chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(chm_rast)</span>
<span id="cb135-214"><a href="geom_detect.html#cb135-214" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">inherits</span>(chm_rast, <span class="st">&quot;SpatRaster&quot;</span>)) {</span>
<span id="cb135-215"><a href="geom_detect.html#cb135-215" tabindex="-1"></a>    chm_rast <span class="ot">&lt;-</span> chm_rast</span>
<span id="cb135-216"><a href="geom_detect.html#cb135-216" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb135-217"><a href="geom_detect.html#cb135-217" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;&#39;chm_rast&#39; must be a .tif|.tiff file path string or a SpatRaster object.&quot;</span>)</span>
<span id="cb135-218"><a href="geom_detect.html#cb135-218" tabindex="-1"></a>  }</span>
<span id="cb135-219"><a href="geom_detect.html#cb135-219" tabindex="-1"></a></span>
<span id="cb135-220"><a href="geom_detect.html#cb135-220" tabindex="-1"></a>  <span class="co"># memory check and direct processing</span></span>
<span id="cb135-221"><a href="geom_detect.html#cb135-221" tabindex="-1"></a>  <span class="co"># if the raster is already in memory, process directly to avoid tiling</span></span>
<span id="cb135-222"><a href="geom_detect.html#cb135-222" tabindex="-1"></a>  <span class="cf">if</span>(terra<span class="sc">::</span><span class="fu">inMemory</span>(chm_rast)) {</span>
<span id="cb135-223"><a href="geom_detect.html#cb135-223" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Raster is already in memory. Processing directly with lidR::watershed().&quot;</span>)</span>
<span id="cb135-224"><a href="geom_detect.html#cb135-224" tabindex="-1"></a>    segs_rast <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb135-225"><a href="geom_detect.html#cb135-225" tabindex="-1"></a>      <span class="at">chm =</span> chm_rast</span>
<span id="cb135-226"><a href="geom_detect.html#cb135-226" tabindex="-1"></a>      <span class="co"># th_tree = Threshold below which a pixel cannot be a tree. Default is 2.</span></span>
<span id="cb135-227"><a href="geom_detect.html#cb135-227" tabindex="-1"></a>      , <span class="at">th_tree =</span> <span class="fl">0.01</span></span>
<span id="cb135-228"><a href="geom_detect.html#cb135-228" tabindex="-1"></a>      <span class="co"># tol = minimum height of the object in the units of image intensity between its highest point (seed) </span></span>
<span id="cb135-229"><a href="geom_detect.html#cb135-229" tabindex="-1"></a>        <span class="co"># and the point where it contacts another object (checked for every contact pixel). </span></span>
<span id="cb135-230"><a href="geom_detect.html#cb135-230" tabindex="-1"></a>        <span class="co"># If the height is smaller than the tolerance, the object will be combined with one of its neighbors, which is the highest.</span></span>
<span id="cb135-231"><a href="geom_detect.html#cb135-231" tabindex="-1"></a>        <span class="co"># Tolerance should be chosen according to the range of x</span></span>
<span id="cb135-232"><a href="geom_detect.html#cb135-232" tabindex="-1"></a>      , <span class="at">tol =</span> tol <span class="co"># max_ht_m-min_ht_m</span></span>
<span id="cb135-233"><a href="geom_detect.html#cb135-233" tabindex="-1"></a>      <span class="co"># ext = Radius of the neighborhood in pixels for the detection of neighboring objects. </span></span>
<span id="cb135-234"><a href="geom_detect.html#cb135-234" tabindex="-1"></a>        <span class="co"># Higher value smoothes out small objects.</span></span>
<span id="cb135-235"><a href="geom_detect.html#cb135-235" tabindex="-1"></a>      , <span class="at">ext =</span> ext <span class="co"># 1</span></span>
<span id="cb135-236"><a href="geom_detect.html#cb135-236" tabindex="-1"></a>    )()</span>
<span id="cb135-237"><a href="geom_detect.html#cb135-237" tabindex="-1"></a>    <span class="co"># match names of get_segs_dbscan()</span></span>
<span id="cb135-238"><a href="geom_detect.html#cb135-238" tabindex="-1"></a>    <span class="fu">names</span>(segs_rast) <span class="ot">&lt;-</span> <span class="st">&quot;cluster&quot;</span></span>
<span id="cb135-239"><a href="geom_detect.html#cb135-239" tabindex="-1"></a>    </span>
<span id="cb135-240"><a href="geom_detect.html#cb135-240" tabindex="-1"></a>    <span class="fu">return</span>(segs_rast)</span>
<span id="cb135-241"><a href="geom_detect.html#cb135-241" tabindex="-1"></a>  }</span>
<span id="cb135-242"><a href="geom_detect.html#cb135-242" tabindex="-1"></a></span>
<span id="cb135-243"><a href="geom_detect.html#cb135-243" tabindex="-1"></a>  <span class="co"># tiling setup</span></span>
<span id="cb135-244"><a href="geom_detect.html#cb135-244" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;raster is on disk (not inMemory). starting tile processing...&quot;</span>)</span>
<span id="cb135-245"><a href="geom_detect.html#cb135-245" tabindex="-1"></a>  tile_dir <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="st">&quot;tiles_&quot;</span>)</span>
<span id="cb135-246"><a href="geom_detect.html#cb135-246" tabindex="-1"></a>  <span class="fu">dir.create</span>(tile_dir,<span class="at">showWarnings =</span> F)</span>
<span id="cb135-247"><a href="geom_detect.html#cb135-247" tabindex="-1"></a>  poly_dir <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">tempfile</span>(<span class="st">&quot;polys_&quot;</span>)</span>
<span id="cb135-248"><a href="geom_detect.html#cb135-248" tabindex="-1"></a>  <span class="fu">dir.create</span>(poly_dir,<span class="at">showWarnings =</span> F)</span>
<span id="cb135-249"><a href="geom_detect.html#cb135-249" tabindex="-1"></a>  </span>
<span id="cb135-250"><a href="geom_detect.html#cb135-250" tabindex="-1"></a>  <span class="co"># tile size, dynamically breaks the raster into 10 regions...might not work for realllllly huge rasters</span></span>
<span id="cb135-251"><a href="geom_detect.html#cb135-251" tabindex="-1"></a>  <span class="co"># tile_size &lt;- c(</span></span>
<span id="cb135-252"><a href="geom_detect.html#cb135-252" tabindex="-1"></a>  <span class="co">#     round(terra::nrow(chm_rast)/10)</span></span>
<span id="cb135-253"><a href="geom_detect.html#cb135-253" tabindex="-1"></a>  <span class="co">#     , round(terra::ncol(chm_rast)/10)</span></span>
<span id="cb135-254"><a href="geom_detect.html#cb135-254" tabindex="-1"></a>  <span class="co">#   )</span></span>
<span id="cb135-255"><a href="geom_detect.html#cb135-255" tabindex="-1"></a>  </span>
<span id="cb135-256"><a href="geom_detect.html#cb135-256" tabindex="-1"></a>  <span class="co"># get_tile_size()...might work for realllllly huge rasters</span></span>
<span id="cb135-257"><a href="geom_detect.html#cb135-257" tabindex="-1"></a>  tile_size <span class="ot">&lt;-</span> <span class="fu">get_tile_size</span>(chm_rast, <span class="at">memory_risk =</span> <span class="fl">0.65</span>)[[<span class="st">&quot;tile_size&quot;</span>]]</span>
<span id="cb135-258"><a href="geom_detect.html#cb135-258" tabindex="-1"></a>  tile_radius_cells <span class="ot">&lt;-</span> <span class="fu">ceiling</span>( tile_size<span class="sc">/</span><span class="dv">2</span> ) <span class="co"># tile radius</span></span>
<span id="cb135-259"><a href="geom_detect.html#cb135-259" tabindex="-1"></a>  </span>
<span id="cb135-260"><a href="geom_detect.html#cb135-260" tabindex="-1"></a>  <span class="co"># need to make sure the buffer isn&#39;t larger than the tile radius...otherwise there&#39;s no point in tiling because we&#39;re processing a similarly large area</span></span>
<span id="cb135-261"><a href="geom_detect.html#cb135-261" tabindex="-1"></a>  <span class="co"># The number of additional rows and columns added to each tile. </span></span>
<span id="cb135-262"><a href="geom_detect.html#cb135-262" tabindex="-1"></a>  </span>
<span id="cb135-263"><a href="geom_detect.html#cb135-263" tabindex="-1"></a>  buffer_size <span class="ot">&lt;-</span> <span class="fu">min</span>(</span>
<span id="cb135-264"><a href="geom_detect.html#cb135-264" tabindex="-1"></a>    <span class="fu">round</span>(buffer_m<span class="sc">/</span>terra<span class="sc">::</span><span class="fu">res</span>(chm_rast)[<span class="dv">1</span>])</span>
<span id="cb135-265"><a href="geom_detect.html#cb135-265" tabindex="-1"></a>    , tile_radius_cells</span>
<span id="cb135-266"><a href="geom_detect.html#cb135-266" tabindex="-1"></a>  )</span>
<span id="cb135-267"><a href="geom_detect.html#cb135-267" tabindex="-1"></a>  </span>
<span id="cb135-268"><a href="geom_detect.html#cb135-268" tabindex="-1"></a>  <span class="co"># generate buffered tiles on disk</span></span>
<span id="cb135-269"><a href="geom_detect.html#cb135-269" tabindex="-1"></a>  <span class="co"># ?terra::makeTiles</span></span>
<span id="cb135-270"><a href="geom_detect.html#cb135-270" tabindex="-1"></a>  tile_files <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">makeTiles</span>(</span>
<span id="cb135-271"><a href="geom_detect.html#cb135-271" tabindex="-1"></a>    <span class="at">x =</span> chm_rast</span>
<span id="cb135-272"><a href="geom_detect.html#cb135-272" tabindex="-1"></a>    <span class="co"># specify rows and columns for tiles in pixels/cells</span></span>
<span id="cb135-273"><a href="geom_detect.html#cb135-273" tabindex="-1"></a>    , <span class="at">y =</span> tile_size</span>
<span id="cb135-274"><a href="geom_detect.html#cb135-274" tabindex="-1"></a>    , <span class="at">filename =</span> <span class="fu">file.path</span>(tile_dir, <span class="st">&quot;tile_.tif&quot;</span>)</span>
<span id="cb135-275"><a href="geom_detect.html#cb135-275" tabindex="-1"></a>    , <span class="at">buffer =</span> buffer_size</span>
<span id="cb135-276"><a href="geom_detect.html#cb135-276" tabindex="-1"></a>    , <span class="at">overwrite =</span> T</span>
<span id="cb135-277"><a href="geom_detect.html#cb135-277" tabindex="-1"></a>    , <span class="at">na.rm =</span> T</span>
<span id="cb135-278"><a href="geom_detect.html#cb135-278" tabindex="-1"></a>  )</span>
<span id="cb135-279"><a href="geom_detect.html#cb135-279" tabindex="-1"></a>  </span>
<span id="cb135-280"><a href="geom_detect.html#cb135-280" tabindex="-1"></a>  <span class="co"># process of each tile and save segmented polygons to disk</span></span>
<span id="cb135-281"><a href="geom_detect.html#cb135-281" tabindex="-1"></a>  <span class="co"># result of purrr::map_chr is a list of file names</span></span>
<span id="cb135-282"><a href="geom_detect.html#cb135-282" tabindex="-1"></a>  poly_files <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_chr</span>(</span>
<span id="cb135-283"><a href="geom_detect.html#cb135-283" tabindex="-1"></a>    tile_files</span>
<span id="cb135-284"><a href="geom_detect.html#cb135-284" tabindex="-1"></a>    , <span class="cf">function</span>(t_path) {</span>
<span id="cb135-285"><a href="geom_detect.html#cb135-285" tabindex="-1"></a>      <span class="co"># load tile</span></span>
<span id="cb135-286"><a href="geom_detect.html#cb135-286" tabindex="-1"></a>      tile_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(t_path)</span>
<span id="cb135-287"><a href="geom_detect.html#cb135-287" tabindex="-1"></a>      tile_rast <span class="ot">&lt;-</span> tile_rast<span class="sc">*</span><span class="dv">1</span> <span class="co"># force tile into memory</span></span>
<span id="cb135-288"><a href="geom_detect.html#cb135-288" tabindex="-1"></a>      <span class="co"># if nothing, save no file path</span></span>
<span id="cb135-289"><a href="geom_detect.html#cb135-289" tabindex="-1"></a>      <span class="cf">if</span>(</span>
<span id="cb135-290"><a href="geom_detect.html#cb135-290" tabindex="-1"></a>        <span class="fu">as.numeric</span>(terra<span class="sc">::</span><span class="fu">global</span>(tile_rast, <span class="at">fun =</span> <span class="st">&quot;isNA&quot;</span>)) <span class="sc">==</span> terra<span class="sc">::</span><span class="fu">ncell</span>(tile_rast) </span>
<span id="cb135-291"><a href="geom_detect.html#cb135-291" tabindex="-1"></a>      ){ <span class="fu">return</span>(<span class="fu">as.character</span>(<span class="cn">NA</span>)) }</span>
<span id="cb135-292"><a href="geom_detect.html#cb135-292" tabindex="-1"></a>      <span class="co"># run watershed </span></span>
<span id="cb135-293"><a href="geom_detect.html#cb135-293" tabindex="-1"></a>      segs_rast <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb135-294"><a href="geom_detect.html#cb135-294" tabindex="-1"></a>        <span class="at">chm =</span> tile_rast</span>
<span id="cb135-295"><a href="geom_detect.html#cb135-295" tabindex="-1"></a>        <span class="co"># th_tree = Threshold below which a pixel cannot be a tree. Default is 2.</span></span>
<span id="cb135-296"><a href="geom_detect.html#cb135-296" tabindex="-1"></a>        , <span class="at">th_tree =</span> <span class="fl">0.01</span></span>
<span id="cb135-297"><a href="geom_detect.html#cb135-297" tabindex="-1"></a>        <span class="co"># tol = minimum height of the object in the units of image intensity between its highest point (seed) </span></span>
<span id="cb135-298"><a href="geom_detect.html#cb135-298" tabindex="-1"></a>          <span class="co"># and the point where it contacts another object (checked for every contact pixel). </span></span>
<span id="cb135-299"><a href="geom_detect.html#cb135-299" tabindex="-1"></a>          <span class="co"># If the height is smaller than the tolerance, the object will be combined with one of its neighbors, which is the highest.</span></span>
<span id="cb135-300"><a href="geom_detect.html#cb135-300" tabindex="-1"></a>          <span class="co"># Tolerance should be chosen according to the range of x</span></span>
<span id="cb135-301"><a href="geom_detect.html#cb135-301" tabindex="-1"></a>        , <span class="at">tol =</span> tol <span class="co"># max_ht_m-min_ht_m</span></span>
<span id="cb135-302"><a href="geom_detect.html#cb135-302" tabindex="-1"></a>        <span class="co"># ext = Radius of the neighborhood in pixels for the detection of neighboring objects. </span></span>
<span id="cb135-303"><a href="geom_detect.html#cb135-303" tabindex="-1"></a>          <span class="co"># Higher value smoothes out small objects.</span></span>
<span id="cb135-304"><a href="geom_detect.html#cb135-304" tabindex="-1"></a>        , <span class="at">ext =</span> ext <span class="co"># 1</span></span>
<span id="cb135-305"><a href="geom_detect.html#cb135-305" tabindex="-1"></a>      )()</span>
<span id="cb135-306"><a href="geom_detect.html#cb135-306" tabindex="-1"></a>      <span class="co"># match names of get_segs_dbscan()</span></span>
<span id="cb135-307"><a href="geom_detect.html#cb135-307" tabindex="-1"></a>      <span class="fu">names</span>(segs_rast) <span class="ot">&lt;-</span> <span class="st">&quot;cluster&quot;</span></span>
<span id="cb135-308"><a href="geom_detect.html#cb135-308" tabindex="-1"></a>      </span>
<span id="cb135-309"><a href="geom_detect.html#cb135-309" tabindex="-1"></a>      <span class="co"># convert to poly</span></span>
<span id="cb135-310"><a href="geom_detect.html#cb135-310" tabindex="-1"></a>      segs_poly <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">as.polygons</span>(segs_rast, <span class="at">values =</span> <span class="cn">TRUE</span>, <span class="at">aggregate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-311"><a href="geom_detect.html#cb135-311" tabindex="-1"></a>      </span>
<span id="cb135-312"><a href="geom_detect.html#cb135-312" tabindex="-1"></a>      <span class="co"># if nothing, save no file path</span></span>
<span id="cb135-313"><a href="geom_detect.html#cb135-313" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(segs_poly) <span class="sc">==</span> <span class="dv">0</span>){ <span class="fu">return</span>(<span class="fu">as.character</span>(<span class="cn">NA</span>)) }</span>
<span id="cb135-314"><a href="geom_detect.html#cb135-314" tabindex="-1"></a>      </span>
<span id="cb135-315"><a href="geom_detect.html#cb135-315" tabindex="-1"></a>      <span class="co"># boundary (in buffer) vs interior</span></span>
<span id="cb135-316"><a href="geom_detect.html#cb135-316" tabindex="-1"></a>      e <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(tile_rast)</span>
<span id="cb135-317"><a href="geom_detect.html#cb135-317" tabindex="-1"></a>      res <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">res</span>(tile_rast)</span>
<span id="cb135-318"><a href="geom_detect.html#cb135-318" tabindex="-1"></a>      <span class="co"># dimensions in meters of buffer</span></span>
<span id="cb135-319"><a href="geom_detect.html#cb135-319" tabindex="-1"></a>      <span class="do">## where in terra::makeTiles : </span></span>
<span id="cb135-320"><a href="geom_detect.html#cb135-320" tabindex="-1"></a>      <span class="co"># buffer = integer. The number of additional rows and columns added to each tile. Can be a single number</span></span>
<span id="cb135-321"><a href="geom_detect.html#cb135-321" tabindex="-1"></a>      <span class="co">#   , or two numbers to specify a separate number of rows and columns. </span></span>
<span id="cb135-322"><a href="geom_detect.html#cb135-322" tabindex="-1"></a>      <span class="co">#   This allows for creating overlapping tiles that can be used for computing spatial context dependent </span></span>
<span id="cb135-323"><a href="geom_detect.html#cb135-323" tabindex="-1"></a>      <span class="co">#   values with e.g. focal. The expansion is only inside x, no rows or columns outside of x are added</span></span>
<span id="cb135-324"><a href="geom_detect.html#cb135-324" tabindex="-1"></a>      <span class="co"># ?terra::makeTiles</span></span>
<span id="cb135-325"><a href="geom_detect.html#cb135-325" tabindex="-1"></a>      <span class="co"># we added a constant number of rows and columns with buffer_size</span></span>
<span id="cb135-326"><a href="geom_detect.html#cb135-326" tabindex="-1"></a>      dist_x <span class="ot">&lt;-</span> buffer_size <span class="sc">*</span> res[<span class="dv">1</span>] <span class="co"># meters</span></span>
<span id="cb135-327"><a href="geom_detect.html#cb135-327" tabindex="-1"></a>      dist_y <span class="ot">&lt;-</span> buffer_size <span class="sc">*</span> res[<span class="dv">2</span>] <span class="co"># meters</span></span>
<span id="cb135-328"><a href="geom_detect.html#cb135-328" tabindex="-1"></a>    </span>
<span id="cb135-329"><a href="geom_detect.html#cb135-329" tabindex="-1"></a>      <span class="co"># tile must be wider/taller than 2x buffer</span></span>
<span id="cb135-330"><a href="geom_detect.html#cb135-330" tabindex="-1"></a>      can_shrink_x <span class="ot">&lt;-</span> (e<span class="sc">$</span>xmax <span class="sc">-</span> e<span class="sc">$</span>xmin) <span class="sc">&gt;</span> (<span class="dv">2</span> <span class="sc">*</span> dist_x)</span>
<span id="cb135-331"><a href="geom_detect.html#cb135-331" tabindex="-1"></a>      can_shrink_y <span class="ot">&lt;-</span> (e<span class="sc">$</span>ymax <span class="sc">-</span> e<span class="sc">$</span>ymin) <span class="sc">&gt;</span> (<span class="dv">2</span> <span class="sc">*</span> dist_y)</span>
<span id="cb135-332"><a href="geom_detect.html#cb135-332" tabindex="-1"></a>      </span>
<span id="cb135-333"><a href="geom_detect.html#cb135-333" tabindex="-1"></a>      <span class="cf">if</span>(can_shrink_x <span class="sc">&amp;&amp;</span> can_shrink_y){</span>
<span id="cb135-334"><a href="geom_detect.html#cb135-334" tabindex="-1"></a>        core_ext <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(</span>
<span id="cb135-335"><a href="geom_detect.html#cb135-335" tabindex="-1"></a>          e<span class="sc">$</span>xmin <span class="sc">+</span> dist_x</span>
<span id="cb135-336"><a href="geom_detect.html#cb135-336" tabindex="-1"></a>          , e<span class="sc">$</span>xmax <span class="sc">-</span> dist_x</span>
<span id="cb135-337"><a href="geom_detect.html#cb135-337" tabindex="-1"></a>          , e<span class="sc">$</span>ymin <span class="sc">+</span> dist_y</span>
<span id="cb135-338"><a href="geom_detect.html#cb135-338" tabindex="-1"></a>          , e<span class="sc">$</span>ymax <span class="sc">-</span> dist_y</span>
<span id="cb135-339"><a href="geom_detect.html#cb135-339" tabindex="-1"></a>        )</span>
<span id="cb135-340"><a href="geom_detect.html#cb135-340" tabindex="-1"></a>        </span>
<span id="cb135-341"><a href="geom_detect.html#cb135-341" tabindex="-1"></a>        <span class="co"># ?terra::relate</span></span>
<span id="cb135-342"><a href="geom_detect.html#cb135-342" tabindex="-1"></a>        is_within <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">relate</span>(segs_poly, terra<span class="sc">::</span><span class="fu">as.polygons</span>(core_ext), <span class="at">relation =</span> <span class="st">&quot;within&quot;</span>)</span>
<span id="cb135-343"><a href="geom_detect.html#cb135-343" tabindex="-1"></a>        segs_poly<span class="sc">$</span>on_buffer <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">as.vector</span>(is_within) <span class="co"># T = boundary segments</span></span>
<span id="cb135-344"><a href="geom_detect.html#cb135-344" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb135-345"><a href="geom_detect.html#cb135-345" tabindex="-1"></a>        <span class="co"># if the tile is too small to have a core everything is a boundary segment</span></span>
<span id="cb135-346"><a href="geom_detect.html#cb135-346" tabindex="-1"></a>        segs_poly<span class="sc">$</span>on_buffer <span class="ot">&lt;-</span> T <span class="co"># T = boundary segments</span></span>
<span id="cb135-347"><a href="geom_detect.html#cb135-347" tabindex="-1"></a>      }</span>
<span id="cb135-348"><a href="geom_detect.html#cb135-348" tabindex="-1"></a>      </span>
<span id="cb135-349"><a href="geom_detect.html#cb135-349" tabindex="-1"></a>      <span class="co"># add flags for boundary processing</span></span>
<span id="cb135-350"><a href="geom_detect.html#cb135-350" tabindex="-1"></a>      segs_poly<span class="sc">$</span>poly_area <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">expanse</span>(segs_poly) <span class="co"># area of poly</span></span>
<span id="cb135-351"><a href="geom_detect.html#cb135-351" tabindex="-1"></a>      <span class="co"># give a unique id to every polygon before merging</span></span>
<span id="cb135-352"><a href="geom_detect.html#cb135-352" tabindex="-1"></a>      segs_poly<span class="sc">$</span>temp_id <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">basename</span>(t_path), <span class="st">&quot;_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(segs_poly))</span>
<span id="cb135-353"><a href="geom_detect.html#cb135-353" tabindex="-1"></a>      </span>
<span id="cb135-354"><a href="geom_detect.html#cb135-354" tabindex="-1"></a>      <span class="co"># save as temp gpkg</span></span>
<span id="cb135-355"><a href="geom_detect.html#cb135-355" tabindex="-1"></a>      out_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(poly_dir, <span class="fu">paste0</span>(<span class="fu">basename</span>(t_path), <span class="st">&quot;.gpkg&quot;</span>))</span>
<span id="cb135-356"><a href="geom_detect.html#cb135-356" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">writeVector</span>(segs_poly, out_path, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-357"><a href="geom_detect.html#cb135-357" tabindex="-1"></a>      <span class="fu">return</span>(out_path)</span>
<span id="cb135-358"><a href="geom_detect.html#cb135-358" tabindex="-1"></a>    }</span>
<span id="cb135-359"><a href="geom_detect.html#cb135-359" tabindex="-1"></a>  )</span>
<span id="cb135-360"><a href="geom_detect.html#cb135-360" tabindex="-1"></a>  <span class="co"># keep only files with polys</span></span>
<span id="cb135-361"><a href="geom_detect.html#cb135-361" tabindex="-1"></a>  poly_files <span class="ot">&lt;-</span> poly_files[<span class="sc">!</span><span class="fu">is.na</span>(poly_files)]</span>
<span id="cb135-362"><a href="geom_detect.html#cb135-362" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(poly_files)<span class="sc">==</span><span class="dv">0</span> <span class="sc">||</span> <span class="fu">all</span>(<span class="fu">is.na</span>(poly_files))){</span>
<span id="cb135-363"><a href="geom_detect.html#cb135-363" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;no segments found with `lidR::watershed()` using input data and `tol`, `ext` settings&quot;</span>)</span>
<span id="cb135-364"><a href="geom_detect.html#cb135-364" tabindex="-1"></a>  }</span>
<span id="cb135-365"><a href="geom_detect.html#cb135-365" tabindex="-1"></a>  <span class="co"># boundary segments processing</span></span>
<span id="cb135-366"><a href="geom_detect.html#cb135-366" tabindex="-1"></a>  <span class="co"># keep all core polygons since they only appear in one tile</span></span>
<span id="cb135-367"><a href="geom_detect.html#cb135-367" tabindex="-1"></a>  <span class="co"># for all polygons that are in a boundary (on_buffer), keep the largest if it overlaps with another from a neighbor tile</span></span>
<span id="cb135-368"><a href="geom_detect.html#cb135-368" tabindex="-1"></a>  <span class="co"># bring together core and processed boundary segments</span></span>
<span id="cb135-369"><a href="geom_detect.html#cb135-369" tabindex="-1"></a>  <span class="co"># message(&quot;merging tile polygons segments and processing buffer overlaps...&quot;)</span></span>
<span id="cb135-370"><a href="geom_detect.html#cb135-370" tabindex="-1"></a>  </span>
<span id="cb135-371"><a href="geom_detect.html#cb135-371" tabindex="-1"></a>  <span class="co"># final datas</span></span>
<span id="cb135-372"><a href="geom_detect.html#cb135-372" tabindex="-1"></a>  final_interior <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb135-373"><a href="geom_detect.html#cb135-373" tabindex="-1"></a>  final_boundary <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb135-374"><a href="geom_detect.html#cb135-374" tabindex="-1"></a>  </span>
<span id="cb135-375"><a href="geom_detect.html#cb135-375" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(poly_files)) {</span>
<span id="cb135-376"><a href="geom_detect.html#cb135-376" tabindex="-1"></a>    <span class="co"># read current tile polys</span></span>
<span id="cb135-377"><a href="geom_detect.html#cb135-377" tabindex="-1"></a>    current_tile_vec <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">vect</span>(poly_files[i])</span>
<span id="cb135-378"><a href="geom_detect.html#cb135-378" tabindex="-1"></a>    </span>
<span id="cb135-379"><a href="geom_detect.html#cb135-379" tabindex="-1"></a>    <span class="co"># get core/interior (no olaps possible)</span></span>
<span id="cb135-380"><a href="geom_detect.html#cb135-380" tabindex="-1"></a>    tile_interior <span class="ot">&lt;-</span> current_tile_vec[<span class="sc">!</span>current_tile_vec<span class="sc">$</span>on_buffer]</span>
<span id="cb135-381"><a href="geom_detect.html#cb135-381" tabindex="-1"></a>    <span class="co"># add to final datas</span></span>
<span id="cb135-382"><a href="geom_detect.html#cb135-382" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(final_interior)) {</span>
<span id="cb135-383"><a href="geom_detect.html#cb135-383" tabindex="-1"></a>      final_interior <span class="ot">&lt;-</span> tile_interior</span>
<span id="cb135-384"><a href="geom_detect.html#cb135-384" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb135-385"><a href="geom_detect.html#cb135-385" tabindex="-1"></a>      final_interior <span class="ot">&lt;-</span> <span class="fu">rbind</span>(final_interior, tile_interior)</span>
<span id="cb135-386"><a href="geom_detect.html#cb135-386" tabindex="-1"></a>    }</span>
<span id="cb135-387"><a href="geom_detect.html#cb135-387" tabindex="-1"></a>    </span>
<span id="cb135-388"><a href="geom_detect.html#cb135-388" tabindex="-1"></a>    <span class="co"># get boundary (olaps possible)</span></span>
<span id="cb135-389"><a href="geom_detect.html#cb135-389" tabindex="-1"></a>    tile_boundary <span class="ot">&lt;-</span> current_tile_vec[current_tile_vec<span class="sc">$</span>on_buffer]</span>
<span id="cb135-390"><a href="geom_detect.html#cb135-390" tabindex="-1"></a>    </span>
<span id="cb135-391"><a href="geom_detect.html#cb135-391" tabindex="-1"></a>    <span class="co"># compare segs in boundary on the current tile to the final, already processed segs </span></span>
<span id="cb135-392"><a href="geom_detect.html#cb135-392" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(tile_boundary) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb135-393"><a href="geom_detect.html#cb135-393" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(final_boundary)) {</span>
<span id="cb135-394"><a href="geom_detect.html#cb135-394" tabindex="-1"></a>        final_boundary <span class="ot">&lt;-</span> tile_boundary</span>
<span id="cb135-395"><a href="geom_detect.html#cb135-395" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb135-396"><a href="geom_detect.html#cb135-396" tabindex="-1"></a>        <span class="co"># compare tile_boundary against the accumulated final_boundary</span></span>
<span id="cb135-397"><a href="geom_detect.html#cb135-397" tabindex="-1"></a>        adj_matrix <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">relate</span>(tile_boundary, final_boundary, <span class="at">relation =</span> <span class="st">&quot;intersects&quot;</span>)</span>
<span id="cb135-398"><a href="geom_detect.html#cb135-398" tabindex="-1"></a>        </span>
<span id="cb135-399"><a href="geom_detect.html#cb135-399" tabindex="-1"></a>        <span class="co"># find olaps in current tile with already processed boundary segs</span></span>
<span id="cb135-400"><a href="geom_detect.html#cb135-400" tabindex="-1"></a>        has_olap <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(adj_matrix) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb135-401"><a href="geom_detect.html#cb135-401" tabindex="-1"></a>        </span>
<span id="cb135-402"><a href="geom_detect.html#cb135-402" tabindex="-1"></a>        <span class="co"># no olap keep as-is</span></span>
<span id="cb135-403"><a href="geom_detect.html#cb135-403" tabindex="-1"></a>        safe_boundary <span class="ot">&lt;-</span> tile_boundary[<span class="sc">!</span>has_olap]</span>
<span id="cb135-404"><a href="geom_detect.html#cb135-404" tabindex="-1"></a>        </span>
<span id="cb135-405"><a href="geom_detect.html#cb135-405" tabindex="-1"></a>        <span class="co"># for olaps, keep the largest seg for overlapping cluster</span></span>
<span id="cb135-406"><a href="geom_detect.html#cb135-406" tabindex="-1"></a>        <span class="cf">if</span>( <span class="fu">any</span>(has_olap) ){  </span>
<span id="cb135-407"><a href="geom_detect.html#cb135-407" tabindex="-1"></a>          olap_tile_segments <span class="ot">&lt;-</span> tile_boundary[has_olap]</span>
<span id="cb135-408"><a href="geom_detect.html#cb135-408" tabindex="-1"></a>          keeps_from_tile <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb135-409"><a href="geom_detect.html#cb135-409" tabindex="-1"></a>          remove_ids <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb135-410"><a href="geom_detect.html#cb135-410" tabindex="-1"></a>          <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(olap_tile_segments)) {</span>
<span id="cb135-411"><a href="geom_detect.html#cb135-411" tabindex="-1"></a>            <span class="co"># which final segments this tile segment touches</span></span>
<span id="cb135-412"><a href="geom_detect.html#cb135-412" tabindex="-1"></a>            match_indxs <span class="ot">&lt;-</span> <span class="fu">which</span>(adj_matrix[<span class="fu">which</span>(has_olap)[j], ] <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-413"><a href="geom_detect.html#cb135-413" tabindex="-1"></a>            matching_final_segs <span class="ot">&lt;-</span> final_boundary[match_indxs]</span>
<span id="cb135-414"><a href="geom_detect.html#cb135-414" tabindex="-1"></a>            </span>
<span id="cb135-415"><a href="geom_detect.html#cb135-415" tabindex="-1"></a>            <span class="co"># compare current seg area to the largest matching segment in the final</span></span>
<span id="cb135-416"><a href="geom_detect.html#cb135-416" tabindex="-1"></a>            max_final_area <span class="ot">&lt;-</span> <span class="fu">max</span>(matching_final_segs<span class="sc">$</span>poly_area)</span>
<span id="cb135-417"><a href="geom_detect.html#cb135-417" tabindex="-1"></a>            </span>
<span id="cb135-418"><a href="geom_detect.html#cb135-418" tabindex="-1"></a>            <span class="cf">if</span>(olap_tile_segments<span class="sc">$</span>poly_area[j] <span class="sc">&gt;</span> max_final_area) {</span>
<span id="cb135-419"><a href="geom_detect.html#cb135-419" tabindex="-1"></a>              <span class="co"># current segment is larger, mark finals for removal instead</span></span>
<span id="cb135-420"><a href="geom_detect.html#cb135-420" tabindex="-1"></a>              keeps_from_tile <span class="ot">&lt;-</span> <span class="fu">c</span>(keeps_from_tile, olap_tile_segments<span class="sc">$</span>temp_id[j])</span>
<span id="cb135-421"><a href="geom_detect.html#cb135-421" tabindex="-1"></a>              remove_ids <span class="ot">&lt;-</span> <span class="fu">c</span>(remove_ids, matching_final_segs<span class="sc">$</span>temp_id)</span>
<span id="cb135-422"><a href="geom_detect.html#cb135-422" tabindex="-1"></a>            }</span>
<span id="cb135-423"><a href="geom_detect.html#cb135-423" tabindex="-1"></a>          }</span>
<span id="cb135-424"><a href="geom_detect.html#cb135-424" tabindex="-1"></a>          <span class="co"># update final_boundary: remove smaller, add largest</span></span>
<span id="cb135-425"><a href="geom_detect.html#cb135-425" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">length</span>(remove_ids) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb135-426"><a href="geom_detect.html#cb135-426" tabindex="-1"></a>            final_boundary <span class="ot">&lt;-</span> final_boundary[<span class="sc">!</span>(final_boundary<span class="sc">$</span>temp_id <span class="sc">%in%</span> remove_ids)]</span>
<span id="cb135-427"><a href="geom_detect.html#cb135-427" tabindex="-1"></a>          }</span>
<span id="cb135-428"><a href="geom_detect.html#cb135-428" tabindex="-1"></a>          </span>
<span id="cb135-429"><a href="geom_detect.html#cb135-429" tabindex="-1"></a>          largers <span class="ot">&lt;-</span> olap_tile_segments[olap_tile_segments<span class="sc">$</span>temp_id <span class="sc">%in%</span> keeps_from_tile]</span>
<span id="cb135-430"><a href="geom_detect.html#cb135-430" tabindex="-1"></a>          final_boundary <span class="ot">&lt;-</span> <span class="fu">rbind</span>(final_boundary, safe_boundary, largers)</span>
<span id="cb135-431"><a href="geom_detect.html#cb135-431" tabindex="-1"></a>        }<span class="cf">else</span>{</span>
<span id="cb135-432"><a href="geom_detect.html#cb135-432" tabindex="-1"></a>          final_boundary <span class="ot">&lt;-</span> <span class="fu">rbind</span>(final_boundary, safe_boundary)</span>
<span id="cb135-433"><a href="geom_detect.html#cb135-433" tabindex="-1"></a>        }</span>
<span id="cb135-434"><a href="geom_detect.html#cb135-434" tabindex="-1"></a>        </span>
<span id="cb135-435"><a href="geom_detect.html#cb135-435" tabindex="-1"></a>      }</span>
<span id="cb135-436"><a href="geom_detect.html#cb135-436" tabindex="-1"></a>    }</span>
<span id="cb135-437"><a href="geom_detect.html#cb135-437" tabindex="-1"></a>    <span class="co"># clean up</span></span>
<span id="cb135-438"><a href="geom_detect.html#cb135-438" tabindex="-1"></a>    <span class="fu">rm</span>(current_tile_vec)</span>
<span id="cb135-439"><a href="geom_detect.html#cb135-439" tabindex="-1"></a>  }</span>
<span id="cb135-440"><a href="geom_detect.html#cb135-440" tabindex="-1"></a></span>
<span id="cb135-441"><a href="geom_detect.html#cb135-441" tabindex="-1"></a>  <span class="co"># combine interior with procerssed boundary segs</span></span>
<span id="cb135-442"><a href="geom_detect.html#cb135-442" tabindex="-1"></a>  final_vec <span class="ot">&lt;-</span> <span class="fu">rbind</span>(final_interior, final_boundary)</span>
<span id="cb135-443"><a href="geom_detect.html#cb135-443" tabindex="-1"></a>  final_vec<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(final_vec)</span>
<span id="cb135-444"><a href="geom_detect.html#cb135-444" tabindex="-1"></a>  </span>
<span id="cb135-445"><a href="geom_detect.html#cb135-445" tabindex="-1"></a>  final_raster <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb135-446"><a href="geom_detect.html#cb135-446" tabindex="-1"></a>    <span class="at">x =</span> final_vec</span>
<span id="cb135-447"><a href="geom_detect.html#cb135-447" tabindex="-1"></a>    , <span class="at">y =</span> chm_rast</span>
<span id="cb135-448"><a href="geom_detect.html#cb135-448" tabindex="-1"></a>    , <span class="at">field =</span> <span class="st">&quot;cluster&quot;</span></span>
<span id="cb135-449"><a href="geom_detect.html#cb135-449" tabindex="-1"></a>  )</span>
<span id="cb135-450"><a href="geom_detect.html#cb135-450" tabindex="-1"></a>  </span>
<span id="cb135-451"><a href="geom_detect.html#cb135-451" tabindex="-1"></a>  <span class="co"># clean up temp tiles</span></span>
<span id="cb135-452"><a href="geom_detect.html#cb135-452" tabindex="-1"></a>  <span class="fu">unlink</span>(tile_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-453"><a href="geom_detect.html#cb135-453" tabindex="-1"></a>  <span class="fu">unlink</span>(poly_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-454"><a href="geom_detect.html#cb135-454" tabindex="-1"></a>  </span>
<span id="cb135-455"><a href="geom_detect.html#cb135-455" tabindex="-1"></a>  <span class="fu">return</span>(final_raster)</span>
<span id="cb135-456"><a href="geom_detect.html#cb135-456" tabindex="-1"></a>}</span>
<span id="cb135-457"><a href="geom_detect.html#cb135-457" tabindex="-1"></a><span class="co"># # ?lidR::watershed</span></span>
<span id="cb135-458"><a href="geom_detect.html#cb135-458" tabindex="-1"></a><span class="co"># terra::clamp(aoi_chm_rast, upper = max_ht_m, lower = 0, values = F) %&gt;%</span></span>
<span id="cb135-459"><a href="geom_detect.html#cb135-459" tabindex="-1"></a><span class="co">#   get_segs_watershed(tol = 1, ext = 1) %&gt;%</span></span>
<span id="cb135-460"><a href="geom_detect.html#cb135-460" tabindex="-1"></a><span class="co">#   terra::plot()</span></span>
<span id="cb135-461"><a href="geom_detect.html#cb135-461" tabindex="-1"></a><span class="co"># # ceiling( sqrt(max_area_m2/pi)*2 ) # buffer_m</span></span>
<span id="cb135-462"><a href="geom_detect.html#cb135-462" tabindex="-1"></a><span class="co"># # ceiling( sqrt(666/pi)*2 ) # buffer_m</span></span>
<span id="cb135-463"><a href="geom_detect.html#cb135-463" tabindex="-1"></a><span class="co"># # round(ceiling( sqrt(666/pi)*2 )/terra::res(bhef_chm_rast)[1])</span></span>
<span id="cb135-464"><a href="geom_detect.html#cb135-464" tabindex="-1"></a><span class="co"># # get_tile_size(bhef_chm_rast, memory_risk = 0.35)[[&quot;tile_size&quot;]]</span></span>
<span id="cb135-465"><a href="geom_detect.html#cb135-465" tabindex="-1"></a><span class="co"># # ceiling( get_tile_size(bhef_chm_rast, memory_risk = 0.35)[[&quot;tile_size&quot;]]/2 ) # tile radius</span></span>
<span id="cb135-466"><a href="geom_detect.html#cb135-466" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb135-467"><a href="geom_detect.html#cb135-467" tabindex="-1"></a><span class="co"># # terra::ncell(psinf_chm_rast)</span></span>
<span id="cb135-468"><a href="geom_detect.html#cb135-468" tabindex="-1"></a><span class="co"># # terra::ncell(pj_chm_rast)</span></span>
<span id="cb135-469"><a href="geom_detect.html#cb135-469" tabindex="-1"></a><span class="co"># terra::clamp(pj_chm_rast, upper = max_ht_m, lower = 0, values = F) %&gt;%</span></span>
<span id="cb135-470"><a href="geom_detect.html#cb135-470" tabindex="-1"></a><span class="co">#   get_segs_watershed(tol = 1, ext = 1) %&gt;%</span></span>
<span id="cb135-471"><a href="geom_detect.html#cb135-471" tabindex="-1"></a><span class="co">#   terra::plot()</span></span>
<span id="cb135-472"><a href="geom_detect.html#cb135-472" tabindex="-1"></a><span class="co"># #### ! testing only...this takes a long time</span></span>
<span id="cb135-473"><a href="geom_detect.html#cb135-473" tabindex="-1"></a><span class="co"># xxx_temp &lt;- terra::clamp(bhef_chm_rast, upper = 5, lower = 0, values = F) %&gt;%</span></span>
<span id="cb135-474"><a href="geom_detect.html#cb135-474" tabindex="-1"></a><span class="co">#   get_segs_watershed(tol = 1, ext = 1, buffer_m = ceiling( sqrt(500/pi)*2 ))</span></span>
<span id="cb135-475"><a href="geom_detect.html#cb135-475" tabindex="-1"></a></span>
<span id="cb135-476"><a href="geom_detect.html#cb135-476" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-477"><a href="geom_detect.html#cb135-477" tabindex="-1"></a><span class="co"># intermediate function to check string method</span></span>
<span id="cb135-478"><a href="geom_detect.html#cb135-478" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-479"><a href="geom_detect.html#cb135-479" tabindex="-1"></a>  <span class="co"># check the `method` argument</span></span>
<span id="cb135-480"><a href="geom_detect.html#cb135-480" tabindex="-1"></a>  check_segmentation_method <span class="ot">&lt;-</span> <span class="cf">function</span>(method) {</span>
<span id="cb135-481"><a href="geom_detect.html#cb135-481" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(method,<span class="st">&quot;character&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;no method&quot;</span>)}</span>
<span id="cb135-482"><a href="geom_detect.html#cb135-482" tabindex="-1"></a>      <span class="co"># clean method</span></span>
<span id="cb135-483"><a href="geom_detect.html#cb135-483" tabindex="-1"></a>      method <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(method, <span class="st">&quot;&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb135-484"><a href="geom_detect.html#cb135-484" tabindex="-1"></a>        <span class="fu">tolower</span>() <span class="sc">%&gt;%</span></span>
<span id="cb135-485"><a href="geom_detect.html#cb135-485" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_squish</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb135-486"><a href="geom_detect.html#cb135-486" tabindex="-1"></a>        <span class="fu">unique</span>()</span>
<span id="cb135-487"><a href="geom_detect.html#cb135-487" tabindex="-1"></a>      <span class="co"># potential methods</span></span>
<span id="cb135-488"><a href="geom_detect.html#cb135-488" tabindex="-1"></a>      pot_methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;watershed&quot;</span>, <span class="st">&quot;dbscan&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb135-489"><a href="geom_detect.html#cb135-489" tabindex="-1"></a>      find_method <span class="ot">&lt;-</span> <span class="fu">paste</span>(pot_methods, <span class="at">collapse=</span><span class="st">&quot;|&quot;</span>)</span>
<span id="cb135-490"><a href="geom_detect.html#cb135-490" tabindex="-1"></a>      <span class="co"># can i find one?</span></span>
<span id="cb135-491"><a href="geom_detect.html#cb135-491" tabindex="-1"></a>      which_methods <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_extract_all</span>(<span class="at">string =</span> method, <span class="at">pattern =</span> find_method) <span class="sc">%&gt;%</span></span>
<span id="cb135-492"><a href="geom_detect.html#cb135-492" tabindex="-1"></a>        <span class="fu">unlist</span>() <span class="sc">%&gt;%</span></span>
<span id="cb135-493"><a href="geom_detect.html#cb135-493" tabindex="-1"></a>        <span class="fu">unique</span>()</span>
<span id="cb135-494"><a href="geom_detect.html#cb135-494" tabindex="-1"></a>      <span class="co"># make sure at least one is selected</span></span>
<span id="cb135-495"><a href="geom_detect.html#cb135-495" tabindex="-1"></a>      n_methods_not <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">setdiff</span>(</span>
<span id="cb135-496"><a href="geom_detect.html#cb135-496" tabindex="-1"></a>          pot_methods</span>
<span id="cb135-497"><a href="geom_detect.html#cb135-497" tabindex="-1"></a>          , which_methods</span>
<span id="cb135-498"><a href="geom_detect.html#cb135-498" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-499"><a href="geom_detect.html#cb135-499" tabindex="-1"></a>        <span class="fu">length</span>()</span>
<span id="cb135-500"><a href="geom_detect.html#cb135-500" tabindex="-1"></a>      </span>
<span id="cb135-501"><a href="geom_detect.html#cb135-501" tabindex="-1"></a>      <span class="cf">if</span>(n_methods_not<span class="sc">&gt;=</span><span class="fu">length</span>(pot_methods)){</span>
<span id="cb135-502"><a href="geom_detect.html#cb135-502" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb135-503"><a href="geom_detect.html#cb135-503" tabindex="-1"></a>          <span class="st">&quot;`method` parameter must be one of:</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb135-504"><a href="geom_detect.html#cb135-504" tabindex="-1"></a>          , <span class="st">&quot;    &quot;</span></span>
<span id="cb135-505"><a href="geom_detect.html#cb135-505" tabindex="-1"></a>          , <span class="fu">paste</span>(pot_methods, <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>)</span>
<span id="cb135-506"><a href="geom_detect.html#cb135-506" tabindex="-1"></a>        ))</span>
<span id="cb135-507"><a href="geom_detect.html#cb135-507" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb135-508"><a href="geom_detect.html#cb135-508" tabindex="-1"></a>        <span class="fu">return</span>(which_methods)</span>
<span id="cb135-509"><a href="geom_detect.html#cb135-509" tabindex="-1"></a>      }</span>
<span id="cb135-510"><a href="geom_detect.html#cb135-510" tabindex="-1"></a>  }</span>
<span id="cb135-511"><a href="geom_detect.html#cb135-511" tabindex="-1"></a><span class="co"># check_segmentation_method(c(&quot;watershed&quot;, &quot;dbscn&quot;, &quot;dbsca&quot;))</span></span>
<span id="cb135-512"><a href="geom_detect.html#cb135-512" tabindex="-1"></a><span class="co"># check_segmentation_method(&quot;dbscn&quot;)</span></span>
<span id="cb135-513"><a href="geom_detect.html#cb135-513" tabindex="-1"></a></span>
<span id="cb135-514"><a href="geom_detect.html#cb135-514" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-515"><a href="geom_detect.html#cb135-515" tabindex="-1"></a><span class="co"># intermediate function to convert rast to polygon</span></span>
<span id="cb135-516"><a href="geom_detect.html#cb135-516" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-517"><a href="geom_detect.html#cb135-517" tabindex="-1"></a>rast_to_poly <span class="ot">&lt;-</span> <span class="cf">function</span>(rast){</span>
<span id="cb135-518"><a href="geom_detect.html#cb135-518" tabindex="-1"></a>  <span class="co"># ?terra::as.polygons</span></span>
<span id="cb135-519"><a href="geom_detect.html#cb135-519" tabindex="-1"></a>  rast <span class="sc">%&gt;%</span> </span>
<span id="cb135-520"><a href="geom_detect.html#cb135-520" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb135-521"><a href="geom_detect.html#cb135-521" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb135-522"><a href="geom_detect.html#cb135-522" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb135-523"><a href="geom_detect.html#cb135-523" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb135-524"><a href="geom_detect.html#cb135-524" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb135-525"><a href="geom_detect.html#cb135-525" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span></span>
<span id="cb135-526"><a href="geom_detect.html#cb135-526" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))  </span>
<span id="cb135-527"><a href="geom_detect.html#cb135-527" tabindex="-1"></a>}</span>
<span id="cb135-528"><a href="geom_detect.html#cb135-528" tabindex="-1"></a></span>
<span id="cb135-529"><a href="geom_detect.html#cb135-529" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-530"><a href="geom_detect.html#cb135-530" tabindex="-1"></a><span class="co"># full segmentation function</span></span>
<span id="cb135-531"><a href="geom_detect.html#cb135-531" tabindex="-1"></a><span class="co"># given an input CHM raster, target height range, and target area range. </span></span>
<span id="cb135-532"><a href="geom_detect.html#cb135-532" tabindex="-1"></a><span class="co"># the output will include a raster and `sf` polygons of the candidate segments</span></span>
<span id="cb135-533"><a href="geom_detect.html#cb135-533" tabindex="-1"></a><span class="co"># automatically adjusts segmentation method parameters using get_segmentation_params()</span></span>
<span id="cb135-534"><a href="geom_detect.html#cb135-534" tabindex="-1"></a><span class="do">############################################################################</span></span>
<span id="cb135-535"><a href="geom_detect.html#cb135-535" tabindex="-1"></a>get_segmentation_candidates <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb135-536"><a href="geom_detect.html#cb135-536" tabindex="-1"></a>  chm_rast</span>
<span id="cb135-537"><a href="geom_detect.html#cb135-537" tabindex="-1"></a>  , <span class="at">method =</span> <span class="st">&quot;watershed&quot;</span> <span class="co"># &quot;watershed&quot; or &quot;dbscan&quot;</span></span>
<span id="cb135-538"><a href="geom_detect.html#cb135-538" tabindex="-1"></a>  , min_ht_m</span>
<span id="cb135-539"><a href="geom_detect.html#cb135-539" tabindex="-1"></a>  , max_ht_m</span>
<span id="cb135-540"><a href="geom_detect.html#cb135-540" tabindex="-1"></a>  , min_area_m2</span>
<span id="cb135-541"><a href="geom_detect.html#cb135-541" tabindex="-1"></a>  , max_area_m2</span>
<span id="cb135-542"><a href="geom_detect.html#cb135-542" tabindex="-1"></a>){</span>
<span id="cb135-543"><a href="geom_detect.html#cb135-543" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-544"><a href="geom_detect.html#cb135-544" tabindex="-1"></a>  <span class="co"># threshold checks</span></span>
<span id="cb135-545"><a href="geom_detect.html#cb135-545" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-546"><a href="geom_detect.html#cb135-546" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> max_ht_m[<span class="dv">1</span>] </span>
<span id="cb135-547"><a href="geom_detect.html#cb135-547" tabindex="-1"></a>  min_ht_m <span class="ot">&lt;-</span> min_ht_m[<span class="dv">1</span>] </span>
<span id="cb135-548"><a href="geom_detect.html#cb135-548" tabindex="-1"></a>  min_area_m2 <span class="ot">&lt;-</span> min_area_m2[<span class="dv">1</span>] </span>
<span id="cb135-549"><a href="geom_detect.html#cb135-549" tabindex="-1"></a>  max_area_m2 <span class="ot">&lt;-</span> max_area_m2[<span class="dv">1</span>] </span>
<span id="cb135-550"><a href="geom_detect.html#cb135-550" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-551"><a href="geom_detect.html#cb135-551" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb135-552"><a href="geom_detect.html#cb135-552" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(max_ht_m), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb135-553"><a href="geom_detect.html#cb135-553" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb135-554"><a href="geom_detect.html#cb135-554" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb135-555"><a href="geom_detect.html#cb135-555" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(min_ht_m), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb135-556"><a href="geom_detect.html#cb135-556" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_ht_m), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb135-557"><a href="geom_detect.html#cb135-557" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb135-558"><a href="geom_detect.html#cb135-558" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb135-559"><a href="geom_detect.html#cb135-559" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb135-560"><a href="geom_detect.html#cb135-560" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb135-561"><a href="geom_detect.html#cb135-561" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb135-562"><a href="geom_detect.html#cb135-562" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb135-563"><a href="geom_detect.html#cb135-563" tabindex="-1"></a>    <span class="sc">!</span>(<span class="fu">as.numeric</span>(max_ht_m) <span class="sc">&gt;</span> <span class="fu">as.numeric</span>(min_ht_m)) <span class="sc">||</span></span>
<span id="cb135-564"><a href="geom_detect.html#cb135-564" tabindex="-1"></a>    <span class="sc">!</span>(<span class="fu">as.numeric</span>(max_area_m2) <span class="sc">&gt;</span> <span class="fu">as.numeric</span>(min_area_m2)) <span class="sc">||</span></span>
<span id="cb135-565"><a href="geom_detect.html#cb135-565" tabindex="-1"></a>    <span class="fu">as.numeric</span>(max_ht_m)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb135-566"><a href="geom_detect.html#cb135-566" tabindex="-1"></a>    <span class="fu">as.numeric</span>(min_ht_m)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb135-567"><a href="geom_detect.html#cb135-567" tabindex="-1"></a>    <span class="fu">as.numeric</span>(min_area_m2)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb135-568"><a href="geom_detect.html#cb135-568" tabindex="-1"></a>    <span class="fu">as.numeric</span>(max_area_m2)<span class="sc">&lt;</span><span class="dv">0</span></span>
<span id="cb135-569"><a href="geom_detect.html#cb135-569" tabindex="-1"></a>  ){</span>
<span id="cb135-570"><a href="geom_detect.html#cb135-570" tabindex="-1"></a>    <span class="co"># Code to execute if any condition is met (e.g., print an error message)</span></span>
<span id="cb135-571"><a href="geom_detect.html#cb135-571" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Error: One or more of `min_ht_m`,`max_ht_m`,`min_area_m2`,`max_area_m2` are not valid numbers, or the conditions max_area_m2&gt;min_area_m2 or max_ht_m&gt;min_ht_m are not met.&quot;</span>)</span>
<span id="cb135-572"><a href="geom_detect.html#cb135-572" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb135-573"><a href="geom_detect.html#cb135-573" tabindex="-1"></a>    max_ht_m <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(max_ht_m)[<span class="dv">1</span>] </span>
<span id="cb135-574"><a href="geom_detect.html#cb135-574" tabindex="-1"></a>    min_ht_m <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(min_ht_m)[<span class="dv">1</span>] </span>
<span id="cb135-575"><a href="geom_detect.html#cb135-575" tabindex="-1"></a>    min_area_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(min_area_m2)[<span class="dv">1</span>] </span>
<span id="cb135-576"><a href="geom_detect.html#cb135-576" tabindex="-1"></a>    max_area_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(max_area_m2)[<span class="dv">1</span>] </span>
<span id="cb135-577"><a href="geom_detect.html#cb135-577" tabindex="-1"></a>  }</span>
<span id="cb135-578"><a href="geom_detect.html#cb135-578" tabindex="-1"></a>  </span>
<span id="cb135-579"><a href="geom_detect.html#cb135-579" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-580"><a href="geom_detect.html#cb135-580" tabindex="-1"></a>  <span class="co"># check raster</span></span>
<span id="cb135-581"><a href="geom_detect.html#cb135-581" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-582"><a href="geom_detect.html#cb135-582" tabindex="-1"></a>  <span class="co"># convert to SpatRaster if input is from &#39;raster&#39; package</span></span>
<span id="cb135-583"><a href="geom_detect.html#cb135-583" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-584"><a href="geom_detect.html#cb135-584" tabindex="-1"></a>    <span class="fu">inherits</span>(chm_rast, <span class="st">&quot;RasterStack&quot;</span>) </span>
<span id="cb135-585"><a href="geom_detect.html#cb135-585" tabindex="-1"></a>    <span class="sc">||</span> <span class="fu">inherits</span>(chm_rast, <span class="st">&quot;RasterBrick&quot;</span>)</span>
<span id="cb135-586"><a href="geom_detect.html#cb135-586" tabindex="-1"></a>  ){</span>
<span id="cb135-587"><a href="geom_detect.html#cb135-587" tabindex="-1"></a>    chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(chm_rast)</span>
<span id="cb135-588"><a href="geom_detect.html#cb135-588" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb135-589"><a href="geom_detect.html#cb135-589" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; must be a SpatRaster from the `terra` package&quot;</span>)</span>
<span id="cb135-590"><a href="geom_detect.html#cb135-590" tabindex="-1"></a>  }</span>
<span id="cb135-591"><a href="geom_detect.html#cb135-591" tabindex="-1"></a>  <span class="co"># first layer only</span></span>
<span id="cb135-592"><a href="geom_detect.html#cb135-592" tabindex="-1"></a>  <span class="cf">if</span>(terra<span class="sc">::</span><span class="fu">nlyr</span>(chm_rast)<span class="sc">&gt;</span><span class="dv">1</span>){<span class="fu">warning</span>(<span class="st">&quot;...only using first layer of raster stack for segmentation&quot;</span>)}</span>
<span id="cb135-593"><a href="geom_detect.html#cb135-593" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>)</span>
<span id="cb135-594"><a href="geom_detect.html#cb135-594" tabindex="-1"></a>  <span class="co"># na check</span></span>
<span id="cb135-595"><a href="geom_detect.html#cb135-595" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-596"><a href="geom_detect.html#cb135-596" tabindex="-1"></a>    <span class="fu">as.numeric</span>(terra<span class="sc">::</span><span class="fu">global</span>(chm_rast, <span class="at">fun =</span> <span class="st">&quot;isNA&quot;</span>)) <span class="sc">==</span> terra<span class="sc">::</span><span class="fu">ncell</span>(chm_rast) </span>
<span id="cb135-597"><a href="geom_detect.html#cb135-597" tabindex="-1"></a>    <span class="co"># || as.numeric(terra::global(chm_rast, fun = &quot;isNA&quot;)) &gt;= round(terra::ncell(chm_rast)*0.98)</span></span>
<span id="cb135-598"><a href="geom_detect.html#cb135-598" tabindex="-1"></a>  ){</span>
<span id="cb135-599"><a href="geom_detect.html#cb135-599" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; has all missing values&quot;</span>)</span>
<span id="cb135-600"><a href="geom_detect.html#cb135-600" tabindex="-1"></a>  }</span>
<span id="cb135-601"><a href="geom_detect.html#cb135-601" tabindex="-1"></a>  </span>
<span id="cb135-602"><a href="geom_detect.html#cb135-602" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-603"><a href="geom_detect.html#cb135-603" tabindex="-1"></a>  <span class="co"># check method</span></span>
<span id="cb135-604"><a href="geom_detect.html#cb135-604" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-605"><a href="geom_detect.html#cb135-605" tabindex="-1"></a>  check_segmentation_method_ans <span class="ot">&lt;-</span> <span class="fu">check_segmentation_method</span>(<span class="at">method =</span> method)</span>
<span id="cb135-606"><a href="geom_detect.html#cb135-606" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(check_segmentation_method_ans)<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb135-607"><a href="geom_detect.html#cb135-607" tabindex="-1"></a>    <span class="fu">warning</span>(</span>
<span id="cb135-608"><a href="geom_detect.html#cb135-608" tabindex="-1"></a>      <span class="fu">paste0</span>( <span class="st">&quot;...using only &quot;</span>, check_segmentation_method_ans[<span class="dv">1</span>], <span class="st">&quot; method for segmentation&quot;</span>)</span>
<span id="cb135-609"><a href="geom_detect.html#cb135-609" tabindex="-1"></a>    )</span>
<span id="cb135-610"><a href="geom_detect.html#cb135-610" tabindex="-1"></a>  }</span>
<span id="cb135-611"><a href="geom_detect.html#cb135-611" tabindex="-1"></a>  check_segmentation_method_ans <span class="ot">&lt;-</span> check_segmentation_method_ans[<span class="dv">1</span>]</span>
<span id="cb135-612"><a href="geom_detect.html#cb135-612" tabindex="-1"></a>  </span>
<span id="cb135-613"><a href="geom_detect.html#cb135-613" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-614"><a href="geom_detect.html#cb135-614" tabindex="-1"></a>  <span class="co"># slice CHM</span></span>
<span id="cb135-615"><a href="geom_detect.html#cb135-615" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-616"><a href="geom_detect.html#cb135-616" tabindex="-1"></a>  <span class="co"># lower CHM slice</span></span>
<span id="cb135-617"><a href="geom_detect.html#cb135-617" tabindex="-1"></a>  slice_chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">clamp</span>(chm_rast, <span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb135-618"><a href="geom_detect.html#cb135-618" tabindex="-1"></a>  <span class="co"># na check</span></span>
<span id="cb135-619"><a href="geom_detect.html#cb135-619" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-620"><a href="geom_detect.html#cb135-620" tabindex="-1"></a>    <span class="fu">as.numeric</span>(terra<span class="sc">::</span><span class="fu">global</span>(slice_chm_rast, <span class="at">fun =</span> <span class="st">&quot;isNA&quot;</span>)) <span class="sc">==</span> terra<span class="sc">::</span><span class="fu">ncell</span>(slice_chm_rast) </span>
<span id="cb135-621"><a href="geom_detect.html#cb135-621" tabindex="-1"></a>  ){</span>
<span id="cb135-622"><a href="geom_detect.html#cb135-622" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; has no values at or below &#39;max_ht_m&#39; value&quot;</span>)</span>
<span id="cb135-623"><a href="geom_detect.html#cb135-623" tabindex="-1"></a>  }</span>
<span id="cb135-624"><a href="geom_detect.html#cb135-624" tabindex="-1"></a>  </span>
<span id="cb135-625"><a href="geom_detect.html#cb135-625" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-626"><a href="geom_detect.html#cb135-626" tabindex="-1"></a>  <span class="co"># get_segmentation_params</span></span>
<span id="cb135-627"><a href="geom_detect.html#cb135-627" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-628"><a href="geom_detect.html#cb135-628" tabindex="-1"></a>  <span class="co"># get_segmentation_params</span></span>
<span id="cb135-629"><a href="geom_detect.html#cb135-629" tabindex="-1"></a>  seg_params_ans <span class="ot">&lt;-</span> <span class="fu">get_segmentation_params</span>(</span>
<span id="cb135-630"><a href="geom_detect.html#cb135-630" tabindex="-1"></a>      <span class="at">max_ht_m =</span> max_ht_m</span>
<span id="cb135-631"><a href="geom_detect.html#cb135-631" tabindex="-1"></a>      , <span class="at">min_ht_m =</span> min_ht_m</span>
<span id="cb135-632"><a href="geom_detect.html#cb135-632" tabindex="-1"></a>      , <span class="at">min_area_m2 =</span> min_area_m2</span>
<span id="cb135-633"><a href="geom_detect.html#cb135-633" tabindex="-1"></a>      , <span class="at">max_area_m2 =</span> max_area_m2</span>
<span id="cb135-634"><a href="geom_detect.html#cb135-634" tabindex="-1"></a>      <span class="co"># , pts_per_m2 = NULL</span></span>
<span id="cb135-635"><a href="geom_detect.html#cb135-635" tabindex="-1"></a>      , <span class="at">rast_res_m =</span> terra<span class="sc">::</span><span class="fu">res</span>(slice_chm_rast)[<span class="dv">1</span>]</span>
<span id="cb135-636"><a href="geom_detect.html#cb135-636" tabindex="-1"></a>    )</span>
<span id="cb135-637"><a href="geom_detect.html#cb135-637" tabindex="-1"></a>  <span class="co"># # huh?</span></span>
<span id="cb135-638"><a href="geom_detect.html#cb135-638" tabindex="-1"></a>  <span class="co"># dplyr::glimpse(seg_params_ans)</span></span>
<span id="cb135-639"><a href="geom_detect.html#cb135-639" tabindex="-1"></a>  </span>
<span id="cb135-640"><a href="geom_detect.html#cb135-640" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-641"><a href="geom_detect.html#cb135-641" tabindex="-1"></a>  <span class="co"># segmentation</span></span>
<span id="cb135-642"><a href="geom_detect.html#cb135-642" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-643"><a href="geom_detect.html#cb135-643" tabindex="-1"></a>  <span class="cf">if</span>(check_segmentation_method_ans<span class="sc">==</span><span class="st">&quot;watershed&quot;</span>){</span>
<span id="cb135-644"><a href="geom_detect.html#cb135-644" tabindex="-1"></a>    <span class="co"># ?EBImage::watershed</span></span>
<span id="cb135-645"><a href="geom_detect.html#cb135-645" tabindex="-1"></a>    segs_rast <span class="ot">&lt;-</span> <span class="fu">get_segs_watershed</span>(</span>
<span id="cb135-646"><a href="geom_detect.html#cb135-646" tabindex="-1"></a>      <span class="at">chm_rast =</span> slice_chm_rast</span>
<span id="cb135-647"><a href="geom_detect.html#cb135-647" tabindex="-1"></a>      , <span class="at">tol =</span> seg_params_ans<span class="sc">$</span>watershed<span class="sc">$</span>tol</span>
<span id="cb135-648"><a href="geom_detect.html#cb135-648" tabindex="-1"></a>      , <span class="at">ext =</span> seg_params_ans<span class="sc">$</span>watershed<span class="sc">$</span>ext</span>
<span id="cb135-649"><a href="geom_detect.html#cb135-649" tabindex="-1"></a>      <span class="co"># in case file is not in-memory, how big should tile buffers be?</span></span>
<span id="cb135-650"><a href="geom_detect.html#cb135-650" tabindex="-1"></a>        <span class="co"># set to maximum expected target object diameter</span></span>
<span id="cb135-651"><a href="geom_detect.html#cb135-651" tabindex="-1"></a>      , <span class="at">buffer_m =</span> <span class="fu">ceiling</span>( <span class="fu">sqrt</span>(max_area_m2<span class="sc">/</span>pi)<span class="sc">*</span><span class="dv">2</span> )</span>
<span id="cb135-652"><a href="geom_detect.html#cb135-652" tabindex="-1"></a>    )</span>
<span id="cb135-653"><a href="geom_detect.html#cb135-653" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(check_segmentation_method_ans<span class="sc">==</span><span class="st">&quot;dbscan&quot;</span>){</span>
<span id="cb135-654"><a href="geom_detect.html#cb135-654" tabindex="-1"></a>    segs_rast <span class="ot">&lt;-</span> <span class="fu">get_segs_dbscan</span>(</span>
<span id="cb135-655"><a href="geom_detect.html#cb135-655" tabindex="-1"></a>      <span class="at">chm_rast =</span> slice_chm_rast</span>
<span id="cb135-656"><a href="geom_detect.html#cb135-656" tabindex="-1"></a>      , <span class="at">eps =</span> seg_params_ans<span class="sc">$</span>dbscan<span class="sc">$</span>eps</span>
<span id="cb135-657"><a href="geom_detect.html#cb135-657" tabindex="-1"></a>      , <span class="at">minPts =</span> seg_params_ans<span class="sc">$</span>dbscan<span class="sc">$</span>minPts</span>
<span id="cb135-658"><a href="geom_detect.html#cb135-658" tabindex="-1"></a>    )</span>
<span id="cb135-659"><a href="geom_detect.html#cb135-659" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb135-660"><a href="geom_detect.html#cb135-660" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;incorrect method selected&quot;</span>)</span>
<span id="cb135-661"><a href="geom_detect.html#cb135-661" tabindex="-1"></a>  }</span>
<span id="cb135-662"><a href="geom_detect.html#cb135-662" tabindex="-1"></a>  </span>
<span id="cb135-663"><a href="geom_detect.html#cb135-663" tabindex="-1"></a>  <span class="co"># na check</span></span>
<span id="cb135-664"><a href="geom_detect.html#cb135-664" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb135-665"><a href="geom_detect.html#cb135-665" tabindex="-1"></a>    <span class="fu">as.numeric</span>(terra<span class="sc">::</span><span class="fu">global</span>(segs_rast, <span class="at">fun =</span> <span class="st">&quot;isNA&quot;</span>)) <span class="sc">==</span> terra<span class="sc">::</span><span class="fu">ncell</span>(segs_rast) </span>
<span id="cb135-666"><a href="geom_detect.html#cb135-666" tabindex="-1"></a>  ){</span>
<span id="cb135-667"><a href="geom_detect.html#cb135-667" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;no segmentation candidates detected&quot;</span>)</span>
<span id="cb135-668"><a href="geom_detect.html#cb135-668" tabindex="-1"></a>  }</span>
<span id="cb135-669"><a href="geom_detect.html#cb135-669" tabindex="-1"></a>  </span>
<span id="cb135-670"><a href="geom_detect.html#cb135-670" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-671"><a href="geom_detect.html#cb135-671" tabindex="-1"></a>  <span class="co"># rast to poly</span></span>
<span id="cb135-672"><a href="geom_detect.html#cb135-672" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-673"><a href="geom_detect.html#cb135-673" tabindex="-1"></a>  segs_sf <span class="ot">&lt;-</span> <span class="fu">rast_to_poly</span>(segs_rast)</span>
<span id="cb135-674"><a href="geom_detect.html#cb135-674" tabindex="-1"></a>  </span>
<span id="cb135-675"><a href="geom_detect.html#cb135-675" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-676"><a href="geom_detect.html#cb135-676" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb135-677"><a href="geom_detect.html#cb135-677" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb135-678"><a href="geom_detect.html#cb135-678" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb135-679"><a href="geom_detect.html#cb135-679" tabindex="-1"></a>    <span class="at">segs_rast =</span> segs_rast</span>
<span id="cb135-680"><a href="geom_detect.html#cb135-680" tabindex="-1"></a>    , <span class="at">segs_sf =</span> segs_sf</span>
<span id="cb135-681"><a href="geom_detect.html#cb135-681" tabindex="-1"></a>    , <span class="at">slice_chm_rast =</span> slice_chm_rast</span>
<span id="cb135-682"><a href="geom_detect.html#cb135-682" tabindex="-1"></a>    , <span class="at">seg_mthd_params =</span> seg_params_ans</span>
<span id="cb135-683"><a href="geom_detect.html#cb135-683" tabindex="-1"></a>  ))</span>
<span id="cb135-684"><a href="geom_detect.html#cb135-684" tabindex="-1"></a>}</span>
<span id="cb135-685"><a href="geom_detect.html#cb135-685" tabindex="-1"></a></span>
<span id="cb135-686"><a href="geom_detect.html#cb135-686" tabindex="-1"></a><span class="co"># get_segmentation_candidates(</span></span>
<span id="cb135-687"><a href="geom_detect.html#cb135-687" tabindex="-1"></a><span class="co">#   chm_rast = aoi_chm_rast</span></span>
<span id="cb135-688"><a href="geom_detect.html#cb135-688" tabindex="-1"></a><span class="co">#   , method = &quot;dbscan&quot;</span></span>
<span id="cb135-689"><a href="geom_detect.html#cb135-689" tabindex="-1"></a><span class="co">#   , min_ht_m = 1</span></span>
<span id="cb135-690"><a href="geom_detect.html#cb135-690" tabindex="-1"></a><span class="co">#   , max_ht_m = 4</span></span>
<span id="cb135-691"><a href="geom_detect.html#cb135-691" tabindex="-1"></a><span class="co">#   , min_area_m2 = 1.5^2</span></span>
<span id="cb135-692"><a href="geom_detect.html#cb135-692" tabindex="-1"></a><span class="co">#   , max_area_m2 = 55</span></span>
<span id="cb135-693"><a href="geom_detect.html#cb135-693" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div>
<p>our <code>get_segmentation_candidates()</code> is the workhorse of our methodology. it includes all input data and parameter (e.g. height, area thresholds) checks and includes the following processing steps:</p>
<ol style="list-style-type: decimal">
<li><em>CHM Height Filtering</em>: A maximum height filter is applied to the CHM to retaining only raster cells below a maximum expected slash pile height (e.g. 4 m), isolating a “slice” of the CHM.</li>
<li><em>Segmentation Method Setup</em>: Applies the dynamic parameter logic used in the Watershed or DBSCAN segmentation method. This logic ensures scale-invariant object detection by maintaining constant proportions between the algorithm search windows and the physical dimensions of the target object. This dynamic approach allows the method parameters to adapt automatically to the input data resolution so that the resulting candidate segments remain spatially consistent with target objects.</li>
<li><em>Candidate Segmentation</em>: Watershed or DBSCAN segmentation is performed on the filtered CHM raster to identify and delineate initial candidate piles based on their structural form.</li>
</ol>
</div>
</div>
<div id="candidate-shape-refinement-and-area-filtering" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Candidate Shape Refinement and Area filtering<a href="geom_detect.html#candidate-shape-refinement-and-area-filtering" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>to better align the segmentation results with real-world pile construction we’ll now simplify candidate segments composed of multiple separate parts representing a single identified feature (i.e. “multi-polygon” candidate segments. We’ll simplify these segments by retaining only the largest contiguous portion using <code>cloud2trees</code> functionality. Because slash piles are constructed as distinct, isolated objects to prevent tree mortality during burning, this refinement step isolates the primary candidate body to eliminate detached noise and ensure each segment represents a discrete physical object before area-based filtering</p>
<p>using the candidate segment polygons, apply the <code>cloud2trees::simplify_multipolygon_crowns()</code> function which keeps only the largest part of multi-polygon geometries and works for all <code>sf</code> polygon data (even though the term “crowns” is in the name)</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="geom_detect.html#cb136-1" tabindex="-1"></a><span class="co"># watershed_segs</span></span>
<span id="cb136-2"><a href="geom_detect.html#cb136-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span></span>
<span id="cb136-3"><a href="geom_detect.html#cb136-3" tabindex="-1"></a>  watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb136-4"><a href="geom_detect.html#cb136-4" tabindex="-1"></a>  <span class="co"># simplify multipolygons by keeping only the largest portion</span></span>
<span id="cb136-5"><a href="geom_detect.html#cb136-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID =</span> pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb136-6"><a href="geom_detect.html#cb136-6" tabindex="-1"></a>  cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb136-7"><a href="geom_detect.html#cb136-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb136-8"><a href="geom_detect.html#cb136-8" tabindex="-1"></a><span class="co"># dbscan_segs</span></span>
<span id="cb136-9"><a href="geom_detect.html#cb136-9" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb136-10"><a href="geom_detect.html#cb136-10" tabindex="-1"></a>  dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb136-11"><a href="geom_detect.html#cb136-11" tabindex="-1"></a>  <span class="co"># simplify multipolygons by keeping only the largest portion</span></span>
<span id="cb136-12"><a href="geom_detect.html#cb136-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID =</span> pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb136-13"><a href="geom_detect.html#cb136-13" tabindex="-1"></a>  cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb136-14"><a href="geom_detect.html#cb136-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span></code></pre></div>
<p>we’ll have the same number of unique candidate segments from each method but the area covered by those segments will now be smaller</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="geom_detect.html#cb137-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb137-2"><a href="geom_detect.html#cb137-2" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;watershed&quot;</span>, <span class="st">&quot;DBSCAN&quot;</span>)</span>
<span id="cb137-3"><a href="geom_detect.html#cb137-3" tabindex="-1"></a>    , <span class="at">segments =</span> <span class="fu">c</span>(</span>
<span id="cb137-4"><a href="geom_detect.html#cb137-4" tabindex="-1"></a>      <span class="fu">nrow</span>(watershed_segs_poly)</span>
<span id="cb137-5"><a href="geom_detect.html#cb137-5" tabindex="-1"></a>      , <span class="fu">nrow</span>(dbscan_segs_poly)</span>
<span id="cb137-6"><a href="geom_detect.html#cb137-6" tabindex="-1"></a>    )</span>
<span id="cb137-7"><a href="geom_detect.html#cb137-7" tabindex="-1"></a>    , <span class="at">area =</span> <span class="fu">c</span>(</span>
<span id="cb137-8"><a href="geom_detect.html#cb137-8" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb137-9"><a href="geom_detect.html#cb137-9" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb137-10"><a href="geom_detect.html#cb137-10" tabindex="-1"></a>    )</span>
<span id="cb137-11"><a href="geom_detect.html#cb137-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb137-12"><a href="geom_detect.html#cb137-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb137-13"><a href="geom_detect.html#cb137-13" tabindex="-1"></a>    <span class="at">segments =</span> scales<span class="sc">::</span><span class="fu">comma</span>(segments,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb137-14"><a href="geom_detect.html#cb137-14" tabindex="-1"></a>    , <span class="at">area =</span> scales<span class="sc">::</span><span class="fu">comma</span>(area,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb137-15"><a href="geom_detect.html#cb137-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb137-16"><a href="geom_detect.html#cb137-16" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb137-17"><a href="geom_detect.html#cb137-17" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Demonstration area candidate segments by method after removing noise polygon parts&quot;</span></span>
<span id="cb137-18"><a href="geom_detect.html#cb137-18" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb137-19"><a href="geom_detect.html#cb137-19" tabindex="-1"></a>      <span class="st">&quot;method&quot;</span>, <span class="st">&quot;candidate segments&quot;</span>, <span class="st">&quot;area (m&lt;sup&gt;2&lt;/sup&gt;)&quot;</span></span>
<span id="cb137-20"><a href="geom_detect.html#cb137-20" tabindex="-1"></a>    )</span>
<span id="cb137-21"><a href="geom_detect.html#cb137-21" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb137-22"><a href="geom_detect.html#cb137-22" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb137-23"><a href="geom_detect.html#cb137-23" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-160">Table 4.2: </span>Demonstration area candidate segments by method after removing noise polygon parts
</caption>
<thead>
<tr>
<th style="text-align:left;">
method
</th>
<th style="text-align:left;">
candidate segments
</th>
<th style="text-align:left;">
area (m<sup>2</sup>)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
watershed
</td>
<td style="text-align:left;">
214
</td>
<td style="text-align:left;">
273.02
</td>
</tr>
<tr>
<td style="text-align:left;">
DBSCAN
</td>
<td style="text-align:left;">
200
</td>
<td style="text-align:left;">
274.16
</td>
</tr>
</tbody>
</table>
<p>now we’ll remove all candidate segments that do not meet the area criteria based on the user-defined minimum and maximum area thresholds</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="geom_detect.html#cb138-1" tabindex="-1"></a>st_filter_area <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data, min_area_m2, max_area_m2) {</span>
<span id="cb138-2"><a href="geom_detect.html#cb138-2" tabindex="-1"></a>  <span class="co"># check input data</span></span>
<span id="cb138-3"><a href="geom_detect.html#cb138-3" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb138-4"><a href="geom_detect.html#cb138-4" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) ){</span>
<span id="cb138-5"><a href="geom_detect.html#cb138-5" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb138-6"><a href="geom_detect.html#cb138-6" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb138-7"><a href="geom_detect.html#cb138-7" tabindex="-1"></a>    ))</span>
<span id="cb138-8"><a href="geom_detect.html#cb138-8" tabindex="-1"></a>  }  </span>
<span id="cb138-9"><a href="geom_detect.html#cb138-9" tabindex="-1"></a>  <span class="co"># check thresholds</span></span>
<span id="cb138-10"><a href="geom_detect.html#cb138-10" tabindex="-1"></a>  min_area_m2 <span class="ot">&lt;-</span> min_area_m2[<span class="dv">1</span>] </span>
<span id="cb138-11"><a href="geom_detect.html#cb138-11" tabindex="-1"></a>  max_area_m2 <span class="ot">&lt;-</span> max_area_m2[<span class="dv">1</span>] </span>
<span id="cb138-12"><a href="geom_detect.html#cb138-12" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb138-13"><a href="geom_detect.html#cb138-13" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb138-14"><a href="geom_detect.html#cb138-14" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb138-15"><a href="geom_detect.html#cb138-15" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(max_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb138-16"><a href="geom_detect.html#cb138-16" tabindex="-1"></a>    (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb138-17"><a href="geom_detect.html#cb138-17" tabindex="-1"></a>     <span class="fu">identical</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb138-18"><a href="geom_detect.html#cb138-18" tabindex="-1"></a>     <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_area_m2), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb138-19"><a href="geom_detect.html#cb138-19" tabindex="-1"></a>    <span class="sc">!</span>(<span class="fu">as.numeric</span>(max_area_m2) <span class="sc">&gt;</span> <span class="fu">as.numeric</span>(min_area_m2)) <span class="sc">||</span></span>
<span id="cb138-20"><a href="geom_detect.html#cb138-20" tabindex="-1"></a>    <span class="fu">as.numeric</span>(min_area_m2)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb138-21"><a href="geom_detect.html#cb138-21" tabindex="-1"></a>    <span class="fu">as.numeric</span>(max_area_m2)<span class="sc">&lt;</span><span class="dv">0</span></span>
<span id="cb138-22"><a href="geom_detect.html#cb138-22" tabindex="-1"></a>  ){</span>
<span id="cb138-23"><a href="geom_detect.html#cb138-23" tabindex="-1"></a>    <span class="co"># Code to execute if any condition is met (e.g., print an error message)</span></span>
<span id="cb138-24"><a href="geom_detect.html#cb138-24" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Error: One or more of `min_area_m2`,`max_area_m2` are not valid numbers, or the condition max_area_m2&gt;min_area_m2 not met.&quot;</span>)</span>
<span id="cb138-25"><a href="geom_detect.html#cb138-25" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb138-26"><a href="geom_detect.html#cb138-26" tabindex="-1"></a>    min_area_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(min_area_m2)[<span class="dv">1</span>] </span>
<span id="cb138-27"><a href="geom_detect.html#cb138-27" tabindex="-1"></a>    max_area_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(max_area_m2)[<span class="dv">1</span>] </span>
<span id="cb138-28"><a href="geom_detect.html#cb138-28" tabindex="-1"></a>  }</span>
<span id="cb138-29"><a href="geom_detect.html#cb138-29" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb138-30"><a href="geom_detect.html#cb138-30" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb138-31"><a href="geom_detect.html#cb138-31" tabindex="-1"></a>    sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb138-32"><a href="geom_detect.html#cb138-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb138-33"><a href="geom_detect.html#cb138-33" tabindex="-1"></a>      <span class="co"># area filter</span></span>
<span id="cb138-34"><a href="geom_detect.html#cb138-34" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb138-35"><a href="geom_detect.html#cb138-35" tabindex="-1"></a>      <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb138-36"><a href="geom_detect.html#cb138-36" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb138-37"><a href="geom_detect.html#cb138-37" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb138-38"><a href="geom_detect.html#cb138-38" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_xxxx,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb138-39"><a href="geom_detect.html#cb138-39" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb138-40"><a href="geom_detect.html#cb138-40" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(area_xxxx))</span>
<span id="cb138-41"><a href="geom_detect.html#cb138-41" tabindex="-1"></a>  )</span>
<span id="cb138-42"><a href="geom_detect.html#cb138-42" tabindex="-1"></a>  </span>
<span id="cb138-43"><a href="geom_detect.html#cb138-43" tabindex="-1"></a>}</span></code></pre></div>
<p>apply our <code>st_filter_area()</code> function</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="geom_detect.html#cb139-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb139-2"><a href="geom_detect.html#cb139-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb139-3"><a href="geom_detect.html#cb139-3" tabindex="-1"></a>  watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb139-4"><a href="geom_detect.html#cb139-4" tabindex="-1"></a>  <span class="fu">st_filter_area</span>(<span class="at">min_area_m2 =</span> min_area_m2, <span class="at">max_area_m2 =</span> max_area_m2)</span>
<span id="cb139-5"><a href="geom_detect.html#cb139-5" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb139-6"><a href="geom_detect.html#cb139-6" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb139-7"><a href="geom_detect.html#cb139-7" tabindex="-1"></a>  dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb139-8"><a href="geom_detect.html#cb139-8" tabindex="-1"></a>  <span class="fu">st_filter_area</span>(<span class="at">min_area_m2 =</span> min_area_m2, <span class="at">max_area_m2 =</span> max_area_m2)</span></code></pre></div>
<p>how many candidate segments were removed?</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="geom_detect.html#cb140-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb140-2"><a href="geom_detect.html#cb140-2" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;watershed&quot;</span>, <span class="st">&quot;DBSCAN&quot;</span>)</span>
<span id="cb140-3"><a href="geom_detect.html#cb140-3" tabindex="-1"></a>    , <span class="at">old_segments =</span> <span class="fu">c</span>(</span>
<span id="cb140-4"><a href="geom_detect.html#cb140-4" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">freq</span>(watershed_segs) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb140-5"><a href="geom_detect.html#cb140-5" tabindex="-1"></a>      , terra<span class="sc">::</span><span class="fu">freq</span>(dbscan_segs) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb140-6"><a href="geom_detect.html#cb140-6" tabindex="-1"></a>    )</span>
<span id="cb140-7"><a href="geom_detect.html#cb140-7" tabindex="-1"></a>    , <span class="at">new_segments =</span> <span class="fu">c</span>(</span>
<span id="cb140-8"><a href="geom_detect.html#cb140-8" tabindex="-1"></a>      <span class="fu">nrow</span>(watershed_segs_poly)</span>
<span id="cb140-9"><a href="geom_detect.html#cb140-9" tabindex="-1"></a>      , <span class="fu">nrow</span>(dbscan_segs_poly)</span>
<span id="cb140-10"><a href="geom_detect.html#cb140-10" tabindex="-1"></a>    )</span>
<span id="cb140-11"><a href="geom_detect.html#cb140-11" tabindex="-1"></a>    , <span class="at">area =</span> <span class="fu">c</span>(</span>
<span id="cb140-12"><a href="geom_detect.html#cb140-12" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb140-13"><a href="geom_detect.html#cb140-13" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb140-14"><a href="geom_detect.html#cb140-14" tabindex="-1"></a>    )</span>
<span id="cb140-15"><a href="geom_detect.html#cb140-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-16"><a href="geom_detect.html#cb140-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb140-17"><a href="geom_detect.html#cb140-17" tabindex="-1"></a>    <span class="at">pct_removed =</span> scales<span class="sc">::</span><span class="fu">percent</span>((new_segments<span class="sc">-</span>old_segments)<span class="sc">/</span>old_segments, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb140-18"><a href="geom_detect.html#cb140-18" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;segments&quot;</span>), <span class="sc">~</span>scales<span class="sc">::</span><span class="fu">comma</span>(.x,<span class="at">accuracy=</span><span class="dv">1</span>))</span>
<span id="cb140-19"><a href="geom_detect.html#cb140-19" tabindex="-1"></a>    , <span class="at">area =</span> scales<span class="sc">::</span><span class="fu">comma</span>(area,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb140-20"><a href="geom_detect.html#cb140-20" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-21"><a href="geom_detect.html#cb140-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(method,pct_removed) <span class="sc">%&gt;%</span> </span>
<span id="cb140-22"><a href="geom_detect.html#cb140-22" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb140-23"><a href="geom_detect.html#cb140-23" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Demonstration area candidate segments by method&lt;br&gt;filtered by segment area&quot;</span></span>
<span id="cb140-24"><a href="geom_detect.html#cb140-24" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb140-25"><a href="geom_detect.html#cb140-25" tabindex="-1"></a>      <span class="st">&quot;method&quot;</span>, <span class="st">&quot;% removed&quot;</span></span>
<span id="cb140-26"><a href="geom_detect.html#cb140-26" tabindex="-1"></a>      , <span class="st">&quot;orig. candidate segments&quot;</span></span>
<span id="cb140-27"><a href="geom_detect.html#cb140-27" tabindex="-1"></a>      , <span class="st">&quot;filtered candidate segments&quot;</span></span>
<span id="cb140-28"><a href="geom_detect.html#cb140-28" tabindex="-1"></a>      , <span class="st">&quot;remaining candidate area (m&lt;sup&gt;2&lt;/sup&gt;)&quot;</span></span>
<span id="cb140-29"><a href="geom_detect.html#cb140-29" tabindex="-1"></a>    )</span>
<span id="cb140-30"><a href="geom_detect.html#cb140-30" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb140-31"><a href="geom_detect.html#cb140-31" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb140-32"><a href="geom_detect.html#cb140-32" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-163">Table 4.3: </span>Demonstration area candidate segments by method<br>filtered by segment area
</caption>
<thead>
<tr>
<th style="text-align:left;">
method
</th>
<th style="text-align:left;">
% removed
</th>
<th style="text-align:left;">
orig. candidate segments
</th>
<th style="text-align:left;">
filtered candidate segments
</th>
<th style="text-align:left;">
remaining candidate area (m<sup>2</sup>)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
watershed
</td>
<td style="text-align:left;">
-85.5%
</td>
<td style="text-align:left;">
214
</td>
<td style="text-align:left;">
31
</td>
<td style="text-align:left;">
231.41
</td>
</tr>
<tr>
<td style="text-align:left;">
DBSCAN
</td>
<td style="text-align:left;">
-84.5%
</td>
<td style="text-align:left;">
200
</td>
<td style="text-align:left;">
31
</td>
<td style="text-align:left;">
230.74
</td>
</tr>
</tbody>
</table>
<div id="watershed-segmentation" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Watershed Segmentation<a href="geom_detect.html#watershed-segmentation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="geom_detect.html#cb141-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb141-2"><a href="geom_detect.html#cb141-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb141-3"><a href="geom_detect.html#cb141-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb141-4"><a href="geom_detect.html#cb141-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb141-5"><a href="geom_detect.html#cb141-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb141-6"><a href="geom_detect.html#cb141-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb141-7"><a href="geom_detect.html#cb141-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb141-8"><a href="geom_detect.html#cb141-8" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb141-9"><a href="geom_detect.html#cb141-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb141-10"><a href="geom_detect.html#cb141-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb141-11"><a href="geom_detect.html#cb141-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-164-1.png" alt="" width="1008" /></p>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="geom_detect.html#cb142-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb142-2"><a href="geom_detect.html#cb142-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb142-3"><a href="geom_detect.html#cb142-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb142-4"><a href="geom_detect.html#cb142-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb142-5"><a href="geom_detect.html#cb142-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb142-6"><a href="geom_detect.html#cb142-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb142-7"><a href="geom_detect.html#cb142-7" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb142-8"><a href="geom_detect.html#cb142-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb142-9"><a href="geom_detect.html#cb142-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-166-1.png" alt="" width="1008" /></p>
<p>nice…we are getting closer.</p>
</div>
<div id="dbscan-segmentation" class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> DBSCAN Segmentation<a href="geom_detect.html#dbscan-segmentation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>plot the filtered dbscan candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="geom_detect.html#cb143-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb143-2"><a href="geom_detect.html#cb143-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb143-3"><a href="geom_detect.html#cb143-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb143-4"><a href="geom_detect.html#cb143-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb143-5"><a href="geom_detect.html#cb143-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb143-6"><a href="geom_detect.html#cb143-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb143-7"><a href="geom_detect.html#cb143-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb143-8"><a href="geom_detect.html#cb143-8" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb143-9"><a href="geom_detect.html#cb143-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb143-10"><a href="geom_detect.html#cb143-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb143-11"><a href="geom_detect.html#cb143-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-169-1.png" alt="" width="1008" /></p>
<p>plot the filtered dbscan candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="geom_detect.html#cb144-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb144-2"><a href="geom_detect.html#cb144-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb144-3"><a href="geom_detect.html#cb144-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb144-4"><a href="geom_detect.html#cb144-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb144-5"><a href="geom_detect.html#cb144-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb144-6"><a href="geom_detect.html#cb144-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb144-7"><a href="geom_detect.html#cb144-7" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb144-8"><a href="geom_detect.html#cb144-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb144-9"><a href="geom_detect.html#cb144-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-171-1.png" alt="" width="1008" /></p>
<p>nice…we are getting closer.</p>
</div>
<div id="quick-methods-comparison" class="section level3 hasAnchor" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> Quick methods comparison<a href="geom_detect.html#quick-methods-comparison" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s quickly look at the watershed and dbscan segments on the same plot</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="geom_detect.html#cb145-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb145-2"><a href="geom_detect.html#cb145-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb145-3"><a href="geom_detect.html#cb145-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;watershed&quot;</span>)</span>
<span id="cb145-4"><a href="geom_detect.html#cb145-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb145-5"><a href="geom_detect.html#cb145-5" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb145-6"><a href="geom_detect.html#cb145-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb145-7"><a href="geom_detect.html#cb145-7" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;dbscan&quot;</span>)</span>
<span id="cb145-8"><a href="geom_detect.html#cb145-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb145-9"><a href="geom_detect.html#cb145-9" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb145-10"><a href="geom_detect.html#cb145-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray33&quot;</span>, <span class="st">&quot;aquamarine3&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb145-11"><a href="geom_detect.html#cb145-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb145-12"><a href="geom_detect.html#cb145-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-174-1.png" alt="" width="1008" /></p>
<p>interesting.</p>
</div>
</div>
<div id="candidate-geometric-filtering" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> Candidate Geometric filtering<a href="geom_detect.html#candidate-geometric-filtering" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>slash piles are man-made objects typically constructed into common geometric forms in 2D (e.g. circular base) and 3D space (e.g. paraboloid) to facilitate efficient construction and burning <a href="https://permanent.fdlp.gov/gpo45282/index.htm">Hardy 1996</a>. Our method leverages these traits by applying independent geometric filters to refine candidate segments.</p>
<p>First, we apply a regularity filter to remove candidates with irregularly-shaped bases. Then, an independent circularity filter removes candidates that do not meet expectations for round bases (typical of hand piles). By keeping these filters independent, the our method is flexible and allows users to prioritize generally regular shapes (e.g. circular or rectangular) or apply the circularity filter as an additional filtering step when circular pile bases are expected.</p>
<div id="shape-irregularity-convexity" class="section level3 hasAnchor" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> Shape Irregularity: Convexity<a href="geom_detect.html#shape-irregularity-convexity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our first shape irregularity filter compares the convex hull of the candidate segment to the raw polygon of the candidate segment. Specifically, we calculate the convexity ratio or “solidity” of the shape (<a href="https://doi.org/10.2307/2533987">Glasbey and Horgan 1995</a>) by:</p>
<p><span class="math display">\[\frac{\text{Area of Polygon}}{\text{Area of Convex Hull}}\]</span></p>
<p>This approach is effective for identifying polygons with deep indents, holes, or branching. A perfectly convex shape like a circle, square, or triangle will have a convexity of 1.0 (because they have no indents) and as shapes become more irregular (or concave) the convexity drops toward 0. Convexity is is not sensitive to the overall elongation of a shape as a long, thin rectangle is technically convex and would have a ratio of 1.0, despite being irregular in its proportions.</p>
<p>let’s create a convex hull of the candidate segments for comparison and convexity calculation</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="geom_detect.html#cb146-1" tabindex="-1"></a><span class="co"># convex hulls of segments</span></span>
<span id="cb146-2"><a href="geom_detect.html#cb146-2" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb146-3"><a href="geom_detect.html#cb146-3" tabindex="-1"></a>watershed_segs_poly_chull <span class="ot">&lt;-</span></span>
<span id="cb146-4"><a href="geom_detect.html#cb146-4" tabindex="-1"></a>  watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb146-5"><a href="geom_detect.html#cb146-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-6"><a href="geom_detect.html#cb146-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-7"><a href="geom_detect.html#cb146-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-8"><a href="geom_detect.html#cb146-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb146-9"><a href="geom_detect.html#cb146-9" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb146-10"><a href="geom_detect.html#cb146-10" tabindex="-1"></a>dbscan_segs_poly_chull <span class="ot">&lt;-</span></span>
<span id="cb146-11"><a href="geom_detect.html#cb146-11" tabindex="-1"></a>  dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb146-12"><a href="geom_detect.html#cb146-12" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-13"><a href="geom_detect.html#cb146-13" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-14"><a href="geom_detect.html#cb146-14" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-15"><a href="geom_detect.html#cb146-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span></code></pre></div>
<p>compare the convex hull shape to the raw polygons</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="geom_detect.html#cb147-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb147-2"><a href="geom_detect.html#cb147-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb147-3"><a href="geom_detect.html#cb147-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly_chull, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;convex hull&quot;</span>)</span>
<span id="cb147-4"><a href="geom_detect.html#cb147-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb147-5"><a href="geom_detect.html#cb147-5" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb147-6"><a href="geom_detect.html#cb147-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb147-7"><a href="geom_detect.html#cb147-7" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;raw polygons&quot;</span>)</span>
<span id="cb147-8"><a href="geom_detect.html#cb147-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb147-9"><a href="geom_detect.html#cb147-9" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb147-10"><a href="geom_detect.html#cb147-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;orangered&quot;</span>, <span class="st">&quot;magenta&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-11"><a href="geom_detect.html#cb147-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;watershed&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-12"><a href="geom_detect.html#cb147-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb147-13"><a href="geom_detect.html#cb147-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb147-14"><a href="geom_detect.html#cb147-14" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb147-15"><a href="geom_detect.html#cb147-15" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb147-16"><a href="geom_detect.html#cb147-16" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb147-17"><a href="geom_detect.html#cb147-17" tabindex="-1"></a>  )</span>
<span id="cb147-18"><a href="geom_detect.html#cb147-18" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb147-19"><a href="geom_detect.html#cb147-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb147-20"><a href="geom_detect.html#cb147-20" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly_chull, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;convex hull&quot;</span>)</span>
<span id="cb147-21"><a href="geom_detect.html#cb147-21" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb147-22"><a href="geom_detect.html#cb147-22" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb147-23"><a href="geom_detect.html#cb147-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb147-24"><a href="geom_detect.html#cb147-24" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;raw polygons&quot;</span>)</span>
<span id="cb147-25"><a href="geom_detect.html#cb147-25" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb147-26"><a href="geom_detect.html#cb147-26" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb147-27"><a href="geom_detect.html#cb147-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;orangered&quot;</span>, <span class="st">&quot;magenta&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-28"><a href="geom_detect.html#cb147-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;dbscan&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-29"><a href="geom_detect.html#cb147-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb147-30"><a href="geom_detect.html#cb147-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb147-31"><a href="geom_detect.html#cb147-31" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb147-32"><a href="geom_detect.html#cb147-32" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb147-33"><a href="geom_detect.html#cb147-33" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb147-34"><a href="geom_detect.html#cb147-34" tabindex="-1"></a>  )</span>
<span id="cb147-35"><a href="geom_detect.html#cb147-35" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(<span class="fu">list</span>(p1_temp,p2_temp))</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-176-1.png" alt="" width="1008" /></p>
<p>now, we’ll calculate the convexity ratio for each remaining candidate segment</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="geom_detect.html#cb148-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb148-2"><a href="geom_detect.html#cb148-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb148-3"><a href="geom_detect.html#cb148-3" tabindex="-1"></a>  watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb148-4"><a href="geom_detect.html#cb148-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">poly_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb148-5"><a href="geom_detect.html#cb148-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb148-6"><a href="geom_detect.html#cb148-6" tabindex="-1"></a>    watershed_segs_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb148-7"><a href="geom_detect.html#cb148-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb148-8"><a href="geom_detect.html#cb148-8" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-9"><a href="geom_detect.html#cb148-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id, chull_area_m2)</span>
<span id="cb148-10"><a href="geom_detect.html#cb148-10" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb148-11"><a href="geom_detect.html#cb148-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb148-12"><a href="geom_detect.html#cb148-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb148-13"><a href="geom_detect.html#cb148-13" tabindex="-1"></a>    <span class="at">convexity_ratio =</span> poly_area_m2<span class="sc">/</span>chull_area_m2</span>
<span id="cb148-14"><a href="geom_detect.html#cb148-14" tabindex="-1"></a>  )</span>
<span id="cb148-15"><a href="geom_detect.html#cb148-15" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb148-16"><a href="geom_detect.html#cb148-16" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb148-17"><a href="geom_detect.html#cb148-17" tabindex="-1"></a>  dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb148-18"><a href="geom_detect.html#cb148-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">poly_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb148-19"><a href="geom_detect.html#cb148-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb148-20"><a href="geom_detect.html#cb148-20" tabindex="-1"></a>    dbscan_segs_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb148-21"><a href="geom_detect.html#cb148-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb148-22"><a href="geom_detect.html#cb148-22" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-23"><a href="geom_detect.html#cb148-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id, chull_area_m2)</span>
<span id="cb148-24"><a href="geom_detect.html#cb148-24" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb148-25"><a href="geom_detect.html#cb148-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb148-26"><a href="geom_detect.html#cb148-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb148-27"><a href="geom_detect.html#cb148-27" tabindex="-1"></a>    <span class="at">convexity_ratio =</span> poly_area_m2<span class="sc">/</span>chull_area_m2</span>
<span id="cb148-28"><a href="geom_detect.html#cb148-28" tabindex="-1"></a>  )</span></code></pre></div>
<p>what is the convexity ratio for the remaining candidate segments in our demonstration area?</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="geom_detect.html#cb149-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb149-2"><a href="geom_detect.html#cb149-2" tabindex="-1"></a>watershed_segs_poly<span class="sc">$</span>convexity_ratio <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.4489  0.7686  0.8941  0.8310  0.9279  0.9423</code></pre>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="geom_detect.html#cb151-1" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb151-2"><a href="geom_detect.html#cb151-2" tabindex="-1"></a>dbscan_segs_poly<span class="sc">$</span>convexity_ratio <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.4591  0.7611  0.8941  0.8349  0.9279  0.9423</code></pre>
<p>plot the convexity of the candidate segments using the raw polygons</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="geom_detect.html#cb153-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span></span>
<span id="cb153-2"><a href="geom_detect.html#cb153-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb153-3"><a href="geom_detect.html#cb153-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb153-4"><a href="geom_detect.html#cb153-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill=</span>convexity_ratio)</span>
<span id="cb153-5"><a href="geom_detect.html#cb153-5" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb153-6"><a href="geom_detect.html#cb153-6" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb153-7"><a href="geom_detect.html#cb153-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf_text</span>(</span>
<span id="cb153-8"><a href="geom_detect.html#cb153-8" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb153-9"><a href="geom_detect.html#cb153-9" tabindex="-1"></a>    , <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">label=</span>scales<span class="sc">::</span><span class="fu">percent</span>(convexity_ratio, <span class="at">accuracy=</span><span class="fl">0.1</span>))</span>
<span id="cb153-10"><a href="geom_detect.html#cb153-10" tabindex="-1"></a>    , <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span></span>
<span id="cb153-11"><a href="geom_detect.html#cb153-11" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb153-12"><a href="geom_detect.html#cb153-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_fermenter</span>(</span>
<span id="cb153-13"><a href="geom_detect.html#cb153-13" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">10</span>, <span class="at">palette =</span> <span class="st">&quot;PuOr&quot;</span></span>
<span id="cb153-14"><a href="geom_detect.html#cb153-14" tabindex="-1"></a>    , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb153-15"><a href="geom_detect.html#cb153-15" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb153-16"><a href="geom_detect.html#cb153-16" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb153-17"><a href="geom_detect.html#cb153-17" tabindex="-1"></a>    , <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>)</span>
<span id="cb153-18"><a href="geom_detect.html#cb153-18" tabindex="-1"></a>    , <span class="at">name =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb153-19"><a href="geom_detect.html#cb153-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb153-20"><a href="geom_detect.html#cb153-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;watershed&quot;</span>) <span class="sc">+</span></span>
<span id="cb153-21"><a href="geom_detect.html#cb153-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb153-22"><a href="geom_detect.html#cb153-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb153-23"><a href="geom_detect.html#cb153-23" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span></span>
<span id="cb153-24"><a href="geom_detect.html#cb153-24" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb153-25"><a href="geom_detect.html#cb153-25" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb153-26"><a href="geom_detect.html#cb153-26" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb153-27"><a href="geom_detect.html#cb153-27" tabindex="-1"></a>  )</span>
<span id="cb153-28"><a href="geom_detect.html#cb153-28" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span></span>
<span id="cb153-29"><a href="geom_detect.html#cb153-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb153-30"><a href="geom_detect.html#cb153-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb153-31"><a href="geom_detect.html#cb153-31" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill=</span>convexity_ratio)</span>
<span id="cb153-32"><a href="geom_detect.html#cb153-32" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb153-33"><a href="geom_detect.html#cb153-33" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb153-34"><a href="geom_detect.html#cb153-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf_text</span>(</span>
<span id="cb153-35"><a href="geom_detect.html#cb153-35" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb153-36"><a href="geom_detect.html#cb153-36" tabindex="-1"></a>    , <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">label=</span>scales<span class="sc">::</span><span class="fu">percent</span>(convexity_ratio, <span class="at">accuracy=</span><span class="fl">0.1</span>))</span>
<span id="cb153-37"><a href="geom_detect.html#cb153-37" tabindex="-1"></a>    , <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span></span>
<span id="cb153-38"><a href="geom_detect.html#cb153-38" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb153-39"><a href="geom_detect.html#cb153-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_fermenter</span>(</span>
<span id="cb153-40"><a href="geom_detect.html#cb153-40" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">10</span>, <span class="at">palette =</span> <span class="st">&quot;PuOr&quot;</span></span>
<span id="cb153-41"><a href="geom_detect.html#cb153-41" tabindex="-1"></a>    , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb153-42"><a href="geom_detect.html#cb153-42" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb153-43"><a href="geom_detect.html#cb153-43" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb153-44"><a href="geom_detect.html#cb153-44" tabindex="-1"></a>    , <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>)</span>
<span id="cb153-45"><a href="geom_detect.html#cb153-45" tabindex="-1"></a>    , <span class="at">name =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb153-46"><a href="geom_detect.html#cb153-46" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb153-47"><a href="geom_detect.html#cb153-47" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;dbscan&quot;</span>) <span class="sc">+</span></span>
<span id="cb153-48"><a href="geom_detect.html#cb153-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb153-49"><a href="geom_detect.html#cb153-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb153-50"><a href="geom_detect.html#cb153-50" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span></span>
<span id="cb153-51"><a href="geom_detect.html#cb153-51" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb153-52"><a href="geom_detect.html#cb153-52" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb153-53"><a href="geom_detect.html#cb153-53" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb153-54"><a href="geom_detect.html#cb153-54" tabindex="-1"></a>  )</span>
<span id="cb153-55"><a href="geom_detect.html#cb153-55" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb153-56"><a href="geom_detect.html#cb153-56" tabindex="-1"></a>  <span class="fu">list</span>(p1_temp,p2_temp)</span>
<span id="cb153-57"><a href="geom_detect.html#cb153-57" tabindex="-1"></a>  , <span class="at">guides =</span> <span class="st">&quot;collect&quot;</span></span>
<span id="cb153-58"><a href="geom_detect.html#cb153-58" tabindex="-1"></a>  , </span>
<span id="cb153-59"><a href="geom_detect.html#cb153-59" tabindex="-1"></a>) <span class="sc">&amp;</span></span>
<span id="cb153-60"><a href="geom_detect.html#cb153-60" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb153-61"><a href="geom_detect.html#cb153-61" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span></span>
<span id="cb153-62"><a href="geom_detect.html#cb153-62" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb153-63"><a href="geom_detect.html#cb153-63" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-180-1.png" alt="" width="1008" /></p>
<p>finally, let’s filter the candidate segments with a user-defined expectation of shape irregularity on the 0-100% scale applied to the convexity ratio</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="geom_detect.html#cb154-1" tabindex="-1"></a><span class="co"># # min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb154-2"><a href="geom_detect.html#cb154-2" tabindex="-1"></a>min_convexity_ratio <span class="ot">&lt;-</span> <span class="fl">0.5</span></span></code></pre></div>
<p>what proportion of the remaining segments were filtered using this shape irregularity filter</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="geom_detect.html#cb155-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb155-2"><a href="geom_detect.html#cb155-2" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;watershed&quot;</span>, <span class="st">&quot;DBSCAN&quot;</span>)</span>
<span id="cb155-3"><a href="geom_detect.html#cb155-3" tabindex="-1"></a>    , <span class="at">old_segments =</span> <span class="fu">c</span>(</span>
<span id="cb155-4"><a href="geom_detect.html#cb155-4" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb155-5"><a href="geom_detect.html#cb155-5" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb155-6"><a href="geom_detect.html#cb155-6" tabindex="-1"></a>    )</span>
<span id="cb155-7"><a href="geom_detect.html#cb155-7" tabindex="-1"></a>    , <span class="at">new_segments =</span> <span class="fu">c</span>(</span>
<span id="cb155-8"><a href="geom_detect.html#cb155-8" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(convexity_ratio<span class="sc">&gt;=</span>min_convexity_ratio) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb155-9"><a href="geom_detect.html#cb155-9" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(convexity_ratio<span class="sc">&gt;=</span>min_convexity_ratio) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb155-10"><a href="geom_detect.html#cb155-10" tabindex="-1"></a>    )</span>
<span id="cb155-11"><a href="geom_detect.html#cb155-11" tabindex="-1"></a>    , <span class="at">area =</span> <span class="fu">c</span>(</span>
<span id="cb155-12"><a href="geom_detect.html#cb155-12" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-13"><a href="geom_detect.html#cb155-13" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(convexity_ratio<span class="sc">&gt;=</span>min_convexity_ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb155-14"><a href="geom_detect.html#cb155-14" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-15"><a href="geom_detect.html#cb155-15" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-16"><a href="geom_detect.html#cb155-16" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb155-17"><a href="geom_detect.html#cb155-17" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-18"><a href="geom_detect.html#cb155-18" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(convexity_ratio<span class="sc">&gt;=</span>min_convexity_ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb155-19"><a href="geom_detect.html#cb155-19" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-20"><a href="geom_detect.html#cb155-20" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-21"><a href="geom_detect.html#cb155-21" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb155-22"><a href="geom_detect.html#cb155-22" tabindex="-1"></a>    )</span>
<span id="cb155-23"><a href="geom_detect.html#cb155-23" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-24"><a href="geom_detect.html#cb155-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb155-25"><a href="geom_detect.html#cb155-25" tabindex="-1"></a>    <span class="at">pct_removed =</span> scales<span class="sc">::</span><span class="fu">percent</span>((new_segments<span class="sc">-</span>old_segments)<span class="sc">/</span>old_segments, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb155-26"><a href="geom_detect.html#cb155-26" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;segments&quot;</span>), <span class="sc">~</span>scales<span class="sc">::</span><span class="fu">comma</span>(.x,<span class="at">accuracy=</span><span class="dv">1</span>))</span>
<span id="cb155-27"><a href="geom_detect.html#cb155-27" tabindex="-1"></a>    , <span class="at">area =</span> scales<span class="sc">::</span><span class="fu">comma</span>(area,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb155-28"><a href="geom_detect.html#cb155-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-29"><a href="geom_detect.html#cb155-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(method,pct_removed) <span class="sc">%&gt;%</span> </span>
<span id="cb155-30"><a href="geom_detect.html#cb155-30" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb155-31"><a href="geom_detect.html#cb155-31" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Demonstration area candidate segments by method&lt;br&gt;filtered by segment convexity&quot;</span></span>
<span id="cb155-32"><a href="geom_detect.html#cb155-32" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb155-33"><a href="geom_detect.html#cb155-33" tabindex="-1"></a>      <span class="st">&quot;method&quot;</span>, <span class="st">&quot;% removed&quot;</span></span>
<span id="cb155-34"><a href="geom_detect.html#cb155-34" tabindex="-1"></a>      , <span class="st">&quot;orig. candidate segments&quot;</span></span>
<span id="cb155-35"><a href="geom_detect.html#cb155-35" tabindex="-1"></a>      , <span class="st">&quot;filtered candidate segments&quot;</span></span>
<span id="cb155-36"><a href="geom_detect.html#cb155-36" tabindex="-1"></a>      , <span class="st">&quot;remaining candidate area (m&lt;sup&gt;2&lt;/sup&gt;)&quot;</span></span>
<span id="cb155-37"><a href="geom_detect.html#cb155-37" tabindex="-1"></a>    )</span>
<span id="cb155-38"><a href="geom_detect.html#cb155-38" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb155-39"><a href="geom_detect.html#cb155-39" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb155-40"><a href="geom_detect.html#cb155-40" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-182">Table 4.4: </span>Demonstration area candidate segments by method<br>filtered by segment convexity
</caption>
<thead>
<tr>
<th style="text-align:left;">
method
</th>
<th style="text-align:left;">
% removed
</th>
<th style="text-align:left;">
orig. candidate segments
</th>
<th style="text-align:left;">
filtered candidate segments
</th>
<th style="text-align:left;">
remaining candidate area (m<sup>2</sup>)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
watershed
</td>
<td style="text-align:left;">
-3.2%
</td>
<td style="text-align:left;">
31
</td>
<td style="text-align:left;">
30
</td>
<td style="text-align:left;">
227.19
</td>
</tr>
<tr>
<td style="text-align:left;">
DBSCAN
</td>
<td style="text-align:left;">
-3.2%
</td>
<td style="text-align:left;">
31
</td>
<td style="text-align:left;">
30
</td>
<td style="text-align:left;">
226.62
</td>
</tr>
</tbody>
</table>
<p>actually apply the filter ;)</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="geom_detect.html#cb156-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb156-2"><a href="geom_detect.html#cb156-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span> watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb156-3"><a href="geom_detect.html#cb156-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(convexity_ratio<span class="sc">&gt;=</span>min_convexity_ratio)</span>
<span id="cb156-4"><a href="geom_detect.html#cb156-4" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb156-5"><a href="geom_detect.html#cb156-5" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb156-6"><a href="geom_detect.html#cb156-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(convexity_ratio<span class="sc">&gt;=</span>min_convexity_ratio)</span></code></pre></div>
<div id="watershed-segmentation-1" class="section level4 hasAnchor" number="4.4.1.1">
<h4><span class="header-section-number">4.4.1.1</span> Watershed Segmentation<a href="geom_detect.html#watershed-segmentation-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="geom_detect.html#cb157-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb157-2"><a href="geom_detect.html#cb157-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb157-3"><a href="geom_detect.html#cb157-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb157-4"><a href="geom_detect.html#cb157-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb157-5"><a href="geom_detect.html#cb157-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb157-6"><a href="geom_detect.html#cb157-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-7"><a href="geom_detect.html#cb157-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb157-8"><a href="geom_detect.html#cb157-8" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb157-9"><a href="geom_detect.html#cb157-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb157-10"><a href="geom_detect.html#cb157-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-11"><a href="geom_detect.html#cb157-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-185-1.png" alt="" width="1008" /></p>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="geom_detect.html#cb158-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb158-2"><a href="geom_detect.html#cb158-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb158-3"><a href="geom_detect.html#cb158-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb158-4"><a href="geom_detect.html#cb158-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb158-5"><a href="geom_detect.html#cb158-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-6"><a href="geom_detect.html#cb158-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb158-7"><a href="geom_detect.html#cb158-7" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb158-8"><a href="geom_detect.html#cb158-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb158-9"><a href="geom_detect.html#cb158-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-187-1.png" alt="" width="1008" /></p>
</div>
<div id="dbscan-segmentation-1" class="section level4 hasAnchor" number="4.4.1.2">
<h4><span class="header-section-number">4.4.1.2</span> DBSCAN Segmentation<a href="geom_detect.html#dbscan-segmentation-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="geom_detect.html#cb159-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb159-2"><a href="geom_detect.html#cb159-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb159-3"><a href="geom_detect.html#cb159-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb159-4"><a href="geom_detect.html#cb159-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb159-5"><a href="geom_detect.html#cb159-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb159-6"><a href="geom_detect.html#cb159-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb159-7"><a href="geom_detect.html#cb159-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb159-8"><a href="geom_detect.html#cb159-8" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb159-9"><a href="geom_detect.html#cb159-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb159-10"><a href="geom_detect.html#cb159-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb159-11"><a href="geom_detect.html#cb159-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-190-1.png" alt="" width="1008" /></p>
<p>plot the filtered dbscan candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="geom_detect.html#cb160-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb160-2"><a href="geom_detect.html#cb160-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb160-3"><a href="geom_detect.html#cb160-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb160-4"><a href="geom_detect.html#cb160-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb160-5"><a href="geom_detect.html#cb160-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-6"><a href="geom_detect.html#cb160-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb160-7"><a href="geom_detect.html#cb160-7" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb160-8"><a href="geom_detect.html#cb160-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb160-9"><a href="geom_detect.html#cb160-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-192-1.png" alt="" width="1008" /></p>
</div>
<div id="convexity-filter-function" class="section level4 hasAnchor" number="4.4.1.3">
<h4><span class="header-section-number">4.4.1.3</span> Convexity Filter Function<a href="geom_detect.html#convexity-filter-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s make a function to ingest a spatial data frame and return polygons filtered for irregularity using this convex hull process</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="geom_detect.html#cb161-1" tabindex="-1"></a>st_convexity_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb161-2"><a href="geom_detect.html#cb161-2" tabindex="-1"></a>  sf_data</span>
<span id="cb161-3"><a href="geom_detect.html#cb161-3" tabindex="-1"></a>  <span class="co"># min required overlap between the polygon and the convex hull of the polygon</span></span>
<span id="cb161-4"><a href="geom_detect.html#cb161-4" tabindex="-1"></a>  , <span class="at">min_convexity_ratio =</span> <span class="fl">0.7</span></span>
<span id="cb161-5"><a href="geom_detect.html#cb161-5" tabindex="-1"></a>) {</span>
<span id="cb161-6"><a href="geom_detect.html#cb161-6" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb161-7"><a href="geom_detect.html#cb161-7" tabindex="-1"></a>  <span class="co"># if not polygons</span></span>
<span id="cb161-8"><a href="geom_detect.html#cb161-8" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) ){</span>
<span id="cb161-9"><a href="geom_detect.html#cb161-9" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb161-10"><a href="geom_detect.html#cb161-10" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb161-11"><a href="geom_detect.html#cb161-11" tabindex="-1"></a>    ))</span>
<span id="cb161-12"><a href="geom_detect.html#cb161-12" tabindex="-1"></a>  }</span>
<span id="cb161-13"><a href="geom_detect.html#cb161-13" tabindex="-1"></a>  <span class="co"># convex hulls of segments</span></span>
<span id="cb161-14"><a href="geom_detect.html#cb161-14" tabindex="-1"></a>  poly_chull <span class="ot">&lt;-</span></span>
<span id="cb161-15"><a href="geom_detect.html#cb161-15" tabindex="-1"></a>    sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb161-16"><a href="geom_detect.html#cb161-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-17"><a href="geom_detect.html#cb161-17" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-18"><a href="geom_detect.html#cb161-18" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb161-19"><a href="geom_detect.html#cb161-19" tabindex="-1"></a>    <span class="co"># dplyr::filter(sf::st_is_valid(.))</span></span>
<span id="cb161-20"><a href="geom_detect.html#cb161-20" tabindex="-1"></a>  <span class="co"># compare areas</span></span>
<span id="cb161-21"><a href="geom_detect.html#cb161-21" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(poly_chull)<span class="sc">!=</span><span class="fu">nrow</span>(sf_data)){</span>
<span id="cb161-22"><a href="geom_detect.html#cb161-22" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;could not make valid convex hulls from provided polygon data&quot;</span>)</span>
<span id="cb161-23"><a href="geom_detect.html#cb161-23" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb161-24"><a href="geom_detect.html#cb161-24" tabindex="-1"></a>    area_comp <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb161-25"><a href="geom_detect.html#cb161-25" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb161-26"><a href="geom_detect.html#cb161-26" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb161-27"><a href="geom_detect.html#cb161-27" tabindex="-1"></a>        poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb161-28"><a href="geom_detect.html#cb161-28" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb161-29"><a href="geom_detect.html#cb161-29" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(chull_area_xxxx) <span class="sc">%&gt;%</span> </span>
<span id="cb161-30"><a href="geom_detect.html#cb161-30" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb161-31"><a href="geom_detect.html#cb161-31" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb161-32"><a href="geom_detect.html#cb161-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb161-33"><a href="geom_detect.html#cb161-33" tabindex="-1"></a>        <span class="at">convexity_ratio =</span> area_xxxx<span class="sc">/</span>chull_area_xxxx</span>
<span id="cb161-34"><a href="geom_detect.html#cb161-34" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb161-35"><a href="geom_detect.html#cb161-35" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb161-36"><a href="geom_detect.html#cb161-36" tabindex="-1"></a>        convexity_ratio <span class="sc">&gt;=</span> min_convexity_ratio</span>
<span id="cb161-37"><a href="geom_detect.html#cb161-37" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb161-38"><a href="geom_detect.html#cb161-38" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(area_xxxx,chull_area_xxxx))</span>
<span id="cb161-39"><a href="geom_detect.html#cb161-39" tabindex="-1"></a>    <span class="fu">return</span>(area_comp)</span>
<span id="cb161-40"><a href="geom_detect.html#cb161-40" tabindex="-1"></a>  }</span>
<span id="cb161-41"><a href="geom_detect.html#cb161-41" tabindex="-1"></a>}</span>
<span id="cb161-42"><a href="geom_detect.html#cb161-42" tabindex="-1"></a><span class="co"># dbscan_segs_poly$convexity_ratio %&gt;% summary()</span></span>
<span id="cb161-43"><a href="geom_detect.html#cb161-43" tabindex="-1"></a><span class="co"># dbscan_segs_poly %&gt;% </span></span>
<span id="cb161-44"><a href="geom_detect.html#cb161-44" tabindex="-1"></a><span class="co">#   st_convexity_filter(min_convexity_ratio = 0.9) %&gt;%</span></span>
<span id="cb161-45"><a href="geom_detect.html#cb161-45" tabindex="-1"></a><span class="co">#   dplyr::pull(convexity_ratio) %&gt;% </span></span>
<span id="cb161-46"><a href="geom_detect.html#cb161-46" tabindex="-1"></a><span class="co">#   summary()</span></span></code></pre></div>
</div>
</div>
<div id="shape-irregularity-circularity" class="section level3 hasAnchor" number="4.4.2">
<h3><span class="header-section-number">4.4.2</span> Shape Irregularity: Circularity<a href="geom_detect.html#shape-irregularity-circularity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our second shape irregularity filter compares the minimum bounding circle of the candidate segment to the raw polygon of the candidate segment. Specifically, we calculate the circularity ratio sometimes referred to as the Reock Compactness Score (<a href="https://doi.org/10.2307/2109043">Reock 1961</a>) of the shape by:</p>
<p><span class="math display">\[\frac{\text{Area of Polygon}}{\text{Area of Minumum Bounding Circle}}\]</span></p>
<p>This approach is used to measure how closely a shape is spread around its central point (dispersion) with a perfect circle receiving a score of 1.0 while long, thin shapes (like downed tree boles) will have low values approaching the lower limit of 0. This metric penalizes any shape that does not fill it’s circumcircle (i.e. the smallest circle that contains the polygon). For context, a perfect square has a circularity ratio of <span class="math inline">\(\frac{2}{\pi}\approx 0.637\)</span> while an equilateral triangle has a ratio of <span class="math inline">\(\frac{3\sqrt{3}}{4\pi}\approx 0.414\)</span></p>
<p>let’s create the minimum bounding circle of the candidate segments using <code>lwgeom::st_minimum_bounding_circle()</code></p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="geom_detect.html#cb162-1" tabindex="-1"></a><span class="co"># MBC of segments</span></span>
<span id="cb162-2"><a href="geom_detect.html#cb162-2" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb162-3"><a href="geom_detect.html#cb162-3" tabindex="-1"></a>watershed_segs_poly_mbc <span class="ot">&lt;-</span></span>
<span id="cb162-4"><a href="geom_detect.html#cb162-4" tabindex="-1"></a>  watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb162-5"><a href="geom_detect.html#cb162-5" tabindex="-1"></a>  lwgeom<span class="sc">::</span><span class="fu">st_minimum_bounding_circle</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb162-6"><a href="geom_detect.html#cb162-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb162-7"><a href="geom_detect.html#cb162-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb162-8"><a href="geom_detect.html#cb162-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb162-9"><a href="geom_detect.html#cb162-9" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb162-10"><a href="geom_detect.html#cb162-10" tabindex="-1"></a>dbscan_segs_poly_mbc <span class="ot">&lt;-</span></span>
<span id="cb162-11"><a href="geom_detect.html#cb162-11" tabindex="-1"></a>  dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb162-12"><a href="geom_detect.html#cb162-12" tabindex="-1"></a>  lwgeom<span class="sc">::</span><span class="fu">st_minimum_bounding_circle</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb162-13"><a href="geom_detect.html#cb162-13" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb162-14"><a href="geom_detect.html#cb162-14" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb162-15"><a href="geom_detect.html#cb162-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span></code></pre></div>
<p>compare the MBC shape to the raw polygons</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="geom_detect.html#cb163-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb163-2"><a href="geom_detect.html#cb163-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb163-3"><a href="geom_detect.html#cb163-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly_mbc, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;min. bounding circle&quot;</span>)</span>
<span id="cb163-4"><a href="geom_detect.html#cb163-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.5</span></span>
<span id="cb163-5"><a href="geom_detect.html#cb163-5" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb163-6"><a href="geom_detect.html#cb163-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb163-7"><a href="geom_detect.html#cb163-7" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;raw polygons&quot;</span>)</span>
<span id="cb163-8"><a href="geom_detect.html#cb163-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb163-9"><a href="geom_detect.html#cb163-9" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb163-10"><a href="geom_detect.html#cb163-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;orangered&quot;</span>, <span class="st">&quot;magenta&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-11"><a href="geom_detect.html#cb163-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;watershed&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-12"><a href="geom_detect.html#cb163-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb163-13"><a href="geom_detect.html#cb163-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb163-14"><a href="geom_detect.html#cb163-14" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb163-15"><a href="geom_detect.html#cb163-15" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb163-16"><a href="geom_detect.html#cb163-16" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb163-17"><a href="geom_detect.html#cb163-17" tabindex="-1"></a>  )</span>
<span id="cb163-18"><a href="geom_detect.html#cb163-18" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb163-19"><a href="geom_detect.html#cb163-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb163-20"><a href="geom_detect.html#cb163-20" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly_mbc, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;min. bounding circle&quot;</span>)</span>
<span id="cb163-21"><a href="geom_detect.html#cb163-21" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.5</span></span>
<span id="cb163-22"><a href="geom_detect.html#cb163-22" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb163-23"><a href="geom_detect.html#cb163-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb163-24"><a href="geom_detect.html#cb163-24" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;raw polygons&quot;</span>)</span>
<span id="cb163-25"><a href="geom_detect.html#cb163-25" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb163-26"><a href="geom_detect.html#cb163-26" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb163-27"><a href="geom_detect.html#cb163-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;orangered&quot;</span>, <span class="st">&quot;magenta&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-28"><a href="geom_detect.html#cb163-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;dbscan&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-29"><a href="geom_detect.html#cb163-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb163-30"><a href="geom_detect.html#cb163-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb163-31"><a href="geom_detect.html#cb163-31" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb163-32"><a href="geom_detect.html#cb163-32" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb163-33"><a href="geom_detect.html#cb163-33" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb163-34"><a href="geom_detect.html#cb163-34" tabindex="-1"></a>  )</span>
<span id="cb163-35"><a href="geom_detect.html#cb163-35" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(<span class="fu">list</span>(p1_temp,p2_temp))</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-197-1.png" alt="" width="1008" /></p>
<p>now, we’ll calculate the circularity ratio for each remaining candidate segment</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="geom_detect.html#cb164-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb164-2"><a href="geom_detect.html#cb164-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb164-3"><a href="geom_detect.html#cb164-3" tabindex="-1"></a>  watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb164-4"><a href="geom_detect.html#cb164-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb164-5"><a href="geom_detect.html#cb164-5" tabindex="-1"></a>    watershed_segs_poly_mbc <span class="sc">%&gt;%</span> </span>
<span id="cb164-6"><a href="geom_detect.html#cb164-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">mbc_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb164-7"><a href="geom_detect.html#cb164-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb164-8"><a href="geom_detect.html#cb164-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id, mbc_area_m2)</span>
<span id="cb164-9"><a href="geom_detect.html#cb164-9" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb164-10"><a href="geom_detect.html#cb164-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb164-11"><a href="geom_detect.html#cb164-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb164-12"><a href="geom_detect.html#cb164-12" tabindex="-1"></a>    <span class="at">circularity_ratio =</span> poly_area_m2<span class="sc">/</span>mbc_area_m2</span>
<span id="cb164-13"><a href="geom_detect.html#cb164-13" tabindex="-1"></a>  )</span>
<span id="cb164-14"><a href="geom_detect.html#cb164-14" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb164-15"><a href="geom_detect.html#cb164-15" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> </span>
<span id="cb164-16"><a href="geom_detect.html#cb164-16" tabindex="-1"></a>  dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb164-17"><a href="geom_detect.html#cb164-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb164-18"><a href="geom_detect.html#cb164-18" tabindex="-1"></a>    dbscan_segs_poly_mbc <span class="sc">%&gt;%</span> </span>
<span id="cb164-19"><a href="geom_detect.html#cb164-19" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">mbc_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb164-20"><a href="geom_detect.html#cb164-20" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb164-21"><a href="geom_detect.html#cb164-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id, mbc_area_m2)</span>
<span id="cb164-22"><a href="geom_detect.html#cb164-22" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb164-23"><a href="geom_detect.html#cb164-23" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb164-24"><a href="geom_detect.html#cb164-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb164-25"><a href="geom_detect.html#cb164-25" tabindex="-1"></a>    <span class="at">circularity_ratio =</span> poly_area_m2<span class="sc">/</span>mbc_area_m2</span>
<span id="cb164-26"><a href="geom_detect.html#cb164-26" tabindex="-1"></a>  )</span></code></pre></div>
<p>what is the circularity ratio for the remaining candidate segments in our demonstration area?</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="geom_detect.html#cb165-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb165-2"><a href="geom_detect.html#cb165-2" tabindex="-1"></a>watershed_segs_poly<span class="sc">$</span>circularity_ratio <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.1896  0.4700  0.6431  0.5770  0.6936  0.7991</code></pre>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="geom_detect.html#cb167-1" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb167-2"><a href="geom_detect.html#cb167-2" tabindex="-1"></a>dbscan_segs_poly<span class="sc">$</span>circularity_ratio <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.1896  0.4783  0.6431  0.5799  0.6936  0.7991</code></pre>
<p>plot the circularity of the candidate segments using the raw polygons</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="geom_detect.html#cb169-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span></span>
<span id="cb169-2"><a href="geom_detect.html#cb169-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb169-3"><a href="geom_detect.html#cb169-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb169-4"><a href="geom_detect.html#cb169-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill=</span>circularity_ratio)</span>
<span id="cb169-5"><a href="geom_detect.html#cb169-5" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb169-6"><a href="geom_detect.html#cb169-6" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb169-7"><a href="geom_detect.html#cb169-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf_text</span>(</span>
<span id="cb169-8"><a href="geom_detect.html#cb169-8" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb169-9"><a href="geom_detect.html#cb169-9" tabindex="-1"></a>    , <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">label=</span>scales<span class="sc">::</span><span class="fu">percent</span>(circularity_ratio, <span class="at">accuracy=</span><span class="fl">0.1</span>))</span>
<span id="cb169-10"><a href="geom_detect.html#cb169-10" tabindex="-1"></a>    , <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span></span>
<span id="cb169-11"><a href="geom_detect.html#cb169-11" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb169-12"><a href="geom_detect.html#cb169-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_fermenter</span>(</span>
<span id="cb169-13"><a href="geom_detect.html#cb169-13" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">10</span>, <span class="at">palette =</span> <span class="st">&quot;PuOr&quot;</span></span>
<span id="cb169-14"><a href="geom_detect.html#cb169-14" tabindex="-1"></a>    , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb169-15"><a href="geom_detect.html#cb169-15" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb169-16"><a href="geom_detect.html#cb169-16" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb169-17"><a href="geom_detect.html#cb169-17" tabindex="-1"></a>    , <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>)</span>
<span id="cb169-18"><a href="geom_detect.html#cb169-18" tabindex="-1"></a>    , <span class="at">name =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb169-19"><a href="geom_detect.html#cb169-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb169-20"><a href="geom_detect.html#cb169-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;watershed&quot;</span>) <span class="sc">+</span></span>
<span id="cb169-21"><a href="geom_detect.html#cb169-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb169-22"><a href="geom_detect.html#cb169-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb169-23"><a href="geom_detect.html#cb169-23" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span></span>
<span id="cb169-24"><a href="geom_detect.html#cb169-24" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb169-25"><a href="geom_detect.html#cb169-25" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb169-26"><a href="geom_detect.html#cb169-26" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb169-27"><a href="geom_detect.html#cb169-27" tabindex="-1"></a>  )</span>
<span id="cb169-28"><a href="geom_detect.html#cb169-28" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span></span>
<span id="cb169-29"><a href="geom_detect.html#cb169-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb169-30"><a href="geom_detect.html#cb169-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb169-31"><a href="geom_detect.html#cb169-31" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill=</span>circularity_ratio)</span>
<span id="cb169-32"><a href="geom_detect.html#cb169-32" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb169-33"><a href="geom_detect.html#cb169-33" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb169-34"><a href="geom_detect.html#cb169-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf_text</span>(</span>
<span id="cb169-35"><a href="geom_detect.html#cb169-35" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb169-36"><a href="geom_detect.html#cb169-36" tabindex="-1"></a>    , <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">label=</span>scales<span class="sc">::</span><span class="fu">percent</span>(circularity_ratio, <span class="at">accuracy=</span><span class="fl">0.1</span>))</span>
<span id="cb169-37"><a href="geom_detect.html#cb169-37" tabindex="-1"></a>    , <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span></span>
<span id="cb169-38"><a href="geom_detect.html#cb169-38" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb169-39"><a href="geom_detect.html#cb169-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_fermenter</span>(</span>
<span id="cb169-40"><a href="geom_detect.html#cb169-40" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">10</span>, <span class="at">palette =</span> <span class="st">&quot;PuOr&quot;</span></span>
<span id="cb169-41"><a href="geom_detect.html#cb169-41" tabindex="-1"></a>    , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb169-42"><a href="geom_detect.html#cb169-42" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb169-43"><a href="geom_detect.html#cb169-43" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb169-44"><a href="geom_detect.html#cb169-44" tabindex="-1"></a>    , <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>)</span>
<span id="cb169-45"><a href="geom_detect.html#cb169-45" tabindex="-1"></a>    , <span class="at">name =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb169-46"><a href="geom_detect.html#cb169-46" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb169-47"><a href="geom_detect.html#cb169-47" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;dbscan&quot;</span>) <span class="sc">+</span></span>
<span id="cb169-48"><a href="geom_detect.html#cb169-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb169-49"><a href="geom_detect.html#cb169-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb169-50"><a href="geom_detect.html#cb169-50" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span></span>
<span id="cb169-51"><a href="geom_detect.html#cb169-51" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb169-52"><a href="geom_detect.html#cb169-52" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb169-53"><a href="geom_detect.html#cb169-53" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb169-54"><a href="geom_detect.html#cb169-54" tabindex="-1"></a>  )</span>
<span id="cb169-55"><a href="geom_detect.html#cb169-55" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb169-56"><a href="geom_detect.html#cb169-56" tabindex="-1"></a>  <span class="fu">list</span>(p1_temp,p2_temp)</span>
<span id="cb169-57"><a href="geom_detect.html#cb169-57" tabindex="-1"></a>  , <span class="at">guides =</span> <span class="st">&quot;collect&quot;</span></span>
<span id="cb169-58"><a href="geom_detect.html#cb169-58" tabindex="-1"></a>  , </span>
<span id="cb169-59"><a href="geom_detect.html#cb169-59" tabindex="-1"></a>) <span class="sc">&amp;</span></span>
<span id="cb169-60"><a href="geom_detect.html#cb169-60" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb169-61"><a href="geom_detect.html#cb169-61" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span></span>
<span id="cb169-62"><a href="geom_detect.html#cb169-62" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb169-63"><a href="geom_detect.html#cb169-63" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-201-1.png" alt="" width="1008" /></p>
<p>finally, let’s filter the candidate segments with a user-defined expectation of shape circularity on the 0-100% scale applied to the circularity ratio</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="geom_detect.html#cb170-1" tabindex="-1"></a><span class="co"># # min required overlap between the predicted pile and the MBC of the predicted pile</span></span>
<span id="cb170-2"><a href="geom_detect.html#cb170-2" tabindex="-1"></a>min_circularity_ratio <span class="ot">&lt;-</span> <span class="fl">0.45</span></span></code></pre></div>
<p>what proportion of the remaining segments were filtered using this shape circularity filter</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="geom_detect.html#cb171-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb171-2"><a href="geom_detect.html#cb171-2" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;watershed&quot;</span>, <span class="st">&quot;DBSCAN&quot;</span>)</span>
<span id="cb171-3"><a href="geom_detect.html#cb171-3" tabindex="-1"></a>    , <span class="at">old_segments =</span> <span class="fu">c</span>(</span>
<span id="cb171-4"><a href="geom_detect.html#cb171-4" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb171-5"><a href="geom_detect.html#cb171-5" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb171-6"><a href="geom_detect.html#cb171-6" tabindex="-1"></a>    )</span>
<span id="cb171-7"><a href="geom_detect.html#cb171-7" tabindex="-1"></a>    , <span class="at">new_segments =</span> <span class="fu">c</span>(</span>
<span id="cb171-8"><a href="geom_detect.html#cb171-8" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(circularity_ratio<span class="sc">&gt;=</span>min_circularity_ratio) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb171-9"><a href="geom_detect.html#cb171-9" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(circularity_ratio<span class="sc">&gt;=</span>min_circularity_ratio) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb171-10"><a href="geom_detect.html#cb171-10" tabindex="-1"></a>    )</span>
<span id="cb171-11"><a href="geom_detect.html#cb171-11" tabindex="-1"></a>    , <span class="at">area =</span> <span class="fu">c</span>(</span>
<span id="cb171-12"><a href="geom_detect.html#cb171-12" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb171-13"><a href="geom_detect.html#cb171-13" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(circularity_ratio<span class="sc">&gt;=</span>min_circularity_ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb171-14"><a href="geom_detect.html#cb171-14" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb171-15"><a href="geom_detect.html#cb171-15" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb171-16"><a href="geom_detect.html#cb171-16" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb171-17"><a href="geom_detect.html#cb171-17" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb171-18"><a href="geom_detect.html#cb171-18" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(circularity_ratio<span class="sc">&gt;=</span>min_circularity_ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb171-19"><a href="geom_detect.html#cb171-19" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb171-20"><a href="geom_detect.html#cb171-20" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb171-21"><a href="geom_detect.html#cb171-21" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb171-22"><a href="geom_detect.html#cb171-22" tabindex="-1"></a>    )</span>
<span id="cb171-23"><a href="geom_detect.html#cb171-23" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb171-24"><a href="geom_detect.html#cb171-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb171-25"><a href="geom_detect.html#cb171-25" tabindex="-1"></a>    <span class="at">pct_removed =</span> scales<span class="sc">::</span><span class="fu">percent</span>((new_segments<span class="sc">-</span>old_segments)<span class="sc">/</span>old_segments, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb171-26"><a href="geom_detect.html#cb171-26" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;segments&quot;</span>), <span class="sc">~</span>scales<span class="sc">::</span><span class="fu">comma</span>(.x,<span class="at">accuracy=</span><span class="dv">1</span>))</span>
<span id="cb171-27"><a href="geom_detect.html#cb171-27" tabindex="-1"></a>    , <span class="at">area =</span> scales<span class="sc">::</span><span class="fu">comma</span>(area,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb171-28"><a href="geom_detect.html#cb171-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb171-29"><a href="geom_detect.html#cb171-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(method,pct_removed) <span class="sc">%&gt;%</span> </span>
<span id="cb171-30"><a href="geom_detect.html#cb171-30" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb171-31"><a href="geom_detect.html#cb171-31" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Demonstration area candidate segments by method&lt;br&gt;filtered by segment circularity&quot;</span></span>
<span id="cb171-32"><a href="geom_detect.html#cb171-32" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb171-33"><a href="geom_detect.html#cb171-33" tabindex="-1"></a>      <span class="st">&quot;method&quot;</span>, <span class="st">&quot;% removed&quot;</span></span>
<span id="cb171-34"><a href="geom_detect.html#cb171-34" tabindex="-1"></a>      , <span class="st">&quot;orig. candidate segments&quot;</span></span>
<span id="cb171-35"><a href="geom_detect.html#cb171-35" tabindex="-1"></a>      , <span class="st">&quot;filtered candidate segments&quot;</span></span>
<span id="cb171-36"><a href="geom_detect.html#cb171-36" tabindex="-1"></a>      , <span class="st">&quot;remaining candidate area (m&lt;sup&gt;2&lt;/sup&gt;)&quot;</span></span>
<span id="cb171-37"><a href="geom_detect.html#cb171-37" tabindex="-1"></a>    )</span>
<span id="cb171-38"><a href="geom_detect.html#cb171-38" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb171-39"><a href="geom_detect.html#cb171-39" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb171-40"><a href="geom_detect.html#cb171-40" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-203">Table 4.5: </span>Demonstration area candidate segments by method<br>filtered by segment circularity
</caption>
<thead>
<tr>
<th style="text-align:left;">
method
</th>
<th style="text-align:left;">
% removed
</th>
<th style="text-align:left;">
orig. candidate segments
</th>
<th style="text-align:left;">
filtered candidate segments
</th>
<th style="text-align:left;">
remaining candidate area (m<sup>2</sup>)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
watershed
</td>
<td style="text-align:left;">
-20.0%
</td>
<td style="text-align:left;">
30
</td>
<td style="text-align:left;">
24
</td>
<td style="text-align:left;">
214.18
</td>
</tr>
<tr>
<td style="text-align:left;">
DBSCAN
</td>
<td style="text-align:left;">
-16.7%
</td>
<td style="text-align:left;">
30
</td>
<td style="text-align:left;">
25
</td>
<td style="text-align:left;">
216.46
</td>
</tr>
</tbody>
</table>
<p>actually apply the filter ;)</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="geom_detect.html#cb172-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb172-2"><a href="geom_detect.html#cb172-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span> watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb172-3"><a href="geom_detect.html#cb172-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(circularity_ratio<span class="sc">&gt;=</span>min_circularity_ratio)</span>
<span id="cb172-4"><a href="geom_detect.html#cb172-4" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb172-5"><a href="geom_detect.html#cb172-5" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb172-6"><a href="geom_detect.html#cb172-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(circularity_ratio<span class="sc">&gt;=</span>min_circularity_ratio)</span></code></pre></div>
<div id="watershed-segmentation-2" class="section level4 hasAnchor" number="4.4.2.1">
<h4><span class="header-section-number">4.4.2.1</span> Watershed Segmentation<a href="geom_detect.html#watershed-segmentation-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="geom_detect.html#cb173-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb173-2"><a href="geom_detect.html#cb173-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb173-3"><a href="geom_detect.html#cb173-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb173-4"><a href="geom_detect.html#cb173-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb173-5"><a href="geom_detect.html#cb173-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb173-6"><a href="geom_detect.html#cb173-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb173-7"><a href="geom_detect.html#cb173-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb173-8"><a href="geom_detect.html#cb173-8" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb173-9"><a href="geom_detect.html#cb173-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb173-10"><a href="geom_detect.html#cb173-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb173-11"><a href="geom_detect.html#cb173-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-206-1.png" alt="" width="1008" /></p>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="geom_detect.html#cb174-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb174-2"><a href="geom_detect.html#cb174-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb174-3"><a href="geom_detect.html#cb174-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb174-4"><a href="geom_detect.html#cb174-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb174-5"><a href="geom_detect.html#cb174-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb174-6"><a href="geom_detect.html#cb174-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb174-7"><a href="geom_detect.html#cb174-7" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb174-8"><a href="geom_detect.html#cb174-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb174-9"><a href="geom_detect.html#cb174-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-208-1.png" alt="" width="1008" /></p>
</div>
<div id="dbscan-segmentation-2" class="section level4 hasAnchor" number="4.4.2.2">
<h4><span class="header-section-number">4.4.2.2</span> DBSCAN Segmentation<a href="geom_detect.html#dbscan-segmentation-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="geom_detect.html#cb175-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb175-2"><a href="geom_detect.html#cb175-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb175-3"><a href="geom_detect.html#cb175-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb175-4"><a href="geom_detect.html#cb175-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb175-5"><a href="geom_detect.html#cb175-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb175-6"><a href="geom_detect.html#cb175-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb175-7"><a href="geom_detect.html#cb175-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb175-8"><a href="geom_detect.html#cb175-8" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb175-9"><a href="geom_detect.html#cb175-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb175-10"><a href="geom_detect.html#cb175-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb175-11"><a href="geom_detect.html#cb175-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-211-1.png" alt="" width="1008" /></p>
<p>plot the filtered dbscan candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="geom_detect.html#cb176-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb176-2"><a href="geom_detect.html#cb176-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb176-3"><a href="geom_detect.html#cb176-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb176-4"><a href="geom_detect.html#cb176-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb176-5"><a href="geom_detect.html#cb176-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb176-6"><a href="geom_detect.html#cb176-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb176-7"><a href="geom_detect.html#cb176-7" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb176-8"><a href="geom_detect.html#cb176-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb176-9"><a href="geom_detect.html#cb176-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-213-1.png" alt="" width="1008" /></p>
</div>
<div id="circularity-filter-function" class="section level4 hasAnchor" number="4.4.2.3">
<h4><span class="header-section-number">4.4.2.3</span> Circularity Filter Function<a href="geom_detect.html#circularity-filter-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s make a function to ingest a spatial data frame and return polygons filtered for irregularity using this minimum bounding circle process</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="geom_detect.html#cb177-1" tabindex="-1"></a>st_circularity_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb177-2"><a href="geom_detect.html#cb177-2" tabindex="-1"></a>  sf_data</span>
<span id="cb177-3"><a href="geom_detect.html#cb177-3" tabindex="-1"></a>  <span class="co"># min required overlap between the polygon and the minimum bounding circle of the polygon</span></span>
<span id="cb177-4"><a href="geom_detect.html#cb177-4" tabindex="-1"></a>  , <span class="at">min_circularity_ratio =</span> <span class="fl">0.6</span></span>
<span id="cb177-5"><a href="geom_detect.html#cb177-5" tabindex="-1"></a>) {</span>
<span id="cb177-6"><a href="geom_detect.html#cb177-6" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb177-7"><a href="geom_detect.html#cb177-7" tabindex="-1"></a>  <span class="co"># if not polygons</span></span>
<span id="cb177-8"><a href="geom_detect.html#cb177-8" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) ){</span>
<span id="cb177-9"><a href="geom_detect.html#cb177-9" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb177-10"><a href="geom_detect.html#cb177-10" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb177-11"><a href="geom_detect.html#cb177-11" tabindex="-1"></a>    ))</span>
<span id="cb177-12"><a href="geom_detect.html#cb177-12" tabindex="-1"></a>  }</span>
<span id="cb177-13"><a href="geom_detect.html#cb177-13" tabindex="-1"></a>  <span class="co"># minimum bounding circle of segments</span></span>
<span id="cb177-14"><a href="geom_detect.html#cb177-14" tabindex="-1"></a>  poly_mbc <span class="ot">&lt;-</span></span>
<span id="cb177-15"><a href="geom_detect.html#cb177-15" tabindex="-1"></a>    sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb177-16"><a href="geom_detect.html#cb177-16" tabindex="-1"></a>    lwgeom<span class="sc">::</span><span class="fu">st_minimum_bounding_circle</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb177-17"><a href="geom_detect.html#cb177-17" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb177-18"><a href="geom_detect.html#cb177-18" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb177-19"><a href="geom_detect.html#cb177-19" tabindex="-1"></a>    <span class="co"># dplyr::filter(sf::st_is_valid(.))</span></span>
<span id="cb177-20"><a href="geom_detect.html#cb177-20" tabindex="-1"></a>  <span class="co"># compare areas</span></span>
<span id="cb177-21"><a href="geom_detect.html#cb177-21" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(poly_mbc)<span class="sc">!=</span><span class="fu">nrow</span>(sf_data)){</span>
<span id="cb177-22"><a href="geom_detect.html#cb177-22" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;could not make valid minimum bounding circle from provided polygon data&quot;</span>)</span>
<span id="cb177-23"><a href="geom_detect.html#cb177-23" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb177-24"><a href="geom_detect.html#cb177-24" tabindex="-1"></a>    area_comp <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb177-25"><a href="geom_detect.html#cb177-25" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb177-26"><a href="geom_detect.html#cb177-26" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb177-27"><a href="geom_detect.html#cb177-27" tabindex="-1"></a>        poly_mbc <span class="sc">%&gt;%</span> </span>
<span id="cb177-28"><a href="geom_detect.html#cb177-28" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">mbc_area_xxxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb177-29"><a href="geom_detect.html#cb177-29" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(mbc_area_xxxx) <span class="sc">%&gt;%</span> </span>
<span id="cb177-30"><a href="geom_detect.html#cb177-30" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb177-31"><a href="geom_detect.html#cb177-31" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb177-32"><a href="geom_detect.html#cb177-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb177-33"><a href="geom_detect.html#cb177-33" tabindex="-1"></a>        <span class="at">circularity_ratio =</span> area_xxxx<span class="sc">/</span>mbc_area_xxxx</span>
<span id="cb177-34"><a href="geom_detect.html#cb177-34" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb177-35"><a href="geom_detect.html#cb177-35" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb177-36"><a href="geom_detect.html#cb177-36" tabindex="-1"></a>        circularity_ratio <span class="sc">&gt;=</span> min_circularity_ratio</span>
<span id="cb177-37"><a href="geom_detect.html#cb177-37" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb177-38"><a href="geom_detect.html#cb177-38" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(area_xxxx,mbc_area_xxxx))</span>
<span id="cb177-39"><a href="geom_detect.html#cb177-39" tabindex="-1"></a>    <span class="fu">return</span>(area_comp)</span>
<span id="cb177-40"><a href="geom_detect.html#cb177-40" tabindex="-1"></a>  }</span>
<span id="cb177-41"><a href="geom_detect.html#cb177-41" tabindex="-1"></a>}</span>
<span id="cb177-42"><a href="geom_detect.html#cb177-42" tabindex="-1"></a><span class="co"># dbscan_segs_poly$circularity_ratio %&gt;% summary()</span></span>
<span id="cb177-43"><a href="geom_detect.html#cb177-43" tabindex="-1"></a><span class="co"># dbscan_segs_poly %&gt;%</span></span>
<span id="cb177-44"><a href="geom_detect.html#cb177-44" tabindex="-1"></a><span class="co">#   st_circularity_filter(min_circularity_ratio = 0.7) %&gt;%</span></span>
<span id="cb177-45"><a href="geom_detect.html#cb177-45" tabindex="-1"></a><span class="co">#   dplyr::pull(circularity_ratio) %&gt;%</span></span>
<span id="cb177-46"><a href="geom_detect.html#cb177-46" tabindex="-1"></a><span class="co">#   summary()</span></span></code></pre></div>
</div>
<div id="quick-methods-comparison-1" class="section level4 hasAnchor" number="4.4.2.4">
<h4><span class="header-section-number">4.4.2.4</span> Quick methods comparison<a href="geom_detect.html#quick-methods-comparison-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s quickly look at the watershed and dbscan segments on the same plot now that we have removed candidate segments that 1) do not meet the area thresholds; 2) do not meet the convexity ratio threshold; and 3) do not meet the circularity ratio threshold</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="geom_detect.html#cb178-1" tabindex="-1"></a><span class="co"># watershed_segs_poly %&gt;% dplyr::glimpse()</span></span>
<span id="cb178-2"><a href="geom_detect.html#cb178-2" tabindex="-1"></a><span class="co"># dbscan_segs_poly %&gt;% dplyr::glimpse()</span></span>
<span id="cb178-3"><a href="geom_detect.html#cb178-3" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb178-4"><a href="geom_detect.html#cb178-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb178-5"><a href="geom_detect.html#cb178-5" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;watershed&quot;</span>)</span>
<span id="cb178-6"><a href="geom_detect.html#cb178-6" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb178-7"><a href="geom_detect.html#cb178-7" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb178-8"><a href="geom_detect.html#cb178-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb178-9"><a href="geom_detect.html#cb178-9" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;dbscan&quot;</span>)</span>
<span id="cb178-10"><a href="geom_detect.html#cb178-10" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb178-11"><a href="geom_detect.html#cb178-11" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb178-12"><a href="geom_detect.html#cb178-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray33&quot;</span>, <span class="st">&quot;aquamarine3&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb178-13"><a href="geom_detect.html#cb178-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb178-14"><a href="geom_detect.html#cb178-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-218-1.png" alt="" width="1008" /></p>
<p>after all of that, the results of the two methods are essentially the same for this particular demonstration area</p>
</div>
</div>
</div>
<div id="structural-metrics-from-chm" class="section level2 hasAnchor" number="4.5">
<h2><span class="header-section-number">4.5</span> Structural Metrics from CHM<a href="geom_detect.html#structural-metrics-from-chm" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll use the CHM raster to calculate area, height, and volume for each candidate pile to reflect the irregular pile footprints and elevation profiles that better represent real-world objects than assuming perfect geometric shapes like traditional pile measurement methods (<a href="https://doi.org/10.5849/forsci.13-501">Long and Boston, 2014</a>; <a href="https://doi.org/10.1139/cjfr-2013-0281">Trofymow et al., 2014</a>; <a href="https://doi.org/10.3389/ffgc.2025.1663753">Guth et al., 2025</a>)</p>
<p>Candidate slash pile structural metrics are derived from the CHM raster using zonal statistics to aggregate cell-level raster data within the boundaries of each pile. To ensure geodetic accuracy, an area raster is generated (<code>terra::cellSize()</code>) which accounts for minute variations in pixel area caused by the curvature of the Earth and the coordinate reference system. This area raster is then used as input for volume calculation, where it is multiplied by the CHM height values to create a volume raster. Summing the individual volume of every pixel within the candidate pile footprint yields the total pile volume with each cell in the volume raster treated as a rectangular prism with height from the CHM and base area from the area raster. Pile area is calculated by summing the area raster values within the candidate pile boundary and pile height is determined by the maximum CHM pixel value.</p>
<p>we’ll make a function to use polygon <code>sf</code> data and an input CHM raster to perform these calculations and return the data with metrics attached</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="geom_detect.html#cb179-1" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb179-2"><a href="geom_detect.html#cb179-2" tabindex="-1"></a><span class="do">## calculate raster-based area, height, and volume using zonal stats</span></span>
<span id="cb179-3"><a href="geom_detect.html#cb179-3" tabindex="-1"></a><span class="do">########################################################################################</span></span>
<span id="cb179-4"><a href="geom_detect.html#cb179-4" tabindex="-1"></a>get_structural_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb179-5"><a href="geom_detect.html#cb179-5" tabindex="-1"></a>    sf_data</span>
<span id="cb179-6"><a href="geom_detect.html#cb179-6" tabindex="-1"></a>    , chm_rast</span>
<span id="cb179-7"><a href="geom_detect.html#cb179-7" tabindex="-1"></a>    <span class="co"># , sf_id = NA</span></span>
<span id="cb179-8"><a href="geom_detect.html#cb179-8" tabindex="-1"></a>) {</span>
<span id="cb179-9"><a href="geom_detect.html#cb179-9" tabindex="-1"></a>  <span class="co"># check polygons</span></span>
<span id="cb179-10"><a href="geom_detect.html#cb179-10" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must include `sf` data object in &#39;sf_data&#39;&quot;</span>)}</span>
<span id="cb179-11"><a href="geom_detect.html#cb179-11" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) ){</span>
<span id="cb179-12"><a href="geom_detect.html#cb179-12" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb179-13"><a href="geom_detect.html#cb179-13" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb179-14"><a href="geom_detect.html#cb179-14" tabindex="-1"></a>    ))</span>
<span id="cb179-15"><a href="geom_detect.html#cb179-15" tabindex="-1"></a>  }</span>
<span id="cb179-16"><a href="geom_detect.html#cb179-16" tabindex="-1"></a>  sf_data <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb179-17"><a href="geom_detect.html#cb179-17" tabindex="-1"></a>  </span>
<span id="cb179-18"><a href="geom_detect.html#cb179-18" tabindex="-1"></a>  <span class="co"># check raster</span></span>
<span id="cb179-19"><a href="geom_detect.html#cb179-19" tabindex="-1"></a>  <span class="co"># convert to SpatRaster if input is from &#39;raster&#39; package</span></span>
<span id="cb179-20"><a href="geom_detect.html#cb179-20" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb179-21"><a href="geom_detect.html#cb179-21" tabindex="-1"></a>    <span class="fu">inherits</span>(chm_rast, <span class="st">&quot;RasterStack&quot;</span>) </span>
<span id="cb179-22"><a href="geom_detect.html#cb179-22" tabindex="-1"></a>    <span class="sc">||</span> <span class="fu">inherits</span>(chm_rast, <span class="st">&quot;RasterBrick&quot;</span>)</span>
<span id="cb179-23"><a href="geom_detect.html#cb179-23" tabindex="-1"></a>  ){</span>
<span id="cb179-24"><a href="geom_detect.html#cb179-24" tabindex="-1"></a>    chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(chm_rast)</span>
<span id="cb179-25"><a href="geom_detect.html#cb179-25" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb179-26"><a href="geom_detect.html#cb179-26" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; must be a SpatRaster from the `terra` package&quot;</span>)</span>
<span id="cb179-27"><a href="geom_detect.html#cb179-27" tabindex="-1"></a>  }</span>
<span id="cb179-28"><a href="geom_detect.html#cb179-28" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>)</span>
<span id="cb179-29"><a href="geom_detect.html#cb179-29" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb179-30"><a href="geom_detect.html#cb179-30" tabindex="-1"></a>    <span class="fu">as.numeric</span>(terra<span class="sc">::</span><span class="fu">global</span>(chm_rast, <span class="at">fun =</span> <span class="st">&quot;isNA&quot;</span>)) <span class="sc">==</span> terra<span class="sc">::</span><span class="fu">ncell</span>(chm_rast) </span>
<span id="cb179-31"><a href="geom_detect.html#cb179-31" tabindex="-1"></a>    <span class="co"># || as.numeric(terra::global(chm_rast, fun = &quot;isNA&quot;)) &gt;= round(terra::ncell(chm_rast)*0.98)</span></span>
<span id="cb179-32"><a href="geom_detect.html#cb179-32" tabindex="-1"></a>  ){</span>
<span id="cb179-33"><a href="geom_detect.html#cb179-33" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;chm_rast&#39; has all missing values&quot;</span>)</span>
<span id="cb179-34"><a href="geom_detect.html#cb179-34" tabindex="-1"></a>  }</span>
<span id="cb179-35"><a href="geom_detect.html#cb179-35" tabindex="-1"></a>  </span>
<span id="cb179-36"><a href="geom_detect.html#cb179-36" tabindex="-1"></a>  <span class="co"># # check id</span></span>
<span id="cb179-37"><a href="geom_detect.html#cb179-37" tabindex="-1"></a>  <span class="co"># if(!inherits(sf_id, &quot;character&quot;)){</span></span>
<span id="cb179-38"><a href="geom_detect.html#cb179-38" tabindex="-1"></a>  <span class="co">#   # stop(&quot;must include &#39;sf_id&#39; as the unique identifier&quot;)</span></span>
<span id="cb179-39"><a href="geom_detect.html#cb179-39" tabindex="-1"></a>  <span class="co">#   sf_data &lt;- sf_data %&gt;% </span></span>
<span id="cb179-40"><a href="geom_detect.html#cb179-40" tabindex="-1"></a>  <span class="co">#     dplyr::mutate(idxxxxx = dplyr::row_number())</span></span>
<span id="cb179-41"><a href="geom_detect.html#cb179-41" tabindex="-1"></a>  <span class="co">#   sf_id &lt;- &quot;idxxxxx&quot;</span></span>
<span id="cb179-42"><a href="geom_detect.html#cb179-42" tabindex="-1"></a>  <span class="co"># }else{</span></span>
<span id="cb179-43"><a href="geom_detect.html#cb179-43" tabindex="-1"></a>  <span class="co">#   if( !any( stringr::str_equal(names(sf_data), sf_id) ) ){</span></span>
<span id="cb179-44"><a href="geom_detect.html#cb179-44" tabindex="-1"></a>  <span class="co">#     stop(paste0(&quot;could not locate &#39;&quot;,sf_id,&quot;&#39; in sf_data&quot;))</span></span>
<span id="cb179-45"><a href="geom_detect.html#cb179-45" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb179-46"><a href="geom_detect.html#cb179-46" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb179-47"><a href="geom_detect.html#cb179-47" tabindex="-1"></a>  </span>
<span id="cb179-48"><a href="geom_detect.html#cb179-48" tabindex="-1"></a>  <span class="co"># check overlap</span></span>
<span id="cb179-49"><a href="geom_detect.html#cb179-49" tabindex="-1"></a>  <span class="co"># Returns TRUE if any part of the vector geometry intersects the raster extent</span></span>
<span id="cb179-50"><a href="geom_detect.html#cb179-50" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb179-51"><a href="geom_detect.html#cb179-51" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">any</span>(terra<span class="sc">::</span><span class="fu">is.related</span>(</span>
<span id="cb179-52"><a href="geom_detect.html#cb179-52" tabindex="-1"></a>      <span class="at">x =</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb179-53"><a href="geom_detect.html#cb179-53" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb179-54"><a href="geom_detect.html#cb179-54" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb179-55"><a href="geom_detect.html#cb179-55" tabindex="-1"></a>      , <span class="at">y =</span> terra<span class="sc">::</span><span class="fu">ext</span>(chm_rast)</span>
<span id="cb179-56"><a href="geom_detect.html#cb179-56" tabindex="-1"></a>      , <span class="at">relation =</span> <span class="st">&quot;intersects&quot;</span></span>
<span id="cb179-57"><a href="geom_detect.html#cb179-57" tabindex="-1"></a>    ))</span>
<span id="cb179-58"><a href="geom_detect.html#cb179-58" tabindex="-1"></a>  ){</span>
<span id="cb179-59"><a href="geom_detect.html#cb179-59" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;sf_data&#39; does not overlap with &#39;chm_rast&#39;&quot;</span>)</span>
<span id="cb179-60"><a href="geom_detect.html#cb179-60" tabindex="-1"></a>  }</span>
<span id="cb179-61"><a href="geom_detect.html#cb179-61" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb179-62"><a href="geom_detect.html#cb179-62" tabindex="-1"></a>  <span class="co"># area, volume of each cell</span></span>
<span id="cb179-63"><a href="geom_detect.html#cb179-63" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb179-64"><a href="geom_detect.html#cb179-64" tabindex="-1"></a>  area_rast_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(chm_rast)</span>
<span id="cb179-65"><a href="geom_detect.html#cb179-65" tabindex="-1"></a>  <span class="fu">names</span>(area_rast_temp) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb179-66"><a href="geom_detect.html#cb179-66" tabindex="-1"></a>  <span class="co"># area_rast_temp %&gt;% terra::plot()</span></span>
<span id="cb179-67"><a href="geom_detect.html#cb179-67" tabindex="-1"></a>  <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb179-68"><a href="geom_detect.html#cb179-68" tabindex="-1"></a>  vol_rast_temp <span class="ot">&lt;-</span> area_rast_temp<span class="sc">*</span>chm_rast</span>
<span id="cb179-69"><a href="geom_detect.html#cb179-69" tabindex="-1"></a>  <span class="fu">names</span>(vol_rast_temp) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb179-70"><a href="geom_detect.html#cb179-70" tabindex="-1"></a>  <span class="co"># vol_rast_temp %&gt;% terra::plot()</span></span>
<span id="cb179-71"><a href="geom_detect.html#cb179-71" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb179-72"><a href="geom_detect.html#cb179-72" tabindex="-1"></a>  <span class="co"># zonal stats</span></span>
<span id="cb179-73"><a href="geom_detect.html#cb179-73" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb179-74"><a href="geom_detect.html#cb179-74" tabindex="-1"></a>  <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb179-75"><a href="geom_detect.html#cb179-75" tabindex="-1"></a>  area_df_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(</span>
<span id="cb179-76"><a href="geom_detect.html#cb179-76" tabindex="-1"></a>      <span class="at">x =</span> area_rast_temp</span>
<span id="cb179-77"><a href="geom_detect.html#cb179-77" tabindex="-1"></a>      , <span class="at">z =</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb179-78"><a href="geom_detect.html#cb179-78" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb179-79"><a href="geom_detect.html#cb179-79" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb179-80"><a href="geom_detect.html#cb179-80" tabindex="-1"></a>      , <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T</span>
<span id="cb179-81"><a href="geom_detect.html#cb179-81" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb179-82"><a href="geom_detect.html#cb179-82" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="st">&quot;area_m2&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-83"><a href="geom_detect.html#cb179-83" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_m2 =</span> dplyr<span class="sc">::</span><span class="fu">na_if</span>(area_m2, <span class="cn">NaN</span>))</span>
<span id="cb179-84"><a href="geom_detect.html#cb179-84" tabindex="-1"></a>  <span class="co"># area_df_temp %&gt;% dplyr::glimpse()</span></span>
<span id="cb179-85"><a href="geom_detect.html#cb179-85" tabindex="-1"></a>  <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb179-86"><a href="geom_detect.html#cb179-86" tabindex="-1"></a>  vol_df_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(</span>
<span id="cb179-87"><a href="geom_detect.html#cb179-87" tabindex="-1"></a>      <span class="at">x =</span> vol_rast_temp</span>
<span id="cb179-88"><a href="geom_detect.html#cb179-88" tabindex="-1"></a>      , <span class="at">z =</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb179-89"><a href="geom_detect.html#cb179-89" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb179-90"><a href="geom_detect.html#cb179-90" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb179-91"><a href="geom_detect.html#cb179-91" tabindex="-1"></a>      , <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T</span>
<span id="cb179-92"><a href="geom_detect.html#cb179-92" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb179-93"><a href="geom_detect.html#cb179-93" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="st">&quot;volume_m3&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-94"><a href="geom_detect.html#cb179-94" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">volume_m3 =</span> dplyr<span class="sc">::</span><span class="fu">na_if</span>(volume_m3, <span class="cn">NaN</span>))</span>
<span id="cb179-95"><a href="geom_detect.html#cb179-95" tabindex="-1"></a>  <span class="co"># vol_df_temp %&gt;% dplyr::glimpse()</span></span>
<span id="cb179-96"><a href="geom_detect.html#cb179-96" tabindex="-1"></a>  <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb179-97"><a href="geom_detect.html#cb179-97" tabindex="-1"></a>  ht_df_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(</span>
<span id="cb179-98"><a href="geom_detect.html#cb179-98" tabindex="-1"></a>      <span class="at">x =</span> chm_rast</span>
<span id="cb179-99"><a href="geom_detect.html#cb179-99" tabindex="-1"></a>      , <span class="at">z =</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb179-100"><a href="geom_detect.html#cb179-100" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb179-101"><a href="geom_detect.html#cb179-101" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb179-102"><a href="geom_detect.html#cb179-102" tabindex="-1"></a>      , <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T</span>
<span id="cb179-103"><a href="geom_detect.html#cb179-103" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb179-104"><a href="geom_detect.html#cb179-104" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="st">&quot;max_height_m&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-105"><a href="geom_detect.html#cb179-105" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">max_height_m =</span> dplyr<span class="sc">::</span><span class="fu">na_if</span>(max_height_m, <span class="cn">NaN</span>))</span>
<span id="cb179-106"><a href="geom_detect.html#cb179-106" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb179-107"><a href="geom_detect.html#cb179-107" tabindex="-1"></a>  <span class="co"># attach to sf</span></span>
<span id="cb179-108"><a href="geom_detect.html#cb179-108" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb179-109"><a href="geom_detect.html#cb179-109" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb179-110"><a href="geom_detect.html#cb179-110" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">identical</span>(</span>
<span id="cb179-111"><a href="geom_detect.html#cb179-111" tabindex="-1"></a>      <span class="fu">nrow</span>(sf_data)</span>
<span id="cb179-112"><a href="geom_detect.html#cb179-112" tabindex="-1"></a>      , <span class="fu">nrow</span>(area_df_temp)</span>
<span id="cb179-113"><a href="geom_detect.html#cb179-113" tabindex="-1"></a>      , <span class="fu">nrow</span>(vol_df_temp)</span>
<span id="cb179-114"><a href="geom_detect.html#cb179-114" tabindex="-1"></a>      , <span class="fu">nrow</span>(ht_df_temp)</span>
<span id="cb179-115"><a href="geom_detect.html#cb179-115" tabindex="-1"></a>    )</span>
<span id="cb179-116"><a href="geom_detect.html#cb179-116" tabindex="-1"></a>  ){</span>
<span id="cb179-117"><a href="geom_detect.html#cb179-117" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;unable to find data in raster for given vectors&quot;</span>)</span>
<span id="cb179-118"><a href="geom_detect.html#cb179-118" tabindex="-1"></a>  }</span>
<span id="cb179-119"><a href="geom_detect.html#cb179-119" tabindex="-1"></a>  </span>
<span id="cb179-120"><a href="geom_detect.html#cb179-120" tabindex="-1"></a>  ret_dta <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span></span>
<span id="cb179-121"><a href="geom_detect.html#cb179-121" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb179-122"><a href="geom_detect.html#cb179-122" tabindex="-1"></a>      <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb179-123"><a href="geom_detect.html#cb179-123" tabindex="-1"></a>      , <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb179-124"><a href="geom_detect.html#cb179-124" tabindex="-1"></a>      , <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb179-125"><a href="geom_detect.html#cb179-125" tabindex="-1"></a>      , <span class="st">&quot;max_height_m&quot;</span></span>
<span id="cb179-126"><a href="geom_detect.html#cb179-126" tabindex="-1"></a>      , <span class="st">&quot;volume_per_area&quot;</span></span>
<span id="cb179-127"><a href="geom_detect.html#cb179-127" tabindex="-1"></a>    ))) <span class="sc">%&gt;%</span> </span>
<span id="cb179-128"><a href="geom_detect.html#cb179-128" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb179-129"><a href="geom_detect.html#cb179-129" tabindex="-1"></a>      area_df_temp</span>
<span id="cb179-130"><a href="geom_detect.html#cb179-130" tabindex="-1"></a>      , vol_df_temp</span>
<span id="cb179-131"><a href="geom_detect.html#cb179-131" tabindex="-1"></a>      , ht_df_temp</span>
<span id="cb179-132"><a href="geom_detect.html#cb179-132" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb179-133"><a href="geom_detect.html#cb179-133" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb179-134"><a href="geom_detect.html#cb179-134" tabindex="-1"></a>      <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb179-135"><a href="geom_detect.html#cb179-135" tabindex="-1"></a>    )</span>
<span id="cb179-136"><a href="geom_detect.html#cb179-136" tabindex="-1"></a>  <span class="co"># ret_dta &lt;- sf_data %&gt;%</span></span>
<span id="cb179-137"><a href="geom_detect.html#cb179-137" tabindex="-1"></a>  <span class="co">#   purrr::reduce(</span></span>
<span id="cb179-138"><a href="geom_detect.html#cb179-138" tabindex="-1"></a>  <span class="co">#     list(sf_data, area_df_temp, vol_df_temp, ht_df_temp)</span></span>
<span id="cb179-139"><a href="geom_detect.html#cb179-139" tabindex="-1"></a>  <span class="co">#     , dplyr::left_join</span></span>
<span id="cb179-140"><a href="geom_detect.html#cb179-140" tabindex="-1"></a>  <span class="co">#     , by = sf_id</span></span>
<span id="cb179-141"><a href="geom_detect.html#cb179-141" tabindex="-1"></a>  <span class="co">#   ) %&gt;% </span></span>
<span id="cb179-142"><a href="geom_detect.html#cb179-142" tabindex="-1"></a>  <span class="co">#   dplyr::mutate(</span></span>
<span id="cb179-143"><a href="geom_detect.html#cb179-143" tabindex="-1"></a>  <span class="co">#     volume_per_area = volume_m3/area_m2</span></span>
<span id="cb179-144"><a href="geom_detect.html#cb179-144" tabindex="-1"></a>  <span class="co">#   )</span></span>
<span id="cb179-145"><a href="geom_detect.html#cb179-145" tabindex="-1"></a>  </span>
<span id="cb179-146"><a href="geom_detect.html#cb179-146" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb179-147"><a href="geom_detect.html#cb179-147" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb179-148"><a href="geom_detect.html#cb179-148" tabindex="-1"></a>      <span class="at">sf_data =</span> ret_dta</span>
<span id="cb179-149"><a href="geom_detect.html#cb179-149" tabindex="-1"></a>      , <span class="at">area_rast =</span> area_rast_temp</span>
<span id="cb179-150"><a href="geom_detect.html#cb179-150" tabindex="-1"></a>      , <span class="at">volume_rast =</span> vol_rast_temp</span>
<span id="cb179-151"><a href="geom_detect.html#cb179-151" tabindex="-1"></a>    )</span>
<span id="cb179-152"><a href="geom_detect.html#cb179-152" tabindex="-1"></a>  )</span>
<span id="cb179-153"><a href="geom_detect.html#cb179-153" tabindex="-1"></a>}</span>
<span id="cb179-154"><a href="geom_detect.html#cb179-154" tabindex="-1"></a></span>
<span id="cb179-155"><a href="geom_detect.html#cb179-155" tabindex="-1"></a><span class="co"># get_structural_metrics(sf_data = watershed_segs_poly, chm_rast = aoi_chm_rast_slice) %&gt;% </span></span>
<span id="cb179-156"><a href="geom_detect.html#cb179-156" tabindex="-1"></a><span class="co">#   dplyr::glimpse()</span></span>
<span id="cb179-157"><a href="geom_detect.html#cb179-157" tabindex="-1"></a><span class="co"># get_structural_metrics(sf_data = watershed_segs_poly, chm_rast = arnf_chm_rast) %&gt;% </span></span>
<span id="cb179-158"><a href="geom_detect.html#cb179-158" tabindex="-1"></a><span class="co">#   dplyr::glimpse()</span></span></code></pre></div>
<div id="structural-rasters" class="section level3 hasAnchor" number="4.5.1">
<h3><span class="header-section-number">4.5.1</span> Structural Rasters<a href="geom_detect.html#structural-rasters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we can quickly look at the area raster that was used for the volume calculation</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="geom_detect.html#cb180-1" tabindex="-1"></a><span class="fu">get_structural_metrics</span>(<span class="at">sf_data =</span> watershed_segs_poly, <span class="at">chm_rast =</span> aoi_chm_rast_slice) <span class="sc">%&gt;%</span> </span>
<span id="cb180-2"><a href="geom_detect.html#cb180-2" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;area_rast&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb180-3"><a href="geom_detect.html#cb180-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F, <span class="at">col =</span> grDevices<span class="sc">::</span><span class="fu">gray.colors</span>(<span class="at">n=</span><span class="dv">100</span>), <span class="at">main =</span> <span class="st">&quot;area (m2)&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-221-1.png" alt="" width="1008" /></p>
<p>and we can quickly look at the volume raster</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="geom_detect.html#cb181-1" tabindex="-1"></a><span class="fu">get_structural_metrics</span>(<span class="at">sf_data =</span> watershed_segs_poly, <span class="at">chm_rast =</span> aoi_chm_rast_slice) <span class="sc">%&gt;%</span> </span>
<span id="cb181-2"><a href="geom_detect.html#cb181-2" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;volume_rast&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb181-3"><a href="geom_detect.html#cb181-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F, <span class="at">col =</span> grDevices<span class="sc">::</span><span class="fu">gray.colors</span>(<span class="at">n=</span><span class="dv">100</span>), <span class="at">main =</span> <span class="st">&quot;volume (m3)&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-222-1.png" alt="" width="1008" /></p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="geom_detect.html#cb182-1" tabindex="-1"></a><span class="co"># terra::plot(</span></span>
<span id="cb182-2"><a href="geom_detect.html#cb182-2" tabindex="-1"></a><span class="co">#   aoi_slash_piles_polys %&gt;% </span></span>
<span id="cb182-3"><a href="geom_detect.html#cb182-3" tabindex="-1"></a><span class="co">#     sf::st_transform(terra::crs(aoi_chm_rast_slice)) %&gt;% </span></span>
<span id="cb182-4"><a href="geom_detect.html#cb182-4" tabindex="-1"></a><span class="co">#     terra::vect()</span></span>
<span id="cb182-5"><a href="geom_detect.html#cb182-5" tabindex="-1"></a><span class="co">#   , add = T, border = &quot;cyan&quot;, col = NA, lwd = 1.2</span></span>
<span id="cb182-6"><a href="geom_detect.html#cb182-6" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div>
<p>the volume raster mirrors the CHM but with volume as the cell value instead of height</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="geom_detect.html#cb183-1" tabindex="-1"></a>aoi_chm_rast_slice <span class="sc">%&gt;%</span> </span>
<span id="cb183-2"><a href="geom_detect.html#cb183-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">main =</span> <span class="st">&quot;CHM (m)&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-223-1.png" alt="" width="1008" /></p>
</div>
<div id="demonstration-candidate-segment-metrics" class="section level3 hasAnchor" number="4.5.2">
<h3><span class="header-section-number">4.5.2</span> Demonstration Candidate Segment Metrics<a href="geom_detect.html#demonstration-candidate-segment-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we’ll use our <code>get_structural_metrics()</code> with the height-filtered CHM to compute the structural metrics for the candidate piles</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="geom_detect.html#cb184-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb184-2"><a href="geom_detect.html#cb184-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span> <span class="fu">get_structural_metrics</span>(<span class="at">sf_data =</span> watershed_segs_poly, <span class="at">chm_rast =</span> aoi_chm_rast_slice) <span class="sc">%&gt;%</span> </span>
<span id="cb184-3"><a href="geom_detect.html#cb184-3" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;sf_data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb184-4"><a href="geom_detect.html#cb184-4" tabindex="-1"></a>  <span class="co"># we already have area so we&#39;ll drop the value from this function</span></span>
<span id="cb184-5"><a href="geom_detect.html#cb184-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb184-6"><a href="geom_detect.html#cb184-6" tabindex="-1"></a>    <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb184-7"><a href="geom_detect.html#cb184-7" tabindex="-1"></a>    , <span class="st">&quot;poly_area_m2&quot;</span></span>
<span id="cb184-8"><a href="geom_detect.html#cb184-8" tabindex="-1"></a>  )))</span>
<span id="cb184-9"><a href="geom_detect.html#cb184-9" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb184-10"><a href="geom_detect.html#cb184-10" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span> <span class="fu">get_structural_metrics</span>(<span class="at">sf_data =</span> dbscan_segs_poly, <span class="at">chm_rast =</span> aoi_chm_rast_slice) <span class="sc">%&gt;%</span> </span>
<span id="cb184-11"><a href="geom_detect.html#cb184-11" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;sf_data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb184-12"><a href="geom_detect.html#cb184-12" tabindex="-1"></a>  <span class="co"># we already have area so we&#39;ll drop the value from this function</span></span>
<span id="cb184-13"><a href="geom_detect.html#cb184-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb184-14"><a href="geom_detect.html#cb184-14" tabindex="-1"></a>    <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb184-15"><a href="geom_detect.html#cb184-15" tabindex="-1"></a>    , <span class="st">&quot;poly_area_m2&quot;</span></span>
<span id="cb184-16"><a href="geom_detect.html#cb184-16" tabindex="-1"></a>  )))</span></code></pre></div>
<p>what did we get back?</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="geom_detect.html#cb185-1" tabindex="-1"></a>watershed_segs_poly <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 24
## Columns: 10
## $ pred_id           &lt;dbl&gt; 22, 133, 135, 141, 142, 143, 145, 146, 147, 151, 156…
## $ chull_area_m2     &lt;dbl&gt; 9.495, 25.320, 26.820, 5.275, 5.055, 20.255, 6.175, …
## $ convexity_ratio   &lt;dbl&gt; 0.7761980, 0.9095577, 0.8941089, 0.9383886, 0.929772…
## $ mbc_area_m2       &lt;dbl&gt; 15.316338, 33.030222, 35.734991, 10.370370, 6.234503…
## $ circularity_ratio &lt;dbl&gt; 0.4811855, 0.6972402, 0.6710510, 0.4773215, 0.753869…
## $ area_m2           &lt;dbl&gt; 7.375899, 23.048435, 23.999195, 4.953962, 4.703762, …
## $ volume_m3         &lt;dbl&gt; 32.331139, 31.446938, 35.541131, 5.187639, 4.081403,…
## $ max_height_m      &lt;dbl&gt; 5.965939, 3.566000, 3.181000, 2.578000, 2.559000, 2.…
## $ volume_per_area   &lt;dbl&gt; 4.3833487, 1.3643850, 1.4809301, 1.0471696, 0.867689…
## $ geometry          &lt;POLYGON [m]&gt; POLYGON ((499326 4317738, 4..., POLYGON ((49…</code></pre>
<p>plot the metrics of pile area, height, and volume</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="geom_detect.html#cb187-1" tabindex="-1"></a><span class="co"># p1_temp &lt;-</span></span>
<span id="cb187-2"><a href="geom_detect.html#cb187-2" tabindex="-1"></a>p_fn_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(dta,fill_col,<span class="at">col_nm=</span>latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;area $</span><span class="sc">\\</span><span class="st">textrm{m}^2$&quot;</span>),<span class="at">pal=</span><span class="st">&quot;Oranges&quot;</span>){</span>
<span id="cb187-3"><a href="geom_detect.html#cb187-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">data =</span> dta) <span class="sc">+</span></span>
<span id="cb187-4"><a href="geom_detect.html#cb187-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb187-5"><a href="geom_detect.html#cb187-5" tabindex="-1"></a>    <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill=</span>.data[[fill_col]])</span>
<span id="cb187-6"><a href="geom_detect.html#cb187-6" tabindex="-1"></a>    <span class="co"># mapping=ggplot2::aes(fill={{fill_col}})</span></span>
<span id="cb187-7"><a href="geom_detect.html#cb187-7" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb187-8"><a href="geom_detect.html#cb187-8" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb187-9"><a href="geom_detect.html#cb187-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf_text</span>(</span>
<span id="cb187-10"><a href="geom_detect.html#cb187-10" tabindex="-1"></a>    <span class="co"># mapping=ggplot2::aes(label=scales::comma({{fill_col}}, accuracy=0.1))</span></span>
<span id="cb187-11"><a href="geom_detect.html#cb187-11" tabindex="-1"></a>    <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">label=</span>scales<span class="sc">::</span><span class="fu">comma</span>(.data[[fill_col]], <span class="at">accuracy=</span><span class="fl">0.1</span>))</span>
<span id="cb187-12"><a href="geom_detect.html#cb187-12" tabindex="-1"></a>    , <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.9</span>, <span class="at">size =</span> <span class="fl">2.5</span></span>
<span id="cb187-13"><a href="geom_detect.html#cb187-13" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb187-14"><a href="geom_detect.html#cb187-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> pal, <span class="at">name =</span> col_nm, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb187-15"><a href="geom_detect.html#cb187-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> col_nm) <span class="sc">+</span></span>
<span id="cb187-16"><a href="geom_detect.html#cb187-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb187-17"><a href="geom_detect.html#cb187-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb187-18"><a href="geom_detect.html#cb187-18" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span></span>
<span id="cb187-19"><a href="geom_detect.html#cb187-19" tabindex="-1"></a>    , <span class="at">legend.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb187-20"><a href="geom_detect.html#cb187-20" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb187-21"><a href="geom_detect.html#cb187-21" tabindex="-1"></a>    , <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb187-22"><a href="geom_detect.html#cb187-22" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb187-23"><a href="geom_detect.html#cb187-23" tabindex="-1"></a>  )</span>
<span id="cb187-24"><a href="geom_detect.html#cb187-24" tabindex="-1"></a>}</span>
<span id="cb187-25"><a href="geom_detect.html#cb187-25" tabindex="-1"></a><span class="co"># lists</span></span>
<span id="cb187-26"><a href="geom_detect.html#cb187-26" tabindex="-1"></a>pal_temp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Blues&quot;</span>,<span class="st">&quot;Purples&quot;</span>,<span class="st">&quot;Greens&quot;</span>)</span>
<span id="cb187-27"><a href="geom_detect.html#cb187-27" tabindex="-1"></a>nm_temp <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb187-28"><a href="geom_detect.html#cb187-28" tabindex="-1"></a>  latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;area $</span><span class="sc">\\</span><span class="st">textrm{m}^2$&quot;</span>)</span>
<span id="cb187-29"><a href="geom_detect.html#cb187-29" tabindex="-1"></a>  , latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">&quot;volume $</span><span class="sc">\\</span><span class="st">textrm{m}^3$&quot;</span>)</span>
<span id="cb187-30"><a href="geom_detect.html#cb187-30" tabindex="-1"></a>  , <span class="st">&quot;height m&quot;</span></span>
<span id="cb187-31"><a href="geom_detect.html#cb187-31" tabindex="-1"></a>)</span>
<span id="cb187-32"><a href="geom_detect.html#cb187-32" tabindex="-1"></a>col_temp <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb187-33"><a href="geom_detect.html#cb187-33" tabindex="-1"></a>  <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb187-34"><a href="geom_detect.html#cb187-34" tabindex="-1"></a>  , <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb187-35"><a href="geom_detect.html#cb187-35" tabindex="-1"></a>  , <span class="st">&quot;max_height_m&quot;</span></span>
<span id="cb187-36"><a href="geom_detect.html#cb187-36" tabindex="-1"></a>)</span>
<span id="cb187-37"><a href="geom_detect.html#cb187-37" tabindex="-1"></a><span class="co"># watershed</span></span>
<span id="cb187-38"><a href="geom_detect.html#cb187-38" tabindex="-1"></a>ws_p_temp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(col_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb187-39"><a href="geom_detect.html#cb187-39" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb187-40"><a href="geom_detect.html#cb187-40" tabindex="-1"></a>    \(x)</span>
<span id="cb187-41"><a href="geom_detect.html#cb187-41" tabindex="-1"></a>    <span class="fu">p_fn_temp</span>(</span>
<span id="cb187-42"><a href="geom_detect.html#cb187-42" tabindex="-1"></a>      watershed_segs_poly</span>
<span id="cb187-43"><a href="geom_detect.html#cb187-43" tabindex="-1"></a>      , <span class="at">fill_col =</span> col_temp[x]</span>
<span id="cb187-44"><a href="geom_detect.html#cb187-44" tabindex="-1"></a>      , <span class="at">col_nm =</span> nm_temp[x]</span>
<span id="cb187-45"><a href="geom_detect.html#cb187-45" tabindex="-1"></a>      , <span class="at">pal =</span> pal_temp[x]</span>
<span id="cb187-46"><a href="geom_detect.html#cb187-46" tabindex="-1"></a>    )</span>
<span id="cb187-47"><a href="geom_detect.html#cb187-47" tabindex="-1"></a>  )</span>
<span id="cb187-48"><a href="geom_detect.html#cb187-48" tabindex="-1"></a><span class="co"># dbscan</span></span>
<span id="cb187-49"><a href="geom_detect.html#cb187-49" tabindex="-1"></a>db_p_temp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(col_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb187-50"><a href="geom_detect.html#cb187-50" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb187-51"><a href="geom_detect.html#cb187-51" tabindex="-1"></a>    \(x)</span>
<span id="cb187-52"><a href="geom_detect.html#cb187-52" tabindex="-1"></a>    <span class="fu">p_fn_temp</span>(</span>
<span id="cb187-53"><a href="geom_detect.html#cb187-53" tabindex="-1"></a>      dbscan_segs_poly</span>
<span id="cb187-54"><a href="geom_detect.html#cb187-54" tabindex="-1"></a>      , <span class="at">fill_col =</span> col_temp[x]</span>
<span id="cb187-55"><a href="geom_detect.html#cb187-55" tabindex="-1"></a>      , <span class="at">col_nm =</span> nm_temp[x]</span>
<span id="cb187-56"><a href="geom_detect.html#cb187-56" tabindex="-1"></a>      , <span class="at">pal =</span> pal_temp[x]</span>
<span id="cb187-57"><a href="geom_detect.html#cb187-57" tabindex="-1"></a>    )</span>
<span id="cb187-58"><a href="geom_detect.html#cb187-58" tabindex="-1"></a>  )</span>
<span id="cb187-59"><a href="geom_detect.html#cb187-59" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span> patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb187-60"><a href="geom_detect.html#cb187-60" tabindex="-1"></a>    ws_p_temp</span>
<span id="cb187-61"><a href="geom_detect.html#cb187-61" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb187-62"><a href="geom_detect.html#cb187-62" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb187-63"><a href="geom_detect.html#cb187-63" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;watershed&quot;</span></span>
<span id="cb187-64"><a href="geom_detect.html#cb187-64" tabindex="-1"></a>    , <span class="at">theme =</span> ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb187-65"><a href="geom_detect.html#cb187-65" tabindex="-1"></a>  )</span>
<span id="cb187-66"><a href="geom_detect.html#cb187-66" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span> patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb187-67"><a href="geom_detect.html#cb187-67" tabindex="-1"></a>    db_p_temp</span>
<span id="cb187-68"><a href="geom_detect.html#cb187-68" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb187-69"><a href="geom_detect.html#cb187-69" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb187-70"><a href="geom_detect.html#cb187-70" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;dbscan&quot;</span></span>
<span id="cb187-71"><a href="geom_detect.html#cb187-71" tabindex="-1"></a>    , <span class="at">theme =</span> ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb187-72"><a href="geom_detect.html#cb187-72" tabindex="-1"></a>  )</span>
<span id="cb187-73"><a href="geom_detect.html#cb187-73" tabindex="-1"></a></span>
<span id="cb187-74"><a href="geom_detect.html#cb187-74" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb187-75"><a href="geom_detect.html#cb187-75" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb187-76"><a href="geom_detect.html#cb187-76" tabindex="-1"></a>    patchwork<span class="sc">::</span><span class="fu">wrap_elements</span>( p1_temp )</span>
<span id="cb187-77"><a href="geom_detect.html#cb187-77" tabindex="-1"></a>    , patchwork<span class="sc">::</span><span class="fu">wrap_elements</span>( p2_temp )</span>
<span id="cb187-78"><a href="geom_detect.html#cb187-78" tabindex="-1"></a>  )</span>
<span id="cb187-79"><a href="geom_detect.html#cb187-79" tabindex="-1"></a>  , <span class="at">nrow =</span> <span class="dv">2</span></span>
<span id="cb187-80"><a href="geom_detect.html#cb187-80" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-226-1.png" alt="" width="672" /></p>
<p>after all of that, the results of the two methods are the same for this particular demonstration area</p>
</div>
</div>
<div id="final-shape-refinement" class="section level2 hasAnchor" number="4.6">
<h2><span class="header-section-number">4.6</span> Final Shape Refinement<a href="geom_detect.html#final-shape-refinement" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the final stage, we generate convex hulls for the segments to smooth the blocky, pixelated edges inherent in raster data (which can look like they were generated in Minecraft). Any segments with overlapping convex hulls are then removed to help filter out false detections which may be groups of small trees or shrubs. This step is intended to reflect real-world conditions where distinct slash piles are constructed with enough spacing to remain spatially independent rather than overlapping. Finally, we’ll apply one more filter for the area and height thresholds.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="geom_detect.html#cb188-1" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb188-2"><a href="geom_detect.html#cb188-2" tabindex="-1"></a><span class="co"># make a function to remove overlapping polygons from a sf data frame</span></span>
<span id="cb188-3"><a href="geom_detect.html#cb188-3" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb188-4"><a href="geom_detect.html#cb188-4" tabindex="-1"></a>st_remove_overlaps <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data) {</span>
<span id="cb188-5"><a href="geom_detect.html#cb188-5" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb188-6"><a href="geom_detect.html#cb188-6" tabindex="-1"></a>  <span class="co"># if not polygons</span></span>
<span id="cb188-7"><a href="geom_detect.html#cb188-7" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) ){</span>
<span id="cb188-8"><a href="geom_detect.html#cb188-8" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb188-9"><a href="geom_detect.html#cb188-9" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb188-10"><a href="geom_detect.html#cb188-10" tabindex="-1"></a>    ))</span>
<span id="cb188-11"><a href="geom_detect.html#cb188-11" tabindex="-1"></a>  }</span>
<span id="cb188-12"><a href="geom_detect.html#cb188-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(sf_data)<span class="sc">&lt;=</span><span class="dv">1</span>){<span class="fu">return</span>(sf_data)}</span>
<span id="cb188-13"><a href="geom_detect.html#cb188-13" tabindex="-1"></a>  <span class="co"># combine all touching polygons and keep the ones that overlap multiple from the original polygons</span></span>
<span id="cb188-14"><a href="geom_detect.html#cb188-14" tabindex="-1"></a>  comb_temp <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb188-15"><a href="geom_detect.html#cb188-15" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb188-16"><a href="geom_detect.html#cb188-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_union</span>(<span class="at">by_feature =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb188-17"><a href="geom_detect.html#cb188-17" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb188-18"><a href="geom_detect.html#cb188-18" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb188-19"><a href="geom_detect.html#cb188-19" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb188-20"><a href="geom_detect.html#cb188-20" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_crs</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data)) <span class="sc">%&gt;%</span> </span>
<span id="cb188-21"><a href="geom_detect.html#cb188-21" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">new_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb188-22"><a href="geom_detect.html#cb188-22" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(new_id) </span>
<span id="cb188-23"><a href="geom_detect.html#cb188-23" tabindex="-1"></a>  <span class="co"># identify overlaps</span></span>
<span id="cb188-24"><a href="geom_detect.html#cb188-24" tabindex="-1"></a>  overlap_temp <span class="ot">&lt;-</span> comb_temp <span class="sc">%&gt;%</span> </span>
<span id="cb188-25"><a href="geom_detect.html#cb188-25" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_intersection</span>(sf_data) <span class="sc">%&gt;%</span> </span>
<span id="cb188-26"><a href="geom_detect.html#cb188-26" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb188-27"><a href="geom_detect.html#cb188-27" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(new_id) <span class="sc">%&gt;%</span> </span>
<span id="cb188-28"><a href="geom_detect.html#cb188-28" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n_orig =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb188-29"><a href="geom_detect.html#cb188-29" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb188-30"><a href="geom_detect.html#cb188-30" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(n_orig<span class="sc">&gt;=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb188-31"><a href="geom_detect.html#cb188-31" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(new_id)</span>
<span id="cb188-32"><a href="geom_detect.html#cb188-32" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(overlap_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(sf_data)}</span>
<span id="cb188-33"><a href="geom_detect.html#cb188-33" tabindex="-1"></a>  <span class="co"># just get the overlaps</span></span>
<span id="cb188-34"><a href="geom_detect.html#cb188-34" tabindex="-1"></a>  comb_temp <span class="ot">&lt;-</span> comb_temp <span class="sc">%&gt;%</span> </span>
<span id="cb188-35"><a href="geom_detect.html#cb188-35" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(new_id <span class="sc">%in%</span> overlap_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb188-36"><a href="geom_detect.html#cb188-36" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_union</span>()</span>
<span id="cb188-37"><a href="geom_detect.html#cb188-37" tabindex="-1"></a>  <span class="co"># remove all input polygons from the original data that have any overlaps</span></span>
<span id="cb188-38"><a href="geom_detect.html#cb188-38" tabindex="-1"></a>  <span class="fu">return</span>(sf<span class="sc">::</span><span class="fu">st_difference</span>(sf_data,comb_temp))</span>
<span id="cb188-39"><a href="geom_detect.html#cb188-39" tabindex="-1"></a>}</span></code></pre></div>
<p>take the convex hull and apply our <code>st_remove_overlaps()</code> function to the remaining candidate segments. Finally, we filter for area based on the smoothed shape</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="geom_detect.html#cb189-1" tabindex="-1"></a><span class="co"># watershed_segs_poly</span></span>
<span id="cb189-2"><a href="geom_detect.html#cb189-2" tabindex="-1"></a>watershed_segs_poly <span class="ot">&lt;-</span></span>
<span id="cb189-3"><a href="geom_detect.html#cb189-3" tabindex="-1"></a>  watershed_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb189-4"><a href="geom_detect.html#cb189-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb189-5"><a href="geom_detect.html#cb189-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb189-6"><a href="geom_detect.html#cb189-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb189-7"><a href="geom_detect.html#cb189-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb189-8"><a href="geom_detect.html#cb189-8" tabindex="-1"></a>  <span class="fu">st_remove_overlaps</span>() <span class="sc">%&gt;%</span></span>
<span id="cb189-9"><a href="geom_detect.html#cb189-9" tabindex="-1"></a>  <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb189-10"><a href="geom_detect.html#cb189-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb189-11"><a href="geom_detect.html#cb189-11" tabindex="-1"></a>    <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb189-12"><a href="geom_detect.html#cb189-12" tabindex="-1"></a>    , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb189-13"><a href="geom_detect.html#cb189-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb189-14"><a href="geom_detect.html#cb189-14" tabindex="-1"></a>  <span class="fu">st_filter_area</span>(<span class="at">min_area_m2 =</span> min_area_m2, <span class="at">max_area_m2 =</span> max_area_m2) <span class="sc">%&gt;%</span> </span>
<span id="cb189-15"><a href="geom_detect.html#cb189-15" tabindex="-1"></a>  <span class="co"># filter for height</span></span>
<span id="cb189-16"><a href="geom_detect.html#cb189-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb189-17"><a href="geom_detect.html#cb189-17" tabindex="-1"></a>    max_height_m <span class="sc">&gt;=</span> min_ht_m</span>
<span id="cb189-18"><a href="geom_detect.html#cb189-18" tabindex="-1"></a>    <span class="sc">&amp;</span> max_height_m <span class="sc">&lt;=</span> max_ht_m</span>
<span id="cb189-19"><a href="geom_detect.html#cb189-19" tabindex="-1"></a>  )</span>
<span id="cb189-20"><a href="geom_detect.html#cb189-20" tabindex="-1"></a><span class="co"># dbscan_segs_poly</span></span>
<span id="cb189-21"><a href="geom_detect.html#cb189-21" tabindex="-1"></a>dbscan_segs_poly <span class="ot">&lt;-</span></span>
<span id="cb189-22"><a href="geom_detect.html#cb189-22" tabindex="-1"></a>  dbscan_segs_poly <span class="sc">%&gt;%</span> </span>
<span id="cb189-23"><a href="geom_detect.html#cb189-23" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb189-24"><a href="geom_detect.html#cb189-24" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb189-25"><a href="geom_detect.html#cb189-25" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb189-26"><a href="geom_detect.html#cb189-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb189-27"><a href="geom_detect.html#cb189-27" tabindex="-1"></a>  <span class="fu">st_remove_overlaps</span>() <span class="sc">%&gt;%</span></span>
<span id="cb189-28"><a href="geom_detect.html#cb189-28" tabindex="-1"></a>  <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb189-29"><a href="geom_detect.html#cb189-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb189-30"><a href="geom_detect.html#cb189-30" tabindex="-1"></a>    <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb189-31"><a href="geom_detect.html#cb189-31" tabindex="-1"></a>    , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb189-32"><a href="geom_detect.html#cb189-32" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb189-33"><a href="geom_detect.html#cb189-33" tabindex="-1"></a>  <span class="fu">st_filter_area</span>(<span class="at">min_area_m2 =</span> min_area_m2, <span class="at">max_area_m2 =</span> max_area_m2) <span class="sc">%&gt;%</span> </span>
<span id="cb189-34"><a href="geom_detect.html#cb189-34" tabindex="-1"></a>  <span class="co"># filter for height</span></span>
<span id="cb189-35"><a href="geom_detect.html#cb189-35" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb189-36"><a href="geom_detect.html#cb189-36" tabindex="-1"></a>    max_height_m <span class="sc">&gt;=</span> min_ht_m</span>
<span id="cb189-37"><a href="geom_detect.html#cb189-37" tabindex="-1"></a>    <span class="sc">&amp;</span> max_height_m <span class="sc">&lt;=</span> max_ht_m</span>
<span id="cb189-38"><a href="geom_detect.html#cb189-38" tabindex="-1"></a>  )</span>
<span id="cb189-39"><a href="geom_detect.html#cb189-39" tabindex="-1"></a><span class="co"># dbscan_segs_poly %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<div id="watershed-segmentation-3" class="section level3 hasAnchor" number="4.6.1">
<h3><span class="header-section-number">4.6.1</span> Watershed Segmentation<a href="geom_detect.html#watershed-segmentation-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="geom_detect.html#cb190-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb190-2"><a href="geom_detect.html#cb190-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb190-3"><a href="geom_detect.html#cb190-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb190-4"><a href="geom_detect.html#cb190-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb190-5"><a href="geom_detect.html#cb190-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb190-6"><a href="geom_detect.html#cb190-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb190-7"><a href="geom_detect.html#cb190-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb190-8"><a href="geom_detect.html#cb190-8" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb190-9"><a href="geom_detect.html#cb190-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb190-10"><a href="geom_detect.html#cb190-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb190-11"><a href="geom_detect.html#cb190-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-231-1.png" alt="" width="1008" /></p>
<p>plot the filtered watershed candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="geom_detect.html#cb191-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb191-2"><a href="geom_detect.html#cb191-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb191-3"><a href="geom_detect.html#cb191-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb191-4"><a href="geom_detect.html#cb191-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb191-5"><a href="geom_detect.html#cb191-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-6"><a href="geom_detect.html#cb191-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb191-7"><a href="geom_detect.html#cb191-7" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly</span>
<span id="cb191-8"><a href="geom_detect.html#cb191-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb191-9"><a href="geom_detect.html#cb191-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-233-1.png" alt="" width="1008" /></p>
<p>nice</p>
</div>
<div id="dbscan-segmentation-3" class="section level3 hasAnchor" number="4.6.2">
<h3><span class="header-section-number">4.6.2</span> DBSCAN Segmentation<a href="geom_detect.html#dbscan-segmentation-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>plot the filtered dbscan candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="geom_detect.html#cb192-1" tabindex="-1"></a>aoi_plt_ortho <span class="sc">+</span></span>
<span id="cb192-2"><a href="geom_detect.html#cb192-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_boundary, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb192-3"><a href="geom_detect.html#cb192-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb192-4"><a href="geom_detect.html#cb192-4" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb192-5"><a href="geom_detect.html#cb192-5" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb192-6"><a href="geom_detect.html#cb192-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb192-7"><a href="geom_detect.html#cb192-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb192-8"><a href="geom_detect.html#cb192-8" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb192-9"><a href="geom_detect.html#cb192-9" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb192-10"><a href="geom_detect.html#cb192-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb192-11"><a href="geom_detect.html#cb192-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-236-1.png" alt="" width="1008" /></p>
<p>plot the filtered dbscan candidate segments (magenta) and the actual piles (cyan) on the CHM</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="geom_detect.html#cb193-1" tabindex="-1"></a><span class="fu">plt_aoi_chm</span>(aoi_chm_rast_slice) <span class="sc">+</span></span>
<span id="cb193-2"><a href="geom_detect.html#cb193-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb193-3"><a href="geom_detect.html#cb193-3" tabindex="-1"></a>    <span class="at">data =</span> aoi_slash_piles_polys</span>
<span id="cb193-4"><a href="geom_detect.html#cb193-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb193-5"><a href="geom_detect.html#cb193-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb193-6"><a href="geom_detect.html#cb193-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb193-7"><a href="geom_detect.html#cb193-7" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly</span>
<span id="cb193-8"><a href="geom_detect.html#cb193-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb193-9"><a href="geom_detect.html#cb193-9" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-238-1.png" alt="" width="1008" /></p>
<p>nice</p>
</div>
<div id="quick-methods-comparison-2" class="section level3 hasAnchor" number="4.6.3">
<h3><span class="header-section-number">4.6.3</span> Quick methods comparison<a href="geom_detect.html#quick-methods-comparison-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s quickly look at the watershed and dbscan segments on the same plot</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="geom_detect.html#cb194-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb194-2"><a href="geom_detect.html#cb194-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb194-3"><a href="geom_detect.html#cb194-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;watershed&quot;</span>)</span>
<span id="cb194-4"><a href="geom_detect.html#cb194-4" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb194-5"><a href="geom_detect.html#cb194-5" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb194-6"><a href="geom_detect.html#cb194-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb194-7"><a href="geom_detect.html#cb194-7" tabindex="-1"></a>    <span class="at">data =</span> dbscan_segs_poly, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color=</span><span class="st">&quot;dbscan&quot;</span>)</span>
<span id="cb194-8"><a href="geom_detect.html#cb194-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb194-9"><a href="geom_detect.html#cb194-9" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb194-10"><a href="geom_detect.html#cb194-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray33&quot;</span>, <span class="st">&quot;aquamarine3&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb194-11"><a href="geom_detect.html#cb194-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb194-12"><a href="geom_detect.html#cb194-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-241-1.png" alt="" width="1008" /></p>
<p>almost exactly the same</p>
<p>let’s see how many segments were originally detected using each method and how many we are left with after our filtering for shape irregularity, pile area and height expectations, circularity, and potential overlaps after smoothing?</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="geom_detect.html#cb195-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb195-2"><a href="geom_detect.html#cb195-2" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;watershed&quot;</span>, <span class="st">&quot;DBSCAN&quot;</span>)</span>
<span id="cb195-3"><a href="geom_detect.html#cb195-3" tabindex="-1"></a>    , <span class="at">old_segments =</span> <span class="fu">c</span>(</span>
<span id="cb195-4"><a href="geom_detect.html#cb195-4" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">freq</span>(watershed_segs) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb195-5"><a href="geom_detect.html#cb195-5" tabindex="-1"></a>      , terra<span class="sc">::</span><span class="fu">freq</span>(dbscan_segs) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb195-6"><a href="geom_detect.html#cb195-6" tabindex="-1"></a>    )</span>
<span id="cb195-7"><a href="geom_detect.html#cb195-7" tabindex="-1"></a>    , <span class="at">new_segments =</span> <span class="fu">c</span>(</span>
<span id="cb195-8"><a href="geom_detect.html#cb195-8" tabindex="-1"></a>      <span class="fu">nrow</span>(watershed_segs_poly)</span>
<span id="cb195-9"><a href="geom_detect.html#cb195-9" tabindex="-1"></a>      , <span class="fu">nrow</span>(dbscan_segs_poly)</span>
<span id="cb195-10"><a href="geom_detect.html#cb195-10" tabindex="-1"></a>    )</span>
<span id="cb195-11"><a href="geom_detect.html#cb195-11" tabindex="-1"></a>    <span class="co"># area</span></span>
<span id="cb195-12"><a href="geom_detect.html#cb195-12" tabindex="-1"></a>    , <span class="at">old_area =</span> <span class="fu">c</span>(</span>
<span id="cb195-13"><a href="geom_detect.html#cb195-13" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">cellSize</span>(watershed_segs) <span class="sc">%&gt;%</span> </span>
<span id="cb195-14"><a href="geom_detect.html#cb195-14" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">crop</span>(watershed_segs,<span class="at">mask=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb195-15"><a href="geom_detect.html#cb195-15" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">global</span>(<span class="at">fun=</span><span class="st">&quot;sum&quot;</span>, <span class="at">na.rm=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb195-16"><a href="geom_detect.html#cb195-16" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb195-17"><a href="geom_detect.html#cb195-17" tabindex="-1"></a>      , terra<span class="sc">::</span><span class="fu">cellSize</span>(dbscan_segs) <span class="sc">%&gt;%</span> </span>
<span id="cb195-18"><a href="geom_detect.html#cb195-18" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">crop</span>(dbscan_segs,<span class="at">mask=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb195-19"><a href="geom_detect.html#cb195-19" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">global</span>(<span class="at">fun=</span><span class="st">&quot;sum&quot;</span>, <span class="at">na.rm=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb195-20"><a href="geom_detect.html#cb195-20" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb195-21"><a href="geom_detect.html#cb195-21" tabindex="-1"></a>    )</span>
<span id="cb195-22"><a href="geom_detect.html#cb195-22" tabindex="-1"></a>    , <span class="at">new_area =</span> <span class="fu">c</span>(</span>
<span id="cb195-23"><a href="geom_detect.html#cb195-23" tabindex="-1"></a>      watershed_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb195-24"><a href="geom_detect.html#cb195-24" tabindex="-1"></a>      , dbscan_segs_poly <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb195-25"><a href="geom_detect.html#cb195-25" tabindex="-1"></a>    )</span>
<span id="cb195-26"><a href="geom_detect.html#cb195-26" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb195-27"><a href="geom_detect.html#cb195-27" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb195-28"><a href="geom_detect.html#cb195-28" tabindex="-1"></a>    <span class="at">segments_pct_removed =</span> scales<span class="sc">::</span><span class="fu">percent</span>((new_segments<span class="sc">-</span>old_segments)<span class="sc">/</span>old_segments, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb195-29"><a href="geom_detect.html#cb195-29" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;segments&quot;</span>), <span class="sc">~</span>scales<span class="sc">::</span><span class="fu">comma</span>(.x,<span class="at">accuracy=</span><span class="dv">1</span>))</span>
<span id="cb195-30"><a href="geom_detect.html#cb195-30" tabindex="-1"></a>    , <span class="at">area_pct_removed =</span> scales<span class="sc">::</span><span class="fu">percent</span>((new_area<span class="sc">-</span>old_area)<span class="sc">/</span>old_area, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb195-31"><a href="geom_detect.html#cb195-31" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;area&quot;</span>), <span class="sc">~</span>scales<span class="sc">::</span><span class="fu">comma</span>(.x,<span class="at">accuracy=</span><span class="fl">0.1</span>))</span>
<span id="cb195-32"><a href="geom_detect.html#cb195-32" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb195-33"><a href="geom_detect.html#cb195-33" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb195-34"><a href="geom_detect.html#cb195-34" tabindex="-1"></a>    method</span>
<span id="cb195-35"><a href="geom_detect.html#cb195-35" tabindex="-1"></a>    ,tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_segments&quot;</span>), segments_pct_removed</span>
<span id="cb195-36"><a href="geom_detect.html#cb195-36" tabindex="-1"></a>    ,tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_area&quot;</span>), area_pct_removed</span>
<span id="cb195-37"><a href="geom_detect.html#cb195-37" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb195-38"><a href="geom_detect.html#cb195-38" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb195-39"><a href="geom_detect.html#cb195-39" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Demonstration area candidate segments by method&lt;br&gt;final candidate segments fully filtered for size and geometric expectations&quot;</span></span>
<span id="cb195-40"><a href="geom_detect.html#cb195-40" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb195-41"><a href="geom_detect.html#cb195-41" tabindex="-1"></a>      <span class="st">&quot;method&quot;</span></span>
<span id="cb195-42"><a href="geom_detect.html#cb195-42" tabindex="-1"></a>      , <span class="st">&quot;orig. candidate&lt;br&gt;segments&quot;</span>, <span class="st">&quot;final&lt;br&gt;segments&quot;</span>, <span class="st">&quot;% candidates&lt;br&gt;removed&quot;</span></span>
<span id="cb195-43"><a href="geom_detect.html#cb195-43" tabindex="-1"></a>      , <span class="st">&quot;orig. candidate&lt;br&gt;area (m&lt;sup&gt;2&lt;/sup&gt;)&quot;</span>, <span class="st">&quot;final&lt;br&gt;area (m&lt;sup&gt;2&lt;/sup&gt;)&quot;</span>, <span class="st">&quot;% area&lt;br&gt;removed&quot;</span></span>
<span id="cb195-44"><a href="geom_detect.html#cb195-44" tabindex="-1"></a>    )</span>
<span id="cb195-45"><a href="geom_detect.html#cb195-45" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb195-46"><a href="geom_detect.html#cb195-46" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb195-47"><a href="geom_detect.html#cb195-47" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-242">Table 4.6: </span>Demonstration area candidate segments by method<br>final candidate segments fully filtered for size and geometric expectations
</caption>
<thead>
<tr>
<th style="text-align:left;">
method
</th>
<th style="text-align:left;">
orig. candidate<br>segments
</th>
<th style="text-align:left;">
final<br>segments
</th>
<th style="text-align:left;">
% candidates<br>removed
</th>
<th style="text-align:left;">
orig. candidate<br>area (m<sup>2</sup>)
</th>
<th style="text-align:left;">
final<br>area (m<sup>2</sup>)
</th>
<th style="text-align:left;">
% area<br>removed
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
watershed
</td>
<td style="text-align:left;">
214
</td>
<td style="text-align:left;">
24
</td>
<td style="text-align:left;">
-88.8%
</td>
<td style="text-align:left;">
276.4
</td>
<td style="text-align:left;">
242.0
</td>
<td style="text-align:left;">
-12.4%
</td>
</tr>
<tr>
<td style="text-align:left;">
DBSCAN
</td>
<td style="text-align:left;">
200
</td>
<td style="text-align:left;">
25
</td>
<td style="text-align:left;">
-87.5%
</td>
<td style="text-align:left;">
274.4
</td>
<td style="text-align:left;">
245.4
</td>
<td style="text-align:left;">
-10.6%
</td>
</tr>
</tbody>
</table>
<p>wow that is a lot of filtering, but it looks like the result for this demonstration area is decently accurate (we’ll perform full validation of the method later). That is, there are few false positive predictions (commission errors) and few false negative predictions (omission errors)…in the next section we’ll integrate spectral data to further filter the false positive predictions based on how closely their spectral information matches vegetation</p>
</div>
</div>
<div id="slash_pile_detect_fn" class="section level2 hasAnchor" number="4.7">
<h2><span class="header-section-number">4.7</span> Pile Detection Function<a href="geom_detect.html#slash_pile_detect_fn" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The rule-based method for slash pile detection using CHM raster data we reviewed above generally follows this outline:</p>
<ul>
<li><em>CHM Generation</em>: A Canopy Height Model (CHM) is generated from the point cloud data. The CHM is generated by removing the ground surface effectively representing a Digital Surface Model (DSM) without ground, ensuring all values are heights above bare earth.</li>
<li><em>CHM Height Filtering</em>: A maximum height filter is applied to the CHM to retaining only raster cells below a maximum expected slash pile height (e.g. 4 m), isolating a “slice” of the CHM.</li>
<li><em>Segmentation Method Setup</em>: Applies the dynamic parameter logic used in the Watershed or DBSCAN segmentation method. This logic ensures scale-invariant object detection by maintaining constant proportions between the algorithm search windows and the physical dimensions of the target object. This dynamic approach allows the method parameters to adapt automatically to the input data resolution so that the resulting candidate segments remain spatially consistent with target objects.</li>
<li><em>Candidate Segmentation</em>: Watershed or DBSCAN segmentation is performed on the filtered CHM raster to identify and delineate initial candidate piles based on their structural form.</li>
<li><em>Shape Refinement &amp; Area Filtering</em>: To align segmentation results with real-world pile construction, we simplify candidate segments by retaining only their largest contiguous portion to eliminate detached noise and ensure each feature represents a discrete physical object. The results are then filtered based on the area expectations.</li>
<li><em>Shape Irregularity: Convexity Filtering</em>: Candidate pile locations are filtered to remove highly irregular shapes by assessing their overlap with their convex hull. This process removes irregular objects like branched tree crowns or segments with holes while allowing solid, regular shapes (e.g. circles, rectangles, triangles) to pass.</li>
<li><em>Circularity Filtering</em>: A circularity filter is applied to measure a shape’s dispersion by dividing the candidate polygon area by the area of its minimum bounding circle. This second-stage shape irregularity filter targets the round bases typical of manual construction by penalizing elongated or non-circular shapes that do not adequately fill their circumcircle.</li>
<li><em>Final Shape Refinement &amp; Overlap Removal</em>: Lastly, segments are smoothed using their convex hull to remove the “blocky” raster edges (like they were made in Minecraft). Overlapping convex hull shapes are then removed to prevent false positives from clustered small trees or shrubs, ensuring singular pile detections.</li>
</ul>
<p>Let’s package all of the steps we demonstrated when <a href="geom_detect.html#geom_detect">formulating the methodology</a> into a single function which can possibly be integrated into the <code>cloud2trees</code> package.</p>
<p>The parameters are defined as follows:</p>
<ul>
<li><code>min_ht_m</code> : numeric. The minimum height (in meters) a detected pile must reach to be considered valid.</li>
<li><code>max_ht_m</code> : numeric. The maximum height (in meters) a slash pile is expected to be. This value helps us focus on a specific “slice” of the data, ignoring anything taller than a typical pile.</li>
<li><code>min_area_m2</code> : numeric. The smallest 2D area (in square meters) a detected pile must cover to be considered valid.</li>
<li><code>max_area_m2</code> : numeric. The largest 2D area (in square meters) a detected pile can cover to be considered valid.</li>
<li><code>min_convexity_ratio</code> : numeric. A value between 0 and 1 that controls how strict the filtering is for regularly shaped piles. A value of 1 means only piles that are perfectly smooth and rounded, with no dents or inward curves are kept (e.g. perfect square, rectangle, circle, triangle). A value of 0 allows for both perfectly regular and very irregular shapes. This filter works alongside <code>min_circularity_ratio</code> to identify slash piles based on expected morphology.</li>
<li><code>min_circularity_ratio</code> : numeric. A value between 0 and 1 that controls how strict the filtering is for circular pile shapes. Setting it to 1 means only piles that are perfectly circular are kept. A value of 0 allows for a wide range of shapes, including very circular and non-circular ones (like long, straight lines). For context, a perfect square has a circularity ratio of <span class="math inline">\(\frac{2}{\pi}\approx 0.637\)</span> while an equilateral triangle has a ratio of <span class="math inline">\(\frac{3\sqrt{3}}{4\pi}\approx 0.414\)</span>. This filter works alongside <code>min_convexity_ratio</code> to identify slash piles based on expected morphology.</li>
<li><code>smooth_segs</code> : logical. Setting this option to TRUE will: 1) smooth out the “blocky” edges of detected piles (which can look like they were made in Minecraft) by using their overall shape; and 2) remove any detected piles that overlap significantly with other smoothed piles to help ensure each detection is a single slash pile, not a cluster of objects like small trees or shrubs.</li>
</ul>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="geom_detect.html#cb196-1" tabindex="-1"></a><span class="co"># detect funciton</span></span>
<span id="cb196-2"><a href="geom_detect.html#cb196-2" tabindex="-1"></a>slash_pile_detect <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb196-3"><a href="geom_detect.html#cb196-3" tabindex="-1"></a>  chm_rast</span>
<span id="cb196-4"><a href="geom_detect.html#cb196-4" tabindex="-1"></a>  , <span class="at">seg_method =</span> <span class="st">&quot;watershed&quot;</span></span>
<span id="cb196-5"><a href="geom_detect.html#cb196-5" tabindex="-1"></a>  <span class="do">#### height and area thresholds for the detected piles</span></span>
<span id="cb196-6"><a href="geom_detect.html#cb196-6" tabindex="-1"></a>  <span class="co"># these should be based on data from the literature or expectations based on the prescription</span></span>
<span id="cb196-7"><a href="geom_detect.html#cb196-7" tabindex="-1"></a>  , min_ht_m <span class="co"># set the min expected pile height</span></span>
<span id="cb196-8"><a href="geom_detect.html#cb196-8" tabindex="-1"></a>  , max_ht_m <span class="co"># set the max expected pile height</span></span>
<span id="cb196-9"><a href="geom_detect.html#cb196-9" tabindex="-1"></a>  , min_area_m2 <span class="co"># set the min expected pile area</span></span>
<span id="cb196-10"><a href="geom_detect.html#cb196-10" tabindex="-1"></a>  , max_area_m2 <span class="co"># set the max expected pile area</span></span>
<span id="cb196-11"><a href="geom_detect.html#cb196-11" tabindex="-1"></a>  <span class="do">#### convexity filtering</span></span>
<span id="cb196-12"><a href="geom_detect.html#cb196-12" tabindex="-1"></a>  <span class="co"># 1 = perfectly convex (no inward angles); 0 = so many inward angles</span></span>
<span id="cb196-13"><a href="geom_detect.html#cb196-13" tabindex="-1"></a>  <span class="co"># values closer to 1 remove more irregular segments; </span></span>
<span id="cb196-14"><a href="geom_detect.html#cb196-14" tabindex="-1"></a>    <span class="co"># values closer to 0 keep more irregular segments (and also regular segments)</span></span>
<span id="cb196-15"><a href="geom_detect.html#cb196-15" tabindex="-1"></a>  <span class="co"># these will all be further filtered for their circularity if desired</span></span>
<span id="cb196-16"><a href="geom_detect.html#cb196-16" tabindex="-1"></a>  , min_convexity_ratio <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb196-17"><a href="geom_detect.html#cb196-17" tabindex="-1"></a>  <span class="do">#### circularity filtering</span></span>
<span id="cb196-18"><a href="geom_detect.html#cb196-18" tabindex="-1"></a>  <span class="co"># 1 = perfectly circular; 0 = not circular (e.g. linear) but also circular</span></span>
<span id="cb196-19"><a href="geom_detect.html#cb196-19" tabindex="-1"></a>  <span class="co"># min required overlap between the candidate pile segment polygon and the minimum bounding circle of the polygon</span></span>
<span id="cb196-20"><a href="geom_detect.html#cb196-20" tabindex="-1"></a>  , min_circularity_ratio</span>
<span id="cb196-21"><a href="geom_detect.html#cb196-21" tabindex="-1"></a>  <span class="do">#### shape refinement &amp; overlap removal</span></span>
<span id="cb196-22"><a href="geom_detect.html#cb196-22" tabindex="-1"></a>  <span class="do">## smooth_segs = T ... convex hulls of raster detected segments are returned, any that overlap are removed</span></span>
<span id="cb196-23"><a href="geom_detect.html#cb196-23" tabindex="-1"></a>  <span class="do">## smooth_segs = F ... raster detected segments are returned (blocky) if they meet all prior rules</span></span>
<span id="cb196-24"><a href="geom_detect.html#cb196-24" tabindex="-1"></a>  , <span class="at">smooth_segs =</span> T</span>
<span id="cb196-25"><a href="geom_detect.html#cb196-25" tabindex="-1"></a>  <span class="do">##############</span></span>
<span id="cb196-26"><a href="geom_detect.html#cb196-26" tabindex="-1"></a>  <span class="co"># if defined...will instead write the detected segment polygons to the file given and return the name of the file</span></span>
<span id="cb196-27"><a href="geom_detect.html#cb196-27" tabindex="-1"></a>  <span class="co"># ex: &quot;my_wshed_segs.gpkg&quot;; ex: &quot;../data/ur_wshed_segs.gpkg&quot;</span></span>
<span id="cb196-28"><a href="geom_detect.html#cb196-28" tabindex="-1"></a>  , <span class="at">ofile =</span> <span class="cn">NA</span></span>
<span id="cb196-29"><a href="geom_detect.html#cb196-29" tabindex="-1"></a>) {</span>
<span id="cb196-30"><a href="geom_detect.html#cb196-30" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb196-31"><a href="geom_detect.html#cb196-31" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(smooth_segs, <span class="st">&quot;logical&quot;</span>) <span class="sc">||</span> <span class="fu">is.na</span>(smooth_segs)){<span class="fu">stop</span>(<span class="st">&quot;define `smooth_segs` as logical&quot;</span>)}</span>
<span id="cb196-32"><a href="geom_detect.html#cb196-32" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb196-33"><a href="geom_detect.html#cb196-33" tabindex="-1"></a>  <span class="co"># shape irregularity checks</span></span>
<span id="cb196-34"><a href="geom_detect.html#cb196-34" tabindex="-1"></a>  <span class="do">########################</span></span>
<span id="cb196-35"><a href="geom_detect.html#cb196-35" tabindex="-1"></a>    min_convexity_ratio <span class="ot">&lt;-</span> min_convexity_ratio[<span class="dv">1</span>] </span>
<span id="cb196-36"><a href="geom_detect.html#cb196-36" tabindex="-1"></a>    min_circularity_ratio <span class="ot">&lt;-</span> min_circularity_ratio[<span class="dv">1</span>] </span>
<span id="cb196-37"><a href="geom_detect.html#cb196-37" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb196-38"><a href="geom_detect.html#cb196-38" tabindex="-1"></a>      (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_convexity_ratio), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb196-39"><a href="geom_detect.html#cb196-39" tabindex="-1"></a>       <span class="fu">identical</span>(<span class="fu">as.numeric</span>(min_convexity_ratio), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb196-40"><a href="geom_detect.html#cb196-40" tabindex="-1"></a>       <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_convexity_ratio), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb196-41"><a href="geom_detect.html#cb196-41" tabindex="-1"></a>      (<span class="fu">is.na</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_circularity_ratio), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>)) <span class="sc">||</span> </span>
<span id="cb196-42"><a href="geom_detect.html#cb196-42" tabindex="-1"></a>       <span class="fu">identical</span>(<span class="fu">as.numeric</span>(min_circularity_ratio), <span class="fu">numeric</span>(<span class="dv">0</span>)) <span class="sc">||</span> </span>
<span id="cb196-43"><a href="geom_detect.html#cb196-43" tabindex="-1"></a>       <span class="sc">!</span><span class="fu">is.numeric</span>(<span class="fu">tryCatch</span>(<span class="fu">as.numeric</span>(min_circularity_ratio), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA</span>))) <span class="sc">||</span></span>
<span id="cb196-44"><a href="geom_detect.html#cb196-44" tabindex="-1"></a>      <span class="fu">as.numeric</span>(min_convexity_ratio)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb196-45"><a href="geom_detect.html#cb196-45" tabindex="-1"></a>      <span class="fu">as.numeric</span>(min_convexity_ratio)<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">||</span></span>
<span id="cb196-46"><a href="geom_detect.html#cb196-46" tabindex="-1"></a>      <span class="fu">as.numeric</span>(min_circularity_ratio)<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb196-47"><a href="geom_detect.html#cb196-47" tabindex="-1"></a>      <span class="fu">as.numeric</span>(min_circularity_ratio)<span class="sc">&gt;</span><span class="dv">1</span></span>
<span id="cb196-48"><a href="geom_detect.html#cb196-48" tabindex="-1"></a>    ){</span>
<span id="cb196-49"><a href="geom_detect.html#cb196-49" tabindex="-1"></a>      <span class="co"># Code to execute if any condition is met (e.g., print an error message)</span></span>
<span id="cb196-50"><a href="geom_detect.html#cb196-50" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Error: One or more of `min_convexity_ratio`,`min_circularity_ratio` are not valid numbers between 0 and 1.&quot;</span>)</span>
<span id="cb196-51"><a href="geom_detect.html#cb196-51" tabindex="-1"></a>    }</span>
<span id="cb196-52"><a href="geom_detect.html#cb196-52" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-53"><a href="geom_detect.html#cb196-53" tabindex="-1"></a>  <span class="do">## 1) Segmentation</span></span>
<span id="cb196-54"><a href="geom_detect.html#cb196-54" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-55"><a href="geom_detect.html#cb196-55" tabindex="-1"></a>    get_segmentation_candidates_ans <span class="ot">&lt;-</span> <span class="fu">get_segmentation_candidates</span>(</span>
<span id="cb196-56"><a href="geom_detect.html#cb196-56" tabindex="-1"></a>      <span class="at">chm_rast =</span> chm_rast</span>
<span id="cb196-57"><a href="geom_detect.html#cb196-57" tabindex="-1"></a>      , <span class="at">method =</span> seg_method</span>
<span id="cb196-58"><a href="geom_detect.html#cb196-58" tabindex="-1"></a>      , <span class="at">min_ht_m =</span> min_ht_m</span>
<span id="cb196-59"><a href="geom_detect.html#cb196-59" tabindex="-1"></a>      , <span class="at">max_ht_m =</span> max_ht_m</span>
<span id="cb196-60"><a href="geom_detect.html#cb196-60" tabindex="-1"></a>      , <span class="at">min_area_m2 =</span> min_area_m2</span>
<span id="cb196-61"><a href="geom_detect.html#cb196-61" tabindex="-1"></a>      , <span class="at">max_area_m2 =</span> max_area_m2</span>
<span id="cb196-62"><a href="geom_detect.html#cb196-62" tabindex="-1"></a>    )</span>
<span id="cb196-63"><a href="geom_detect.html#cb196-63" tabindex="-1"></a>    </span>
<span id="cb196-64"><a href="geom_detect.html#cb196-64" tabindex="-1"></a>    <span class="co"># get results individual objects</span></span>
<span id="cb196-65"><a href="geom_detect.html#cb196-65" tabindex="-1"></a>    segs_rast <span class="ot">&lt;-</span> get_segmentation_candidates_ans<span class="sc">$</span>segs_rast</span>
<span id="cb196-66"><a href="geom_detect.html#cb196-66" tabindex="-1"></a>    segs_sf <span class="ot">&lt;-</span> get_segmentation_candidates_ans<span class="sc">$</span>segs_sf</span>
<span id="cb196-67"><a href="geom_detect.html#cb196-67" tabindex="-1"></a>    slice_chm_rast <span class="ot">&lt;-</span> get_segmentation_candidates_ans<span class="sc">$</span>slice_chm_rast</span>
<span id="cb196-68"><a href="geom_detect.html#cb196-68" tabindex="-1"></a>    <span class="co"># seg_mthd_params &lt;- get_segmentation_candidates_ans$seg_mthd_params</span></span>
<span id="cb196-69"><a href="geom_detect.html#cb196-69" tabindex="-1"></a>    </span>
<span id="cb196-70"><a href="geom_detect.html#cb196-70" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(segs_sf),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb196-71"><a href="geom_detect.html#cb196-71" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb196-72"><a href="geom_detect.html#cb196-72" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and size expectations&quot;</span></span>
<span id="cb196-73"><a href="geom_detect.html#cb196-73" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting size threshold parameters:&quot;</span></span>
<span id="cb196-74"><a href="geom_detect.html#cb196-74" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     `min_ht_m`,`max_ht_m`,`min_area_m2`,`max_area_m2`&quot;</span></span>
<span id="cb196-75"><a href="geom_detect.html#cb196-75" tabindex="-1"></a>      ))</span>
<span id="cb196-76"><a href="geom_detect.html#cb196-76" tabindex="-1"></a>    }</span>
<span id="cb196-77"><a href="geom_detect.html#cb196-77" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-78"><a href="geom_detect.html#cb196-78" tabindex="-1"></a>  <span class="do">## 2) shape refinement and area filtering</span></span>
<span id="cb196-79"><a href="geom_detect.html#cb196-79" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-80"><a href="geom_detect.html#cb196-80" tabindex="-1"></a>    <span class="co"># to better align the segmentation results with real-world pile construction we&#39;ll now </span></span>
<span id="cb196-81"><a href="geom_detect.html#cb196-81" tabindex="-1"></a>    <span class="co"># simplify candidate segments composed of multiple separate parts representing a single identified feature (i.e. &quot;multi-polygon&quot; candidate segments. </span></span>
<span id="cb196-82"><a href="geom_detect.html#cb196-82" tabindex="-1"></a>    <span class="co"># We&#39;ll simplify these segments by retaining only the largest contiguous portion using `cloud2trees` functionality. </span></span>
<span id="cb196-83"><a href="geom_detect.html#cb196-83" tabindex="-1"></a>    <span class="co"># Because slash piles are constructed as distinct, isolated objects to prevent tree mortality during burning, this refinement step isolates the primary </span></span>
<span id="cb196-84"><a href="geom_detect.html#cb196-84" tabindex="-1"></a>    <span class="co"># candidate body to eliminate detached noise and ensure each segment represents a discrete physical object before area-based filtering</span></span>
<span id="cb196-85"><a href="geom_detect.html#cb196-85" tabindex="-1"></a>    segs_sf <span class="ot">&lt;-</span> </span>
<span id="cb196-86"><a href="geom_detect.html#cb196-86" tabindex="-1"></a>      segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb196-87"><a href="geom_detect.html#cb196-87" tabindex="-1"></a>      <span class="co"># simplify multipolygons by keeping only the largest portion</span></span>
<span id="cb196-88"><a href="geom_detect.html#cb196-88" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID =</span> pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb196-89"><a href="geom_detect.html#cb196-89" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb196-90"><a href="geom_detect.html#cb196-90" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb196-91"><a href="geom_detect.html#cb196-91" tabindex="-1"></a>      <span class="co"># area filtering</span></span>
<span id="cb196-92"><a href="geom_detect.html#cb196-92" tabindex="-1"></a>      <span class="fu">st_filter_area</span>(<span class="at">min_area_m2 =</span> min_area_m2, <span class="at">max_area_m2 =</span> max_area_m2)</span>
<span id="cb196-93"><a href="geom_detect.html#cb196-93" tabindex="-1"></a>    </span>
<span id="cb196-94"><a href="geom_detect.html#cb196-94" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(segs_sf),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb196-95"><a href="geom_detect.html#cb196-95" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb196-96"><a href="geom_detect.html#cb196-96" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and size expectations&quot;</span></span>
<span id="cb196-97"><a href="geom_detect.html#cb196-97" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting size threshold parameters:&quot;</span></span>
<span id="cb196-98"><a href="geom_detect.html#cb196-98" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     `min_area_m2`,`max_area_m2`&quot;</span></span>
<span id="cb196-99"><a href="geom_detect.html#cb196-99" tabindex="-1"></a>      ))</span>
<span id="cb196-100"><a href="geom_detect.html#cb196-100" tabindex="-1"></a>    }</span>
<span id="cb196-101"><a href="geom_detect.html#cb196-101" tabindex="-1"></a></span>
<span id="cb196-102"><a href="geom_detect.html#cb196-102" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-103"><a href="geom_detect.html#cb196-103" tabindex="-1"></a>  <span class="do">## 3) convexity filtering</span></span>
<span id="cb196-104"><a href="geom_detect.html#cb196-104" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-105"><a href="geom_detect.html#cb196-105" tabindex="-1"></a>    <span class="co"># let&#39;s first filter out segments that have holes in them </span></span>
<span id="cb196-106"><a href="geom_detect.html#cb196-106" tabindex="-1"></a>    <span class="co"># or are very irregularly shaped by comparing the area of the polygon and convex hull</span></span>
<span id="cb196-107"><a href="geom_detect.html#cb196-107" tabindex="-1"></a>    <span class="co"># min_convexity_ratio = min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb196-108"><a href="geom_detect.html#cb196-108" tabindex="-1"></a>    <span class="cf">if</span>(min_convexity_ratio<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb196-109"><a href="geom_detect.html#cb196-109" tabindex="-1"></a>      <span class="co"># apply the convexity filtering on the polygons</span></span>
<span id="cb196-110"><a href="geom_detect.html#cb196-110" tabindex="-1"></a>      segs_sf <span class="ot">&lt;-</span> <span class="fu">st_convexity_filter</span>(</span>
<span id="cb196-111"><a href="geom_detect.html#cb196-111" tabindex="-1"></a>          <span class="at">sf_data =</span> segs_sf</span>
<span id="cb196-112"><a href="geom_detect.html#cb196-112" tabindex="-1"></a>          <span class="co"># min required overlap between the polygon and the convex hull of the polygon</span></span>
<span id="cb196-113"><a href="geom_detect.html#cb196-113" tabindex="-1"></a>          , <span class="at">min_convexity_ratio =</span> min_convexity_ratio</span>
<span id="cb196-114"><a href="geom_detect.html#cb196-114" tabindex="-1"></a>        )</span>
<span id="cb196-115"><a href="geom_detect.html#cb196-115" tabindex="-1"></a>    }</span>
<span id="cb196-116"><a href="geom_detect.html#cb196-116" tabindex="-1"></a></span>
<span id="cb196-117"><a href="geom_detect.html#cb196-117" tabindex="-1"></a>    <span class="co"># check return</span></span>
<span id="cb196-118"><a href="geom_detect.html#cb196-118" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(segs_sf),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb196-119"><a href="geom_detect.html#cb196-119" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb196-120"><a href="geom_detect.html#cb196-120" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and `min_convexity_ratio` expectations&quot;</span></span>
<span id="cb196-121"><a href="geom_detect.html#cb196-121" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `min_convexity_ratio` &quot;</span></span>
<span id="cb196-122"><a href="geom_detect.html#cb196-122" tabindex="-1"></a>      ))</span>
<span id="cb196-123"><a href="geom_detect.html#cb196-123" tabindex="-1"></a>    }</span>
<span id="cb196-124"><a href="geom_detect.html#cb196-124" tabindex="-1"></a>   </span>
<span id="cb196-125"><a href="geom_detect.html#cb196-125" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-126"><a href="geom_detect.html#cb196-126" tabindex="-1"></a>  <span class="do">## 4) circularity filtering</span></span>
<span id="cb196-127"><a href="geom_detect.html#cb196-127" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-128"><a href="geom_detect.html#cb196-128" tabindex="-1"></a>    <span class="co"># let&#39;s apply a minimum bounding circle algorithm to remove non-circular segments from the remaining segments</span></span>
<span id="cb196-129"><a href="geom_detect.html#cb196-129" tabindex="-1"></a>    <span class="cf">if</span>(min_circularity_ratio<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb196-130"><a href="geom_detect.html#cb196-130" tabindex="-1"></a>      <span class="co"># apply the circularity filtering on the polygons</span></span>
<span id="cb196-131"><a href="geom_detect.html#cb196-131" tabindex="-1"></a>      segs_sf <span class="ot">&lt;-</span> <span class="fu">st_circularity_filter</span>(</span>
<span id="cb196-132"><a href="geom_detect.html#cb196-132" tabindex="-1"></a>          <span class="at">sf_data =</span> segs_sf</span>
<span id="cb196-133"><a href="geom_detect.html#cb196-133" tabindex="-1"></a>          <span class="co"># min required overlap between the polygon and the minimum bounding circle of the polygon</span></span>
<span id="cb196-134"><a href="geom_detect.html#cb196-134" tabindex="-1"></a>          , <span class="at">min_circularity_ratio =</span> min_circularity_ratio</span>
<span id="cb196-135"><a href="geom_detect.html#cb196-135" tabindex="-1"></a>        )</span>
<span id="cb196-136"><a href="geom_detect.html#cb196-136" tabindex="-1"></a>    }</span>
<span id="cb196-137"><a href="geom_detect.html#cb196-137" tabindex="-1"></a></span>
<span id="cb196-138"><a href="geom_detect.html#cb196-138" tabindex="-1"></a>    <span class="co"># check return</span></span>
<span id="cb196-139"><a href="geom_detect.html#cb196-139" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(segs_sf),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb196-140"><a href="geom_detect.html#cb196-140" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb196-141"><a href="geom_detect.html#cb196-141" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and `min_circularity_ratio` expectations&quot;</span></span>
<span id="cb196-142"><a href="geom_detect.html#cb196-142" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `min_circularity_ratio` &quot;</span></span>
<span id="cb196-143"><a href="geom_detect.html#cb196-143" tabindex="-1"></a>      ))</span>
<span id="cb196-144"><a href="geom_detect.html#cb196-144" tabindex="-1"></a>    }</span>
<span id="cb196-145"><a href="geom_detect.html#cb196-145" tabindex="-1"></a>  </span>
<span id="cb196-146"><a href="geom_detect.html#cb196-146" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-147"><a href="geom_detect.html#cb196-147" tabindex="-1"></a>  <span class="do">## 5) calculate CHM-based structural metrics for the candidate piles</span></span>
<span id="cb196-148"><a href="geom_detect.html#cb196-148" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-149"><a href="geom_detect.html#cb196-149" tabindex="-1"></a>    <span class="co"># we&#39;ll use our `get_structural_metrics()` with the height-filtered CHM to compute the structural metrics for the candidate piles</span></span>
<span id="cb196-150"><a href="geom_detect.html#cb196-150" tabindex="-1"></a>    segs_sf <span class="ot">&lt;-</span> </span>
<span id="cb196-151"><a href="geom_detect.html#cb196-151" tabindex="-1"></a>      <span class="fu">get_structural_metrics</span>(</span>
<span id="cb196-152"><a href="geom_detect.html#cb196-152" tabindex="-1"></a>        <span class="at">sf_data =</span> segs_sf</span>
<span id="cb196-153"><a href="geom_detect.html#cb196-153" tabindex="-1"></a>        , <span class="at">chm_rast =</span> slice_chm_rast</span>
<span id="cb196-154"><a href="geom_detect.html#cb196-154" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb196-155"><a href="geom_detect.html#cb196-155" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;sf_data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb196-156"><a href="geom_detect.html#cb196-156" tabindex="-1"></a>      <span class="co"># we may already have area so we&#39;ll use only the value from this function</span></span>
<span id="cb196-157"><a href="geom_detect.html#cb196-157" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb196-158"><a href="geom_detect.html#cb196-158" tabindex="-1"></a>        <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb196-159"><a href="geom_detect.html#cb196-159" tabindex="-1"></a>        , <span class="st">&quot;poly_area_m2&quot;</span></span>
<span id="cb196-160"><a href="geom_detect.html#cb196-160" tabindex="-1"></a>      )))</span>
<span id="cb196-161"><a href="geom_detect.html#cb196-161" tabindex="-1"></a>    </span>
<span id="cb196-162"><a href="geom_detect.html#cb196-162" tabindex="-1"></a>    <span class="co"># check return</span></span>
<span id="cb196-163"><a href="geom_detect.html#cb196-163" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(segs_sf),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb196-164"><a href="geom_detect.html#cb196-164" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb196-165"><a href="geom_detect.html#cb196-165" tabindex="-1"></a>        <span class="st">&quot;trouble getting the structural metrics&quot;</span></span>
<span id="cb196-166"><a href="geom_detect.html#cb196-166" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting .... something &quot;</span></span>
<span id="cb196-167"><a href="geom_detect.html#cb196-167" tabindex="-1"></a>      ))</span>
<span id="cb196-168"><a href="geom_detect.html#cb196-168" tabindex="-1"></a>    }</span>
<span id="cb196-169"><a href="geom_detect.html#cb196-169" tabindex="-1"></a>    </span>
<span id="cb196-170"><a href="geom_detect.html#cb196-170" tabindex="-1"></a>    <span class="co"># filter for height</span></span>
<span id="cb196-171"><a href="geom_detect.html#cb196-171" tabindex="-1"></a>    segs_sf <span class="ot">&lt;-</span> segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb196-172"><a href="geom_detect.html#cb196-172" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb196-173"><a href="geom_detect.html#cb196-173" tabindex="-1"></a>        max_height_m <span class="sc">&gt;=</span> min_ht_m</span>
<span id="cb196-174"><a href="geom_detect.html#cb196-174" tabindex="-1"></a>        <span class="sc">&amp;</span> max_height_m <span class="sc">&lt;=</span> max_ht_m</span>
<span id="cb196-175"><a href="geom_detect.html#cb196-175" tabindex="-1"></a>      )</span>
<span id="cb196-176"><a href="geom_detect.html#cb196-176" tabindex="-1"></a>    </span>
<span id="cb196-177"><a href="geom_detect.html#cb196-177" tabindex="-1"></a>    <span class="co"># check return</span></span>
<span id="cb196-178"><a href="geom_detect.html#cb196-178" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(segs_sf),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb196-179"><a href="geom_detect.html#cb196-179" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb196-180"><a href="geom_detect.html#cb196-180" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and size expectations&quot;</span></span>
<span id="cb196-181"><a href="geom_detect.html#cb196-181" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting size threshold parameters:&quot;</span></span>
<span id="cb196-182"><a href="geom_detect.html#cb196-182" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     `min_ht_m`,`max_ht_m`&quot;</span></span>
<span id="cb196-183"><a href="geom_detect.html#cb196-183" tabindex="-1"></a>      ))</span>
<span id="cb196-184"><a href="geom_detect.html#cb196-184" tabindex="-1"></a>    }</span>
<span id="cb196-185"><a href="geom_detect.html#cb196-185" tabindex="-1"></a>    </span>
<span id="cb196-186"><a href="geom_detect.html#cb196-186" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-187"><a href="geom_detect.html#cb196-187" tabindex="-1"></a>  <span class="do">## 6) shape refinement &amp; overlap removal</span></span>
<span id="cb196-188"><a href="geom_detect.html#cb196-188" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb196-189"><a href="geom_detect.html#cb196-189" tabindex="-1"></a>    <span class="co"># use the convex hull shapes of our remaining segments. </span></span>
<span id="cb196-190"><a href="geom_detect.html#cb196-190" tabindex="-1"></a>    <span class="co"># This helps to smooth out the often &#39;blocky&#39; edges of raster-based segments</span></span>
<span id="cb196-191"><a href="geom_detect.html#cb196-191" tabindex="-1"></a>    <span class="co"># , which can look like they were generated in Minecraft. </span></span>
<span id="cb196-192"><a href="geom_detect.html#cb196-192" tabindex="-1"></a>    <span class="co"># Additionally, by removing any segments with overlapping convex hull shapes, </span></span>
<span id="cb196-193"><a href="geom_detect.html#cb196-193" tabindex="-1"></a>    <span class="co"># we can likely reduce false detections that are actually groups of small trees or shrubs, </span></span>
<span id="cb196-194"><a href="geom_detect.html#cb196-194" tabindex="-1"></a>    <span class="co"># ensuring our results represent singular slash piles.</span></span>
<span id="cb196-195"><a href="geom_detect.html#cb196-195" tabindex="-1"></a>    </span>
<span id="cb196-196"><a href="geom_detect.html#cb196-196" tabindex="-1"></a>    <span class="cf">if</span>(smooth_segs){</span>
<span id="cb196-197"><a href="geom_detect.html#cb196-197" tabindex="-1"></a>      <span class="co"># take the convex hull and apply our `st_remove_overlaps()` function to the remaining candidate segments. </span></span>
<span id="cb196-198"><a href="geom_detect.html#cb196-198" tabindex="-1"></a>      <span class="co"># Finally, we filter for area based on the smoothed shape </span></span>
<span id="cb196-199"><a href="geom_detect.html#cb196-199" tabindex="-1"></a>      segs_sf <span class="ot">&lt;-</span></span>
<span id="cb196-200"><a href="geom_detect.html#cb196-200" tabindex="-1"></a>        segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb196-201"><a href="geom_detect.html#cb196-201" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb196-202"><a href="geom_detect.html#cb196-202" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb196-203"><a href="geom_detect.html#cb196-203" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb196-204"><a href="geom_detect.html#cb196-204" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb196-205"><a href="geom_detect.html#cb196-205" tabindex="-1"></a>        <span class="fu">st_remove_overlaps</span>() <span class="sc">%&gt;%</span></span>
<span id="cb196-206"><a href="geom_detect.html#cb196-206" tabindex="-1"></a>        <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb196-207"><a href="geom_detect.html#cb196-207" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb196-208"><a href="geom_detect.html#cb196-208" tabindex="-1"></a>          <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb196-209"><a href="geom_detect.html#cb196-209" tabindex="-1"></a>          , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb196-210"><a href="geom_detect.html#cb196-210" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb196-211"><a href="geom_detect.html#cb196-211" tabindex="-1"></a>        <span class="fu">st_filter_area</span>(<span class="at">min_area_m2 =</span> min_area_m2, <span class="at">max_area_m2 =</span> max_area_m2)</span>
<span id="cb196-212"><a href="geom_detect.html#cb196-212" tabindex="-1"></a>      </span>
<span id="cb196-213"><a href="geom_detect.html#cb196-213" tabindex="-1"></a>      <span class="co"># check return</span></span>
<span id="cb196-214"><a href="geom_detect.html#cb196-214" tabindex="-1"></a>      <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(segs_sf),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb196-215"><a href="geom_detect.html#cb196-215" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb196-216"><a href="geom_detect.html#cb196-216" tabindex="-1"></a>          <span class="st">&quot;no segments detected after removing overlapping final segments&quot;</span></span>
<span id="cb196-217"><a href="geom_detect.html#cb196-217" tabindex="-1"></a>          , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try with `smooth_segs = F`&quot;</span></span>
<span id="cb196-218"><a href="geom_detect.html#cb196-218" tabindex="-1"></a>        ))</span>
<span id="cb196-219"><a href="geom_detect.html#cb196-219" tabindex="-1"></a>      }</span>
<span id="cb196-220"><a href="geom_detect.html#cb196-220" tabindex="-1"></a>    }</span>
<span id="cb196-221"><a href="geom_detect.html#cb196-221" tabindex="-1"></a>    </span>
<span id="cb196-222"><a href="geom_detect.html#cb196-222" tabindex="-1"></a>    <span class="co"># calculate diameter</span></span>
<span id="cb196-223"><a href="geom_detect.html#cb196-223" tabindex="-1"></a>    segs_sf <span class="ot">&lt;-</span> <span class="fu">st_calculate_diameter</span>(segs_sf)</span>
<span id="cb196-224"><a href="geom_detect.html#cb196-224" tabindex="-1"></a>      </span>
<span id="cb196-225"><a href="geom_detect.html#cb196-225" tabindex="-1"></a>  <span class="co"># check for write</span></span>
<span id="cb196-226"><a href="geom_detect.html#cb196-226" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb196-227"><a href="geom_detect.html#cb196-227" tabindex="-1"></a>      <span class="fu">inherits</span>(ofile,<span class="st">&quot;character&quot;</span>) </span>
<span id="cb196-228"><a href="geom_detect.html#cb196-228" tabindex="-1"></a>      <span class="sc">&amp;&amp;</span> stringr<span class="sc">::</span><span class="fu">str_squish</span>(ofile)<span class="sc">!=</span><span class="st">&quot;&quot;</span> </span>
<span id="cb196-229"><a href="geom_detect.html#cb196-229" tabindex="-1"></a>      <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">identical</span>(stringr<span class="sc">::</span><span class="fu">str_squish</span>(ofile),<span class="fu">character</span>(<span class="dv">0</span>)) </span>
<span id="cb196-230"><a href="geom_detect.html#cb196-230" tabindex="-1"></a>    ){</span>
<span id="cb196-231"><a href="geom_detect.html#cb196-231" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_write</span>(segs_sf, <span class="at">dsn =</span> ofile, <span class="at">quiet =</span> T, <span class="at">append =</span> F)</span>
<span id="cb196-232"><a href="geom_detect.html#cb196-232" tabindex="-1"></a>      <span class="fu">return</span>(ofile)</span>
<span id="cb196-233"><a href="geom_detect.html#cb196-233" tabindex="-1"></a>    }</span>
<span id="cb196-234"><a href="geom_detect.html#cb196-234" tabindex="-1"></a>    </span>
<span id="cb196-235"><a href="geom_detect.html#cb196-235" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb196-236"><a href="geom_detect.html#cb196-236" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb196-237"><a href="geom_detect.html#cb196-237" tabindex="-1"></a>      <span class="at">segs_sf =</span> segs_sf</span>
<span id="cb196-238"><a href="geom_detect.html#cb196-238" tabindex="-1"></a>      , <span class="at">seg_mthd_params =</span> get_segmentation_candidates_ans<span class="sc">$</span>seg_mthd_params</span>
<span id="cb196-239"><a href="geom_detect.html#cb196-239" tabindex="-1"></a>      , <span class="at">slice_chm_rast =</span> get_segmentation_candidates_ans<span class="sc">$</span>slice_chm_rast</span>
<span id="cb196-240"><a href="geom_detect.html#cb196-240" tabindex="-1"></a>    ))</span>
<span id="cb196-241"><a href="geom_detect.html#cb196-241" tabindex="-1"></a>}</span></code></pre></div>
<p>remove all other parameters and objects that might have the same name as in this function since we used the framework outlined above to define this (fantastic?) beast of a function</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="geom_detect.html#cb197-1" tabindex="-1"></a><span class="fu">remove</span>(</span>
<span id="cb197-2"><a href="geom_detect.html#cb197-2" tabindex="-1"></a>  min_ht_m, max_ht_m</span>
<span id="cb197-3"><a href="geom_detect.html#cb197-3" tabindex="-1"></a>  , min_area_m2, max_area_m2</span>
<span id="cb197-4"><a href="geom_detect.html#cb197-4" tabindex="-1"></a>  , min_convexity_ratio</span>
<span id="cb197-5"><a href="geom_detect.html#cb197-5" tabindex="-1"></a>  , min_circularity_ratio</span>
<span id="cb197-6"><a href="geom_detect.html#cb197-6" tabindex="-1"></a>  , get_segmentation_params_ans</span>
<span id="cb197-7"><a href="geom_detect.html#cb197-7" tabindex="-1"></a>  , dbscan_segs_poly, watershed_segs_poly</span>
<span id="cb197-8"><a href="geom_detect.html#cb197-8" tabindex="-1"></a>  , dbscan_segs, watershed_segs</span>
<span id="cb197-9"><a href="geom_detect.html#cb197-9" tabindex="-1"></a>  , dbscan_segs_poly_chull, dbscan_segs_poly_mbc</span>
<span id="cb197-10"><a href="geom_detect.html#cb197-10" tabindex="-1"></a>  , watershed_segs_poly_chull, watershed_segs_poly_mbc</span>
<span id="cb197-11"><a href="geom_detect.html#cb197-11" tabindex="-1"></a>  , aoi_chm_rast_slice</span>
<span id="cb197-12"><a href="geom_detect.html#cb197-12" tabindex="-1"></a>)</span>
<span id="cb197-13"><a href="geom_detect.html#cb197-13" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<p>let’s test this real quick on our example area</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="geom_detect.html#cb198-1" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="ot">&lt;-</span> <span class="fu">slash_pile_detect</span>(</span>
<span id="cb198-2"><a href="geom_detect.html#cb198-2" tabindex="-1"></a>  <span class="at">chm_rast =</span> aoi_chm_rast</span>
<span id="cb198-3"><a href="geom_detect.html#cb198-3" tabindex="-1"></a>  , <span class="at">seg_method =</span> <span class="st">&quot;watershed&quot;</span></span>
<span id="cb198-4"><a href="geom_detect.html#cb198-4" tabindex="-1"></a>  , <span class="at">min_ht_m =</span> <span class="dv">1</span></span>
<span id="cb198-5"><a href="geom_detect.html#cb198-5" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span></span>
<span id="cb198-6"><a href="geom_detect.html#cb198-6" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="fl">1.5</span><span class="sc">^</span><span class="dv">2</span></span>
<span id="cb198-7"><a href="geom_detect.html#cb198-7" tabindex="-1"></a>  , <span class="at">max_area_m2 =</span> <span class="dv">50</span></span>
<span id="cb198-8"><a href="geom_detect.html#cb198-8" tabindex="-1"></a>  , <span class="at">min_convexity_ratio =</span> <span class="fl">0.7</span></span>
<span id="cb198-9"><a href="geom_detect.html#cb198-9" tabindex="-1"></a>  , <span class="at">min_circularity_ratio =</span> <span class="fl">0.5</span></span>
<span id="cb198-10"><a href="geom_detect.html#cb198-10" tabindex="-1"></a>)</span></code></pre></div>
<p>the <code>slash_pile_detect()</code> function returns:</p>
<ol style="list-style-type: decimal">
<li><code>segs_sf</code>: the segments that passed all size and geometric expectations for target slash piles</li>
<li><code>seg_mthd_params</code>: the dynamic parameters used in the Watershed or DBSCAN segmentation method</li>
<li><code>slice_chm_rast</code>: the height-filtered CHM slice used to segment candidate slash piles</li>
</ol>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="geom_detect.html#cb199-1" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb199-2"><a href="geom_detect.html#cb199-2" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## List of 3
##  $ segs_sf        : sf [19 × 9] (S3: sf/tbl_df/tbl/data.frame)
##   ..$ pred_id          : num [1:19] 54 69 83 84 87 88 89 94 100 101 ...
##   ..$ convexity_ratio  : num [1:19] 0.91 0.894 0.93 0.881 0.933 ...
##   ..$ circularity_ratio: num [1:19] 0.697 0.671 0.754 0.652 0.662 ...
##   ..$ area_m2          : num [1:19] 25.32 26.82 5.05 20.26 6.18 ...
##   ..$ volume_m3        : num [1:19] 34.55 39.72 4.39 21.23 4.48 ...
##   ..$ max_height_m     : num [1:19] 3.57 3.18 2.56 2.54 2.36 ...
##   ..$ volume_per_area  : num [1:19] 1.364 1.481 0.868 1.048 0.725 ...
##   ..$ geometry         :sfc_POLYGON of length 19; first list element: List of 1
##   .. ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;XY&quot; &quot;POLYGON&quot; &quot;sfg&quot;
##   ..$ diameter_m       : num [1:19] 6.45 6.75 2.82 5.91 3.33 ...
##   ..- attr(*, &quot;sf_column&quot;)= chr &quot;geometry&quot;
##   ..- attr(*, &quot;agr&quot;)= Factor w/ 3 levels &quot;constant&quot;,&quot;aggregate&quot;,..: NA NA NA NA NA NA NA NA
##   .. ..- attr(*, &quot;names&quot;)= chr [1:8] &quot;pred_id&quot; &quot;convexity_ratio&quot; &quot;circularity_ratio&quot; &quot;area_m2&quot; ...
##  $ seg_mthd_params:List of 3
##   ..$ data_summary:List of 2
##   .. ..$ pts_per_m2: num 100
##   .. ..$ rast_res_m: num 0.1
##   ..$ watershed   :List of 2
##   .. ..$ tol: num 1.5
##   .. ..$ ext: num 2
##   ..$ dbscan      :List of 2
##   .. ..$ eps   : num 0.15
##   .. ..$ minPts: num 7
##  $ slice_chm_rast :S4 class &#39;SpatRaster&#39; [package &quot;terra&quot;]</code></pre>
<p>let’s check out the height-filtered CHM “slice”</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="geom_detect.html#cb201-1" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp<span class="sc">$</span>slice_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb201-2"><a href="geom_detect.html#cb201-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">main =</span> <span class="st">&quot;filtered CHM (m)&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-247-1.png" alt="" width="1008" /></p>
<p>let’s overlay the final candidate segments (magenta) and the actual piles (cyan) on the raw, un-filtered CHM</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="geom_detect.html#cb202-1" tabindex="-1"></a>aoi_chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb202-2"><a href="geom_detect.html#cb202-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">main =</span> <span class="st">&quot;CHM (m) and demonstration piles&quot;</span>)</span>
<span id="cb202-3"><a href="geom_detect.html#cb202-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb202-4"><a href="geom_detect.html#cb202-4" tabindex="-1"></a>  aoi_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb202-5"><a href="geom_detect.html#cb202-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb202-6"><a href="geom_detect.html#cb202-6" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb202-7"><a href="geom_detect.html#cb202-7" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb202-8"><a href="geom_detect.html#cb202-8" tabindex="-1"></a>)</span>
<span id="cb202-9"><a href="geom_detect.html#cb202-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb202-10"><a href="geom_detect.html#cb202-10" tabindex="-1"></a>  slash_pile_detect_watershed_ans_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb202-11"><a href="geom_detect.html#cb202-11" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">2.5</span></span>
<span id="cb202-12"><a href="geom_detect.html#cb202-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-248-1.png" alt="" width="1008" /></p>
<p>how do the form quantification measurements look?</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="geom_detect.html#cb203-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb203-2"><a href="geom_detect.html#cb203-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb203-3"><a href="geom_detect.html#cb203-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> area_m2)) <span class="sc">+</span></span>
<span id="cb203-4"><a href="geom_detect.html#cb203-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Blues&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb203-5"><a href="geom_detect.html#cb203-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;area_m2&quot;</span>) <span class="sc">+</span></span>
<span id="cb203-6"><a href="geom_detect.html#cb203-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb203-7"><a href="geom_detect.html#cb203-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>,<span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb203-8"><a href="geom_detect.html#cb203-8" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb203-9"><a href="geom_detect.html#cb203-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb203-10"><a href="geom_detect.html#cb203-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> volume_m3)) <span class="sc">+</span></span>
<span id="cb203-11"><a href="geom_detect.html#cb203-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Purples&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb203-12"><a href="geom_detect.html#cb203-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;volume_m3&quot;</span>) <span class="sc">+</span></span>
<span id="cb203-13"><a href="geom_detect.html#cb203-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb203-14"><a href="geom_detect.html#cb203-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>,<span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb203-15"><a href="geom_detect.html#cb203-15" tabindex="-1"></a>p3_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb203-16"><a href="geom_detect.html#cb203-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb203-17"><a href="geom_detect.html#cb203-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> max_height_m)) <span class="sc">+</span></span>
<span id="cb203-18"><a href="geom_detect.html#cb203-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Greens&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb203-19"><a href="geom_detect.html#cb203-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;max_height_m&quot;</span>) <span class="sc">+</span></span>
<span id="cb203-20"><a href="geom_detect.html#cb203-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb203-21"><a href="geom_detect.html#cb203-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>,<span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb203-22"><a href="geom_detect.html#cb203-22" tabindex="-1"></a>p4_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb203-23"><a href="geom_detect.html#cb203-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb203-24"><a href="geom_detect.html#cb203-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> diameter_m)) <span class="sc">+</span></span>
<span id="cb203-25"><a href="geom_detect.html#cb203-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;PuRd&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb203-26"><a href="geom_detect.html#cb203-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;diameter_m&quot;</span>) <span class="sc">+</span></span>
<span id="cb203-27"><a href="geom_detect.html#cb203-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb203-28"><a href="geom_detect.html#cb203-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>,<span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb203-29"><a href="geom_detect.html#cb203-29" tabindex="-1"></a>(p1_temp <span class="sc">+</span> p2_temp) <span class="sc">/</span> (p3_temp <span class="sc">+</span> p4_temp)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-249-1.png" alt="" width="1008" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ptcld_process.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data_fusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
