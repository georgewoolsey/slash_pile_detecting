<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 5 Data Fusion | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 5 Data Fusion | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 5 Data Fusion | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="geom_detect.html"/>
<link rel="next" href="meth_eval.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.9/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<link href="libs/study sites-CSS-0.0.1/study sites_home-button.css" rel="stylesheet" />
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data and Site Descriptions</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#silvicultural-prescriptions"><i class="fa fa-check"></i><b>1.2.1</b> Silvicultural Prescriptions</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#analysis-plan"><i class="fa fa-check"></i><b>1.3</b> Analysis Plan</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data_load.html"><a href="data_load.html"><i class="fa fa-check"></i><b>2</b> Data Overview</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data_load.html"><a href="data_load.html#study-units-vector-data"><i class="fa fa-check"></i><b>2.1</b> Study Units Vector Data</a></li>
<li class="chapter" data-level="2.2" data-path="data_load.html"><a href="data_load.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.2</b> Slash Pile Vector Data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data_load.html"><a href="data_load.html#standardize-pile-data"><i class="fa fa-check"></i><b>2.2.1</b> Standardize Pile Data</a></li>
<li class="chapter" data-level="2.2.2" data-path="data_load.html"><a href="data_load.html#pile-form-measurements"><i class="fa fa-check"></i><b>2.2.2</b> Pile Form Measurements</a></li>
<li class="chapter" data-level="2.2.3" data-path="data_load.html"><a href="data_load.html#image-annotation-comparison"><i class="fa fa-check"></i><b>2.2.3</b> Image-Annotation Comparison</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data_load.html"><a href="data_load.html#rgb-orthomosaic"><i class="fa fa-check"></i><b>2.3</b> RGB orthomosaic</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="data_load.html"><a href="data_load.html#psinf-mixed-conifer-site-1"><i class="fa fa-check"></i><b>2.3.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="2.3.2" data-path="data_load.html"><a href="data_load.html#trfo-blm-pinyon-juniper-site-1"><i class="fa fa-check"></i><b>2.3.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="2.3.3" data-path="data_load.html"><a href="data_load.html#bhef-ponderosa-pine-site-1"><i class="fa fa-check"></i><b>2.3.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="2.3.4" data-path="data_load.html"><a href="data_load.html#arnf-ponderosa-pine-site-1"><i class="fa fa-check"></i><b>2.3.4</b> ARNF Ponderosa Pine Site</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="data_load.html"><a href="data_load.html#slash-pile-rgb-imagery"><i class="fa fa-check"></i><b>2.4</b> Slash Pile RGB Imagery</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="data_load.html"><a href="data_load.html#psinf-mixed-conifer-site-2"><i class="fa fa-check"></i><b>2.4.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="2.4.2" data-path="data_load.html"><a href="data_load.html#trfo-blm-pinyon-juniper-site-2"><i class="fa fa-check"></i><b>2.4.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="2.4.3" data-path="data_load.html"><a href="data_load.html#bhef-ponderosa-pine-site-2"><i class="fa fa-check"></i><b>2.4.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="2.4.4" data-path="data_load.html"><a href="data_load.html#arnf-ponderosa-pine-site-2"><i class="fa fa-check"></i><b>2.4.4</b> ARNF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="2.4.5" data-path="data_load.html"><a href="data_load.html#all"><i class="fa fa-check"></i><b>2.4.5</b> All</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ptcld_process.html"><a href="ptcld_process.html"><i class="fa fa-check"></i><b>3</b> Point Cloud Processing</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ptcld_process.html"><a href="ptcld_process.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>3.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="ptcld_process.html"><a href="ptcld_process.html#ptcld_process_psinf"><i class="fa fa-check"></i><b>3.1.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="3.1.2" data-path="ptcld_process.html"><a href="ptcld_process.html#trfo-blm-pinyon-juniper-site-3"><i class="fa fa-check"></i><b>3.1.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="3.1.3" data-path="ptcld_process.html"><a href="ptcld_process.html#bhef-ponderosa-pine-site-3"><i class="fa fa-check"></i><b>3.1.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="3.1.4" data-path="ptcld_process.html"><a href="ptcld_process.html#arnf-ponderosa-pine-site-3"><i class="fa fa-check"></i><b>3.1.4</b> ARNF Ponderosa Pine Site</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="ptcld_process.html"><a href="ptcld_process.html#clean-up"><i class="fa fa-check"></i><b>3.2</b> Clean Up</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geom_detect.html"><a href="geom_detect.html"><i class="fa fa-check"></i><b>4</b> Geometry-based Slash Pile Detection</a>
<ul>
<li class="chapter" data-level="4.1" data-path="geom_detect.html"><a href="geom_detect.html#d_area"><i class="fa fa-check"></i><b>4.1</b> Demonstration Area</a></li>
<li class="chapter" data-level="4.2" data-path="geom_detect.html"><a href="geom_detect.html#segmentation-methods"><i class="fa fa-check"></i><b>4.2</b> Segmentation Methods</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="geom_detect.html"><a href="geom_detect.html#seg_methods"><i class="fa fa-check"></i><b>4.2.1</b> Overview of Methods</a></li>
<li class="chapter" data-level="4.2.2" data-path="geom_detect.html"><a href="geom_detect.html#watershed-segmentation-demonstration"><i class="fa fa-check"></i><b>4.2.2</b> Watershed Segmentation Demonstration</a></li>
<li class="chapter" data-level="4.2.3" data-path="geom_detect.html"><a href="geom_detect.html#dbscan-segmentation-demonstration"><i class="fa fa-check"></i><b>4.2.3</b> DBSCAN Segmentation Demonstration</a></li>
<li class="chapter" data-level="4.2.4" data-path="geom_detect.html"><a href="geom_detect.html#comparison-of-candidate-segments"><i class="fa fa-check"></i><b>4.2.4</b> Comparison of Candidate Segments</a></li>
<li class="chapter" data-level="4.2.5" data-path="geom_detect.html"><a href="geom_detect.html#segmentation-function"><i class="fa fa-check"></i><b>4.2.5</b> Segmentation Function</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="geom_detect.html"><a href="geom_detect.html#candidate-shape-refinement-and-area-filtering"><i class="fa fa-check"></i><b>4.3</b> Candidate Shape Refinement and Area filtering</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="geom_detect.html"><a href="geom_detect.html#watershed-segmentation"><i class="fa fa-check"></i><b>4.3.1</b> Watershed Segmentation</a></li>
<li class="chapter" data-level="4.3.2" data-path="geom_detect.html"><a href="geom_detect.html#dbscan-segmentation"><i class="fa fa-check"></i><b>4.3.2</b> DBSCAN Segmentation</a></li>
<li class="chapter" data-level="4.3.3" data-path="geom_detect.html"><a href="geom_detect.html#quick-methods-comparison"><i class="fa fa-check"></i><b>4.3.3</b> Quick methods comparison</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="geom_detect.html"><a href="geom_detect.html#candidate-geometric-filtering"><i class="fa fa-check"></i><b>4.4</b> Candidate Geometric filtering</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="geom_detect.html"><a href="geom_detect.html#shape-irregularity-convexity"><i class="fa fa-check"></i><b>4.4.1</b> Shape Irregularity: Convexity</a></li>
<li class="chapter" data-level="4.4.2" data-path="geom_detect.html"><a href="geom_detect.html#shape-irregularity-circularity"><i class="fa fa-check"></i><b>4.4.2</b> Shape Irregularity: Circularity</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="geom_detect.html"><a href="geom_detect.html#structural-metrics-from-chm"><i class="fa fa-check"></i><b>4.5</b> Structural Metrics from CHM</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="geom_detect.html"><a href="geom_detect.html#structural-rasters"><i class="fa fa-check"></i><b>4.5.1</b> Structural Rasters</a></li>
<li class="chapter" data-level="4.5.2" data-path="geom_detect.html"><a href="geom_detect.html#demonstration-candidate-segment-metrics"><i class="fa fa-check"></i><b>4.5.2</b> Demonstration Candidate Segment Metrics</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="geom_detect.html"><a href="geom_detect.html#final-shape-refinement"><i class="fa fa-check"></i><b>4.6</b> Final Shape Refinement</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="geom_detect.html"><a href="geom_detect.html#watershed-segmentation-3"><i class="fa fa-check"></i><b>4.6.1</b> Watershed Segmentation</a></li>
<li class="chapter" data-level="4.6.2" data-path="geom_detect.html"><a href="geom_detect.html#dbscan-segmentation-3"><i class="fa fa-check"></i><b>4.6.2</b> DBSCAN Segmentation</a></li>
<li class="chapter" data-level="4.6.3" data-path="geom_detect.html"><a href="geom_detect.html#quick-methods-comparison-2"><i class="fa fa-check"></i><b>4.6.3</b> Quick methods comparison</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="geom_detect.html"><a href="geom_detect.html#slash_pile_detect_fn"><i class="fa fa-check"></i><b>4.7</b> Pile Detection Function</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data_fusion.html"><a href="data_fusion.html"><i class="fa fa-check"></i><b>5</b> Data Fusion</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data_fusion.html"><a href="data_fusion.html#rgb-indices"><i class="fa fa-check"></i><b>5.1</b> RGB Indices</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-functions"><i class="fa fa-check"></i><b>5.1.1</b> Spectral Index Functions</a></li>
<li class="chapter" data-level="5.1.2" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-of-polygons"><i class="fa fa-check"></i><b>5.1.2</b> Spectral Index of Polygons</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data_fusion.html"><a href="data_fusion.html#demonstration-pile-spectral-summary"><i class="fa fa-check"></i><b>5.2</b> Demonstration Pile Spectral Summary</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="data_fusion.html"><a href="data_fusion.html#voting-system"><i class="fa fa-check"></i><b>5.2.1</b> Voting System</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="data_fusion.html"><a href="data_fusion.html#polygon_spectral_filtering"><i class="fa fa-check"></i><b>5.3</b> Candidate Polygon Spectral Filtering Function</a></li>
<li class="chapter" data-level="5.4" data-path="data_fusion.html"><a href="data_fusion.html#data-fusion-method-demonstration"><i class="fa fa-check"></i><b>5.4</b> Data Fusion Method Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="meth_eval.html"><a href="meth_eval.html"><i class="fa fa-check"></i><b>6</b> Method Evaluation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="meth_eval.html"><a href="meth_eval.html#iou_match"><i class="fa fa-check"></i><b>6.1</b> Instance Matching</a></li>
<li class="chapter" data-level="6.2" data-path="meth_eval.html"><a href="meth_eval.html#detect_metrics_form"><i class="fa fa-check"></i><b>6.2</b> Detection Accuracy Metrics</a></li>
<li class="chapter" data-level="6.3" data-path="meth_eval.html"><a href="meth_eval.html#quant_metrics_form"><i class="fa fa-check"></i><b>6.3</b> Quantification Accuracy Metrics</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="meth_preds.html"><a href="meth_preds.html"><i class="fa fa-check"></i><b>7</b> Method Predictions</a>
<ul>
<li class="chapter" data-level="7.1" data-path="meth_preds.html"><a href="meth_preds.html#size-and-geometric-parameter-settings"><i class="fa fa-check"></i><b>7.1</b> Size and Geometric Parameter Settings</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="meth_preds.html"><a href="meth_preds.html#psinf-mixed-conifer-site-3"><i class="fa fa-check"></i><b>7.1.1</b> PSINF Mixed Conifer Site</a></li>
<li class="chapter" data-level="7.1.2" data-path="meth_preds.html"><a href="meth_preds.html#trfo-blm-pinyon-juniper-site-4"><i class="fa fa-check"></i><b>7.1.2</b> TRFO-BLM Pinyon-Juniper Site</a></li>
<li class="chapter" data-level="7.1.3" data-path="meth_preds.html"><a href="meth_preds.html#bhef-ponderosa-pine-site-4"><i class="fa fa-check"></i><b>7.1.3</b> BHEF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="7.1.4" data-path="meth_preds.html"><a href="meth_preds.html#arnf-ponderosa-pine-site-4"><i class="fa fa-check"></i><b>7.1.4</b> ARNF Ponderosa Pine Site</a></li>
<li class="chapter" data-level="7.1.5" data-path="meth_preds.html"><a href="meth_preds.html#study-paremeter-settings"><i class="fa fa-check"></i><b>7.1.5</b> Study Paremeter Settings</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="meth_preds.html"><a href="meth_preds.html#chm-based-slash-pile-candidates"><i class="fa fa-check"></i><b>7.2</b> CHM-based Slash Pile Candidates</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="meth_preds.html"><a href="meth_preds.html#dbscan-candidates"><i class="fa fa-check"></i><b>7.2.1</b> DBSCAN Candidates</a></li>
<li class="chapter" data-level="7.2.2" data-path="meth_preds.html"><a href="meth_preds.html#watershed-candidates"><i class="fa fa-check"></i><b>7.2.2</b> Watershed Candidates</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="meth_preds.html"><a href="meth_preds.html#spectral-filter-slash-pile-candidates"><i class="fa fa-check"></i><b>7.3</b> Spectral Filter Slash Pile Candidates</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="meth_preds.html"><a href="meth_preds.html#dbscan-predictions"><i class="fa fa-check"></i><b>7.3.1</b> DBSCAN Predictions</a></li>
<li class="chapter" data-level="7.3.2" data-path="meth_preds.html"><a href="meth_preds.html#watershed-predictions"><i class="fa fa-check"></i><b>7.3.2</b> Watershed Predictions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="preds_detect.html"><a href="preds_detect.html"><i class="fa fa-check"></i><b>8</b> Detection Accuracy</a>
<ul>
<li class="chapter" data-level="8.1" data-path="preds_detect.html"><a href="preds_detect.html#instance-matching"><i class="fa fa-check"></i><b>8.1</b> Instance Matching</a></li>
<li class="chapter" data-level="8.2" data-path="preds_detect.html"><a href="preds_detect.html#detection-accuracy-metrics"><i class="fa fa-check"></i><b>8.2</b> Detection Accuracy Metrics</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="preds_detect.html"><a href="preds_detect.html#agg_inst_match"><i class="fa fa-check"></i><b>8.2.1</b> Aggregate Instance Match Results</a></li>
<li class="chapter" data-level="8.2.2" data-path="preds_detect.html"><a href="preds_detect.html#detection-accuracy-results"><i class="fa fa-check"></i><b>8.2.2</b> Detection Accuracy Results</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="preds_detect.html"><a href="preds_detect.html#segmentation-method-accuracy-comparison"><i class="fa fa-check"></i><b>8.3</b> Segmentation Method Accuracy Comparison</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="preds_detect.html"><a href="preds_detect.html#paired-t-test"><i class="fa fa-check"></i><b>8.3.1</b> Paired T-Test</a></li>
<li class="chapter" data-level="8.3.2" data-path="preds_detect.html"><a href="preds_detect.html#bayesian-approach"><i class="fa fa-check"></i><b>8.3.2</b> Bayesian Approach</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="preds_detect.html"><a href="preds_detect.html#individual-pile-evaluation"><i class="fa fa-check"></i><b>8.4</b> Individual Pile Evaluation</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="preds_detect.html"><a href="preds_detect.html#true-positives"><i class="fa fa-check"></i><b>8.4.1</b> True Positives</a></li>
<li class="chapter" data-level="8.4.2" data-path="preds_detect.html"><a href="preds_detect.html#omissions-false-negatives"><i class="fa fa-check"></i><b>8.4.2</b> Omissions (False Negatives)</a></li>
<li class="chapter" data-level="8.4.3" data-path="preds_detect.html"><a href="preds_detect.html#commissions-false-positives"><i class="fa fa-check"></i><b>8.4.3</b> commissions (False Positives)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="preds_quantit.html"><a href="preds_quantit.html"><i class="fa fa-check"></i><b>9</b> Detection Accuracy</a>
<ul>
<li class="chapter" data-level="9.1" data-path="preds_quantit.html"><a href="preds_quantit.html#height-and-diameter-accuracy"><i class="fa fa-check"></i><b>9.1</b> Height and Diameter Accuracy</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="preds_quantit.html"><a href="preds_quantit.html#stand-level-aggregation"><i class="fa fa-check"></i><b>9.1.1</b> Stand-level Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="preds_quantit.html"><a href="preds_quantit.html#area-accuracy"><i class="fa fa-check"></i><b>9.2</b> Area Accuracy</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="preds_quantit.html"><a href="preds_quantit.html#stand-level-aggregation-1"><i class="fa fa-check"></i><b>9.2.1</b> Stand-level Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="preds_quantit.html"><a href="preds_quantit.html#vol_comp"><i class="fa fa-check"></i><b>9.3</b> Volume Comparison</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="preds_quantit.html"><a href="preds_quantit.html#extreme-volume-disagreements"><i class="fa fa-check"></i><b>9.3.1</b> Extreme Volume Disagreements</a></li>
<li class="chapter" data-level="9.3.2" data-path="preds_quantit.html"><a href="preds_quantit.html#allometric-volume-comparison"><i class="fa fa-check"></i><b>9.3.2</b> Allometric Volume Comparison</a></li>
<li class="chapter" data-level="9.3.3" data-path="preds_quantit.html"><a href="preds_quantit.html#stand-level-aggregation-2"><i class="fa fa-check"></i><b>9.3.3</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data_fusion" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Section 5</span> Data Fusion<a href="data_fusion.html#data_fusion" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We’ll demonstrate our approach that uses both aerial point cloud-generated CHM data (for structural information) and RGB imagery (for spectral information) which is a data fusion approach. In the prior section, we demonstrated our geometric, rules-based <a href="geom_detect.html#geom_detect">slash pile detection approach</a>. Our data fusion approach identify initial candidate slash piles based on their structural form using this geometric, rules-based method and then integrates the RGB imagery to filter these candidates spectrally. This data fusion methodology leverages the complementary strengths of both data types, using 3D geometry (or “2.5D” as CHM is sometimes referred to) for initial object segmentation and spectral data to refine detections by using thresholds defined to identify green biomass and rock and soil features for exclusion.</p>
<p>we’ll continue using the same demonstration area for this walkthrough as introduced in the <a href="geom_detect.html#d_area">prior section</a></p>
<div id="rgb-indices" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> RGB Indices<a href="data_fusion.html#rgb-indices" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Our data fusion approach uses methods feasible with RGB data since most common UAS systems lack additional multispectral sensors. Despite the absence of multispectral data (e.g. near-infrared), many RGB-based indices correlate strongly with multispectral measurements, particularly those related to leaf area (<a href="https://doi.org/10.1111/aab.12484">Santini et al. 2019</a>). We employ six specific spectral threshold tests: the Green Red Vegetation Index (GRVI), Red Green Ratio Index (RGRI), Visible Band-Difference Vegetation Index (VDVI), and Excess Green-minus-Red Index (ExGR), alongside components from the CIELAB and HSV color models. These indices were selected based on their established ability in existing research to effectively distinguish living vegetation from dead material or background features, while the application of thresholds to indices is a common approach for spectral segmentation (<a href="https://doi.org/10.3390/plants13091262">Kior et al. 2024</a>). The RGB index thresholds implemented include those found to perform well in distinguishing green vegetation in previous research (<a href="https://doi.org/10.1016/j.compag.2008.03.009">Meyer &amp; Neto 2008</a>; <a href="https://doi.org/10.3390/rs2102369">Motohka et al. 2010</a>; <a href="https://doi.org/10.3390/plants14111677">Wang et al. 2025</a>; <a href="https://doi.org/10.1016/j.compag.2019.105201">Riehle et al. 2020</a>; <a href="https://doi.org/10.3389/fpls.2019.00370">Johansen et al. 2019</a>; <a href="https://doi.org/10.1080/01431161.2017.1402387">Goodbody et al. 2017</a>). By inverting these established vegetation thresholds, our approach isolates non-photosynthetic slash piles from surrounding green biomass.</p>
<p>To enhance segmentation accuracy, the CIELAB and HSV models are used because they offer advantages over the RGB color model which can be sensitive to external variables like lighting (<a href="https://doi.org/10.1016/S0031-3203(00)00149-7">Cheng et al. 2001</a>; <a href="https://doi.org/10.3390/plants13091262">Kior et al. 2024</a>). These models provide stability across different lighting conditions, sensors, and flight plans by isolating color from light intensity. The CIELAB (L*a*b*) model provides a perceptually uniform color space based on human vision, using L* for lightness (0-100), a* for green-red (towards red if a* &gt; 0, towards green if a* &lt; 0), and b* for blue-yellow (towards yellow if b* &gt; 0, towards blue if b* &lt; 0). Studies have used the a* component to perform vegetation segmentation and health evaluation (<a href="https://doi.org/10.1007/s11099-016-0214-x">Rigon et al. 2016</a>; <a href="https://doi.org/10.1016/j.compag.2019.105201">Riehle et al. 2020</a>) as well as in the discrimination of wood products (<a href="https://doi.org/10.3390/molecules17043639">Moya et al. 2012</a>; <a href="https://doi.org/10.1007/s00107-023-01953-4">Amaral Reis et al. 2023</a>). The HSV (Hue, Saturation and Value) model isolates the hue (i.e. color) component to provide a color representation that is invariant to saturation and brightness (i.e. the “value” component). In general, the hue values of green vegetation vary from 50 to 150 degrees using a value range of 0-360 degrees (<a href="https://doi.org/10.1016/j.inpa.2015.07.003">Yang et al. 2015</a>; <a href="https://doi.org/10.1088/1742-6596/2833/1/012012">Luo et al. 2024</a>).</p>
<p>We’ll integrate the spectral indices listed in the table below that rely only on RGB data and have threshold values identified in the literature to distinguish green vegetation from dead/senescent vegetation and background soil or rock. For the thresholds meant to identify green vegetation we’ll use the inverted threshold to retain candidate slash piles.</p>
<p>Here are the thresholds represented in the literature:</p>
<table>
<colgroup>
<col width="5%" />
<col width="11%" />
<col width="11%" />
<col width="8%" />
<col width="17%" />
<col width="45%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Index</strong></th>
<th><strong>Likely Crop</strong></th>
<th><strong>Likely Tree</strong></th>
<th><strong>Likely Shrub</strong></th>
<th><strong>Likely Wood / Diseased Trees</strong></th>
<th><strong>Source</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GRVI</td>
<td>x &gt; 0.0</td>
<td>x &gt; 0.0</td>
<td>x &gt; 0.0</td>
<td></td>
<td>Motohka et al. 2010; Goodbody et al. 2017; Johansen et al. 2019</td>
</tr>
<tr class="even">
<td>RGRI</td>
<td>x &lt; 0.63</td>
<td>x &lt; 0.70</td>
<td>x &lt; 0.52</td>
<td></td>
<td>Wang et al. 2025</td>
</tr>
<tr class="odd">
<td>VDVI</td>
<td>x &gt; 0.06</td>
<td>x &gt; 0.04</td>
<td>x &gt; 0.03</td>
<td></td>
<td>Wang et al. 2025</td>
</tr>
<tr class="even">
<td>ExGR</td>
<td>x &gt; 0.0</td>
<td>x &gt; 0.0</td>
<td>x &gt; 0.0</td>
<td></td>
<td>Meyer &amp; Neto 2008; Riehle et al. 2020</td>
</tr>
<tr class="odd">
<td>a*</td>
<td>x &lt; -5 – 0</td>
<td></td>
<td></td>
<td>x &gt; 2 – 10</td>
<td>Moya et al. 2012; Rigon et al. 2016; Riehle et al. 2020; Amaral Reis et al. 2023</td>
</tr>
<tr class="even">
<td>Hue</td>
<td>50 &lt; x &lt; 150</td>
<td></td>
<td></td>
<td>0 &lt; x &lt; 26</td>
<td>Yang et al. 2015; Luo et al. 2024</td>
</tr>
</tbody>
</table>
<p>For these formulas, <span class="math inline">\(R\)</span>, <span class="math inline">\(G\)</span>, and <span class="math inline">\(B\)</span> represent the raw pixel values for the Red, Green, and Blue bands, respectively. For indices that use normalized values, <span class="math inline">\(r\)</span>, <span class="math inline">\(g\)</span>, and <span class="math inline">\(b\)</span> are defined as:</p>
<p><span class="math inline">\(r = \frac{R}{R+G+B}\)</span>
<span class="math inline">\(g = \frac{G}{R+G+B}\)</span>
<span class="math inline">\(b = \frac{B}{R+G+B}\)</span></p>
<table>
<colgroup>
<col width="15%" />
<col width="5%" />
<col width="43%" />
<col width="21%" />
<col width="13%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Name</strong></th>
<th><strong>Acronym</strong></th>
<th><strong>Description</strong></th>
<th><strong>Recommended Formula / Method</strong></th>
<th><strong>Potential Range</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Green-Red Vegetation Index</td>
<td>GRVI</td>
<td>Detects vegetation greenness using a normalized difference</td>
<td><span class="math inline">\(\frac{G - R}{G + R}\)</span></td>
<td>-1 to 1</td>
</tr>
<tr class="even">
<td>Red-Green Ratio Index</td>
<td>RGRI</td>
<td>Compares red to green intensity to estimate plant pigment changes</td>
<td><span class="math inline">\(\frac{R}{G}\)</span></td>
<td>0 to <span class="math inline">\(\infty\)</span></td>
</tr>
<tr class="odd">
<td>Visible-band Difference Index</td>
<td>VDVI</td>
<td>Index for extracting vegetation from complex backgrounds</td>
<td><span class="math inline">\(\frac{2G - R - B}{2G + R + B}\)</span></td>
<td>-1 to 1</td>
</tr>
<tr class="even">
<td>Excess Green-minus-Red</td>
<td>ExGR</td>
<td>Linear index for discriminating plants from soil/background</td>
<td><span class="math inline">\(3g - 2.4r - b\)</span></td>
<td>-3.4 to 3</td>
</tr>
<tr class="odd">
<td>CIELab a* (Green-Red)</td>
<td>a*</td>
<td>Perceptually uniform green-to-red axis</td>
<td><code>grDevices::convertColor(..., to="Lab")</code></td>
<td>-128 to 127</td>
</tr>
<tr class="even">
<td>HSV Hue</td>
<td>Hue</td>
<td>The dominant “color type” angle on the color wheel that ensures consistent values regardless of illumination</td>
<td><code>terra::colorize(..., to="hsv")</code></td>
<td>0 to 1 (or 0–360 degrees)</td>
</tr>
</tbody>
</table>
<p>Rather than relying on a single spectral metric, our method employs a “voting” system where all six indices contribute to candidate evaluation. Integrating six distinct index-threshold pairs determined independently by different researchers across diverse sensors and vegetation types is more stable than relying on any single index or study a an ensemble approach minimizes the potential error or limitations inherent in a single identified threshold. This ensemble approach provides a framework that allows users to weight the spectral data by requiring anywhere from 0 to 6 thresholds to be met for a candidate pile to be retained. Setting the requirement to zero relies exclusively on the structural detection, while higher values place progressively more weight on spectral confirmation.</p>
<p>A known limitation of our data fusion approach is the spectral similarity between dead wood and geologic features like rocks or boulders. Many common rock-forming minerals are “spectrally featureless” in the visible range with reflectance values remaining relatively constant across the range of visible wavelengths (<a href="http://dx.doi.org/10.5589/m10-072">Harris et al. 2010</a>). These geologic features are difficult to distinguish from dead wood which can appear spectrally similar to background soil and rocks (<a href="https://doi.org/10.3390/f11080801">Zielewska-Büttner et al. 2020</a>). Because our indices are specifically tuned to distinguish vegetation, our framework may struggle in rocky environments where boulders or rock outcroppings are both structurally and spectrally similar to slash piles.</p>
<p>It is important to highlight that the spectral data in our data fusion approach functions strictly as a final filter or quality check. It does not generate new piles or alter the shape and location of structurally detected candidates. This leads to a distinct performance trade-off when integrating spectral data. While applying these spectral filters can improve precision by correctly removing false positives (e.g. shrubs, lower branches of trees), it also carries the risk of lowering recall if a true slash pile possesses an unexpected spectral signature.</p>
<div id="spectral-index-functions" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Spectral Index Functions<a href="data_fusion.html#spectral-index-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Although there are dedicated R packages to calculate various spectral indicies (e.g. <code>RStoolbox</code> [<a href="https://doi.org/10.1111/2041-210X.14451">Muller et al. 2025</a>]), we’ll make our own to ensure data quality checks and to limit the spectral indices to those highlighted above.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="data_fusion.html#cb206-1" tabindex="-1"></a><span class="co"># check raster bands and extract rgb layers</span></span>
<span id="cb206-2"><a href="data_fusion.html#cb206-2" tabindex="-1"></a>check_raster_bands <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-3"><a href="data_fusion.html#cb206-3" tabindex="-1"></a>  <span class="co"># convert to SpatRaster if input is from &#39;raster&#39; package</span></span>
<span id="cb206-4"><a href="data_fusion.html#cb206-4" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb206-5"><a href="data_fusion.html#cb206-5" tabindex="-1"></a>    <span class="fu">inherits</span>(rast, <span class="st">&quot;RasterStack&quot;</span>) </span>
<span id="cb206-6"><a href="data_fusion.html#cb206-6" tabindex="-1"></a>    <span class="sc">||</span> <span class="fu">inherits</span>(rast, <span class="st">&quot;RasterBrick&quot;</span>)</span>
<span id="cb206-7"><a href="data_fusion.html#cb206-7" tabindex="-1"></a>  ){</span>
<span id="cb206-8"><a href="data_fusion.html#cb206-8" tabindex="-1"></a>    rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(rast)</span>
<span id="cb206-9"><a href="data_fusion.html#cb206-9" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb206-10"><a href="data_fusion.html#cb206-10" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;rast&#39; must be a SpatRaster from the `terra` package&quot;</span>)</span>
<span id="cb206-11"><a href="data_fusion.html#cb206-11" tabindex="-1"></a>  }</span>
<span id="cb206-12"><a href="data_fusion.html#cb206-12" tabindex="-1"></a></span>
<span id="cb206-13"><a href="data_fusion.html#cb206-13" tabindex="-1"></a>  <span class="co"># check if band indices are valid</span></span>
<span id="cb206-14"><a href="data_fusion.html#cb206-14" tabindex="-1"></a>  num_bands <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(rast)</span>
<span id="cb206-15"><a href="data_fusion.html#cb206-15" tabindex="-1"></a>  <span class="co"># let 999999 be a cheat code</span></span>
<span id="cb206-16"><a href="data_fusion.html#cb206-16" tabindex="-1"></a>  cheat_code <span class="ot">&lt;-</span> <span class="dv">999999</span></span>
<span id="cb206-17"><a href="data_fusion.html#cb206-17" tabindex="-1"></a>  </span>
<span id="cb206-18"><a href="data_fusion.html#cb206-18" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb206-19"><a href="data_fusion.html#cb206-19" tabindex="-1"></a>    ( red_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> red_band_idx <span class="sc">&gt;</span> num_bands )</span>
<span id="cb206-20"><a href="data_fusion.html#cb206-20" tabindex="-1"></a>    <span class="sc">||</span> ( green_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> green_band_idx <span class="sc">&gt;</span> num_bands )</span>
<span id="cb206-21"><a href="data_fusion.html#cb206-21" tabindex="-1"></a>    <span class="sc">||</span> ( blue_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span>  blue_band_idx <span class="sc">&gt;</span> num_bands )</span>
<span id="cb206-22"><a href="data_fusion.html#cb206-22" tabindex="-1"></a>    <span class="sc">||</span> ( red_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> red_band_idx <span class="sc">&lt;</span> <span class="dv">1</span> )</span>
<span id="cb206-23"><a href="data_fusion.html#cb206-23" tabindex="-1"></a>    <span class="sc">||</span> ( green_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> green_band_idx <span class="sc">&lt;</span> <span class="dv">1</span> )</span>
<span id="cb206-24"><a href="data_fusion.html#cb206-24" tabindex="-1"></a>    <span class="sc">||</span> ( blue_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span>  blue_band_idx <span class="sc">&lt;</span> <span class="dv">1</span> )</span>
<span id="cb206-25"><a href="data_fusion.html#cb206-25" tabindex="-1"></a>    <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">c</span>(red_band_idx,green_band_idx,blue_band_idx)))<span class="sc">!=</span><span class="dv">3</span></span>
<span id="cb206-26"><a href="data_fusion.html#cb206-26" tabindex="-1"></a>  ){</span>
<span id="cb206-27"><a href="data_fusion.html#cb206-27" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid band index provided. Band indices must correspond to existing, unique layers in the raster object.&quot;</span>)</span>
<span id="cb206-28"><a href="data_fusion.html#cb206-28" tabindex="-1"></a>  }</span>
<span id="cb206-29"><a href="data_fusion.html#cb206-29" tabindex="-1"></a></span>
<span id="cb206-30"><a href="data_fusion.html#cb206-30" tabindex="-1"></a>  <span class="co"># extract bands</span></span>
<span id="cb206-31"><a href="data_fusion.html#cb206-31" tabindex="-1"></a>  <span class="cf">if</span>(red_band_idx<span class="sc">!=</span>cheat_code){ R <span class="ot">&lt;-</span> rast[[red_band_idx]] }<span class="cf">else</span>{ R <span class="ot">&lt;-</span> rast[[<span class="dv">1</span>]] }</span>
<span id="cb206-32"><a href="data_fusion.html#cb206-32" tabindex="-1"></a>  <span class="cf">if</span>(green_band_idx<span class="sc">!=</span>cheat_code){ G <span class="ot">&lt;-</span> rast[[green_band_idx]] }<span class="cf">else</span>{ G <span class="ot">&lt;-</span> rast[[<span class="dv">1</span>]] }</span>
<span id="cb206-33"><a href="data_fusion.html#cb206-33" tabindex="-1"></a>  <span class="cf">if</span>(blue_band_idx<span class="sc">!=</span>cheat_code){ B <span class="ot">&lt;-</span> rast[[blue_band_idx]] }<span class="cf">else</span>{ B <span class="ot">&lt;-</span> rast[[<span class="dv">1</span>]] }</span>
<span id="cb206-34"><a href="data_fusion.html#cb206-34" tabindex="-1"></a></span>
<span id="cb206-35"><a href="data_fusion.html#cb206-35" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">R =</span> R, <span class="at">G =</span> G, <span class="at">B =</span> B))</span>
<span id="cb206-36"><a href="data_fusion.html#cb206-36" tabindex="-1"></a>}</span>
<span id="cb206-37"><a href="data_fusion.html#cb206-37" tabindex="-1"></a><span class="co"># check_raster_bands(ortho_rast, red_band_idx=1, green_band_idx=3, blue_band_idx = 999999)</span></span>
<span id="cb206-38"><a href="data_fusion.html#cb206-38" tabindex="-1"></a></span>
<span id="cb206-39"><a href="data_fusion.html#cb206-39" tabindex="-1"></a><span class="co"># convert RGB to HSV color space</span></span>
<span id="cb206-40"><a href="data_fusion.html#cb206-40" tabindex="-1"></a>spectral_rgb_to_hsv <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-41"><a href="data_fusion.html#cb206-41" tabindex="-1"></a>  <span class="co"># check</span></span>
<span id="cb206-42"><a href="data_fusion.html#cb206-42" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-43"><a href="data_fusion.html#cb206-43" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-44"><a href="data_fusion.html#cb206-44" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-45"><a href="data_fusion.html#cb206-45" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-46"><a href="data_fusion.html#cb206-46" tabindex="-1"></a>  </span>
<span id="cb206-47"><a href="data_fusion.html#cb206-47" tabindex="-1"></a>  <span class="co"># convert to RGB</span></span>
<span id="cb206-48"><a href="data_fusion.html#cb206-48" tabindex="-1"></a>  rgb_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">RGB</span>(<span class="at">x =</span> <span class="fu">c</span>(R,G,B), <span class="at">value =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb206-49"><a href="data_fusion.html#cb206-49" tabindex="-1"></a>  </span>
<span id="cb206-50"><a href="data_fusion.html#cb206-50" tabindex="-1"></a>  <span class="co"># ?terra::colorize</span></span>
<span id="cb206-51"><a href="data_fusion.html#cb206-51" tabindex="-1"></a>  <span class="co"># convert to HSV (returns layers: h, s, v)</span></span>
<span id="cb206-52"><a href="data_fusion.html#cb206-52" tabindex="-1"></a>  hsv_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">colorize</span>(rgb_rast, <span class="at">to =</span> <span class="st">&quot;hsv&quot;</span>)</span>
<span id="cb206-53"><a href="data_fusion.html#cb206-53" tabindex="-1"></a></span>
<span id="cb206-54"><a href="data_fusion.html#cb206-54" tabindex="-1"></a>  <span class="co"># names</span></span>
<span id="cb206-55"><a href="data_fusion.html#cb206-55" tabindex="-1"></a>  <span class="fu">names</span>(hsv_rast) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;hue&quot;</span>, <span class="st">&quot;saturation&quot;</span>, <span class="st">&quot;brightness&quot;</span>)</span>
<span id="cb206-56"><a href="data_fusion.html#cb206-56" tabindex="-1"></a>  <span class="co"># scale only the hue layer to 360</span></span>
<span id="cb206-57"><a href="data_fusion.html#cb206-57" tabindex="-1"></a>  <span class="co"># hsv_rast$hue &lt;- hsv_rast$hue*360</span></span>
<span id="cb206-58"><a href="data_fusion.html#cb206-58" tabindex="-1"></a></span>
<span id="cb206-59"><a href="data_fusion.html#cb206-59" tabindex="-1"></a>  <span class="fu">return</span>(hsv_rast)</span>
<span id="cb206-60"><a href="data_fusion.html#cb206-60" tabindex="-1"></a>}</span>
<span id="cb206-61"><a href="data_fusion.html#cb206-61" tabindex="-1"></a></span>
<span id="cb206-62"><a href="data_fusion.html#cb206-62" tabindex="-1"></a><span class="co"># convert RGB to CIELab color space</span></span>
<span id="cb206-63"><a href="data_fusion.html#cb206-63" tabindex="-1"></a><span class="co"># ?grDevices::convertColor</span></span>
<span id="cb206-64"><a href="data_fusion.html#cb206-64" tabindex="-1"></a>spectral_rgb_to_lab <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx, <span class="at">max_dn =</span> <span class="dv">255</span>) {</span>
<span id="cb206-65"><a href="data_fusion.html#cb206-65" tabindex="-1"></a>  <span class="co"># check</span></span>
<span id="cb206-66"><a href="data_fusion.html#cb206-66" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-67"><a href="data_fusion.html#cb206-67" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-68"><a href="data_fusion.html#cb206-68" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-69"><a href="data_fusion.html#cb206-69" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-70"><a href="data_fusion.html#cb206-70" tabindex="-1"></a>  rgb_rast <span class="ot">&lt;-</span> <span class="fu">c</span>(R,G,B)</span>
<span id="cb206-71"><a href="data_fusion.html#cb206-71" tabindex="-1"></a>  </span>
<span id="cb206-72"><a href="data_fusion.html#cb206-72" tabindex="-1"></a>  <span class="co"># values as a matrix (vectorized) normalized to max 255 val</span></span>
<span id="cb206-73"><a href="data_fusion.html#cb206-73" tabindex="-1"></a>  vals <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">values</span>(rgb_rast) <span class="sc">/</span> max_dn</span>
<span id="cb206-74"><a href="data_fusion.html#cb206-74" tabindex="-1"></a>  </span>
<span id="cb206-75"><a href="data_fusion.html#cb206-75" tabindex="-1"></a>  <span class="co"># conversion on the matrix</span></span>
<span id="cb206-76"><a href="data_fusion.html#cb206-76" tabindex="-1"></a>  lab_vals <span class="ot">&lt;-</span> grDevices<span class="sc">::</span><span class="fu">convertColor</span>(vals, <span class="at">from =</span> <span class="st">&quot;sRGB&quot;</span>, <span class="at">to =</span> <span class="st">&quot;Lab&quot;</span>)</span>
<span id="cb206-77"><a href="data_fusion.html#cb206-77" tabindex="-1"></a></span>
<span id="cb206-78"><a href="data_fusion.html#cb206-78" tabindex="-1"></a>  <span class="co"># new SpatRaster using original str and replace values</span></span>
<span id="cb206-79"><a href="data_fusion.html#cb206-79" tabindex="-1"></a>  lab_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(rgb_rast, <span class="at">nlyrs =</span> <span class="dv">3</span>)</span>
<span id="cb206-80"><a href="data_fusion.html#cb206-80" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">values</span>(lab_rast) <span class="ot">&lt;-</span> lab_vals</span>
<span id="cb206-81"><a href="data_fusion.html#cb206-81" tabindex="-1"></a></span>
<span id="cb206-82"><a href="data_fusion.html#cb206-82" tabindex="-1"></a>  <span class="fu">names</span>(lab_rast) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;L&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>)</span>
<span id="cb206-83"><a href="data_fusion.html#cb206-83" tabindex="-1"></a></span>
<span id="cb206-84"><a href="data_fusion.html#cb206-84" tabindex="-1"></a>  <span class="fu">return</span>(lab_rast)</span>
<span id="cb206-85"><a href="data_fusion.html#cb206-85" tabindex="-1"></a>}</span>
<span id="cb206-86"><a href="data_fusion.html#cb206-86" tabindex="-1"></a></span>
<span id="cb206-87"><a href="data_fusion.html#cb206-87" tabindex="-1"></a><span class="co"># calculate green red vegetation index (GRVI)</span></span>
<span id="cb206-88"><a href="data_fusion.html#cb206-88" tabindex="-1"></a><span class="co"># (G - R) / (G + R)</span></span>
<span id="cb206-89"><a href="data_fusion.html#cb206-89" tabindex="-1"></a>spectral_index_grvi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx) {</span>
<span id="cb206-90"><a href="data_fusion.html#cb206-90" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, <span class="at">blue_band_idx =</span> <span class="dv">999999</span>) <span class="co"># blue_band_idx is dummy here</span></span>
<span id="cb206-91"><a href="data_fusion.html#cb206-91" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-92"><a href="data_fusion.html#cb206-92" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-93"><a href="data_fusion.html#cb206-93" tabindex="-1"></a></span>
<span id="cb206-94"><a href="data_fusion.html#cb206-94" tabindex="-1"></a>  grvi <span class="ot">&lt;-</span> (G <span class="sc">-</span> R) <span class="sc">/</span> (G <span class="sc">+</span> R)</span>
<span id="cb206-95"><a href="data_fusion.html#cb206-95" tabindex="-1"></a>  <span class="fu">names</span>(grvi) <span class="ot">&lt;-</span> <span class="st">&quot;grvi&quot;</span></span>
<span id="cb206-96"><a href="data_fusion.html#cb206-96" tabindex="-1"></a>  <span class="fu">return</span>(grvi)</span>
<span id="cb206-97"><a href="data_fusion.html#cb206-97" tabindex="-1"></a>}</span>
<span id="cb206-98"><a href="data_fusion.html#cb206-98" tabindex="-1"></a><span class="co"># spectral_index_grvi(ortho_rast,red_band_idx = 1, green_band_idx = 2) %&gt;% terra::plot()</span></span>
<span id="cb206-99"><a href="data_fusion.html#cb206-99" tabindex="-1"></a></span>
<span id="cb206-100"><a href="data_fusion.html#cb206-100" tabindex="-1"></a><span class="co"># red green ratio index (RGRI)</span></span>
<span id="cb206-101"><a href="data_fusion.html#cb206-101" tabindex="-1"></a><span class="co"># R/G</span></span>
<span id="cb206-102"><a href="data_fusion.html#cb206-102" tabindex="-1"></a>spectral_index_rgri <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx) {</span>
<span id="cb206-103"><a href="data_fusion.html#cb206-103" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, <span class="at">blue_band_idx =</span> <span class="dv">999999</span>) <span class="co"># blue_band_idx is dummy here</span></span>
<span id="cb206-104"><a href="data_fusion.html#cb206-104" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-105"><a href="data_fusion.html#cb206-105" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-106"><a href="data_fusion.html#cb206-106" tabindex="-1"></a></span>
<span id="cb206-107"><a href="data_fusion.html#cb206-107" tabindex="-1"></a>  rgri <span class="ot">&lt;-</span> R<span class="sc">/</span>G</span>
<span id="cb206-108"><a href="data_fusion.html#cb206-108" tabindex="-1"></a>  <span class="fu">names</span>(rgri) <span class="ot">&lt;-</span> <span class="st">&quot;rgri&quot;</span></span>
<span id="cb206-109"><a href="data_fusion.html#cb206-109" tabindex="-1"></a>  <span class="fu">return</span>(rgri)</span>
<span id="cb206-110"><a href="data_fusion.html#cb206-110" tabindex="-1"></a>}</span>
<span id="cb206-111"><a href="data_fusion.html#cb206-111" tabindex="-1"></a><span class="co"># spectral_index_grvi(ortho_rast,red_band_idx = 1, green_band_idx = 2) %&gt;% terra::plot()</span></span>
<span id="cb206-112"><a href="data_fusion.html#cb206-112" tabindex="-1"></a></span>
<span id="cb206-113"><a href="data_fusion.html#cb206-113" tabindex="-1"></a><span class="co"># calculate visible band-difference vegetation index (VDVI)</span></span>
<span id="cb206-114"><a href="data_fusion.html#cb206-114" tabindex="-1"></a><span class="co"># (2G - R - B) / (2G + R + B)</span></span>
<span id="cb206-115"><a href="data_fusion.html#cb206-115" tabindex="-1"></a>spectral_index_vdvi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-116"><a href="data_fusion.html#cb206-116" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-117"><a href="data_fusion.html#cb206-117" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-118"><a href="data_fusion.html#cb206-118" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-119"><a href="data_fusion.html#cb206-119" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-120"><a href="data_fusion.html#cb206-120" tabindex="-1"></a></span>
<span id="cb206-121"><a href="data_fusion.html#cb206-121" tabindex="-1"></a>  vdvi <span class="ot">&lt;-</span> (<span class="dv">2</span> <span class="sc">*</span> G <span class="sc">-</span> R <span class="sc">-</span> B) <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> G <span class="sc">+</span> R <span class="sc">+</span> B)</span>
<span id="cb206-122"><a href="data_fusion.html#cb206-122" tabindex="-1"></a>  <span class="fu">names</span>(vdvi) <span class="ot">&lt;-</span> <span class="st">&quot;vdvi&quot;</span></span>
<span id="cb206-123"><a href="data_fusion.html#cb206-123" tabindex="-1"></a>  <span class="fu">return</span>(vdvi)</span>
<span id="cb206-124"><a href="data_fusion.html#cb206-124" tabindex="-1"></a>}</span>
<span id="cb206-125"><a href="data_fusion.html#cb206-125" tabindex="-1"></a><span class="co"># spectral_index_vdvi(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb206-126"><a href="data_fusion.html#cb206-126" tabindex="-1"></a></span>
<span id="cb206-127"><a href="data_fusion.html#cb206-127" tabindex="-1"></a><span class="co"># calculate red green blue vegetation index (RGBVI)</span></span>
<span id="cb206-128"><a href="data_fusion.html#cb206-128" tabindex="-1"></a><span class="co"># (G^2 - (B * R)) / (G^2 + (B * R))</span></span>
<span id="cb206-129"><a href="data_fusion.html#cb206-129" tabindex="-1"></a>spectral_index_rgbvi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-130"><a href="data_fusion.html#cb206-130" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-131"><a href="data_fusion.html#cb206-131" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-132"><a href="data_fusion.html#cb206-132" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-133"><a href="data_fusion.html#cb206-133" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-134"><a href="data_fusion.html#cb206-134" tabindex="-1"></a></span>
<span id="cb206-135"><a href="data_fusion.html#cb206-135" tabindex="-1"></a>  rgbvi <span class="ot">&lt;-</span> (G<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> (B <span class="sc">*</span> R)) <span class="sc">/</span> (G<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (B <span class="sc">*</span> R))</span>
<span id="cb206-136"><a href="data_fusion.html#cb206-136" tabindex="-1"></a>  <span class="fu">names</span>(rgbvi) <span class="ot">&lt;-</span> <span class="st">&quot;rgbvi&quot;</span></span>
<span id="cb206-137"><a href="data_fusion.html#cb206-137" tabindex="-1"></a>  <span class="fu">return</span>(rgbvi)</span>
<span id="cb206-138"><a href="data_fusion.html#cb206-138" tabindex="-1"></a>}</span>
<span id="cb206-139"><a href="data_fusion.html#cb206-139" tabindex="-1"></a><span class="co"># spectral_index_rgbvi(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb206-140"><a href="data_fusion.html#cb206-140" tabindex="-1"></a></span>
<span id="cb206-141"><a href="data_fusion.html#cb206-141" tabindex="-1"></a><span class="co"># calculate excess green (ExG)</span></span>
<span id="cb206-142"><a href="data_fusion.html#cb206-142" tabindex="-1"></a><span class="co"># (2G - R - B) / (R + G + B) (using normalized RGB values)</span></span>
<span id="cb206-143"><a href="data_fusion.html#cb206-143" tabindex="-1"></a><span class="co"># 2G - R - B (using raw values, then normalized by sum of R+G+B)</span></span>
<span id="cb206-144"><a href="data_fusion.html#cb206-144" tabindex="-1"></a>spectral_index_exg <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-145"><a href="data_fusion.html#cb206-145" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-146"><a href="data_fusion.html#cb206-146" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-147"><a href="data_fusion.html#cb206-147" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-148"><a href="data_fusion.html#cb206-148" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-149"><a href="data_fusion.html#cb206-149" tabindex="-1"></a></span>
<span id="cb206-150"><a href="data_fusion.html#cb206-150" tabindex="-1"></a>  <span class="co"># Calculate normalized RGB values</span></span>
<span id="cb206-151"><a href="data_fusion.html#cb206-151" tabindex="-1"></a>  sum_rgb <span class="ot">&lt;-</span> R <span class="sc">+</span> G <span class="sc">+</span> B</span>
<span id="cb206-152"><a href="data_fusion.html#cb206-152" tabindex="-1"></a>  r_norm <span class="ot">&lt;-</span> R <span class="sc">/</span> sum_rgb</span>
<span id="cb206-153"><a href="data_fusion.html#cb206-153" tabindex="-1"></a>  g_norm <span class="ot">&lt;-</span> G <span class="sc">/</span> sum_rgb</span>
<span id="cb206-154"><a href="data_fusion.html#cb206-154" tabindex="-1"></a>  b_norm <span class="ot">&lt;-</span> B <span class="sc">/</span> sum_rgb</span>
<span id="cb206-155"><a href="data_fusion.html#cb206-155" tabindex="-1"></a></span>
<span id="cb206-156"><a href="data_fusion.html#cb206-156" tabindex="-1"></a>  exg <span class="ot">&lt;-</span> (<span class="dv">2</span> <span class="sc">*</span> g_norm <span class="sc">-</span> r_norm <span class="sc">-</span> b_norm)</span>
<span id="cb206-157"><a href="data_fusion.html#cb206-157" tabindex="-1"></a>  <span class="fu">names</span>(exg) <span class="ot">&lt;-</span> <span class="st">&quot;exg&quot;</span></span>
<span id="cb206-158"><a href="data_fusion.html#cb206-158" tabindex="-1"></a>  <span class="fu">return</span>(exg)</span>
<span id="cb206-159"><a href="data_fusion.html#cb206-159" tabindex="-1"></a>}</span>
<span id="cb206-160"><a href="data_fusion.html#cb206-160" tabindex="-1"></a><span class="co"># spectral_index_exg(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb206-161"><a href="data_fusion.html#cb206-161" tabindex="-1"></a></span>
<span id="cb206-162"><a href="data_fusion.html#cb206-162" tabindex="-1"></a><span class="co"># calculate brightness index (BI)</span></span>
<span id="cb206-163"><a href="data_fusion.html#cb206-163" tabindex="-1"></a><span class="co"># sqrt((R^2 + G^2 + B^2) / 3)</span></span>
<span id="cb206-164"><a href="data_fusion.html#cb206-164" tabindex="-1"></a>spectral_index_bi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-165"><a href="data_fusion.html#cb206-165" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-166"><a href="data_fusion.html#cb206-166" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-167"><a href="data_fusion.html#cb206-167" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-168"><a href="data_fusion.html#cb206-168" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-169"><a href="data_fusion.html#cb206-169" tabindex="-1"></a></span>
<span id="cb206-170"><a href="data_fusion.html#cb206-170" tabindex="-1"></a>  bi <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((R<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> G<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> B<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">3</span>)</span>
<span id="cb206-171"><a href="data_fusion.html#cb206-171" tabindex="-1"></a>  <span class="co"># normalize to 0-1 range</span></span>
<span id="cb206-172"><a href="data_fusion.html#cb206-172" tabindex="-1"></a>  max_brightness <span class="ot">=</span> <span class="fu">max</span>(</span>
<span id="cb206-173"><a href="data_fusion.html#cb206-173" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">minmax</span>(R)[<span class="dv">2</span>]</span>
<span id="cb206-174"><a href="data_fusion.html#cb206-174" tabindex="-1"></a>    , terra<span class="sc">::</span><span class="fu">minmax</span>(G)[<span class="dv">2</span>]</span>
<span id="cb206-175"><a href="data_fusion.html#cb206-175" tabindex="-1"></a>    , terra<span class="sc">::</span><span class="fu">minmax</span>(B)[<span class="dv">2</span>]</span>
<span id="cb206-176"><a href="data_fusion.html#cb206-176" tabindex="-1"></a>    , <span class="at">na.rm =</span> T</span>
<span id="cb206-177"><a href="data_fusion.html#cb206-177" tabindex="-1"></a>  )</span>
<span id="cb206-178"><a href="data_fusion.html#cb206-178" tabindex="-1"></a>  </span>
<span id="cb206-179"><a href="data_fusion.html#cb206-179" tabindex="-1"></a>  bi <span class="ot">&lt;-</span> bi<span class="sc">/</span>max_brightness</span>
<span id="cb206-180"><a href="data_fusion.html#cb206-180" tabindex="-1"></a>  <span class="fu">names</span>(bi) <span class="ot">&lt;-</span> <span class="st">&quot;bi&quot;</span></span>
<span id="cb206-181"><a href="data_fusion.html#cb206-181" tabindex="-1"></a>  <span class="fu">return</span>(bi)</span>
<span id="cb206-182"><a href="data_fusion.html#cb206-182" tabindex="-1"></a>}</span>
<span id="cb206-183"><a href="data_fusion.html#cb206-183" tabindex="-1"></a><span class="co"># spectral_index_bi(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb206-184"><a href="data_fusion.html#cb206-184" tabindex="-1"></a></span>
<span id="cb206-185"><a href="data_fusion.html#cb206-185" tabindex="-1"></a><span class="co"># calculate excessive red (ExR)</span></span>
<span id="cb206-186"><a href="data_fusion.html#cb206-186" tabindex="-1"></a><span class="co"># 1.4r - g, where r and g are normalized RGB values.</span></span>
<span id="cb206-187"><a href="data_fusion.html#cb206-187" tabindex="-1"></a>spectral_index_exr <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx){</span>
<span id="cb206-188"><a href="data_fusion.html#cb206-188" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-189"><a href="data_fusion.html#cb206-189" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-190"><a href="data_fusion.html#cb206-190" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-191"><a href="data_fusion.html#cb206-191" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-192"><a href="data_fusion.html#cb206-192" tabindex="-1"></a></span>
<span id="cb206-193"><a href="data_fusion.html#cb206-193" tabindex="-1"></a>  <span class="co"># Calculate normalized RGB values</span></span>
<span id="cb206-194"><a href="data_fusion.html#cb206-194" tabindex="-1"></a>  sum_rgb <span class="ot">&lt;-</span> R <span class="sc">+</span> G <span class="sc">+</span> B</span>
<span id="cb206-195"><a href="data_fusion.html#cb206-195" tabindex="-1"></a>  r_norm <span class="ot">&lt;-</span> R <span class="sc">/</span> sum_rgb</span>
<span id="cb206-196"><a href="data_fusion.html#cb206-196" tabindex="-1"></a>  g_norm <span class="ot">&lt;-</span> G <span class="sc">/</span> sum_rgb</span>
<span id="cb206-197"><a href="data_fusion.html#cb206-197" tabindex="-1"></a></span>
<span id="cb206-198"><a href="data_fusion.html#cb206-198" tabindex="-1"></a>  exr <span class="ot">&lt;-</span> (<span class="fl">1.4</span> <span class="sc">*</span> r_norm <span class="sc">-</span> g_norm)</span>
<span id="cb206-199"><a href="data_fusion.html#cb206-199" tabindex="-1"></a>  <span class="fu">names</span>(exr) <span class="ot">&lt;-</span> <span class="st">&quot;exr&quot;</span></span>
<span id="cb206-200"><a href="data_fusion.html#cb206-200" tabindex="-1"></a>  <span class="fu">return</span>(exr)</span>
<span id="cb206-201"><a href="data_fusion.html#cb206-201" tabindex="-1"></a>}</span>
<span id="cb206-202"><a href="data_fusion.html#cb206-202" tabindex="-1"></a></span>
<span id="cb206-203"><a href="data_fusion.html#cb206-203" tabindex="-1"></a><span class="co">#&#39; calculate excess green-excess red (ExGR)</span></span>
<span id="cb206-204"><a href="data_fusion.html#cb206-204" tabindex="-1"></a><span class="co">#&#39; 3g - 2.4r - b, where r, g, b are normalized RGB values.</span></span>
<span id="cb206-205"><a href="data_fusion.html#cb206-205" tabindex="-1"></a><span class="co">#&#39; equivalent to ExG - ExR.</span></span>
<span id="cb206-206"><a href="data_fusion.html#cb206-206" tabindex="-1"></a>spectral_index_exgr <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-207"><a href="data_fusion.html#cb206-207" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-208"><a href="data_fusion.html#cb206-208" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-209"><a href="data_fusion.html#cb206-209" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-210"><a href="data_fusion.html#cb206-210" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-211"><a href="data_fusion.html#cb206-211" tabindex="-1"></a></span>
<span id="cb206-212"><a href="data_fusion.html#cb206-212" tabindex="-1"></a>  <span class="co"># Calculate normalized RGB values</span></span>
<span id="cb206-213"><a href="data_fusion.html#cb206-213" tabindex="-1"></a>  sum_rgb <span class="ot">&lt;-</span> R <span class="sc">+</span> G <span class="sc">+</span> B</span>
<span id="cb206-214"><a href="data_fusion.html#cb206-214" tabindex="-1"></a>  r_norm <span class="ot">&lt;-</span> R <span class="sc">/</span> sum_rgb</span>
<span id="cb206-215"><a href="data_fusion.html#cb206-215" tabindex="-1"></a>  g_norm <span class="ot">&lt;-</span> G <span class="sc">/</span> sum_rgb</span>
<span id="cb206-216"><a href="data_fusion.html#cb206-216" tabindex="-1"></a>  b_norm <span class="ot">&lt;-</span> B <span class="sc">/</span> sum_rgb</span>
<span id="cb206-217"><a href="data_fusion.html#cb206-217" tabindex="-1"></a></span>
<span id="cb206-218"><a href="data_fusion.html#cb206-218" tabindex="-1"></a>  exgr <span class="ot">&lt;-</span> (<span class="dv">3</span> <span class="sc">*</span> g_norm <span class="sc">-</span> <span class="fl">2.4</span> <span class="sc">*</span> r_norm <span class="sc">-</span> b_norm)</span>
<span id="cb206-219"><a href="data_fusion.html#cb206-219" tabindex="-1"></a>  <span class="fu">names</span>(exgr) <span class="ot">&lt;-</span> <span class="st">&quot;exgr&quot;</span></span>
<span id="cb206-220"><a href="data_fusion.html#cb206-220" tabindex="-1"></a>  <span class="fu">return</span>(exgr)</span>
<span id="cb206-221"><a href="data_fusion.html#cb206-221" tabindex="-1"></a>}</span>
<span id="cb206-222"><a href="data_fusion.html#cb206-222" tabindex="-1"></a></span>
<span id="cb206-223"><a href="data_fusion.html#cb206-223" tabindex="-1"></a><span class="co"># calculate saturation (SAT)</span></span>
<span id="cb206-224"><a href="data_fusion.html#cb206-224" tabindex="-1"></a><span class="co"># (max(R,G,B) - min(R,G,B)) / max(R,G,B)</span></span>
<span id="cb206-225"><a href="data_fusion.html#cb206-225" tabindex="-1"></a>spectral_index_saturation <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-226"><a href="data_fusion.html#cb206-226" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-227"><a href="data_fusion.html#cb206-227" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb206-228"><a href="data_fusion.html#cb206-228" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb206-229"><a href="data_fusion.html#cb206-229" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb206-230"><a href="data_fusion.html#cb206-230" tabindex="-1"></a></span>
<span id="cb206-231"><a href="data_fusion.html#cb206-231" tabindex="-1"></a>  max_rgb <span class="ot">&lt;-</span> <span class="fu">max</span>(R, G, B, <span class="at">na.rm =</span> T)</span>
<span id="cb206-232"><a href="data_fusion.html#cb206-232" tabindex="-1"></a>  min_rgb <span class="ot">&lt;-</span> <span class="fu">min</span>(R, G, B, <span class="at">na.rm =</span> T)</span>
<span id="cb206-233"><a href="data_fusion.html#cb206-233" tabindex="-1"></a>  sat <span class="ot">&lt;-</span> (max_rgb <span class="sc">-</span> min_rgb) <span class="sc">/</span> max_rgb</span>
<span id="cb206-234"><a href="data_fusion.html#cb206-234" tabindex="-1"></a>  <span class="fu">names</span>(sat) <span class="ot">&lt;-</span> <span class="st">&quot;sat&quot;</span></span>
<span id="cb206-235"><a href="data_fusion.html#cb206-235" tabindex="-1"></a>  <span class="fu">return</span>(sat)</span>
<span id="cb206-236"><a href="data_fusion.html#cb206-236" tabindex="-1"></a>}</span>
<span id="cb206-237"><a href="data_fusion.html#cb206-237" tabindex="-1"></a><span class="co"># spectral_index_saturation(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb206-238"><a href="data_fusion.html#cb206-238" tabindex="-1"></a></span>
<span id="cb206-239"><a href="data_fusion.html#cb206-239" tabindex="-1"></a><span class="co"># calculate all indices</span></span>
<span id="cb206-240"><a href="data_fusion.html#cb206-240" tabindex="-1"></a>calculate_all_rgb_indices <span class="ot">&lt;-</span> <span class="cf">function</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb206-241"><a href="data_fusion.html#cb206-241" tabindex="-1"></a>  <span class="co"># call individual index functions</span></span>
<span id="cb206-242"><a href="data_fusion.html#cb206-242" tabindex="-1"></a>  grvi_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_grvi</span>(raster_obj, red_band_idx, green_band_idx)</span>
<span id="cb206-243"><a href="data_fusion.html#cb206-243" tabindex="-1"></a>  rgri_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_rgri</span>(raster_obj, red_band_idx, green_band_idx)</span>
<span id="cb206-244"><a href="data_fusion.html#cb206-244" tabindex="-1"></a>  vdvi_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_vdvi</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-245"><a href="data_fusion.html#cb206-245" tabindex="-1"></a>  rgbvi_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_rgbvi</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-246"><a href="data_fusion.html#cb206-246" tabindex="-1"></a>  exg_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_exg</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-247"><a href="data_fusion.html#cb206-247" tabindex="-1"></a>  exr_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_exr</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-248"><a href="data_fusion.html#cb206-248" tabindex="-1"></a>  exgr_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_exgr</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-249"><a href="data_fusion.html#cb206-249" tabindex="-1"></a>  <span class="co"># bi_layer &lt;- spectral_index_bi(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span></span>
<span id="cb206-250"><a href="data_fusion.html#cb206-250" tabindex="-1"></a>  <span class="co"># sat_layer &lt;- spectral_index_saturation(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span></span>
<span id="cb206-251"><a href="data_fusion.html#cb206-251" tabindex="-1"></a>  </span>
<span id="cb206-252"><a href="data_fusion.html#cb206-252" tabindex="-1"></a>  <span class="co"># color spaces: HSV</span></span>
<span id="cb206-253"><a href="data_fusion.html#cb206-253" tabindex="-1"></a>  hsv_rast <span class="ot">&lt;-</span> <span class="fu">spectral_rgb_to_hsv</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-254"><a href="data_fusion.html#cb206-254" tabindex="-1"></a>  <span class="fu">names</span>(hsv_rast) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;hsv_&quot;</span>, <span class="fu">names</span>(hsv_rast), <span class="at">recycle0 =</span> T)</span>
<span id="cb206-255"><a href="data_fusion.html#cb206-255" tabindex="-1"></a>  hsv_hue <span class="ot">&lt;-</span> hsv_rast<span class="sc">$</span>hsv_hue</span>
<span id="cb206-256"><a href="data_fusion.html#cb206-256" tabindex="-1"></a>  hsv_saturation <span class="ot">&lt;-</span> hsv_rast<span class="sc">$</span>hsv_saturation</span>
<span id="cb206-257"><a href="data_fusion.html#cb206-257" tabindex="-1"></a>  hsv_brightness <span class="ot">&lt;-</span> hsv_rast<span class="sc">$</span>hsv_brightness</span>
<span id="cb206-258"><a href="data_fusion.html#cb206-258" tabindex="-1"></a>  <span class="co"># color spaces: CEILab</span></span>
<span id="cb206-259"><a href="data_fusion.html#cb206-259" tabindex="-1"></a>  Lab_rast <span class="ot">&lt;-</span> <span class="fu">spectral_rgb_to_lab</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb206-260"><a href="data_fusion.html#cb206-260" tabindex="-1"></a>  <span class="fu">names</span>(Lab_rast) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;Lab_&quot;</span>, <span class="fu">names</span>(Lab_rast), <span class="at">recycle0 =</span> T)</span>
<span id="cb206-261"><a href="data_fusion.html#cb206-261" tabindex="-1"></a>  Lab_L <span class="ot">&lt;-</span> Lab_rast<span class="sc">$</span>Lab_L</span>
<span id="cb206-262"><a href="data_fusion.html#cb206-262" tabindex="-1"></a>  Lab_a <span class="ot">&lt;-</span> Lab_rast<span class="sc">$</span>Lab_a</span>
<span id="cb206-263"><a href="data_fusion.html#cb206-263" tabindex="-1"></a>  Lab_b <span class="ot">&lt;-</span> Lab_rast<span class="sc">$</span>Lab_b</span>
<span id="cb206-264"><a href="data_fusion.html#cb206-264" tabindex="-1"></a>  </span>
<span id="cb206-265"><a href="data_fusion.html#cb206-265" tabindex="-1"></a>  <span class="co"># stack all calculated indices into a single spatraster</span></span>
<span id="cb206-266"><a href="data_fusion.html#cb206-266" tabindex="-1"></a>  all_indices <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb206-267"><a href="data_fusion.html#cb206-267" tabindex="-1"></a>    grvi_layer</span>
<span id="cb206-268"><a href="data_fusion.html#cb206-268" tabindex="-1"></a>    , rgri_layer</span>
<span id="cb206-269"><a href="data_fusion.html#cb206-269" tabindex="-1"></a>    , vdvi_layer</span>
<span id="cb206-270"><a href="data_fusion.html#cb206-270" tabindex="-1"></a>    , rgbvi_layer</span>
<span id="cb206-271"><a href="data_fusion.html#cb206-271" tabindex="-1"></a>    , exg_layer</span>
<span id="cb206-272"><a href="data_fusion.html#cb206-272" tabindex="-1"></a>    , exr_layer</span>
<span id="cb206-273"><a href="data_fusion.html#cb206-273" tabindex="-1"></a>    , exgr_layer</span>
<span id="cb206-274"><a href="data_fusion.html#cb206-274" tabindex="-1"></a>    <span class="co"># , bi_layer</span></span>
<span id="cb206-275"><a href="data_fusion.html#cb206-275" tabindex="-1"></a>    <span class="co"># , sat_layer</span></span>
<span id="cb206-276"><a href="data_fusion.html#cb206-276" tabindex="-1"></a>    , hsv_hue</span>
<span id="cb206-277"><a href="data_fusion.html#cb206-277" tabindex="-1"></a>    , hsv_saturation</span>
<span id="cb206-278"><a href="data_fusion.html#cb206-278" tabindex="-1"></a>    , hsv_brightness</span>
<span id="cb206-279"><a href="data_fusion.html#cb206-279" tabindex="-1"></a>    , Lab_L</span>
<span id="cb206-280"><a href="data_fusion.html#cb206-280" tabindex="-1"></a>    , Lab_a</span>
<span id="cb206-281"><a href="data_fusion.html#cb206-281" tabindex="-1"></a>    , Lab_b</span>
<span id="cb206-282"><a href="data_fusion.html#cb206-282" tabindex="-1"></a>  )</span>
<span id="cb206-283"><a href="data_fusion.html#cb206-283" tabindex="-1"></a></span>
<span id="cb206-284"><a href="data_fusion.html#cb206-284" tabindex="-1"></a>  <span class="fu">return</span>(all_indices)</span>
<span id="cb206-285"><a href="data_fusion.html#cb206-285" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s test this <code>calculate_all_rgb_indices()</code> function with our orthomosaic</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="data_fusion.html#cb207-1" tabindex="-1"></a><span class="co"># calculate_all_rgb_indices</span></span>
<span id="cb207-2"><a href="data_fusion.html#cb207-2" tabindex="-1"></a>all_rgb_indices_rast <span class="ot">&lt;-</span> <span class="fu">calculate_all_rgb_indices</span>(aoi_rgb_rast,<span class="at">red_band_idx =</span> <span class="dv">1</span>, <span class="at">green_band_idx =</span> <span class="dv">2</span>, <span class="at">blue_band_idx =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="data_fusion.html#cb208-1" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb208-2"><a href="data_fusion.html#cb208-2" tabindex="-1"></a>all_rgb_indices_rast <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
<pre><code>##  [1] &quot;grvi&quot;           &quot;rgri&quot;           &quot;vdvi&quot;           &quot;rgbvi&quot;         
##  [5] &quot;exg&quot;            &quot;exr&quot;            &quot;exgr&quot;           &quot;hsv_hue&quot;       
##  [9] &quot;hsv_saturation&quot; &quot;hsv_brightness&quot; &quot;Lab_L&quot;          &quot;Lab_a&quot;         
## [13] &quot;Lab_b&quot;</code></pre>
<p>we’ll limit to the indices we have thresholds for</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="data_fusion.html#cb210-1" tabindex="-1"></a>all_rgb_indices_rast <span class="ot">&lt;-</span> </span>
<span id="cb210-2"><a href="data_fusion.html#cb210-2" tabindex="-1"></a>  all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb210-3"><a href="data_fusion.html#cb210-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">subset</span>(</span>
<span id="cb210-4"><a href="data_fusion.html#cb210-4" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb210-5"><a href="data_fusion.html#cb210-5" tabindex="-1"></a>      <span class="st">&quot;grvi&quot;</span></span>
<span id="cb210-6"><a href="data_fusion.html#cb210-6" tabindex="-1"></a>      , <span class="st">&quot;rgri&quot;</span></span>
<span id="cb210-7"><a href="data_fusion.html#cb210-7" tabindex="-1"></a>      , <span class="st">&quot;vdvi&quot;</span></span>
<span id="cb210-8"><a href="data_fusion.html#cb210-8" tabindex="-1"></a>      , <span class="st">&quot;exgr&quot;</span></span>
<span id="cb210-9"><a href="data_fusion.html#cb210-9" tabindex="-1"></a>      , <span class="st">&quot;Lab_a&quot;</span></span>
<span id="cb210-10"><a href="data_fusion.html#cb210-10" tabindex="-1"></a>      , <span class="st">&quot;hsv_hue&quot;</span></span>
<span id="cb210-11"><a href="data_fusion.html#cb210-11" tabindex="-1"></a>    )</span>
<span id="cb210-12"><a href="data_fusion.html#cb210-12" tabindex="-1"></a>  )</span></code></pre></div>
<p>let’s plot all of those indices for the entire extent of our orthomoasic</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="data_fusion.html#cb211-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb211-2"><a href="data_fusion.html#cb211-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb211-3"><a href="data_fusion.html#cb211-3" tabindex="-1"></a>  all_rgb_indices_rast</span>
<span id="cb211-4"><a href="data_fusion.html#cb211-4" tabindex="-1"></a>  , <span class="at">nc =</span> <span class="dv">3</span></span>
<span id="cb211-5"><a href="data_fusion.html#cb211-5" tabindex="-1"></a>  <span class="co"># , nr = 3</span></span>
<span id="cb211-6"><a href="data_fusion.html#cb211-6" tabindex="-1"></a>  , <span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">2</span>,<span class="fl">0.5</span>)</span>
<span id="cb211-7"><a href="data_fusion.html#cb211-7" tabindex="-1"></a>  , <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb211-8"><a href="data_fusion.html#cb211-8" tabindex="-1"></a>  , <span class="at">legend =</span> F</span>
<span id="cb211-9"><a href="data_fusion.html#cb211-9" tabindex="-1"></a>  <span class="co"># , col = grDevices::gray.colors(n=111)</span></span>
<span id="cb211-10"><a href="data_fusion.html#cb211-10" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-253-1.png" alt="" width="1008" /></p>
<p>we can also look at the correlation between the different indices</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="data_fusion.html#cb212-1" tabindex="-1"></a><span class="co"># investigate correlation among covariates</span></span>
<span id="cb212-2"><a href="data_fusion.html#cb212-2" tabindex="-1"></a>all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb212-3"><a href="data_fusion.html#cb212-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">pairs</span>(</span>
<span id="cb212-4"><a href="data_fusion.html#cb212-4" tabindex="-1"></a>    <span class="at">maxcells =</span> <span class="fu">min</span>(<span class="dv">11111</span>, terra<span class="sc">::</span><span class="fu">ncell</span>(all_rgb_indices_rast)<span class="sc">*</span>.<span class="dv">01</span>)</span>
<span id="cb212-5"><a href="data_fusion.html#cb212-5" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-254-1.png" alt="" width="1008" /></p>
<p>many of these spectral indices are highly (even perfectly) correlated, meaning they provide redundant information. however, the index thresholds were determined independently for the most highly correlated values so we retain them for our voting system filtering methodology since the combination of the index with the unique index provides unique identification functionality.</p>
<p>summary stats of these indices over our example area</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="data_fusion.html#cb213-1" tabindex="-1"></a>all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb213-2"><a href="data_fusion.html#cb213-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">summary</span>(<span class="at">size =</span> <span class="fu">min</span>(<span class="dv">11111</span>, terra<span class="sc">::</span><span class="fu">ncell</span>(all_rgb_indices_rast)<span class="sc">*</span>.<span class="dv">01</span>))</span></code></pre></div>
<pre><code>##       grvi               rgri             vdvi                exgr         
##  Min.   :-0.27500   Min.   :0.5890   Min.   :-0.166224   Min.   :-0.57562  
##  1st Qu.:-0.04377   1st Qu.:0.9607   1st Qu.:-0.016255   1st Qu.:-0.19027  
##  Median :-0.02054   Median :1.0419   Median :-0.004388   Median :-0.15605  
##  Mean   :-0.01061   Mean   :1.0267   Mean   : 0.011658   Mean   :-0.12931  
##  3rd Qu.: 0.02003   3rd Qu.:1.0916   3rd Qu.: 0.024418   3rd Qu.:-0.09614  
##  Max.   : 0.25861   Max.   :1.7586   Max.   : 0.320572   Max.   : 0.54519  
##  NA&#39;s   :11         NA&#39;s   :11       NA&#39;s   :11          NA&#39;s   :11        
##      Lab_a              hsv_hue        
##  Min.   :-31.14243   Min.   :0.000029  
##  1st Qu.: -1.54772   1st Qu.:0.061810  
##  Median :  1.03632   Median :0.126905  
##  Mean   :  0.04067   Mean   :0.251398  
##  3rd Qu.:  3.41652   3rd Qu.:0.293970  
##  Max.   : 15.66249   Max.   :0.999958  
##  NA&#39;s   :11          NA&#39;s   :11</code></pre>
<p>the <code>terra::colorize()</code> function produces Hue values normalized to the [0, 1] range; we can convert these normalized values to the [0, 360] range:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="data_fusion.html#cb215-1" tabindex="-1"></a>(all_rgb_indices_rast<span class="sc">$</span>hsv_hue<span class="sc">*</span><span class="dv">360</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb215-2"><a href="data_fusion.html#cb215-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">main=</span><span class="st">&quot;Hue [0,360] range&quot;</span>, <span class="at">axes =</span> F, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-256-1.png" alt="" width="1008" /></p>
<p>here is a plot of the different spectral indices (high values are brighter, low values are darker) on our example area we were working with in the last section with the demonstration piles in blue</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="data_fusion.html#cb216-1" tabindex="-1"></a>all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb216-2"><a href="data_fusion.html#cb216-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb216-3"><a href="data_fusion.html#cb216-3" tabindex="-1"></a>    <span class="at">nc =</span> <span class="dv">3</span></span>
<span id="cb216-4"><a href="data_fusion.html#cb216-4" tabindex="-1"></a>    , <span class="at">col =</span> grDevices<span class="sc">::</span><span class="fu">gray.colors</span>(<span class="dv">111</span>, <span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>)</span>
<span id="cb216-5"><a href="data_fusion.html#cb216-5" tabindex="-1"></a>    , <span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">2</span>,<span class="fl">0.5</span>)</span>
<span id="cb216-6"><a href="data_fusion.html#cb216-6" tabindex="-1"></a>    , <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb216-7"><a href="data_fusion.html#cb216-7" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb216-8"><a href="data_fusion.html#cb216-8" tabindex="-1"></a>    , <span class="at">fun =</span> <span class="cf">function</span>(){</span>
<span id="cb216-9"><a href="data_fusion.html#cb216-9" tabindex="-1"></a>      <span class="fu">lines</span>(terra<span class="sc">::</span><span class="fu">vect</span>(aoi_boundary), <span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb216-10"><a href="data_fusion.html#cb216-10" tabindex="-1"></a>      <span class="co"># add a second vector outline (cyan)</span></span>
<span id="cb216-11"><a href="data_fusion.html#cb216-11" tabindex="-1"></a>      <span class="fu">lines</span>(</span>
<span id="cb216-12"><a href="data_fusion.html#cb216-12" tabindex="-1"></a>        aoi_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb216-13"><a href="data_fusion.html#cb216-13" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb216-14"><a href="data_fusion.html#cb216-14" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb216-15"><a href="data_fusion.html#cb216-15" tabindex="-1"></a>        , <span class="at">col =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.3</span>)</span>
<span id="cb216-16"><a href="data_fusion.html#cb216-16" tabindex="-1"></a>    }</span>
<span id="cb216-17"><a href="data_fusion.html#cb216-17" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-259-1.png" alt="" width="1008" /></p>
<p>for a refresher, here is the demonstration RGB image with the image annotated piles (cyan)</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="data_fusion.html#cb217-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(aoi_rgb_rast)</span>
<span id="cb217-2"><a href="data_fusion.html#cb217-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb217-3"><a href="data_fusion.html#cb217-3" tabindex="-1"></a>  aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb217-4"><a href="data_fusion.html#cb217-4" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb217-5"><a href="data_fusion.html#cb217-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb217-6"><a href="data_fusion.html#cb217-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb217-7"><a href="data_fusion.html#cb217-7" tabindex="-1"></a>)</span>
<span id="cb217-8"><a href="data_fusion.html#cb217-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb217-9"><a href="data_fusion.html#cb217-9" tabindex="-1"></a>  aoi_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb217-10"><a href="data_fusion.html#cb217-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb217-11"><a href="data_fusion.html#cb217-11" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb217-12"><a href="data_fusion.html#cb217-12" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.3</span></span>
<span id="cb217-13"><a href="data_fusion.html#cb217-13" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-260-1.png" alt="" width="1008" /></p>
</div>
<div id="spectral-index-of-polygons" class="section level3 hasAnchor" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Spectral Index of Polygons<a href="data_fusion.html#spectral-index-of-polygons" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we now need a function to crop the raster with all spectral indices given a polygon input data and return the spectral index values as columns attached to the polygon</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="data_fusion.html#cb218-1" tabindex="-1"></a>extract_rast_values <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data, rast, <span class="at">fun_agg =</span> mean) {</span>
<span id="cb218-2"><a href="data_fusion.html#cb218-2" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb218-3"><a href="data_fusion.html#cb218-3" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb218-4"><a href="data_fusion.html#cb218-4" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `rast` must be a SpatRaster object.&quot;</span>)</span>
<span id="cb218-5"><a href="data_fusion.html#cb218-5" tabindex="-1"></a>  }</span>
<span id="cb218-6"><a href="data_fusion.html#cb218-6" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){</span>
<span id="cb218-7"><a href="data_fusion.html#cb218-7" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must be an sf data frame.&quot;</span>)</span>
<span id="cb218-8"><a href="data_fusion.html#cb218-8" tabindex="-1"></a>  }</span>
<span id="cb218-9"><a href="data_fusion.html#cb218-9" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(sf_data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) {</span>
<span id="cb218-10"><a href="data_fusion.html#cb218-10" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must contain polygon geometries.&quot;</span>)</span>
<span id="cb218-11"><a href="data_fusion.html#cb218-11" tabindex="-1"></a>  }</span>
<span id="cb218-12"><a href="data_fusion.html#cb218-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.function</span>(fun_agg)) {</span>
<span id="cb218-13"><a href="data_fusion.html#cb218-13" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Argument `fun_agg` must be a function (e.g., mean, median, sum).&quot;</span>)</span>
<span id="cb218-14"><a href="data_fusion.html#cb218-14" tabindex="-1"></a>  }</span>
<span id="cb218-15"><a href="data_fusion.html#cb218-15" tabindex="-1"></a></span>
<span id="cb218-16"><a href="data_fusion.html#cb218-16" tabindex="-1"></a>  <span class="co"># crs</span></span>
<span id="cb218-17"><a href="data_fusion.html#cb218-17" tabindex="-1"></a>  sf_data <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(rast))</span>
<span id="cb218-18"><a href="data_fusion.html#cb218-18" tabindex="-1"></a></span>
<span id="cb218-19"><a href="data_fusion.html#cb218-19" tabindex="-1"></a>  <span class="co"># extract values for each layer within each polygon</span></span>
<span id="cb218-20"><a href="data_fusion.html#cb218-20" tabindex="-1"></a>  extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb218-21"><a href="data_fusion.html#cb218-21" tabindex="-1"></a>    <span class="at">x =</span> rast</span>
<span id="cb218-22"><a href="data_fusion.html#cb218-22" tabindex="-1"></a>    , <span class="at">y =</span> sf_data</span>
<span id="cb218-23"><a href="data_fusion.html#cb218-23" tabindex="-1"></a>    , <span class="at">fun =</span> fun_agg</span>
<span id="cb218-24"><a href="data_fusion.html#cb218-24" tabindex="-1"></a>    , <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb218-25"><a href="data_fusion.html#cb218-25" tabindex="-1"></a>  )</span>
<span id="cb218-26"><a href="data_fusion.html#cb218-26" tabindex="-1"></a></span>
<span id="cb218-27"><a href="data_fusion.html#cb218-27" tabindex="-1"></a>  <span class="co"># clean data</span></span>
<span id="cb218-28"><a href="data_fusion.html#cb218-28" tabindex="-1"></a>  fun_name <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(fun_agg))</span>
<span id="cb218-29"><a href="data_fusion.html#cb218-29" tabindex="-1"></a>  extracted_values <span class="ot">&lt;-</span> extracted_values <span class="sc">%&gt;%</span> </span>
<span id="cb218-30"><a href="data_fusion.html#cb218-30" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>ID) <span class="sc">%&gt;%</span> </span>
<span id="cb218-31"><a href="data_fusion.html#cb218-31" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(</span>
<span id="cb218-32"><a href="data_fusion.html#cb218-32" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">paste0</span>(</span>
<span id="cb218-33"><a href="data_fusion.html#cb218-33" tabindex="-1"></a>        <span class="st">&quot;rast_&quot;</span></span>
<span id="cb218-34"><a href="data_fusion.html#cb218-34" tabindex="-1"></a>        <span class="co"># , fun_name </span><span class="al">###</span><span class="co"> if we want to have custom output depending on the fun_agg</span></span>
<span id="cb218-35"><a href="data_fusion.html#cb218-35" tabindex="-1"></a>        , <span class="st">&quot;agg&quot;</span></span>
<span id="cb218-36"><a href="data_fusion.html#cb218-36" tabindex="-1"></a>        , <span class="st">&quot;_&quot;</span></span>
<span id="cb218-37"><a href="data_fusion.html#cb218-37" tabindex="-1"></a>        , .x</span>
<span id="cb218-38"><a href="data_fusion.html#cb218-38" tabindex="-1"></a>        , <span class="at">recycle0 =</span> <span class="cn">TRUE</span></span>
<span id="cb218-39"><a href="data_fusion.html#cb218-39" tabindex="-1"></a>      )</span>
<span id="cb218-40"><a href="data_fusion.html#cb218-40" tabindex="-1"></a>    )</span>
<span id="cb218-41"><a href="data_fusion.html#cb218-41" tabindex="-1"></a></span>
<span id="cb218-42"><a href="data_fusion.html#cb218-42" tabindex="-1"></a>  <span class="co"># Merge the extracted values back to the original sf data frame</span></span>
<span id="cb218-43"><a href="data_fusion.html#cb218-43" tabindex="-1"></a>  <span class="co"># The row order is preserved by terra::extract, so a direct cbind is safe</span></span>
<span id="cb218-44"><a href="data_fusion.html#cb218-44" tabindex="-1"></a>  <span class="co"># if no rows were dropped due to spatial mismatch.</span></span>
<span id="cb218-45"><a href="data_fusion.html#cb218-45" tabindex="-1"></a>  <span class="co"># For robustness, we can explicitly join by row ID if needed, but for simple cases, cbind works.</span></span>
<span id="cb218-46"><a href="data_fusion.html#cb218-46" tabindex="-1"></a>  <span class="co"># Assuming sf_data has a unique ID column or row order is stable:</span></span>
<span id="cb218-47"><a href="data_fusion.html#cb218-47" tabindex="-1"></a>  sf_data_with_indices <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(extracted_values)</span>
<span id="cb218-48"><a href="data_fusion.html#cb218-48" tabindex="-1"></a></span>
<span id="cb218-49"><a href="data_fusion.html#cb218-49" tabindex="-1"></a>  <span class="fu">return</span>(sf_data_with_indices)</span>
<span id="cb218-50"><a href="data_fusion.html#cb218-50" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="demonstration-pile-spectral-summary" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Demonstration Pile Spectral Summary<a href="data_fusion.html#demonstration-pile-spectral-summary" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>let’s calculate the various spectral indices on our demonstration slash pile polygons by getting the median value within the bounds of the pile</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="data_fusion.html#cb219-1" tabindex="-1"></a><span class="co"># extract_rast_values</span></span>
<span id="cb219-2"><a href="data_fusion.html#cb219-2" tabindex="-1"></a>rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">extract_rast_values</span>(aoi_slash_piles_polys, <span class="at">rast =</span> all_rgb_indices_rast, <span class="at">fun_agg =</span> median) <span class="sc">%&gt;%</span> </span>
<span id="cb219-3"><a href="data_fusion.html#cb219-3" tabindex="-1"></a>  <span class="co"># convert hue to 0-360</span></span>
<span id="cb219-4"><a href="data_fusion.html#cb219-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">rast_agg_hsv_hue_01=</span>rast_agg_hsv_hue) <span class="sc">%&gt;%</span> </span>
<span id="cb219-5"><a href="data_fusion.html#cb219-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rast_agg_hsv_hue =</span> rast_agg_hsv_hue_01<span class="sc">*</span><span class="dv">360</span>)</span>
<span id="cb219-6"><a href="data_fusion.html#cb219-6" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 17
## Columns: 27
## $ pile_id             &lt;dbl&gt; 3, 4, 5, 6, 11, 13, 17, 19, 20, 21, 22, 23, 24, 29…
## $ site                &lt;chr&gt; &quot;PSINF Mixed Conifer Site&quot;, &quot;PSINF Mixed Conifer S…
## $ is_in_stand         &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, F…
## $ comment             &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ comment2            &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ height_ft           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ diameter_ft         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ xcoord              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ ycoord              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ refcorner           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ row_number          &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ geometry            &lt;POLYGON [m]&gt; POLYGON ((499341.7 4317759,..., POLYGON ((…
## $ image_gt_diameter_m &lt;dbl&gt; 6.469934, 6.867876, 6.387723, 6.589466, 5.482888, …
## $ field_height_m      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ field_diameter_m    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ field_radius_m      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ image_gt_area_m2    &lt;dbl&gt; 25.166539, 32.028082, 22.928349, 26.261937, 20.184…
## $ field_gt_area_m2    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ image_gt_volume_m3  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ field_gt_volume_m3  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ rast_agg_grvi       &lt;dbl&gt; -0.032770754, -0.028380480, -0.052833877, -0.04832…
## $ rast_agg_rgri       &lt;dbl&gt; 1.0677621, 1.0584189, 1.1115620, 1.1015627, 1.0571…
## $ rast_agg_vdvi       &lt;dbl&gt; -0.01948794, -0.02056626, -0.02798897, -0.02466490…
## $ rast_agg_exgr       &lt;dbl&gt; -0.1868011, -0.1832732, -0.2167072, -0.2087036, -0…
## $ rast_agg_Lab_a      &lt;dbl&gt; 3.3675173, 3.2561641, 4.2656566, 4.0006617, 3.0351…
## $ rast_agg_hsv_hue_01 &lt;dbl&gt; 0.8723564, 0.8332400, 0.6569343, 0.7332149, 0.5626…
## $ rast_agg_hsv_hue    &lt;dbl&gt; 314.0483, 299.9664, 236.4963, 263.9574, 202.5427, …</code></pre>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="data_fusion.html#cb221-1" tabindex="-1"></a><span class="co"># quick summary</span></span>
<span id="cb221-2"><a href="data_fusion.html#cb221-2" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb221-3"><a href="data_fusion.html#cb221-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb221-4"><a href="data_fusion.html#cb221-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb221-5"><a href="data_fusion.html#cb221-5" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##  rast_agg_grvi       rast_agg_rgri    rast_agg_vdvi      rast_agg_exgr    
##  Min.   :-0.052834   Min.   :0.8950   Min.   :-0.03551   Min.   :-0.2167  
##  1st Qu.:-0.028380   1st Qu.:0.9855   1st Qu.:-0.02799   1st Qu.:-0.1833  
##  Median :-0.018569   Median :1.0378   Median :-0.02057   Median :-0.1694  
##  Mean   :-0.009339   Mean   :1.0209   Mean   :-0.02271   Mean   :-0.1688  
##  3rd Qu.: 0.007320   3rd Qu.:1.0584   3rd Qu.:-0.01693   3rd Qu.:-0.1533  
##  Max.   : 0.055409   Max.   :1.1116   Max.   :-0.01214   Max.   :-0.1203  
##  rast_agg_Lab_a   rast_agg_hsv_hue_01 rast_agg_hsv_hue
##  Min.   :0.3379   Min.   :0.5626      Min.   :202.5   
##  1st Qu.:0.8788   1st Qu.:0.6205      1st Qu.:223.4   
##  Median :2.2162   Median :0.7208      Median :259.5   
##  Mean   :2.1987   Mean   :0.7153      Mean   :257.5   
##  3rd Qu.:3.2562   3rd Qu.:0.8054      3rd Qu.:289.9   
##  Max.   :4.2657   Max.   :0.9026      Max.   :324.9</code></pre>
<p>let’s plot it</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="data_fusion.html#cb223-1" tabindex="-1"></a><span class="co"># pivot</span></span>
<span id="cb223-2"><a href="data_fusion.html#cb223-2" tabindex="-1"></a>agg_df_temp <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb223-3"><a href="data_fusion.html#cb223-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb223-4"><a href="data_fusion.html#cb223-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb223-5"><a href="data_fusion.html#cb223-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>rast_agg_hsv_hue_01) <span class="sc">%&gt;%</span> </span>
<span id="cb223-6"><a href="data_fusion.html#cb223-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb223-7"><a href="data_fusion.html#cb223-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;rast_agg_&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_upper</span>())</span>
<span id="cb223-8"><a href="data_fusion.html#cb223-8" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb223-9"><a href="data_fusion.html#cb223-9" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb223-10"><a href="data_fusion.html#cb223-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(</span>
<span id="cb223-11"><a href="data_fusion.html#cb223-11" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp</span>
<span id="cb223-12"><a href="data_fusion.html#cb223-12" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name)</span>
<span id="cb223-13"><a href="data_fusion.html#cb223-13" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb223-14"><a href="data_fusion.html#cb223-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-15"><a href="data_fusion.html#cb223-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb223-16"><a href="data_fusion.html#cb223-16" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">value=</span><span class="fu">median</span>(value,<span class="at">na.rm=</span>T))</span>
<span id="cb223-17"><a href="data_fusion.html#cb223-17" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;median&quot;</span>)</span>
<span id="cb223-18"><a href="data_fusion.html#cb223-18" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb223-19"><a href="data_fusion.html#cb223-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-20"><a href="data_fusion.html#cb223-20" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb223-21"><a href="data_fusion.html#cb223-21" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">value=</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs=</span><span class="fl">0.025</span>))</span>
<span id="cb223-22"><a href="data_fusion.html#cb223-22" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;p2.5–p97.5&quot;</span>)</span>
<span id="cb223-23"><a href="data_fusion.html#cb223-23" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb223-24"><a href="data_fusion.html#cb223-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-25"><a href="data_fusion.html#cb223-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb223-26"><a href="data_fusion.html#cb223-26" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">value=</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs=</span>(<span class="dv">1</span><span class="fl">-0.025</span>)))</span>
<span id="cb223-27"><a href="data_fusion.html#cb223-27" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;p2.5–p97.5&quot;</span>)</span>
<span id="cb223-28"><a href="data_fusion.html#cb223-28" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb223-29"><a href="data_fusion.html#cb223-29" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-30"><a href="data_fusion.html#cb223-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>, <span class="at">begin =</span> <span class="fl">0.1</span>, <span class="at">end =</span> <span class="fl">0.9</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb223-31"><a href="data_fusion.html#cb223-31" tabindex="-1"></a>  <span class="co"># ggplot2::scale_fill_brewer(palette = &quot;Set2&quot;) +</span></span>
<span id="cb223-32"><a href="data_fusion.html#cb223-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray22&quot;</span>,<span class="st">&quot;gray&quot;</span>,<span class="st">&quot;gray&quot;</span>)) <span class="sc">+</span></span>
<span id="cb223-33"><a href="data_fusion.html#cb223-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb223-34"><a href="data_fusion.html#cb223-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb223-35"><a href="data_fusion.html#cb223-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb223-36"><a href="data_fusion.html#cb223-36" tabindex="-1"></a>    <span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)</span>
<span id="cb223-37"><a href="data_fusion.html#cb223-37" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">3</span></span>
<span id="cb223-38"><a href="data_fusion.html#cb223-38" tabindex="-1"></a>    , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb223-39"><a href="data_fusion.html#cb223-39" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-40"><a href="data_fusion.html#cb223-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb223-41"><a href="data_fusion.html#cb223-41" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb223-42"><a href="data_fusion.html#cb223-42" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-43"><a href="data_fusion.html#cb223-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb223-44"><a href="data_fusion.html#cb223-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb223-45"><a href="data_fusion.html#cb223-45" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb223-46"><a href="data_fusion.html#cb223-46" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb223-47"><a href="data_fusion.html#cb223-47" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb223-48"><a href="data_fusion.html#cb223-48" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb223-49"><a href="data_fusion.html#cb223-49" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb223-50"><a href="data_fusion.html#cb223-50" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-263-1.png" alt="" width="1008" /></p>
<p>that’s interesting. compare those values with the thresholds identified in the research listed in the table above</p>
<p>here is a plot of the median value of the different spectral indices (high values are brighter, low values are darker) within the bounds of the pile on our example area we were working with in the last section</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="data_fusion.html#cb224-1" tabindex="-1"></a>polys_temp <span class="ot">&lt;-</span></span>
<span id="cb224-2"><a href="data_fusion.html#cb224-2" tabindex="-1"></a>  rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb224-3"><a href="data_fusion.html#cb224-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(aoi_boundary)) <span class="sc">%&gt;%</span> </span>
<span id="cb224-4"><a href="data_fusion.html#cb224-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id, tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb224-5"><a href="data_fusion.html#cb224-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb224-6"><a href="data_fusion.html#cb224-6" tabindex="-1"></a>    <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb224-7"><a href="data_fusion.html#cb224-7" tabindex="-1"></a>    , <span class="st">&quot;rast_agg_hsv_hue_01&quot;</span></span>
<span id="cb224-8"><a href="data_fusion.html#cb224-8" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span> </span>
<span id="cb224-9"><a href="data_fusion.html#cb224-9" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb224-10"><a href="data_fusion.html#cb224-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(name,<span class="st">&quot;rast_agg_&quot;</span>))</span>
<span id="cb224-11"><a href="data_fusion.html#cb224-11" tabindex="-1"></a>  <span class="co"># # dplyr::filter(name==&quot;grvi&quot;) %&gt;% </span></span>
<span id="cb224-12"><a href="data_fusion.html#cb224-12" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() + </span></span>
<span id="cb224-13"><a href="data_fusion.html#cb224-13" tabindex="-1"></a>  <span class="co">#   ggplot2::geom_sf(mapping=ggplot2::aes(fill=value)) + </span></span>
<span id="cb224-14"><a href="data_fusion.html#cb224-14" tabindex="-1"></a>  <span class="co">#   ggplot2::facet_wrap(facets=dplyr::vars(name)) +</span></span>
<span id="cb224-15"><a href="data_fusion.html#cb224-15" tabindex="-1"></a>  <span class="co">#   ggplot2::theme_void() +</span></span>
<span id="cb224-16"><a href="data_fusion.html#cb224-16" tabindex="-1"></a>  <span class="co">#   ggplot2::theme(legend.position = &quot;top&quot;)</span></span>
<span id="cb224-17"><a href="data_fusion.html#cb224-17" tabindex="-1"></a><span class="co"># rast clip</span></span>
<span id="cb224-18"><a href="data_fusion.html#cb224-18" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb224-19"><a href="data_fusion.html#cb224-19" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(aoi_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">7.3</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb224-20"><a href="data_fusion.html#cb224-20" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(aoi_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">7.3</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()) </span>
<span id="cb224-21"><a href="data_fusion.html#cb224-21" tabindex="-1"></a></span>
<span id="cb224-22"><a href="data_fusion.html#cb224-22" tabindex="-1"></a><span class="co"># plot list</span></span>
<span id="cb224-23"><a href="data_fusion.html#cb224-23" tabindex="-1"></a>plt_list_temp <span class="ot">&lt;-</span> </span>
<span id="cb224-24"><a href="data_fusion.html#cb224-24" tabindex="-1"></a>  <span class="co"># names(all_rgb_indices_rast) %&gt;%</span></span>
<span id="cb224-25"><a href="data_fusion.html#cb224-25" tabindex="-1"></a>  <span class="st">&quot;hsv_hue&quot;</span> <span class="sc">%&gt;%</span></span>
<span id="cb224-26"><a href="data_fusion.html#cb224-26" tabindex="-1"></a>  <span class="co"># sample(6) %&gt;%</span></span>
<span id="cb224-27"><a href="data_fusion.html#cb224-27" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb224-28"><a href="data_fusion.html#cb224-28" tabindex="-1"></a>    \(x)</span>
<span id="cb224-29"><a href="data_fusion.html#cb224-29" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb224-30"><a href="data_fusion.html#cb224-30" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb224-31"><a href="data_fusion.html#cb224-31" tabindex="-1"></a>        <span class="at">data =</span> rast_temp[[x]] <span class="sc">%&gt;%</span> </span>
<span id="cb224-32"><a href="data_fusion.html#cb224-32" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb224-33"><a href="data_fusion.html#cb224-33" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb224-34"><a href="data_fusion.html#cb224-34" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> f)</span>
<span id="cb224-35"><a href="data_fusion.html#cb224-35" tabindex="-1"></a>        , <span class="at">alpha =</span> <span class="fl">0.9</span></span>
<span id="cb224-36"><a href="data_fusion.html#cb224-36" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb224-37"><a href="data_fusion.html#cb224-37" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb224-38"><a href="data_fusion.html#cb224-38" tabindex="-1"></a>        <span class="at">data =</span> aoi_boundary</span>
<span id="cb224-39"><a href="data_fusion.html#cb224-39" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">0.8</span></span>
<span id="cb224-40"><a href="data_fusion.html#cb224-40" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb224-41"><a href="data_fusion.html#cb224-41" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb224-42"><a href="data_fusion.html#cb224-42" tabindex="-1"></a>        <span class="at">data =</span> polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(name <span class="sc">==</span> x)</span>
<span id="cb224-43"><a href="data_fusion.html#cb224-43" tabindex="-1"></a>        <span class="co"># , mapping = ggplot2::aes(fill=value)</span></span>
<span id="cb224-44"><a href="data_fusion.html#cb224-44" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb224-45"><a href="data_fusion.html#cb224-45" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb224-46"><a href="data_fusion.html#cb224-46" tabindex="-1"></a>      ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb224-47"><a href="data_fusion.html#cb224-47" tabindex="-1"></a>        <span class="at">data =</span> polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb224-48"><a href="data_fusion.html#cb224-48" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(name <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb224-49"><a href="data_fusion.html#cb224-49" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_point_on_surface</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb224-50"><a href="data_fusion.html#cb224-50" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-51"><a href="data_fusion.html#cb224-51" tabindex="-1"></a>            <span class="at">x_coord =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[, <span class="dv">1</span>]</span>
<span id="cb224-52"><a href="data_fusion.html#cb224-52" tabindex="-1"></a>            , <span class="at">y_coord =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[, <span class="dv">2</span>]</span>
<span id="cb224-53"><a href="data_fusion.html#cb224-53" tabindex="-1"></a>          )</span>
<span id="cb224-54"><a href="data_fusion.html#cb224-54" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb224-55"><a href="data_fusion.html#cb224-55" tabindex="-1"></a>          <span class="at">x =</span> x_coord</span>
<span id="cb224-56"><a href="data_fusion.html#cb224-56" tabindex="-1"></a>          , <span class="at">y =</span> y_coord</span>
<span id="cb224-57"><a href="data_fusion.html#cb224-57" tabindex="-1"></a>          , <span class="at">label =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb224-58"><a href="data_fusion.html#cb224-58" tabindex="-1"></a>            name <span class="sc">==</span> <span class="st">&quot;hsv_hue&quot;</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value, <span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb224-59"><a href="data_fusion.html#cb224-59" tabindex="-1"></a>            , T <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">comma</span>(value, <span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb224-60"><a href="data_fusion.html#cb224-60" tabindex="-1"></a>          )</span>
<span id="cb224-61"><a href="data_fusion.html#cb224-61" tabindex="-1"></a>          , <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span></span>
<span id="cb224-62"><a href="data_fusion.html#cb224-62" tabindex="-1"></a>        )</span>
<span id="cb224-63"><a href="data_fusion.html#cb224-63" tabindex="-1"></a>        , <span class="at">nudge_x =</span> <span class="fl">0.5</span> <span class="co"># initial horizontal nudge</span></span>
<span id="cb224-64"><a href="data_fusion.html#cb224-64" tabindex="-1"></a>        , <span class="at">nudge_y =</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="co"># initial vertical nudge</span></span>
<span id="cb224-65"><a href="data_fusion.html#cb224-65" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.2</span>, <span class="at">color =</span> <span class="st">&quot;cyan&quot;</span></span>
<span id="cb224-66"><a href="data_fusion.html#cb224-66" tabindex="-1"></a>        , <span class="at">force =</span> <span class="dv">1</span></span>
<span id="cb224-67"><a href="data_fusion.html#cb224-67" tabindex="-1"></a>        , <span class="at">box.padding =</span> <span class="fl">0.3</span> <span class="co"># Increase padding to push labels further away</span></span>
<span id="cb224-68"><a href="data_fusion.html#cb224-68" tabindex="-1"></a>        <span class="co"># , point.padding = 0.7 # Ensure distance from the original point</span></span>
<span id="cb224-69"><a href="data_fusion.html#cb224-69" tabindex="-1"></a>        , <span class="at">min.segment.length =</span> <span class="fl">0.5</span> <span class="co"># Minimum length of the connecting line segment</span></span>
<span id="cb224-70"><a href="data_fusion.html#cb224-70" tabindex="-1"></a>        , <span class="at">segment.color =</span> <span class="cn">NA</span></span>
<span id="cb224-71"><a href="data_fusion.html#cb224-71" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb224-72"><a href="data_fusion.html#cb224-72" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Greys&quot;</span>) <span class="sc">+</span></span>
<span id="cb224-73"><a href="data_fusion.html#cb224-73" tabindex="-1"></a>      <span class="co"># ggplot2::scale_fill_gradientn(colors = grDevices::gray.colors(111, start = 0, end = 1)) +</span></span>
<span id="cb224-74"><a href="data_fusion.html#cb224-74" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb224-75"><a href="data_fusion.html#cb224-75" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb224-76"><a href="data_fusion.html#cb224-76" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb224-77"><a href="data_fusion.html#cb224-77" tabindex="-1"></a>        <span class="at">fill =</span> x</span>
<span id="cb224-78"><a href="data_fusion.html#cb224-78" tabindex="-1"></a>        , <span class="at">subtitle =</span> x</span>
<span id="cb224-79"><a href="data_fusion.html#cb224-79" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb224-80"><a href="data_fusion.html#cb224-80" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb224-81"><a href="data_fusion.html#cb224-81" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb224-82"><a href="data_fusion.html#cb224-82" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb224-83"><a href="data_fusion.html#cb224-83" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb224-84"><a href="data_fusion.html#cb224-84" tabindex="-1"></a>      )</span>
<span id="cb224-85"><a href="data_fusion.html#cb224-85" tabindex="-1"></a>  )</span>
<span id="cb224-86"><a href="data_fusion.html#cb224-86" tabindex="-1"></a><span class="co"># plt_list_temp</span></span>
<span id="cb224-87"><a href="data_fusion.html#cb224-87" tabindex="-1"></a><span class="co"># patchwork</span></span>
<span id="cb224-88"><a href="data_fusion.html#cb224-88" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb224-89"><a href="data_fusion.html#cb224-89" tabindex="-1"></a>  plt_list_temp</span>
<span id="cb224-90"><a href="data_fusion.html#cb224-90" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">3</span></span>
<span id="cb224-91"><a href="data_fusion.html#cb224-91" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-264-1.png" alt="" width="1008" /></p>
<div id="voting-system" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Voting System<a href="data_fusion.html#voting-system" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s consider a voting system approach for filtering candidate slash piles using the multiple spectral indices. a voting system could allow for a more robust and nuanced decision than relying on a single index.</p>
<p>let’s make a highly specialized function using the data returned by out <code>extract_rast_values()</code> function</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="data_fusion.html#cb225-1" tabindex="-1"></a><span class="do">##########################################################</span></span>
<span id="cb225-2"><a href="data_fusion.html#cb225-2" tabindex="-1"></a><span class="do">#### function to validate threshold vector or list pair</span></span>
<span id="cb225-3"><a href="data_fusion.html#cb225-3" tabindex="-1"></a><span class="do">##########################################################</span></span>
<span id="cb225-4"><a href="data_fusion.html#cb225-4" tabindex="-1"></a>validate_thresholds_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(th_list) {</span>
<span id="cb225-5"><a href="data_fusion.html#cb225-5" tabindex="-1"></a>  <span class="co"># input is a list or a numeric vector</span></span>
<span id="cb225-6"><a href="data_fusion.html#cb225-6" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.list</span>(th_list) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.numeric</span>(th_list)) {</span>
<span id="cb225-7"><a href="data_fusion.html#cb225-7" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Validation Error: Input must be a list of pairs or a single numeric vector pair.&quot;</span>)</span>
<span id="cb225-8"><a href="data_fusion.html#cb225-8" tabindex="-1"></a>  }</span>
<span id="cb225-9"><a href="data_fusion.html#cb225-9" tabindex="-1"></a></span>
<span id="cb225-10"><a href="data_fusion.html#cb225-10" tabindex="-1"></a>  <span class="co"># to a list to standardize the purrr::map iteration</span></span>
<span id="cb225-11"><a href="data_fusion.html#cb225-11" tabindex="-1"></a>  items_to_check <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">is.list</span>(th_list)){</span>
<span id="cb225-12"><a href="data_fusion.html#cb225-12" tabindex="-1"></a>    th_list</span>
<span id="cb225-13"><a href="data_fusion.html#cb225-13" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb225-14"><a href="data_fusion.html#cb225-14" tabindex="-1"></a>    <span class="fu">list</span>(th_list)</span>
<span id="cb225-15"><a href="data_fusion.html#cb225-15" tabindex="-1"></a>  }</span>
<span id="cb225-16"><a href="data_fusion.html#cb225-16" tabindex="-1"></a></span>
<span id="cb225-17"><a href="data_fusion.html#cb225-17" tabindex="-1"></a>  <span class="co"># validate logic on each pair</span></span>
<span id="cb225-18"><a href="data_fusion.html#cb225-18" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(items_to_check, <span class="cf">function</span>(x) {</span>
<span id="cb225-19"><a href="data_fusion.html#cb225-19" tabindex="-1"></a>    <span class="co"># numeric type</span></span>
<span id="cb225-20"><a href="data_fusion.html#cb225-20" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(x)) {</span>
<span id="cb225-21"><a href="data_fusion.html#cb225-21" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Validation Error: Threshold elements must be numeric.&quot;</span>)</span>
<span id="cb225-22"><a href="data_fusion.html#cb225-22" tabindex="-1"></a>    }</span>
<span id="cb225-23"><a href="data_fusion.html#cb225-23" tabindex="-1"></a>    </span>
<span id="cb225-24"><a href="data_fusion.html#cb225-24" tabindex="-1"></a>    <span class="co"># length is exactly 2</span></span>
<span id="cb225-25"><a href="data_fusion.html#cb225-25" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">!=</span> <span class="dv">2</span>) {</span>
<span id="cb225-26"><a href="data_fusion.html#cb225-26" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">&quot;Validation Error: Pair must have exactly 2 values. Found length:&quot;</span>, <span class="fu">length</span>(x)))</span>
<span id="cb225-27"><a href="data_fusion.html#cb225-27" tabindex="-1"></a>    }</span>
<span id="cb225-28"><a href="data_fusion.html#cb225-28" tabindex="-1"></a>    </span>
<span id="cb225-29"><a href="data_fusion.html#cb225-29" tabindex="-1"></a>    <span class="co"># order (lower &lt; upper)</span></span>
<span id="cb225-30"><a href="data_fusion.html#cb225-30" tabindex="-1"></a>    <span class="cf">if</span> (x[<span class="dv">1</span>] <span class="sc">&gt;=</span> x[<span class="dv">2</span>]) {</span>
<span id="cb225-31"><a href="data_fusion.html#cb225-31" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Validation Error: Lower limit must be smaller than upper limit. Found: [&quot;</span>, x[<span class="dv">1</span>], <span class="st">&quot;, &quot;</span>, x[<span class="dv">2</span>], <span class="st">&quot;]&quot;</span>))</span>
<span id="cb225-32"><a href="data_fusion.html#cb225-32" tabindex="-1"></a>    }</span>
<span id="cb225-33"><a href="data_fusion.html#cb225-33" tabindex="-1"></a>  })</span>
<span id="cb225-34"><a href="data_fusion.html#cb225-34" tabindex="-1"></a></span>
<span id="cb225-35"><a href="data_fusion.html#cb225-35" tabindex="-1"></a>  <span class="co"># 4. If all checks passed (no stop triggered), return the original input</span></span>
<span id="cb225-36"><a href="data_fusion.html#cb225-36" tabindex="-1"></a>  <span class="fu">return</span>(th_list)</span>
<span id="cb225-37"><a href="data_fusion.html#cb225-37" tabindex="-1"></a>}</span>
<span id="cb225-38"><a href="data_fusion.html#cb225-38" tabindex="-1"></a></span>
<span id="cb225-39"><a href="data_fusion.html#cb225-39" tabindex="-1"></a><span class="do">##########################################################</span></span>
<span id="cb225-40"><a href="data_fusion.html#cb225-40" tabindex="-1"></a><span class="co"># function to filter a data frame by a list pair and column</span></span>
<span id="cb225-41"><a href="data_fusion.html#cb225-41" tabindex="-1"></a><span class="do">##########################################################</span></span>
<span id="cb225-42"><a href="data_fusion.html#cb225-42" tabindex="-1"></a>filter_by_thresholds_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(df, target_col, th_list) {</span>
<span id="cb225-43"><a href="data_fusion.html#cb225-43" tabindex="-1"></a>  <span class="co"># col exists?</span></span>
<span id="cb225-44"><a href="data_fusion.html#cb225-44" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(target_col <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb225-45"><a href="data_fusion.html#cb225-45" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Column &#39;&quot;</span>, target_col, <span class="st">&quot;&#39; not found in the data frame&quot;</span>))</span>
<span id="cb225-46"><a href="data_fusion.html#cb225-46" tabindex="-1"></a>  }</span>
<span id="cb225-47"><a href="data_fusion.html#cb225-47" tabindex="-1"></a>  </span>
<span id="cb225-48"><a href="data_fusion.html#cb225-48" tabindex="-1"></a>  <span class="co"># validate the thresholds using previous function</span></span>
<span id="cb225-49"><a href="data_fusion.html#cb225-49" tabindex="-1"></a>  valid_th <span class="ot">&lt;-</span> <span class="fu">validate_thresholds_fn</span>(th_list)</span>
<span id="cb225-50"><a href="data_fusion.html#cb225-50" tabindex="-1"></a>  </span>
<span id="cb225-51"><a href="data_fusion.html#cb225-51" tabindex="-1"></a>  <span class="co"># thresholds to a list if a single vector was provided</span></span>
<span id="cb225-52"><a href="data_fusion.html#cb225-52" tabindex="-1"></a>  th_pairs <span class="ot">&lt;-</span> </span>
<span id="cb225-53"><a href="data_fusion.html#cb225-53" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.list</span>(valid_th)){</span>
<span id="cb225-54"><a href="data_fusion.html#cb225-54" tabindex="-1"></a>      valid_th</span>
<span id="cb225-55"><a href="data_fusion.html#cb225-55" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb225-56"><a href="data_fusion.html#cb225-56" tabindex="-1"></a>      <span class="fu">list</span>(valid_th)</span>
<span id="cb225-57"><a href="data_fusion.html#cb225-57" tabindex="-1"></a>    }</span>
<span id="cb225-58"><a href="data_fusion.html#cb225-58" tabindex="-1"></a>  </span>
<span id="cb225-59"><a href="data_fusion.html#cb225-59" tabindex="-1"></a>  <span class="co"># use purrr::map to create a list of logical vectors (one for each pair)</span></span>
<span id="cb225-60"><a href="data_fusion.html#cb225-60" tabindex="-1"></a>  <span class="co"># then reduce them with &#39;|&#39; so any row hitting any range is kept</span></span>
<span id="cb225-61"><a href="data_fusion.html#cb225-61" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb225-62"><a href="data_fusion.html#cb225-62" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb225-63"><a href="data_fusion.html#cb225-63" tabindex="-1"></a>      <span class="at">is_inrange =</span> purrr<span class="sc">::</span><span class="fu">map</span>(th_pairs, <span class="cf">function</span>(x) {</span>
<span id="cb225-64"><a href="data_fusion.html#cb225-64" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">between</span>(.data[[target_col]], x[<span class="dv">1</span>], x[<span class="dv">2</span>])</span>
<span id="cb225-65"><a href="data_fusion.html#cb225-65" tabindex="-1"></a>      }) <span class="sc">%&gt;%</span></span>
<span id="cb225-66"><a href="data_fusion.html#cb225-66" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">reduce</span>(<span class="st">`</span><span class="at">|</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb225-67"><a href="data_fusion.html#cb225-67" tabindex="-1"></a>      <span class="fu">as.integer</span>()</span>
<span id="cb225-68"><a href="data_fusion.html#cb225-68" tabindex="-1"></a>    )</span>
<span id="cb225-69"><a href="data_fusion.html#cb225-69" tabindex="-1"></a>    <span class="co"># dplyr::filter(</span></span>
<span id="cb225-70"><a href="data_fusion.html#cb225-70" tabindex="-1"></a>    <span class="co">#   purrr::map(</span></span>
<span id="cb225-71"><a href="data_fusion.html#cb225-71" tabindex="-1"></a>    <span class="co">#     th_pairs</span></span>
<span id="cb225-72"><a href="data_fusion.html#cb225-72" tabindex="-1"></a>    <span class="co">#     , function(x) {</span></span>
<span id="cb225-73"><a href="data_fusion.html#cb225-73" tabindex="-1"></a>    <span class="co">#       dplyr::between(.data[[target_col]], x[1], x[2])</span></span>
<span id="cb225-74"><a href="data_fusion.html#cb225-74" tabindex="-1"></a>    <span class="co">#     }</span></span>
<span id="cb225-75"><a href="data_fusion.html#cb225-75" tabindex="-1"></a>    <span class="co">#   ) %&gt;%</span></span>
<span id="cb225-76"><a href="data_fusion.html#cb225-76" tabindex="-1"></a>    <span class="co">#   purrr::reduce(`|`)</span></span>
<span id="cb225-77"><a href="data_fusion.html#cb225-77" tabindex="-1"></a>    <span class="co"># )</span></span>
<span id="cb225-78"><a href="data_fusion.html#cb225-78" tabindex="-1"></a>}</span>
<span id="cb225-79"><a href="data_fusion.html#cb225-79" tabindex="-1"></a></span>
<span id="cb225-80"><a href="data_fusion.html#cb225-80" tabindex="-1"></a><span class="co"># filter_by_thresholds_fn(</span></span>
<span id="cb225-81"><a href="data_fusion.html#cb225-81" tabindex="-1"></a><span class="co">#   rgb_indices_df</span></span>
<span id="cb225-82"><a href="data_fusion.html#cb225-82" tabindex="-1"></a><span class="co">#   , target_col = &quot;rast_agg_hsv_hue&quot;</span></span>
<span id="cb225-83"><a href="data_fusion.html#cb225-83" tabindex="-1"></a><span class="co">#   # , th_list = c(275,Inf)</span></span>
<span id="cb225-84"><a href="data_fusion.html#cb225-84" tabindex="-1"></a><span class="co">#   , th_list = list(c(0,210), c(275,Inf))</span></span>
<span id="cb225-85"><a href="data_fusion.html#cb225-85" tabindex="-1"></a><span class="co">#   # , th_list = c(275,207)</span></span>
<span id="cb225-86"><a href="data_fusion.html#cb225-86" tabindex="-1"></a><span class="co"># ) %&gt;% </span></span>
<span id="cb225-87"><a href="data_fusion.html#cb225-87" tabindex="-1"></a><span class="co"># ggplot2::ggplot(aes(x=rast_agg_hsv_hue,y=0,color=as.factor(is_inrange))) + ggplot2::geom_jitter()</span></span>
<span id="cb225-88"><a href="data_fusion.html#cb225-88" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb225-89"><a href="data_fusion.html#cb225-89" tabindex="-1"></a><span class="co"># filter_by_thresholds_fn(</span></span>
<span id="cb225-90"><a href="data_fusion.html#cb225-90" tabindex="-1"></a><span class="co">#   rgb_indices_df</span></span>
<span id="cb225-91"><a href="data_fusion.html#cb225-91" tabindex="-1"></a><span class="co">#   , target_col = &quot;rast_agg_hsv_hue&quot;</span></span>
<span id="cb225-92"><a href="data_fusion.html#cb225-92" tabindex="-1"></a><span class="co">#   # , th_list = c(275,Inf)</span></span>
<span id="cb225-93"><a href="data_fusion.html#cb225-93" tabindex="-1"></a><span class="co">#   , th_list = list(c(0,210), c(275,Inf))</span></span>
<span id="cb225-94"><a href="data_fusion.html#cb225-94" tabindex="-1"></a><span class="co">#   # , th_list = c(275,207)</span></span>
<span id="cb225-95"><a href="data_fusion.html#cb225-95" tabindex="-1"></a><span class="co"># ) %&gt;% </span></span>
<span id="cb225-96"><a href="data_fusion.html#cb225-96" tabindex="-1"></a><span class="co"># dplyr::glimpse()</span></span>
<span id="cb225-97"><a href="data_fusion.html#cb225-97" tabindex="-1"></a></span>
<span id="cb225-98"><a href="data_fusion.html#cb225-98" tabindex="-1"></a><span class="co"># voting system</span></span>
<span id="cb225-99"><a href="data_fusion.html#cb225-99" tabindex="-1"></a>rgb_indices_threshold_voting <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb225-100"><a href="data_fusion.html#cb225-100" tabindex="-1"></a>  rgb_indices_df</span>
<span id="cb225-101"><a href="data_fusion.html#cb225-101" tabindex="-1"></a>  <span class="co"># define ranges to *keep* piles</span></span>
<span id="cb225-102"><a href="data_fusion.html#cb225-102" tabindex="-1"></a>  , <span class="at">th_grvi =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="dv">0</span>)</span>
<span id="cb225-103"><a href="data_fusion.html#cb225-103" tabindex="-1"></a>  , <span class="at">th_rgri =</span> <span class="fu">c</span>((<span class="fl">0.7+0.001</span>),<span class="cn">Inf</span>) <span class="co"># increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb225-104"><a href="data_fusion.html#cb225-104" tabindex="-1"></a>  , <span class="at">th_vdvi =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,(<span class="fl">0.03+0.001</span>)) <span class="co"># increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb225-105"><a href="data_fusion.html#cb225-105" tabindex="-1"></a>  , <span class="at">th_exgr =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="dv">0</span>)</span>
<span id="cb225-106"><a href="data_fusion.html#cb225-106" tabindex="-1"></a>  , <span class="at">th_a =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="fl">+0.001</span>,<span class="cn">Inf</span>)</span>
<span id="cb225-107"><a href="data_fusion.html#cb225-107" tabindex="-1"></a>  , <span class="at">th_hue =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">50</span><span class="fl">-0.001</span>), <span class="fu">c</span>(<span class="dv">150</span><span class="fl">+0.001</span>,<span class="cn">Inf</span>))</span>
<span id="cb225-108"><a href="data_fusion.html#cb225-108" tabindex="-1"></a>){</span>
<span id="cb225-109"><a href="data_fusion.html#cb225-109" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb225-110"><a href="data_fusion.html#cb225-110" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rgb_indices_df, <span class="st">&quot;data.frame&quot;</span>)){</span>
<span id="cb225-111"><a href="data_fusion.html#cb225-111" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Input `rgb_indices_df` must be an data.frame.&quot;</span>)</span>
<span id="cb225-112"><a href="data_fusion.html#cb225-112" tabindex="-1"></a>  }</span>
<span id="cb225-113"><a href="data_fusion.html#cb225-113" tabindex="-1"></a>  <span class="co"># names</span></span>
<span id="cb225-114"><a href="data_fusion.html#cb225-114" tabindex="-1"></a>  agg_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;rast_agg_grvi&quot;</span>,<span class="st">&quot;rast_agg_exgr&quot;</span>,<span class="st">&quot;rast_agg_rgri&quot;</span>,<span class="st">&quot;rast_agg_vdvi&quot;</span>,<span class="st">&quot;rast_agg_Lab_a&quot;</span>,<span class="st">&quot;rast_agg_hsv_hue&quot;</span>) <span class="co"># &quot;rast_agg_rgbvi&quot;,</span></span>
<span id="cb225-115"><a href="data_fusion.html#cb225-115" tabindex="-1"></a>  nm_diff <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">setdiff</span>(</span>
<span id="cb225-116"><a href="data_fusion.html#cb225-116" tabindex="-1"></a>    agg_cols</span>
<span id="cb225-117"><a href="data_fusion.html#cb225-117" tabindex="-1"></a>    , <span class="fu">names</span>(rgb_indices_df)</span>
<span id="cb225-118"><a href="data_fusion.html#cb225-118" tabindex="-1"></a>  )</span>
<span id="cb225-119"><a href="data_fusion.html#cb225-119" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(nm_diff)<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb225-120"><a href="data_fusion.html#cb225-120" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;required variables missing:</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;... &quot;</span>, <span class="fu">paste</span>(nm_diff, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>) ))</span>
<span id="cb225-121"><a href="data_fusion.html#cb225-121" tabindex="-1"></a>  }</span>
<span id="cb225-122"><a href="data_fusion.html#cb225-122" tabindex="-1"></a>  <span class="co"># thresholds</span></span>
<span id="cb225-123"><a href="data_fusion.html#cb225-123" tabindex="-1"></a>  safe_validate_thresholds_fn <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(validate_thresholds_fn)</span>
<span id="cb225-124"><a href="data_fusion.html#cb225-124" tabindex="-1"></a>    <span class="co"># th_grvi</span></span>
<span id="cb225-125"><a href="data_fusion.html#cb225-125" tabindex="-1"></a>    chk_grvi <span class="ot">&lt;-</span> <span class="fu">safe_validate_thresholds_fn</span>(th_grvi)</span>
<span id="cb225-126"><a href="data_fusion.html#cb225-126" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(chk_grvi<span class="sc">$</span>result)){</span>
<span id="cb225-127"><a href="data_fusion.html#cb225-127" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Input `th_grvi`: &quot;</span>, chk_grvi<span class="sc">$</span>error))</span>
<span id="cb225-128"><a href="data_fusion.html#cb225-128" tabindex="-1"></a>    }</span>
<span id="cb225-129"><a href="data_fusion.html#cb225-129" tabindex="-1"></a>    <span class="co"># th_rgri</span></span>
<span id="cb225-130"><a href="data_fusion.html#cb225-130" tabindex="-1"></a>    chk_rgri <span class="ot">&lt;-</span> <span class="fu">safe_validate_thresholds_fn</span>(th_rgri)</span>
<span id="cb225-131"><a href="data_fusion.html#cb225-131" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(chk_rgri<span class="sc">$</span>result)){</span>
<span id="cb225-132"><a href="data_fusion.html#cb225-132" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Input `th_rgri`: &quot;</span>, chk_rgri<span class="sc">$</span>error))</span>
<span id="cb225-133"><a href="data_fusion.html#cb225-133" tabindex="-1"></a>    }</span>
<span id="cb225-134"><a href="data_fusion.html#cb225-134" tabindex="-1"></a>    <span class="co"># th_vdvi</span></span>
<span id="cb225-135"><a href="data_fusion.html#cb225-135" tabindex="-1"></a>    chk_vdvi <span class="ot">&lt;-</span> <span class="fu">safe_validate_thresholds_fn</span>(th_vdvi)</span>
<span id="cb225-136"><a href="data_fusion.html#cb225-136" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(chk_vdvi<span class="sc">$</span>result)){</span>
<span id="cb225-137"><a href="data_fusion.html#cb225-137" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Input `th_vdvi`: &quot;</span>, chk_vdvi<span class="sc">$</span>error))</span>
<span id="cb225-138"><a href="data_fusion.html#cb225-138" tabindex="-1"></a>    }</span>
<span id="cb225-139"><a href="data_fusion.html#cb225-139" tabindex="-1"></a>    <span class="co"># th_exgr</span></span>
<span id="cb225-140"><a href="data_fusion.html#cb225-140" tabindex="-1"></a>    chk_exgr <span class="ot">&lt;-</span> <span class="fu">safe_validate_thresholds_fn</span>(th_exgr)</span>
<span id="cb225-141"><a href="data_fusion.html#cb225-141" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(chk_exgr<span class="sc">$</span>result)){</span>
<span id="cb225-142"><a href="data_fusion.html#cb225-142" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Input `th_exgr`: &quot;</span>, chk_exgr<span class="sc">$</span>error))</span>
<span id="cb225-143"><a href="data_fusion.html#cb225-143" tabindex="-1"></a>    }</span>
<span id="cb225-144"><a href="data_fusion.html#cb225-144" tabindex="-1"></a>    <span class="co"># th_a</span></span>
<span id="cb225-145"><a href="data_fusion.html#cb225-145" tabindex="-1"></a>    chk_a <span class="ot">&lt;-</span> <span class="fu">safe_validate_thresholds_fn</span>(th_a)</span>
<span id="cb225-146"><a href="data_fusion.html#cb225-146" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(chk_a<span class="sc">$</span>result)){</span>
<span id="cb225-147"><a href="data_fusion.html#cb225-147" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Input `th_a`: &quot;</span>, chk_a<span class="sc">$</span>error))</span>
<span id="cb225-148"><a href="data_fusion.html#cb225-148" tabindex="-1"></a>    }</span>
<span id="cb225-149"><a href="data_fusion.html#cb225-149" tabindex="-1"></a>    <span class="co"># th_hue</span></span>
<span id="cb225-150"><a href="data_fusion.html#cb225-150" tabindex="-1"></a>    chk_hue <span class="ot">&lt;-</span> <span class="fu">safe_validate_thresholds_fn</span>(th_hue)</span>
<span id="cb225-151"><a href="data_fusion.html#cb225-151" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(chk_hue<span class="sc">$</span>result)){</span>
<span id="cb225-152"><a href="data_fusion.html#cb225-152" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;Input `th_hue`: &quot;</span>, chk_hue<span class="sc">$</span>error))</span>
<span id="cb225-153"><a href="data_fusion.html#cb225-153" tabindex="-1"></a>    }</span>
<span id="cb225-154"><a href="data_fusion.html#cb225-154" tabindex="-1"></a>  </span>
<span id="cb225-155"><a href="data_fusion.html#cb225-155" tabindex="-1"></a>  <span class="co"># get rid of columns we&#39;ll create</span></span>
<span id="cb225-156"><a href="data_fusion.html#cb225-156" tabindex="-1"></a>  rgb_indices_df <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span></span>
<span id="cb225-157"><a href="data_fusion.html#cb225-157" tabindex="-1"></a>    <span class="co"># throw in hey_xxxxxxxxxx to test it works if we include non-existant columns</span></span>
<span id="cb225-158"><a href="data_fusion.html#cb225-158" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb225-159"><a href="data_fusion.html#cb225-159" tabindex="-1"></a>      <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb225-160"><a href="data_fusion.html#cb225-160" tabindex="-1"></a>      , <span class="st">&quot;is_inrange&quot;</span></span>
<span id="cb225-161"><a href="data_fusion.html#cb225-161" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_grvi&quot;</span></span>
<span id="cb225-162"><a href="data_fusion.html#cb225-162" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_rgri&quot;</span></span>
<span id="cb225-163"><a href="data_fusion.html#cb225-163" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_vdvi&quot;</span></span>
<span id="cb225-164"><a href="data_fusion.html#cb225-164" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_exgr&quot;</span></span>
<span id="cb225-165"><a href="data_fusion.html#cb225-165" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_Lab_a&quot;</span></span>
<span id="cb225-166"><a href="data_fusion.html#cb225-166" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_hsv_hue&quot;</span></span>
<span id="cb225-167"><a href="data_fusion.html#cb225-167" tabindex="-1"></a>    )))</span>
<span id="cb225-168"><a href="data_fusion.html#cb225-168" tabindex="-1"></a>  </span>
<span id="cb225-169"><a href="data_fusion.html#cb225-169" tabindex="-1"></a>  <span class="co"># check threshold</span></span>
<span id="cb225-170"><a href="data_fusion.html#cb225-170" tabindex="-1"></a>  ret_df <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb225-171"><a href="data_fusion.html#cb225-171" tabindex="-1"></a>    <span class="fu">filter_by_thresholds_fn</span>(<span class="at">target_col =</span> <span class="st">&quot;rast_agg_grvi&quot;</span>, <span class="at">th_list =</span> th_grvi) <span class="sc">%&gt;%</span> </span>
<span id="cb225-172"><a href="data_fusion.html#cb225-172" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">inrange_th_grvi=</span>is_inrange) <span class="sc">%&gt;%</span> </span>
<span id="cb225-173"><a href="data_fusion.html#cb225-173" tabindex="-1"></a>    <span class="fu">filter_by_thresholds_fn</span>(<span class="at">target_col =</span> <span class="st">&quot;rast_agg_rgri&quot;</span>, <span class="at">th_list =</span> th_rgri) <span class="sc">%&gt;%</span> </span>
<span id="cb225-174"><a href="data_fusion.html#cb225-174" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">inrange_th_rgri=</span>is_inrange) <span class="sc">%&gt;%</span> </span>
<span id="cb225-175"><a href="data_fusion.html#cb225-175" tabindex="-1"></a>    <span class="fu">filter_by_thresholds_fn</span>(<span class="at">target_col =</span> <span class="st">&quot;rast_agg_vdvi&quot;</span>, <span class="at">th_list =</span> th_vdvi) <span class="sc">%&gt;%</span> </span>
<span id="cb225-176"><a href="data_fusion.html#cb225-176" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">inrange_th_vdvi=</span>is_inrange) <span class="sc">%&gt;%</span> </span>
<span id="cb225-177"><a href="data_fusion.html#cb225-177" tabindex="-1"></a>    <span class="fu">filter_by_thresholds_fn</span>(<span class="at">target_col =</span> <span class="st">&quot;rast_agg_exgr&quot;</span>, <span class="at">th_list =</span> th_exgr) <span class="sc">%&gt;%</span> </span>
<span id="cb225-178"><a href="data_fusion.html#cb225-178" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">inrange_th_exgr=</span>is_inrange) <span class="sc">%&gt;%</span> </span>
<span id="cb225-179"><a href="data_fusion.html#cb225-179" tabindex="-1"></a>    <span class="fu">filter_by_thresholds_fn</span>(<span class="at">target_col =</span> <span class="st">&quot;rast_agg_Lab_a&quot;</span>, <span class="at">th_list =</span> th_a) <span class="sc">%&gt;%</span> </span>
<span id="cb225-180"><a href="data_fusion.html#cb225-180" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">inrange_th_Lab_a=</span>is_inrange) <span class="sc">%&gt;%</span> </span>
<span id="cb225-181"><a href="data_fusion.html#cb225-181" tabindex="-1"></a>    <span class="fu">filter_by_thresholds_fn</span>(<span class="at">target_col =</span> <span class="st">&quot;rast_agg_hsv_hue&quot;</span>, <span class="at">th_list =</span> th_hue) <span class="sc">%&gt;%</span> </span>
<span id="cb225-182"><a href="data_fusion.html#cb225-182" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">inrange_th_hsv_hue=</span>is_inrange) <span class="sc">%&gt;%</span> </span>
<span id="cb225-183"><a href="data_fusion.html#cb225-183" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb225-184"><a href="data_fusion.html#cb225-184" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb225-185"><a href="data_fusion.html#cb225-185" tabindex="-1"></a>      <span class="at">inrange_th_votes =</span> <span class="fu">sum</span>(</span>
<span id="cb225-186"><a href="data_fusion.html#cb225-186" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">c_across</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>))</span>
<span id="cb225-187"><a href="data_fusion.html#cb225-187" tabindex="-1"></a>        , <span class="at">na.rm =</span> T</span>
<span id="cb225-188"><a href="data_fusion.html#cb225-188" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb225-189"><a href="data_fusion.html#cb225-189" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="dv">0</span>)</span>
<span id="cb225-190"><a href="data_fusion.html#cb225-190" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb225-191"><a href="data_fusion.html#cb225-191" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb225-192"><a href="data_fusion.html#cb225-192" tabindex="-1"></a>  </span>
<span id="cb225-193"><a href="data_fusion.html#cb225-193" tabindex="-1"></a>  <span class="co">#return</span></span>
<span id="cb225-194"><a href="data_fusion.html#cb225-194" tabindex="-1"></a>  <span class="fu">return</span>(ret_df)</span>
<span id="cb225-195"><a href="data_fusion.html#cb225-195" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s look at the columns we get from our <code>rgb_indices_threshold_voting()</code> function</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="data_fusion.html#cb226-1" tabindex="-1"></a>rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">rgb_indices_threshold_voting</span>(<span class="at">rgb_indices_df=</span>rgb_indices_df)</span>
<span id="cb226-2"><a href="data_fusion.html#cb226-2" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb226-3"><a href="data_fusion.html#cb226-3" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb226-4"><a href="data_fusion.html#cb226-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb226-5"><a href="data_fusion.html#cb226-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb226-6"><a href="data_fusion.html#cb226-6" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##  inrange_th_grvi  inrange_th_rgri inrange_th_vdvi inrange_th_exgr
##  Min.   :0.0000   Min.   :1       Min.   :1       Min.   :1      
##  1st Qu.:0.0000   1st Qu.:1       1st Qu.:1       1st Qu.:1      
##  Median :1.0000   Median :1       Median :1       Median :1      
##  Mean   :0.7059   Mean   :1       Mean   :1       Mean   :1      
##  3rd Qu.:1.0000   3rd Qu.:1       3rd Qu.:1       3rd Qu.:1      
##  Max.   :1.0000   Max.   :1       Max.   :1       Max.   :1      
##  inrange_th_Lab_a inrange_th_hsv_hue inrange_th_votes
##  Min.   :1        Min.   :1          Min.   :5.000   
##  1st Qu.:1        1st Qu.:1          1st Qu.:5.000   
##  Median :1        Median :1          Median :6.000   
##  Mean   :1        Mean   :1          Mean   :5.706   
##  3rd Qu.:1        3rd Qu.:1          3rd Qu.:6.000   
##  Max.   :1        Max.   :1          Max.   :6.000</code></pre>
<p>notice the “Mean” value in the summary above is the proportion of demonstration piles that successfully met the spectral index threshold criteria (i.e. piles to be “kept”). it looks like the GRVI threshold was most unaligned with these demonstration piles, something we anticipated by looking at the distributions above compared the threshold value recommended in the literature for detecting green vegetation.</p>
<p>let’s look at the proportional distribution of demonstration piles meeting the threshold by individual spectral index</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="data_fusion.html#cb228-1" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb228-2"><a href="data_fusion.html#cb228-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb228-3"><a href="data_fusion.html#cb228-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb228-4"><a href="data_fusion.html#cb228-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb228-5"><a href="data_fusion.html#cb228-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;inrange_th_&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_upper</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb228-6"><a href="data_fusion.html#cb228-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">!=</span><span class="st">&quot;VOTES&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb228-7"><a href="data_fusion.html#cb228-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(name,value) <span class="sc">%&gt;%</span> </span>
<span id="cb228-8"><a href="data_fusion.html#cb228-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb228-9"><a href="data_fusion.html#cb228-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb228-10"><a href="data_fusion.html#cb228-10" tabindex="-1"></a>    <span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)</span>
<span id="cb228-11"><a href="data_fusion.html#cb228-11" tabindex="-1"></a>    , <span class="at">value =</span> <span class="fu">factor</span>(value, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;outside threshold&quot;</span>,<span class="st">&quot;within threshold&quot;</span>), <span class="at">ordered =</span> T)</span>
<span id="cb228-12"><a href="data_fusion.html#cb228-12" tabindex="-1"></a>    , <span class="at">lab =</span> <span class="fu">paste0</span>(scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">(n=&quot;</span>, scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb228-13"><a href="data_fusion.html#cb228-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb228-14"><a href="data_fusion.html#cb228-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb228-15"><a href="data_fusion.html#cb228-15" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> pct, <span class="at">label =</span> lab, <span class="at">fill =</span> value)</span>
<span id="cb228-16"><a href="data_fusion.html#cb228-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb228-17"><a href="data_fusion.html#cb228-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(</span>
<span id="cb228-18"><a href="data_fusion.html#cb228-18" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">0.6</span></span>
<span id="cb228-19"><a href="data_fusion.html#cb228-19" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb228-20"><a href="data_fusion.html#cb228-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb228-21"><a href="data_fusion.html#cb228-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb228-22"><a href="data_fusion.html#cb228-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>, <span class="at">begin =</span> <span class="fl">0.3</span>, <span class="at">end =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb228-23"><a href="data_fusion.html#cb228-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb228-24"><a href="data_fusion.html#cb228-24" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.2</span>)</span>
<span id="cb228-25"><a href="data_fusion.html#cb228-25" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb228-26"><a href="data_fusion.html#cb228-26" tabindex="-1"></a>    , <span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb228-27"><a href="data_fusion.html#cb228-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb228-28"><a href="data_fusion.html#cb228-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb228-29"><a href="data_fusion.html#cb228-29" tabindex="-1"></a>    <span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)</span>
<span id="cb228-30"><a href="data_fusion.html#cb228-30" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb228-31"><a href="data_fusion.html#cb228-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb228-32"><a href="data_fusion.html#cb228-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb228-33"><a href="data_fusion.html#cb228-33" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb228-34"><a href="data_fusion.html#cb228-34" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb228-35"><a href="data_fusion.html#cb228-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb228-36"><a href="data_fusion.html#cb228-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb228-37"><a href="data_fusion.html#cb228-37" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb228-38"><a href="data_fusion.html#cb228-38" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb228-39"><a href="data_fusion.html#cb228-39" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb228-40"><a href="data_fusion.html#cb228-40" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb228-41"><a href="data_fusion.html#cb228-41" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-269-1.png" alt="" width="1008" /></p>
<p>and let’s look at the distribution of demonstration piles based on the number of individual spectral index thresholds met. we’ll use this count as our voting system.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="data_fusion.html#cb229-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">value=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb229-2"><a href="data_fusion.html#cb229-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb229-3"><a href="data_fusion.html#cb229-3" tabindex="-1"></a>    rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb229-4"><a href="data_fusion.html#cb229-4" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb229-5"><a href="data_fusion.html#cb229-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_votes&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb229-6"><a href="data_fusion.html#cb229-6" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb229-7"><a href="data_fusion.html#cb229-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;inrange_th_&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_upper</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb229-8"><a href="data_fusion.html#cb229-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">count</span>(name,value)</span>
<span id="cb229-9"><a href="data_fusion.html#cb229-9" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(value)</span>
<span id="cb229-10"><a href="data_fusion.html#cb229-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb229-11"><a href="data_fusion.html#cb229-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb229-12"><a href="data_fusion.html#cb229-12" tabindex="-1"></a>    <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(n,<span class="dv">0</span>)</span>
<span id="cb229-13"><a href="data_fusion.html#cb229-13" tabindex="-1"></a>    , <span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)</span>
<span id="cb229-14"><a href="data_fusion.html#cb229-14" tabindex="-1"></a>    , <span class="at">lab =</span> <span class="fu">paste0</span>(scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">(n=&quot;</span>, scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb229-15"><a href="data_fusion.html#cb229-15" tabindex="-1"></a>    , <span class="at">value =</span> <span class="fu">factor</span>(value)</span>
<span id="cb229-16"><a href="data_fusion.html#cb229-16" tabindex="-1"></a>    , <span class="at">cum_pct =</span> <span class="fu">cumsum</span>(pct)</span>
<span id="cb229-17"><a href="data_fusion.html#cb229-17" tabindex="-1"></a>    , <span class="at">cum_pct_lab =</span> scales<span class="sc">::</span><span class="fu">percent</span>(cum_pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb229-18"><a href="data_fusion.html#cb229-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb229-19"><a href="data_fusion.html#cb229-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb229-20"><a href="data_fusion.html#cb229-20" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> pct, <span class="at">label =</span> lab, <span class="at">fill =</span> value)</span>
<span id="cb229-21"><a href="data_fusion.html#cb229-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb229-22"><a href="data_fusion.html#cb229-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(</span>
<span id="cb229-23"><a href="data_fusion.html#cb229-23" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">0.6</span></span>
<span id="cb229-24"><a href="data_fusion.html#cb229-24" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb229-25"><a href="data_fusion.html#cb229-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb229-26"><a href="data_fusion.html#cb229-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb229-27"><a href="data_fusion.html#cb229-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;mako&quot;</span>, <span class="at">direction=</span><span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb229-28"><a href="data_fusion.html#cb229-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb229-29"><a href="data_fusion.html#cb229-29" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb229-30"><a href="data_fusion.html#cb229-30" tabindex="-1"></a>    , <span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.15</span>))</span>
<span id="cb229-31"><a href="data_fusion.html#cb229-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb229-32"><a href="data_fusion.html#cb229-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb229-33"><a href="data_fusion.html#cb229-33" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;spectral index threshold votes&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb229-34"><a href="data_fusion.html#cb229-34" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;distribution of demonstration piles meeting spectral index thresholds&quot;</span></span>
<span id="cb229-35"><a href="data_fusion.html#cb229-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb229-36"><a href="data_fusion.html#cb229-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb229-37"><a href="data_fusion.html#cb229-37" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb229-38"><a href="data_fusion.html#cb229-38" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb229-39"><a href="data_fusion.html#cb229-39" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb229-40"><a href="data_fusion.html#cb229-40" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb229-41"><a href="data_fusion.html#cb229-41" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-270-1.png" alt="" width="1008" /></p>
<p>we can use this spectral index voting system to filter candidate slash piles with a user-defined parameter which defines the sensitivity of filtering based on the spectral information. For example, a value of “6” would heavily weight the spectral information in determining which piles to keep while a value of “1” would put less weight on the spectral data.</p>
</div>
</div>
<div id="polygon_spectral_filtering" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Candidate Polygon Spectral Filtering Function<a href="data_fusion.html#polygon_spectral_filtering" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>let’s put all of this together to define a function that takes as input: 1) a spatial data frame of candidate polygons; 2) a raster with RGB spectral data; 3) user-defined spectral weighting (voting system)</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="data_fusion.html#cb230-1" tabindex="-1"></a>polygon_spectral_filtering <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb230-2"><a href="data_fusion.html#cb230-2" tabindex="-1"></a>  sf_data</span>
<span id="cb230-3"><a href="data_fusion.html#cb230-3" tabindex="-1"></a>  , rgb_rast</span>
<span id="cb230-4"><a href="data_fusion.html#cb230-4" tabindex="-1"></a>  <span class="co"># define the band index</span></span>
<span id="cb230-5"><a href="data_fusion.html#cb230-5" tabindex="-1"></a>  , red_band_idx</span>
<span id="cb230-6"><a href="data_fusion.html#cb230-6" tabindex="-1"></a>  , green_band_idx</span>
<span id="cb230-7"><a href="data_fusion.html#cb230-7" tabindex="-1"></a>  , blue_band_idx</span>
<span id="cb230-8"><a href="data_fusion.html#cb230-8" tabindex="-1"></a>  <span class="co"># spectral weighting</span></span>
<span id="cb230-9"><a href="data_fusion.html#cb230-9" tabindex="-1"></a>  , <span class="at">spectral_weight =</span> <span class="dv">3</span></span>
<span id="cb230-10"><a href="data_fusion.html#cb230-10" tabindex="-1"></a>  <span class="co"># return unfiltered or filtered</span></span>
<span id="cb230-11"><a href="data_fusion.html#cb230-11" tabindex="-1"></a>  , <span class="at">filter_return =</span> T</span>
<span id="cb230-12"><a href="data_fusion.html#cb230-12" tabindex="-1"></a>) {</span>
<span id="cb230-13"><a href="data_fusion.html#cb230-13" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(filter_return,<span class="st">&quot;logical&quot;</span>)){</span>
<span id="cb230-14"><a href="data_fusion.html#cb230-14" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `filter_return` should be logical: T to filter return based on the `spectral_weight` or F to return the full `sf_data`&quot;</span>)</span>
<span id="cb230-15"><a href="data_fusion.html#cb230-15" tabindex="-1"></a>  }</span>
<span id="cb230-16"><a href="data_fusion.html#cb230-16" tabindex="-1"></a>  </span>
<span id="cb230-17"><a href="data_fusion.html#cb230-17" tabindex="-1"></a>  <span class="co"># </span><span class="al">###</span><span class="co"> could make these parameters</span></span>
<span id="cb230-18"><a href="data_fusion.html#cb230-18" tabindex="-1"></a>  <span class="co"># th_grvi &lt;- c(-Inf,0)</span></span>
<span id="cb230-19"><a href="data_fusion.html#cb230-19" tabindex="-1"></a>  <span class="co"># th_rgri &lt;- c((0.7+0.001),Inf) # increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb230-20"><a href="data_fusion.html#cb230-20" tabindex="-1"></a>  <span class="co"># th_vdvi &lt;- c(-Inf,(0.03+0.001)) # increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb230-21"><a href="data_fusion.html#cb230-21" tabindex="-1"></a>  <span class="co"># th_exgr &lt;- c(-Inf,0)</span></span>
<span id="cb230-22"><a href="data_fusion.html#cb230-22" tabindex="-1"></a>  <span class="co"># th_a &lt;- c(-5+0.001,Inf)</span></span>
<span id="cb230-23"><a href="data_fusion.html#cb230-23" tabindex="-1"></a>  <span class="co"># th_hue &lt;- list(c(0,50-0.001), c(150+0.001,Inf))</span></span>
<span id="cb230-24"><a href="data_fusion.html#cb230-24" tabindex="-1"></a>  </span>
<span id="cb230-25"><a href="data_fusion.html#cb230-25" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb230-26"><a href="data_fusion.html#cb230-26" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rgb_rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb230-27"><a href="data_fusion.html#cb230-27" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `rast` must be a SpatRaster object.&quot;</span>)</span>
<span id="cb230-28"><a href="data_fusion.html#cb230-28" tabindex="-1"></a>  }</span>
<span id="cb230-29"><a href="data_fusion.html#cb230-29" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){</span>
<span id="cb230-30"><a href="data_fusion.html#cb230-30" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must be an sf data frame.&quot;</span>)</span>
<span id="cb230-31"><a href="data_fusion.html#cb230-31" tabindex="-1"></a>  }</span>
<span id="cb230-32"><a href="data_fusion.html#cb230-32" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(sf_data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) {</span>
<span id="cb230-33"><a href="data_fusion.html#cb230-33" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must contain polygon geometries.&quot;</span>)</span>
<span id="cb230-34"><a href="data_fusion.html#cb230-34" tabindex="-1"></a>  }</span>
<span id="cb230-35"><a href="data_fusion.html#cb230-35" tabindex="-1"></a>  spectral_weight <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(spectral_weight)</span>
<span id="cb230-36"><a href="data_fusion.html#cb230-36" tabindex="-1"></a>  <span class="cf">if</span>( </span>
<span id="cb230-37"><a href="data_fusion.html#cb230-37" tabindex="-1"></a>    filter_return <span class="sc">&amp;&amp;</span></span>
<span id="cb230-38"><a href="data_fusion.html#cb230-38" tabindex="-1"></a>    (</span>
<span id="cb230-39"><a href="data_fusion.html#cb230-39" tabindex="-1"></a>      <span class="fu">is.na</span>(spectral_weight) <span class="sc">||</span> </span>
<span id="cb230-40"><a href="data_fusion.html#cb230-40" tabindex="-1"></a>      <span class="fu">is.null</span>(spectral_weight) <span class="sc">||</span> </span>
<span id="cb230-41"><a href="data_fusion.html#cb230-41" tabindex="-1"></a>      <span class="fu">is.nan</span>(spectral_weight) <span class="sc">||</span> </span>
<span id="cb230-42"><a href="data_fusion.html#cb230-42" tabindex="-1"></a>      <span class="sc">!</span>(spectral_weight <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>)) </span>
<span id="cb230-43"><a href="data_fusion.html#cb230-43" tabindex="-1"></a>    )</span>
<span id="cb230-44"><a href="data_fusion.html#cb230-44" tabindex="-1"></a>  ){</span>
<span id="cb230-45"><a href="data_fusion.html#cb230-45" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `spectral_weight` must be a number between 0 (no filtering based on spectral) and 6 (highest weighting of spectral data)&quot;</span>)</span>
<span id="cb230-46"><a href="data_fusion.html#cb230-46" tabindex="-1"></a>  }</span>
<span id="cb230-47"><a href="data_fusion.html#cb230-47" tabindex="-1"></a>  <span class="co"># if you don&#39;t want to do it, then why do it?</span></span>
<span id="cb230-48"><a href="data_fusion.html#cb230-48" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb230-49"><a href="data_fusion.html#cb230-49" tabindex="-1"></a>    filter_return <span class="sc">&amp;&amp;</span></span>
<span id="cb230-50"><a href="data_fusion.html#cb230-50" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">coalesce</span>(spectral_weight,<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span></span>
<span id="cb230-51"><a href="data_fusion.html#cb230-51" tabindex="-1"></a>  ){</span>
<span id="cb230-52"><a href="data_fusion.html#cb230-52" tabindex="-1"></a>    <span class="fu">return</span>(sf_data)</span>
<span id="cb230-53"><a href="data_fusion.html#cb230-53" tabindex="-1"></a>  }</span>
<span id="cb230-54"><a href="data_fusion.html#cb230-54" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-55"><a href="data_fusion.html#cb230-55" tabindex="-1"></a>  <span class="co"># calculate_all_rgb_indices</span></span>
<span id="cb230-56"><a href="data_fusion.html#cb230-56" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-57"><a href="data_fusion.html#cb230-57" tabindex="-1"></a>  all_rgb_indices_rast <span class="ot">&lt;-</span> <span class="fu">calculate_all_rgb_indices</span>(</span>
<span id="cb230-58"><a href="data_fusion.html#cb230-58" tabindex="-1"></a>    <span class="at">raster_obj =</span> rgb_rast</span>
<span id="cb230-59"><a href="data_fusion.html#cb230-59" tabindex="-1"></a>    , <span class="at">red_band_idx =</span> red_band_idx</span>
<span id="cb230-60"><a href="data_fusion.html#cb230-60" tabindex="-1"></a>    , <span class="at">green_band_idx =</span> green_band_idx</span>
<span id="cb230-61"><a href="data_fusion.html#cb230-61" tabindex="-1"></a>    , <span class="at">blue_band_idx =</span> blue_band_idx</span>
<span id="cb230-62"><a href="data_fusion.html#cb230-62" tabindex="-1"></a>  )</span>
<span id="cb230-63"><a href="data_fusion.html#cb230-63" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-64"><a href="data_fusion.html#cb230-64" tabindex="-1"></a>  <span class="co"># limit to the indices we have thresholds for</span></span>
<span id="cb230-65"><a href="data_fusion.html#cb230-65" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-66"><a href="data_fusion.html#cb230-66" tabindex="-1"></a>  some_rgb_indices_rast <span class="ot">&lt;-</span> </span>
<span id="cb230-67"><a href="data_fusion.html#cb230-67" tabindex="-1"></a>    all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb230-68"><a href="data_fusion.html#cb230-68" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(</span>
<span id="cb230-69"><a href="data_fusion.html#cb230-69" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb230-70"><a href="data_fusion.html#cb230-70" tabindex="-1"></a>        <span class="st">&quot;grvi&quot;</span></span>
<span id="cb230-71"><a href="data_fusion.html#cb230-71" tabindex="-1"></a>        , <span class="st">&quot;rgri&quot;</span></span>
<span id="cb230-72"><a href="data_fusion.html#cb230-72" tabindex="-1"></a>        , <span class="st">&quot;vdvi&quot;</span></span>
<span id="cb230-73"><a href="data_fusion.html#cb230-73" tabindex="-1"></a>        , <span class="st">&quot;exgr&quot;</span></span>
<span id="cb230-74"><a href="data_fusion.html#cb230-74" tabindex="-1"></a>        , <span class="st">&quot;Lab_a&quot;</span></span>
<span id="cb230-75"><a href="data_fusion.html#cb230-75" tabindex="-1"></a>        , <span class="st">&quot;hsv_hue&quot;</span></span>
<span id="cb230-76"><a href="data_fusion.html#cb230-76" tabindex="-1"></a>      )</span>
<span id="cb230-77"><a href="data_fusion.html#cb230-77" tabindex="-1"></a>    )</span>
<span id="cb230-78"><a href="data_fusion.html#cb230-78" tabindex="-1"></a>  <span class="co"># !!!!!!!!!!!!! convert hsv_hue to 0-360 range !!!!!!!!!!!!!</span></span>
<span id="cb230-79"><a href="data_fusion.html#cb230-79" tabindex="-1"></a>  some_rgb_indices_rast<span class="sc">$</span>hsv_hue <span class="ot">&lt;-</span> some_rgb_indices_rast<span class="sc">$</span>hsv_hue<span class="sc">*</span><span class="dv">360</span></span>
<span id="cb230-80"><a href="data_fusion.html#cb230-80" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-81"><a href="data_fusion.html#cb230-81" tabindex="-1"></a>  <span class="co"># extract_rast_values</span></span>
<span id="cb230-82"><a href="data_fusion.html#cb230-82" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-83"><a href="data_fusion.html#cb230-83" tabindex="-1"></a>  rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">extract_rast_values</span>(</span>
<span id="cb230-84"><a href="data_fusion.html#cb230-84" tabindex="-1"></a>    <span class="at">sf_data =</span> sf_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb230-85"><a href="data_fusion.html#cb230-85" tabindex="-1"></a>    , <span class="at">rast =</span> some_rgb_indices_rast</span>
<span id="cb230-86"><a href="data_fusion.html#cb230-86" tabindex="-1"></a>    , <span class="at">fun_agg =</span> median</span>
<span id="cb230-87"><a href="data_fusion.html#cb230-87" tabindex="-1"></a>  )</span>
<span id="cb230-88"><a href="data_fusion.html#cb230-88" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-89"><a href="data_fusion.html#cb230-89" tabindex="-1"></a>  <span class="co"># rgb_indices_threshold_voting</span></span>
<span id="cb230-90"><a href="data_fusion.html#cb230-90" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-91"><a href="data_fusion.html#cb230-91" tabindex="-1"></a>  rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">rgb_indices_threshold_voting</span>(</span>
<span id="cb230-92"><a href="data_fusion.html#cb230-92" tabindex="-1"></a>    <span class="at">rgb_indices_df=</span>rgb_indices_df</span>
<span id="cb230-93"><a href="data_fusion.html#cb230-93" tabindex="-1"></a>    <span class="co"># , th_grvi = th_grvi</span></span>
<span id="cb230-94"><a href="data_fusion.html#cb230-94" tabindex="-1"></a>    <span class="co"># , th_rgri = th_rgri</span></span>
<span id="cb230-95"><a href="data_fusion.html#cb230-95" tabindex="-1"></a>    <span class="co"># , th_vdvi = th_vdvi</span></span>
<span id="cb230-96"><a href="data_fusion.html#cb230-96" tabindex="-1"></a>    <span class="co"># , th_exgr = th_exgr</span></span>
<span id="cb230-97"><a href="data_fusion.html#cb230-97" tabindex="-1"></a>    <span class="co"># , th_a = th_a</span></span>
<span id="cb230-98"><a href="data_fusion.html#cb230-98" tabindex="-1"></a>    <span class="co"># , th_hue = th_hue</span></span>
<span id="cb230-99"><a href="data_fusion.html#cb230-99" tabindex="-1"></a>  )</span>
<span id="cb230-100"><a href="data_fusion.html#cb230-100" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-101"><a href="data_fusion.html#cb230-101" tabindex="-1"></a>  <span class="co"># filtering</span></span>
<span id="cb230-102"><a href="data_fusion.html#cb230-102" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb230-103"><a href="data_fusion.html#cb230-103" tabindex="-1"></a>  <span class="cf">if</span>(filter_return){</span>
<span id="cb230-104"><a href="data_fusion.html#cb230-104" tabindex="-1"></a>    rgb_indices_df <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&gt;=</span>spectral_weight)</span>
<span id="cb230-105"><a href="data_fusion.html#cb230-105" tabindex="-1"></a>  }</span>
<span id="cb230-106"><a href="data_fusion.html#cb230-106" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb230-107"><a href="data_fusion.html#cb230-107" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb230-108"><a href="data_fusion.html#cb230-108" tabindex="-1"></a>    <span class="at">segs_sf =</span> rgb_indices_df</span>
<span id="cb230-109"><a href="data_fusion.html#cb230-109" tabindex="-1"></a>    , <span class="at">rgb_indices_rast =</span> all_rgb_indices_rast</span>
<span id="cb230-110"><a href="data_fusion.html#cb230-110" tabindex="-1"></a>  ))</span>
<span id="cb230-111"><a href="data_fusion.html#cb230-111" tabindex="-1"></a>}</span>
<span id="cb230-112"><a href="data_fusion.html#cb230-112" tabindex="-1"></a><span class="co"># polygon_spectral_filtering(</span></span>
<span id="cb230-113"><a href="data_fusion.html#cb230-113" tabindex="-1"></a><span class="co">#   sf_data = slash_piles_polys</span></span>
<span id="cb230-114"><a href="data_fusion.html#cb230-114" tabindex="-1"></a><span class="co">#   , rgb_rast = ortho_rast</span></span>
<span id="cb230-115"><a href="data_fusion.html#cb230-115" tabindex="-1"></a><span class="co">#   , red_band_idx = 1</span></span>
<span id="cb230-116"><a href="data_fusion.html#cb230-116" tabindex="-1"></a><span class="co">#   , green_band_idx = 2</span></span>
<span id="cb230-117"><a href="data_fusion.html#cb230-117" tabindex="-1"></a><span class="co">#   , blue_band_idx = 3</span></span>
<span id="cb230-118"><a href="data_fusion.html#cb230-118" tabindex="-1"></a><span class="co">#   , spectral_weight = 4</span></span>
<span id="cb230-119"><a href="data_fusion.html#cb230-119" tabindex="-1"></a><span class="co"># ) %&gt;%</span></span>
<span id="cb230-120"><a href="data_fusion.html#cb230-120" tabindex="-1"></a><span class="co"># nrow()</span></span>
<span id="cb230-121"><a href="data_fusion.html#cb230-121" tabindex="-1"></a><span class="co"># # dplyr::glimpse()</span></span>
<span id="cb230-122"><a href="data_fusion.html#cb230-122" tabindex="-1"></a><span class="co"># nrow(slash_piles_polys)</span></span></code></pre></div>
</div>
<div id="data-fusion-method-demonstration" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Data Fusion Method Demonstration<a href="data_fusion.html#data-fusion-method-demonstration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>we previously worked through an example where we identified candidate slash piles based on their structural form using our raster-based <a href="geom_detect.html#geom_detect">segmentation approach</a>. we’re going to use that demonstration area, apply the <code>slash_pile_detect()</code> <a href="geom_detect.html#slash_pile_detect_fn">function</a> to detect candidate slash piles from the CHM data based on expected size and geometric properties, and then integrate the spectral filtering method we defined above.</p>
<p>for this demonstration, we’ll use the DBSCAN segmentation method with slightly less strict size and geometric thresholds than we used in the previous section</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="data_fusion.html#cb231-1" tabindex="-1"></a><span class="co"># structurally predicted from chm</span></span>
<span id="cb231-2"><a href="data_fusion.html#cb231-2" tabindex="-1"></a>slash_pile_detect_dbscan_ans_temp <span class="ot">&lt;-</span> <span class="fu">slash_pile_detect</span>(</span>
<span id="cb231-3"><a href="data_fusion.html#cb231-3" tabindex="-1"></a>  <span class="at">chm_rast =</span> aoi_chm_rast</span>
<span id="cb231-4"><a href="data_fusion.html#cb231-4" tabindex="-1"></a>  , <span class="at">seg_method =</span> <span class="st">&quot;dbscan&quot;</span></span>
<span id="cb231-5"><a href="data_fusion.html#cb231-5" tabindex="-1"></a>  , <span class="at">min_ht_m =</span> <span class="dv">1</span></span>
<span id="cb231-6"><a href="data_fusion.html#cb231-6" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">6</span></span>
<span id="cb231-7"><a href="data_fusion.html#cb231-7" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="fl">1.5</span></span>
<span id="cb231-8"><a href="data_fusion.html#cb231-8" tabindex="-1"></a>  , <span class="at">max_area_m2 =</span> <span class="dv">50</span></span>
<span id="cb231-9"><a href="data_fusion.html#cb231-9" tabindex="-1"></a>  , <span class="at">min_convexity_ratio =</span> <span class="fl">0.4</span></span>
<span id="cb231-10"><a href="data_fusion.html#cb231-10" tabindex="-1"></a>  , <span class="at">min_circularity_ratio =</span> <span class="fl">0.3</span></span>
<span id="cb231-11"><a href="data_fusion.html#cb231-11" tabindex="-1"></a>)</span></code></pre></div>
<p>let’s overlay the structural candidate segments (magenta) and the actual piles (cyan) on the raw, un-filtered CHM</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="data_fusion.html#cb232-1" tabindex="-1"></a>aoi_chm_rast <span class="sc">%&gt;%</span></span>
<span id="cb232-2"><a href="data_fusion.html#cb232-2" tabindex="-1"></a>  <span class="co"># slash_pile_detect_dbscan_ans_temp$slice_chm_rast %&gt;% </span></span>
<span id="cb232-3"><a href="data_fusion.html#cb232-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb232-4"><a href="data_fusion.html#cb232-4" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb232-5"><a href="data_fusion.html#cb232-5" tabindex="-1"></a>  aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb232-6"><a href="data_fusion.html#cb232-6" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb232-7"><a href="data_fusion.html#cb232-7" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb232-8"><a href="data_fusion.html#cb232-8" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb232-9"><a href="data_fusion.html#cb232-9" tabindex="-1"></a>)</span>
<span id="cb232-10"><a href="data_fusion.html#cb232-10" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb232-11"><a href="data_fusion.html#cb232-11" tabindex="-1"></a>  aoi_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb232-12"><a href="data_fusion.html#cb232-12" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb232-13"><a href="data_fusion.html#cb232-13" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb232-14"><a href="data_fusion.html#cb232-14" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb232-15"><a href="data_fusion.html#cb232-15" tabindex="-1"></a>)</span>
<span id="cb232-16"><a href="data_fusion.html#cb232-16" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb232-17"><a href="data_fusion.html#cb232-17" tabindex="-1"></a>  slash_pile_detect_dbscan_ans_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb232-18"><a href="data_fusion.html#cb232-18" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">2.5</span></span>
<span id="cb232-19"><a href="data_fusion.html#cb232-19" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-274-1.png" alt="" width="1008" /></p>
<p>now overlay the structural candidate segments (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="data_fusion.html#cb233-1" tabindex="-1"></a>aoi_rgb_rast <span class="sc">%&gt;%</span> </span>
<span id="cb233-2"><a href="data_fusion.html#cb233-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plotRGB</span>(<span class="at">axes =</span> F, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>)</span>
<span id="cb233-3"><a href="data_fusion.html#cb233-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb233-4"><a href="data_fusion.html#cb233-4" tabindex="-1"></a>  aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb233-5"><a href="data_fusion.html#cb233-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb233-6"><a href="data_fusion.html#cb233-6" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb233-7"><a href="data_fusion.html#cb233-7" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb233-8"><a href="data_fusion.html#cb233-8" tabindex="-1"></a>)</span>
<span id="cb233-9"><a href="data_fusion.html#cb233-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb233-10"><a href="data_fusion.html#cb233-10" tabindex="-1"></a>  aoi_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb233-11"><a href="data_fusion.html#cb233-11" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb233-12"><a href="data_fusion.html#cb233-12" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb233-13"><a href="data_fusion.html#cb233-13" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb233-14"><a href="data_fusion.html#cb233-14" tabindex="-1"></a>)</span>
<span id="cb233-15"><a href="data_fusion.html#cb233-15" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb233-16"><a href="data_fusion.html#cb233-16" tabindex="-1"></a>  slash_pile_detect_dbscan_ans_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb233-17"><a href="data_fusion.html#cb233-17" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb233-18"><a href="data_fusion.html#cb233-18" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb233-19"><a href="data_fusion.html#cb233-19" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">2.5</span></span>
<span id="cb233-20"><a href="data_fusion.html#cb233-20" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-275-1.png" alt="" width="1008" /></p>
<p>notice there are lower portions of trees or small trees that are proposed as candidate segments given our less strict size and geometric filters</p>
<p>Remember, our data fusion method uses the spectral data strictly as a final <strong>filter</strong> or quality check on the structurally-detected candidate piles, meaning it <strong>neither adds new piles nor alters the shape or location</strong> of the candidates. As a result, if the structural detection step missed a pile (false negative or omission), the spectral data won’t go back and fix it. The only changes we can expect by including spectral data in our data fusion approach is a trade-off: we can either improve our precision by successfully removing detections that aren’t actually piles (commissions or false positives), or we run the risk of mistakenly filtering out real piles (true positives) if their spectral signature happens to look unusual, which would unfortunately lower our recall.</p>
<p>let’s apply our spectral filtering method to the set of structurally-detected piles but we’ll leave the return unfiltered (<code>filter_return=F</code>) so that we can see which candidate piles would have been filtered and why depending on the <code>spectral_weight</code> setting which defines how many of the six spectral thresholds must be met for a candidate pile to be retained given <code>filter_return=T</code></p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="data_fusion.html#cb234-1" tabindex="-1"></a><span class="co"># names(aoi_rgb_rast)</span></span>
<span id="cb234-2"><a href="data_fusion.html#cb234-2" tabindex="-1"></a>slash_pile_detect_spec_filt_temp <span class="ot">&lt;-</span> <span class="fu">polygon_spectral_filtering</span>(</span>
<span id="cb234-3"><a href="data_fusion.html#cb234-3" tabindex="-1"></a>  <span class="at">sf_data =</span> slash_pile_detect_dbscan_ans_temp<span class="sc">$</span>segs_sf</span>
<span id="cb234-4"><a href="data_fusion.html#cb234-4" tabindex="-1"></a>  , <span class="at">rgb_rast =</span> aoi_rgb_rast</span>
<span id="cb234-5"><a href="data_fusion.html#cb234-5" tabindex="-1"></a>  <span class="co"># define the band index</span></span>
<span id="cb234-6"><a href="data_fusion.html#cb234-6" tabindex="-1"></a>  , <span class="at">red_band_idx =</span> <span class="dv">1</span></span>
<span id="cb234-7"><a href="data_fusion.html#cb234-7" tabindex="-1"></a>  , <span class="at">green_band_idx =</span> <span class="dv">2</span></span>
<span id="cb234-8"><a href="data_fusion.html#cb234-8" tabindex="-1"></a>  , <span class="at">blue_band_idx =</span> <span class="dv">3</span></span>
<span id="cb234-9"><a href="data_fusion.html#cb234-9" tabindex="-1"></a>  <span class="co"># leave return unfiltered</span></span>
<span id="cb234-10"><a href="data_fusion.html#cb234-10" tabindex="-1"></a>  , <span class="at">filter_return =</span> F</span>
<span id="cb234-11"><a href="data_fusion.html#cb234-11" tabindex="-1"></a>)</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="data_fusion.html#cb235-1" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb235-2"><a href="data_fusion.html#cb235-2" tabindex="-1"></a>slash_pile_detect_spec_filt_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## List of 2
##  $ segs_sf         : sf [22 × 22] (S3: sf/tbl_df/tbl/data.frame)
##   ..$ pred_id           : num [1:22] 3 4 22 35 38 39 40 43 56 67 ...
##   ..$ convexity_ratio   : num [1:22] 0.931 0.929 0.938 0.9 0.928 ...
##   ..$ circularity_ratio : num [1:22] 0.671 0.73 0.477 0.641 0.733 ...
##   ..$ area_m2           : num [1:22] 8.33 6.18 5.28 5.51 8.06 ...
##   ..$ volume_m3         : num [1:22] 6.66 3.13 5.52 3.25 4.45 ...
##   ..$ max_height_m      : num [1:22] 1.73 1.15 2.58 1.5 1.53 ...
##   ..$ volume_per_area   : num [1:22] 0.799 0.506 1.047 0.589 0.553 ...
##   ..$ geometry          :sfc_POLYGON of length 22; first list element: List of 1
##   .. ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;XY&quot; &quot;POLYGON&quot; &quot;sfg&quot;
##   ..$ diameter_m        : num [1:22] 3.83 3.14 3.63 3.14 3.54 ...
##   ..$ rast_agg_grvi     : num [1:22] -0.0119 -0.0409 0.0237 0.0274 0.0542 ...
##   ..$ rast_agg_rgri     : num [1:22] 1.024 1.085 0.954 0.947 0.897 ...
##   ..$ rast_agg_vdvi     : num [1:22] -0.0189 -0.0238 0.0105 -0.0344 -0.0292 ...
##   ..$ rast_agg_exgr     : num [1:22] -0.1669 -0.2005 -0.0956 -0.1472 -0.1196 ...
##   ..$ rast_agg_Lab_a    : num [1:22] 1.861 3.781 -0.722 0.778 0.337 ...
##   ..$ rast_agg_hsv_hue  : num [1:22] 258 324 144 227 221 ...
##   ..$ inrange_th_grvi   : int [1:22] 1 1 0 0 0 0 0 1 0 1 ...
##   ..$ inrange_th_rgri   : int [1:22] 1 1 1 1 1 1 1 1 1 1 ...
##   ..$ inrange_th_vdvi   : int [1:22] 1 1 1 1 1 1 1 1 1 1 ...
##   ..$ inrange_th_exgr   : int [1:22] 1 1 1 1 1 1 1 1 1 1 ...
##   ..$ inrange_th_Lab_a  : int [1:22] 1 1 1 1 1 1 1 1 1 1 ...
##   ..$ inrange_th_hsv_hue: int [1:22] 1 1 0 1 1 1 1 1 1 1 ...
##   ..$ inrange_th_votes  : num [1:22] 6 6 4 5 5 5 5 6 5 6 ...
##   ..- attr(*, &quot;sf_column&quot;)= chr &quot;geometry&quot;
##   ..- attr(*, &quot;agr&quot;)= Factor w/ 3 levels &quot;constant&quot;,&quot;aggregate&quot;,..: NA NA NA NA NA NA NA NA NA NA ...
##   .. ..- attr(*, &quot;names&quot;)= chr [1:21] &quot;pred_id&quot; &quot;convexity_ratio&quot; &quot;circularity_ratio&quot; &quot;area_m2&quot; ...
##  $ rgb_indices_rast:S4 class &#39;SpatRaster&#39; [package &quot;terra&quot;]</code></pre>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="data_fusion.html#cb237-1" tabindex="-1"></a><span class="co"># slash_pile_detect_spec_filt_temp$segs_sf$rast_agg_hsv_hue %&gt;% summary()</span></span></code></pre></div>
<p>how many piles would be removed if we set a <code>spectral_weight</code> of <strong>“5”</strong> which requires five of the six spectral thresholds to be met for a candidate pile to be retained</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="data_fusion.html#cb238-1" tabindex="-1"></a><span class="co"># how many piles were removed?</span></span>
<span id="cb238-2"><a href="data_fusion.html#cb238-2" tabindex="-1"></a><span class="fu">nrow</span>(slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf)<span class="sc">-</span></span>
<span id="cb238-3"><a href="data_fusion.html#cb238-3" tabindex="-1"></a>  <span class="fu">nrow</span>(slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&gt;=</span><span class="dv">5</span>))</span></code></pre></div>
<pre><code>## [1] 4</code></pre>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="data_fusion.html#cb240-1" tabindex="-1"></a><span class="co"># what proportion were removed?</span></span>
<span id="cb240-2"><a href="data_fusion.html#cb240-2" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">percent</span>(</span>
<span id="cb240-3"><a href="data_fusion.html#cb240-3" tabindex="-1"></a>  (</span>
<span id="cb240-4"><a href="data_fusion.html#cb240-4" tabindex="-1"></a>    <span class="fu">nrow</span>(slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf)<span class="sc">-</span></span>
<span id="cb240-5"><a href="data_fusion.html#cb240-5" tabindex="-1"></a>    <span class="fu">nrow</span>(slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&gt;=</span><span class="dv">5</span>))</span>
<span id="cb240-6"><a href="data_fusion.html#cb240-6" tabindex="-1"></a>  )<span class="sc">/</span><span class="fu">nrow</span>(slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf)</span>
<span id="cb240-7"><a href="data_fusion.html#cb240-7" tabindex="-1"></a>  , <span class="at">accuracy=</span><span class="fl">0.1</span></span>
<span id="cb240-8"><a href="data_fusion.html#cb240-8" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;18.2%&quot;</code></pre>
<p>let’s highlight the spectrally filtered segments (orange) with the candidate segments that were retained by the spectral filtering (magenta) and the actual piles (cyan) on the raw, un-filtered CHM</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="data_fusion.html#cb242-1" tabindex="-1"></a>aoi_chm_rast <span class="sc">%&gt;%</span></span>
<span id="cb242-2"><a href="data_fusion.html#cb242-2" tabindex="-1"></a>  <span class="co"># slash_pile_detect_dbscan_ans_temp$slice_chm_rast %&gt;% </span></span>
<span id="cb242-3"><a href="data_fusion.html#cb242-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb242-4"><a href="data_fusion.html#cb242-4" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb242-5"><a href="data_fusion.html#cb242-5" tabindex="-1"></a>  aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb242-6"><a href="data_fusion.html#cb242-6" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb242-7"><a href="data_fusion.html#cb242-7" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb242-8"><a href="data_fusion.html#cb242-8" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb242-9"><a href="data_fusion.html#cb242-9" tabindex="-1"></a>)</span>
<span id="cb242-10"><a href="data_fusion.html#cb242-10" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb242-11"><a href="data_fusion.html#cb242-11" tabindex="-1"></a>  aoi_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb242-12"><a href="data_fusion.html#cb242-12" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb242-13"><a href="data_fusion.html#cb242-13" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb242-14"><a href="data_fusion.html#cb242-14" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb242-15"><a href="data_fusion.html#cb242-15" tabindex="-1"></a>)</span>
<span id="cb242-16"><a href="data_fusion.html#cb242-16" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb242-17"><a href="data_fusion.html#cb242-17" tabindex="-1"></a>  slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb242-18"><a href="data_fusion.html#cb242-18" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&gt;=</span><span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb242-19"><a href="data_fusion.html#cb242-19" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb242-20"><a href="data_fusion.html#cb242-20" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">2.5</span></span>
<span id="cb242-21"><a href="data_fusion.html#cb242-21" tabindex="-1"></a>)</span>
<span id="cb242-22"><a href="data_fusion.html#cb242-22" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb242-23"><a href="data_fusion.html#cb242-23" tabindex="-1"></a>  slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb242-24"><a href="data_fusion.html#cb242-24" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&lt;</span><span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb242-25"><a href="data_fusion.html#cb242-25" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb242-26"><a href="data_fusion.html#cb242-26" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">2.5</span></span>
<span id="cb242-27"><a href="data_fusion.html#cb242-27" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-279-1.png" alt="" width="1008" /></p>
<p>now let’s highlight the spectrally filtered segments (orange) with the candidate segments that were retained by the spectral filtering (magenta) and the actual piles (cyan) on the RGB</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="data_fusion.html#cb243-1" tabindex="-1"></a>aoi_rgb_rast <span class="sc">%&gt;%</span> </span>
<span id="cb243-2"><a href="data_fusion.html#cb243-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plotRGB</span>(<span class="at">axes =</span> F, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>)</span>
<span id="cb243-3"><a href="data_fusion.html#cb243-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb243-4"><a href="data_fusion.html#cb243-4" tabindex="-1"></a>  aoi_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb243-5"><a href="data_fusion.html#cb243-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb243-6"><a href="data_fusion.html#cb243-6" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb243-7"><a href="data_fusion.html#cb243-7" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb243-8"><a href="data_fusion.html#cb243-8" tabindex="-1"></a>)</span>
<span id="cb243-9"><a href="data_fusion.html#cb243-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb243-10"><a href="data_fusion.html#cb243-10" tabindex="-1"></a>  aoi_slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb243-11"><a href="data_fusion.html#cb243-11" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb243-12"><a href="data_fusion.html#cb243-12" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb243-13"><a href="data_fusion.html#cb243-13" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb243-14"><a href="data_fusion.html#cb243-14" tabindex="-1"></a>)</span>
<span id="cb243-15"><a href="data_fusion.html#cb243-15" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb243-16"><a href="data_fusion.html#cb243-16" tabindex="-1"></a>  slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb243-17"><a href="data_fusion.html#cb243-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&gt;=</span><span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb243-18"><a href="data_fusion.html#cb243-18" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb243-19"><a href="data_fusion.html#cb243-19" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb243-20"><a href="data_fusion.html#cb243-20" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">2.5</span></span>
<span id="cb243-21"><a href="data_fusion.html#cb243-21" tabindex="-1"></a>)</span>
<span id="cb243-22"><a href="data_fusion.html#cb243-22" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb243-23"><a href="data_fusion.html#cb243-23" tabindex="-1"></a>  slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb243-24"><a href="data_fusion.html#cb243-24" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&lt;</span><span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb243-25"><a href="data_fusion.html#cb243-25" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(aoi_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb243-26"><a href="data_fusion.html#cb243-26" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb243-27"><a href="data_fusion.html#cb243-27" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">2.5</span></span>
<span id="cb243-28"><a href="data_fusion.html#cb243-28" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-280-1.png" alt="" width="1008" /></p>
<p>in this demonsration area, the spectral filtering of our data fusion approach successfully filtered the structurally detected candidate piles that were clearly lower parts of trees (clearly green in the RGB). however, the spectral filtering failed to remove some false positive predictions that were shadowed in the RGB imagery. a positive result, though, was that the spectral filtering stage did not remove any true positive predictions.</p>
<p>let’s see the spectral index values of the candidates which were identified for removal</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="data_fusion.html#cb244-1" tabindex="-1"></a>slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf <span class="sc">%&gt;%</span> </span>
<span id="cb244-2"><a href="data_fusion.html#cb244-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb244-3"><a href="data_fusion.html#cb244-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb244-4"><a href="data_fusion.html#cb244-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rand =</span> <span class="fu">runif</span>(<span class="at">n=</span><span class="fu">nrow</span>(slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf))) <span class="sc">%&gt;%</span> </span>
<span id="cb244-5"><a href="data_fusion.html#cb244-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(rand) <span class="sc">%&gt;%</span> </span>
<span id="cb244-6"><a href="data_fusion.html#cb244-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb244-7"><a href="data_fusion.html#cb244-7" tabindex="-1"></a>    <span class="at">is_removed =</span> inrange_th_votes<span class="sc">&lt;</span><span class="dv">5</span></span>
<span id="cb244-8"><a href="data_fusion.html#cb244-8" tabindex="-1"></a>    , <span class="at">sorter =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb244-9"><a href="data_fusion.html#cb244-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-10"><a href="data_fusion.html#cb244-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb244-11"><a href="data_fusion.html#cb244-11" tabindex="-1"></a>    pred_id, is_removed, sorter</span>
<span id="cb244-12"><a href="data_fusion.html#cb244-12" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)</span>
<span id="cb244-13"><a href="data_fusion.html#cb244-13" tabindex="-1"></a>    , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>)</span>
<span id="cb244-14"><a href="data_fusion.html#cb244-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-15"><a href="data_fusion.html#cb244-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_votes&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb244-16"><a href="data_fusion.html#cb244-16" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb244-17"><a href="data_fusion.html#cb244-17" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb244-18"><a href="data_fusion.html#cb244-18" tabindex="-1"></a>      tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)</span>
<span id="cb244-19"><a href="data_fusion.html#cb244-19" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>)</span>
<span id="cb244-20"><a href="data_fusion.html#cb244-20" tabindex="-1"></a>    )</span>
<span id="cb244-21"><a href="data_fusion.html#cb244-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-22"><a href="data_fusion.html#cb244-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb244-23"><a href="data_fusion.html#cb244-23" tabindex="-1"></a>    <span class="at">i =</span> name <span class="sc">%&gt;%</span> </span>
<span id="cb244-24"><a href="data_fusion.html#cb244-24" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;^rast_agg_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb244-25"><a href="data_fusion.html#cb244-25" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;^inrange_th_&quot;</span>)</span>
<span id="cb244-26"><a href="data_fusion.html#cb244-26" tabindex="-1"></a>    , <span class="at">v =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(name, <span class="st">&quot;^(rast_agg_|inrange_th_)&quot;</span>)</span>
<span id="cb244-27"><a href="data_fusion.html#cb244-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-28"><a href="data_fusion.html#cb244-28" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb244-29"><a href="data_fusion.html#cb244-29" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> v, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb244-30"><a href="data_fusion.html#cb244-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">inrange_th_ =</span> <span class="fu">as.logical</span>(inrange_th_)) <span class="sc">%&gt;%</span> </span>
<span id="cb244-31"><a href="data_fusion.html#cb244-31" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb244-32"><a href="data_fusion.html#cb244-32" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb244-33"><a href="data_fusion.html#cb244-33" tabindex="-1"></a>      <span class="at">x =</span> rast_agg_, <span class="at">y =</span> sorter</span>
<span id="cb244-34"><a href="data_fusion.html#cb244-34" tabindex="-1"></a>      , <span class="at">shape =</span> is_removed</span>
<span id="cb244-35"><a href="data_fusion.html#cb244-35" tabindex="-1"></a>      , <span class="at">color =</span> inrange_th_</span>
<span id="cb244-36"><a href="data_fusion.html#cb244-36" tabindex="-1"></a>    )</span>
<span id="cb244-37"><a href="data_fusion.html#cb244-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb244-38"><a href="data_fusion.html#cb244-38" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb244-39"><a href="data_fusion.html#cb244-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(i), <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb244-40"><a href="data_fusion.html#cb244-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb244-41"><a href="data_fusion.html#cb244-41" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">19</span>,<span class="dv">17</span>)) <span class="sc">+</span></span>
<span id="cb244-42"><a href="data_fusion.html#cb244-42" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>,<span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(slash_pile_detect_spec_filt_temp<span class="sc">$</span>segs_sf)) <span class="sc">+</span></span>
<span id="cb244-43"><a href="data_fusion.html#cb244-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb244-44"><a href="data_fusion.html#cb244-44" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb244-45"><a href="data_fusion.html#cb244-45" tabindex="-1"></a>    , <span class="at">shape =</span> <span class="st">&quot;ultimately</span><span class="sc">\n</span><span class="st">spectrally filtered?&quot;</span></span>
<span id="cb244-46"><a href="data_fusion.html#cb244-46" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;meets</span><span class="sc">\n</span><span class="st">index threshold?&quot;</span></span>
<span id="cb244-47"><a href="data_fusion.html#cb244-47" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb244-48"><a href="data_fusion.html#cb244-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb244-49"><a href="data_fusion.html#cb244-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb244-50"><a href="data_fusion.html#cb244-50" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb244-51"><a href="data_fusion.html#cb244-51" tabindex="-1"></a>    , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb244-52"><a href="data_fusion.html#cb244-52" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb244-53"><a href="data_fusion.html#cb244-53" tabindex="-1"></a>    , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;gray97&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.05</span>)</span>
<span id="cb244-54"><a href="data_fusion.html#cb244-54" tabindex="-1"></a>    , <span class="at">panel.grid.minor.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;gray97&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.05</span>)</span>
<span id="cb244-55"><a href="data_fusion.html#cb244-55" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb244-56"><a href="data_fusion.html#cb244-56" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb244-57"><a href="data_fusion.html#cb244-57" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb244-58"><a href="data_fusion.html#cb244-58" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>)),</span>
<span id="cb244-59"><a href="data_fusion.html#cb244-59" tabindex="-1"></a>    <span class="at">shape =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>))</span>
<span id="cb244-60"><a href="data_fusion.html#cb244-60" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="slash_pile_detecting_files/figure-html/unnamed-chunk-281-1.png" alt="" width="1008" /></p>
<p>the strength of our ensemble spectral index filtering approach is clear with this demonstration data as only one index perfectly aligned with the overall vote for removing candidate piles</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="geom_detect.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="meth_eval.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
