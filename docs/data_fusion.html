<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 6 Data Fusion | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 6 Data Fusion | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 6 Data Fusion | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="raster_watershed.html"/>
<link rel="next" href="wshed_params_test.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script src="libs/. - 1_d2f159-1/data_stars_1b1597e.txt"></script>
<script src="libs/joda-0.0.1/joda.js"></script>
<script src="libs/joda-0.0.1/addImageQuery-bindings.js"></script>
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<link href="libs/study sites-CSS-0.0.1/study sites_home-button.css" rel="stylesheet" />
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#analysis-plan"><i class="fa fa-check"></i><b>1.3</b> Analysis Plan</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="training-data.html"><a href="training-data.html"><i class="fa fa-check"></i><b>2</b> Training Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="training-data.html"><a href="training-data.html#site-introduction"><i class="fa fa-check"></i><b>2.1</b> Site Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="training-data.html"><a href="training-data.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.2</b> Slash Pile Vector Data</a></li>
<li class="chapter" data-level="2.3" data-path="training-data.html"><a href="training-data.html#rgb-orthomosaic"><i class="fa fa-check"></i><b>2.3</b> RGB orthomosaic</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="training-data.html"><a href="training-data.html#example-ratio-based-index"><i class="fa fa-check"></i><b>2.3.1</b> Example ratio-based index</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="training-data.html"><a href="training-data.html#study-area-imagery"><i class="fa fa-check"></i><b>2.4</b> Study area imagery</a></li>
<li class="chapter" data-level="2.5" data-path="training-data.html"><a href="training-data.html#point-cloud-data"><i class="fa fa-check"></i><b>2.5</b> Point Cloud Data</a></li>
<li class="chapter" data-level="2.6" data-path="training-data.html"><a href="training-data.html#check-out-one-pile"><i class="fa fa-check"></i><b>2.6</b> Check out one pile</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="method-evaluation.html"><a href="method-evaluation.html"><i class="fa fa-check"></i><b>3</b> Method Evaluation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="method-evaluation.html"><a href="method-evaluation.html#iou_match"><i class="fa fa-check"></i><b>3.1</b> Instance Matching</a></li>
<li class="chapter" data-level="3.2" data-path="method-evaluation.html"><a href="method-evaluation.html#detect_metrics_form"><i class="fa fa-check"></i><b>3.2</b> Detection Accuracy Metrics</a></li>
<li class="chapter" data-level="3.3" data-path="method-evaluation.html"><a href="method-evaluation.html#quant_metrics_form"><i class="fa fa-check"></i><b>3.3</b> Quantification Accuracy Metrics</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ptcld_process.html"><a href="ptcld_process.html"><i class="fa fa-check"></i><b>4</b> Point Cloud Processing and Pile Segmentation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ptcld_process.html"><a href="ptcld_process.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>4.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ptcld_process.html"><a href="ptcld_process.html#dtm-and-chm-piles"><i class="fa fa-check"></i><b>4.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="raster_watershed.html"><a href="raster_watershed.html"><i class="fa fa-check"></i><b>5</b> Structural Detection from CHM</a>
<ul>
<li class="chapter" data-level="5.1" data-path="raster_watershed.html"><a href="raster_watershed.html#method-demonstration"><i class="fa fa-check"></i><b>5.1</b> Method Demonstration</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-irregularity-filtering"><i class="fa fa-check"></i><b>5.1.1</b> Geometric filtering: Irregularity Filtering</a></li>
<li class="chapter" data-level="5.1.2" data-path="raster_watershed.html"><a href="raster_watershed.html#area-filtering"><i class="fa fa-check"></i><b>5.1.2</b> Area Filtering</a></li>
<li class="chapter" data-level="5.1.3" data-path="raster_watershed.html"><a href="raster_watershed.html#geometric-filtering-circularity-filtering"><i class="fa fa-check"></i><b>5.1.3</b> Geometric filtering: Circularity Filtering</a></li>
<li class="chapter" data-level="5.1.4" data-path="raster_watershed.html"><a href="raster_watershed.html#area-and-volume-from-chm"><i class="fa fa-check"></i><b>5.1.4</b> Area and Volume from CHM</a></li>
<li class="chapter" data-level="5.1.5" data-path="raster_watershed.html"><a href="raster_watershed.html#shape-refinement"><i class="fa fa-check"></i><b>5.1.5</b> Shape Refinement</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="raster_watershed.html"><a href="raster_watershed.html#instance-matching"><i class="fa fa-check"></i><b>5.2</b> Instance Matching</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="raster_watershed.html"><a href="raster_watershed.html#example-area"><i class="fa fa-check"></i><b>5.2.1</b> Example Area</a></li>
<li class="chapter" data-level="5.2.2" data-path="raster_watershed.html"><a href="raster_watershed.html#full-study-area"><i class="fa fa-check"></i><b>5.2.2</b> Full Study Area</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="raster_watershed.html"><a href="raster_watershed.html#slash_pile_detect_watershed"><i class="fa fa-check"></i><b>5.3</b> Watershed Pile Detection Function</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data_fusion.html"><a href="data_fusion.html"><i class="fa fa-check"></i><b>6</b> Data Fusion</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data_fusion.html"><a href="data_fusion.html#rgb-indices"><i class="fa fa-check"></i><b>6.1</b> RGB Indices</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-functions"><i class="fa fa-check"></i><b>6.1.1</b> Spectral Index Functions</a></li>
<li class="chapter" data-level="6.1.2" data-path="data_fusion.html"><a href="data_fusion.html#spectral-index-of-polygons"><i class="fa fa-check"></i><b>6.1.2</b> Spectral Index of Polygons</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data_fusion.html"><a href="data_fusion.html#ground-truth-pile-spectral-summary"><i class="fa fa-check"></i><b>6.2</b> Ground Truth Pile Spectral Summary</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="data_fusion.html"><a href="data_fusion.html#voting-system"><i class="fa fa-check"></i><b>6.2.1</b> Voting System</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="data_fusion.html"><a href="data_fusion.html#polygon_spectral_filtering"><i class="fa fa-check"></i><b>6.3</b> Candidate Polygon Spectral Filtering Function</a></li>
<li class="chapter" data-level="6.4" data-path="data_fusion.html"><a href="data_fusion.html#data-fusion-example"><i class="fa fa-check"></i><b>6.4</b> Data Fusion Example</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="data_fusion.html"><a href="data_fusion.html#instance-matching-1"><i class="fa fa-check"></i><b>6.4.1</b> Instance Matching</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="wshed_params_test.html"><a href="wshed_params_test.html"><i class="fa fa-check"></i><b>7</b> Sensitivity Testing Method</a>
<ul>
<li class="chapter" data-level="7.1" data-path="wshed_params_test.html"><a href="wshed_params_test.html#all_the_combos"><i class="fa fa-check"></i><b>7.1</b> Workflow over parameter combinations</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-workflow"><i class="fa fa-check"></i><b>7.1.1</b> Test Workflow</a></li>
<li class="chapter" data-level="7.1.2" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-instance-matching"><i class="fa fa-check"></i><b>7.1.2</b> Test Instance Matching</a></li>
<li class="chapter" data-level="7.1.3" data-path="wshed_params_test.html"><a href="wshed_params_test.html#test-accuracy"><i class="fa fa-check"></i><b>7.1.3</b> Test Accuracy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="chm_sens_test.html"><a href="chm_sens_test.html"><i class="fa fa-check"></i><b>8</b> Sensitivity Testing Results</a>
<ul>
<li class="chapter" data-level="8.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#process-raw-point-cloud-1"><i class="fa fa-check"></i><b>8.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="8.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#structural-only-parameter-testing"><i class="fa fa-check"></i><b>8.2</b> Structural Only: Parameter Testing</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#validation-over-parameter-combinations"><i class="fa fa-check"></i><b>8.2.1</b> Validation over parameter combinations</a></li>
<li class="chapter" data-level="8.2.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#aggregate-validation-metrics-to-parameter-combination"><i class="fa fa-check"></i><b>8.2.2</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion-parameter-testing"><i class="fa fa-check"></i><b>8.3</b> Data Fusion: Parameter Testing</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#aggregate-validation-metrics-to-parameter-combination-1"><i class="fa fa-check"></i><b>8.3.1</b> Aggregate Validation Metrics to Parameter Combination</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="chm_sens_test.html"><a href="chm_sens_test.html#read-data-for-analysis"><i class="fa fa-check"></i><b>8.4</b> Read Data for Analysis</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#structural-only"><i class="fa fa-check"></i><b>8.4.1</b> Structural Only</a></li>
<li class="chapter" data-level="8.4.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion"><i class="fa fa-check"></i><b>8.4.2</b> Data Fusion</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="chm_sens_test.html"><a href="chm_sens_test.html#allthetests"><i class="fa fa-check"></i><b>8.5</b> Structural Only: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#detect_trends"><i class="fa fa-check"></i><b>8.5.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="8.5.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#quant_trends"><i class="fa fa-check"></i><b>8.5.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="8.5.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#best-settings"><i class="fa fa-check"></i><b>8.5.3</b> Best settings</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="chm_sens_test.html"><a href="chm_sens_test.html#data-fusion-sensitivity-testing"><i class="fa fa-check"></i><b>8.6</b> Data Fusion: Sensitivity Testing</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="chm_sens_test.html"><a href="chm_sens_test.html#main-effects-pile-detection"><i class="fa fa-check"></i><b>8.6.1</b> Main Effects: pile detection</a></li>
<li class="chapter" data-level="8.6.2" data-path="chm_sens_test.html"><a href="chm_sens_test.html#main-effects-form-quantification"><i class="fa fa-check"></i><b>8.6.2</b> Main Effects: form quantification</a></li>
<li class="chapter" data-level="8.6.3" data-path="chm_sens_test.html"><a href="chm_sens_test.html#balanced_acc_assess"><i class="fa fa-check"></i><b>8.6.3</b> Top settings</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="chm_sens_test.html"><a href="chm_sens_test.html#save-the-data"><i class="fa fa-check"></i><b>8.7</b> save the data</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="stats_method.html"><a href="stats_method.html"><i class="fa fa-check"></i><b>9</b> Statistical Testing of Method Settings</a>
<ul>
<li class="chapter" data-level="9.1" data-path="stats_method.html"><a href="stats_method.html#bayesian-glm---f-score"><i class="fa fa-check"></i><b>9.1</b> Bayesian GLM - F-score</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="stats_method.html"><a href="stats_method.html#model-selection"><i class="fa fa-check"></i><b>9.1.1</b> Model selection</a></li>
<li class="chapter" data-level="9.1.2" data-path="stats_method.html"><a href="stats_method.html#modeling"><i class="fa fa-check"></i><b>9.1.2</b> Modeling</a></li>
<li class="chapter" data-level="9.1.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks"><i class="fa fa-check"></i><b>9.1.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.1.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects"><i class="fa fa-check"></i><b>9.1.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.1.5" data-path="stats_method.html"><a href="stats_method.html#f_score_epred"><i class="fa fa-check"></i><b>9.1.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape"><i class="fa fa-check"></i><b>9.2</b> Bayesian GLM - Diameter MAPE</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-1"><i class="fa fa-check"></i><b>9.2.1</b> Model selection</a></li>
<li class="chapter" data-level="9.2.2" data-path="stats_method.html"><a href="stats_method.html#mod_diam_mape2"><i class="fa fa-check"></i><b>9.2.2</b> Modeling</a></li>
<li class="chapter" data-level="9.2.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-1"><i class="fa fa-check"></i><b>9.2.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.2.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-1"><i class="fa fa-check"></i><b>9.2.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.2.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation"><i class="fa fa-check"></i><b>9.2.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="stats_method.html"><a href="stats_method.html#bayesian-glm---height-mape"><i class="fa fa-check"></i><b>9.3</b> Bayesian GLM - Height MAPE</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="stats_method.html"><a href="stats_method.html#model-selection-2"><i class="fa fa-check"></i><b>9.3.1</b> Model selection</a></li>
<li class="chapter" data-level="9.3.2" data-path="stats_method.html"><a href="stats_method.html#modeling-1"><i class="fa fa-check"></i><b>9.3.2</b> Modeling</a></li>
<li class="chapter" data-level="9.3.3" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-checks-2"><i class="fa fa-check"></i><b>9.3.3</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="9.3.4" data-path="stats_method.html"><a href="stats_method.html#conditional-effects-2"><i class="fa fa-check"></i><b>9.3.4</b> Conditional Effects</a></li>
<li class="chapter" data-level="9.3.5" data-path="stats_method.html"><a href="stats_method.html#posterior-predictive-expectation-1"><i class="fa fa-check"></i><b>9.3.5</b> Posterior Predictive Expectation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="stats_method.html"><a href="stats_method.html#hey_balanced_acc"><i class="fa fa-check"></i><b>9.4</b> Balanced Accuracy Bayesian Optimization</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="stats_method.html"><a href="stats_method.html#balanced-accuracy-selection"><i class="fa fa-check"></i><b>9.4.1</b> Balanced Accuracy Selection</a></li>
<li class="chapter" data-level="9.4.2" data-path="stats_method.html"><a href="stats_method.html#overall-across-chm-resolution-2"><i class="fa fa-check"></i><b>9.4.2</b> Overall (across CHM resolution)</a></li>
<li class="chapter" data-level="9.4.3" data-path="stats_method.html"><a href="stats_method.html#by-chm-resolution-2"><i class="fa fa-check"></i><b>9.4.3</b> by CHM resolution</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="stats_method.html"><a href="stats_method.html#training_detect_final"><i class="fa fa-check"></i><b>9.5</b> Balanced Accuracy Validation</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="stats_method.html"><a href="stats_method.html#detection"><i class="fa fa-check"></i><b>9.5.1</b> Detection</a></li>
<li class="chapter" data-level="9.5.2" data-path="stats_method.html"><a href="stats_method.html#instance-match-accuracy-assessment"><i class="fa fa-check"></i><b>9.5.2</b> Instance Match &amp; Accuracy Assessment</a></li>
<li class="chapter" data-level="9.5.3" data-path="stats_method.html"><a href="stats_method.html#training_detect_final_volcomp"><i class="fa fa-check"></i><b>9.5.3</b> Volume Comparison</a></li>
<li class="chapter" data-level="9.5.4" data-path="stats_method.html"><a href="stats_method.html#stand-level-aggregation"><i class="fa fa-check"></i><b>9.5.4</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html"><i class="fa fa-check"></i><b>10</b> Method Validation: Pinyon-Juniper</a>
<ul>
<li class="chapter" data-level="10.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#site-introduction-1"><i class="fa fa-check"></i><b>10.1</b> Site Introduction</a></li>
<li class="chapter" data-level="10.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#data-processing"><i class="fa fa-check"></i><b>10.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#vector-data"><i class="fa fa-check"></i><b>10.2.1</b> Vector Data</a></li>
<li class="chapter" data-level="10.2.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#rgb-data"><i class="fa fa-check"></i><b>10.2.2</b> RGB Data</a></li>
<li class="chapter" data-level="10.2.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#process-raw-point-cloud-2"><i class="fa fa-check"></i><b>10.2.3</b> Process Raw Point Cloud</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#pj_detect_fusion"><i class="fa fa-check"></i><b>10.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#structural-candidate-segments"><i class="fa fa-check"></i><b>10.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="10.3.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#accuracy-of-these-structural-settings"><i class="fa fa-check"></i><b>10.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="10.3.3" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#spect_filtering_final_pj"><i class="fa fa-check"></i><b>10.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="10.3.4" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#detection-and-quantification-accuracy"><i class="fa fa-check"></i><b>10.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="10.3.5" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#validation_detect_final_volcomp"><i class="fa fa-check"></i><b>10.3.5</b> Volume Comparison</a></li>
<li class="chapter" data-level="10.3.6" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#stand-level-aggregation-1"><i class="fa fa-check"></i><b>10.3.6</b> Stand-level Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#pj_detect_struct"><i class="fa fa-check"></i><b>10.4</b> Pile Detection: Structural Only</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#structural-detection"><i class="fa fa-check"></i><b>10.4.1</b> Structural Detection</a></li>
<li class="chapter" data-level="10.4.2" data-path="method-validation-pinyon-juniper.html"><a href="method-validation-pinyon-juniper.html#detection-and-quantification-accuracy-1"><i class="fa fa-check"></i><b>10.4.2</b> Detection and Quantification Accuracy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html"><i class="fa fa-check"></i><b>11</b> Method Validation: BHEF Machine Piles</a>
<ul>
<li class="chapter" data-level="11.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#site-introduction-2"><i class="fa fa-check"></i><b>11.1</b> Site Introduction</a></li>
<li class="chapter" data-level="11.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#data-processing-1"><i class="fa fa-check"></i><b>11.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#rgb-data-1"><i class="fa fa-check"></i><b>11.2.1</b> RGB Data</a></li>
<li class="chapter" data-level="11.2.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#process-raw-point-cloud-3"><i class="fa fa-check"></i><b>11.2.2</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="11.2.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#vector-data-1"><i class="fa fa-check"></i><b>11.2.3</b> Vector Data</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#bhef_detect_fusion"><i class="fa fa-check"></i><b>11.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#structural-candidate-segments-1"><i class="fa fa-check"></i><b>11.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="11.3.2" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#accuracy-of-these-structural-settings-1"><i class="fa fa-check"></i><b>11.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="11.3.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#spect_filtering_final_bhef"><i class="fa fa-check"></i><b>11.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="11.3.4" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#detection-and-quantification-accuracy-2"><i class="fa fa-check"></i><b>11.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="11.3.5" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#stand-level-aggregation-2"><i class="fa fa-check"></i><b>11.3.5</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html"><i class="fa fa-check"></i><b>12</b> Method Validation: ARNF Machine Piles</a>
<ul>
<li class="chapter" data-level="12.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#site-introduction-3"><i class="fa fa-check"></i><b>12.1</b> Site Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#data-processing-2"><i class="fa fa-check"></i><b>12.2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#process-raw-point-cloud-4"><i class="fa fa-check"></i><b>12.2.1</b> Process Raw Point Cloud</a></li>
<li class="chapter" data-level="12.2.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#vector-data-2"><i class="fa fa-check"></i><b>12.2.2</b> Vector Data</a></li>
<li class="chapter" data-level="12.2.3" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#rgb-data-2"><i class="fa fa-check"></i><b>12.2.3</b> RGB Data</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#arnf_detect_fusion"><i class="fa fa-check"></i><b>12.3</b> Pile Detection: Data Fusion</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#structural-candidate-segments-2"><i class="fa fa-check"></i><b>12.3.1</b> Structural Candidate Segments</a></li>
<li class="chapter" data-level="12.3.2" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#accuracy-of-these-structural-settings-2"><i class="fa fa-check"></i><b>12.3.2</b> Accuracy of these structural settings</a></li>
<li class="chapter" data-level="12.3.3" data-path="method-validation-bhef-machine-piles.html"><a href="method-validation-bhef-machine-piles.html#spect_filtering_final_bhef"><i class="fa fa-check"></i><b>12.3.3</b> Spectral Filtering of Candidate Segments</a></li>
<li class="chapter" data-level="12.3.4" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#detection-and-quantification-accuracy-3"><i class="fa fa-check"></i><b>12.3.4</b> Detection and Quantification Accuracy</a></li>
<li class="chapter" data-level="12.3.5" data-path="method-validation-arnf-machine-piles.html"><a href="method-validation-arnf-machine-piles.html#stand-level-aggregation-3"><i class="fa fa-check"></i><b>12.3.5</b> Stand-level Aggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="validation_summary.html"><a href="validation_summary.html"><i class="fa fa-check"></i><b>13</b> Method Validation: Summary</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data_fusion" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Section 6</span> Data Fusion<a href="data_fusion.html#data_fusion" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We’ll now test and approach that uses both aerial point cloud data (for structural information) and RGB imagery (for spectral information) which is a data fusion approach. First, we’ll identify initial candidate slash piles based on their structural form using our raster-based <a href="raster_watershed.html#slash_pile_detect_watershed">watershed segmentation approach</a>. Then, we’ll use the RGB imagery to filter these candidates spectrally: relevant RGB vegetation indices such as Green Red Vegetation Index (GRVI), Red Green Ratio Index (RGRI), Visible Band-Difference Vegetation Index (VDVI), Red Green Ratio Index (RGRI), Red Green Blue Vegetation Index (RGBVI), and Excess Green (ExG) are calculated for each candidate segment, and thresholds are applied to remove those exhibiting high greenness. Index thresholds tested include those found to perform well in distinguishing green vegetation in previous research (<a href="https://doi.org/10.3390/rs2102369">Motohka et al. 2010</a>; <a href="https://doi.org/10.3390/plants14111677">Wang et al. 2025</a>; <a href="https://doi.org/10.1016/j.compag.2019.105201">Riehle et al. 2020</a>). Filtering candidate segments using spectral data will enhance our method’s ability to distinguish non-photosynthetic slash piles from living vegetation (e.g., small trees or shrubs) that might share similar structural profiles.</p>
<p>While RGB vegetation indices are good for separating green biomass, differentiating between various shades of brown, black, and white of non-vegetated surfaces like slash piles, rocks, and bare soil can be more challenging. Many common rock-forming minerals are “spectrally featureless” in the visible range, often appearing pale grey to white (<a href="http://dx.doi.org/10.5589/m10-072">Harris et al. 2010</a>). As such, we will attempt to filter out very dark (black) or very light (white) boulders from the reddish-brown tones common of wood in slash piles using RGB indices that focus on overall brightness and color purity (<a href="https://doi.org/10.3390/plants13091262">Kior et al. 2024</a>). The Brightness Index (BI) can help us exclude extremely dark (black; low BI) or bright (white; high BI) objects. Setting a minimum threshold for saturation (i.e. color purity) can remove achromatic features (like grey, black, or white objects that have very low saturation values close to 0) to help us isolate more chromatic (brown) slash piles.</p>
<p>This data fusion methodology leverages the complementary strengths of both data types, using 3D geometry for initial object segmentation and 2D spectral data to refine detections by excluding green biomass and potential rock and soil features that appear very dark or very light, leading to more accurate slash pile identification.</p>
<div id="rgb-indices" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> RGB Indices<a href="data_fusion.html#rgb-indices" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For these formulas, <span class="math inline">\(R\)</span>, <span class="math inline">\(G\)</span>, and <span class="math inline">\(B\)</span> represent the raw pixel values for the Red, Green, and Blue bands, respectively. For indices that use normalized values, <span class="math inline">\(r\)</span>, <span class="math inline">\(g\)</span>, and <span class="math inline">\(b\)</span> are defined as:</p>
<p><span class="math inline">\(r = \frac{R}{R+G+B}\)</span>
<span class="math inline">\(g = \frac{G}{R+G+B}\)</span>
<span class="math inline">\(b = \frac{B}{R+G+B}\)</span></p>
<p><strong>Green Red Vegetation Index (GRVI)</strong></p>
<p><span class="math display">\[GRVI = \frac{G - R}{G + R}\]</span></p>
<p><strong>Red Green Ratio Index (RGRI)</strong></p>
<p><span class="math display">\[RGRI = \frac{R}{G}\]</span></p>
<p><strong>Visible Band-Difference Vegetation Index (VDVI)</strong></p>
<p><span class="math display">\[VDVI = \frac{2G - R - B}{2G + R + B}\]</span></p>
<p><strong>Red Green Blue Vegetation Index (RGBVI)</strong></p>
<p><span class="math display">\[RGBVI = \frac{G^2 - (B \cdot R)}{G^2 + (B \cdot R)}\]</span></p>
<p><strong>Excess Green (ExG)</strong></p>
<p><span class="math display">\[ExG = 2g - r - b = \frac{2G - R - B}{R+G+B}\]</span></p>
<p><strong>Excessive Red (ExR)</strong>
<span class="math display">\[ExR = 1.4r - g = \frac{1.4R - G}{R+G+B}\]</span></p>
<p><strong>Excess Green-Excess Red (ExGR)</strong></p>
<p><span class="math display">\[ExGR = 3g - 2.4r - b = \frac{3G - 2.4R - B}{R+G+B}\]</span></p>
<p><strong>Brightness Index (BI)</strong></p>
<p><span class="math display">\[BI = \sqrt{\frac{R^2+G^2+B^2}{3}}\]</span></p>
<p><strong>Saturation</strong></p>
<p><span class="math display">\[Saturation = \frac{\max(R,G,B) - \min(R,G,B)}{\max(R,G,B)}\]</span></p>
<div id="spectral-index-functions" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Spectral Index Functions<a href="data_fusion.html#spectral-index-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Although there are dedicated R packages to calculate various spectral indicies (e.g. <code>RStoolbox</code> [<a href="https://doi.org/10.1111/2041-210X.14451">Muller et al. 2025</a>]), we’ll make our own to ensure data quality checks and to limit the spectral indices to those highlighted above.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="data_fusion.html#cb160-1" tabindex="-1"></a><span class="co"># check raster bands and extract rgb layers</span></span>
<span id="cb160-2"><a href="data_fusion.html#cb160-2" tabindex="-1"></a>check_raster_bands <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-3"><a href="data_fusion.html#cb160-3" tabindex="-1"></a>  <span class="co"># convert to SpatRaster if input is from &#39;raster&#39; package</span></span>
<span id="cb160-4"><a href="data_fusion.html#cb160-4" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb160-5"><a href="data_fusion.html#cb160-5" tabindex="-1"></a>    <span class="fu">inherits</span>(rast, <span class="st">&quot;RasterStack&quot;</span>) </span>
<span id="cb160-6"><a href="data_fusion.html#cb160-6" tabindex="-1"></a>    <span class="sc">||</span> <span class="fu">inherits</span>(rast, <span class="st">&quot;RasterBrick&quot;</span>)</span>
<span id="cb160-7"><a href="data_fusion.html#cb160-7" tabindex="-1"></a>  ){</span>
<span id="cb160-8"><a href="data_fusion.html#cb160-8" tabindex="-1"></a>    rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(rast)</span>
<span id="cb160-9"><a href="data_fusion.html#cb160-9" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb160-10"><a href="data_fusion.html#cb160-10" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input &#39;rast&#39; must be a SpatRaster from the `terra` package&quot;</span>)</span>
<span id="cb160-11"><a href="data_fusion.html#cb160-11" tabindex="-1"></a>  }</span>
<span id="cb160-12"><a href="data_fusion.html#cb160-12" tabindex="-1"></a></span>
<span id="cb160-13"><a href="data_fusion.html#cb160-13" tabindex="-1"></a>  <span class="co"># check if band indices are valid</span></span>
<span id="cb160-14"><a href="data_fusion.html#cb160-14" tabindex="-1"></a>  num_bands <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(rast)</span>
<span id="cb160-15"><a href="data_fusion.html#cb160-15" tabindex="-1"></a>  <span class="co"># let 999999 be a cheat code</span></span>
<span id="cb160-16"><a href="data_fusion.html#cb160-16" tabindex="-1"></a>  cheat_code <span class="ot">&lt;-</span> <span class="dv">999999</span></span>
<span id="cb160-17"><a href="data_fusion.html#cb160-17" tabindex="-1"></a>  </span>
<span id="cb160-18"><a href="data_fusion.html#cb160-18" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb160-19"><a href="data_fusion.html#cb160-19" tabindex="-1"></a>    ( red_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> red_band_idx <span class="sc">&gt;</span> num_bands )</span>
<span id="cb160-20"><a href="data_fusion.html#cb160-20" tabindex="-1"></a>    <span class="sc">||</span> ( green_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> green_band_idx <span class="sc">&gt;</span> num_bands )</span>
<span id="cb160-21"><a href="data_fusion.html#cb160-21" tabindex="-1"></a>    <span class="sc">||</span> ( blue_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span>  blue_band_idx <span class="sc">&gt;</span> num_bands )</span>
<span id="cb160-22"><a href="data_fusion.html#cb160-22" tabindex="-1"></a>    <span class="sc">||</span> ( red_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> red_band_idx <span class="sc">&lt;</span> <span class="dv">1</span> )</span>
<span id="cb160-23"><a href="data_fusion.html#cb160-23" tabindex="-1"></a>    <span class="sc">||</span> ( green_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span> green_band_idx <span class="sc">&lt;</span> <span class="dv">1</span> )</span>
<span id="cb160-24"><a href="data_fusion.html#cb160-24" tabindex="-1"></a>    <span class="sc">||</span> ( blue_band_idx<span class="sc">!=</span>cheat_code <span class="sc">&amp;&amp;</span>  blue_band_idx <span class="sc">&lt;</span> <span class="dv">1</span> )</span>
<span id="cb160-25"><a href="data_fusion.html#cb160-25" tabindex="-1"></a>    <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">c</span>(red_band_idx,green_band_idx,blue_band_idx)))<span class="sc">!=</span><span class="dv">3</span></span>
<span id="cb160-26"><a href="data_fusion.html#cb160-26" tabindex="-1"></a>  ){</span>
<span id="cb160-27"><a href="data_fusion.html#cb160-27" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid band index provided. Band indices must correspond to existing, unique layers in the raster object.&quot;</span>)</span>
<span id="cb160-28"><a href="data_fusion.html#cb160-28" tabindex="-1"></a>  }</span>
<span id="cb160-29"><a href="data_fusion.html#cb160-29" tabindex="-1"></a></span>
<span id="cb160-30"><a href="data_fusion.html#cb160-30" tabindex="-1"></a>  <span class="co"># extract bands</span></span>
<span id="cb160-31"><a href="data_fusion.html#cb160-31" tabindex="-1"></a>  <span class="cf">if</span>(red_band_idx<span class="sc">!=</span>cheat_code){ R <span class="ot">&lt;-</span> rast[[red_band_idx]] }<span class="cf">else</span>{ R <span class="ot">&lt;-</span> rast[[<span class="dv">1</span>]] }</span>
<span id="cb160-32"><a href="data_fusion.html#cb160-32" tabindex="-1"></a>  <span class="cf">if</span>(green_band_idx<span class="sc">!=</span>cheat_code){ G <span class="ot">&lt;-</span> rast[[green_band_idx]] }<span class="cf">else</span>{ G <span class="ot">&lt;-</span> rast[[<span class="dv">1</span>]] }</span>
<span id="cb160-33"><a href="data_fusion.html#cb160-33" tabindex="-1"></a>  <span class="cf">if</span>(blue_band_idx<span class="sc">!=</span>cheat_code){ B <span class="ot">&lt;-</span> rast[[blue_band_idx]] }<span class="cf">else</span>{ B <span class="ot">&lt;-</span> rast[[<span class="dv">1</span>]] }</span>
<span id="cb160-34"><a href="data_fusion.html#cb160-34" tabindex="-1"></a></span>
<span id="cb160-35"><a href="data_fusion.html#cb160-35" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">R =</span> R, <span class="at">G =</span> G, <span class="at">B =</span> B))</span>
<span id="cb160-36"><a href="data_fusion.html#cb160-36" tabindex="-1"></a>}</span>
<span id="cb160-37"><a href="data_fusion.html#cb160-37" tabindex="-1"></a><span class="co"># check_raster_bands(ortho_rast, red_band_idx=1, green_band_idx=3, blue_band_idx = 999999)</span></span>
<span id="cb160-38"><a href="data_fusion.html#cb160-38" tabindex="-1"></a></span>
<span id="cb160-39"><a href="data_fusion.html#cb160-39" tabindex="-1"></a><span class="co"># calculate green red vegetation index (GRVI)</span></span>
<span id="cb160-40"><a href="data_fusion.html#cb160-40" tabindex="-1"></a><span class="co"># (G - R) / (G + R)</span></span>
<span id="cb160-41"><a href="data_fusion.html#cb160-41" tabindex="-1"></a>spectral_index_grvi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx) {</span>
<span id="cb160-42"><a href="data_fusion.html#cb160-42" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, <span class="at">blue_band_idx =</span> <span class="dv">999999</span>) <span class="co"># blue_band_idx is dummy here</span></span>
<span id="cb160-43"><a href="data_fusion.html#cb160-43" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-44"><a href="data_fusion.html#cb160-44" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-45"><a href="data_fusion.html#cb160-45" tabindex="-1"></a></span>
<span id="cb160-46"><a href="data_fusion.html#cb160-46" tabindex="-1"></a>  grvi <span class="ot">&lt;-</span> (G <span class="sc">-</span> R) <span class="sc">/</span> (G <span class="sc">+</span> R)</span>
<span id="cb160-47"><a href="data_fusion.html#cb160-47" tabindex="-1"></a>  <span class="fu">names</span>(grvi) <span class="ot">&lt;-</span> <span class="st">&quot;grvi&quot;</span></span>
<span id="cb160-48"><a href="data_fusion.html#cb160-48" tabindex="-1"></a>  <span class="fu">return</span>(grvi)</span>
<span id="cb160-49"><a href="data_fusion.html#cb160-49" tabindex="-1"></a>}</span>
<span id="cb160-50"><a href="data_fusion.html#cb160-50" tabindex="-1"></a><span class="co"># spectral_index_grvi(ortho_rast,red_band_idx = 1, green_band_idx = 2) %&gt;% terra::plot()</span></span>
<span id="cb160-51"><a href="data_fusion.html#cb160-51" tabindex="-1"></a></span>
<span id="cb160-52"><a href="data_fusion.html#cb160-52" tabindex="-1"></a><span class="co"># red green ratio index (RGRI)</span></span>
<span id="cb160-53"><a href="data_fusion.html#cb160-53" tabindex="-1"></a><span class="co"># R/G</span></span>
<span id="cb160-54"><a href="data_fusion.html#cb160-54" tabindex="-1"></a>spectral_index_rgri <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx) {</span>
<span id="cb160-55"><a href="data_fusion.html#cb160-55" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, <span class="at">blue_band_idx =</span> <span class="dv">999999</span>) <span class="co"># blue_band_idx is dummy here</span></span>
<span id="cb160-56"><a href="data_fusion.html#cb160-56" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-57"><a href="data_fusion.html#cb160-57" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-58"><a href="data_fusion.html#cb160-58" tabindex="-1"></a></span>
<span id="cb160-59"><a href="data_fusion.html#cb160-59" tabindex="-1"></a>  rgri <span class="ot">&lt;-</span> R<span class="sc">/</span>G</span>
<span id="cb160-60"><a href="data_fusion.html#cb160-60" tabindex="-1"></a>  <span class="fu">names</span>(rgri) <span class="ot">&lt;-</span> <span class="st">&quot;rgri&quot;</span></span>
<span id="cb160-61"><a href="data_fusion.html#cb160-61" tabindex="-1"></a>  <span class="fu">return</span>(rgri)</span>
<span id="cb160-62"><a href="data_fusion.html#cb160-62" tabindex="-1"></a>}</span>
<span id="cb160-63"><a href="data_fusion.html#cb160-63" tabindex="-1"></a><span class="co"># spectral_index_grvi(ortho_rast,red_band_idx = 1, green_band_idx = 2) %&gt;% terra::plot()</span></span>
<span id="cb160-64"><a href="data_fusion.html#cb160-64" tabindex="-1"></a></span>
<span id="cb160-65"><a href="data_fusion.html#cb160-65" tabindex="-1"></a><span class="co"># calculate visible band-difference vegetation index (VDVI)</span></span>
<span id="cb160-66"><a href="data_fusion.html#cb160-66" tabindex="-1"></a><span class="co"># (2G - R - B) / (2G + R + B)</span></span>
<span id="cb160-67"><a href="data_fusion.html#cb160-67" tabindex="-1"></a>spectral_index_vdvi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-68"><a href="data_fusion.html#cb160-68" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-69"><a href="data_fusion.html#cb160-69" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-70"><a href="data_fusion.html#cb160-70" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-71"><a href="data_fusion.html#cb160-71" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb160-72"><a href="data_fusion.html#cb160-72" tabindex="-1"></a></span>
<span id="cb160-73"><a href="data_fusion.html#cb160-73" tabindex="-1"></a>  vdvi <span class="ot">&lt;-</span> (<span class="dv">2</span> <span class="sc">*</span> G <span class="sc">-</span> R <span class="sc">-</span> B) <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> G <span class="sc">+</span> R <span class="sc">+</span> B)</span>
<span id="cb160-74"><a href="data_fusion.html#cb160-74" tabindex="-1"></a>  <span class="fu">names</span>(vdvi) <span class="ot">&lt;-</span> <span class="st">&quot;vdvi&quot;</span></span>
<span id="cb160-75"><a href="data_fusion.html#cb160-75" tabindex="-1"></a>  <span class="fu">return</span>(vdvi)</span>
<span id="cb160-76"><a href="data_fusion.html#cb160-76" tabindex="-1"></a>}</span>
<span id="cb160-77"><a href="data_fusion.html#cb160-77" tabindex="-1"></a><span class="co"># spectral_index_vdvi(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb160-78"><a href="data_fusion.html#cb160-78" tabindex="-1"></a></span>
<span id="cb160-79"><a href="data_fusion.html#cb160-79" tabindex="-1"></a><span class="co"># calculate red green blue vegetation index (RGBVI)</span></span>
<span id="cb160-80"><a href="data_fusion.html#cb160-80" tabindex="-1"></a><span class="co"># (G^2 - (B * R)) / (G^2 + (B * R))</span></span>
<span id="cb160-81"><a href="data_fusion.html#cb160-81" tabindex="-1"></a>spectral_index_rgbvi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-82"><a href="data_fusion.html#cb160-82" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-83"><a href="data_fusion.html#cb160-83" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-84"><a href="data_fusion.html#cb160-84" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-85"><a href="data_fusion.html#cb160-85" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb160-86"><a href="data_fusion.html#cb160-86" tabindex="-1"></a></span>
<span id="cb160-87"><a href="data_fusion.html#cb160-87" tabindex="-1"></a>  rgbvi <span class="ot">&lt;-</span> (G<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> (B <span class="sc">*</span> R)) <span class="sc">/</span> (G<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (B <span class="sc">*</span> R))</span>
<span id="cb160-88"><a href="data_fusion.html#cb160-88" tabindex="-1"></a>  <span class="fu">names</span>(rgbvi) <span class="ot">&lt;-</span> <span class="st">&quot;rgbvi&quot;</span></span>
<span id="cb160-89"><a href="data_fusion.html#cb160-89" tabindex="-1"></a>  <span class="fu">return</span>(rgbvi)</span>
<span id="cb160-90"><a href="data_fusion.html#cb160-90" tabindex="-1"></a>}</span>
<span id="cb160-91"><a href="data_fusion.html#cb160-91" tabindex="-1"></a><span class="co"># spectral_index_rgbvi(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb160-92"><a href="data_fusion.html#cb160-92" tabindex="-1"></a></span>
<span id="cb160-93"><a href="data_fusion.html#cb160-93" tabindex="-1"></a><span class="co"># calculate excess green (ExG)</span></span>
<span id="cb160-94"><a href="data_fusion.html#cb160-94" tabindex="-1"></a><span class="co"># (2G - R - B) / (R + G + B) (using normalized RGB values)</span></span>
<span id="cb160-95"><a href="data_fusion.html#cb160-95" tabindex="-1"></a><span class="co"># 2G - R - B (using raw values, then normalized by sum of R+G+B)</span></span>
<span id="cb160-96"><a href="data_fusion.html#cb160-96" tabindex="-1"></a>spectral_index_exg <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-97"><a href="data_fusion.html#cb160-97" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-98"><a href="data_fusion.html#cb160-98" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-99"><a href="data_fusion.html#cb160-99" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-100"><a href="data_fusion.html#cb160-100" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb160-101"><a href="data_fusion.html#cb160-101" tabindex="-1"></a></span>
<span id="cb160-102"><a href="data_fusion.html#cb160-102" tabindex="-1"></a>  <span class="co"># Calculate normalized RGB values</span></span>
<span id="cb160-103"><a href="data_fusion.html#cb160-103" tabindex="-1"></a>  sum_rgb <span class="ot">&lt;-</span> R <span class="sc">+</span> G <span class="sc">+</span> B</span>
<span id="cb160-104"><a href="data_fusion.html#cb160-104" tabindex="-1"></a>  r_norm <span class="ot">&lt;-</span> R <span class="sc">/</span> sum_rgb</span>
<span id="cb160-105"><a href="data_fusion.html#cb160-105" tabindex="-1"></a>  g_norm <span class="ot">&lt;-</span> G <span class="sc">/</span> sum_rgb</span>
<span id="cb160-106"><a href="data_fusion.html#cb160-106" tabindex="-1"></a>  b_norm <span class="ot">&lt;-</span> B <span class="sc">/</span> sum_rgb</span>
<span id="cb160-107"><a href="data_fusion.html#cb160-107" tabindex="-1"></a></span>
<span id="cb160-108"><a href="data_fusion.html#cb160-108" tabindex="-1"></a>  exg <span class="ot">&lt;-</span> (<span class="dv">2</span> <span class="sc">*</span> g_norm <span class="sc">-</span> r_norm <span class="sc">-</span> b_norm)</span>
<span id="cb160-109"><a href="data_fusion.html#cb160-109" tabindex="-1"></a>  <span class="fu">names</span>(exg) <span class="ot">&lt;-</span> <span class="st">&quot;exg&quot;</span></span>
<span id="cb160-110"><a href="data_fusion.html#cb160-110" tabindex="-1"></a>  <span class="fu">return</span>(exg)</span>
<span id="cb160-111"><a href="data_fusion.html#cb160-111" tabindex="-1"></a>}</span>
<span id="cb160-112"><a href="data_fusion.html#cb160-112" tabindex="-1"></a><span class="co"># spectral_index_exg(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb160-113"><a href="data_fusion.html#cb160-113" tabindex="-1"></a></span>
<span id="cb160-114"><a href="data_fusion.html#cb160-114" tabindex="-1"></a><span class="co"># calculate brightness index (BI)</span></span>
<span id="cb160-115"><a href="data_fusion.html#cb160-115" tabindex="-1"></a><span class="co"># sqrt((R^2 + G^2 + B^2) / 3)</span></span>
<span id="cb160-116"><a href="data_fusion.html#cb160-116" tabindex="-1"></a>spectral_index_bi <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-117"><a href="data_fusion.html#cb160-117" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-118"><a href="data_fusion.html#cb160-118" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-119"><a href="data_fusion.html#cb160-119" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-120"><a href="data_fusion.html#cb160-120" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb160-121"><a href="data_fusion.html#cb160-121" tabindex="-1"></a></span>
<span id="cb160-122"><a href="data_fusion.html#cb160-122" tabindex="-1"></a>  bi <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((R<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> G<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> B<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">3</span>)</span>
<span id="cb160-123"><a href="data_fusion.html#cb160-123" tabindex="-1"></a>  <span class="co"># normalize to 0-1 range</span></span>
<span id="cb160-124"><a href="data_fusion.html#cb160-124" tabindex="-1"></a>  max_brightness <span class="ot">=</span> <span class="fu">max</span>(</span>
<span id="cb160-125"><a href="data_fusion.html#cb160-125" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">minmax</span>(R)[<span class="dv">2</span>]</span>
<span id="cb160-126"><a href="data_fusion.html#cb160-126" tabindex="-1"></a>    , terra<span class="sc">::</span><span class="fu">minmax</span>(G)[<span class="dv">2</span>]</span>
<span id="cb160-127"><a href="data_fusion.html#cb160-127" tabindex="-1"></a>    , terra<span class="sc">::</span><span class="fu">minmax</span>(B)[<span class="dv">2</span>]</span>
<span id="cb160-128"><a href="data_fusion.html#cb160-128" tabindex="-1"></a>    , <span class="at">na.rm =</span> T</span>
<span id="cb160-129"><a href="data_fusion.html#cb160-129" tabindex="-1"></a>  )</span>
<span id="cb160-130"><a href="data_fusion.html#cb160-130" tabindex="-1"></a>  </span>
<span id="cb160-131"><a href="data_fusion.html#cb160-131" tabindex="-1"></a>  bi <span class="ot">&lt;-</span> bi<span class="sc">/</span>max_brightness</span>
<span id="cb160-132"><a href="data_fusion.html#cb160-132" tabindex="-1"></a>  <span class="fu">names</span>(bi) <span class="ot">&lt;-</span> <span class="st">&quot;bi&quot;</span></span>
<span id="cb160-133"><a href="data_fusion.html#cb160-133" tabindex="-1"></a>  <span class="fu">return</span>(bi)</span>
<span id="cb160-134"><a href="data_fusion.html#cb160-134" tabindex="-1"></a>}</span>
<span id="cb160-135"><a href="data_fusion.html#cb160-135" tabindex="-1"></a><span class="co"># spectral_index_bi(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb160-136"><a href="data_fusion.html#cb160-136" tabindex="-1"></a></span>
<span id="cb160-137"><a href="data_fusion.html#cb160-137" tabindex="-1"></a><span class="co"># calculate excessive red (ExR)</span></span>
<span id="cb160-138"><a href="data_fusion.html#cb160-138" tabindex="-1"></a><span class="co"># 1.4r - g, where r and g are normalized RGB values.</span></span>
<span id="cb160-139"><a href="data_fusion.html#cb160-139" tabindex="-1"></a>spectral_index_exr <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx){</span>
<span id="cb160-140"><a href="data_fusion.html#cb160-140" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-141"><a href="data_fusion.html#cb160-141" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-142"><a href="data_fusion.html#cb160-142" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-143"><a href="data_fusion.html#cb160-143" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb160-144"><a href="data_fusion.html#cb160-144" tabindex="-1"></a></span>
<span id="cb160-145"><a href="data_fusion.html#cb160-145" tabindex="-1"></a>  <span class="co"># Calculate normalized RGB values</span></span>
<span id="cb160-146"><a href="data_fusion.html#cb160-146" tabindex="-1"></a>  sum_rgb <span class="ot">&lt;-</span> R <span class="sc">+</span> G <span class="sc">+</span> B</span>
<span id="cb160-147"><a href="data_fusion.html#cb160-147" tabindex="-1"></a>  r_norm <span class="ot">&lt;-</span> R <span class="sc">/</span> sum_rgb</span>
<span id="cb160-148"><a href="data_fusion.html#cb160-148" tabindex="-1"></a>  g_norm <span class="ot">&lt;-</span> G <span class="sc">/</span> sum_rgb</span>
<span id="cb160-149"><a href="data_fusion.html#cb160-149" tabindex="-1"></a></span>
<span id="cb160-150"><a href="data_fusion.html#cb160-150" tabindex="-1"></a>  exr <span class="ot">&lt;-</span> (<span class="fl">1.4</span> <span class="sc">*</span> r_norm <span class="sc">-</span> g_norm)</span>
<span id="cb160-151"><a href="data_fusion.html#cb160-151" tabindex="-1"></a>  <span class="fu">names</span>(exr) <span class="ot">&lt;-</span> <span class="st">&quot;exr&quot;</span></span>
<span id="cb160-152"><a href="data_fusion.html#cb160-152" tabindex="-1"></a>  <span class="fu">return</span>(exr)</span>
<span id="cb160-153"><a href="data_fusion.html#cb160-153" tabindex="-1"></a>}</span>
<span id="cb160-154"><a href="data_fusion.html#cb160-154" tabindex="-1"></a></span>
<span id="cb160-155"><a href="data_fusion.html#cb160-155" tabindex="-1"></a><span class="co">#&#39; calculate excess green-excess red (ExGR)</span></span>
<span id="cb160-156"><a href="data_fusion.html#cb160-156" tabindex="-1"></a><span class="co">#&#39; 3g - 2.4r - b, where r, g, b are normalized RGB values.</span></span>
<span id="cb160-157"><a href="data_fusion.html#cb160-157" tabindex="-1"></a><span class="co">#&#39; equivalent to ExG - ExR.</span></span>
<span id="cb160-158"><a href="data_fusion.html#cb160-158" tabindex="-1"></a>spectral_index_exgr <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-159"><a href="data_fusion.html#cb160-159" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-160"><a href="data_fusion.html#cb160-160" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-161"><a href="data_fusion.html#cb160-161" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-162"><a href="data_fusion.html#cb160-162" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb160-163"><a href="data_fusion.html#cb160-163" tabindex="-1"></a></span>
<span id="cb160-164"><a href="data_fusion.html#cb160-164" tabindex="-1"></a>  <span class="co"># Calculate normalized RGB values</span></span>
<span id="cb160-165"><a href="data_fusion.html#cb160-165" tabindex="-1"></a>  sum_rgb <span class="ot">&lt;-</span> R <span class="sc">+</span> G <span class="sc">+</span> B</span>
<span id="cb160-166"><a href="data_fusion.html#cb160-166" tabindex="-1"></a>  r_norm <span class="ot">&lt;-</span> R <span class="sc">/</span> sum_rgb</span>
<span id="cb160-167"><a href="data_fusion.html#cb160-167" tabindex="-1"></a>  g_norm <span class="ot">&lt;-</span> G <span class="sc">/</span> sum_rgb</span>
<span id="cb160-168"><a href="data_fusion.html#cb160-168" tabindex="-1"></a>  b_norm <span class="ot">&lt;-</span> B <span class="sc">/</span> sum_rgb</span>
<span id="cb160-169"><a href="data_fusion.html#cb160-169" tabindex="-1"></a></span>
<span id="cb160-170"><a href="data_fusion.html#cb160-170" tabindex="-1"></a>  exgr <span class="ot">&lt;-</span> (<span class="dv">3</span> <span class="sc">*</span> g_norm <span class="sc">-</span> <span class="fl">2.4</span> <span class="sc">*</span> r_norm <span class="sc">-</span> b_norm)</span>
<span id="cb160-171"><a href="data_fusion.html#cb160-171" tabindex="-1"></a>  <span class="fu">names</span>(exgr) <span class="ot">&lt;-</span> <span class="st">&quot;exgr&quot;</span></span>
<span id="cb160-172"><a href="data_fusion.html#cb160-172" tabindex="-1"></a>  <span class="fu">return</span>(exgr)</span>
<span id="cb160-173"><a href="data_fusion.html#cb160-173" tabindex="-1"></a>}</span>
<span id="cb160-174"><a href="data_fusion.html#cb160-174" tabindex="-1"></a></span>
<span id="cb160-175"><a href="data_fusion.html#cb160-175" tabindex="-1"></a><span class="co"># calculate saturation (SAT)</span></span>
<span id="cb160-176"><a href="data_fusion.html#cb160-176" tabindex="-1"></a><span class="co"># (max(R,G,B) - min(R,G,B)) / max(R,G,B)</span></span>
<span id="cb160-177"><a href="data_fusion.html#cb160-177" tabindex="-1"></a>spectral_index_saturation <span class="ot">&lt;-</span> <span class="cf">function</span>(rast, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-178"><a href="data_fusion.html#cb160-178" tabindex="-1"></a>  bands <span class="ot">&lt;-</span> <span class="fu">check_raster_bands</span>(rast, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-179"><a href="data_fusion.html#cb160-179" tabindex="-1"></a>  R <span class="ot">&lt;-</span> bands<span class="sc">$</span>R</span>
<span id="cb160-180"><a href="data_fusion.html#cb160-180" tabindex="-1"></a>  G <span class="ot">&lt;-</span> bands<span class="sc">$</span>G</span>
<span id="cb160-181"><a href="data_fusion.html#cb160-181" tabindex="-1"></a>  B <span class="ot">&lt;-</span> bands<span class="sc">$</span>B</span>
<span id="cb160-182"><a href="data_fusion.html#cb160-182" tabindex="-1"></a></span>
<span id="cb160-183"><a href="data_fusion.html#cb160-183" tabindex="-1"></a>  max_rgb <span class="ot">&lt;-</span> <span class="fu">max</span>(R, G, B)</span>
<span id="cb160-184"><a href="data_fusion.html#cb160-184" tabindex="-1"></a>  min_rgb <span class="ot">&lt;-</span> <span class="fu">min</span>(R, G, B)</span>
<span id="cb160-185"><a href="data_fusion.html#cb160-185" tabindex="-1"></a>  sat <span class="ot">&lt;-</span> (max_rgb <span class="sc">-</span> min_rgb) <span class="sc">/</span> max_rgb</span>
<span id="cb160-186"><a href="data_fusion.html#cb160-186" tabindex="-1"></a>  <span class="fu">names</span>(sat) <span class="ot">&lt;-</span> <span class="st">&quot;sat&quot;</span></span>
<span id="cb160-187"><a href="data_fusion.html#cb160-187" tabindex="-1"></a>  <span class="fu">return</span>(sat)</span>
<span id="cb160-188"><a href="data_fusion.html#cb160-188" tabindex="-1"></a>}</span>
<span id="cb160-189"><a href="data_fusion.html#cb160-189" tabindex="-1"></a><span class="co"># spectral_index_saturation(ortho_rast,red_band_idx = 1, green_band_idx = 2, blue_band_idx = 3) %&gt;% terra::plot()</span></span>
<span id="cb160-190"><a href="data_fusion.html#cb160-190" tabindex="-1"></a></span>
<span id="cb160-191"><a href="data_fusion.html#cb160-191" tabindex="-1"></a><span class="co"># calculate all indices</span></span>
<span id="cb160-192"><a href="data_fusion.html#cb160-192" tabindex="-1"></a>calculate_all_rgb_indices <span class="ot">&lt;-</span> <span class="cf">function</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx) {</span>
<span id="cb160-193"><a href="data_fusion.html#cb160-193" tabindex="-1"></a>  <span class="co"># call individual index functions</span></span>
<span id="cb160-194"><a href="data_fusion.html#cb160-194" tabindex="-1"></a>  grvi_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_grvi</span>(raster_obj, red_band_idx, green_band_idx)</span>
<span id="cb160-195"><a href="data_fusion.html#cb160-195" tabindex="-1"></a>  rgri_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_rgri</span>(raster_obj, red_band_idx, green_band_idx)</span>
<span id="cb160-196"><a href="data_fusion.html#cb160-196" tabindex="-1"></a>  vdvi_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_vdvi</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-197"><a href="data_fusion.html#cb160-197" tabindex="-1"></a>  rgbvi_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_rgbvi</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-198"><a href="data_fusion.html#cb160-198" tabindex="-1"></a>  exg_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_exg</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-199"><a href="data_fusion.html#cb160-199" tabindex="-1"></a>  exr_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_exr</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-200"><a href="data_fusion.html#cb160-200" tabindex="-1"></a>  exgr_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_exgr</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-201"><a href="data_fusion.html#cb160-201" tabindex="-1"></a>  bi_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_bi</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-202"><a href="data_fusion.html#cb160-202" tabindex="-1"></a>  sat_layer <span class="ot">&lt;-</span> <span class="fu">spectral_index_saturation</span>(raster_obj, red_band_idx, green_band_idx, blue_band_idx)</span>
<span id="cb160-203"><a href="data_fusion.html#cb160-203" tabindex="-1"></a></span>
<span id="cb160-204"><a href="data_fusion.html#cb160-204" tabindex="-1"></a>  <span class="co"># stack all calculated indices into a single spatraster</span></span>
<span id="cb160-205"><a href="data_fusion.html#cb160-205" tabindex="-1"></a>  all_indices <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb160-206"><a href="data_fusion.html#cb160-206" tabindex="-1"></a>    grvi_layer</span>
<span id="cb160-207"><a href="data_fusion.html#cb160-207" tabindex="-1"></a>    , rgri_layer</span>
<span id="cb160-208"><a href="data_fusion.html#cb160-208" tabindex="-1"></a>    , vdvi_layer</span>
<span id="cb160-209"><a href="data_fusion.html#cb160-209" tabindex="-1"></a>    , rgbvi_layer</span>
<span id="cb160-210"><a href="data_fusion.html#cb160-210" tabindex="-1"></a>    , exg_layer</span>
<span id="cb160-211"><a href="data_fusion.html#cb160-211" tabindex="-1"></a>    , exr_layer</span>
<span id="cb160-212"><a href="data_fusion.html#cb160-212" tabindex="-1"></a>    , exgr_layer</span>
<span id="cb160-213"><a href="data_fusion.html#cb160-213" tabindex="-1"></a>    , bi_layer</span>
<span id="cb160-214"><a href="data_fusion.html#cb160-214" tabindex="-1"></a>    , sat_layer</span>
<span id="cb160-215"><a href="data_fusion.html#cb160-215" tabindex="-1"></a>  )</span>
<span id="cb160-216"><a href="data_fusion.html#cb160-216" tabindex="-1"></a></span>
<span id="cb160-217"><a href="data_fusion.html#cb160-217" tabindex="-1"></a>  <span class="fu">return</span>(all_indices)</span>
<span id="cb160-218"><a href="data_fusion.html#cb160-218" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s test this <code>calculate_all_rgb_indices()</code> function with our orthomosaic</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="data_fusion.html#cb161-1" tabindex="-1"></a><span class="co"># calculate_all_rgb_indices</span></span>
<span id="cb161-2"><a href="data_fusion.html#cb161-2" tabindex="-1"></a>all_rgb_indices_rast <span class="ot">&lt;-</span> <span class="fu">calculate_all_rgb_indices</span>(ortho_rast,<span class="at">red_band_idx =</span> <span class="dv">1</span>, <span class="at">green_band_idx =</span> <span class="dv">2</span>, <span class="at">blue_band_idx =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="data_fusion.html#cb162-1" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb162-2"><a href="data_fusion.html#cb162-2" tabindex="-1"></a>all_rgb_indices_rast <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
<pre><code>## [1] &quot;grvi&quot;  &quot;rgri&quot;  &quot;vdvi&quot;  &quot;rgbvi&quot; &quot;exg&quot;   &quot;exr&quot;   &quot;exgr&quot;  &quot;bi&quot;    &quot;sat&quot;</code></pre>
<p>let’s plot all of those indices for the entire extent of our orthomoasic</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="data_fusion.html#cb164-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb164-2"><a href="data_fusion.html#cb164-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb164-3"><a href="data_fusion.html#cb164-3" tabindex="-1"></a>  all_rgb_indices_rast</span>
<span id="cb164-4"><a href="data_fusion.html#cb164-4" tabindex="-1"></a>  , <span class="at">nc =</span> <span class="dv">3</span></span>
<span id="cb164-5"><a href="data_fusion.html#cb164-5" tabindex="-1"></a>  <span class="co"># , nr = 3</span></span>
<span id="cb164-6"><a href="data_fusion.html#cb164-6" tabindex="-1"></a>  , <span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">2</span>,<span class="fl">0.5</span>)</span>
<span id="cb164-7"><a href="data_fusion.html#cb164-7" tabindex="-1"></a>  , <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb164-8"><a href="data_fusion.html#cb164-8" tabindex="-1"></a>  , <span class="at">legend =</span> F</span>
<span id="cb164-9"><a href="data_fusion.html#cb164-9" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-150-1.png" width="1008" /></p>
<p>we can also look at the correlation between the different indices</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="data_fusion.html#cb165-1" tabindex="-1"></a><span class="co"># investigate correlation among covariates</span></span>
<span id="cb165-2"><a href="data_fusion.html#cb165-2" tabindex="-1"></a>all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb165-3"><a href="data_fusion.html#cb165-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">pairs</span>(</span>
<span id="cb165-4"><a href="data_fusion.html#cb165-4" tabindex="-1"></a>    <span class="at">maxcells =</span> <span class="fu">min</span>(<span class="dv">11111</span>, terra<span class="sc">::</span><span class="fu">ncell</span>(all_rgb_indices_rast)<span class="sc">*</span>.<span class="dv">01</span>)</span>
<span id="cb165-5"><a href="data_fusion.html#cb165-5" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-151-1.png" width="1008" /></p>
<p>many of these spectral indices are highly (even perfectly) correlated, meaning they provide redundant information. to streamline our method and ensure we utilize unique spectral insights for distinguishing slash piles from the surrounding terrain and other objects, we will select only one index from each correlated group. GRVI, RGRI, and ExR are highly correlated, as are VDVI, RGBVI, and ExG. we’ll choose one from each of these sets.</p>
<p>here is a plot of the different spectral indices (high values are brighter, low values are darker) on our example area we were working with in the last section with the ground truth piles in blue</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="data_fusion.html#cb166-1" tabindex="-1"></a>all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb166-2"><a href="data_fusion.html#cb166-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(example_aoi <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">7.3</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb166-3"><a href="data_fusion.html#cb166-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(example_aoi <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">7.3</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb166-4"><a href="data_fusion.html#cb166-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb166-5"><a href="data_fusion.html#cb166-5" tabindex="-1"></a>    <span class="at">nc =</span> <span class="dv">3</span></span>
<span id="cb166-6"><a href="data_fusion.html#cb166-6" tabindex="-1"></a>    , <span class="at">col =</span> grDevices<span class="sc">::</span><span class="fu">gray.colors</span>(<span class="dv">111</span>, <span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>)</span>
<span id="cb166-7"><a href="data_fusion.html#cb166-7" tabindex="-1"></a>    , <span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">2</span>,<span class="fl">0.5</span>)</span>
<span id="cb166-8"><a href="data_fusion.html#cb166-8" tabindex="-1"></a>    , <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb166-9"><a href="data_fusion.html#cb166-9" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb166-10"><a href="data_fusion.html#cb166-10" tabindex="-1"></a>    , <span class="at">fun =</span> <span class="cf">function</span>(){</span>
<span id="cb166-11"><a href="data_fusion.html#cb166-11" tabindex="-1"></a>      <span class="fu">lines</span>(terra<span class="sc">::</span><span class="fu">vect</span>(example_aoi), <span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb166-12"><a href="data_fusion.html#cb166-12" tabindex="-1"></a>      <span class="co"># add a second vector outline (blue)</span></span>
<span id="cb166-13"><a href="data_fusion.html#cb166-13" tabindex="-1"></a>      <span class="fu">lines</span>(</span>
<span id="cb166-14"><a href="data_fusion.html#cb166-14" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb166-15"><a href="data_fusion.html#cb166-15" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb166-16"><a href="data_fusion.html#cb166-16" tabindex="-1"></a>            slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb166-17"><a href="data_fusion.html#cb166-17" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb166-18"><a href="data_fusion.html#cb166-18" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb166-19"><a href="data_fusion.html#cb166-19" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb166-20"><a href="data_fusion.html#cb166-20" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb166-21"><a href="data_fusion.html#cb166-21" tabindex="-1"></a>            , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb166-22"><a href="data_fusion.html#cb166-22" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb166-23"><a href="data_fusion.html#cb166-23" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb166-24"><a href="data_fusion.html#cb166-24" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb166-25"><a href="data_fusion.html#cb166-25" tabindex="-1"></a>        , <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.3</span>)</span>
<span id="cb166-26"><a href="data_fusion.html#cb166-26" tabindex="-1"></a>    }</span>
<span id="cb166-27"><a href="data_fusion.html#cb166-27" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-153-1.png" width="1008" /></p>
</div>
<div id="spectral-index-of-polygons" class="section level3 hasAnchor" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Spectral Index of Polygons<a href="data_fusion.html#spectral-index-of-polygons" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we now need a function to crop the raster with all spectral indices given a polygon input data and return the spectral index values as columns attached to the polygon</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="data_fusion.html#cb167-1" tabindex="-1"></a>extract_rast_values <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data, rast, <span class="at">fun_agg =</span> mean) {</span>
<span id="cb167-2"><a href="data_fusion.html#cb167-2" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb167-3"><a href="data_fusion.html#cb167-3" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb167-4"><a href="data_fusion.html#cb167-4" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `rast` must be a SpatRaster object.&quot;</span>)</span>
<span id="cb167-5"><a href="data_fusion.html#cb167-5" tabindex="-1"></a>  }</span>
<span id="cb167-6"><a href="data_fusion.html#cb167-6" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){</span>
<span id="cb167-7"><a href="data_fusion.html#cb167-7" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must be an sf data frame.&quot;</span>)</span>
<span id="cb167-8"><a href="data_fusion.html#cb167-8" tabindex="-1"></a>  }</span>
<span id="cb167-9"><a href="data_fusion.html#cb167-9" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(sf_data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) {</span>
<span id="cb167-10"><a href="data_fusion.html#cb167-10" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must contain polygon geometries.&quot;</span>)</span>
<span id="cb167-11"><a href="data_fusion.html#cb167-11" tabindex="-1"></a>  }</span>
<span id="cb167-12"><a href="data_fusion.html#cb167-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.function</span>(fun_agg)) {</span>
<span id="cb167-13"><a href="data_fusion.html#cb167-13" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Argument `fun_agg` must be a function (e.g., mean, median, sum).&quot;</span>)</span>
<span id="cb167-14"><a href="data_fusion.html#cb167-14" tabindex="-1"></a>  }</span>
<span id="cb167-15"><a href="data_fusion.html#cb167-15" tabindex="-1"></a></span>
<span id="cb167-16"><a href="data_fusion.html#cb167-16" tabindex="-1"></a>  <span class="co"># crs</span></span>
<span id="cb167-17"><a href="data_fusion.html#cb167-17" tabindex="-1"></a>  sf_data <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(rast))</span>
<span id="cb167-18"><a href="data_fusion.html#cb167-18" tabindex="-1"></a></span>
<span id="cb167-19"><a href="data_fusion.html#cb167-19" tabindex="-1"></a>  <span class="co"># extract values for each layer within each polygon</span></span>
<span id="cb167-20"><a href="data_fusion.html#cb167-20" tabindex="-1"></a>  extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb167-21"><a href="data_fusion.html#cb167-21" tabindex="-1"></a>    <span class="at">x =</span> rast</span>
<span id="cb167-22"><a href="data_fusion.html#cb167-22" tabindex="-1"></a>    , <span class="at">y =</span> sf_data</span>
<span id="cb167-23"><a href="data_fusion.html#cb167-23" tabindex="-1"></a>    , <span class="at">fun =</span> fun_agg</span>
<span id="cb167-24"><a href="data_fusion.html#cb167-24" tabindex="-1"></a>    , <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb167-25"><a href="data_fusion.html#cb167-25" tabindex="-1"></a>  )</span>
<span id="cb167-26"><a href="data_fusion.html#cb167-26" tabindex="-1"></a></span>
<span id="cb167-27"><a href="data_fusion.html#cb167-27" tabindex="-1"></a>  <span class="co"># clean data</span></span>
<span id="cb167-28"><a href="data_fusion.html#cb167-28" tabindex="-1"></a>  fun_name <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(fun_agg))</span>
<span id="cb167-29"><a href="data_fusion.html#cb167-29" tabindex="-1"></a>  extracted_values <span class="ot">&lt;-</span> extracted_values <span class="sc">%&gt;%</span> </span>
<span id="cb167-30"><a href="data_fusion.html#cb167-30" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>ID) <span class="sc">%&gt;%</span> </span>
<span id="cb167-31"><a href="data_fusion.html#cb167-31" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(</span>
<span id="cb167-32"><a href="data_fusion.html#cb167-32" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">paste0</span>(</span>
<span id="cb167-33"><a href="data_fusion.html#cb167-33" tabindex="-1"></a>        <span class="st">&quot;rast_&quot;</span></span>
<span id="cb167-34"><a href="data_fusion.html#cb167-34" tabindex="-1"></a>        <span class="co"># , fun_name </span><span class="al">###</span><span class="co"> if we want to have custom output depending on the fun_agg</span></span>
<span id="cb167-35"><a href="data_fusion.html#cb167-35" tabindex="-1"></a>        , <span class="st">&quot;agg&quot;</span></span>
<span id="cb167-36"><a href="data_fusion.html#cb167-36" tabindex="-1"></a>        , <span class="st">&quot;_&quot;</span></span>
<span id="cb167-37"><a href="data_fusion.html#cb167-37" tabindex="-1"></a>        , .x</span>
<span id="cb167-38"><a href="data_fusion.html#cb167-38" tabindex="-1"></a>        , <span class="at">recycle0 =</span> <span class="cn">TRUE</span></span>
<span id="cb167-39"><a href="data_fusion.html#cb167-39" tabindex="-1"></a>      )</span>
<span id="cb167-40"><a href="data_fusion.html#cb167-40" tabindex="-1"></a>    )</span>
<span id="cb167-41"><a href="data_fusion.html#cb167-41" tabindex="-1"></a></span>
<span id="cb167-42"><a href="data_fusion.html#cb167-42" tabindex="-1"></a>  <span class="co"># Merge the extracted values back to the original sf data frame</span></span>
<span id="cb167-43"><a href="data_fusion.html#cb167-43" tabindex="-1"></a>  <span class="co"># The row order is preserved by terra::extract, so a direct cbind is safe</span></span>
<span id="cb167-44"><a href="data_fusion.html#cb167-44" tabindex="-1"></a>  <span class="co"># if no rows were dropped due to spatial mismatch.</span></span>
<span id="cb167-45"><a href="data_fusion.html#cb167-45" tabindex="-1"></a>  <span class="co"># For robustness, we can explicitly join by row ID if needed, but for simple cases, cbind works.</span></span>
<span id="cb167-46"><a href="data_fusion.html#cb167-46" tabindex="-1"></a>  <span class="co"># Assuming sf_data has a unique ID column or row order is stable:</span></span>
<span id="cb167-47"><a href="data_fusion.html#cb167-47" tabindex="-1"></a>  sf_data_with_indices <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(extracted_values)</span>
<span id="cb167-48"><a href="data_fusion.html#cb167-48" tabindex="-1"></a></span>
<span id="cb167-49"><a href="data_fusion.html#cb167-49" tabindex="-1"></a>  <span class="fu">return</span>(sf_data_with_indices)</span>
<span id="cb167-50"><a href="data_fusion.html#cb167-50" tabindex="-1"></a>}</span>
<span id="cb167-51"><a href="data_fusion.html#cb167-51" tabindex="-1"></a><span class="co"># extract_rast_values(slash_piles_polys, rast = ortho_rast) %&gt;% dplyr::glimpse()</span></span></code></pre></div>
</div>
</div>
<div id="ground-truth-pile-spectral-summary" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Ground Truth Pile Spectral Summary<a href="data_fusion.html#ground-truth-pile-spectral-summary" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>let’s calculate the various spectral indices on our ground truth slash pile polygons by getting the median value within the bounds of the pile</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="data_fusion.html#cb168-1" tabindex="-1"></a><span class="co"># extract_rast_values</span></span>
<span id="cb168-2"><a href="data_fusion.html#cb168-2" tabindex="-1"></a>rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">extract_rast_values</span>(slash_piles_polys, <span class="at">rast =</span> all_rgb_indices_rast, <span class="at">fun_agg =</span> median)</span>
<span id="cb168-3"><a href="data_fusion.html#cb168-3" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 187
## Columns: 28
## $ pile_id             &lt;dbl&gt; 3, 4, 5, 6, 8, 11, 13, 15, 16, 17, 19, 20, 21, 22,…
## $ comment             &lt;chr&gt; NA, NA, NA, NA, &quot;Mechanical Pile&quot;, NA, NA, NA, NA,…
## $ comment2            &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ height_ft           &lt;dbl&gt; NA, NA, NA, NA, 14.0, NA, NA, NA, NA, NA, NA, NA, …
## $ diameter_ft         &lt;dbl&gt; NA, NA, NA, NA, 22.0, NA, NA, NA, NA, NA, NA, NA, …
## $ xcoord              &lt;dbl&gt; NA, NA, NA, NA, 1019078, NA, NA, NA, NA, NA, NA, N…
## $ ycoord              &lt;dbl&gt; NA, NA, NA, NA, 4334862, NA, NA, NA, NA, NA, NA, N…
## $ refcorner           &lt;chr&gt; NA, NA, NA, NA, &quot;G4&quot;, NA, NA, NA, NA, NA, NA, NA, …
## $ row_number          &lt;int&gt; NA, NA, NA, NA, 93, NA, NA, NA, NA, NA, NA, NA, NA…
## $ geometry            &lt;POLYGON [m]&gt; POLYGON ((499341.7 4317759,..., POLYGON ((…
## $ image_gt_diameter_m &lt;dbl&gt; 6.469934, 6.867876, 6.387723, 6.589466, 7.595808, …
## $ height_m            &lt;dbl&gt; NA, NA, NA, NA, 4.2672, NA, NA, NA, NA, NA, NA, NA…
## $ field_diameter_m    &lt;dbl&gt; NA, NA, NA, NA, 6.7056, NA, NA, NA, NA, NA, NA, NA…
## $ field_radius_m      &lt;dbl&gt; NA, NA, NA, NA, 3.3528, NA, NA, NA, NA, NA, NA, NA…
## $ image_gt_area_m2    &lt;dbl&gt; 25.166539, 32.028082, 22.928349, 26.261937, 28.909…
## $ field_gt_area_m2    &lt;dbl&gt; NA, NA, NA, NA, 35.315484, NA, NA, NA, NA, NA, NA,…
## $ image_gt_volume_m3  &lt;dbl&gt; NA, NA, NA, NA, 61.682109, NA, NA, NA, NA, NA, NA,…
## $ field_gt_volume_m3  &lt;dbl&gt; NA, NA, NA, NA, 75.34912, NA, NA, NA, NA, NA, NA, …
## $ is_in_stand         &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FA…
## $ rast_agg_grvi       &lt;dbl&gt; -0.032584086, -0.028242828, -0.052384051, -0.04705…
## $ rast_agg_rgri       &lt;dbl&gt; 1.0673631, 1.0581273, 1.1105597, 1.0987591, 1.0457…
## $ rast_agg_vdvi       &lt;dbl&gt; -0.01943105, -0.02085224, -0.02775876, -0.02476903…
## $ rast_agg_rgbvi      &lt;dbl&gt; -0.03828319, -0.04091964, -0.05317091, -0.04778023…
## $ rast_agg_exg        &lt;dbl&gt; -0.02574134, -0.02761107, -0.03667236, -0.03275494…
## $ rast_agg_exr        &lt;dbl&gt; 0.16016840, 0.15627252, 0.17784675, 0.17298965, 0.…
## $ rast_agg_exgr       &lt;dbl&gt; -0.1866028, -0.1835047, -0.2156208, -0.2073676, -0…
## $ rast_agg_bi         &lt;dbl&gt; 0.48999473, 0.50380811, 0.41243017, 0.43621239, 0.…
## $ rast_agg_sat        &lt;dbl&gt; 0.06838244, 0.06986231, 0.11602359, 0.09983881, 0.…</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="data_fusion.html#cb170-1" tabindex="-1"></a><span class="co"># quick summary</span></span>
<span id="cb170-2"><a href="data_fusion.html#cb170-2" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb170-3"><a href="data_fusion.html#cb170-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb170-4"><a href="data_fusion.html#cb170-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb170-5"><a href="data_fusion.html#cb170-5" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##  rast_agg_grvi        rast_agg_rgri    rast_agg_vdvi        rast_agg_rgbvi     
##  Min.   :-0.0523841   Min.   :0.7814   Min.   :-0.0380903   Min.   :-0.066556  
##  1st Qu.:-0.0183949   1st Qu.:0.9919   1st Qu.:-0.0150468   1st Qu.:-0.028208  
##  Median :-0.0051776   Median :1.0104   Median : 0.0060960   Median : 0.016233  
##  Mean   :-0.0007363   Mean   :1.0030   Mean   :-0.0001669   Mean   : 0.002146  
##  3rd Qu.: 0.0040900   3rd Qu.:1.0375   3rd Qu.: 0.0138264   3rd Qu.: 0.028844  
##  Max.   : 0.1227404   Max.   :1.1106   Max.   : 0.0223162   Max.   : 0.045439  
##   rast_agg_exg         rast_agg_exr     rast_agg_exgr       rast_agg_bi     
##  Min.   :-0.0501504   Min.   :0.03125   Min.   :-0.21562   Min.   :0.05521  
##  1st Qu.:-0.0199623   1st Qu.:0.13239   1st Qu.:-0.15365   1st Qu.:0.35286  
##  Median : 0.0081446   Median :0.13834   Median :-0.13253   Median :0.47475  
##  Mean   :-0.0001212   Mean   :0.13466   Mean   :-0.13491   Mean   :0.40386  
##  3rd Qu.: 0.0185206   3rd Qu.:0.15020   3rd Qu.:-0.11602   3rd Qu.:0.50461  
##  Max.   : 0.0299779   Max.   :0.17785   Max.   :-0.03701   Max.   :0.61996  
##   rast_agg_sat    
##  Min.   :0.02616  
##  1st Qu.:0.06252  
##  Median :0.07335  
##  Mean   :0.09759  
##  3rd Qu.:0.11510  
##  Max.   :0.36490</code></pre>
<p>let’s plot it</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="data_fusion.html#cb172-1" tabindex="-1"></a><span class="co"># pivot</span></span>
<span id="cb172-2"><a href="data_fusion.html#cb172-2" tabindex="-1"></a>agg_df_temp <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb172-3"><a href="data_fusion.html#cb172-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb172-4"><a href="data_fusion.html#cb172-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb172-5"><a href="data_fusion.html#cb172-5" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb172-6"><a href="data_fusion.html#cb172-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;rast_agg_&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_upper</span>())</span>
<span id="cb172-7"><a href="data_fusion.html#cb172-7" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb172-8"><a href="data_fusion.html#cb172-8" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb172-9"><a href="data_fusion.html#cb172-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(</span>
<span id="cb172-10"><a href="data_fusion.html#cb172-10" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp</span>
<span id="cb172-11"><a href="data_fusion.html#cb172-11" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name)</span>
<span id="cb172-12"><a href="data_fusion.html#cb172-12" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb172-13"><a href="data_fusion.html#cb172-13" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb172-14"><a href="data_fusion.html#cb172-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb172-15"><a href="data_fusion.html#cb172-15" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">value=</span><span class="fu">median</span>(value,<span class="at">na.rm=</span>T))</span>
<span id="cb172-16"><a href="data_fusion.html#cb172-16" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;median&quot;</span>)</span>
<span id="cb172-17"><a href="data_fusion.html#cb172-17" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb172-18"><a href="data_fusion.html#cb172-18" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb172-19"><a href="data_fusion.html#cb172-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb172-20"><a href="data_fusion.html#cb172-20" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">value=</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs=</span><span class="fl">0.025</span>))</span>
<span id="cb172-21"><a href="data_fusion.html#cb172-21" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;p2.5–p97.5&quot;</span>)</span>
<span id="cb172-22"><a href="data_fusion.html#cb172-22" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb172-23"><a href="data_fusion.html#cb172-23" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb172-24"><a href="data_fusion.html#cb172-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb172-25"><a href="data_fusion.html#cb172-25" tabindex="-1"></a>    <span class="at">data =</span> agg_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">value=</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs=</span>(<span class="dv">1</span><span class="fl">-0.025</span>)))</span>
<span id="cb172-26"><a href="data_fusion.html#cb172-26" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">xintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;p2.5–p97.5&quot;</span>)</span>
<span id="cb172-27"><a href="data_fusion.html#cb172-27" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb172-28"><a href="data_fusion.html#cb172-28" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb172-29"><a href="data_fusion.html#cb172-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>, <span class="at">begin =</span> <span class="fl">0.1</span>, <span class="at">end =</span> <span class="fl">0.9</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb172-30"><a href="data_fusion.html#cb172-30" tabindex="-1"></a>  <span class="co"># ggplot2::scale_fill_brewer(palette = &quot;Set2&quot;) +</span></span>
<span id="cb172-31"><a href="data_fusion.html#cb172-31" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray22&quot;</span>,<span class="st">&quot;gray&quot;</span>,<span class="st">&quot;gray&quot;</span>)) <span class="sc">+</span></span>
<span id="cb172-32"><a href="data_fusion.html#cb172-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb172-33"><a href="data_fusion.html#cb172-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb172-34"><a href="data_fusion.html#cb172-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb172-35"><a href="data_fusion.html#cb172-35" tabindex="-1"></a>    <span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)</span>
<span id="cb172-36"><a href="data_fusion.html#cb172-36" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">3</span></span>
<span id="cb172-37"><a href="data_fusion.html#cb172-37" tabindex="-1"></a>    , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb172-38"><a href="data_fusion.html#cb172-38" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb172-39"><a href="data_fusion.html#cb172-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb172-40"><a href="data_fusion.html#cb172-40" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb172-41"><a href="data_fusion.html#cb172-41" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb172-42"><a href="data_fusion.html#cb172-42" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb172-43"><a href="data_fusion.html#cb172-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb172-44"><a href="data_fusion.html#cb172-44" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb172-45"><a href="data_fusion.html#cb172-45" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb172-46"><a href="data_fusion.html#cb172-46" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb172-47"><a href="data_fusion.html#cb172-47" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb172-48"><a href="data_fusion.html#cb172-48" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb172-49"><a href="data_fusion.html#cb172-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-156-1.png" width="1008" /></p>
<p>that’s interesting. let’s see how those values compare with the thresholds identified in the research to identify green crops, trees, and shrubs using RGB spectral indicies</p>
<table>
<colgroup>
<col width="11%" />
<col width="19%" />
<col width="19%" />
<col width="20%" />
<col width="29%" />
</colgroup>
<thead>
<tr class="header">
<th>Index</th>
<th>Likely Crop</th>
<th>Likely Tree</th>
<th>Likely Shrub</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>VDVI</td>
<td>x &gt; 0.06</td>
<td>x &gt; 0.04</td>
<td>x &gt; 0.03</td>
<td>Wang et al. 2025</td>
</tr>
<tr class="even">
<td>RGRI</td>
<td>x &lt; 0.63</td>
<td>x &lt; 0.70</td>
<td>x &lt; 0.52</td>
<td>Wang et al. 2025</td>
</tr>
<tr class="odd">
<td>RGBVI</td>
<td>x &gt; -20.0</td>
<td>x &gt; -22.0</td>
<td>x &gt; -18.0</td>
<td>Wang et al. 2025</td>
</tr>
<tr class="even">
<td>ExG</td>
<td>x &gt; 58.0</td>
<td>x &gt; 59.5</td>
<td>x &gt; 59.0</td>
<td>Wang et al. 2025</td>
</tr>
<tr class="odd">
<td>GRVI</td>
<td>x &gt; 0.0</td>
<td>x &gt; 0.0</td>
<td></td>
<td>Motohka et al. 2010</td>
</tr>
<tr class="even">
<td>ExGR</td>
<td>x &gt; 0.0</td>
<td>x &gt; 0.0</td>
<td>x &gt; 0.0</td>
<td>Riehle et al. 2020</td>
</tr>
</tbody>
</table>
<ul>
<li>VDVI: setting a threshold to remove candidate slash piles with VDVI&gt;0.03 should <em>work well</em></li>
<li>RGRI: setting a threshold to remove candidate slash piles with RGRI&lt;0.70 should <em>work well</em></li>
<li>RGBVI: setting a threshold to remove candidate slash piles with RGBVI&gt;-18.0 should <em>not work well</em>
<ul>
<li>There appears to be a mis-match between the range of values we calculated ([-1.00, 1.00]) and their range ([-50, 78])</li>
</ul></li>
<li>ExG: setting a threshold to remove candidate slash piles with ExG&gt;59.5 should <em>not work well</em>
<ul>
<li>There appears to be a mis-match between the range of values we calculated ([-1.00, 2.00]) and their range ([0, 150])</li>
</ul></li>
<li>GRVI: setting a threshold to remove candidate slash piles with GRVI&gt;0.0 should <em>work moderately well</em>
<ul>
<li>We may need to raise this threshold to remove candidate slash piles with GRVI&gt;0.05, for example</li>
</ul></li>
<li>ExGR: setting a threshold to remove candidate slash piles with ExGR&gt;0.0 should <em>work well</em></li>
<li>BI: setting a threshold to remove candidate slash piles that are extremely dark (BI&lt;0.10) or bright (BI&gt;0.90) should <em>work well</em></li>
<li>Saturation: setting a threshold to remove candidate slash piles that have low saturation values (SAT&lt;0.03) should <em>work well</em></li>
</ul>
<p>Based on these thresholds identified in the literature and our objective to remove very highly correlated indices, we’ll proceed with the following five indices to refine the structurally detected candidate slash piles:</p>
<ol style="list-style-type: decimal">
<li>RGRI</li>
<li>VDVI</li>
<li>ExGR</li>
<li>BI</li>
<li>Saturation (SAT)</li>
</ol>
<p>here is a plot of the median value of the different spectral indices (high values are brighter, low values are darker) within the bounds of the pile on our example area we were working with in the last section</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="data_fusion.html#cb173-1" tabindex="-1"></a>polys_temp <span class="ot">&lt;-</span></span>
<span id="cb173-2"><a href="data_fusion.html#cb173-2" tabindex="-1"></a>  rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb173-3"><a href="data_fusion.html#cb173-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb173-4"><a href="data_fusion.html#cb173-4" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb173-5"><a href="data_fusion.html#cb173-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb173-6"><a href="data_fusion.html#cb173-6" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb173-7"><a href="data_fusion.html#cb173-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb173-8"><a href="data_fusion.html#cb173-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb173-9"><a href="data_fusion.html#cb173-9" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb173-10"><a href="data_fusion.html#cb173-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb173-11"><a href="data_fusion.html#cb173-11" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb173-12"><a href="data_fusion.html#cb173-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id, tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb173-13"><a href="data_fusion.html#cb173-13" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rast_agg_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb173-14"><a href="data_fusion.html#cb173-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(name,<span class="st">&quot;rast_agg_&quot;</span>))</span>
<span id="cb173-15"><a href="data_fusion.html#cb173-15" tabindex="-1"></a>  <span class="co"># # dplyr::filter(name==&quot;grvi&quot;) %&gt;% </span></span>
<span id="cb173-16"><a href="data_fusion.html#cb173-16" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() + </span></span>
<span id="cb173-17"><a href="data_fusion.html#cb173-17" tabindex="-1"></a>  <span class="co">#   ggplot2::geom_sf(mapping=ggplot2::aes(fill=value)) + </span></span>
<span id="cb173-18"><a href="data_fusion.html#cb173-18" tabindex="-1"></a>  <span class="co">#   ggplot2::facet_wrap(facets=dplyr::vars(name)) +</span></span>
<span id="cb173-19"><a href="data_fusion.html#cb173-19" tabindex="-1"></a>  <span class="co">#   ggplot2::theme_void() +</span></span>
<span id="cb173-20"><a href="data_fusion.html#cb173-20" tabindex="-1"></a>  <span class="co">#   ggplot2::theme(legend.position = &quot;top&quot;)</span></span>
<span id="cb173-21"><a href="data_fusion.html#cb173-21" tabindex="-1"></a><span class="co"># rast clip</span></span>
<span id="cb173-22"><a href="data_fusion.html#cb173-22" tabindex="-1"></a>rast_temp <span class="ot">&lt;-</span> all_rgb_indices_rast <span class="sc">%&gt;%</span> </span>
<span id="cb173-23"><a href="data_fusion.html#cb173-23" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(example_aoi <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">7.3</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb173-24"><a href="data_fusion.html#cb173-24" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">mask</span>(example_aoi <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">7.3</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()) </span>
<span id="cb173-25"><a href="data_fusion.html#cb173-25" tabindex="-1"></a></span>
<span id="cb173-26"><a href="data_fusion.html#cb173-26" tabindex="-1"></a><span class="co"># plot list</span></span>
<span id="cb173-27"><a href="data_fusion.html#cb173-27" tabindex="-1"></a>plt_list_temp <span class="ot">&lt;-</span> </span>
<span id="cb173-28"><a href="data_fusion.html#cb173-28" tabindex="-1"></a>  <span class="fu">names</span>(all_rgb_indices_rast) <span class="sc">%&gt;%</span> </span>
<span id="cb173-29"><a href="data_fusion.html#cb173-29" tabindex="-1"></a>  <span class="co"># sample(6) %&gt;%</span></span>
<span id="cb173-30"><a href="data_fusion.html#cb173-30" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb173-31"><a href="data_fusion.html#cb173-31" tabindex="-1"></a>    \(x)</span>
<span id="cb173-32"><a href="data_fusion.html#cb173-32" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb173-33"><a href="data_fusion.html#cb173-33" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb173-34"><a href="data_fusion.html#cb173-34" tabindex="-1"></a>        <span class="at">data =</span> rast_temp[[x]] <span class="sc">%&gt;%</span> </span>
<span id="cb173-35"><a href="data_fusion.html#cb173-35" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb173-36"><a href="data_fusion.html#cb173-36" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb173-37"><a href="data_fusion.html#cb173-37" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> f)</span>
<span id="cb173-38"><a href="data_fusion.html#cb173-38" tabindex="-1"></a>        , <span class="at">alpha =</span> <span class="fl">0.9</span></span>
<span id="cb173-39"><a href="data_fusion.html#cb173-39" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb173-40"><a href="data_fusion.html#cb173-40" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb173-41"><a href="data_fusion.html#cb173-41" tabindex="-1"></a>        <span class="at">data =</span> example_aoi</span>
<span id="cb173-42"><a href="data_fusion.html#cb173-42" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">0.8</span></span>
<span id="cb173-43"><a href="data_fusion.html#cb173-43" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb173-44"><a href="data_fusion.html#cb173-44" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb173-45"><a href="data_fusion.html#cb173-45" tabindex="-1"></a>        <span class="at">data =</span> polys_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(name <span class="sc">==</span> x)</span>
<span id="cb173-46"><a href="data_fusion.html#cb173-46" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill=</span>value)</span>
<span id="cb173-47"><a href="data_fusion.html#cb173-47" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb173-48"><a href="data_fusion.html#cb173-48" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb173-49"><a href="data_fusion.html#cb173-49" tabindex="-1"></a>      <span class="co"># ggplot2::geom_sf_text(</span></span>
<span id="cb173-50"><a href="data_fusion.html#cb173-50" tabindex="-1"></a>      <span class="co">#   data = polys_temp %&gt;% dplyr::filter(name == x)</span></span>
<span id="cb173-51"><a href="data_fusion.html#cb173-51" tabindex="-1"></a>      <span class="co">#   , mapping = ggplot2::aes(label=scales::comma(value, accuracy=0.01), fontface = &quot;bold&quot;)</span></span>
<span id="cb173-52"><a href="data_fusion.html#cb173-52" tabindex="-1"></a>      <span class="co">#   , size = 1.7, color = &quot;blue&quot;</span></span>
<span id="cb173-53"><a href="data_fusion.html#cb173-53" tabindex="-1"></a>      <span class="co">#   , vjust = 0, hjust = 0.5</span></span>
<span id="cb173-54"><a href="data_fusion.html#cb173-54" tabindex="-1"></a>      <span class="co"># ) +</span></span>
<span id="cb173-55"><a href="data_fusion.html#cb173-55" tabindex="-1"></a>      ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb173-56"><a href="data_fusion.html#cb173-56" tabindex="-1"></a>        <span class="at">data =</span> polys_temp <span class="sc">%&gt;%</span> </span>
<span id="cb173-57"><a href="data_fusion.html#cb173-57" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(name <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb173-58"><a href="data_fusion.html#cb173-58" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_point_on_surface</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb173-59"><a href="data_fusion.html#cb173-59" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb173-60"><a href="data_fusion.html#cb173-60" tabindex="-1"></a>            <span class="at">x_coord =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[, <span class="dv">1</span>]</span>
<span id="cb173-61"><a href="data_fusion.html#cb173-61" tabindex="-1"></a>            , <span class="at">y_coord =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[, <span class="dv">2</span>]</span>
<span id="cb173-62"><a href="data_fusion.html#cb173-62" tabindex="-1"></a>          )</span>
<span id="cb173-63"><a href="data_fusion.html#cb173-63" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x_coord, <span class="at">y =</span> y_coord, <span class="at">label=</span>scales<span class="sc">::</span><span class="fu">comma</span>(value, <span class="at">accuracy=</span><span class="fl">0.01</span>), <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb173-64"><a href="data_fusion.html#cb173-64" tabindex="-1"></a>        , <span class="at">nudge_x =</span> <span class="fl">0.5</span> <span class="co"># initial horizontal nudge</span></span>
<span id="cb173-65"><a href="data_fusion.html#cb173-65" tabindex="-1"></a>        , <span class="at">nudge_y =</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="co"># initial vertical nudge</span></span>
<span id="cb173-66"><a href="data_fusion.html#cb173-66" tabindex="-1"></a>        , <span class="at">size =</span> <span class="fl">2.2</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span></span>
<span id="cb173-67"><a href="data_fusion.html#cb173-67" tabindex="-1"></a>        , <span class="at">force =</span> <span class="dv">1</span></span>
<span id="cb173-68"><a href="data_fusion.html#cb173-68" tabindex="-1"></a>        , <span class="at">box.padding =</span> <span class="fl">0.3</span> <span class="co"># Increase padding to push labels further away</span></span>
<span id="cb173-69"><a href="data_fusion.html#cb173-69" tabindex="-1"></a>        <span class="co"># , point.padding = 0.7 # Ensure distance from the original point</span></span>
<span id="cb173-70"><a href="data_fusion.html#cb173-70" tabindex="-1"></a>        , <span class="at">min.segment.length =</span> <span class="fl">0.5</span> <span class="co"># Minimum length of the connecting line segment</span></span>
<span id="cb173-71"><a href="data_fusion.html#cb173-71" tabindex="-1"></a>        , <span class="at">segment.color =</span> <span class="cn">NA</span></span>
<span id="cb173-72"><a href="data_fusion.html#cb173-72" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb173-73"><a href="data_fusion.html#cb173-73" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Greys&quot;</span>) <span class="sc">+</span></span>
<span id="cb173-74"><a href="data_fusion.html#cb173-74" tabindex="-1"></a>      <span class="co"># ggplot2::scale_fill_gradientn(colors = grDevices::gray.colors(111, start = 0, end = 1)) +</span></span>
<span id="cb173-75"><a href="data_fusion.html#cb173-75" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb173-76"><a href="data_fusion.html#cb173-76" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb173-77"><a href="data_fusion.html#cb173-77" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb173-78"><a href="data_fusion.html#cb173-78" tabindex="-1"></a>        <span class="at">fill =</span> x</span>
<span id="cb173-79"><a href="data_fusion.html#cb173-79" tabindex="-1"></a>        , <span class="at">subtitle =</span> x</span>
<span id="cb173-80"><a href="data_fusion.html#cb173-80" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb173-81"><a href="data_fusion.html#cb173-81" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb173-82"><a href="data_fusion.html#cb173-82" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb173-83"><a href="data_fusion.html#cb173-83" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb173-84"><a href="data_fusion.html#cb173-84" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb173-85"><a href="data_fusion.html#cb173-85" tabindex="-1"></a>      )</span>
<span id="cb173-86"><a href="data_fusion.html#cb173-86" tabindex="-1"></a>  )</span>
<span id="cb173-87"><a href="data_fusion.html#cb173-87" tabindex="-1"></a><span class="co"># plt_list_temp</span></span>
<span id="cb173-88"><a href="data_fusion.html#cb173-88" tabindex="-1"></a><span class="co"># patchwork</span></span>
<span id="cb173-89"><a href="data_fusion.html#cb173-89" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb173-90"><a href="data_fusion.html#cb173-90" tabindex="-1"></a>  plt_list_temp</span>
<span id="cb173-91"><a href="data_fusion.html#cb173-91" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">3</span></span>
<span id="cb173-92"><a href="data_fusion.html#cb173-92" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-157-1.png" width="1008" /></p>
<div id="voting-system" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Voting System<a href="data_fusion.html#voting-system" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s consider a voting system approach for filtering candidate slash piles using the multiple spectral indices. a voting system could allow for a more robust and nuanced decision than relying on a single index.</p>
<p>let’s make a highly specialized function using the data returned by out <code>extract_rast_values()</code> function</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="data_fusion.html#cb174-1" tabindex="-1"></a>rgb_indices_threshold_voting <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb174-2"><a href="data_fusion.html#cb174-2" tabindex="-1"></a>  rgb_indices_df</span>
<span id="cb174-3"><a href="data_fusion.html#cb174-3" tabindex="-1"></a>  <span class="co"># define ranges to *keep* piles</span></span>
<span id="cb174-4"><a href="data_fusion.html#cb174-4" tabindex="-1"></a>  , <span class="at">th_rgri =</span> <span class="fu">c</span>((<span class="fl">0.7+0.001</span>),<span class="cn">Inf</span>) <span class="co"># increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb174-5"><a href="data_fusion.html#cb174-5" tabindex="-1"></a>  , <span class="at">th_vdvi =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,(<span class="fl">0.03+0.001</span>)) <span class="co"># increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb174-6"><a href="data_fusion.html#cb174-6" tabindex="-1"></a>  , <span class="at">th_exgr =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="dv">0</span>)</span>
<span id="cb174-7"><a href="data_fusion.html#cb174-7" tabindex="-1"></a>  , <span class="at">th_bi =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.9</span>)</span>
<span id="cb174-8"><a href="data_fusion.html#cb174-8" tabindex="-1"></a>  , <span class="at">th_sat =</span> <span class="fu">c</span>(<span class="fl">0.03</span>,<span class="cn">Inf</span>)</span>
<span id="cb174-9"><a href="data_fusion.html#cb174-9" tabindex="-1"></a>){</span>
<span id="cb174-10"><a href="data_fusion.html#cb174-10" tabindex="-1"></a></span>
<span id="cb174-11"><a href="data_fusion.html#cb174-11" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb174-12"><a href="data_fusion.html#cb174-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rgb_indices_df, <span class="st">&quot;data.frame&quot;</span>)){</span>
<span id="cb174-13"><a href="data_fusion.html#cb174-13" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Input `rgb_indices_df` must be an data.frame.&quot;</span>)</span>
<span id="cb174-14"><a href="data_fusion.html#cb174-14" tabindex="-1"></a>  }</span>
<span id="cb174-15"><a href="data_fusion.html#cb174-15" tabindex="-1"></a>  <span class="co"># names</span></span>
<span id="cb174-16"><a href="data_fusion.html#cb174-16" tabindex="-1"></a>  agg_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;rast_agg_exgr&quot;</span>,<span class="st">&quot;rast_agg_rgri&quot;</span>,<span class="st">&quot;rast_agg_vdvi&quot;</span>,<span class="st">&quot;rast_agg_bi&quot;</span>,<span class="st">&quot;rast_agg_sat&quot;</span>) <span class="co"># &quot;rast_agg_rgbvi&quot;,</span></span>
<span id="cb174-17"><a href="data_fusion.html#cb174-17" tabindex="-1"></a>  nm_diff <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">setdiff</span>(</span>
<span id="cb174-18"><a href="data_fusion.html#cb174-18" tabindex="-1"></a>    agg_cols</span>
<span id="cb174-19"><a href="data_fusion.html#cb174-19" tabindex="-1"></a>    , <span class="fu">names</span>(rgb_indices_df)</span>
<span id="cb174-20"><a href="data_fusion.html#cb174-20" tabindex="-1"></a>  )</span>
<span id="cb174-21"><a href="data_fusion.html#cb174-21" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(nm_diff)<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb174-22"><a href="data_fusion.html#cb174-22" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;required variables missing:</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;... &quot;</span>, <span class="fu">paste</span>(nm_diff, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>) ))</span>
<span id="cb174-23"><a href="data_fusion.html#cb174-23" tabindex="-1"></a>  }</span>
<span id="cb174-24"><a href="data_fusion.html#cb174-24" tabindex="-1"></a>  <span class="co"># thresholds</span></span>
<span id="cb174-25"><a href="data_fusion.html#cb174-25" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(th_exgr)<span class="sc">!=</span><span class="dv">2</span> <span class="sc">||</span> th_exgr[<span class="dv">1</span>]<span class="sc">&gt;</span>th_exgr[<span class="dv">2</span>]){</span>
<span id="cb174-26"><a href="data_fusion.html#cb174-26" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `th_exgr` must be of length 2 as: c(lower,upper) defining the range of values to keep where lower&lt;=upper&quot;</span>)</span>
<span id="cb174-27"><a href="data_fusion.html#cb174-27" tabindex="-1"></a>  }</span>
<span id="cb174-28"><a href="data_fusion.html#cb174-28" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(th_rgri)<span class="sc">!=</span><span class="dv">2</span> <span class="sc">||</span> th_rgri[<span class="dv">1</span>]<span class="sc">&gt;</span>th_rgri[<span class="dv">2</span>]){</span>
<span id="cb174-29"><a href="data_fusion.html#cb174-29" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `th_rgri` must be of length 2 as: c(lower,upper) defining the range of values to keep where lower&lt;=upper&quot;</span>)</span>
<span id="cb174-30"><a href="data_fusion.html#cb174-30" tabindex="-1"></a>  }</span>
<span id="cb174-31"><a href="data_fusion.html#cb174-31" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(th_vdvi)<span class="sc">!=</span><span class="dv">2</span> <span class="sc">||</span> th_vdvi[<span class="dv">1</span>]<span class="sc">&gt;</span>th_vdvi[<span class="dv">2</span>]){</span>
<span id="cb174-32"><a href="data_fusion.html#cb174-32" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `th_vdvi` must be of length 2 as: c(lower,upper) defining the range of values to keep where lower&lt;=upper&quot;</span>)</span>
<span id="cb174-33"><a href="data_fusion.html#cb174-33" tabindex="-1"></a>  }</span>
<span id="cb174-34"><a href="data_fusion.html#cb174-34" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(th_bi)<span class="sc">!=</span><span class="dv">2</span> <span class="sc">||</span> th_bi[<span class="dv">1</span>]<span class="sc">&gt;</span>th_bi[<span class="dv">2</span>]){</span>
<span id="cb174-35"><a href="data_fusion.html#cb174-35" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `th_bi` must be of length 2 as: c(lower,upper) defining the range of values to keep where lower&lt;=upper&quot;</span>)</span>
<span id="cb174-36"><a href="data_fusion.html#cb174-36" tabindex="-1"></a>  }</span>
<span id="cb174-37"><a href="data_fusion.html#cb174-37" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(th_sat)<span class="sc">!=</span><span class="dv">2</span> <span class="sc">||</span> th_sat[<span class="dv">1</span>]<span class="sc">&gt;</span>th_sat[<span class="dv">2</span>]){</span>
<span id="cb174-38"><a href="data_fusion.html#cb174-38" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `th_sat` must be of length 2 as: c(lower,upper) defining the range of values to keep where lower&lt;=upper&quot;</span>)</span>
<span id="cb174-39"><a href="data_fusion.html#cb174-39" tabindex="-1"></a>  }</span>
<span id="cb174-40"><a href="data_fusion.html#cb174-40" tabindex="-1"></a>  </span>
<span id="cb174-41"><a href="data_fusion.html#cb174-41" tabindex="-1"></a>  <span class="co"># get rid of columns we&#39;ll create</span></span>
<span id="cb174-42"><a href="data_fusion.html#cb174-42" tabindex="-1"></a>  rgb_indices_df <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span></span>
<span id="cb174-43"><a href="data_fusion.html#cb174-43" tabindex="-1"></a>    <span class="co"># throw in hey_xxxxxxxxxx to test it works if we include non-existant columns</span></span>
<span id="cb174-44"><a href="data_fusion.html#cb174-44" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb174-45"><a href="data_fusion.html#cb174-45" tabindex="-1"></a>      <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb174-46"><a href="data_fusion.html#cb174-46" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_exgr&quot;</span></span>
<span id="cb174-47"><a href="data_fusion.html#cb174-47" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_rgri&quot;</span></span>
<span id="cb174-48"><a href="data_fusion.html#cb174-48" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_vdvi&quot;</span></span>
<span id="cb174-49"><a href="data_fusion.html#cb174-49" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_bi&quot;</span></span>
<span id="cb174-50"><a href="data_fusion.html#cb174-50" tabindex="-1"></a>      , <span class="st">&quot;inrange_th_sat&quot;</span></span>
<span id="cb174-51"><a href="data_fusion.html#cb174-51" tabindex="-1"></a>    )))</span>
<span id="cb174-52"><a href="data_fusion.html#cb174-52" tabindex="-1"></a>  </span>
<span id="cb174-53"><a href="data_fusion.html#cb174-53" tabindex="-1"></a>  <span class="co"># check threshold</span></span>
<span id="cb174-54"><a href="data_fusion.html#cb174-54" tabindex="-1"></a>  ret_df <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb174-55"><a href="data_fusion.html#cb174-55" tabindex="-1"></a>    <span class="co"># dplyr::select(dplyr::all_of(agg_cols)) %&gt;% </span></span>
<span id="cb174-56"><a href="data_fusion.html#cb174-56" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb174-57"><a href="data_fusion.html#cb174-57" tabindex="-1"></a>      <span class="at">inrange_th_exgr =</span> <span class="fu">ifelse</span>(</span>
<span id="cb174-58"><a href="data_fusion.html#cb174-58" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(rast_agg_exgr)</span>
<span id="cb174-59"><a href="data_fusion.html#cb174-59" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_exgr <span class="sc">&gt;=</span> th_exgr[<span class="dv">1</span>]</span>
<span id="cb174-60"><a href="data_fusion.html#cb174-60" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_exgr <span class="sc">&lt;=</span> th_exgr[<span class="dv">2</span>]</span>
<span id="cb174-61"><a href="data_fusion.html#cb174-61" tabindex="-1"></a>          , <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb174-62"><a href="data_fusion.html#cb174-62" tabindex="-1"></a>        )</span>
<span id="cb174-63"><a href="data_fusion.html#cb174-63" tabindex="-1"></a>      , <span class="at">inrange_th_rgri =</span> <span class="fu">ifelse</span>(</span>
<span id="cb174-64"><a href="data_fusion.html#cb174-64" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(rast_agg_rgri)</span>
<span id="cb174-65"><a href="data_fusion.html#cb174-65" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_rgri <span class="sc">&gt;=</span> th_rgri[<span class="dv">1</span>]</span>
<span id="cb174-66"><a href="data_fusion.html#cb174-66" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_rgri <span class="sc">&lt;=</span> th_rgri[<span class="dv">2</span>]</span>
<span id="cb174-67"><a href="data_fusion.html#cb174-67" tabindex="-1"></a>          , <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb174-68"><a href="data_fusion.html#cb174-68" tabindex="-1"></a>        )</span>
<span id="cb174-69"><a href="data_fusion.html#cb174-69" tabindex="-1"></a>      , <span class="at">inrange_th_vdvi =</span> <span class="fu">ifelse</span>(</span>
<span id="cb174-70"><a href="data_fusion.html#cb174-70" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(rast_agg_vdvi)</span>
<span id="cb174-71"><a href="data_fusion.html#cb174-71" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_vdvi <span class="sc">&gt;=</span> th_vdvi[<span class="dv">1</span>]</span>
<span id="cb174-72"><a href="data_fusion.html#cb174-72" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_vdvi <span class="sc">&lt;=</span> th_vdvi[<span class="dv">2</span>]</span>
<span id="cb174-73"><a href="data_fusion.html#cb174-73" tabindex="-1"></a>          , <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb174-74"><a href="data_fusion.html#cb174-74" tabindex="-1"></a>        )</span>
<span id="cb174-75"><a href="data_fusion.html#cb174-75" tabindex="-1"></a>      , <span class="at">inrange_th_bi =</span> <span class="fu">ifelse</span>(</span>
<span id="cb174-76"><a href="data_fusion.html#cb174-76" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(rast_agg_bi)</span>
<span id="cb174-77"><a href="data_fusion.html#cb174-77" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_bi <span class="sc">&gt;=</span> th_bi[<span class="dv">1</span>]</span>
<span id="cb174-78"><a href="data_fusion.html#cb174-78" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_bi <span class="sc">&lt;=</span> th_bi[<span class="dv">2</span>]</span>
<span id="cb174-79"><a href="data_fusion.html#cb174-79" tabindex="-1"></a>          , <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb174-80"><a href="data_fusion.html#cb174-80" tabindex="-1"></a>        )</span>
<span id="cb174-81"><a href="data_fusion.html#cb174-81" tabindex="-1"></a>      , <span class="at">inrange_th_sat =</span> <span class="fu">ifelse</span>(</span>
<span id="cb174-82"><a href="data_fusion.html#cb174-82" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(rast_agg_sat)</span>
<span id="cb174-83"><a href="data_fusion.html#cb174-83" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_sat <span class="sc">&gt;=</span> th_sat[<span class="dv">1</span>]</span>
<span id="cb174-84"><a href="data_fusion.html#cb174-84" tabindex="-1"></a>          <span class="sc">&amp;</span> rast_agg_sat <span class="sc">&lt;=</span> th_sat[<span class="dv">2</span>]</span>
<span id="cb174-85"><a href="data_fusion.html#cb174-85" tabindex="-1"></a>          , <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb174-86"><a href="data_fusion.html#cb174-86" tabindex="-1"></a>        )</span>
<span id="cb174-87"><a href="data_fusion.html#cb174-87" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb174-88"><a href="data_fusion.html#cb174-88" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb174-89"><a href="data_fusion.html#cb174-89" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb174-90"><a href="data_fusion.html#cb174-90" tabindex="-1"></a>      <span class="at">inrange_th_votes =</span> <span class="fu">sum</span>(</span>
<span id="cb174-91"><a href="data_fusion.html#cb174-91" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">c_across</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>))</span>
<span id="cb174-92"><a href="data_fusion.html#cb174-92" tabindex="-1"></a>        , <span class="at">na.rm =</span> T</span>
<span id="cb174-93"><a href="data_fusion.html#cb174-93" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb174-94"><a href="data_fusion.html#cb174-94" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="dv">0</span>)</span>
<span id="cb174-95"><a href="data_fusion.html#cb174-95" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb174-96"><a href="data_fusion.html#cb174-96" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb174-97"><a href="data_fusion.html#cb174-97" tabindex="-1"></a>  </span>
<span id="cb174-98"><a href="data_fusion.html#cb174-98" tabindex="-1"></a>  <span class="co">#return</span></span>
<span id="cb174-99"><a href="data_fusion.html#cb174-99" tabindex="-1"></a>  <span class="fu">return</span>(ret_df)</span>
<span id="cb174-100"><a href="data_fusion.html#cb174-100" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s look at the columns we get from our <code>rgb_indices_threshold_voting()</code> function</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="data_fusion.html#cb175-1" tabindex="-1"></a>rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">rgb_indices_threshold_voting</span>(<span class="at">rgb_indices_df=</span>rgb_indices_df)</span>
<span id="cb175-2"><a href="data_fusion.html#cb175-2" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb175-3"><a href="data_fusion.html#cb175-3" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb175-4"><a href="data_fusion.html#cb175-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb175-5"><a href="data_fusion.html#cb175-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb175-6"><a href="data_fusion.html#cb175-6" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##  inrange_th_exgr inrange_th_rgri inrange_th_vdvi inrange_th_bi   
##  Min.   :1       Min.   :1       Min.   :1       Min.   :0.0000  
##  1st Qu.:1       1st Qu.:1       1st Qu.:1       1st Qu.:1.0000  
##  Median :1       Median :1       Median :1       Median :1.0000  
##  Mean   :1       Mean   :1       Mean   :1       Mean   :0.9358  
##  3rd Qu.:1       3rd Qu.:1       3rd Qu.:1       3rd Qu.:1.0000  
##  Max.   :1       Max.   :1       Max.   :1       Max.   :1.0000  
##  inrange_th_sat   inrange_th_votes
##  Min.   :0.0000   Min.   :4.00    
##  1st Qu.:1.0000   1st Qu.:5.00    
##  Median :1.0000   Median :5.00    
##  Mean   :0.9947   Mean   :4.93    
##  3rd Qu.:1.0000   3rd Qu.:5.00    
##  Max.   :1.0000   Max.   :5.00</code></pre>
<p>notice the “Mean” value in the summary above is the proportion of ground truth piles that successfully met the spectral index threshold criteria (i.e. piles to be “kept”). it looks like the SAT threshold was most unaligned with these ground truth piles, something we anticipated by looking at the distributions above compared the threshold value recommended in the literature for detecting green vegetation.</p>
<p>let’s look at the proportional distribution of ground truth piles meeting the threshold by individual spectral index</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="data_fusion.html#cb177-1" tabindex="-1"></a>rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb177-2"><a href="data_fusion.html#cb177-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb177-3"><a href="data_fusion.html#cb177-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb177-4"><a href="data_fusion.html#cb177-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb177-5"><a href="data_fusion.html#cb177-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;inrange_th_&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_upper</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb177-6"><a href="data_fusion.html#cb177-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">!=</span><span class="st">&quot;VOTES&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb177-7"><a href="data_fusion.html#cb177-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(name,value) <span class="sc">%&gt;%</span> </span>
<span id="cb177-8"><a href="data_fusion.html#cb177-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb177-9"><a href="data_fusion.html#cb177-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb177-10"><a href="data_fusion.html#cb177-10" tabindex="-1"></a>    <span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)</span>
<span id="cb177-11"><a href="data_fusion.html#cb177-11" tabindex="-1"></a>    , <span class="at">value =</span> <span class="fu">factor</span>(value, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;outside threshold&quot;</span>,<span class="st">&quot;within threshold&quot;</span>), <span class="at">ordered =</span> T)</span>
<span id="cb177-12"><a href="data_fusion.html#cb177-12" tabindex="-1"></a>    , <span class="at">lab =</span> <span class="fu">paste0</span>(scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">(n=&quot;</span>, scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb177-13"><a href="data_fusion.html#cb177-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb177-14"><a href="data_fusion.html#cb177-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb177-15"><a href="data_fusion.html#cb177-15" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> pct, <span class="at">label =</span> lab, <span class="at">fill =</span> value)</span>
<span id="cb177-16"><a href="data_fusion.html#cb177-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb177-17"><a href="data_fusion.html#cb177-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(</span>
<span id="cb177-18"><a href="data_fusion.html#cb177-18" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">0.6</span></span>
<span id="cb177-19"><a href="data_fusion.html#cb177-19" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb177-20"><a href="data_fusion.html#cb177-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb177-21"><a href="data_fusion.html#cb177-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb177-22"><a href="data_fusion.html#cb177-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>, <span class="at">begin =</span> <span class="fl">0.3</span>, <span class="at">end =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb177-23"><a href="data_fusion.html#cb177-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb177-24"><a href="data_fusion.html#cb177-24" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.2</span>)</span>
<span id="cb177-25"><a href="data_fusion.html#cb177-25" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb177-26"><a href="data_fusion.html#cb177-26" tabindex="-1"></a>    , <span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb177-27"><a href="data_fusion.html#cb177-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb177-28"><a href="data_fusion.html#cb177-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb177-29"><a href="data_fusion.html#cb177-29" tabindex="-1"></a>    <span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)</span>
<span id="cb177-30"><a href="data_fusion.html#cb177-30" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb177-31"><a href="data_fusion.html#cb177-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb177-32"><a href="data_fusion.html#cb177-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb177-33"><a href="data_fusion.html#cb177-33" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb177-34"><a href="data_fusion.html#cb177-34" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb177-35"><a href="data_fusion.html#cb177-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb177-36"><a href="data_fusion.html#cb177-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb177-37"><a href="data_fusion.html#cb177-37" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb177-38"><a href="data_fusion.html#cb177-38" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb177-39"><a href="data_fusion.html#cb177-39" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb177-40"><a href="data_fusion.html#cb177-40" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb177-41"><a href="data_fusion.html#cb177-41" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-162-1.png" width="1008" /></p>
<p>and let’s look at the distribution of ground truth piles based on the number of individual spectral index thresholds met. we’ll use this count as our voting system.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="data_fusion.html#cb178-1" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">value=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb178-2"><a href="data_fusion.html#cb178-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb178-3"><a href="data_fusion.html#cb178-3" tabindex="-1"></a>    rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb178-4"><a href="data_fusion.html#cb178-4" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb178-5"><a href="data_fusion.html#cb178-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_votes&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb178-6"><a href="data_fusion.html#cb178-6" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb178-7"><a href="data_fusion.html#cb178-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;inrange_th_&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_upper</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb178-8"><a href="data_fusion.html#cb178-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">count</span>(name,value)</span>
<span id="cb178-9"><a href="data_fusion.html#cb178-9" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(value)</span>
<span id="cb178-10"><a href="data_fusion.html#cb178-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb178-11"><a href="data_fusion.html#cb178-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb178-12"><a href="data_fusion.html#cb178-12" tabindex="-1"></a>    <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(n,<span class="dv">0</span>)</span>
<span id="cb178-13"><a href="data_fusion.html#cb178-13" tabindex="-1"></a>    , <span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)</span>
<span id="cb178-14"><a href="data_fusion.html#cb178-14" tabindex="-1"></a>    , <span class="at">lab =</span> <span class="fu">paste0</span>(scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">(n=&quot;</span>, scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb178-15"><a href="data_fusion.html#cb178-15" tabindex="-1"></a>    , <span class="at">value =</span> <span class="fu">factor</span>(value)</span>
<span id="cb178-16"><a href="data_fusion.html#cb178-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb178-17"><a href="data_fusion.html#cb178-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb178-18"><a href="data_fusion.html#cb178-18" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> pct, <span class="at">label =</span> lab, <span class="at">fill =</span> value)</span>
<span id="cb178-19"><a href="data_fusion.html#cb178-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb178-20"><a href="data_fusion.html#cb178-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(</span>
<span id="cb178-21"><a href="data_fusion.html#cb178-21" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">0.6</span></span>
<span id="cb178-22"><a href="data_fusion.html#cb178-22" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb178-23"><a href="data_fusion.html#cb178-23" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb178-24"><a href="data_fusion.html#cb178-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb178-25"><a href="data_fusion.html#cb178-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;mako&quot;</span>, <span class="at">direction=</span><span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb178-26"><a href="data_fusion.html#cb178-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb178-27"><a href="data_fusion.html#cb178-27" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb178-28"><a href="data_fusion.html#cb178-28" tabindex="-1"></a>    , <span class="at">expand =</span> ggplot2<span class="sc">::</span><span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.15</span>))</span>
<span id="cb178-29"><a href="data_fusion.html#cb178-29" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb178-30"><a href="data_fusion.html#cb178-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb178-31"><a href="data_fusion.html#cb178-31" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;spectral index threshold votes&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb178-32"><a href="data_fusion.html#cb178-32" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;distribution of ground truth piles meeting spectral index thresholds&quot;</span></span>
<span id="cb178-33"><a href="data_fusion.html#cb178-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb178-34"><a href="data_fusion.html#cb178-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb178-35"><a href="data_fusion.html#cb178-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb178-36"><a href="data_fusion.html#cb178-36" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb178-37"><a href="data_fusion.html#cb178-37" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb178-38"><a href="data_fusion.html#cb178-38" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb178-39"><a href="data_fusion.html#cb178-39" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-163-1.png" width="1008" /></p>
<p>we can use this spectral index voting system to filter candidate slash piles with a user-defined parameter which defines the sensitivity of filtering based on the spectral information. For example, a value of “5” would heavily weight the spectral information in determining which piles to keep while a value of “1” would put less weight on the spectral data.</p>
<p>let’s see what some of those piles with the fewest votes look like on the imagery</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="data_fusion.html#cb179-1" tabindex="-1"></a><span class="co"># filter for the plots with the fewest votes</span></span>
<span id="cb179-2"><a href="data_fusion.html#cb179-2" tabindex="-1"></a>dta_temp <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span> </span>
<span id="cb179-3"><a href="data_fusion.html#cb179-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&lt;=</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-4"><a href="data_fusion.html#cb179-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">12</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-5"><a href="data_fusion.html#cb179-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast))</span>
<span id="cb179-6"><a href="data_fusion.html#cb179-6" tabindex="-1"></a><span class="co"># dta_temp %&gt;% sf::st_drop_geometry() %&gt;% dplyr::select(tidyselect::starts_with(&quot;rast_agg&quot;)) %&gt;% summary()</span></span>
<span id="cb179-7"><a href="data_fusion.html#cb179-7" tabindex="-1"></a><span class="co"># plot on ortho</span></span>
<span id="cb179-8"><a href="data_fusion.html#cb179-8" tabindex="-1"></a>plts_temp <span class="ot">&lt;-</span></span>
<span id="cb179-9"><a href="data_fusion.html#cb179-9" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dta_temp) <span class="sc">%&gt;%</span></span>
<span id="cb179-10"><a href="data_fusion.html#cb179-10" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb179-11"><a href="data_fusion.html#cb179-11" tabindex="-1"></a>    dta <span class="ot">&lt;-</span> dta_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(x)</span>
<span id="cb179-12"><a href="data_fusion.html#cb179-12" tabindex="-1"></a>    dta <span class="ot">&lt;-</span> dta <span class="sc">%&gt;%</span> </span>
<span id="cb179-13"><a href="data_fusion.html#cb179-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb179-14"><a href="data_fusion.html#cb179-14" tabindex="-1"></a>        dta <span class="sc">%&gt;%</span> </span>
<span id="cb179-15"><a href="data_fusion.html#cb179-15" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb179-16"><a href="data_fusion.html#cb179-16" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;inrange_th_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb179-17"><a href="data_fusion.html#cb179-17" tabindex="-1"></a>          tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb179-18"><a href="data_fusion.html#cb179-18" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;inrange_th_&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_upper</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb179-19"><a href="data_fusion.html#cb179-19" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">!=</span><span class="st">&quot;VOTES&quot;</span> <span class="sc">&amp;</span> value <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb179-20"><a href="data_fusion.html#cb179-20" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>value) <span class="sc">%&gt;%</span> </span>
<span id="cb179-21"><a href="data_fusion.html#cb179-21" tabindex="-1"></a>          tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">values_from =</span> name) <span class="sc">%&gt;%</span> </span>
<span id="cb179-22"><a href="data_fusion.html#cb179-22" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb179-23"><a href="data_fusion.html#cb179-23" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb179-24"><a href="data_fusion.html#cb179-24" tabindex="-1"></a>            <span class="at">lab =</span> <span class="fu">paste</span>(</span>
<span id="cb179-25"><a href="data_fusion.html#cb179-25" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">c_across</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>())</span>
<span id="cb179-26"><a href="data_fusion.html#cb179-26" tabindex="-1"></a>                , <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span></span>
<span id="cb179-27"><a href="data_fusion.html#cb179-27" tabindex="-1"></a>              )</span>
<span id="cb179-28"><a href="data_fusion.html#cb179-28" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb179-29"><a href="data_fusion.html#cb179-29" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(lab)</span>
<span id="cb179-30"><a href="data_fusion.html#cb179-30" tabindex="-1"></a>      )</span>
<span id="cb179-31"><a href="data_fusion.html#cb179-31" tabindex="-1"></a>    <span class="fu">ortho_plt_fn</span>(<span class="at">my_ortho_rast =</span> ortho_rast, <span class="at">stand =</span>dta) <span class="sc">+</span></span>
<span id="cb179-32"><a href="data_fusion.html#cb179-32" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> dta, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb179-33"><a href="data_fusion.html#cb179-33" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Outside Threshold:</span><span class="sc">\n</span><span class="st">&quot;</span>,dta<span class="sc">$</span>lab)) <span class="sc">+</span> </span>
<span id="cb179-34"><a href="data_fusion.html#cb179-34" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))  </span>
<span id="cb179-35"><a href="data_fusion.html#cb179-35" tabindex="-1"></a>  })</span>
<span id="cb179-36"><a href="data_fusion.html#cb179-36" tabindex="-1"></a><span class="co"># combine</span></span>
<span id="cb179-37"><a href="data_fusion.html#cb179-37" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb179-38"><a href="data_fusion.html#cb179-38" tabindex="-1"></a>  plts_temp</span>
<span id="cb179-39"><a href="data_fusion.html#cb179-39" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">4</span></span>
<span id="cb179-40"><a href="data_fusion.html#cb179-40" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-164-1.png" width="1008" /></p>
<p>all of those piles would have been voted out based on <del>SAT or</del> BI since they are either in shadows or the dead wood appears very bright/white (perhaps we need to adjust those thresholds?). let’s see a summary of those spectral index values for these piles with the fewest votes</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="data_fusion.html#cb180-1" tabindex="-1"></a>dta_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(rast_agg_bi, rast_agg_sat) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##   rast_agg_bi       rast_agg_sat   
##  Min.   :0.05521   Min.   :0.1229  
##  1st Qu.:0.06566   1st Qu.:0.1978  
##  Median :0.07075   Median :0.2542  
##  Mean   :0.07154   Mean   :0.2538  
##  3rd Qu.:0.07920   3rd Qu.:0.2985  
##  Max.   :0.08803   Max.   :0.3649</code></pre>
</div>
</div>
<div id="polygon_spectral_filtering" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Candidate Polygon Spectral Filtering Function<a href="data_fusion.html#polygon_spectral_filtering" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>let’s put all of this together to define a function that takes as input: 1) a spatial data frame of candidate polygons; 2) a raster with RGB spectral data; 3) user-defined spectral weighting (voting system)</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="data_fusion.html#cb182-1" tabindex="-1"></a>polygon_spectral_filtering <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb182-2"><a href="data_fusion.html#cb182-2" tabindex="-1"></a>  sf_data</span>
<span id="cb182-3"><a href="data_fusion.html#cb182-3" tabindex="-1"></a>  , rgb_rast</span>
<span id="cb182-4"><a href="data_fusion.html#cb182-4" tabindex="-1"></a>  <span class="co"># define the band index</span></span>
<span id="cb182-5"><a href="data_fusion.html#cb182-5" tabindex="-1"></a>  , red_band_idx</span>
<span id="cb182-6"><a href="data_fusion.html#cb182-6" tabindex="-1"></a>  , green_band_idx</span>
<span id="cb182-7"><a href="data_fusion.html#cb182-7" tabindex="-1"></a>  , blue_band_idx</span>
<span id="cb182-8"><a href="data_fusion.html#cb182-8" tabindex="-1"></a>  <span class="co"># spectral weighting</span></span>
<span id="cb182-9"><a href="data_fusion.html#cb182-9" tabindex="-1"></a>  , <span class="at">spectral_weight =</span> <span class="dv">3</span></span>
<span id="cb182-10"><a href="data_fusion.html#cb182-10" tabindex="-1"></a>) {</span>
<span id="cb182-11"><a href="data_fusion.html#cb182-11" tabindex="-1"></a>  <span class="do">### could make these parameters</span></span>
<span id="cb182-12"><a href="data_fusion.html#cb182-12" tabindex="-1"></a>  th_rgri <span class="ot">&lt;-</span> <span class="fu">c</span>((<span class="fl">0.7+0.001</span>),<span class="cn">Inf</span>) <span class="co"># increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb182-13"><a href="data_fusion.html#cb182-13" tabindex="-1"></a>  th_vdvi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,(<span class="fl">0.03+0.001</span>)) <span class="co"># increase each by 0.001 since we&#39;ll be checking lower&lt;=x&lt;=upper</span></span>
<span id="cb182-14"><a href="data_fusion.html#cb182-14" tabindex="-1"></a>  th_exgr <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="dv">0</span>)</span>
<span id="cb182-15"><a href="data_fusion.html#cb182-15" tabindex="-1"></a>  th_bi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.9</span>)</span>
<span id="cb182-16"><a href="data_fusion.html#cb182-16" tabindex="-1"></a>  th_sat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.03</span>,<span class="cn">Inf</span>)</span>
<span id="cb182-17"><a href="data_fusion.html#cb182-17" tabindex="-1"></a>  </span>
<span id="cb182-18"><a href="data_fusion.html#cb182-18" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb182-19"><a href="data_fusion.html#cb182-19" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(rgb_rast, <span class="st">&quot;SpatRaster&quot;</span>)){</span>
<span id="cb182-20"><a href="data_fusion.html#cb182-20" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `rast` must be a SpatRaster object.&quot;</span>)</span>
<span id="cb182-21"><a href="data_fusion.html#cb182-21" tabindex="-1"></a>  }</span>
<span id="cb182-22"><a href="data_fusion.html#cb182-22" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){</span>
<span id="cb182-23"><a href="data_fusion.html#cb182-23" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must be an sf data frame.&quot;</span>)</span>
<span id="cb182-24"><a href="data_fusion.html#cb182-24" tabindex="-1"></a>  }</span>
<span id="cb182-25"><a href="data_fusion.html#cb182-25" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(sf_data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) {</span>
<span id="cb182-26"><a href="data_fusion.html#cb182-26" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `sf_data` must contain polygon geometries.&quot;</span>)</span>
<span id="cb182-27"><a href="data_fusion.html#cb182-27" tabindex="-1"></a>  }</span>
<span id="cb182-28"><a href="data_fusion.html#cb182-28" tabindex="-1"></a>  spectral_weight <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(spectral_weight)</span>
<span id="cb182-29"><a href="data_fusion.html#cb182-29" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(spectral_weight <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>)) ){</span>
<span id="cb182-30"><a href="data_fusion.html#cb182-30" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Input `spectral_weight` must be a number between 0 (no filtering based on spectral) and 5 (highest weighting of spectral data)&quot;</span>)</span>
<span id="cb182-31"><a href="data_fusion.html#cb182-31" tabindex="-1"></a>  }</span>
<span id="cb182-32"><a href="data_fusion.html#cb182-32" tabindex="-1"></a>  <span class="co"># if you don&#39;t want to do it, then why do it?</span></span>
<span id="cb182-33"><a href="data_fusion.html#cb182-33" tabindex="-1"></a>  <span class="cf">if</span>(spectral_weight<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb182-34"><a href="data_fusion.html#cb182-34" tabindex="-1"></a>    <span class="fu">return</span>(sf_data)</span>
<span id="cb182-35"><a href="data_fusion.html#cb182-35" tabindex="-1"></a>  }</span>
<span id="cb182-36"><a href="data_fusion.html#cb182-36" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-37"><a href="data_fusion.html#cb182-37" tabindex="-1"></a>  <span class="co"># calculate_all_rgb_indices</span></span>
<span id="cb182-38"><a href="data_fusion.html#cb182-38" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-39"><a href="data_fusion.html#cb182-39" tabindex="-1"></a>  all_rgb_indices_rast <span class="ot">&lt;-</span> <span class="fu">calculate_all_rgb_indices</span>(</span>
<span id="cb182-40"><a href="data_fusion.html#cb182-40" tabindex="-1"></a>    <span class="at">raster_obj =</span> rgb_rast</span>
<span id="cb182-41"><a href="data_fusion.html#cb182-41" tabindex="-1"></a>    , <span class="at">red_band_idx =</span> red_band_idx</span>
<span id="cb182-42"><a href="data_fusion.html#cb182-42" tabindex="-1"></a>    , <span class="at">green_band_idx =</span> green_band_idx</span>
<span id="cb182-43"><a href="data_fusion.html#cb182-43" tabindex="-1"></a>    , <span class="at">blue_band_idx =</span> blue_band_idx</span>
<span id="cb182-44"><a href="data_fusion.html#cb182-44" tabindex="-1"></a>  )</span>
<span id="cb182-45"><a href="data_fusion.html#cb182-45" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-46"><a href="data_fusion.html#cb182-46" tabindex="-1"></a>  <span class="co"># extract_rast_values</span></span>
<span id="cb182-47"><a href="data_fusion.html#cb182-47" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-48"><a href="data_fusion.html#cb182-48" tabindex="-1"></a>  rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">extract_rast_values</span>(</span>
<span id="cb182-49"><a href="data_fusion.html#cb182-49" tabindex="-1"></a>    <span class="at">sf_data =</span> sf_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb182-50"><a href="data_fusion.html#cb182-50" tabindex="-1"></a>    , <span class="at">rast =</span> all_rgb_indices_rast</span>
<span id="cb182-51"><a href="data_fusion.html#cb182-51" tabindex="-1"></a>    , <span class="at">fun_agg =</span> median</span>
<span id="cb182-52"><a href="data_fusion.html#cb182-52" tabindex="-1"></a>  )</span>
<span id="cb182-53"><a href="data_fusion.html#cb182-53" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-54"><a href="data_fusion.html#cb182-54" tabindex="-1"></a>  <span class="co"># rgb_indices_threshold_voting</span></span>
<span id="cb182-55"><a href="data_fusion.html#cb182-55" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-56"><a href="data_fusion.html#cb182-56" tabindex="-1"></a>  rgb_indices_df <span class="ot">&lt;-</span> <span class="fu">rgb_indices_threshold_voting</span>(</span>
<span id="cb182-57"><a href="data_fusion.html#cb182-57" tabindex="-1"></a>    <span class="at">rgb_indices_df=</span>rgb_indices_df</span>
<span id="cb182-58"><a href="data_fusion.html#cb182-58" tabindex="-1"></a>    , <span class="at">th_rgri =</span> th_rgri</span>
<span id="cb182-59"><a href="data_fusion.html#cb182-59" tabindex="-1"></a>    , <span class="at">th_vdvi =</span> th_vdvi</span>
<span id="cb182-60"><a href="data_fusion.html#cb182-60" tabindex="-1"></a>    , <span class="at">th_exgr =</span> th_exgr</span>
<span id="cb182-61"><a href="data_fusion.html#cb182-61" tabindex="-1"></a>    , <span class="at">th_bi =</span> th_bi</span>
<span id="cb182-62"><a href="data_fusion.html#cb182-62" tabindex="-1"></a>    , <span class="at">th_sat =</span> th_sat</span>
<span id="cb182-63"><a href="data_fusion.html#cb182-63" tabindex="-1"></a>  )</span>
<span id="cb182-64"><a href="data_fusion.html#cb182-64" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-65"><a href="data_fusion.html#cb182-65" tabindex="-1"></a>  <span class="co"># filtering</span></span>
<span id="cb182-66"><a href="data_fusion.html#cb182-66" tabindex="-1"></a>  <span class="do">##################################################</span></span>
<span id="cb182-67"><a href="data_fusion.html#cb182-67" tabindex="-1"></a>  rgb_indices_df <span class="ot">&lt;-</span> rgb_indices_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(inrange_th_votes<span class="sc">&gt;=</span>spectral_weight)</span>
<span id="cb182-68"><a href="data_fusion.html#cb182-68" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb182-69"><a href="data_fusion.html#cb182-69" tabindex="-1"></a>  <span class="fu">return</span>(rgb_indices_df)</span>
<span id="cb182-70"><a href="data_fusion.html#cb182-70" tabindex="-1"></a>}</span>
<span id="cb182-71"><a href="data_fusion.html#cb182-71" tabindex="-1"></a><span class="co"># polygon_spectral_filtering(</span></span>
<span id="cb182-72"><a href="data_fusion.html#cb182-72" tabindex="-1"></a><span class="co">#   sf_data = slash_piles_polys</span></span>
<span id="cb182-73"><a href="data_fusion.html#cb182-73" tabindex="-1"></a><span class="co">#   , rgb_rast = ortho_rast</span></span>
<span id="cb182-74"><a href="data_fusion.html#cb182-74" tabindex="-1"></a><span class="co">#   , red_band_idx = 1</span></span>
<span id="cb182-75"><a href="data_fusion.html#cb182-75" tabindex="-1"></a><span class="co">#   , green_band_idx = 2</span></span>
<span id="cb182-76"><a href="data_fusion.html#cb182-76" tabindex="-1"></a><span class="co">#   , blue_band_idx = 3</span></span>
<span id="cb182-77"><a href="data_fusion.html#cb182-77" tabindex="-1"></a><span class="co">#   , spectral_weight = 4</span></span>
<span id="cb182-78"><a href="data_fusion.html#cb182-78" tabindex="-1"></a><span class="co"># ) %&gt;%</span></span>
<span id="cb182-79"><a href="data_fusion.html#cb182-79" tabindex="-1"></a><span class="co"># nrow()</span></span>
<span id="cb182-80"><a href="data_fusion.html#cb182-80" tabindex="-1"></a><span class="co"># # dplyr::glimpse()</span></span>
<span id="cb182-81"><a href="data_fusion.html#cb182-81" tabindex="-1"></a><span class="co"># nrow(slash_piles_polys)</span></span></code></pre></div>
</div>
<div id="data-fusion-example" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Data Fusion Example<a href="data_fusion.html#data-fusion-example" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>we previously worked through an example where we identified candidate slash piles based on their structural form using our raster-based <a href="raster_watershed.html#slash_pile_detect_watershed">watershed segmentation approach</a>. let’s go back to that example and see how the spectral filtering method we defined above impacts the results.</p>
<p>first, load those example predictions</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="data_fusion.html#cb183-1" tabindex="-1"></a><span class="co"># structurally predicted</span></span>
<span id="cb183-2"><a href="data_fusion.html#cb183-2" tabindex="-1"></a>predicted_watershed_piles_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;../data/predicted_watershed_piles_sf.gpkg&quot;</span>, <span class="at">quiet =</span> T)</span>
<span id="cb183-3"><a href="data_fusion.html#cb183-3" tabindex="-1"></a><span class="co"># ortho plt</span></span>
<span id="cb183-4"><a href="data_fusion.html#cb183-4" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb183-5"><a href="data_fusion.html#cb183-5" tabindex="-1"></a>buff_temp <span class="ot">&lt;-</span> <span class="fl">7.3</span></span>
<span id="cb183-6"><a href="data_fusion.html#cb183-6" tabindex="-1"></a>plt_ortho_example <span class="ot">&lt;-</span> </span>
<span id="cb183-7"><a href="data_fusion.html#cb183-7" tabindex="-1"></a>  <span class="fu">ortho_plt_fn</span>(</span>
<span id="cb183-8"><a href="data_fusion.html#cb183-8" tabindex="-1"></a>    <span class="at">my_ortho_rast =</span> ortho_rast, <span class="at">stand =</span> example_aoi</span>
<span id="cb183-9"><a href="data_fusion.html#cb183-9" tabindex="-1"></a>    , <span class="at">buffer =</span> buff_temp</span>
<span id="cb183-10"><a href="data_fusion.html#cb183-10" tabindex="-1"></a>  )</span></code></pre></div>
<p>here is a reminder of the structurally-detected segments (brown) compared with the ground truth piles (blue) in the example area we have been looking at</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="data_fusion.html#cb184-1" tabindex="-1"></a>plt_ortho_example <span class="sc">+</span></span>
<span id="cb184-2"><a href="data_fusion.html#cb184-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb184-3"><a href="data_fusion.html#cb184-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb184-4"><a href="data_fusion.html#cb184-4" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb184-5"><a href="data_fusion.html#cb184-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb184-6"><a href="data_fusion.html#cb184-6" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb184-7"><a href="data_fusion.html#cb184-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb184-8"><a href="data_fusion.html#cb184-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb184-9"><a href="data_fusion.html#cb184-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb184-10"><a href="data_fusion.html#cb184-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb184-11"><a href="data_fusion.html#cb184-11" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb184-12"><a href="data_fusion.html#cb184-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast))</span>
<span id="cb184-13"><a href="data_fusion.html#cb184-13" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb184-14"><a href="data_fusion.html#cb184-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb184-15"><a href="data_fusion.html#cb184-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb184-16"><a href="data_fusion.html#cb184-16" tabindex="-1"></a>    <span class="at">data =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb184-17"><a href="data_fusion.html#cb184-17" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb184-18"><a href="data_fusion.html#cb184-18" tabindex="-1"></a>        predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb184-19"><a href="data_fusion.html#cb184-19" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb184-20"><a href="data_fusion.html#cb184-20" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb184-21"><a href="data_fusion.html#cb184-21" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb184-22"><a href="data_fusion.html#cb184-22" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id)</span>
<span id="cb184-23"><a href="data_fusion.html#cb184-23" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb184-24"><a href="data_fusion.html#cb184-24" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast))</span>
<span id="cb184-25"><a href="data_fusion.html#cb184-25" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb184-26"><a href="data_fusion.html#cb184-26" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb184-27"><a href="data_fusion.html#cb184-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb184-28"><a href="data_fusion.html#cb184-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb184-29"><a href="data_fusion.html#cb184-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-170-1.png" width="1008" /></p>
<p>Remember, our data fusion method uses the spectral data strictly as a final <strong>filter</strong> or quality check on the structurally-detected candidate piles, meaning it <strong>neither adds new piles nor alters the shape or location</strong> of the candidates. As a result, if the structural detection step missed a pile (false negative or omission), the spectral data won’t go back and fix it. The only changes we can expect by including spectral data in our data fusion approach is a trade-off: we can either improve our precision by successfully removing detections that aren’t actually piles (commissions or false positives), or we run the risk of mistakenly filtering out real piles (true positives) if their spectral signature happens to look unusual, which would unfortunately lower our recall. Different magnitude changes in these metrics will directly impact the overall accuracy measure of F-score. For example, a large gain in precision paired with only a small drop in recall will result in a net increase in the F-score, whereas a steep drop in recall will quickly negate any gains from improved precision.</p>
<p>let’s apply our spectral filtering method to the full set of structurally-detected piles using a <code>spectral_weight</code> of <strong>“4”</strong> which requires four of the five spectral thresholds to be met for a candidate pile to be retained</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="data_fusion.html#cb185-1" tabindex="-1"></a>final_predicted_slash_piles <span class="ot">&lt;-</span> <span class="fu">polygon_spectral_filtering</span>(</span>
<span id="cb185-2"><a href="data_fusion.html#cb185-2" tabindex="-1"></a>  <span class="at">sf_data =</span> predicted_watershed_piles_sf</span>
<span id="cb185-3"><a href="data_fusion.html#cb185-3" tabindex="-1"></a>  , <span class="at">rgb_rast =</span> ortho_rast</span>
<span id="cb185-4"><a href="data_fusion.html#cb185-4" tabindex="-1"></a>  <span class="co"># define the band index</span></span>
<span id="cb185-5"><a href="data_fusion.html#cb185-5" tabindex="-1"></a>  , <span class="at">red_band_idx =</span> <span class="dv">1</span></span>
<span id="cb185-6"><a href="data_fusion.html#cb185-6" tabindex="-1"></a>  , <span class="at">green_band_idx =</span> <span class="dv">2</span></span>
<span id="cb185-7"><a href="data_fusion.html#cb185-7" tabindex="-1"></a>  , <span class="at">blue_band_idx =</span> <span class="dv">3</span></span>
<span id="cb185-8"><a href="data_fusion.html#cb185-8" tabindex="-1"></a>  <span class="co"># spectral weighting</span></span>
<span id="cb185-9"><a href="data_fusion.html#cb185-9" tabindex="-1"></a>  , <span class="at">spectral_weight =</span> <span class="dv">4</span></span>
<span id="cb185-10"><a href="data_fusion.html#cb185-10" tabindex="-1"></a>)</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="data_fusion.html#cb186-1" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb186-2"><a href="data_fusion.html#cb186-2" tabindex="-1"></a>final_predicted_slash_piles <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 342
## Columns: 23
## $ pred_id          &lt;dbl&gt; 38, 80, 150, 233, 296, 335, 345, 403, 552, 595, 872, …
## $ area_m2          &lt;dbl&gt; 7.886308, 22.057642, 18.614888, 23.098474, 2.321857, …
## $ volume_m3        &lt;dbl&gt; 15.930993, 65.423964, 27.613173, 25.648945, 5.870187,…
## $ max_height_m     &lt;dbl&gt; 3.999429, 3.998000, 3.997000, 3.994792, 3.992937, 3.9…
## $ volume_per_area  &lt;dbl&gt; 2.0200827, 2.9660453, 1.4833918, 1.1104173, 2.5282292…
## $ pct_chull        &lt;dbl&gt; 0.8509719, 0.7118863, 0.7591837, 0.8952676, 0.7204969…
## $ is_in_stand      &lt;lgl&gt; FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, TRUE, FALSE,…
## $ rast_agg_grvi    &lt;dbl&gt; 0.051901337, 0.053044260, 0.003640603, 0.067690785, 0…
## $ rast_agg_rgri    &lt;dbl&gt; 0.9013190, 0.8992777, 0.9927452, 0.8732015, 0.9749513…
## $ rast_agg_vdvi    &lt;dbl&gt; 0.07027040, -0.01708128, 0.03236633, 0.03398474, -0.0…
## $ rast_agg_rgbvi   &lt;dbl&gt; 0.14096444, -0.02549687, 0.06923695, 0.07262199, -0.0…
## $ rast_agg_exg     &lt;dbl&gt; 0.09594114, -0.02264607, 0.04362578, 0.04583218, -0.0…
## $ rast_agg_exr     &lt;dbl&gt; 0.09521890, 0.08437340, 0.13648952, 0.07878246, 0.120…
## $ rast_agg_exgr    &lt;dbl&gt; -0.001033881, -0.107019464, -0.088533181, -0.02634802…
## $ rast_agg_bi      &lt;dbl&gt; 0.44347274, 0.04628512, 0.47422114, 0.14808661, 0.282…
## $ rast_agg_sat     &lt;dbl&gt; 0.16817074, 0.23150009, 0.17257952, 0.15251648, 0.126…
## $ geom             &lt;POLYGON [m]&gt; POLYGON ((499303.2 4318059,..., POLYGON ((499…
## $ inrange_th_exgr  &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ inrange_th_rgri  &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ inrange_th_vdvi  &lt;dbl&gt; 0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0,…
## $ inrange_th_bi    &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ inrange_th_sat   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ inrange_th_votes &lt;dbl&gt; 4, 4, 4, 4, 5, 5, 4, 4, 4, 5, 4, 4, 4, 4, 4, 4, 5, 4,…</code></pre>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="data_fusion.html#cb188-1" tabindex="-1"></a><span class="co"># final_predicted_slash_piles %&gt;%</span></span>
<span id="cb188-2"><a href="data_fusion.html#cb188-2" tabindex="-1"></a><span class="co">#   sf::st_drop_geometry() %&gt;%</span></span>
<span id="cb188-3"><a href="data_fusion.html#cb188-3" tabindex="-1"></a><span class="co">#   dplyr::count(inrange_th_votes)</span></span></code></pre></div>
<p>how many piles were removed?</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="data_fusion.html#cb189-1" tabindex="-1"></a><span class="co"># how many piles were removed?</span></span>
<span id="cb189-2"><a href="data_fusion.html#cb189-2" tabindex="-1"></a><span class="fu">nrow</span>(predicted_watershed_piles_sf)<span class="sc">-</span><span class="fu">nrow</span>(final_predicted_slash_piles)</span></code></pre></div>
<pre><code>## [1] 178</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="data_fusion.html#cb191-1" tabindex="-1"></a><span class="co"># what proportion were removed?</span></span>
<span id="cb191-2"><a href="data_fusion.html#cb191-2" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">percent</span>(</span>
<span id="cb191-3"><a href="data_fusion.html#cb191-3" tabindex="-1"></a>  (<span class="fu">nrow</span>(predicted_watershed_piles_sf)<span class="sc">-</span><span class="fu">nrow</span>(final_predicted_slash_piles))<span class="sc">/</span><span class="fu">nrow</span>(predicted_watershed_piles_sf)</span>
<span id="cb191-4"><a href="data_fusion.html#cb191-4" tabindex="-1"></a>  , <span class="at">accuracy=</span><span class="fl">0.1</span></span>
<span id="cb191-5"><a href="data_fusion.html#cb191-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;34.2%&quot;</code></pre>
<p>let’s check out the results of the spectral filtering for our example area</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="data_fusion.html#cb193-1" tabindex="-1"></a>p_temp <span class="ot">&lt;-</span> </span>
<span id="cb193-2"><a href="data_fusion.html#cb193-2" tabindex="-1"></a>  plt_ortho_example <span class="sc">+</span></span>
<span id="cb193-3"><a href="data_fusion.html#cb193-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb193-4"><a href="data_fusion.html#cb193-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb193-5"><a href="data_fusion.html#cb193-5" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb193-6"><a href="data_fusion.html#cb193-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb193-7"><a href="data_fusion.html#cb193-7" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb193-8"><a href="data_fusion.html#cb193-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb193-9"><a href="data_fusion.html#cb193-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb193-10"><a href="data_fusion.html#cb193-10" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb193-11"><a href="data_fusion.html#cb193-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb193-12"><a href="data_fusion.html#cb193-12" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb193-13"><a href="data_fusion.html#cb193-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast))</span>
<span id="cb193-14"><a href="data_fusion.html#cb193-14" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb193-15"><a href="data_fusion.html#cb193-15" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb193-16"><a href="data_fusion.html#cb193-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb193-17"><a href="data_fusion.html#cb193-17" tabindex="-1"></a>    <span class="at">data =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb193-18"><a href="data_fusion.html#cb193-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb193-19"><a href="data_fusion.html#cb193-19" tabindex="-1"></a>        predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb193-20"><a href="data_fusion.html#cb193-20" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb193-21"><a href="data_fusion.html#cb193-21" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb193-22"><a href="data_fusion.html#cb193-22" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb193-23"><a href="data_fusion.html#cb193-23" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id)</span>
<span id="cb193-24"><a href="data_fusion.html#cb193-24" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb193-25"><a href="data_fusion.html#cb193-25" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast))</span>
<span id="cb193-26"><a href="data_fusion.html#cb193-26" tabindex="-1"></a>    <span class="co"># , fill = NA, color = &quot;brown&quot;, lwd = 0.6</span></span>
<span id="cb193-27"><a href="data_fusion.html#cb193-27" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb193-28"><a href="data_fusion.html#cb193-28" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb193-29"><a href="data_fusion.html#cb193-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb193-30"><a href="data_fusion.html#cb193-30" tabindex="-1"></a>    <span class="at">data =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb193-31"><a href="data_fusion.html#cb193-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb193-32"><a href="data_fusion.html#cb193-32" tabindex="-1"></a>        predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb193-33"><a href="data_fusion.html#cb193-33" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb193-34"><a href="data_fusion.html#cb193-34" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb193-35"><a href="data_fusion.html#cb193-35" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb193-36"><a href="data_fusion.html#cb193-36" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id)</span>
<span id="cb193-37"><a href="data_fusion.html#cb193-37" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb193-38"><a href="data_fusion.html#cb193-38" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb193-39"><a href="data_fusion.html#cb193-39" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb193-40"><a href="data_fusion.html#cb193-40" tabindex="-1"></a>        final_predicted_slash_piles <span class="sc">%&gt;%</span> </span>
<span id="cb193-41"><a href="data_fusion.html#cb193-41" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb193-42"><a href="data_fusion.html#cb193-42" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb193-43"><a href="data_fusion.html#cb193-43" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_spectral_kept =</span> T)</span>
<span id="cb193-44"><a href="data_fusion.html#cb193-44" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb193-45"><a href="data_fusion.html#cb193-45" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_spectral_kept =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_spectral_kept,F))</span>
<span id="cb193-46"><a href="data_fusion.html#cb193-46" tabindex="-1"></a>    , ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> is_spectral_kept)</span>
<span id="cb193-47"><a href="data_fusion.html#cb193-47" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb193-48"><a href="data_fusion.html#cb193-48" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb193-49"><a href="data_fusion.html#cb193-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb193-50"><a href="data_fusion.html#cb193-50" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb193-51"><a href="data_fusion.html#cb193-51" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span>
<span id="cb193-52"><a href="data_fusion.html#cb193-52" tabindex="-1"></a>p_temp</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-174-1.png" width="1008" /></p>
<p>let’s look at the instance matching results for this example area</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="data_fusion.html#cb194-1" tabindex="-1"></a><span class="co"># instance match</span></span>
<span id="cb194-2"><a href="data_fusion.html#cb194-2" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb194-3"><a href="data_fusion.html#cb194-3" tabindex="-1"></a>  <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb194-4"><a href="data_fusion.html#cb194-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb194-5"><a href="data_fusion.html#cb194-5" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb194-6"><a href="data_fusion.html#cb194-6" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-7"><a href="data_fusion.html#cb194-7" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb194-8"><a href="data_fusion.html#cb194-8" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb194-9"><a href="data_fusion.html#cb194-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb194-10"><a href="data_fusion.html#cb194-10" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb194-11"><a href="data_fusion.html#cb194-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(field_diameter_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-12"><a href="data_fusion.html#cb194-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(final_predicted_slash_piles))</span>
<span id="cb194-13"><a href="data_fusion.html#cb194-13" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb194-14"><a href="data_fusion.html#cb194-14" tabindex="-1"></a>  , <span class="at">predictions =</span> final_predicted_slash_piles <span class="sc">%&gt;%</span> </span>
<span id="cb194-15"><a href="data_fusion.html#cb194-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb194-16"><a href="data_fusion.html#cb194-16" tabindex="-1"></a>        final_predicted_slash_piles <span class="sc">%&gt;%</span> </span>
<span id="cb194-17"><a href="data_fusion.html#cb194-17" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-18"><a href="data_fusion.html#cb194-18" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb194-19"><a href="data_fusion.html#cb194-19" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb194-20"><a href="data_fusion.html#cb194-20" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id)</span>
<span id="cb194-21"><a href="data_fusion.html#cb194-21" tabindex="-1"></a>      )</span>
<span id="cb194-22"><a href="data_fusion.html#cb194-22" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb194-23"><a href="data_fusion.html#cb194-23" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb194-24"><a href="data_fusion.html#cb194-24" tabindex="-1"></a>)</span>
<span id="cb194-25"><a href="data_fusion.html#cb194-25" tabindex="-1"></a></span>
<span id="cb194-26"><a href="data_fusion.html#cb194-26" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb194-27"><a href="data_fusion.html#cb194-27" tabindex="-1"></a>p_temp <span class="ot">&lt;-</span> </span>
<span id="cb194-28"><a href="data_fusion.html#cb194-28" tabindex="-1"></a>  plt_ortho_example <span class="sc">+</span></span>
<span id="cb194-29"><a href="data_fusion.html#cb194-29" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb194-30"><a href="data_fusion.html#cb194-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> example_aoi <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast)), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb194-31"><a href="data_fusion.html#cb194-31" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb194-32"><a href="data_fusion.html#cb194-32" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb194-33"><a href="data_fusion.html#cb194-33" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb194-34"><a href="data_fusion.html#cb194-34" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb194-35"><a href="data_fusion.html#cb194-35" tabindex="-1"></a>        slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb194-36"><a href="data_fusion.html#cb194-36" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-37"><a href="data_fusion.html#cb194-37" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb194-38"><a href="data_fusion.html#cb194-38" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb194-39"><a href="data_fusion.html#cb194-39" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb194-40"><a href="data_fusion.html#cb194-40" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb194-41"><a href="data_fusion.html#cb194-41" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb194-42"><a href="data_fusion.html#cb194-42" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb194-43"><a href="data_fusion.html#cb194-43" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb194-44"><a href="data_fusion.html#cb194-44" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb194-45"><a href="data_fusion.html#cb194-45" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb194-46"><a href="data_fusion.html#cb194-46" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast))</span>
<span id="cb194-47"><a href="data_fusion.html#cb194-47" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb194-48"><a href="data_fusion.html#cb194-48" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb194-49"><a href="data_fusion.html#cb194-49" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb194-50"><a href="data_fusion.html#cb194-50" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb194-51"><a href="data_fusion.html#cb194-51" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb194-52"><a href="data_fusion.html#cb194-52" tabindex="-1"></a>    final_predicted_slash_piles <span class="sc">%&gt;%</span> </span>
<span id="cb194-53"><a href="data_fusion.html#cb194-53" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb194-54"><a href="data_fusion.html#cb194-54" tabindex="-1"></a>        final_predicted_slash_piles <span class="sc">%&gt;%</span> </span>
<span id="cb194-55"><a href="data_fusion.html#cb194-55" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(example_aoi)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-56"><a href="data_fusion.html#cb194-56" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(example_aoi) <span class="sc">%&gt;%</span> </span>
<span id="cb194-57"><a href="data_fusion.html#cb194-57" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb194-58"><a href="data_fusion.html#cb194-58" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id)</span>
<span id="cb194-59"><a href="data_fusion.html#cb194-59" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb194-60"><a href="data_fusion.html#cb194-60" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-61"><a href="data_fusion.html#cb194-61" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb194-62"><a href="data_fusion.html#cb194-62" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb194-63"><a href="data_fusion.html#cb194-63" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb194-64"><a href="data_fusion.html#cb194-64" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb194-65"><a href="data_fusion.html#cb194-65" tabindex="-1"></a>      )</span>
<span id="cb194-66"><a href="data_fusion.html#cb194-66" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb194-67"><a href="data_fusion.html#cb194-67" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb194-68"><a href="data_fusion.html#cb194-68" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">0.8</span></span>
<span id="cb194-69"><a href="data_fusion.html#cb194-69" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb194-70"><a href="data_fusion.html#cb194-70" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb194-71"><a href="data_fusion.html#cb194-71" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb194-72"><a href="data_fusion.html#cb194-72" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb194-73"><a href="data_fusion.html#cb194-73" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb194-74"><a href="data_fusion.html#cb194-74" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,pal_match_grp[<span class="st">&quot;commission&quot;</span>])))</span>
<span id="cb194-75"><a href="data_fusion.html#cb194-75" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb194-76"><a href="data_fusion.html#cb194-76" tabindex="-1"></a>  )</span>
<span id="cb194-77"><a href="data_fusion.html#cb194-77" tabindex="-1"></a>p_temp</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-176-1.png" width="1008" /></p>
<p>unfortunately, we didn’t remove as many false positive predictions as we would have liked for this example area but we did slightly improve our precision (by a count of one)…we’ll have to see how we did for the full ground truth set</p>
<div id="instance-matching-1" class="section level3 hasAnchor" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Instance Matching<a href="data_fusion.html#instance-matching-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s see how we did with the full data fusion predictions compared to the ground truth data using the instance matching process we outlined in this <a href="method-evaluation.html#iou_match">earlier section</a></p>
<p>we’ll look at only predicted and ground truth piles that intersect with the unit boundary for our instance matching</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="data_fusion.html#cb195-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb195-2"><a href="data_fusion.html#cb195-2" tabindex="-1"></a>  <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb195-3"><a href="data_fusion.html#cb195-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb195-4"><a href="data_fusion.html#cb195-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(field_diameter_m)) <span class="sc">%&gt;%</span> </span>
<span id="cb195-5"><a href="data_fusion.html#cb195-5" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(final_predicted_slash_piles))</span>
<span id="cb195-6"><a href="data_fusion.html#cb195-6" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb195-7"><a href="data_fusion.html#cb195-7" tabindex="-1"></a>  , <span class="at">predictions =</span> final_predicted_slash_piles <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand)</span>
<span id="cb195-8"><a href="data_fusion.html#cb195-8" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb195-9"><a href="data_fusion.html#cb195-9" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb195-10"><a href="data_fusion.html#cb195-10" tabindex="-1"></a>)</span></code></pre></div>
<p>let’s look at that spatially for the entire area</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="data_fusion.html#cb196-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb196-2"><a href="data_fusion.html#cb196-2" tabindex="-1"></a><span class="fu">ortho_plt_fn</span>(<span class="at">my_ortho_rast =</span> ortho_rast, <span class="at">stand =</span> stand_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast)), <span class="at">buffer =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb196-3"><a href="data_fusion.html#cb196-3" tabindex="-1"></a><span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb196-4"><a href="data_fusion.html#cb196-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> stand_boundary <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast)), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb196-5"><a href="data_fusion.html#cb196-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb196-6"><a href="data_fusion.html#cb196-6" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb196-7"><a href="data_fusion.html#cb196-7" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb196-8"><a href="data_fusion.html#cb196-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb196-9"><a href="data_fusion.html#cb196-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb196-10"><a href="data_fusion.html#cb196-10" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb196-11"><a href="data_fusion.html#cb196-11" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb196-12"><a href="data_fusion.html#cb196-12" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb196-13"><a href="data_fusion.html#cb196-13" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb196-14"><a href="data_fusion.html#cb196-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast))</span>
<span id="cb196-15"><a href="data_fusion.html#cb196-15" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb196-16"><a href="data_fusion.html#cb196-16" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb196-17"><a href="data_fusion.html#cb196-17" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb196-18"><a href="data_fusion.html#cb196-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb196-19"><a href="data_fusion.html#cb196-19" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb196-20"><a href="data_fusion.html#cb196-20" tabindex="-1"></a>      final_predicted_slash_piles <span class="sc">%&gt;%</span> </span>
<span id="cb196-21"><a href="data_fusion.html#cb196-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb196-22"><a href="data_fusion.html#cb196-22" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb196-23"><a href="data_fusion.html#cb196-23" tabindex="-1"></a>        ground_truth_prediction_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb196-24"><a href="data_fusion.html#cb196-24" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb196-25"><a href="data_fusion.html#cb196-25" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb196-26"><a href="data_fusion.html#cb196-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb196-27"><a href="data_fusion.html#cb196-27" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ortho_rast))</span>
<span id="cb196-28"><a href="data_fusion.html#cb196-28" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb196-29"><a href="data_fusion.html#cb196-29" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb196-30"><a href="data_fusion.html#cb196-30" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb196-31"><a href="data_fusion.html#cb196-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb196-32"><a href="data_fusion.html#cb196-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-33"><a href="data_fusion.html#cb196-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-34"><a href="data_fusion.html#cb196-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-35"><a href="data_fusion.html#cb196-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb196-36"><a href="data_fusion.html#cb196-36" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,pal_match_grp[<span class="st">&quot;commission&quot;</span>])))</span>
<span id="cb196-37"><a href="data_fusion.html#cb196-37" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb196-38"><a href="data_fusion.html#cb196-38" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-179-1.png" width="1008" /></p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="data_fusion.html#cb197-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/datafusion_pred_match.jpg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="fl">10.5</span>)</span></code></pre></div>
<p>we’ll aggregate the raw instance match data to calculate our detection accuracy metrics</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="data_fusion.html#cb198-1" tabindex="-1"></a><span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 8
##    tp_n  fp_n  fn_n omission_rate commission_rate precision recall f_score
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1   108    48    13         0.107           0.308     0.692  0.893   0.780</code></pre>
<p>let’s plot our confusion matrix</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="data_fusion.html#cb200-1" tabindex="-1"></a>confusion_matrix_temp <span class="ot">&lt;-</span> <span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans)</span>
<span id="cb200-2"><a href="data_fusion.html#cb200-2" tabindex="-1"></a>confusion_matrix_scores_temp <span class="ot">&lt;-</span> <span class="fu">confusion_matrix_scores_fn</span>(confusion_matrix_temp)</span>
<span id="cb200-3"><a href="data_fusion.html#cb200-3" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb200-4"><a href="data_fusion.html#cb200-4" tabindex="-1"></a>confusion_matrix_temp <span class="sc">%&gt;%</span> </span>
<span id="cb200-5"><a href="data_fusion.html#cb200-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_n&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb200-6"><a href="data_fusion.html#cb200-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb200-7"><a href="data_fusion.html#cb200-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb200-8"><a href="data_fusion.html#cb200-8" tabindex="-1"></a>    <span class="at">presence =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fn_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb200-9"><a href="data_fusion.html#cb200-9" tabindex="-1"></a>    , <span class="at">estimate =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fp_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb200-10"><a href="data_fusion.html#cb200-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb200-11"><a href="data_fusion.html#cb200-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb200-12"><a href="data_fusion.html#cb200-12" tabindex="-1"></a>    <span class="at">is_false =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(presence<span class="sc">!=</span>estimate,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb200-13"><a href="data_fusion.html#cb200-13" tabindex="-1"></a>    , <span class="at">presence_fact =</span> <span class="fu">factor</span>(presence,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed Absent&quot;</span>, <span class="st">&quot;Observed Present&quot;</span>))</span>
<span id="cb200-14"><a href="data_fusion.html#cb200-14" tabindex="-1"></a>    , <span class="at">estimate_fact =</span> <span class="fu">factor</span>(estimate,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Predicted Absent&quot;</span>, <span class="st">&quot;Predicted Present&quot;</span>))</span>
<span id="cb200-15"><a href="data_fusion.html#cb200-15" tabindex="-1"></a>    , <span class="at">pct =</span> value<span class="sc">/</span><span class="fu">sum</span>(value)</span>
<span id="cb200-16"><a href="data_fusion.html#cb200-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb200-17"><a href="data_fusion.html#cb200-17" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> estimate_fact, <span class="at">x =</span> presence_fact)) <span class="sc">+</span></span>
<span id="cb200-18"><a href="data_fusion.html#cb200-18" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> is_false), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>,<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb200-19"><a href="data_fusion.html#cb200-19" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)), <span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb200-20"><a href="data_fusion.html#cb200-20" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)), <span class="at">vjust =</span> <span class="fl">3.5</span>, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb200-21"><a href="data_fusion.html#cb200-21" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;turquoise&quot;</span>,<span class="st">&quot;tomato2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb200-22"><a href="data_fusion.html#cb200-22" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb200-23"><a href="data_fusion.html#cb200-23" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb200-24"><a href="data_fusion.html#cb200-24" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Predicted&quot;</span></span>
<span id="cb200-25"><a href="data_fusion.html#cb200-25" tabindex="-1"></a>    , <span class="at">x =</span> <span class="st">&quot;Observed&quot;</span></span>
<span id="cb200-26"><a href="data_fusion.html#cb200-26" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb200-27"><a href="data_fusion.html#cb200-27" tabindex="-1"></a>      <span class="st">&quot;True positive rate (recall) = &quot;</span></span>
<span id="cb200-28"><a href="data_fusion.html#cb200-28" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>recall <span class="sc">%&gt;%</span> </span>
<span id="cb200-29"><a href="data_fusion.html#cb200-29" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb200-30"><a href="data_fusion.html#cb200-30" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Precision (PPV) = &quot;</span></span>
<span id="cb200-31"><a href="data_fusion.html#cb200-31" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>precision <span class="sc">%&gt;%</span> </span>
<span id="cb200-32"><a href="data_fusion.html#cb200-32" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb200-33"><a href="data_fusion.html#cb200-33" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">F1-score = &quot;</span></span>
<span id="cb200-34"><a href="data_fusion.html#cb200-34" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>f_score <span class="sc">%&gt;%</span> </span>
<span id="cb200-35"><a href="data_fusion.html#cb200-35" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb200-36"><a href="data_fusion.html#cb200-36" tabindex="-1"></a>    )</span>
<span id="cb200-37"><a href="data_fusion.html#cb200-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb200-38"><a href="data_fusion.html#cb200-38" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb200-39"><a href="data_fusion.html#cb200-39" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb200-40"><a href="data_fusion.html#cb200-40" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb200-41"><a href="data_fusion.html#cb200-41" tabindex="-1"></a>    , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb200-42"><a href="data_fusion.html#cb200-42" tabindex="-1"></a>    , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb200-43"><a href="data_fusion.html#cb200-43" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb200-44"><a href="data_fusion.html#cb200-44" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-181-1.png" width="1008" /></p>
<p>you can compare these results to the results using the <a href="raster_watershed.html#det_accuracy_wshed_ex">structural data only</a>…wow, our data fusion approach noticeably improved the precision of our method’s predictions without negatively impacting recall, this effect combined to greatly improve our overall accuracy as measured by F-score</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="raster_watershed.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="wshed_params_test.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
