<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 5 Point Cloud Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 5 Point Cloud Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 5 Point Cloud Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="point-cloud-classification.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-processing.html"><a href="data-processing.html"><i class="fa fa-check"></i><b>2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-processing.html"><a href="data-processing.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.1</b> Slash Pile Vector Data</a></li>
<li class="chapter" data-level="2.2" data-path="data-processing.html"><a href="data-processing.html#load-rgb-orthomosaic-rasters"><i class="fa fa-check"></i><b>2.2</b> Load RGB orthomosaic rasters</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data-processing.html"><a href="data-processing.html#example-ratio-based-index"><i class="fa fa-check"></i><b>2.2.1</b> Example ratio-based index</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data-processing.html"><a href="data-processing.html#study-area-imagery"><i class="fa fa-check"></i><b>2.3</b> Study area imagery</a></li>
<li class="chapter" data-level="2.4" data-path="data-processing.html"><a href="data-processing.html#point-cloud-data"><i class="fa fa-check"></i><b>2.4</b> Point Cloud Data</a></li>
<li class="chapter" data-level="2.5" data-path="data-processing.html"><a href="data-processing.html#check-out-one-pile"><i class="fa fa-check"></i><b>2.5</b> Check out one pile</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="rgb-classification.html"><a href="rgb-classification.html"><i class="fa fa-check"></i><b>3</b> RGB Classification</a>
<ul>
<li class="chapter" data-level="3.1" data-path="rgb-classification.html"><a href="rgb-classification.html#textural-covariates"><i class="fa fa-check"></i><b>3.1</b> Textural covariates</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-panchromatic"><i class="fa fa-check"></i><b>3.1.1</b> Raster Texture: Panchromatic</a></li>
<li class="chapter" data-level="3.1.2" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-grvi"><i class="fa fa-check"></i><b>3.1.2</b> Raster Texture: GRVI</a></li>
<li class="chapter" data-level="3.1.3" data-path="rgb-classification.html"><a href="rgb-classification.html#plot-textural-rasters"><i class="fa fa-check"></i><b>3.1.3</b> Plot textural rasters</a></li>
<li class="chapter" data-level="3.1.4" data-path="rgb-classification.html"><a href="rgb-classification.html#features-for-classification"><i class="fa fa-check"></i><b>3.1.4</b> Features for classification</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel-based-unsupervised-classification"><i class="fa fa-check"></i><b>3.2</b> Pixel-based: unsupervised classification</a></li>
<li class="chapter" data-level="3.3" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel_class"><i class="fa fa-check"></i><b>3.3</b> Pixel-based: supervised classification</a></li>
<li class="chapter" data-level="3.4" data-path="rgb-classification.html"><a href="rgb-classification.html#obia"><i class="fa fa-check"></i><b>3.4</b> Object-based image analysis (OBIA)</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="rgb-classification.html"><a href="rgb-classification.html#training-data"><i class="fa fa-check"></i><b>3.4.1</b> Training data</a></li>
<li class="chapter" data-level="3.4.2" data-path="rgb-classification.html"><a href="rgb-classification.html#slic"><i class="fa fa-check"></i><b>3.4.2</b> <code>OpenImageR</code> package SLIC image segmentation</a></li>
<li class="chapter" data-level="3.4.3" data-path="rgb-classification.html"><a href="rgb-classification.html#superpixelimagesegmentation-package-slicap-clustering"><i class="fa fa-check"></i><b>3.4.3</b> <code>SuperpixelImageSegmentation</code> package SLICAP clustering</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html"><i class="fa fa-check"></i><b>4</b> Point Cloud Classification</a>
<ul>
<li class="chapter" data-level="4.1" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>4.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#dtm-and-chm-piles"><i class="fa fa-check"></i><b>4.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#raster-based-approaches"><i class="fa fa-check"></i><b>4.2</b> Raster-based approaches</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#watershed-segmentation"><i class="fa fa-check"></i><b>4.2.1</b> Watershed Segmentation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="point-cloud-classification-1.html"><a href="point-cloud-classification-1.html"><i class="fa fa-check"></i><b>5</b> Point Cloud Classification</a>
<ul>
<li class="chapter" data-level="5.1" data-path="point-cloud-classification-1.html"><a href="point-cloud-classification-1.html#process-raw-point-cloud-1"><i class="fa fa-check"></i><b>5.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="point-cloud-classification-1.html"><a href="point-cloud-classification-1.html#dtm-and-chm-piles-1"><i class="fa fa-check"></i><b>5.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="point-cloud-classification-1.html"><a href="point-cloud-classification-1.html#raster-based-approaches-1"><i class="fa fa-check"></i><b>5.2</b> Raster-based approaches</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="point-cloud-classification-1.html"><a href="point-cloud-classification-1.html#watershed-segmentation-1"><i class="fa fa-check"></i><b>5.2.1</b> Watershed Segmentation</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="point-cloud-classification-1" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Section 5</span> Point Cloud Classification<a href="point-cloud-classification-1.html#point-cloud-classification-1" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We’ll use the point cloud data alone (to begin with) to attempt to classify slash piles without additional spectral information.</p>
<p>We’ll use the <code>cloud2trees</code> package to perform all preprocessing of point cloud data which includes:</p>
<ul>
<li>ground classification and noise removal</li>
<li>raster data (DTM and CHM) generation</li>
<li>point cloud height normalization</li>
</ul>
<p>All of this can be accomplished using the <code>cloud2raster()</code> function. After generating these products from the raw point cloud we’ll perform object segmentation to attempt to detect round, conical objects like slash piles from: 1) the normalized point cloud directly; 2) the CHM which we’ll generate by setting the minimum height to zero to effectively create a digital surface model (DSM).</p>
<p>To attempt to detect slash piles directly from the point cloud we can use a clustering algorithm such as DBSCAN (Density-Based Spatial Clustering of Applications with Noise) which identifies clusters based on point density, making it effective for detecting clusters of arbitrary shapes and sizes. It does not require the number of clusters to be specified beforehand. Insert something from TLS paper that used DBSCAN in semi-automated way….xxxxx. After segmenting the point cloud using DBSCAN, random forest can be used as a classifier (i.e. classification step) to distinguish slash piles from other objects based on their extracted geometric features. The general workflow is:</p>
<ol style="list-style-type: decimal">
<li>for each point in the normalized non-ground point cloud, compute a suite of relevant geometric features within a defined local neighborhood radius using <code>lidR::point_metrics()</code></li>
<li>calculate features derived from PCA, such as linearity, planarity, sphericity, and surface variation. Also, compute curvature (mean, Gaussian) and roughness</li>
<li>perform object segmentation/clustering to group points belonging to individual objects using DBSCAN which can identify dense clusters without requiring a predefined number of objects</li>
<li>classify the segmented objects (clusters) as “slash pile” or “non-slash pile” based on their extracted features (e.g., sphericity, roughness, height, volume) with a random forest classifier using a manually annotated subset of segmented objects</li>
<li>merge small, adjacent segments that likely belong to a single slash pile based on proximity and connectivity</li>
<li>perform a confusion matrix-based evaluation on the results</li>
</ol>
<p>To attempt to identify slash piles from the CHM/DSM, we can use watershed segmentation (potentially without “seed” points) in a bottom-up approach. Insert something from paper about bottom-up approach that uses a CHM “slice” near the ground…xxxxx. For slash piles, which are often irregular and may not have a distinct “treetop” equivalent, CHM-based methods might be less directly applicable unless the piles present a very clear, isolated conical or rounded form. Could use expected morphology of the slash piles (e.g. maximum height) based on prior research.</p>
<div id="process-raw-point-cloud-1" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Process Raw Point Cloud<a href="point-cloud-classification-1.html#process-raw-point-cloud-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll use <code>cloud2trees::cloud2raster()</code> to process the raw point cloud data</p>
<p><code>{r, include=FALSE,eval=FALSE}E</code></p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="point-cloud-classification-1.html#cb193-1" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">&quot;../data/point_cloud_processing_delivery&quot;</span>)){</span>
<span id="cb193-2"><a href="point-cloud-classification-1.html#cb193-2" tabindex="-1"></a>  cloud2raster_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2raster</span>(</span>
<span id="cb193-3"><a href="point-cloud-classification-1.html#cb193-3" tabindex="-1"></a>    <span class="at">output_dir =</span> <span class="st">&quot;../data&quot;</span></span>
<span id="cb193-4"><a href="point-cloud-classification-1.html#cb193-4" tabindex="-1"></a>    , <span class="at">input_las_dir =</span> <span class="st">&quot;E:</span><span class="sc">\\</span><span class="st">PFDP_Data</span><span class="sc">\\</span><span class="st">p4pro_images</span><span class="sc">\\</span><span class="st">P4Pro_06_17_2021_half_half_optimal</span><span class="sc">\\</span><span class="st">2_densification</span><span class="sc">\\</span><span class="st">point_cloud&quot;</span></span>
<span id="cb193-5"><a href="point-cloud-classification-1.html#cb193-5" tabindex="-1"></a>    , <span class="at">accuracy_level =</span> <span class="dv">2</span></span>
<span id="cb193-6"><a href="point-cloud-classification-1.html#cb193-6" tabindex="-1"></a>    , <span class="at">keep_intrmdt =</span> T</span>
<span id="cb193-7"><a href="point-cloud-classification-1.html#cb193-7" tabindex="-1"></a>    , <span class="at">dtm_res_m =</span> <span class="fl">0.25</span></span>
<span id="cb193-8"><a href="point-cloud-classification-1.html#cb193-8" tabindex="-1"></a>    , <span class="at">chm_res_m =</span> <span class="fl">0.1</span></span>
<span id="cb193-9"><a href="point-cloud-classification-1.html#cb193-9" tabindex="-1"></a>    , <span class="at">min_height =</span> <span class="dv">0</span> <span class="co"># effectively generates a DSM based on non-ground points</span></span>
<span id="cb193-10"><a href="point-cloud-classification-1.html#cb193-10" tabindex="-1"></a>  )</span>
<span id="cb193-11"><a href="point-cloud-classification-1.html#cb193-11" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb193-12"><a href="point-cloud-classification-1.html#cb193-12" tabindex="-1"></a>  dtm_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="st">&quot;../data/point_cloud_processing_delivery/dtm_0.25m.tif&quot;</span>)</span>
<span id="cb193-13"><a href="point-cloud-classification-1.html#cb193-13" tabindex="-1"></a>  chm_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="st">&quot;../data/point_cloud_processing_delivery/chm_0.1m.tif&quot;</span>)</span>
<span id="cb193-14"><a href="point-cloud-classification-1.html#cb193-14" tabindex="-1"></a>  cloud2raster_ans <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb193-15"><a href="point-cloud-classification-1.html#cb193-15" tabindex="-1"></a>    <span class="st">&quot;dtm_rast&quot;</span> <span class="ot">=</span> dtm_temp</span>
<span id="cb193-16"><a href="point-cloud-classification-1.html#cb193-16" tabindex="-1"></a>    , <span class="st">&quot;chm_rast&quot;</span> <span class="ot">=</span> chm_temp</span>
<span id="cb193-17"><a href="point-cloud-classification-1.html#cb193-17" tabindex="-1"></a>  )</span>
<span id="cb193-18"><a href="point-cloud-classification-1.html#cb193-18" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s check out the DTM</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="point-cloud-classification-1.html#cb194-1" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>dtm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb194-2"><a href="point-cloud-classification-1.html#cb194-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co">#, fun = &quot;median&quot;, cores = lasR::half_cores(), na.rm = T) %&gt;% </span></span>
<span id="cb194-3"><a href="point-cloud-classification-1.html#cb194-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F)</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-166-1.png" width="1008" /></p>
<p>and CHM</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="point-cloud-classification-1.html#cb196-1" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb196-2"><a href="point-cloud-classification-1.html#cb196-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co">#, fun = &quot;median&quot;, cores = lasR::half_cores(), na.rm = T) %&gt;% </span></span>
<span id="cb196-3"><a href="point-cloud-classification-1.html#cb196-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-168-1.png" width="1008" /></p>
<div id="dtm-and-chm-piles-1" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> DTM and CHM + piles<a href="point-cloud-classification-1.html#dtm-and-chm-piles-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s visually inspect the DTM and CHM with the pile outlines overlaid</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="point-cloud-classification-1.html#cb198-1" tabindex="-1"></a>p_fn_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb198-2"><a href="point-cloud-classification-1.html#cb198-2" tabindex="-1"></a>    rn</span>
<span id="cb198-3"><a href="point-cloud-classification-1.html#cb198-3" tabindex="-1"></a>    , <span class="at">df =</span> slash_piles_polys</span>
<span id="cb198-4"><a href="point-cloud-classification-1.html#cb198-4" tabindex="-1"></a>    , <span class="at">rast =</span> cloud2raster_ans<span class="sc">$</span>dtm_rast</span>
<span id="cb198-5"><a href="point-cloud-classification-1.html#cb198-5" tabindex="-1"></a>    , <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>dtm_rast)</span>
<span id="cb198-6"><a href="point-cloud-classification-1.html#cb198-6" tabindex="-1"></a>    , <span class="at">my_title =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb198-7"><a href="point-cloud-classification-1.html#cb198-7" tabindex="-1"></a>    , <span class="at">vopt =</span> <span class="st">&quot;viridis&quot;</span></span>
<span id="cb198-8"><a href="point-cloud-classification-1.html#cb198-8" tabindex="-1"></a>    , <span class="at">lim =</span> <span class="cn">NULL</span></span>
<span id="cb198-9"><a href="point-cloud-classification-1.html#cb198-9" tabindex="-1"></a>) {</span>
<span id="cb198-10"><a href="point-cloud-classification-1.html#cb198-10" tabindex="-1"></a>  <span class="co"># scale the buffer based on the largest</span></span>
<span id="cb198-11"><a href="point-cloud-classification-1.html#cb198-11" tabindex="-1"></a>    d_temp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb198-12"><a href="point-cloud-classification-1.html#cb198-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">tolower</span>(comment), <span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb198-13"><a href="point-cloud-classification-1.html#cb198-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(rn) <span class="sc">%&gt;%</span> </span>
<span id="cb198-14"><a href="point-cloud-classification-1.html#cb198-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(crs)</span>
<span id="cb198-15"><a href="point-cloud-classification-1.html#cb198-15" tabindex="-1"></a>    </span>
<span id="cb198-16"><a href="point-cloud-classification-1.html#cb198-16" tabindex="-1"></a>    <span class="co"># plt classifier</span></span>
<span id="cb198-17"><a href="point-cloud-classification-1.html#cb198-17" tabindex="-1"></a>    <span class="co"># convert to stars</span></span>
<span id="cb198-18"><a href="point-cloud-classification-1.html#cb198-18" tabindex="-1"></a>    comp_st <span class="ot">&lt;-</span> rast <span class="sc">%&gt;%</span>  </span>
<span id="cb198-19"><a href="point-cloud-classification-1.html#cb198-19" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb198-20"><a href="point-cloud-classification-1.html#cb198-20" tabindex="-1"></a>        d_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb198-21"><a href="point-cloud-classification-1.html#cb198-21" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb198-22"><a href="point-cloud-classification-1.html#cb198-22" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb198-23"><a href="point-cloud-classification-1.html#cb198-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb198-24"><a href="point-cloud-classification-1.html#cb198-24" tabindex="-1"></a>    </span>
<span id="cb198-25"><a href="point-cloud-classification-1.html#cb198-25" tabindex="-1"></a>    <span class="co"># ggplot</span></span>
<span id="cb198-26"><a href="point-cloud-classification-1.html#cb198-26" tabindex="-1"></a>    comp_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb198-27"><a href="point-cloud-classification-1.html#cb198-27" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">data =</span> comp_st, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span>f)) <span class="sc">+</span></span>
<span id="cb198-28"><a href="point-cloud-classification-1.html#cb198-28" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> d_temp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;gray33&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb198-29"><a href="point-cloud-classification-1.html#cb198-29" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb198-30"><a href="point-cloud-classification-1.html#cb198-30" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb198-31"><a href="point-cloud-classification-1.html#cb198-31" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb198-32"><a href="point-cloud-classification-1.html#cb198-32" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb198-33"><a href="point-cloud-classification-1.html#cb198-33" tabindex="-1"></a>        , <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb198-34"><a href="point-cloud-classification-1.html#cb198-34" tabindex="-1"></a>        , <span class="at">subtitle =</span> my_title</span>
<span id="cb198-35"><a href="point-cloud-classification-1.html#cb198-35" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb198-36"><a href="point-cloud-classification-1.html#cb198-36" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb198-37"><a href="point-cloud-classification-1.html#cb198-37" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb198-38"><a href="point-cloud-classification-1.html#cb198-38" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span> <span class="co"># c(0.5,1)</span></span>
<span id="cb198-39"><a href="point-cloud-classification-1.html#cb198-39" tabindex="-1"></a>        , <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb198-40"><a href="point-cloud-classification-1.html#cb198-40" tabindex="-1"></a>        , <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb198-41"><a href="point-cloud-classification-1.html#cb198-41" tabindex="-1"></a>        , <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb198-42"><a href="point-cloud-classification-1.html#cb198-42" tabindex="-1"></a>        , <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb198-43"><a href="point-cloud-classification-1.html#cb198-43" tabindex="-1"></a>        <span class="co"># , plot.title = ggtext::element_markdown(size = 10, hjust = 0.5)</span></span>
<span id="cb198-44"><a href="point-cloud-classification-1.html#cb198-44" tabindex="-1"></a>        , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb198-45"><a href="point-cloud-classification-1.html#cb198-45" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)</span>
<span id="cb198-46"><a href="point-cloud-classification-1.html#cb198-46" tabindex="-1"></a>      )</span>
<span id="cb198-47"><a href="point-cloud-classification-1.html#cb198-47" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(lim)){</span>
<span id="cb198-48"><a href="point-cloud-classification-1.html#cb198-48" tabindex="-1"></a>    comp_temp <span class="ot">&lt;-</span> comp_temp <span class="sc">+</span> </span>
<span id="cb198-49"><a href="point-cloud-classification-1.html#cb198-49" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> vopt, <span class="at">limits =</span> lim)</span>
<span id="cb198-50"><a href="point-cloud-classification-1.html#cb198-50" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb198-51"><a href="point-cloud-classification-1.html#cb198-51" tabindex="-1"></a>    comp_temp <span class="ot">&lt;-</span> comp_temp <span class="sc">+</span> </span>
<span id="cb198-52"><a href="point-cloud-classification-1.html#cb198-52" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> vopt)</span>
<span id="cb198-53"><a href="point-cloud-classification-1.html#cb198-53" tabindex="-1"></a>  }</span>
<span id="cb198-54"><a href="point-cloud-classification-1.html#cb198-54" tabindex="-1"></a>    </span>
<span id="cb198-55"><a href="point-cloud-classification-1.html#cb198-55" tabindex="-1"></a>  plt_temp <span class="ot">&lt;-</span> comp_temp</span>
<span id="cb198-56"><a href="point-cloud-classification-1.html#cb198-56" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;plt&quot;</span><span class="ot">=</span>plt_temp,<span class="st">&quot;d&quot;</span><span class="ot">=</span>d_temp))</span>
<span id="cb198-57"><a href="point-cloud-classification-1.html#cb198-57" tabindex="-1"></a>}</span>
<span id="cb198-58"><a href="point-cloud-classification-1.html#cb198-58" tabindex="-1"></a></span>
<span id="cb198-59"><a href="point-cloud-classification-1.html#cb198-59" tabindex="-1"></a><span class="co"># p_fn_temp(</span></span>
<span id="cb198-60"><a href="point-cloud-classification-1.html#cb198-60" tabindex="-1"></a><span class="co">#   rn = 5</span></span>
<span id="cb198-61"><a href="point-cloud-classification-1.html#cb198-61" tabindex="-1"></a><span class="co">#   # , lim = c(floor(terra::minmax(cloud2raster_ans$dtm_rast)[1]*0.98), floor(terra::minmax(cloud2raster_ans$dtm_rast)[2]*1.02))</span></span>
<span id="cb198-62"><a href="point-cloud-classification-1.html#cb198-62" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb198-63"><a href="point-cloud-classification-1.html#cb198-63" tabindex="-1"></a><span class="co"># p_fn_temp(</span></span>
<span id="cb198-64"><a href="point-cloud-classification-1.html#cb198-64" tabindex="-1"></a><span class="co">#   rn = 11</span></span>
<span id="cb198-65"><a href="point-cloud-classification-1.html#cb198-65" tabindex="-1"></a><span class="co">#   , rast = cloud2raster_ans$chm_rast</span></span>
<span id="cb198-66"><a href="point-cloud-classification-1.html#cb198-66" tabindex="-1"></a><span class="co">#   , vopt = &quot;plasma&quot;</span></span>
<span id="cb198-67"><a href="point-cloud-classification-1.html#cb198-67" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb198-68"><a href="point-cloud-classification-1.html#cb198-68" tabindex="-1"></a><span class="co"># combine 3</span></span>
<span id="cb198-69"><a href="point-cloud-classification-1.html#cb198-69" tabindex="-1"></a>plt_combine_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb198-70"><a href="point-cloud-classification-1.html#cb198-70" tabindex="-1"></a>    rn</span>
<span id="cb198-71"><a href="point-cloud-classification-1.html#cb198-71" tabindex="-1"></a>    , <span class="at">df =</span> slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))</span>
<span id="cb198-72"><a href="point-cloud-classification-1.html#cb198-72" tabindex="-1"></a>    , <span class="at">rast1 =</span> cloud2raster_ans<span class="sc">$</span>dtm_rast</span>
<span id="cb198-73"><a href="point-cloud-classification-1.html#cb198-73" tabindex="-1"></a>    , <span class="at">title1 =</span> <span class="st">&quot;DTM&quot;</span></span>
<span id="cb198-74"><a href="point-cloud-classification-1.html#cb198-74" tabindex="-1"></a>    , <span class="at">vopt1 =</span> <span class="st">&quot;viridis&quot;</span></span>
<span id="cb198-75"><a href="point-cloud-classification-1.html#cb198-75" tabindex="-1"></a>    , <span class="at">rast2 =</span> cloud2raster_ans<span class="sc">$</span>chm_rast</span>
<span id="cb198-76"><a href="point-cloud-classification-1.html#cb198-76" tabindex="-1"></a>    , <span class="at">title2 =</span> <span class="st">&quot;CHM&quot;</span></span>
<span id="cb198-77"><a href="point-cloud-classification-1.html#cb198-77" tabindex="-1"></a>    , <span class="at">vopt2 =</span> <span class="st">&quot;plasma&quot;</span></span>
<span id="cb198-78"><a href="point-cloud-classification-1.html#cb198-78" tabindex="-1"></a>    , <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>dtm_rast)</span>
<span id="cb198-79"><a href="point-cloud-classification-1.html#cb198-79" tabindex="-1"></a>) {</span>
<span id="cb198-80"><a href="point-cloud-classification-1.html#cb198-80" tabindex="-1"></a>  <span class="co"># composite 1</span></span>
<span id="cb198-81"><a href="point-cloud-classification-1.html#cb198-81" tabindex="-1"></a>  ans1 <span class="ot">&lt;-</span> <span class="fu">p_fn_temp</span>(</span>
<span id="cb198-82"><a href="point-cloud-classification-1.html#cb198-82" tabindex="-1"></a>    <span class="at">rn =</span> rn</span>
<span id="cb198-83"><a href="point-cloud-classification-1.html#cb198-83" tabindex="-1"></a>    , <span class="at">df =</span> df</span>
<span id="cb198-84"><a href="point-cloud-classification-1.html#cb198-84" tabindex="-1"></a>    , <span class="at">rast =</span> rast1</span>
<span id="cb198-85"><a href="point-cloud-classification-1.html#cb198-85" tabindex="-1"></a>    , <span class="at">my_title =</span> title1</span>
<span id="cb198-86"><a href="point-cloud-classification-1.html#cb198-86" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb198-87"><a href="point-cloud-classification-1.html#cb198-87" tabindex="-1"></a>    , <span class="at">vopt =</span> vopt1</span>
<span id="cb198-88"><a href="point-cloud-classification-1.html#cb198-88" tabindex="-1"></a>  )</span>
<span id="cb198-89"><a href="point-cloud-classification-1.html#cb198-89" tabindex="-1"></a>  <span class="co"># composite 2</span></span>
<span id="cb198-90"><a href="point-cloud-classification-1.html#cb198-90" tabindex="-1"></a>  ans2 <span class="ot">&lt;-</span> <span class="fu">p_fn_temp</span>(</span>
<span id="cb198-91"><a href="point-cloud-classification-1.html#cb198-91" tabindex="-1"></a>    <span class="at">rn =</span> rn</span>
<span id="cb198-92"><a href="point-cloud-classification-1.html#cb198-92" tabindex="-1"></a>    , <span class="at">df =</span> df</span>
<span id="cb198-93"><a href="point-cloud-classification-1.html#cb198-93" tabindex="-1"></a>    , <span class="at">rast =</span> rast2</span>
<span id="cb198-94"><a href="point-cloud-classification-1.html#cb198-94" tabindex="-1"></a>    , <span class="at">my_title =</span> title2</span>
<span id="cb198-95"><a href="point-cloud-classification-1.html#cb198-95" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb198-96"><a href="point-cloud-classification-1.html#cb198-96" tabindex="-1"></a>    , <span class="at">vopt =</span> vopt2</span>
<span id="cb198-97"><a href="point-cloud-classification-1.html#cb198-97" tabindex="-1"></a>  )</span>
<span id="cb198-98"><a href="point-cloud-classification-1.html#cb198-98" tabindex="-1"></a>  <span class="co"># plt rgb</span></span>
<span id="cb198-99"><a href="point-cloud-classification-1.html#cb198-99" tabindex="-1"></a>    rgb_temp <span class="ot">&lt;-</span></span>
<span id="cb198-100"><a href="point-cloud-classification-1.html#cb198-100" tabindex="-1"></a>      <span class="fu">ortho_plt_fn</span>(ans1<span class="sc">$</span>d) <span class="sc">+</span> </span>
<span id="cb198-101"><a href="point-cloud-classification-1.html#cb198-101" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> ans1<span class="sc">$</span>d, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>)</span>
<span id="cb198-102"><a href="point-cloud-classification-1.html#cb198-102" tabindex="-1"></a>  <span class="co"># combine</span></span>
<span id="cb198-103"><a href="point-cloud-classification-1.html#cb198-103" tabindex="-1"></a>    r <span class="ot">&lt;-</span> ans1<span class="sc">$</span>plt <span class="sc">+</span> ans2<span class="sc">$</span>plt <span class="sc">+</span> rgb_temp</span>
<span id="cb198-104"><a href="point-cloud-classification-1.html#cb198-104" tabindex="-1"></a>    <span class="fu">return</span>(r)</span>
<span id="cb198-105"><a href="point-cloud-classification-1.html#cb198-105" tabindex="-1"></a>}</span>
<span id="cb198-106"><a href="point-cloud-classification-1.html#cb198-106" tabindex="-1"></a></span>
<span id="cb198-107"><a href="point-cloud-classification-1.html#cb198-107" tabindex="-1"></a><span class="co"># plt_combine_temp(2)</span></span>
<span id="cb198-108"><a href="point-cloud-classification-1.html#cb198-108" tabindex="-1"></a></span>
<span id="cb198-109"><a href="point-cloud-classification-1.html#cb198-109" tabindex="-1"></a><span class="co"># add pile locations</span></span>
<span id="cb198-110"><a href="point-cloud-classification-1.html#cb198-110" tabindex="-1"></a>plt_list_rast_comp <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))),<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb198-111"><a href="point-cloud-classification-1.html#cb198-111" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(plt_combine_temp)</span>
<span id="cb198-112"><a href="point-cloud-classification-1.html#cb198-112" tabindex="-1"></a><span class="co"># plt_list_rast_comp[[2]]</span></span></code></pre></div>
<p>combine the plots for a few piles</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="point-cloud-classification-1.html#cb199-1" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb199-2"><a href="point-cloud-classification-1.html#cb199-2" tabindex="-1"></a>  plt_list_rast_comp</span>
<span id="cb199-3"><a href="point-cloud-classification-1.html#cb199-3" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb199-4"><a href="point-cloud-classification-1.html#cb199-4" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-171-1.png" width="1008" /></p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="point-cloud-classification-1.html#cb200-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/pile_tiles_rast.jpeg&quot;</span>, <span class="at">height =</span> <span class="fl">8.5</span>, <span class="at">width =</span> <span class="fl">10.5</span>)</span></code></pre></div>
<p>a few things are noteworthy in these examples:</p>
<ul>
<li>Piles are clearly visible in some areas of the DTM but less visible in other areas</li>
<li>Piles are delineated in the DSM but with varying degrees of definition based on surrounding terrain and pile structure</li>
<li>The DTM and DSM were rarely impacted by shadows in the RGB imagery</li>
<li>It is interesting to see coarse woody debris occasionally visible in the DSM</li>
</ul>
</div>
</div>
<div id="raster-based-approaches-1" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Raster-based approaches<a href="point-cloud-classification-1.html#raster-based-approaches-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll first attempt to detect slash piles using raster-based methods with the DTM and DSM. These raster-based approaches are simple and efficient but can be limited in complex forest structures where piles might be occluded by overstory trees and rasterization simplifies/removes some of the rich 3D information in the point cloud. For slash piles, which are often irregular and may not have a distinct “treetop” equivalent, common CHM-based tree detection methods might be less directly applicable. We’ll see…</p>
<div id="watershed-segmentation-1" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Watershed Segmentation<a href="point-cloud-classification-1.html#watershed-segmentation-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When used for individual tree detection (ITD), this technique treats the CHM as a topographic surface, where local maxima represent tree tops and valleys represent crown boundaries. A “water source” is conceptually placed at each local lowest point, and the surface is “flooded.” Barriers are generated where different “water sources” meet, forming watershed lines that delineate individual tree crowns.</p>
<p>two possible approaches for segmenting piles are to: 1) segment individual trees using a top-down approach and then use the canopy cover as a mask to then identify slash piles; 2) use a bottoms-up approach to perform slash pile segmentation on a lower “slice” of the CHM based on an expected maximum height of a pile</p>
<p>we’ll first try the bottoms-up approach using a CHM slice with a maximum height of 4 m based on the highest point in the point cloud (3.65 m) of the slash pile which had the tallest measurement in the field (6.4 m). The 6.4 m (21 ft) field measured height seems unlikely even for a machine pile, so we’ll use the point cloud measured height which will align with the CHM data.</p>
<p>check out the lower slice of the CHM</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="point-cloud-classification-1.html#cb201-1" tabindex="-1"></a><span class="co"># set the max expected pile height</span></span>
<span id="cb201-2"><a href="point-cloud-classification-1.html#cb201-2" tabindex="-1"></a>max_ht_m <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb201-3"><a href="point-cloud-classification-1.html#cb201-3" tabindex="-1"></a><span class="co"># lower CHM slice</span></span>
<span id="cb201-4"><a href="point-cloud-classification-1.html#cb201-4" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb201-5"><a href="point-cloud-classification-1.html#cb201-5" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb201-6"><a href="point-cloud-classification-1.html#cb201-6" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-173-1.png" width="1008" /></p>
<p>already, it looks like the piles should be distinguishable objects from this data</p>
<p>let’s run watershed segmentation using <code>lidR::watershed()</code> which is based on the bioconductor package <code>EBIimage</code></p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="point-cloud-classification-1.html#cb202-1" tabindex="-1"></a>watershed_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb202-2"><a href="point-cloud-classification-1.html#cb202-2" tabindex="-1"></a>    <span class="at">chm =</span> cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb202-3"><a href="point-cloud-classification-1.html#cb202-3" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb202-4"><a href="point-cloud-classification-1.html#cb202-4" tabindex="-1"></a>    , <span class="at">th_tree =</span> <span class="fl">0.5</span></span>
<span id="cb202-5"><a href="point-cloud-classification-1.html#cb202-5" tabindex="-1"></a>  )()</span>
<span id="cb202-6"><a href="point-cloud-classification-1.html#cb202-6" tabindex="-1"></a><span class="co"># this is a raster</span></span>
<span id="cb202-7"><a href="point-cloud-classification-1.html#cb202-7" tabindex="-1"></a>watershed_ans</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 5479, 6946, 1  (nrow, ncol, nlyr)
## resolution  : 0.1, 0.1  (x, y)
## extent      : 499264.2, 499958.8, 4317599, 4318147  (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N (EPSG:32613) 
## source(s)   : memory
## varname     : chm_0.1m 
## name        : focal_mean 
## min value   :          1 
## max value   :      17305</code></pre>
<p>each value should be a unique “segment” which we can refine based on rules of expected size and shape of piles</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="point-cloud-classification-1.html#cb204-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(watershed_ans) <span class="sc">%&gt;%</span> </span>
<span id="cb204-2"><a href="point-cloud-classification-1.html#cb204-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>##    layer value count
## 1      1  2599     1
## 2      1  5549    36
## 3      1  8309    18
## 4      1  3635     1
## 5      1  4044     6
## 6      1 11231    15
## 7      1  2560    14
## 8      1  2464   118
## 9      1  8672     5
## 10     1  7055   116</code></pre>
<p>where the “value” is the segment identifier and the count is the number of raster cells assigned to that segment</p>
<p>let’s plot the raster return from the watershed segmentation</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="point-cloud-classification-1.html#cb206-1" tabindex="-1"></a>watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb206-2"><a href="point-cloud-classification-1.html#cb206-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb206-3"><a href="point-cloud-classification-1.html#cb206-3" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">c</span>(</span>
<span id="cb206-4"><a href="point-cloud-classification-1.html#cb206-4" tabindex="-1"></a>      viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb206-5"><a href="point-cloud-classification-1.html#cb206-5" tabindex="-1"></a>      , viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb206-6"><a href="point-cloud-classification-1.html#cb206-6" tabindex="-1"></a>      , viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb206-7"><a href="point-cloud-classification-1.html#cb206-7" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">sample</span>()</span>
<span id="cb206-8"><a href="point-cloud-classification-1.html#cb206-8" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb206-9"><a href="point-cloud-classification-1.html#cb206-9" tabindex="-1"></a>    , <span class="at">axes =</span> F</span>
<span id="cb206-10"><a href="point-cloud-classification-1.html#cb206-10" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-176-1.png" width="1008" /></p>
<p>we can quickly calculate the area of the segments which we could use as a filter</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="point-cloud-classification-1.html#cb207-1" tabindex="-1"></a>min_area_m2 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb207-2"><a href="point-cloud-classification-1.html#cb207-2" tabindex="-1"></a><span class="co"># Two standard US parking spaces, typically measuring 9 feet by 18 feet, </span></span>
<span id="cb207-3"><a href="point-cloud-classification-1.html#cb207-3" tabindex="-1"></a><span class="co"># are roughly equivalent to 30.25 square meters. Each space is approximately 15.125 square meters.</span></span>
<span id="cb207-4"><a href="point-cloud-classification-1.html#cb207-4" tabindex="-1"></a><span class="co"># 15.125*3</span></span>
<span id="cb207-5"><a href="point-cloud-classification-1.html#cb207-5" tabindex="-1"></a>max_area_m2 <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb207-6"><a href="point-cloud-classification-1.html#cb207-6" tabindex="-1"></a><span class="co"># list of segments that meet size threshold</span></span>
<span id="cb207-7"><a href="point-cloud-classification-1.html#cb207-7" tabindex="-1"></a>keep_segs_temp <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb207-8"><a href="point-cloud-classification-1.html#cb207-8" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">freq</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb207-9"><a href="point-cloud-classification-1.html#cb207-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_m2 =</span> count <span class="sc">*</span> (terra<span class="sc">::</span><span class="fu">res</span>(watershed_ans) <span class="sc">%&gt;%</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> <span class="fu">prod</span>()) ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-10"><a href="point-cloud-classification-1.html#cb207-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb207-11"><a href="point-cloud-classification-1.html#cb207-11" tabindex="-1"></a>    area_m2 <span class="sc">&gt;=</span> min_area_m2 <span class="sc">&amp;</span> </span>
<span id="cb207-12"><a href="point-cloud-classification-1.html#cb207-12" tabindex="-1"></a>    area_m2 <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb207-13"><a href="point-cloud-classification-1.html#cb207-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb207-14"><a href="point-cloud-classification-1.html#cb207-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(value)</span>
<span id="cb207-15"><a href="point-cloud-classification-1.html#cb207-15" tabindex="-1"></a><span class="co"># filter the raster and plot it</span></span>
<span id="cb207-16"><a href="point-cloud-classification-1.html#cb207-16" tabindex="-1"></a>watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb207-17"><a href="point-cloud-classification-1.html#cb207-17" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">subst</span>(<span class="at">from =</span> keep_segs_temp, <span class="at">to =</span> keep_segs_temp, <span class="at">others =</span> <span class="cn">NA</span>)</span></code></pre></div>
<p>plot it with the watershed segmented piles (orange) and the actual piles (white)</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="point-cloud-classification-1.html#cb208-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb208-2"><a href="point-cloud-classification-1.html#cb208-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb208-3"><a href="point-cloud-classification-1.html#cb208-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb208-4"><a href="point-cloud-classification-1.html#cb208-4" tabindex="-1"></a>  watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb208-5"><a href="point-cloud-classification-1.html#cb208-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T)</span>
<span id="cb208-6"><a href="point-cloud-classification-1.html#cb208-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb208-7"><a href="point-cloud-classification-1.html#cb208-7" tabindex="-1"></a>)</span>
<span id="cb208-8"><a href="point-cloud-classification-1.html#cb208-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb208-9"><a href="point-cloud-classification-1.html#cb208-9" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb208-10"><a href="point-cloud-classification-1.html#cb208-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb208-11"><a href="point-cloud-classification-1.html#cb208-11" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb208-12"><a href="point-cloud-classification-1.html#cb208-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-178-1.png" width="1008" /></p>
<p>zomg…we are getting so close.</p>
<div id="geometric-filtering-of-watershed-segments-1" class="section level4 hasAnchor" number="5.2.1.1">
<h4><span class="header-section-number">5.2.1.1</span> Geometric filtering of watershed segments<a href="point-cloud-classification-1.html#geometric-filtering-of-watershed-segments-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>now let’s try to filter based on the geometric properties of the watershed-detected segments.</p>
<p>ideally, we want objects that: i) meet the height threshold over the entire surface of the segment (no doughnuts); ii) are not irregularly shaped (relatively few inward angles); and iii) are circular in shape</p>
<p>we’ll make a convex hull of the polygons generated from a raster to smooth out the square edges and any inward curves or indentations, resulting in a boundary that’s always convex (no inward angles). using a convex hull we will be able to filter out:</p>
<ol style="list-style-type: decimal">
<li>watershed detected segments that were actually lower branches of a tree. these will be shaped like a doughnut with circular shape but a hole in the center</li>
<li>watershed detected segments that are irregularly shaped like coarse woody debris that was not organized into piles by humans</li>
</ol>
<p>we will then use circle fitting further filter irregular and linear shapes. Least squares circle fitting is a method to find the circle that best approximates a set of data points by minimizing the sum of the squared distances between the points and the circle wh</p>
<p>let’s convert the watershed-detected segments from raster to vector data and create a convex hull of the shapes for comparison</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="point-cloud-classification-1.html#cb209-1" tabindex="-1"></a><span class="co"># vectors of segments</span></span>
<span id="cb209-2"><a href="point-cloud-classification-1.html#cb209-2" tabindex="-1"></a>watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb209-3"><a href="point-cloud-classification-1.html#cb209-3" tabindex="-1"></a>  watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb209-4"><a href="point-cloud-classification-1.html#cb209-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb209-5"><a href="point-cloud-classification-1.html#cb209-5" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb209-6"><a href="point-cloud-classification-1.html#cb209-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb209-7"><a href="point-cloud-classification-1.html#cb209-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb209-8"><a href="point-cloud-classification-1.html#cb209-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb209-9"><a href="point-cloud-classification-1.html#cb209-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb209-10"><a href="point-cloud-classification-1.html#cb209-10" tabindex="-1"></a><span class="co"># convex hulls of segments</span></span>
<span id="cb209-11"><a href="point-cloud-classification-1.html#cb209-11" tabindex="-1"></a>watershed_ans_poly_chull <span class="ot">&lt;-</span></span>
<span id="cb209-12"><a href="point-cloud-classification-1.html#cb209-12" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb209-13"><a href="point-cloud-classification-1.html#cb209-13" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb209-14"><a href="point-cloud-classification-1.html#cb209-14" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb209-15"><a href="point-cloud-classification-1.html#cb209-15" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb209-16"><a href="point-cloud-classification-1.html#cb209-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span></code></pre></div>
<p>lets make an example area that we’ll use to demonstrate the filtering process of the watershed detected segments</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="point-cloud-classification-1.html#cb210-1" tabindex="-1"></a>aoi_temp <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb210-2"><a href="point-cloud-classification-1.html#cb210-2" tabindex="-1"></a>  <span class="co"># dplyr::filter(pred_id==241) %&gt;%</span></span>
<span id="cb210-3"><a href="point-cloud-classification-1.html#cb210-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id<span class="sc">==</span><span class="dv">11916</span>) <span class="sc">%&gt;%</span></span>
<span id="cb210-4"><a href="point-cloud-classification-1.html#cb210-4" tabindex="-1"></a>  <span class="co"># dplyr::slice_sample(n = 1) %&gt;% </span></span>
<span id="cb210-5"><a href="point-cloud-classification-1.html#cb210-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb210-6"><a href="point-cloud-classification-1.html#cb210-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb210-7"><a href="point-cloud-classification-1.html#cb210-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">55</span>)</span>
<span id="cb210-8"><a href="point-cloud-classification-1.html#cb210-8" tabindex="-1"></a><span class="co"># list of examples</span></span>
<span id="cb210-9"><a href="point-cloud-classification-1.html#cb210-9" tabindex="-1"></a>pred_id_temp <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb210-10"><a href="point-cloud-classification-1.html#cb210-10" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb210-11"><a href="point-cloud-classification-1.html#cb210-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span>
<span id="cb210-12"><a href="point-cloud-classification-1.html#cb210-12" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb210-13"><a href="point-cloud-classification-1.html#cb210-13" tabindex="-1"></a>ortho_plt_temp <span class="ot">&lt;-</span> </span>
<span id="cb210-14"><a href="point-cloud-classification-1.html#cb210-14" tabindex="-1"></a>  <span class="fu">ortho_plt_fn</span>(</span>
<span id="cb210-15"><a href="point-cloud-classification-1.html#cb210-15" tabindex="-1"></a>    <span class="at">stand =</span> aoi_temp</span>
<span id="cb210-16"><a href="point-cloud-classification-1.html#cb210-16" tabindex="-1"></a>    , <span class="at">buffer =</span> <span class="dv">5</span></span>
<span id="cb210-17"><a href="point-cloud-classification-1.html#cb210-17" tabindex="-1"></a>  ) </span></code></pre></div>
<p>plot our example watershed detected segments as vectors (pink) and convex hull of the segments (orange) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="point-cloud-classification-1.html#cb211-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb211-2"><a href="point-cloud-classification-1.html#cb211-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb211-3"><a href="point-cloud-classification-1.html#cb211-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb211-4"><a href="point-cloud-classification-1.html#cb211-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb211-5"><a href="point-cloud-classification-1.html#cb211-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb211-6"><a href="point-cloud-classification-1.html#cb211-6" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb211-7"><a href="point-cloud-classification-1.html#cb211-7" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb211-8"><a href="point-cloud-classification-1.html#cb211-8" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb211-9"><a href="point-cloud-classification-1.html#cb211-9" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb211-10"><a href="point-cloud-classification-1.html#cb211-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb211-11"><a href="point-cloud-classification-1.html#cb211-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb211-12"><a href="point-cloud-classification-1.html#cb211-12" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb211-13"><a href="point-cloud-classification-1.html#cb211-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb211-14"><a href="point-cloud-classification-1.html#cb211-14" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span></span>
<span id="cb211-15"><a href="point-cloud-classification-1.html#cb211-15" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb211-16"><a href="point-cloud-classification-1.html#cb211-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb211-17"><a href="point-cloud-classification-1.html#cb211-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb211-18"><a href="point-cloud-classification-1.html#cb211-18" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb211-19"><a href="point-cloud-classification-1.html#cb211-19" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb211-20"><a href="point-cloud-classification-1.html#cb211-20" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb211-21"><a href="point-cloud-classification-1.html#cb211-21" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb211-22"><a href="point-cloud-classification-1.html#cb211-22" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb211-23"><a href="point-cloud-classification-1.html#cb211-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb211-24"><a href="point-cloud-classification-1.html#cb211-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-181-1.png" width="1008" /></p>
<p>let’s first filter out segments that have holes in them or are very irregularly shaped by comparing the area of the polygon and convex hull</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="point-cloud-classification-1.html#cb212-1" tabindex="-1"></a><span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb212-2"><a href="point-cloud-classification-1.html#cb212-2" tabindex="-1"></a>pct_chull_overlap <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb212-3"><a href="point-cloud-classification-1.html#cb212-3" tabindex="-1"></a><span class="co"># compare areas</span></span>
<span id="cb212-4"><a href="point-cloud-classification-1.html#cb212-4" tabindex="-1"></a>watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb212-5"><a href="point-cloud-classification-1.html#cb212-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">poly_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb212-6"><a href="point-cloud-classification-1.html#cb212-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb212-7"><a href="point-cloud-classification-1.html#cb212-7" tabindex="-1"></a>    watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb212-8"><a href="point-cloud-classification-1.html#cb212-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb212-9"><a href="point-cloud-classification-1.html#cb212-9" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb212-10"><a href="point-cloud-classification-1.html#cb212-10" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb212-11"><a href="point-cloud-classification-1.html#cb212-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-12"><a href="point-cloud-classification-1.html#cb212-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb212-13"><a href="point-cloud-classification-1.html#cb212-13" tabindex="-1"></a>    <span class="at">pct_chull =</span> poly_area_m2<span class="sc">/</span>chull_area_m2</span>
<span id="cb212-14"><a href="point-cloud-classification-1.html#cb212-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-15"><a href="point-cloud-classification-1.html#cb212-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb212-16"><a href="point-cloud-classification-1.html#cb212-16" tabindex="-1"></a>    pct_chull <span class="sc">&gt;=</span> pct_chull_overlap</span>
<span id="cb212-17"><a href="point-cloud-classification-1.html#cb212-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-18"><a href="point-cloud-classification-1.html#cb212-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span></code></pre></div>
<p>which piles meet the minimum overlap threshold (black outline) between the segmented polygon and the convex hull?</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="point-cloud-classification-1.html#cb213-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb213-2"><a href="point-cloud-classification-1.html#cb213-2" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb213-3"><a href="point-cloud-classification-1.html#cb213-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb213-4"><a href="point-cloud-classification-1.html#cb213-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb213-5"><a href="point-cloud-classification-1.html#cb213-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb213-6"><a href="point-cloud-classification-1.html#cb213-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb213-7"><a href="point-cloud-classification-1.html#cb213-7" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb213-8"><a href="point-cloud-classification-1.html#cb213-8" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb213-9"><a href="point-cloud-classification-1.html#cb213-9" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb213-10"><a href="point-cloud-classification-1.html#cb213-10" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb213-11"><a href="point-cloud-classification-1.html#cb213-11" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb213-12"><a href="point-cloud-classification-1.html#cb213-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb213-13"><a href="point-cloud-classification-1.html#cb213-13" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb213-14"><a href="point-cloud-classification-1.html#cb213-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb213-15"><a href="point-cloud-classification-1.html#cb213-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb213-16"><a href="point-cloud-classification-1.html#cb213-16" tabindex="-1"></a>        <span class="at">meets_overlap =</span> pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id</span>
<span id="cb213-17"><a href="point-cloud-classification-1.html#cb213-17" tabindex="-1"></a>      )</span>
<span id="cb213-18"><a href="point-cloud-classification-1.html#cb213-18" tabindex="-1"></a>    , ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> meets_overlap)</span>
<span id="cb213-19"><a href="point-cloud-classification-1.html#cb213-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb213-20"><a href="point-cloud-classification-1.html#cb213-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb213-21"><a href="point-cloud-classification-1.html#cb213-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb213-22"><a href="point-cloud-classification-1.html#cb213-22" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb213-23"><a href="point-cloud-classification-1.html#cb213-23" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb213-24"><a href="point-cloud-classification-1.html#cb213-24" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb213-25"><a href="point-cloud-classification-1.html#cb213-25" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb213-26"><a href="point-cloud-classification-1.html#cb213-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb213-27"><a href="point-cloud-classification-1.html#cb213-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb213-28"><a href="point-cloud-classification-1.html#cb213-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb213-29"><a href="point-cloud-classification-1.html#cb213-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-183-1.png" width="1008" /></p>
<p>that looks like it did what we wanted it to do (filter out segments with holes and irregular shapes) let’s look at the entire area again after applying this filter plotting the remaining watershed segmented piles (orange) and the actual piles (white)</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="point-cloud-classification-1.html#cb214-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb214-2"><a href="point-cloud-classification-1.html#cb214-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb214-3"><a href="point-cloud-classification-1.html#cb214-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb214-4"><a href="point-cloud-classification-1.html#cb214-4" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb214-5"><a href="point-cloud-classification-1.html#cb214-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb214-6"><a href="point-cloud-classification-1.html#cb214-6" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb214-7"><a href="point-cloud-classification-1.html#cb214-7" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb214-8"><a href="point-cloud-classification-1.html#cb214-8" tabindex="-1"></a>)</span>
<span id="cb214-9"><a href="point-cloud-classification-1.html#cb214-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb214-10"><a href="point-cloud-classification-1.html#cb214-10" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb214-11"><a href="point-cloud-classification-1.html#cb214-11" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb214-12"><a href="point-cloud-classification-1.html#cb214-12" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb214-13"><a href="point-cloud-classification-1.html#cb214-13" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-184-1.png" width="1008" /></p>
<p>finally, let’s apply a circle-fitting algorithm to remove non-circular segments from the remaining segments.</p>
<p>Least squares circle fitting is a method to find the circle that best approximates a set of data points by minimizing the sum of the squared distances between the points and the circle. The <code>lidR::fit_circle()</code> function finds the best-fitting flat, horizontal circle for a group of 3D points, even if some of those points are messy or don’t quite fit. It determines the circle’s center and size, and also provides an “angular range” to show how much of a complete circle the points actually form, which is a more reliable measure than a simple error value (e.g. RMSE).</p>
<p>The “angular range” tells you how much of a complete circle the points in the watershed-detected segment actually cover. Imagine drawing a circle, and then only having points along a part of its edge, here’s how to interpret it:</p>
<ul>
<li>360 degrees suggests the points form a full, unbroken circle, like the base of a perfectly round slash pile.</li>
<li>180 degrees would mean the points only form a half-circle or a semi-circle.</li>
</ul>
<p>A smaller range (e.g., 90 degrees) indicates just a partial arc or a small curve. This can help us determine if a group of points truly represents a circular shape, which is useful for identifying objects like slash piles that are expected to have a round or conical base.</p>
<p>we’ll define a function to pass our <code>sf</code> polygon data of watershed detected segments and return a <code>sf</code> data of the fitted circles</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="point-cloud-classification-1.html#cb215-1" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-2"><a href="point-cloud-classification-1.html#cb215-2" tabindex="-1"></a><span class="co"># 1)</span></span>
<span id="cb215-3"><a href="point-cloud-classification-1.html#cb215-3" tabindex="-1"></a><span class="co"># function to return sf circle from xy center and radius in given crs</span></span>
<span id="cb215-4"><a href="point-cloud-classification-1.html#cb215-4" tabindex="-1"></a><span class="co"># to handle return from common circle fitting algorithms</span></span>
<span id="cb215-5"><a href="point-cloud-classification-1.html#cb215-5" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-6"><a href="point-cloud-classification-1.html#cb215-6" tabindex="-1"></a>point_xy_radius_to_circle_sf <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb215-7"><a href="point-cloud-classification-1.html#cb215-7" tabindex="-1"></a>  center_x</span>
<span id="cb215-8"><a href="point-cloud-classification-1.html#cb215-8" tabindex="-1"></a>  , center_y</span>
<span id="cb215-9"><a href="point-cloud-classification-1.html#cb215-9" tabindex="-1"></a>  , radius</span>
<span id="cb215-10"><a href="point-cloud-classification-1.html#cb215-10" tabindex="-1"></a>  , <span class="at">crs =</span> <span class="cn">NULL</span></span>
<span id="cb215-11"><a href="point-cloud-classification-1.html#cb215-11" tabindex="-1"></a>) {</span>
<span id="cb215-12"><a href="point-cloud-classification-1.html#cb215-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(crs)){<span class="fu">stop</span>(<span class="st">&quot;need a crs, guy&quot;</span>)}</span>
<span id="cb215-13"><a href="point-cloud-classification-1.html#cb215-13" tabindex="-1"></a>  <span class="co"># create a point geometry object</span></span>
<span id="cb215-14"><a href="point-cloud-classification-1.html#cb215-14" tabindex="-1"></a>  center_point <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(center_x, center_y))</span>
<span id="cb215-15"><a href="point-cloud-classification-1.html#cb215-15" tabindex="-1"></a>  <span class="co"># create an sf object from the point</span></span>
<span id="cb215-16"><a href="point-cloud-classification-1.html#cb215-16" tabindex="-1"></a>  center_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_sf</span>(</span>
<span id="cb215-17"><a href="point-cloud-classification-1.html#cb215-17" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb215-18"><a href="point-cloud-classification-1.html#cb215-18" tabindex="-1"></a>      <span class="at">center_x =</span> center_x</span>
<span id="cb215-19"><a href="point-cloud-classification-1.html#cb215-19" tabindex="-1"></a>      , <span class="at">center_y =</span> center_y</span>
<span id="cb215-20"><a href="point-cloud-classification-1.html#cb215-20" tabindex="-1"></a>      , <span class="at">radius =</span> radius</span>
<span id="cb215-21"><a href="point-cloud-classification-1.html#cb215-21" tabindex="-1"></a>    )</span>
<span id="cb215-22"><a href="point-cloud-classification-1.html#cb215-22" tabindex="-1"></a>    , <span class="at">geometry =</span> sf<span class="sc">::</span><span class="fu">st_sfc</span>(center_point)</span>
<span id="cb215-23"><a href="point-cloud-classification-1.html#cb215-23" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb215-24"><a href="point-cloud-classification-1.html#cb215-24" tabindex="-1"></a>  )</span>
<span id="cb215-25"><a href="point-cloud-classification-1.html#cb215-25" tabindex="-1"></a>  <span class="co"># create the circle geometry by buffering the point</span></span>
<span id="cb215-26"><a href="point-cloud-classification-1.html#cb215-26" tabindex="-1"></a>  circle_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(center_sf, <span class="at">dist =</span> radius)</span>
<span id="cb215-27"><a href="point-cloud-classification-1.html#cb215-27" tabindex="-1"></a>  <span class="fu">return</span>(circle_sf)</span>
<span id="cb215-28"><a href="point-cloud-classification-1.html#cb215-28" tabindex="-1"></a>}</span>
<span id="cb215-29"><a href="point-cloud-classification-1.html#cb215-29" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-30"><a href="point-cloud-classification-1.html#cb215-30" tabindex="-1"></a><span class="co"># 2)</span></span>
<span id="cb215-31"><a href="point-cloud-classification-1.html#cb215-31" tabindex="-1"></a><span class="co"># function to generate 2d xy points from polygon feature</span></span>
<span id="cb215-32"><a href="point-cloud-classification-1.html#cb215-32" tabindex="-1"></a><span class="co"># to pass to common circle fitting algorithms</span></span>
<span id="cb215-33"><a href="point-cloud-classification-1.html#cb215-33" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb215-34"><a href="point-cloud-classification-1.html#cb215-34" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-35"><a href="point-cloud-classification-1.html#cb215-35" tabindex="-1"></a>poly_to_points <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb215-36"><a href="point-cloud-classification-1.html#cb215-36" tabindex="-1"></a>  sf_data</span>
<span id="cb215-37"><a href="point-cloud-classification-1.html#cb215-37" tabindex="-1"></a>  , <span class="at">as_spatial =</span> F <span class="co"># if set to F, returns xy dataframe; if T returns sf data</span></span>
<span id="cb215-38"><a href="point-cloud-classification-1.html#cb215-38" tabindex="-1"></a>  , <span class="at">simplify_multipolygons =</span> F <span class="co"># if set to T, multipolygons are simplified by keeping the largest segment</span></span>
<span id="cb215-39"><a href="point-cloud-classification-1.html#cb215-39" tabindex="-1"></a>) {</span>
<span id="cb215-40"><a href="point-cloud-classification-1.html#cb215-40" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb215-41"><a href="point-cloud-classification-1.html#cb215-41" tabindex="-1"></a>  <span class="co"># just work with the first</span></span>
<span id="cb215-42"><a href="point-cloud-classification-1.html#cb215-42" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(sf_data)<span class="sc">&gt;</span><span class="dv">1</span>){<span class="fu">stop</span>(<span class="st">&quot;this function only works with a single record at a time&quot;</span>)}</span>
<span id="cb215-43"><a href="point-cloud-classification-1.html#cb215-43" tabindex="-1"></a>  <span class="co"># simplify_multipolygons</span></span>
<span id="cb215-44"><a href="point-cloud-classification-1.html#cb215-44" tabindex="-1"></a>  <span class="cf">if</span>(simplify_multipolygons){</span>
<span id="cb215-45"><a href="point-cloud-classification-1.html#cb215-45" tabindex="-1"></a>    sf_data <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb215-46"><a href="point-cloud-classification-1.html#cb215-46" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb215-47"><a href="point-cloud-classification-1.html#cb215-47" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb215-48"><a href="point-cloud-classification-1.html#cb215-48" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb215-49"><a href="point-cloud-classification-1.html#cb215-49" tabindex="-1"></a>  }</span>
<span id="cb215-50"><a href="point-cloud-classification-1.html#cb215-50" tabindex="-1"></a>  <span class="co"># get point coordinates</span></span>
<span id="cb215-51"><a href="point-cloud-classification-1.html#cb215-51" tabindex="-1"></a>  xy_temp <span class="ot">&lt;-</span> </span>
<span id="cb215-52"><a href="point-cloud-classification-1.html#cb215-52" tabindex="-1"></a>    sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb215-53"><a href="point-cloud-classification-1.html#cb215-53" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb215-54"><a href="point-cloud-classification-1.html#cb215-54" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb215-55"><a href="point-cloud-classification-1.html#cb215-55" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span> </span>
<span id="cb215-56"><a href="point-cloud-classification-1.html#cb215-56" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(x,y) <span class="sc">%&gt;%</span> </span>
<span id="cb215-57"><a href="point-cloud-classification-1.html#cb215-57" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">z=</span><span class="dv">0</span>)</span>
<span id="cb215-58"><a href="point-cloud-classification-1.html#cb215-58" tabindex="-1"></a>  <span class="co"># as_spatial</span></span>
<span id="cb215-59"><a href="point-cloud-classification-1.html#cb215-59" tabindex="-1"></a>  <span class="cf">if</span>(as_spatial){</span>
<span id="cb215-60"><a href="point-cloud-classification-1.html#cb215-60" tabindex="-1"></a>    xy_temp <span class="ot">&lt;-</span> xy_temp <span class="sc">%&gt;%</span> </span>
<span id="cb215-61"><a href="point-cloud-classification-1.html#cb215-61" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data), <span class="at">remove =</span> F)</span>
<span id="cb215-62"><a href="point-cloud-classification-1.html#cb215-62" tabindex="-1"></a>  }</span>
<span id="cb215-63"><a href="point-cloud-classification-1.html#cb215-63" tabindex="-1"></a>  <span class="fu">return</span>(xy_temp)</span>
<span id="cb215-64"><a href="point-cloud-classification-1.html#cb215-64" tabindex="-1"></a>}</span>
<span id="cb215-65"><a href="point-cloud-classification-1.html#cb215-65" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;% </span></span>
<span id="cb215-66"><a href="point-cloud-classification-1.html#cb215-66" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id %in% c(7717)) %&gt;%</span></span>
<span id="cb215-67"><a href="point-cloud-classification-1.html#cb215-67" tabindex="-1"></a><span class="co">#   # poly_to_points(as_spatial = T) %&gt;% </span></span>
<span id="cb215-68"><a href="point-cloud-classification-1.html#cb215-68" tabindex="-1"></a><span class="co">#   poly_to_points(as_spatial = F) %&gt;% </span></span>
<span id="cb215-69"><a href="point-cloud-classification-1.html#cb215-69" tabindex="-1"></a><span class="co">#   ggplot() + </span></span>
<span id="cb215-70"><a href="point-cloud-classification-1.html#cb215-70" tabindex="-1"></a><span class="co">#     # geom_sf()</span></span>
<span id="cb215-71"><a href="point-cloud-classification-1.html#cb215-71" tabindex="-1"></a><span class="co">#     geom_point(aes(x=x,y=y))</span></span>
<span id="cb215-72"><a href="point-cloud-classification-1.html#cb215-72" tabindex="-1"></a></span>
<span id="cb215-73"><a href="point-cloud-classification-1.html#cb215-73" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-74"><a href="point-cloud-classification-1.html#cb215-74" tabindex="-1"></a><span class="co"># 3)</span></span>
<span id="cb215-75"><a href="point-cloud-classification-1.html#cb215-75" tabindex="-1"></a><span class="co"># function to combine poly_to_points, lidR::fit_circle, and point_xy_radius_to_circle_sf</span></span>
<span id="cb215-76"><a href="point-cloud-classification-1.html#cb215-76" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb215-77"><a href="point-cloud-classification-1.html#cb215-77" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-78"><a href="point-cloud-classification-1.html#cb215-78" tabindex="-1"></a>poly_circle_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb215-79"><a href="point-cloud-classification-1.html#cb215-79" tabindex="-1"></a>  poly</span>
<span id="cb215-80"><a href="point-cloud-classification-1.html#cb215-80" tabindex="-1"></a>  <span class="co"># if set to T, multipolygons are simplified by keeping the largest segment</span></span>
<span id="cb215-81"><a href="point-cloud-classification-1.html#cb215-81" tabindex="-1"></a>  , <span class="at">simplify_multipolygons =</span> F</span>
<span id="cb215-82"><a href="point-cloud-classification-1.html#cb215-82" tabindex="-1"></a>  <span class="co"># number of iterations for the RANSAC fitting algorithm</span></span>
<span id="cb215-83"><a href="point-cloud-classification-1.html#cb215-83" tabindex="-1"></a>  , <span class="at">num_iterations =</span> <span class="dv">100</span></span>
<span id="cb215-84"><a href="point-cloud-classification-1.html#cb215-84" tabindex="-1"></a>  <span class="co"># threshold value; points are considered inliers if their residuals are below this value</span></span>
<span id="cb215-85"><a href="point-cloud-classification-1.html#cb215-85" tabindex="-1"></a>  , <span class="at">inlier_threshold =</span> <span class="fl">0.01</span></span>
<span id="cb215-86"><a href="point-cloud-classification-1.html#cb215-86" tabindex="-1"></a>) {</span>
<span id="cb215-87"><a href="point-cloud-classification-1.html#cb215-87" tabindex="-1"></a>  <span class="co"># poly_to_points</span></span>
<span id="cb215-88"><a href="point-cloud-classification-1.html#cb215-88" tabindex="-1"></a>  poly_to_points_ans <span class="ot">&lt;-</span> <span class="fu">poly_to_points</span>(poly, <span class="at">as_spatial =</span> F, <span class="at">simplify_multipolygons =</span> simplify_multipolygons)</span>
<span id="cb215-89"><a href="point-cloud-classification-1.html#cb215-89" tabindex="-1"></a>  <span class="co"># fit_circle</span></span>
<span id="cb215-90"><a href="point-cloud-classification-1.html#cb215-90" tabindex="-1"></a>  fit_circle_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">fit_circle</span>(</span>
<span id="cb215-91"><a href="point-cloud-classification-1.html#cb215-91" tabindex="-1"></a>    <span class="at">points =</span> poly_to_points_ans <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb215-92"><a href="point-cloud-classification-1.html#cb215-92" tabindex="-1"></a>    <span class="co"># number of iterations for the RANSAC fitting algorithm</span></span>
<span id="cb215-93"><a href="point-cloud-classification-1.html#cb215-93" tabindex="-1"></a>    , <span class="at">num_iterations =</span> num_iterations</span>
<span id="cb215-94"><a href="point-cloud-classification-1.html#cb215-94" tabindex="-1"></a>    <span class="co"># threshold value; points are considered inliers if their residuals are below this value</span></span>
<span id="cb215-95"><a href="point-cloud-classification-1.html#cb215-95" tabindex="-1"></a>    , <span class="at">inlier_threshold =</span> inlier_threshold</span>
<span id="cb215-96"><a href="point-cloud-classification-1.html#cb215-96" tabindex="-1"></a>  )</span>
<span id="cb215-97"><a href="point-cloud-classification-1.html#cb215-97" tabindex="-1"></a>  <span class="co"># point_xy_radius_to_circle_sf</span></span>
<span id="cb215-98"><a href="point-cloud-classification-1.html#cb215-98" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> <span class="fu">point_xy_radius_to_circle_sf</span>(</span>
<span id="cb215-99"><a href="point-cloud-classification-1.html#cb215-99" tabindex="-1"></a>    <span class="at">center_x =</span> fit_circle_ans<span class="sc">$</span>center_x</span>
<span id="cb215-100"><a href="point-cloud-classification-1.html#cb215-100" tabindex="-1"></a>    , <span class="at">center_y =</span> fit_circle_ans<span class="sc">$</span>center_y</span>
<span id="cb215-101"><a href="point-cloud-classification-1.html#cb215-101" tabindex="-1"></a>    , <span class="at">radius =</span> fit_circle_ans<span class="sc">$</span>radius</span>
<span id="cb215-102"><a href="point-cloud-classification-1.html#cb215-102" tabindex="-1"></a>    , <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(poly)</span>
<span id="cb215-103"><a href="point-cloud-classification-1.html#cb215-103" tabindex="-1"></a>  )</span>
<span id="cb215-104"><a href="point-cloud-classification-1.html#cb215-104" tabindex="-1"></a>  <span class="co"># add other vars</span></span>
<span id="cb215-105"><a href="point-cloud-classification-1.html#cb215-105" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> ans <span class="sc">%&gt;%</span> </span>
<span id="cb215-106"><a href="point-cloud-classification-1.html#cb215-106" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb215-107"><a href="point-cloud-classification-1.html#cb215-107" tabindex="-1"></a>      <span class="at">covered_arc_degree =</span> fit_circle_ans<span class="sc">$</span>covered_arc_degree</span>
<span id="cb215-108"><a href="point-cloud-classification-1.html#cb215-108" tabindex="-1"></a>      , <span class="at">percentage_inlier =</span> fit_circle_ans<span class="sc">$</span>percentage_inlier</span>
<span id="cb215-109"><a href="point-cloud-classification-1.html#cb215-109" tabindex="-1"></a>      , <span class="at">percentage_inside =</span> fit_circle_ans<span class="sc">$</span>percentage_inside</span>
<span id="cb215-110"><a href="point-cloud-classification-1.html#cb215-110" tabindex="-1"></a>      <span class="co"># , inliers = fit_circle_ans$inliers</span></span>
<span id="cb215-111"><a href="point-cloud-classification-1.html#cb215-111" tabindex="-1"></a>    )</span>
<span id="cb215-112"><a href="point-cloud-classification-1.html#cb215-112" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb215-113"><a href="point-cloud-classification-1.html#cb215-113" tabindex="-1"></a>  <span class="fu">return</span>(ans)</span>
<span id="cb215-114"><a href="point-cloud-classification-1.html#cb215-114" tabindex="-1"></a>}</span>
<span id="cb215-115"><a href="point-cloud-classification-1.html#cb215-115" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;%</span></span>
<span id="cb215-116"><a href="point-cloud-classification-1.html#cb215-116" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id == 7717) %&gt;%</span></span>
<span id="cb215-117"><a href="point-cloud-classification-1.html#cb215-117" tabindex="-1"></a><span class="co">#   poly_circle_fit() %&gt;%</span></span>
<span id="cb215-118"><a href="point-cloud-classification-1.html#cb215-118" tabindex="-1"></a><span class="co">#   ggplot() + geom_sf() + </span></span>
<span id="cb215-119"><a href="point-cloud-classification-1.html#cb215-119" tabindex="-1"></a><span class="co">#   geom_sf(</span></span>
<span id="cb215-120"><a href="point-cloud-classification-1.html#cb215-120" tabindex="-1"></a><span class="co">#     data = filtered_watershed_ans_poly %&gt;% dplyr::filter(pred_id == 7717) %&gt;% poly_to_points(as_spatial = T)</span></span>
<span id="cb215-121"><a href="point-cloud-classification-1.html#cb215-121" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb215-122"><a href="point-cloud-classification-1.html#cb215-122" tabindex="-1"></a></span>
<span id="cb215-123"><a href="point-cloud-classification-1.html#cb215-123" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;%</span></span>
<span id="cb215-124"><a href="point-cloud-classification-1.html#cb215-124" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id == 7717) %&gt;%</span></span>
<span id="cb215-125"><a href="point-cloud-classification-1.html#cb215-125" tabindex="-1"></a><span class="co">#   poly_circle_fit() %&gt;% </span></span>
<span id="cb215-126"><a href="point-cloud-classification-1.html#cb215-126" tabindex="-1"></a><span class="co">#   dplyr::glimpse()</span></span>
<span id="cb215-127"><a href="point-cloud-classification-1.html#cb215-127" tabindex="-1"></a></span>
<span id="cb215-128"><a href="point-cloud-classification-1.html#cb215-128" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-129"><a href="point-cloud-classification-1.html#cb215-129" tabindex="-1"></a><span class="co"># 4)</span></span>
<span id="cb215-130"><a href="point-cloud-classification-1.html#cb215-130" tabindex="-1"></a><span class="co"># function to combine poly_to_points, lidR::fit_circle, and point_xy_radius_to_circle_sf</span></span>
<span id="cb215-131"><a href="point-cloud-classification-1.html#cb215-131" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb215-132"><a href="point-cloud-classification-1.html#cb215-132" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb215-133"><a href="point-cloud-classification-1.html#cb215-133" tabindex="-1"></a>sf_data_circle_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data) {</span>
<span id="cb215-134"><a href="point-cloud-classification-1.html#cb215-134" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb215-135"><a href="point-cloud-classification-1.html#cb215-135" tabindex="-1"></a>  <span class="co"># apply poly_circle_fit() to each row to get fitted circle sf data</span></span>
<span id="cb215-136"><a href="point-cloud-classification-1.html#cb215-136" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb215-137"><a href="point-cloud-classification-1.html#cb215-137" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb215-138"><a href="point-cloud-classification-1.html#cb215-138" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id_xxx =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb215-139"><a href="point-cloud-classification-1.html#cb215-139" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">nest_by</span>(id_xxx) <span class="sc">%&gt;%</span> </span>
<span id="cb215-140"><a href="point-cloud-classification-1.html#cb215-140" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb215-141"><a href="point-cloud-classification-1.html#cb215-141" tabindex="-1"></a>      <span class="at">circle_fit =</span> <span class="fu">poly_circle_fit</span>(<span class="at">poly =</span> data)</span>
<span id="cb215-142"><a href="point-cloud-classification-1.html#cb215-142" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb215-143"><a href="point-cloud-classification-1.html#cb215-143" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(circle_fit)</span>
<span id="cb215-144"><a href="point-cloud-classification-1.html#cb215-144" tabindex="-1"></a>  <span class="co"># combine with original data but drop original geom</span></span>
<span id="cb215-145"><a href="point-cloud-classification-1.html#cb215-145" tabindex="-1"></a>  df <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb215-146"><a href="point-cloud-classification-1.html#cb215-146" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb215-147"><a href="point-cloud-classification-1.html#cb215-147" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(cf) <span class="sc">%&gt;%</span> </span>
<span id="cb215-148"><a href="point-cloud-classification-1.html#cb215-148" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data))</span>
<span id="cb215-149"><a href="point-cloud-classification-1.html#cb215-149" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb215-150"><a href="point-cloud-classification-1.html#cb215-150" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb215-151"><a href="point-cloud-classification-1.html#cb215-151" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s apply the <code>sf_data_circle_fit()</code> function we just defined fits the best circle using <code>lidR::fit_circle()</code> to each watershed detected segment to get a spatial data frame with the best fitting circle for each segment</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="point-cloud-classification-1.html#cb216-1" tabindex="-1"></a><span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb216-2"><a href="point-cloud-classification-1.html#cb216-2" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb216-3"><a href="point-cloud-classification-1.html#cb216-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb216-4"><a href="point-cloud-classification-1.html#cb216-4" tabindex="-1"></a>  <span class="fu">sf_data_circle_fit</span>()</span>
<span id="cb216-5"><a href="point-cloud-classification-1.html#cb216-5" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb216-6"><a href="point-cloud-classification-1.html#cb216-6" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 523
## Columns: 8
## $ pred_id            &lt;dbl&gt; 5, 9, 13, 17, 38, 48, 60, 75, 80, 110, 130, 153, 16…
## $ center_x           &lt;dbl&gt; 499867.6, 499718.7, 499777.8, 499910.5, 499476.8, 4…
## $ center_y           &lt;dbl&gt; 4318009, 4317851, 4318048, 4317617, 4317666, 431808…
## $ radius             &lt;dbl&gt; 1.4063857, 1.5971949, 0.7179556, 1.3044741, 0.46059…
## $ covered_arc_degree &lt;dbl&gt; 3, 0, 0, 3, 0, 0, 3, 0, 3, 6, 0, 0, 0, 15, 3, 6, 0,…
## $ percentage_inlier  &lt;dbl&gt; 0.09302326, 0.05813953, 0.11111111, 0.11764706, 0.1…
## $ percentage_inside  &lt;dbl&gt; 0.60465116, 0.41860465, 0.18888889, 0.33333333, 0.1…
## $ geometry           &lt;POLYGON [m]&gt; POLYGON ((499869 4318009, 4..., POLYGON ((4…</code></pre>
<p>let’s check out the distribution of the metrics that quantify the fit of the circle</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="point-cloud-classification-1.html#cb218-1" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb218-2"><a href="point-cloud-classification-1.html#cb218-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb218-3"><a href="point-cloud-classification-1.html#cb218-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(pred_id,center_x,center_y,radius)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-4"><a href="point-cloud-classification-1.html#cb218-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb218-5"><a href="point-cloud-classification-1.html#cb218-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb218-6"><a href="point-cloud-classification-1.html#cb218-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb218-7"><a href="point-cloud-classification-1.html#cb218-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> ggplot2<span class="sc">::</span><span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb218-8"><a href="point-cloud-classification-1.html#cb218-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;rocket&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb218-9"><a href="point-cloud-classification-1.html#cb218-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb218-10"><a href="point-cloud-classification-1.html#cb218-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb218-11"><a href="point-cloud-classification-1.html#cb218-11" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb218-12"><a href="point-cloud-classification-1.html#cb218-12" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb218-13"><a href="point-cloud-classification-1.html#cb218-13" tabindex="-1"></a>      , <span class="at">axis.title.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb218-14"><a href="point-cloud-classification-1.html#cb218-14" tabindex="-1"></a>      , <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb218-15"><a href="point-cloud-classification-1.html#cb218-15" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb218-16"><a href="point-cloud-classification-1.html#cb218-16" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-187-1.png" width="1008" /></p>
<p>let’s look at the best fitting circles using the remaining piles from our example above</p>
<p>example of watershed detected segments as vectors (pink) and best fitting circle of the segments (orange) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="point-cloud-classification-1.html#cb219-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb219-2"><a href="point-cloud-classification-1.html#cb219-2" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb219-3"><a href="point-cloud-classification-1.html#cb219-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb219-4"><a href="point-cloud-classification-1.html#cb219-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb219-5"><a href="point-cloud-classification-1.html#cb219-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb219-6"><a href="point-cloud-classification-1.html#cb219-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb219-7"><a href="point-cloud-classification-1.html#cb219-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb219-8"><a href="point-cloud-classification-1.html#cb219-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb219-9"><a href="point-cloud-classification-1.html#cb219-9" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb219-10"><a href="point-cloud-classification-1.html#cb219-10" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb219-11"><a href="point-cloud-classification-1.html#cb219-11" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb219-12"><a href="point-cloud-classification-1.html#cb219-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb219-13"><a href="point-cloud-classification-1.html#cb219-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb219-14"><a href="point-cloud-classification-1.html#cb219-14" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb219-15"><a href="point-cloud-classification-1.html#cb219-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb219-16"><a href="point-cloud-classification-1.html#cb219-16" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb219-17"><a href="point-cloud-classification-1.html#cb219-17" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb219-18"><a href="point-cloud-classification-1.html#cb219-18" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span></span>
<span id="cb219-19"><a href="point-cloud-classification-1.html#cb219-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb219-20"><a href="point-cloud-classification-1.html#cb219-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb219-21"><a href="point-cloud-classification-1.html#cb219-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb219-22"><a href="point-cloud-classification-1.html#cb219-22" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb219-23"><a href="point-cloud-classification-1.html#cb219-23" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb219-24"><a href="point-cloud-classification-1.html#cb219-24" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb219-25"><a href="point-cloud-classification-1.html#cb219-25" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb219-26"><a href="point-cloud-classification-1.html#cb219-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb219-27"><a href="point-cloud-classification-1.html#cb219-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-188-1.png" width="1008" /></p>
<p>the best fitting circles on the linear watershed detected segements are not very well fitting, we can filter using the intersection over union (IoU) between the circle and the predicted segment. we’ll use the IoU function we defined in this <a href="rgb-classification.html#iou_match">earlier section</a>.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="point-cloud-classification-1.html#cb220-1" tabindex="-1"></a>watershed_circle_fit_iou <span class="ot">&lt;-</span> </span>
<span id="cb220-2"><a href="point-cloud-classification-1.html#cb220-2" tabindex="-1"></a>  watershed_keep_overlaps_chull_pred_id <span class="sc">%&gt;%</span> </span>
<span id="cb220-3"><a href="point-cloud-classification-1.html#cb220-3" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb220-4"><a href="point-cloud-classification-1.html#cb220-4" tabindex="-1"></a>    <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb220-5"><a href="point-cloud-classification-1.html#cb220-5" tabindex="-1"></a>      <span class="at">gt_inst =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb220-6"><a href="point-cloud-classification-1.html#cb220-6" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x)</span>
<span id="cb220-7"><a href="point-cloud-classification-1.html#cb220-7" tabindex="-1"></a>      , <span class="at">gt_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb220-8"><a href="point-cloud-classification-1.html#cb220-8" tabindex="-1"></a>      , <span class="at">predictions =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb220-9"><a href="point-cloud-classification-1.html#cb220-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb220-10"><a href="point-cloud-classification-1.html#cb220-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb220-11"><a href="point-cloud-classification-1.html#cb220-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_pred_id =</span> pred_id)</span>
<span id="cb220-12"><a href="point-cloud-classification-1.html#cb220-12" tabindex="-1"></a>      , <span class="at">pred_id =</span> <span class="st">&quot;circ_pred_id&quot;</span></span>
<span id="cb220-13"><a href="point-cloud-classification-1.html#cb220-13" tabindex="-1"></a>      , <span class="at">min_iou_pct =</span> <span class="dv">0</span></span>
<span id="cb220-14"><a href="point-cloud-classification-1.html#cb220-14" tabindex="-1"></a>    )    </span>
<span id="cb220-15"><a href="point-cloud-classification-1.html#cb220-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-16"><a href="point-cloud-classification-1.html#cb220-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb220-17"><a href="point-cloud-classification-1.html#cb220-17" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb220-18"><a href="point-cloud-classification-1.html#cb220-18" tabindex="-1"></a>watershed_circle_fit_iou <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 521
## Columns: 5
## $ pred_id      &lt;dbl&gt; 5, 9, 13, 17, 38, 48, 60, 75, 80, 110, 130, 153, 161, 174…
## $ i_area       &lt;dbl&gt; 3.6380588, 3.0566884, 1.2494129, 2.1531182, 0.5491588, 0.…
## $ u_area       &lt;dbl&gt; 6.862923, 12.023952, 4.719213, 5.710339, 2.147028, 2.2116…
## $ iou          &lt;dbl&gt; 5.301034e-01, 2.542166e-01, 2.647503e-01, 3.770561e-01, 2…
## $ circ_pred_id &lt;dbl&gt; 5, 9, 13, 17, 38, 48, 60, 75, 80, 110, 130, 153, 161, 174…</code></pre>
<p>what is the distribution of IoU of the watershed segments and the best fit circle of those segments?</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="point-cloud-classification-1.html#cb222-1" tabindex="-1"></a>watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb222-2"><a href="point-cloud-classification-1.html#cb222-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> iou)) <span class="sc">+</span></span>
<span id="cb222-3"><a href="point-cloud-classification-1.html#cb222-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="st">&quot;navy&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb222-4"><a href="point-cloud-classification-1.html#cb222-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb222-5"><a href="point-cloud-classification-1.html#cb222-5" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;IoU of the watershed segments and the best fit circle&quot;</span></span>
<span id="cb222-6"><a href="point-cloud-classification-1.html#cb222-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb222-7"><a href="point-cloud-classification-1.html#cb222-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb222-8"><a href="point-cloud-classification-1.html#cb222-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb222-9"><a href="point-cloud-classification-1.html#cb222-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb222-10"><a href="point-cloud-classification-1.html#cb222-10" tabindex="-1"></a>    <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb222-11"><a href="point-cloud-classification-1.html#cb222-11" tabindex="-1"></a>    , <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb222-12"><a href="point-cloud-classification-1.html#cb222-12" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb222-13"><a href="point-cloud-classification-1.html#cb222-13" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-190-1.png" width="1008" /></p>
<p>let’s color our predicted polygons by the IoU</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="point-cloud-classification-1.html#cb223-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb223-2"><a href="point-cloud-classification-1.html#cb223-2" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb223-3"><a href="point-cloud-classification-1.html#cb223-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb223-4"><a href="point-cloud-classification-1.html#cb223-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb223-5"><a href="point-cloud-classification-1.html#cb223-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb223-6"><a href="point-cloud-classification-1.html#cb223-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb223-7"><a href="point-cloud-classification-1.html#cb223-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(watershed_circle_fit_iou, <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span>)</span>
<span id="cb223-8"><a href="point-cloud-classification-1.html#cb223-8" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> iou)</span>
<span id="cb223-9"><a href="point-cloud-classification-1.html#cb223-9" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb223-10"><a href="point-cloud-classification-1.html#cb223-10" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb223-11"><a href="point-cloud-classification-1.html#cb223-11" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb223-12"><a href="point-cloud-classification-1.html#cb223-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-13"><a href="point-cloud-classification-1.html#cb223-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb223-14"><a href="point-cloud-classification-1.html#cb223-14" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb223-15"><a href="point-cloud-classification-1.html#cb223-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb223-16"><a href="point-cloud-classification-1.html#cb223-16" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb223-17"><a href="point-cloud-classification-1.html#cb223-17" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span></span>
<span id="cb223-18"><a href="point-cloud-classification-1.html#cb223-18" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb223-19"><a href="point-cloud-classification-1.html#cb223-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-20"><a href="point-cloud-classification-1.html#cb223-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb223-21"><a href="point-cloud-classification-1.html#cb223-21" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb223-22"><a href="point-cloud-classification-1.html#cb223-22" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb223-23"><a href="point-cloud-classification-1.html#cb223-23" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb223-24"><a href="point-cloud-classification-1.html#cb223-24" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb223-25"><a href="point-cloud-classification-1.html#cb223-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-26"><a href="point-cloud-classification-1.html#cb223-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_fermenter</span>(</span>
<span id="cb223-27"><a href="point-cloud-classification-1.html#cb223-27" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">10</span> <span class="co"># 10 use 10 if can go full range 0-1</span></span>
<span id="cb223-28"><a href="point-cloud-classification-1.html#cb223-28" tabindex="-1"></a>    , <span class="at">palette =</span> <span class="st">&quot;PuOr&quot;</span> <span class="co"># &quot;BrBG&quot;</span></span>
<span id="cb223-29"><a href="point-cloud-classification-1.html#cb223-29" tabindex="-1"></a>    , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb223-30"><a href="point-cloud-classification-1.html#cb223-30" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># use c(0,1) if can go full range 0-1</span></span>
<span id="cb223-31"><a href="point-cloud-classification-1.html#cb223-31" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb223-32"><a href="point-cloud-classification-1.html#cb223-32" tabindex="-1"></a>    , <span class="at">na.value =</span> <span class="st">&quot;sienna4&quot;</span></span>
<span id="cb223-33"><a href="point-cloud-classification-1.html#cb223-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb223-34"><a href="point-cloud-classification-1.html#cb223-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb223-35"><a href="point-cloud-classification-1.html#cb223-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb223-36"><a href="point-cloud-classification-1.html#cb223-36" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb223-37"><a href="point-cloud-classification-1.html#cb223-37" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb223-38"><a href="point-cloud-classification-1.html#cb223-38" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-191-1.png" width="1008" /></p>
<p>we’ll set a threshold for the minimum IoU to further filter for segments that are approximately round, this filter should remove linear objects from the watershed detections</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="point-cloud-classification-1.html#cb224-1" tabindex="-1"></a><span class="co"># min required IoU between the predicted pile and the best fit circle of the predicted pile</span></span>
<span id="cb224-2"><a href="point-cloud-classification-1.html#cb224-2" tabindex="-1"></a>pct_iou_circle_fit <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb224-3"><a href="point-cloud-classification-1.html#cb224-3" tabindex="-1"></a><span class="co"># compare iou</span></span>
<span id="cb224-4"><a href="point-cloud-classification-1.html#cb224-4" tabindex="-1"></a>watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb224-5"><a href="point-cloud-classification-1.html#cb224-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(iou<span class="sc">&gt;=</span>pct_iou_circle_fit) <span class="sc">%&gt;%</span> </span>
<span id="cb224-6"><a href="point-cloud-classification-1.html#cb224-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span></code></pre></div>
<p>let’s check out the remaining watershed detected piles after filtering out the irregularly shaped segments (filtered using the convex hull) and filtering out the non-circular segments (filtered using circle fitting)</p>
<p>example of filtered watershed detected segments as vectors (pink) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="point-cloud-classification-1.html#cb225-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb225-2"><a href="point-cloud-classification-1.html#cb225-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb225-3"><a href="point-cloud-classification-1.html#cb225-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb225-4"><a href="point-cloud-classification-1.html#cb225-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb225-5"><a href="point-cloud-classification-1.html#cb225-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb225-6"><a href="point-cloud-classification-1.html#cb225-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb225-7"><a href="point-cloud-classification-1.html#cb225-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb225-8"><a href="point-cloud-classification-1.html#cb225-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb225-9"><a href="point-cloud-classification-1.html#cb225-9" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb225-10"><a href="point-cloud-classification-1.html#cb225-10" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb225-11"><a href="point-cloud-classification-1.html#cb225-11" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb225-12"><a href="point-cloud-classification-1.html#cb225-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb225-13"><a href="point-cloud-classification-1.html#cb225-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb225-14"><a href="point-cloud-classification-1.html#cb225-14" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb225-15"><a href="point-cloud-classification-1.html#cb225-15" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb225-16"><a href="point-cloud-classification-1.html#cb225-16" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb225-17"><a href="point-cloud-classification-1.html#cb225-17" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb225-18"><a href="point-cloud-classification-1.html#cb225-18" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb225-19"><a href="point-cloud-classification-1.html#cb225-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-193-1.png" width="1008" /></p>
<p>save this filtered data as our predictions</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="point-cloud-classification-1.html#cb226-1" tabindex="-1"></a><span class="co"># save this filtered data as our predictions</span></span>
<span id="cb226-2"><a href="point-cloud-classification-1.html#cb226-2" tabindex="-1"></a>predicted_watershed_piles_sf <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb226-3"><a href="point-cloud-classification-1.html#cb226-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb226-4"><a href="point-cloud-classification-1.html#cb226-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id)</span></code></pre></div>
<p>that looks like it did what we wanted it to do (filter out segments that are non-circular)</p>
<p>let’s look at the entire area again after applying this filter plotting the remaining watershed segmented piles (orange) and the actual piles (white)</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="point-cloud-classification-1.html#cb227-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb227-2"><a href="point-cloud-classification-1.html#cb227-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb227-3"><a href="point-cloud-classification-1.html#cb227-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb227-4"><a href="point-cloud-classification-1.html#cb227-4" tabindex="-1"></a>  predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb227-5"><a href="point-cloud-classification-1.html#cb227-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb227-6"><a href="point-cloud-classification-1.html#cb227-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb227-7"><a href="point-cloud-classification-1.html#cb227-7" tabindex="-1"></a>)</span>
<span id="cb227-8"><a href="point-cloud-classification-1.html#cb227-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb227-9"><a href="point-cloud-classification-1.html#cb227-9" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb227-10"><a href="point-cloud-classification-1.html#cb227-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb227-11"><a href="point-cloud-classification-1.html#cb227-11" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb227-12"><a href="point-cloud-classification-1.html#cb227-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-195-1.png" width="1008" /></p>
<p>nice! let’s save these data</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="point-cloud-classification-1.html#cb228-1" tabindex="-1"></a>predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb228-2"><a href="point-cloud-classification-1.html#cb228-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="st">&quot;../data/predicted_watershed_piles_sf.gpkg&quot;</span>, <span class="at">append =</span> F)</span></code></pre></div>
<pre><code>## Deleting layer `predicted_watershed_piles_sf&#39; using driver `GPKG&#39;
## Writing layer `predicted_watershed_piles_sf&#39; to data source 
##   `../data/predicted_watershed_piles_sf.gpkg&#39; using driver `GPKG&#39;
## Writing 342 features with 1 fields and geometry type Unknown (any).</code></pre>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="point-cloud-classification-1.html#cb230-1" tabindex="-1"></a>watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb230-2"><a href="point-cloud-classification-1.html#cb230-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="st">&quot;../data/watershed_ans_poly.gpkg&quot;</span>, <span class="at">append =</span> F)</span></code></pre></div>
<pre><code>## Deleting layer `watershed_ans_poly&#39; using driver `GPKG&#39;
## Writing layer `watershed_ans_poly&#39; to data source 
##   `../data/watershed_ans_poly.gpkg&#39; using driver `GPKG&#39;
## Writing 786 features with 1 fields and geometry type Unknown (any).</code></pre>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="point-cloud-classification-1.html#cb232-1" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb232-2"><a href="point-cloud-classification-1.html#cb232-2" tabindex="-1"></a>watershed_ans_poly <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;../data/watershed_ans_poly.gpkg&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `watershed_ans_poly&#39; from data source 
##   `C:\Data\usfs\manitou_slash_piles\data\watershed_ans_poly.gpkg&#39; 
##   using driver `GPKG&#39;
## Simple feature collection with 786 features and 1 field
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 499276.5 ymin: 4317605 xmax: 499954 ymax: 4318140
## Projected CRS: WGS 84 / UTM zone 13N</code></pre>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="point-cloud-classification-1.html#cb234-1" tabindex="-1"></a>watershed_ans_poly_chull <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb234-2"><a href="point-cloud-classification-1.html#cb234-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb234-3"><a href="point-cloud-classification-1.html#cb234-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb234-4"><a href="point-cloud-classification-1.html#cb234-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb234-5"><a href="point-cloud-classification-1.html#cb234-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span></code></pre></div>
<div id="matching-process" class="section level5 hasAnchor" number="5.2.1.1.1">
<h5><span class="header-section-number">5.2.1.1.1</span> Matching process<a href="point-cloud-classification-1.html#matching-process" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We didn’t “train” any model here, just developed a rules-based method for detecting piles from aerial point cloud data. As such, we can evaluate the methods performance on the “full” set of ground truth pile data.</p>
<p>let’s see how we did given the list of predictions compared to the ground truth data using the confusion matrix matching process we outlined in this <a href="rgb-classification.html#iou_match">earlier section</a>.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="point-cloud-classification-1.html#cb235-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb235-2"><a href="point-cloud-classification-1.html#cb235-2" tabindex="-1"></a>  <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb235-3"><a href="point-cloud-classification-1.html#cb235-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb235-4"><a href="point-cloud-classification-1.html#cb235-4" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_watershed_piles_sf))</span>
<span id="cb235-5"><a href="point-cloud-classification-1.html#cb235-5" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb235-6"><a href="point-cloud-classification-1.html#cb235-6" tabindex="-1"></a>  , <span class="at">predictions =</span> predicted_watershed_piles_sf</span>
<span id="cb235-7"><a href="point-cloud-classification-1.html#cb235-7" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb235-8"><a href="point-cloud-classification-1.html#cb235-8" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb235-9"><a href="point-cloud-classification-1.html#cb235-9" tabindex="-1"></a>)</span></code></pre></div>
<p>how did our predictions do for this particular example?</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="point-cloud-classification-1.html#cb236-1" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb236-2"><a href="point-cloud-classification-1.html#cb236-2" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb236-3"><a href="point-cloud-classification-1.html#cb236-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb236-4"><a href="point-cloud-classification-1.html#cb236-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> (n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy=</span><span class="fl">0.1</span>))</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   match_grp         n pct  
##   &lt;ord&gt;         &lt;int&gt; &lt;chr&gt;
## 1 omission         21 5.8% 
## 2 commission      180 49.6%
## 3 true positive   162 44.6%</code></pre>
<p>let’s look at that spatially</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="point-cloud-classification-1.html#cb238-1" tabindex="-1"></a>pal_match_grp <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb238-2"><a href="point-cloud-classification-1.html#cb238-2" tabindex="-1"></a>  <span class="st">&quot;omission&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">1</span>]</span>
<span id="cb238-3"><a href="point-cloud-classification-1.html#cb238-3" tabindex="-1"></a>  , <span class="st">&quot;commission&quot;</span><span class="ot">=</span> <span class="st">&quot;black&quot;</span> <span class="co">#viridis::cividis(3)[2]</span></span>
<span id="cb238-4"><a href="point-cloud-classification-1.html#cb238-4" tabindex="-1"></a>  , <span class="st">&quot;true positive&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">3</span>]</span>
<span id="cb238-5"><a href="point-cloud-classification-1.html#cb238-5" tabindex="-1"></a>)</span>
<span id="cb238-6"><a href="point-cloud-classification-1.html#cb238-6" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb238-7"><a href="point-cloud-classification-1.html#cb238-7" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb238-8"><a href="point-cloud-classification-1.html#cb238-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb238-9"><a href="point-cloud-classification-1.html#cb238-9" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb238-10"><a href="point-cloud-classification-1.html#cb238-10" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb238-11"><a href="point-cloud-classification-1.html#cb238-11" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly_chull)) <span class="sc">%&gt;%</span> </span>
<span id="cb238-12"><a href="point-cloud-classification-1.html#cb238-12" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb238-13"><a href="point-cloud-classification-1.html#cb238-13" tabindex="-1"></a>          ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb238-14"><a href="point-cloud-classification-1.html#cb238-14" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb238-15"><a href="point-cloud-classification-1.html#cb238-15" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb238-16"><a href="point-cloud-classification-1.html#cb238-16" tabindex="-1"></a>        )</span>
<span id="cb238-17"><a href="point-cloud-classification-1.html#cb238-17" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb238-18"><a href="point-cloud-classification-1.html#cb238-18" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.7</span></span>
<span id="cb238-19"><a href="point-cloud-classification-1.html#cb238-19" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb238-20"><a href="point-cloud-classification-1.html#cb238-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb238-21"><a href="point-cloud-classification-1.html#cb238-21" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb238-22"><a href="point-cloud-classification-1.html#cb238-22" tabindex="-1"></a>      watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb238-23"><a href="point-cloud-classification-1.html#cb238-23" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb238-24"><a href="point-cloud-classification-1.html#cb238-24" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb238-25"><a href="point-cloud-classification-1.html#cb238-25" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb238-26"><a href="point-cloud-classification-1.html#cb238-26" tabindex="-1"></a>          ground_truth_prediction_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb238-27"><a href="point-cloud-classification-1.html#cb238-27" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb238-28"><a href="point-cloud-classification-1.html#cb238-28" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb238-29"><a href="point-cloud-classification-1.html#cb238-29" tabindex="-1"></a>        )</span>
<span id="cb238-30"><a href="point-cloud-classification-1.html#cb238-30" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb238-31"><a href="point-cloud-classification-1.html#cb238-31" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb238-32"><a href="point-cloud-classification-1.html#cb238-32" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.1</span></span>
<span id="cb238-33"><a href="point-cloud-classification-1.html#cb238-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb238-34"><a href="point-cloud-classification-1.html#cb238-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb238-35"><a href="point-cloud-classification-1.html#cb238-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb238-36"><a href="point-cloud-classification-1.html#cb238-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb238-37"><a href="point-cloud-classification-1.html#cb238-37" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb238-38"><a href="point-cloud-classification-1.html#cb238-38" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,pal_match_grp[<span class="st">&quot;commission&quot;</span>])))</span>
<span id="cb238-39"><a href="point-cloud-classification-1.html#cb238-39" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb238-40"><a href="point-cloud-classification-1.html#cb238-40" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-199-1.png" width="1008" /></p>
<p>let’s quickly look at the IoU values on the true positives</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="point-cloud-classification-1.html#cb239-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(iou) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##       iou        
##  Min.   :0.1475  
##  1st Qu.:0.2908  
##  Median :0.3662  
##  Mean   :0.3718  
##  3rd Qu.:0.4418  
##  Max.   :0.6646  
##  NA&#39;s   :201</code></pre>
<p>let’s make a function to aggregate the instances to pass to the xxxx function we defined above</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="point-cloud-classification-1.html#cb241-1" tabindex="-1"></a>agg_ground_truth_match <span class="ot">&lt;-</span> <span class="cf">function</span>(ground_truth_prediction_match_ans) {</span>
<span id="cb241-2"><a href="point-cloud-classification-1.html#cb241-2" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(ground_truth_prediction_match_ans)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb241-3"><a href="point-cloud-classification-1.html#cb241-3" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(ground_truth_prediction_match_ans) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){<span class="fu">stop</span>(<span class="st">&quot;ground_truth_prediction_match_ans must contain `match_grp` column&quot;</span>)}</span>
<span id="cb241-4"><a href="point-cloud-classification-1.html#cb241-4" tabindex="-1"></a>  <span class="co"># count by match group</span></span>
<span id="cb241-5"><a href="point-cloud-classification-1.html#cb241-5" tabindex="-1"></a>  agg <span class="ot">&lt;-</span> ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb241-6"><a href="point-cloud-classification-1.html#cb241-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb241-7"><a href="point-cloud-classification-1.html#cb241-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb241-8"><a href="point-cloud-classification-1.html#cb241-8" tabindex="-1"></a>      <span class="at">match_grp =</span> dplyr<span class="sc">::</span><span class="fu">case_match</span>(</span>
<span id="cb241-9"><a href="point-cloud-classification-1.html#cb241-9" tabindex="-1"></a>        match_grp</span>
<span id="cb241-10"><a href="point-cloud-classification-1.html#cb241-10" tabindex="-1"></a>        , <span class="st">&quot;true positive&quot;</span><span class="sc">~</span><span class="st">&quot;tp&quot;</span></span>
<span id="cb241-11"><a href="point-cloud-classification-1.html#cb241-11" tabindex="-1"></a>        , <span class="st">&quot;commission&quot;</span><span class="sc">~</span><span class="st">&quot;fp&quot;</span></span>
<span id="cb241-12"><a href="point-cloud-classification-1.html#cb241-12" tabindex="-1"></a>        , <span class="st">&quot;omission&quot;</span><span class="sc">~</span><span class="st">&quot;fn&quot;</span></span>
<span id="cb241-13"><a href="point-cloud-classification-1.html#cb241-13" tabindex="-1"></a>      )</span>
<span id="cb241-14"><a href="point-cloud-classification-1.html#cb241-14" tabindex="-1"></a>    )</span>
<span id="cb241-15"><a href="point-cloud-classification-1.html#cb241-15" tabindex="-1"></a>  <span class="co"># true positive, false positive, false negative rates</span></span>
<span id="cb241-16"><a href="point-cloud-classification-1.html#cb241-16" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">match_grp =</span> <span class="fu">c</span>(<span class="st">&quot;tp&quot;</span>,<span class="st">&quot;fp&quot;</span>,<span class="st">&quot;fn&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb241-17"><a href="point-cloud-classification-1.html#cb241-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(agg, <span class="at">by =</span> <span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb241-18"><a href="point-cloud-classification-1.html#cb241-18" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(n), <span class="at">.fn =</span> <span class="sc">~</span>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(.x,<span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb241-19"><a href="point-cloud-classification-1.html#cb241-19" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb241-20"><a href="point-cloud-classification-1.html#cb241-20" tabindex="-1"></a>      <span class="at">names_from =</span> match_grp</span>
<span id="cb241-21"><a href="point-cloud-classification-1.html#cb241-21" tabindex="-1"></a>      , <span class="at">values_from =</span> <span class="fu">c</span>(n)</span>
<span id="cb241-22"><a href="point-cloud-classification-1.html#cb241-22" tabindex="-1"></a>      , <span class="at">names_glue =</span> <span class="st">&quot;{match_grp}_{.value}&quot;</span></span>
<span id="cb241-23"><a href="point-cloud-classification-1.html#cb241-23" tabindex="-1"></a>    )</span>
<span id="cb241-24"><a href="point-cloud-classification-1.html#cb241-24" tabindex="-1"></a>  <span class="co"># rates, precision, recall, f-score</span></span>
<span id="cb241-25"><a href="point-cloud-classification-1.html#cb241-25" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> <span class="fu">confusion_matrix_scores_fn</span>()</span>
<span id="cb241-26"><a href="point-cloud-classification-1.html#cb241-26" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb241-27"><a href="point-cloud-classification-1.html#cb241-27" tabindex="-1"></a>  <span class="fu">return</span>(return_df)</span>
<span id="cb241-28"><a href="point-cloud-classification-1.html#cb241-28" tabindex="-1"></a>}</span></code></pre></div>
<p>finally, let’s check our confusion matrix</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="point-cloud-classification-1.html#cb242-1" tabindex="-1"></a>confusion_matrix_temp <span class="ot">&lt;-</span> <span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans)</span>
<span id="cb242-2"><a href="point-cloud-classification-1.html#cb242-2" tabindex="-1"></a>confusion_matrix_scores_temp <span class="ot">&lt;-</span> <span class="fu">confusion_matrix_scores_fn</span>(confusion_matrix_temp)</span>
<span id="cb242-3"><a href="point-cloud-classification-1.html#cb242-3" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb242-4"><a href="point-cloud-classification-1.html#cb242-4" tabindex="-1"></a>confusion_matrix_temp <span class="sc">%&gt;%</span> </span>
<span id="cb242-5"><a href="point-cloud-classification-1.html#cb242-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_n&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb242-6"><a href="point-cloud-classification-1.html#cb242-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb242-7"><a href="point-cloud-classification-1.html#cb242-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb242-8"><a href="point-cloud-classification-1.html#cb242-8" tabindex="-1"></a>    <span class="at">presence =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fn_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb242-9"><a href="point-cloud-classification-1.html#cb242-9" tabindex="-1"></a>    , <span class="at">estimate =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fp_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb242-10"><a href="point-cloud-classification-1.html#cb242-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb242-11"><a href="point-cloud-classification-1.html#cb242-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb242-12"><a href="point-cloud-classification-1.html#cb242-12" tabindex="-1"></a>    <span class="at">is_false =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(presence<span class="sc">!=</span>estimate,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb242-13"><a href="point-cloud-classification-1.html#cb242-13" tabindex="-1"></a>    , <span class="at">presence_fact =</span> <span class="fu">factor</span>(presence,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed Absent&quot;</span>, <span class="st">&quot;Observed Present&quot;</span>))</span>
<span id="cb242-14"><a href="point-cloud-classification-1.html#cb242-14" tabindex="-1"></a>    , <span class="at">estimate_fact =</span> <span class="fu">factor</span>(estimate,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Predicted Absent&quot;</span>, <span class="st">&quot;Predicted Present&quot;</span>))</span>
<span id="cb242-15"><a href="point-cloud-classification-1.html#cb242-15" tabindex="-1"></a>    , <span class="at">pct =</span> value<span class="sc">/</span><span class="fu">sum</span>(value)</span>
<span id="cb242-16"><a href="point-cloud-classification-1.html#cb242-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb242-17"><a href="point-cloud-classification-1.html#cb242-17" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> estimate_fact, <span class="at">x =</span> presence_fact)) <span class="sc">+</span></span>
<span id="cb242-18"><a href="point-cloud-classification-1.html#cb242-18" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> is_false), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>,<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb242-19"><a href="point-cloud-classification-1.html#cb242-19" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)), <span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb242-20"><a href="point-cloud-classification-1.html#cb242-20" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)), <span class="at">vjust =</span> <span class="fl">3.5</span>, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb242-21"><a href="point-cloud-classification-1.html#cb242-21" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;turquoise&quot;</span>,<span class="st">&quot;tomato2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb242-22"><a href="point-cloud-classification-1.html#cb242-22" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb242-23"><a href="point-cloud-classification-1.html#cb242-23" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb242-24"><a href="point-cloud-classification-1.html#cb242-24" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Predicted&quot;</span></span>
<span id="cb242-25"><a href="point-cloud-classification-1.html#cb242-25" tabindex="-1"></a>    , <span class="at">x =</span> <span class="st">&quot;Observed&quot;</span></span>
<span id="cb242-26"><a href="point-cloud-classification-1.html#cb242-26" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb242-27"><a href="point-cloud-classification-1.html#cb242-27" tabindex="-1"></a>      <span class="st">&quot;True positive rate (recall) = &quot;</span></span>
<span id="cb242-28"><a href="point-cloud-classification-1.html#cb242-28" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>recall <span class="sc">%&gt;%</span> </span>
<span id="cb242-29"><a href="point-cloud-classification-1.html#cb242-29" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb242-30"><a href="point-cloud-classification-1.html#cb242-30" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Precision (PPV) = &quot;</span></span>
<span id="cb242-31"><a href="point-cloud-classification-1.html#cb242-31" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>precision <span class="sc">%&gt;%</span> </span>
<span id="cb242-32"><a href="point-cloud-classification-1.html#cb242-32" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb242-33"><a href="point-cloud-classification-1.html#cb242-33" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">F1-score = &quot;</span></span>
<span id="cb242-34"><a href="point-cloud-classification-1.html#cb242-34" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>f_score <span class="sc">%&gt;%</span> </span>
<span id="cb242-35"><a href="point-cloud-classification-1.html#cb242-35" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb242-36"><a href="point-cloud-classification-1.html#cb242-36" tabindex="-1"></a>    )</span>
<span id="cb242-37"><a href="point-cloud-classification-1.html#cb242-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb242-38"><a href="point-cloud-classification-1.html#cb242-38" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb242-39"><a href="point-cloud-classification-1.html#cb242-39" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb242-40"><a href="point-cloud-classification-1.html#cb242-40" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb242-41"><a href="point-cloud-classification-1.html#cb242-41" tabindex="-1"></a>    , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb242-42"><a href="point-cloud-classification-1.html#cb242-42" tabindex="-1"></a>    , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb242-43"><a href="point-cloud-classification-1.html#cb242-43" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb242-44"><a href="point-cloud-classification-1.html#cb242-44" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-202-1.png" width="1008" /></p>

</div>
</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="point-cloud-classification.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
