<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 4 Point Cloud Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 4 Point Cloud Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 4 Point Cloud Classification | Aerial Imagery and Point Cloud Data for Slash Pile Quantification" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="rgb-classification.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-processing.html"><a href="data-processing.html"><i class="fa fa-check"></i><b>2</b> Data Processing</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-processing.html"><a href="data-processing.html#slash-pile-vector-data"><i class="fa fa-check"></i><b>2.1</b> Slash Pile Vector Data</a></li>
<li class="chapter" data-level="2.2" data-path="data-processing.html"><a href="data-processing.html#load-rgb-orthomosaic-rasters"><i class="fa fa-check"></i><b>2.2</b> Load RGB orthomosaic rasters</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data-processing.html"><a href="data-processing.html#example-ratio-based-index"><i class="fa fa-check"></i><b>2.2.1</b> Example ratio-based index</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="data-processing.html"><a href="data-processing.html#study-area-imagery"><i class="fa fa-check"></i><b>2.3</b> Study area imagery</a></li>
<li class="chapter" data-level="2.4" data-path="data-processing.html"><a href="data-processing.html#point-cloud-data"><i class="fa fa-check"></i><b>2.4</b> Point Cloud Data</a></li>
<li class="chapter" data-level="2.5" data-path="data-processing.html"><a href="data-processing.html#check-out-one-pile"><i class="fa fa-check"></i><b>2.5</b> Check out one pile</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="rgb-classification.html"><a href="rgb-classification.html"><i class="fa fa-check"></i><b>3</b> RGB Classification</a>
<ul>
<li class="chapter" data-level="3.1" data-path="rgb-classification.html"><a href="rgb-classification.html#textural-covariates"><i class="fa fa-check"></i><b>3.1</b> Textural covariates</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-panchromatic"><i class="fa fa-check"></i><b>3.1.1</b> Raster Texture: Panchromatic</a></li>
<li class="chapter" data-level="3.1.2" data-path="rgb-classification.html"><a href="rgb-classification.html#raster-texture-grvi"><i class="fa fa-check"></i><b>3.1.2</b> Raster Texture: GRVI</a></li>
<li class="chapter" data-level="3.1.3" data-path="rgb-classification.html"><a href="rgb-classification.html#plot-textural-rasters"><i class="fa fa-check"></i><b>3.1.3</b> Plot textural rasters</a></li>
<li class="chapter" data-level="3.1.4" data-path="rgb-classification.html"><a href="rgb-classification.html#features-for-classification"><i class="fa fa-check"></i><b>3.1.4</b> Features for classification</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel-based-unsupervised-classification"><i class="fa fa-check"></i><b>3.2</b> Pixel-based: unsupervised classification</a></li>
<li class="chapter" data-level="3.3" data-path="rgb-classification.html"><a href="rgb-classification.html#pixel_class"><i class="fa fa-check"></i><b>3.3</b> Pixel-based: supervised classification</a></li>
<li class="chapter" data-level="3.4" data-path="rgb-classification.html"><a href="rgb-classification.html#obia"><i class="fa fa-check"></i><b>3.4</b> Object-based image analysis (OBIA)</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="rgb-classification.html"><a href="rgb-classification.html#training-data"><i class="fa fa-check"></i><b>3.4.1</b> Training data</a></li>
<li class="chapter" data-level="3.4.2" data-path="rgb-classification.html"><a href="rgb-classification.html#slic"><i class="fa fa-check"></i><b>3.4.2</b> <code>OpenImageR</code> package SLIC image segmentation</a></li>
<li class="chapter" data-level="3.4.3" data-path="rgb-classification.html"><a href="rgb-classification.html#superpixelimagesegmentation-package-slicap-clustering"><i class="fa fa-check"></i><b>3.4.3</b> <code>SuperpixelImageSegmentation</code> package SLICAP clustering</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html"><i class="fa fa-check"></i><b>4</b> Point Cloud Classification</a>
<ul>
<li class="chapter" data-level="4.1" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#process-raw-point-cloud"><i class="fa fa-check"></i><b>4.1</b> Process Raw Point Cloud</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#dtm-and-chm-piles"><i class="fa fa-check"></i><b>4.1.1</b> DTM and CHM + piles</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#raster-based-approaches"><i class="fa fa-check"></i><b>4.2</b> Raster-based approaches</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#watershed-segmentation"><i class="fa fa-check"></i><b>4.2.1</b> Watershed Segmentation</a></li>
<li class="chapter" data-level="4.2.2" data-path="point-cloud-classification.html"><a href="point-cloud-classification.html#watershed-segmentation-sensitivity"><i class="fa fa-check"></i><b>4.2.2</b> Watershed Segmentation Sensitivity</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial Imagery and Point Cloud Data for Slash Pile Quantification</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="point-cloud-classification" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Section 4</span> Point Cloud Classification<a href="point-cloud-classification.html#point-cloud-classification" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We’ll use the point cloud data alone (to begin with) to attempt to classify slash piles without additional spectral information.</p>
<p>We’ll use the <code>cloud2trees</code> package to perform all preprocessing of point cloud data which includes:</p>
<ul>
<li>ground classification and noise removal</li>
<li>raster data (DTM and CHM) generation</li>
<li>point cloud height normalization</li>
</ul>
<p>All of this can be accomplished using the <code>cloud2raster()</code> function. After generating these products from the raw point cloud we’ll perform object segmentation to attempt to detect round, conical objects like slash piles from: 1) the normalized point cloud directly; 2) the CHM which we’ll generate by setting the minimum height to zero to effectively create a digital surface model (DSM).</p>
<p>To attempt to detect slash piles directly from the point cloud we can use a clustering algorithm such as DBSCAN (Density-Based Spatial Clustering of Applications with Noise) which identifies clusters based on point density, making it effective for detecting clusters of arbitrary shapes and sizes. It does not require the number of clusters to be specified beforehand. Insert something from TLS paper that used DBSCAN in semi-automated way….xxxxx. After segmenting the point cloud using DBSCAN, random forest can be used as a classifier (i.e. classification step) to distinguish slash piles from other objects based on their extracted geometric features. The general workflow is:</p>
<ol style="list-style-type: decimal">
<li>for each point in the normalized non-ground point cloud, compute a suite of relevant geometric features within a defined local neighborhood radius using <code>lidR::point_metrics()</code></li>
<li>calculate features derived from PCA, such as linearity, planarity, sphericity, and surface variation. Also, compute curvature (mean, Gaussian) and roughness</li>
<li>perform object segmentation/clustering to group points belonging to individual objects using DBSCAN which can identify dense clusters without requiring a predefined number of objects</li>
<li>classify the segmented objects (clusters) as “slash pile” or “non-slash pile” based on their extracted features (e.g., sphericity, roughness, height, volume) with a random forest classifier using a manually annotated subset of segmented objects</li>
<li>merge small, adjacent segments that likely belong to a single slash pile based on proximity and connectivity</li>
<li>perform a confusion matrix-based evaluation on the results</li>
</ol>
<p>To attempt to identify slash piles from the CHM/DSM, we can use watershed segmentation (potentially without “seed” points) in a bottom-up approach. Insert something from paper about bottom-up approach that uses a CHM “slice” near the ground…xxxxx. For slash piles, which are often irregular and may not have a distinct “treetop” equivalent, CHM-based methods might be less directly applicable unless the piles present a very clear, isolated conical or rounded form. Could use expected morphology of the slash piles (e.g. maximum height) based on prior research.</p>
<div id="process-raw-point-cloud" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Process Raw Point Cloud<a href="point-cloud-classification.html#process-raw-point-cloud" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll use <code>cloud2trees::cloud2raster()</code> to process the raw point cloud data</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="point-cloud-classification.html#cb140-1" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">&quot;../data/point_cloud_processing_delivery&quot;</span>)){</span>
<span id="cb140-2"><a href="point-cloud-classification.html#cb140-2" tabindex="-1"></a>  cloud2raster_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2raster</span>(</span>
<span id="cb140-3"><a href="point-cloud-classification.html#cb140-3" tabindex="-1"></a>    <span class="at">output_dir =</span> <span class="st">&quot;../data&quot;</span></span>
<span id="cb140-4"><a href="point-cloud-classification.html#cb140-4" tabindex="-1"></a>    , <span class="at">input_las_dir =</span> <span class="st">&quot;f:</span><span class="sc">\\</span><span class="st">PFDP_Data</span><span class="sc">\\</span><span class="st">p4pro_images</span><span class="sc">\\</span><span class="st">P4Pro_06_17_2021_half_half_optimal</span><span class="sc">\\</span><span class="st">2_densification</span><span class="sc">\\</span><span class="st">point_cloud&quot;</span></span>
<span id="cb140-5"><a href="point-cloud-classification.html#cb140-5" tabindex="-1"></a>    , <span class="at">accuracy_level =</span> <span class="dv">2</span></span>
<span id="cb140-6"><a href="point-cloud-classification.html#cb140-6" tabindex="-1"></a>    , <span class="at">keep_intrmdt =</span> T</span>
<span id="cb140-7"><a href="point-cloud-classification.html#cb140-7" tabindex="-1"></a>    , <span class="at">dtm_res_m =</span> <span class="fl">0.25</span></span>
<span id="cb140-8"><a href="point-cloud-classification.html#cb140-8" tabindex="-1"></a>    , <span class="at">chm_res_m =</span> <span class="fl">0.1</span></span>
<span id="cb140-9"><a href="point-cloud-classification.html#cb140-9" tabindex="-1"></a>    , <span class="at">min_height =</span> <span class="dv">0</span> <span class="co"># effectively generates a DSM based on non-ground points</span></span>
<span id="cb140-10"><a href="point-cloud-classification.html#cb140-10" tabindex="-1"></a>  )</span>
<span id="cb140-11"><a href="point-cloud-classification.html#cb140-11" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb140-12"><a href="point-cloud-classification.html#cb140-12" tabindex="-1"></a>  <span class="co"># dtm_temp &lt;- terra::rast(&quot;../data/point_cloud_processing_delivery/dtm_0.25m.tif&quot;)</span></span>
<span id="cb140-13"><a href="point-cloud-classification.html#cb140-13" tabindex="-1"></a>  <span class="co"># chm_temp &lt;- terra::rast(&quot;../data/point_cloud_processing_delivery/chm_0.1m.tif&quot;)</span></span>
<span id="cb140-14"><a href="point-cloud-classification.html#cb140-14" tabindex="-1"></a>  </span>
<span id="cb140-15"><a href="point-cloud-classification.html#cb140-15" tabindex="-1"></a>  dtm_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="st">&quot;../data/xxpoint_cloud_processing_delivery/dtm_0.5m.tif&quot;</span>)</span>
<span id="cb140-16"><a href="point-cloud-classification.html#cb140-16" tabindex="-1"></a>  chm_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="st">&quot;../data/xxpoint_cloud_processing_delivery/chm_0.2m.tif&quot;</span>)</span>
<span id="cb140-17"><a href="point-cloud-classification.html#cb140-17" tabindex="-1"></a>  </span>
<span id="cb140-18"><a href="point-cloud-classification.html#cb140-18" tabindex="-1"></a>  cloud2raster_ans <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb140-19"><a href="point-cloud-classification.html#cb140-19" tabindex="-1"></a>    <span class="st">&quot;dtm_rast&quot;</span> <span class="ot">=</span> dtm_temp</span>
<span id="cb140-20"><a href="point-cloud-classification.html#cb140-20" tabindex="-1"></a>    , <span class="st">&quot;chm_rast&quot;</span> <span class="ot">=</span> chm_temp</span>
<span id="cb140-21"><a href="point-cloud-classification.html#cb140-21" tabindex="-1"></a>  )</span>
<span id="cb140-22"><a href="point-cloud-classification.html#cb140-22" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s check out the DTM</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="point-cloud-classification.html#cb141-1" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>dtm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb141-2"><a href="point-cloud-classification.html#cb141-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co">#, fun = &quot;median&quot;, cores = lasR::half_cores(), na.rm = T) %&gt;% </span></span>
<span id="cb141-3"><a href="point-cloud-classification.html#cb141-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">axes =</span> F)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-121-1.png" width="1008" /></p>
<p>and CHM</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="point-cloud-classification.html#cb142-1" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb142-2"><a href="point-cloud-classification.html#cb142-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co">#, fun = &quot;median&quot;, cores = lasR::half_cores(), na.rm = T) %&gt;% </span></span>
<span id="cb142-3"><a href="point-cloud-classification.html#cb142-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span></code></pre></div>
<pre><code>## |---------|---------|---------|---------|=========================================                                          </code></pre>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-123-1.png" width="1008" /></p>
<div id="dtm-and-chm-piles" class="section level3 hasAnchor" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> DTM and CHM + piles<a href="point-cloud-classification.html#dtm-and-chm-piles" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s visually inspect the DTM and CHM with the pile outlines overlaid</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="point-cloud-classification.html#cb144-1" tabindex="-1"></a>p_fn_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb144-2"><a href="point-cloud-classification.html#cb144-2" tabindex="-1"></a>    rn</span>
<span id="cb144-3"><a href="point-cloud-classification.html#cb144-3" tabindex="-1"></a>    , <span class="at">df =</span> slash_piles_polys</span>
<span id="cb144-4"><a href="point-cloud-classification.html#cb144-4" tabindex="-1"></a>    , <span class="at">rast =</span> cloud2raster_ans<span class="sc">$</span>dtm_rast</span>
<span id="cb144-5"><a href="point-cloud-classification.html#cb144-5" tabindex="-1"></a>    , <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>dtm_rast)</span>
<span id="cb144-6"><a href="point-cloud-classification.html#cb144-6" tabindex="-1"></a>    , <span class="at">my_title =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb144-7"><a href="point-cloud-classification.html#cb144-7" tabindex="-1"></a>    , <span class="at">vopt =</span> <span class="st">&quot;viridis&quot;</span></span>
<span id="cb144-8"><a href="point-cloud-classification.html#cb144-8" tabindex="-1"></a>    , <span class="at">lim =</span> <span class="cn">NULL</span></span>
<span id="cb144-9"><a href="point-cloud-classification.html#cb144-9" tabindex="-1"></a>) {</span>
<span id="cb144-10"><a href="point-cloud-classification.html#cb144-10" tabindex="-1"></a>  <span class="co"># scale the buffer based on the largest</span></span>
<span id="cb144-11"><a href="point-cloud-classification.html#cb144-11" tabindex="-1"></a>    d_temp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb144-12"><a href="point-cloud-classification.html#cb144-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">tolower</span>(comment), <span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb144-13"><a href="point-cloud-classification.html#cb144-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(rn) <span class="sc">%&gt;%</span> </span>
<span id="cb144-14"><a href="point-cloud-classification.html#cb144-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(crs)</span>
<span id="cb144-15"><a href="point-cloud-classification.html#cb144-15" tabindex="-1"></a>    </span>
<span id="cb144-16"><a href="point-cloud-classification.html#cb144-16" tabindex="-1"></a>    <span class="co"># plt classifier</span></span>
<span id="cb144-17"><a href="point-cloud-classification.html#cb144-17" tabindex="-1"></a>    <span class="co"># convert to stars</span></span>
<span id="cb144-18"><a href="point-cloud-classification.html#cb144-18" tabindex="-1"></a>    comp_st <span class="ot">&lt;-</span> rast <span class="sc">%&gt;%</span>  </span>
<span id="cb144-19"><a href="point-cloud-classification.html#cb144-19" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb144-20"><a href="point-cloud-classification.html#cb144-20" tabindex="-1"></a>        d_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb144-21"><a href="point-cloud-classification.html#cb144-21" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb144-22"><a href="point-cloud-classification.html#cb144-22" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb144-23"><a href="point-cloud-classification.html#cb144-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb144-24"><a href="point-cloud-classification.html#cb144-24" tabindex="-1"></a>    </span>
<span id="cb144-25"><a href="point-cloud-classification.html#cb144-25" tabindex="-1"></a>    <span class="co"># ggplot</span></span>
<span id="cb144-26"><a href="point-cloud-classification.html#cb144-26" tabindex="-1"></a>    comp_temp <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb144-27"><a href="point-cloud-classification.html#cb144-27" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">data =</span> comp_st, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span>f)) <span class="sc">+</span></span>
<span id="cb144-28"><a href="point-cloud-classification.html#cb144-28" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> d_temp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;gray33&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb144-29"><a href="point-cloud-classification.html#cb144-29" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb144-30"><a href="point-cloud-classification.html#cb144-30" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb144-31"><a href="point-cloud-classification.html#cb144-31" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb144-32"><a href="point-cloud-classification.html#cb144-32" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb144-33"><a href="point-cloud-classification.html#cb144-33" tabindex="-1"></a>        , <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb144-34"><a href="point-cloud-classification.html#cb144-34" tabindex="-1"></a>        , <span class="at">subtitle =</span> my_title</span>
<span id="cb144-35"><a href="point-cloud-classification.html#cb144-35" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb144-36"><a href="point-cloud-classification.html#cb144-36" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb144-37"><a href="point-cloud-classification.html#cb144-37" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb144-38"><a href="point-cloud-classification.html#cb144-38" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span> <span class="co"># c(0.5,1)</span></span>
<span id="cb144-39"><a href="point-cloud-classification.html#cb144-39" tabindex="-1"></a>        , <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb144-40"><a href="point-cloud-classification.html#cb144-40" tabindex="-1"></a>        , <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb144-41"><a href="point-cloud-classification.html#cb144-41" tabindex="-1"></a>        , <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb144-42"><a href="point-cloud-classification.html#cb144-42" tabindex="-1"></a>        , <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb144-43"><a href="point-cloud-classification.html#cb144-43" tabindex="-1"></a>        <span class="co"># , plot.title = ggtext::element_markdown(size = 10, hjust = 0.5)</span></span>
<span id="cb144-44"><a href="point-cloud-classification.html#cb144-44" tabindex="-1"></a>        , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb144-45"><a href="point-cloud-classification.html#cb144-45" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;italic&quot;</span>)</span>
<span id="cb144-46"><a href="point-cloud-classification.html#cb144-46" tabindex="-1"></a>      )</span>
<span id="cb144-47"><a href="point-cloud-classification.html#cb144-47" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(lim)){</span>
<span id="cb144-48"><a href="point-cloud-classification.html#cb144-48" tabindex="-1"></a>    comp_temp <span class="ot">&lt;-</span> comp_temp <span class="sc">+</span> </span>
<span id="cb144-49"><a href="point-cloud-classification.html#cb144-49" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> vopt, <span class="at">limits =</span> lim)</span>
<span id="cb144-50"><a href="point-cloud-classification.html#cb144-50" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb144-51"><a href="point-cloud-classification.html#cb144-51" tabindex="-1"></a>    comp_temp <span class="ot">&lt;-</span> comp_temp <span class="sc">+</span> </span>
<span id="cb144-52"><a href="point-cloud-classification.html#cb144-52" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> vopt)</span>
<span id="cb144-53"><a href="point-cloud-classification.html#cb144-53" tabindex="-1"></a>  }</span>
<span id="cb144-54"><a href="point-cloud-classification.html#cb144-54" tabindex="-1"></a>    </span>
<span id="cb144-55"><a href="point-cloud-classification.html#cb144-55" tabindex="-1"></a>  plt_temp <span class="ot">&lt;-</span> comp_temp</span>
<span id="cb144-56"><a href="point-cloud-classification.html#cb144-56" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;plt&quot;</span><span class="ot">=</span>plt_temp,<span class="st">&quot;d&quot;</span><span class="ot">=</span>d_temp))</span>
<span id="cb144-57"><a href="point-cloud-classification.html#cb144-57" tabindex="-1"></a>}</span>
<span id="cb144-58"><a href="point-cloud-classification.html#cb144-58" tabindex="-1"></a></span>
<span id="cb144-59"><a href="point-cloud-classification.html#cb144-59" tabindex="-1"></a><span class="co"># p_fn_temp(</span></span>
<span id="cb144-60"><a href="point-cloud-classification.html#cb144-60" tabindex="-1"></a><span class="co">#   rn = 5</span></span>
<span id="cb144-61"><a href="point-cloud-classification.html#cb144-61" tabindex="-1"></a><span class="co">#   # , lim = c(floor(terra::minmax(cloud2raster_ans$dtm_rast)[1]*0.98), floor(terra::minmax(cloud2raster_ans$dtm_rast)[2]*1.02))</span></span>
<span id="cb144-62"><a href="point-cloud-classification.html#cb144-62" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb144-63"><a href="point-cloud-classification.html#cb144-63" tabindex="-1"></a><span class="co"># p_fn_temp(</span></span>
<span id="cb144-64"><a href="point-cloud-classification.html#cb144-64" tabindex="-1"></a><span class="co">#   rn = 11</span></span>
<span id="cb144-65"><a href="point-cloud-classification.html#cb144-65" tabindex="-1"></a><span class="co">#   , rast = cloud2raster_ans$chm_rast</span></span>
<span id="cb144-66"><a href="point-cloud-classification.html#cb144-66" tabindex="-1"></a><span class="co">#   , vopt = &quot;plasma&quot;</span></span>
<span id="cb144-67"><a href="point-cloud-classification.html#cb144-67" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb144-68"><a href="point-cloud-classification.html#cb144-68" tabindex="-1"></a><span class="co"># combine 3</span></span>
<span id="cb144-69"><a href="point-cloud-classification.html#cb144-69" tabindex="-1"></a>plt_combine_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb144-70"><a href="point-cloud-classification.html#cb144-70" tabindex="-1"></a>    rn</span>
<span id="cb144-71"><a href="point-cloud-classification.html#cb144-71" tabindex="-1"></a>    , <span class="at">df =</span> slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))</span>
<span id="cb144-72"><a href="point-cloud-classification.html#cb144-72" tabindex="-1"></a>    , <span class="at">rast1 =</span> cloud2raster_ans<span class="sc">$</span>dtm_rast</span>
<span id="cb144-73"><a href="point-cloud-classification.html#cb144-73" tabindex="-1"></a>    , <span class="at">title1 =</span> <span class="st">&quot;DTM&quot;</span></span>
<span id="cb144-74"><a href="point-cloud-classification.html#cb144-74" tabindex="-1"></a>    , <span class="at">vopt1 =</span> <span class="st">&quot;viridis&quot;</span></span>
<span id="cb144-75"><a href="point-cloud-classification.html#cb144-75" tabindex="-1"></a>    , <span class="at">rast2 =</span> cloud2raster_ans<span class="sc">$</span>chm_rast</span>
<span id="cb144-76"><a href="point-cloud-classification.html#cb144-76" tabindex="-1"></a>    , <span class="at">title2 =</span> <span class="st">&quot;CHM&quot;</span></span>
<span id="cb144-77"><a href="point-cloud-classification.html#cb144-77" tabindex="-1"></a>    , <span class="at">vopt2 =</span> <span class="st">&quot;plasma&quot;</span></span>
<span id="cb144-78"><a href="point-cloud-classification.html#cb144-78" tabindex="-1"></a>    , <span class="at">crs =</span> terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>dtm_rast)</span>
<span id="cb144-79"><a href="point-cloud-classification.html#cb144-79" tabindex="-1"></a>) {</span>
<span id="cb144-80"><a href="point-cloud-classification.html#cb144-80" tabindex="-1"></a>  <span class="co"># composite 1</span></span>
<span id="cb144-81"><a href="point-cloud-classification.html#cb144-81" tabindex="-1"></a>  ans1 <span class="ot">&lt;-</span> <span class="fu">p_fn_temp</span>(</span>
<span id="cb144-82"><a href="point-cloud-classification.html#cb144-82" tabindex="-1"></a>    <span class="at">rn =</span> rn</span>
<span id="cb144-83"><a href="point-cloud-classification.html#cb144-83" tabindex="-1"></a>    , <span class="at">df =</span> df</span>
<span id="cb144-84"><a href="point-cloud-classification.html#cb144-84" tabindex="-1"></a>    , <span class="at">rast =</span> rast1</span>
<span id="cb144-85"><a href="point-cloud-classification.html#cb144-85" tabindex="-1"></a>    , <span class="at">my_title =</span> title1</span>
<span id="cb144-86"><a href="point-cloud-classification.html#cb144-86" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb144-87"><a href="point-cloud-classification.html#cb144-87" tabindex="-1"></a>    , <span class="at">vopt =</span> vopt1</span>
<span id="cb144-88"><a href="point-cloud-classification.html#cb144-88" tabindex="-1"></a>  )</span>
<span id="cb144-89"><a href="point-cloud-classification.html#cb144-89" tabindex="-1"></a>  <span class="co"># composite 2</span></span>
<span id="cb144-90"><a href="point-cloud-classification.html#cb144-90" tabindex="-1"></a>  ans2 <span class="ot">&lt;-</span> <span class="fu">p_fn_temp</span>(</span>
<span id="cb144-91"><a href="point-cloud-classification.html#cb144-91" tabindex="-1"></a>    <span class="at">rn =</span> rn</span>
<span id="cb144-92"><a href="point-cloud-classification.html#cb144-92" tabindex="-1"></a>    , <span class="at">df =</span> df</span>
<span id="cb144-93"><a href="point-cloud-classification.html#cb144-93" tabindex="-1"></a>    , <span class="at">rast =</span> rast2</span>
<span id="cb144-94"><a href="point-cloud-classification.html#cb144-94" tabindex="-1"></a>    , <span class="at">my_title =</span> title2</span>
<span id="cb144-95"><a href="point-cloud-classification.html#cb144-95" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb144-96"><a href="point-cloud-classification.html#cb144-96" tabindex="-1"></a>    , <span class="at">vopt =</span> vopt2</span>
<span id="cb144-97"><a href="point-cloud-classification.html#cb144-97" tabindex="-1"></a>  )</span>
<span id="cb144-98"><a href="point-cloud-classification.html#cb144-98" tabindex="-1"></a>  <span class="co"># plt rgb</span></span>
<span id="cb144-99"><a href="point-cloud-classification.html#cb144-99" tabindex="-1"></a>    rgb_temp <span class="ot">&lt;-</span></span>
<span id="cb144-100"><a href="point-cloud-classification.html#cb144-100" tabindex="-1"></a>      <span class="fu">ortho_plt_fn</span>(ans1<span class="sc">$</span>d) <span class="sc">+</span> </span>
<span id="cb144-101"><a href="point-cloud-classification.html#cb144-101" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> ans1<span class="sc">$</span>d, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>)</span>
<span id="cb144-102"><a href="point-cloud-classification.html#cb144-102" tabindex="-1"></a>  <span class="co"># combine</span></span>
<span id="cb144-103"><a href="point-cloud-classification.html#cb144-103" tabindex="-1"></a>    r <span class="ot">&lt;-</span> ans1<span class="sc">$</span>plt <span class="sc">+</span> ans2<span class="sc">$</span>plt <span class="sc">+</span> rgb_temp</span>
<span id="cb144-104"><a href="point-cloud-classification.html#cb144-104" tabindex="-1"></a>    <span class="fu">return</span>(r)</span>
<span id="cb144-105"><a href="point-cloud-classification.html#cb144-105" tabindex="-1"></a>}</span>
<span id="cb144-106"><a href="point-cloud-classification.html#cb144-106" tabindex="-1"></a></span>
<span id="cb144-107"><a href="point-cloud-classification.html#cb144-107" tabindex="-1"></a><span class="co"># plt_combine_temp(2)</span></span>
<span id="cb144-108"><a href="point-cloud-classification.html#cb144-108" tabindex="-1"></a></span>
<span id="cb144-109"><a href="point-cloud-classification.html#cb144-109" tabindex="-1"></a><span class="co"># add pile locations</span></span>
<span id="cb144-110"><a href="point-cloud-classification.html#cb144-110" tabindex="-1"></a>plt_list_rast_comp <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(slash_piles_polys <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(comment))),<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb144-111"><a href="point-cloud-classification.html#cb144-111" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(plt_combine_temp)</span>
<span id="cb144-112"><a href="point-cloud-classification.html#cb144-112" tabindex="-1"></a><span class="co"># plt_list_rast_comp[[2]]</span></span></code></pre></div>
<p>combine the plots for a few piles</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="point-cloud-classification.html#cb145-1" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb145-2"><a href="point-cloud-classification.html#cb145-2" tabindex="-1"></a>  plt_list_rast_comp</span>
<span id="cb145-3"><a href="point-cloud-classification.html#cb145-3" tabindex="-1"></a>  , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb145-4"><a href="point-cloud-classification.html#cb145-4" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-126-1.png" width="1008" /></p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="point-cloud-classification.html#cb146-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/pile_tiles_rast.jpeg&quot;</span>, <span class="at">height =</span> <span class="fl">8.5</span>, <span class="at">width =</span> <span class="fl">10.5</span>)</span></code></pre></div>
<p>a few things are noteworthy in these examples:</p>
<ul>
<li>Piles are clearly visible in some areas of the DTM but less visible in other areas</li>
<li>Piles are delineated in the DSM but with varying degrees of definition based on surrounding terrain and pile structure</li>
<li>The DTM and DSM were rarely impacted by shadows in the RGB imagery</li>
<li>It is interesting to see coarse woody debris occasionally visible in the DSM</li>
</ul>
</div>
</div>
<div id="raster-based-approaches" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Raster-based approaches<a href="point-cloud-classification.html#raster-based-approaches" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll first attempt to detect slash piles using raster-based methods with the DTM and DSM. These raster-based approaches are simple and efficient but can be limited in complex forest structures where piles might be occluded by overstory trees and rasterization simplifies/removes some of the rich 3D information in the point cloud. For slash piles, which are often irregular and may not have a distinct “treetop” equivalent, common CHM-based tree detection methods might be less directly applicable. We’ll see…</p>
<div id="watershed-segmentation" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Watershed Segmentation<a href="point-cloud-classification.html#watershed-segmentation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When used for individual tree detection (ITD), this technique treats the CHM as a topographic surface, where local maxima represent tree tops and valleys represent crown boundaries. A “water source” is conceptually placed at each local lowest point, and the surface is “flooded.” Barriers are generated where different “water sources” meet, forming watershed lines that delineate individual tree crowns.</p>
<p>two possible approaches for segmenting piles are to: 1) segment individual trees using a top-down approach and then use the canopy cover as a mask to then identify slash piles; 2) use a bottoms-up approach to perform slash pile segmentation on a lower “slice” of the CHM based on an expected maximum height of a pile</p>
<p>we’ll first try the bottoms-up approach using a CHM slice with a maximum height of 4 m based on the highest point in the point cloud (3.65 m) of the slash pile which had the tallest measurement in the field (6.4 m). The 6.4 m (21 ft) field measured height seems unlikely even for a machine pile, so we’ll use the point cloud measured height which will align with the CHM data.</p>
<p>check out the lower slice of the CHM</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="point-cloud-classification.html#cb147-1" tabindex="-1"></a><span class="co"># set the max expected pile height</span></span>
<span id="cb147-2"><a href="point-cloud-classification.html#cb147-2" tabindex="-1"></a>max_ht_m <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb147-3"><a href="point-cloud-classification.html#cb147-3" tabindex="-1"></a><span class="co"># lower CHM slice</span></span>
<span id="cb147-4"><a href="point-cloud-classification.html#cb147-4" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb147-5"><a href="point-cloud-classification.html#cb147-5" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb147-6"><a href="point-cloud-classification.html#cb147-6" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-128-1.png" width="1008" /></p>
<p>already, it looks like the piles should be distinguishable objects from this data</p>
<p>let’s run watershed segmentation using <code>lidR::watershed()</code> which is based on the bioconductor package <code>EBIimage</code></p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="point-cloud-classification.html#cb148-1" tabindex="-1"></a>watershed_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb148-2"><a href="point-cloud-classification.html#cb148-2" tabindex="-1"></a>    <span class="at">chm =</span> cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb148-3"><a href="point-cloud-classification.html#cb148-3" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb148-4"><a href="point-cloud-classification.html#cb148-4" tabindex="-1"></a>    , <span class="at">th_tree =</span> <span class="fl">0.5</span></span>
<span id="cb148-5"><a href="point-cloud-classification.html#cb148-5" tabindex="-1"></a>  )()</span>
<span id="cb148-6"><a href="point-cloud-classification.html#cb148-6" tabindex="-1"></a><span class="co"># this is a raster</span></span>
<span id="cb148-7"><a href="point-cloud-classification.html#cb148-7" tabindex="-1"></a>watershed_ans</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 2740, 3473, 1  (nrow, ncol, nlyr)
## resolution  : 0.2, 0.2  (x, y)
## extent      : 499264.2, 499958.8, 4317599, 4318147  (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N (EPSG:32613) 
## source(s)   : memory
## varname     : chm_0.2m 
## name        : focal_mean 
## min value   :          1 
## max value   :      10007</code></pre>
<p>each value should be a unique “segment” which we can refine based on rules of expected size and shape of piles</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="point-cloud-classification.html#cb150-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">freq</span>(watershed_ans) <span class="sc">%&gt;%</span> </span>
<span id="cb150-2"><a href="point-cloud-classification.html#cb150-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>##    layer value count
## 1      1  6846    11
## 2      1  8003    16
## 3      1  2435     4
## 4      1  6953     4
## 5      1  1685     6
## 6      1  7978     9
## 7      1  6768    12
## 8      1  1403    54
## 9      1   511     5
## 10     1  3321     6</code></pre>
<p>where the “value” is the segment identifier and the count is the number of raster cells assigned to that segment</p>
<p>let’s plot the raster return from the watershed segmentation</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="point-cloud-classification.html#cb152-1" tabindex="-1"></a>watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb152-2"><a href="point-cloud-classification.html#cb152-2" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb152-3"><a href="point-cloud-classification.html#cb152-3" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">c</span>(</span>
<span id="cb152-4"><a href="point-cloud-classification.html#cb152-4" tabindex="-1"></a>      viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb152-5"><a href="point-cloud-classification.html#cb152-5" tabindex="-1"></a>      , viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb152-6"><a href="point-cloud-classification.html#cb152-6" tabindex="-1"></a>      , viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="at">n =</span> <span class="fu">floor</span>(terra<span class="sc">::</span><span class="fu">minmax</span>(watershed_ans)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb152-7"><a href="point-cloud-classification.html#cb152-7" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">sample</span>()</span>
<span id="cb152-8"><a href="point-cloud-classification.html#cb152-8" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb152-9"><a href="point-cloud-classification.html#cb152-9" tabindex="-1"></a>    , <span class="at">axes =</span> F</span>
<span id="cb152-10"><a href="point-cloud-classification.html#cb152-10" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-131-1.png" width="1008" /></p>
<p>we can quickly calculate the area of the segments which we could use as a filter</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="point-cloud-classification.html#cb153-1" tabindex="-1"></a>min_area_m2 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb153-2"><a href="point-cloud-classification.html#cb153-2" tabindex="-1"></a><span class="co"># Two standard US parking spaces, typically measuring 9 feet by 18 feet, </span></span>
<span id="cb153-3"><a href="point-cloud-classification.html#cb153-3" tabindex="-1"></a><span class="co"># are roughly equivalent to 30.25 square meters. Each space is approximately 15.125 square meters.</span></span>
<span id="cb153-4"><a href="point-cloud-classification.html#cb153-4" tabindex="-1"></a><span class="co"># 15.125*3</span></span>
<span id="cb153-5"><a href="point-cloud-classification.html#cb153-5" tabindex="-1"></a>max_area_m2 <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb153-6"><a href="point-cloud-classification.html#cb153-6" tabindex="-1"></a><span class="co"># list of segments that meet size threshold</span></span>
<span id="cb153-7"><a href="point-cloud-classification.html#cb153-7" tabindex="-1"></a>keep_segs_temp <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb153-8"><a href="point-cloud-classification.html#cb153-8" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">freq</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb153-9"><a href="point-cloud-classification.html#cb153-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_m2 =</span> count <span class="sc">*</span> (terra<span class="sc">::</span><span class="fu">res</span>(watershed_ans) <span class="sc">%&gt;%</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> <span class="fu">prod</span>()) ) <span class="sc">%&gt;%</span> </span>
<span id="cb153-10"><a href="point-cloud-classification.html#cb153-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb153-11"><a href="point-cloud-classification.html#cb153-11" tabindex="-1"></a>    area_m2 <span class="sc">&gt;=</span> min_area_m2 <span class="sc">&amp;</span> </span>
<span id="cb153-12"><a href="point-cloud-classification.html#cb153-12" tabindex="-1"></a>    area_m2 <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb153-13"><a href="point-cloud-classification.html#cb153-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb153-14"><a href="point-cloud-classification.html#cb153-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(value)</span>
<span id="cb153-15"><a href="point-cloud-classification.html#cb153-15" tabindex="-1"></a><span class="co"># filter the raster and plot it</span></span>
<span id="cb153-16"><a href="point-cloud-classification.html#cb153-16" tabindex="-1"></a>watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb153-17"><a href="point-cloud-classification.html#cb153-17" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">subst</span>(<span class="at">from =</span> keep_segs_temp, <span class="at">to =</span> keep_segs_temp, <span class="at">others =</span> <span class="cn">NA</span>)</span></code></pre></div>
<p>plot it with the watershed segmented piles (orange) and the actual piles (white)</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="point-cloud-classification.html#cb154-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb154-2"><a href="point-cloud-classification.html#cb154-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb154-3"><a href="point-cloud-classification.html#cb154-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb154-4"><a href="point-cloud-classification.html#cb154-4" tabindex="-1"></a>  watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb154-5"><a href="point-cloud-classification.html#cb154-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T)</span>
<span id="cb154-6"><a href="point-cloud-classification.html#cb154-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb154-7"><a href="point-cloud-classification.html#cb154-7" tabindex="-1"></a>)</span>
<span id="cb154-8"><a href="point-cloud-classification.html#cb154-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb154-9"><a href="point-cloud-classification.html#cb154-9" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb154-10"><a href="point-cloud-classification.html#cb154-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb154-11"><a href="point-cloud-classification.html#cb154-11" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb154-12"><a href="point-cloud-classification.html#cb154-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-133-1.png" width="1008" /></p>
<p>zomg…we are getting so close.</p>
<div id="geometric-filtering-of-watershed-segments" class="section level4 hasAnchor" number="4.2.1.1">
<h4><span class="header-section-number">4.2.1.1</span> Geometric filtering of watershed segments<a href="point-cloud-classification.html#geometric-filtering-of-watershed-segments" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>now let’s try to filter based on the geometric properties of the watershed-detected segments.</p>
<p>ideally, we want objects that: i) meet the height threshold over the entire surface of the segment (no doughnuts); ii) are not irregularly shaped (relatively few inward angles); and iii) are circular in shape</p>
<p>we’ll make a convex hull of the polygons generated from a raster to smooth out the square edges and any inward curves or indentations, resulting in a boundary that’s always convex (no inward angles). using a convex hull we will be able to filter out:</p>
<ol style="list-style-type: decimal">
<li>watershed detected segments that were actually lower branches of a tree. these will be shaped like a doughnut with circular shape but a hole in the center</li>
<li>watershed detected segments that are irregularly shaped like coarse woody debris that was not organized into piles by humans</li>
</ol>
<p>let’s convert the watershed-detected segments from raster to vector data and create a convex hull of the shapes for comparison</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="point-cloud-classification.html#cb155-1" tabindex="-1"></a><span class="co"># vectors of segments</span></span>
<span id="cb155-2"><a href="point-cloud-classification.html#cb155-2" tabindex="-1"></a>watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb155-3"><a href="point-cloud-classification.html#cb155-3" tabindex="-1"></a>  watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb155-4"><a href="point-cloud-classification.html#cb155-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb155-5"><a href="point-cloud-classification.html#cb155-5" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-6"><a href="point-cloud-classification.html#cb155-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-7"><a href="point-cloud-classification.html#cb155-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-8"><a href="point-cloud-classification.html#cb155-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-9"><a href="point-cloud-classification.html#cb155-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb155-10"><a href="point-cloud-classification.html#cb155-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb155-11"><a href="point-cloud-classification.html#cb155-11" tabindex="-1"></a>  cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-12"><a href="point-cloud-classification.html#cb155-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb155-13"><a href="point-cloud-classification.html#cb155-13" tabindex="-1"></a><span class="co"># convex hulls of segments</span></span>
<span id="cb155-14"><a href="point-cloud-classification.html#cb155-14" tabindex="-1"></a>watershed_ans_poly_chull <span class="ot">&lt;-</span></span>
<span id="cb155-15"><a href="point-cloud-classification.html#cb155-15" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb155-16"><a href="point-cloud-classification.html#cb155-16" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-17"><a href="point-cloud-classification.html#cb155-17" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-18"><a href="point-cloud-classification.html#cb155-18" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-19"><a href="point-cloud-classification.html#cb155-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span></code></pre></div>
<p>lets make an example area that we’ll use to demonstrate the filtering process of the watershed detected segments</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="point-cloud-classification.html#cb156-1" tabindex="-1"></a>aoi_temp <span class="ot">&lt;-</span></span>
<span id="cb156-2"><a href="point-cloud-classification.html#cb156-2" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb156-3"><a href="point-cloud-classification.html#cb156-3" tabindex="-1"></a>  <span class="co"># dplyr::filter(pred_id==241) %&gt;%</span></span>
<span id="cb156-4"><a href="point-cloud-classification.html#cb156-4" tabindex="-1"></a>  <span class="co"># dplyr::filter(pred_id==11916) %&gt;%</span></span>
<span id="cb156-5"><a href="point-cloud-classification.html#cb156-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb156-6"><a href="point-cloud-classification.html#cb156-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb156-7"><a href="point-cloud-classification.html#cb156-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb156-8"><a href="point-cloud-classification.html#cb156-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">55</span>)</span>
<span id="cb156-9"><a href="point-cloud-classification.html#cb156-9" tabindex="-1"></a><span class="co"># list of examples</span></span>
<span id="cb156-10"><a href="point-cloud-classification.html#cb156-10" tabindex="-1"></a>pred_id_temp <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb156-11"><a href="point-cloud-classification.html#cb156-11" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb156-12"><a href="point-cloud-classification.html#cb156-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span>
<span id="cb156-13"><a href="point-cloud-classification.html#cb156-13" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb156-14"><a href="point-cloud-classification.html#cb156-14" tabindex="-1"></a>ortho_plt_temp <span class="ot">&lt;-</span> </span>
<span id="cb156-15"><a href="point-cloud-classification.html#cb156-15" tabindex="-1"></a>  <span class="fu">ortho_plt_fn</span>(</span>
<span id="cb156-16"><a href="point-cloud-classification.html#cb156-16" tabindex="-1"></a>    <span class="at">stand =</span> aoi_temp</span>
<span id="cb156-17"><a href="point-cloud-classification.html#cb156-17" tabindex="-1"></a>    , <span class="at">buffer =</span> <span class="dv">5</span></span>
<span id="cb156-18"><a href="point-cloud-classification.html#cb156-18" tabindex="-1"></a>  ) </span></code></pre></div>
<p>plot our example watershed detected segments as vectors (pink) and convex hull of the segments (orange) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="point-cloud-classification.html#cb157-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb157-2"><a href="point-cloud-classification.html#cb157-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb157-3"><a href="point-cloud-classification.html#cb157-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb157-4"><a href="point-cloud-classification.html#cb157-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb157-5"><a href="point-cloud-classification.html#cb157-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb157-6"><a href="point-cloud-classification.html#cb157-6" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb157-7"><a href="point-cloud-classification.html#cb157-7" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb157-8"><a href="point-cloud-classification.html#cb157-8" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb157-9"><a href="point-cloud-classification.html#cb157-9" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb157-10"><a href="point-cloud-classification.html#cb157-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-11"><a href="point-cloud-classification.html#cb157-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb157-12"><a href="point-cloud-classification.html#cb157-12" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb157-13"><a href="point-cloud-classification.html#cb157-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp)</span>
<span id="cb157-14"><a href="point-cloud-classification.html#cb157-14" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span></span>
<span id="cb157-15"><a href="point-cloud-classification.html#cb157-15" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb157-16"><a href="point-cloud-classification.html#cb157-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-17"><a href="point-cloud-classification.html#cb157-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb157-18"><a href="point-cloud-classification.html#cb157-18" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb157-19"><a href="point-cloud-classification.html#cb157-19" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb157-20"><a href="point-cloud-classification.html#cb157-20" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb157-21"><a href="point-cloud-classification.html#cb157-21" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb157-22"><a href="point-cloud-classification.html#cb157-22" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-23"><a href="point-cloud-classification.html#cb157-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb157-24"><a href="point-cloud-classification.html#cb157-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-136-1.png" width="1008" /></p>
<p>let’s first filter out segments that have holes in them or are very irregularly shaped by comparing the area of the polygon and convex hull</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="point-cloud-classification.html#cb158-1" tabindex="-1"></a><span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb158-2"><a href="point-cloud-classification.html#cb158-2" tabindex="-1"></a>pct_chull_overlap <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb158-3"><a href="point-cloud-classification.html#cb158-3" tabindex="-1"></a><span class="co"># compare areas</span></span>
<span id="cb158-4"><a href="point-cloud-classification.html#cb158-4" tabindex="-1"></a>watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb158-5"><a href="point-cloud-classification.html#cb158-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">poly_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb158-6"><a href="point-cloud-classification.html#cb158-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb158-7"><a href="point-cloud-classification.html#cb158-7" tabindex="-1"></a>    watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb158-8"><a href="point-cloud-classification.html#cb158-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb158-9"><a href="point-cloud-classification.html#cb158-9" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb158-10"><a href="point-cloud-classification.html#cb158-10" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb158-11"><a href="point-cloud-classification.html#cb158-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-12"><a href="point-cloud-classification.html#cb158-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb158-13"><a href="point-cloud-classification.html#cb158-13" tabindex="-1"></a>    <span class="at">pct_chull =</span> poly_area_m2<span class="sc">/</span>chull_area_m2</span>
<span id="cb158-14"><a href="point-cloud-classification.html#cb158-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-15"><a href="point-cloud-classification.html#cb158-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb158-16"><a href="point-cloud-classification.html#cb158-16" tabindex="-1"></a>    pct_chull <span class="sc">&gt;=</span> pct_chull_overlap</span>
<span id="cb158-17"><a href="point-cloud-classification.html#cb158-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb158-18"><a href="point-cloud-classification.html#cb158-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span></code></pre></div>
<p>which piles meet the minimum overlap threshold (black outline) between the segmented polygon and the convex hull?</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="point-cloud-classification.html#cb159-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb159-2"><a href="point-cloud-classification.html#cb159-2" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb159-3"><a href="point-cloud-classification.html#cb159-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb159-4"><a href="point-cloud-classification.html#cb159-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb159-5"><a href="point-cloud-classification.html#cb159-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb159-6"><a href="point-cloud-classification.html#cb159-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb159-7"><a href="point-cloud-classification.html#cb159-7" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb159-8"><a href="point-cloud-classification.html#cb159-8" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb159-9"><a href="point-cloud-classification.html#cb159-9" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb159-10"><a href="point-cloud-classification.html#cb159-10" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb159-11"><a href="point-cloud-classification.html#cb159-11" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb159-12"><a href="point-cloud-classification.html#cb159-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb159-13"><a href="point-cloud-classification.html#cb159-13" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb159-14"><a href="point-cloud-classification.html#cb159-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb159-15"><a href="point-cloud-classification.html#cb159-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb159-16"><a href="point-cloud-classification.html#cb159-16" tabindex="-1"></a>        <span class="at">meets_overlap =</span> pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id</span>
<span id="cb159-17"><a href="point-cloud-classification.html#cb159-17" tabindex="-1"></a>      )</span>
<span id="cb159-18"><a href="point-cloud-classification.html#cb159-18" tabindex="-1"></a>    , ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> meets_overlap)</span>
<span id="cb159-19"><a href="point-cloud-classification.html#cb159-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb159-20"><a href="point-cloud-classification.html#cb159-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb159-21"><a href="point-cloud-classification.html#cb159-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb159-22"><a href="point-cloud-classification.html#cb159-22" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb159-23"><a href="point-cloud-classification.html#cb159-23" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb159-24"><a href="point-cloud-classification.html#cb159-24" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb159-25"><a href="point-cloud-classification.html#cb159-25" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb159-26"><a href="point-cloud-classification.html#cb159-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb159-27"><a href="point-cloud-classification.html#cb159-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb159-28"><a href="point-cloud-classification.html#cb159-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb159-29"><a href="point-cloud-classification.html#cb159-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-138-1.png" width="1008" /></p>
<p>that looks like it did what we wanted it to do (filter out segments with holes and irregular shapes) let’s look at the entire area again after applying this filter plotting the remaining watershed segmented piles (orange) and the actual piles (white)</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="point-cloud-classification.html#cb160-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb160-2"><a href="point-cloud-classification.html#cb160-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb160-3"><a href="point-cloud-classification.html#cb160-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb160-4"><a href="point-cloud-classification.html#cb160-4" tabindex="-1"></a>  watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb160-5"><a href="point-cloud-classification.html#cb160-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb160-6"><a href="point-cloud-classification.html#cb160-6" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb160-7"><a href="point-cloud-classification.html#cb160-7" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb160-8"><a href="point-cloud-classification.html#cb160-8" tabindex="-1"></a>)</span>
<span id="cb160-9"><a href="point-cloud-classification.html#cb160-9" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb160-10"><a href="point-cloud-classification.html#cb160-10" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb160-11"><a href="point-cloud-classification.html#cb160-11" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb160-12"><a href="point-cloud-classification.html#cb160-12" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb160-13"><a href="point-cloud-classification.html#cb160-13" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-139-1.png" width="1008" /></p>
<p>finally, let’s apply a circle-fitting algorithm to remove non-circular segments from the remaining segments.</p>
<p>Least squares circle fitting is a method to find the circle that best approximates a set of data points by minimizing the sum of the squared distances between the points and the circle. The <code>lidR::fit_circle()</code> function finds the best-fitting flat, horizontal circle for a group of 3D points, even if some of those points are messy or don’t quite fit. It determines the circle’s center and size, and also provides an “angular range” to show how much of a complete circle the points actually form, which is a more reliable measure than a simple error value (e.g. RMSE).</p>
<p>The “angular range” tells you how much of a complete circle the points in the watershed-detected segment actually cover. Imagine drawing a circle, and then only having points along a part of its edge, here’s how to interpret it:</p>
<ul>
<li>360 degrees suggests the points form a full, unbroken circle, like the base of a perfectly round slash pile.</li>
<li>180 degrees would mean the points only form a half-circle or a semi-circle.</li>
</ul>
<p>A smaller range (e.g., 90 degrees) indicates just a partial arc or a small curve. This can help us determine if a group of points truly represents a circular shape, which is useful for identifying objects like slash piles that are expected to have a round or conical base.</p>
<p>we’ll define a function to pass our <code>sf</code> polygon data of watershed detected segments and return a <code>sf</code> data of the fitted circles</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="point-cloud-classification.html#cb161-1" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-2"><a href="point-cloud-classification.html#cb161-2" tabindex="-1"></a><span class="co"># 1)</span></span>
<span id="cb161-3"><a href="point-cloud-classification.html#cb161-3" tabindex="-1"></a><span class="co"># function to return sf circle from xy center and radius in given crs</span></span>
<span id="cb161-4"><a href="point-cloud-classification.html#cb161-4" tabindex="-1"></a><span class="co"># to handle return from common circle fitting algorithms</span></span>
<span id="cb161-5"><a href="point-cloud-classification.html#cb161-5" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-6"><a href="point-cloud-classification.html#cb161-6" tabindex="-1"></a>point_xy_radius_to_circle_sf <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb161-7"><a href="point-cloud-classification.html#cb161-7" tabindex="-1"></a>  center_x</span>
<span id="cb161-8"><a href="point-cloud-classification.html#cb161-8" tabindex="-1"></a>  , center_y</span>
<span id="cb161-9"><a href="point-cloud-classification.html#cb161-9" tabindex="-1"></a>  , radius</span>
<span id="cb161-10"><a href="point-cloud-classification.html#cb161-10" tabindex="-1"></a>  , <span class="at">crs =</span> <span class="cn">NULL</span></span>
<span id="cb161-11"><a href="point-cloud-classification.html#cb161-11" tabindex="-1"></a>) {</span>
<span id="cb161-12"><a href="point-cloud-classification.html#cb161-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(crs)){<span class="fu">stop</span>(<span class="st">&quot;need a crs, guy&quot;</span>)}</span>
<span id="cb161-13"><a href="point-cloud-classification.html#cb161-13" tabindex="-1"></a>  <span class="co"># create a point geometry object</span></span>
<span id="cb161-14"><a href="point-cloud-classification.html#cb161-14" tabindex="-1"></a>  center_point <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(center_x, center_y))</span>
<span id="cb161-15"><a href="point-cloud-classification.html#cb161-15" tabindex="-1"></a>  <span class="co"># create an sf object from the point</span></span>
<span id="cb161-16"><a href="point-cloud-classification.html#cb161-16" tabindex="-1"></a>  center_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_sf</span>(</span>
<span id="cb161-17"><a href="point-cloud-classification.html#cb161-17" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb161-18"><a href="point-cloud-classification.html#cb161-18" tabindex="-1"></a>      <span class="at">center_x =</span> center_x</span>
<span id="cb161-19"><a href="point-cloud-classification.html#cb161-19" tabindex="-1"></a>      , <span class="at">center_y =</span> center_y</span>
<span id="cb161-20"><a href="point-cloud-classification.html#cb161-20" tabindex="-1"></a>      , <span class="at">radius =</span> radius</span>
<span id="cb161-21"><a href="point-cloud-classification.html#cb161-21" tabindex="-1"></a>    )</span>
<span id="cb161-22"><a href="point-cloud-classification.html#cb161-22" tabindex="-1"></a>    , <span class="at">geometry =</span> sf<span class="sc">::</span><span class="fu">st_sfc</span>(center_point)</span>
<span id="cb161-23"><a href="point-cloud-classification.html#cb161-23" tabindex="-1"></a>    , <span class="at">crs =</span> crs</span>
<span id="cb161-24"><a href="point-cloud-classification.html#cb161-24" tabindex="-1"></a>  )</span>
<span id="cb161-25"><a href="point-cloud-classification.html#cb161-25" tabindex="-1"></a>  <span class="co"># create the circle geometry by buffering the point</span></span>
<span id="cb161-26"><a href="point-cloud-classification.html#cb161-26" tabindex="-1"></a>  circle_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(center_sf, <span class="at">dist =</span> radius)</span>
<span id="cb161-27"><a href="point-cloud-classification.html#cb161-27" tabindex="-1"></a>  <span class="fu">return</span>(circle_sf)</span>
<span id="cb161-28"><a href="point-cloud-classification.html#cb161-28" tabindex="-1"></a>}</span>
<span id="cb161-29"><a href="point-cloud-classification.html#cb161-29" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-30"><a href="point-cloud-classification.html#cb161-30" tabindex="-1"></a><span class="co"># 2)</span></span>
<span id="cb161-31"><a href="point-cloud-classification.html#cb161-31" tabindex="-1"></a><span class="co"># function to generate 2d xy points from polygon feature</span></span>
<span id="cb161-32"><a href="point-cloud-classification.html#cb161-32" tabindex="-1"></a><span class="co"># to pass to common circle fitting algorithms</span></span>
<span id="cb161-33"><a href="point-cloud-classification.html#cb161-33" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb161-34"><a href="point-cloud-classification.html#cb161-34" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-35"><a href="point-cloud-classification.html#cb161-35" tabindex="-1"></a>poly_to_points <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb161-36"><a href="point-cloud-classification.html#cb161-36" tabindex="-1"></a>  sf_data</span>
<span id="cb161-37"><a href="point-cloud-classification.html#cb161-37" tabindex="-1"></a>  , <span class="at">as_spatial =</span> F <span class="co"># if set to F, returns xy dataframe; if T returns sf data</span></span>
<span id="cb161-38"><a href="point-cloud-classification.html#cb161-38" tabindex="-1"></a>  , <span class="at">simplify_multipolygons =</span> F <span class="co"># if set to T, multipolygons are simplified by keeping the largest segment</span></span>
<span id="cb161-39"><a href="point-cloud-classification.html#cb161-39" tabindex="-1"></a>) {</span>
<span id="cb161-40"><a href="point-cloud-classification.html#cb161-40" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb161-41"><a href="point-cloud-classification.html#cb161-41" tabindex="-1"></a>  <span class="co"># just work with the first</span></span>
<span id="cb161-42"><a href="point-cloud-classification.html#cb161-42" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(sf_data)<span class="sc">&gt;</span><span class="dv">1</span>){<span class="fu">stop</span>(<span class="st">&quot;this function only works with a single record at a time&quot;</span>)}</span>
<span id="cb161-43"><a href="point-cloud-classification.html#cb161-43" tabindex="-1"></a>  <span class="co"># simplify_multipolygons</span></span>
<span id="cb161-44"><a href="point-cloud-classification.html#cb161-44" tabindex="-1"></a>  <span class="cf">if</span>(simplify_multipolygons){</span>
<span id="cb161-45"><a href="point-cloud-classification.html#cb161-45" tabindex="-1"></a>    sf_data <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb161-46"><a href="point-cloud-classification.html#cb161-46" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb161-47"><a href="point-cloud-classification.html#cb161-47" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-48"><a href="point-cloud-classification.html#cb161-48" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb161-49"><a href="point-cloud-classification.html#cb161-49" tabindex="-1"></a>  }</span>
<span id="cb161-50"><a href="point-cloud-classification.html#cb161-50" tabindex="-1"></a>  <span class="co"># get point coordinates</span></span>
<span id="cb161-51"><a href="point-cloud-classification.html#cb161-51" tabindex="-1"></a>  xy_temp <span class="ot">&lt;-</span> </span>
<span id="cb161-52"><a href="point-cloud-classification.html#cb161-52" tabindex="-1"></a>    sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb161-53"><a href="point-cloud-classification.html#cb161-53" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-54"><a href="point-cloud-classification.html#cb161-54" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-55"><a href="point-cloud-classification.html#cb161-55" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span> </span>
<span id="cb161-56"><a href="point-cloud-classification.html#cb161-56" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(x,y) <span class="sc">%&gt;%</span> </span>
<span id="cb161-57"><a href="point-cloud-classification.html#cb161-57" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">z=</span><span class="dv">0</span>)</span>
<span id="cb161-58"><a href="point-cloud-classification.html#cb161-58" tabindex="-1"></a>  <span class="co"># as_spatial</span></span>
<span id="cb161-59"><a href="point-cloud-classification.html#cb161-59" tabindex="-1"></a>  <span class="cf">if</span>(as_spatial){</span>
<span id="cb161-60"><a href="point-cloud-classification.html#cb161-60" tabindex="-1"></a>    xy_temp <span class="ot">&lt;-</span> xy_temp <span class="sc">%&gt;%</span> </span>
<span id="cb161-61"><a href="point-cloud-classification.html#cb161-61" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data), <span class="at">remove =</span> F)</span>
<span id="cb161-62"><a href="point-cloud-classification.html#cb161-62" tabindex="-1"></a>  }</span>
<span id="cb161-63"><a href="point-cloud-classification.html#cb161-63" tabindex="-1"></a>  <span class="fu">return</span>(xy_temp)</span>
<span id="cb161-64"><a href="point-cloud-classification.html#cb161-64" tabindex="-1"></a>}</span>
<span id="cb161-65"><a href="point-cloud-classification.html#cb161-65" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;% </span></span>
<span id="cb161-66"><a href="point-cloud-classification.html#cb161-66" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id %in% c(7717)) %&gt;%</span></span>
<span id="cb161-67"><a href="point-cloud-classification.html#cb161-67" tabindex="-1"></a><span class="co">#   # poly_to_points(as_spatial = T) %&gt;% </span></span>
<span id="cb161-68"><a href="point-cloud-classification.html#cb161-68" tabindex="-1"></a><span class="co">#   poly_to_points(as_spatial = F) %&gt;% </span></span>
<span id="cb161-69"><a href="point-cloud-classification.html#cb161-69" tabindex="-1"></a><span class="co">#   ggplot() + </span></span>
<span id="cb161-70"><a href="point-cloud-classification.html#cb161-70" tabindex="-1"></a><span class="co">#     # geom_sf()</span></span>
<span id="cb161-71"><a href="point-cloud-classification.html#cb161-71" tabindex="-1"></a><span class="co">#     geom_point(aes(x=x,y=y))</span></span>
<span id="cb161-72"><a href="point-cloud-classification.html#cb161-72" tabindex="-1"></a></span>
<span id="cb161-73"><a href="point-cloud-classification.html#cb161-73" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-74"><a href="point-cloud-classification.html#cb161-74" tabindex="-1"></a><span class="co"># 3)</span></span>
<span id="cb161-75"><a href="point-cloud-classification.html#cb161-75" tabindex="-1"></a><span class="co"># function to combine poly_to_points, lidR::fit_circle, and point_xy_radius_to_circle_sf</span></span>
<span id="cb161-76"><a href="point-cloud-classification.html#cb161-76" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb161-77"><a href="point-cloud-classification.html#cb161-77" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-78"><a href="point-cloud-classification.html#cb161-78" tabindex="-1"></a>poly_circle_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb161-79"><a href="point-cloud-classification.html#cb161-79" tabindex="-1"></a>  poly</span>
<span id="cb161-80"><a href="point-cloud-classification.html#cb161-80" tabindex="-1"></a>  <span class="co"># if set to T, multipolygons are simplified by keeping the largest segment</span></span>
<span id="cb161-81"><a href="point-cloud-classification.html#cb161-81" tabindex="-1"></a>  , <span class="at">simplify_multipolygons =</span> F</span>
<span id="cb161-82"><a href="point-cloud-classification.html#cb161-82" tabindex="-1"></a>  <span class="co"># number of iterations for the RANSAC fitting algorithm</span></span>
<span id="cb161-83"><a href="point-cloud-classification.html#cb161-83" tabindex="-1"></a>  , <span class="at">num_iterations =</span> <span class="dv">100</span></span>
<span id="cb161-84"><a href="point-cloud-classification.html#cb161-84" tabindex="-1"></a>  <span class="co"># threshold value; points are considered inliers if their residuals are below this value</span></span>
<span id="cb161-85"><a href="point-cloud-classification.html#cb161-85" tabindex="-1"></a>  , <span class="at">inlier_threshold =</span> <span class="fl">0.01</span></span>
<span id="cb161-86"><a href="point-cloud-classification.html#cb161-86" tabindex="-1"></a>) {</span>
<span id="cb161-87"><a href="point-cloud-classification.html#cb161-87" tabindex="-1"></a>  <span class="co"># poly_to_points</span></span>
<span id="cb161-88"><a href="point-cloud-classification.html#cb161-88" tabindex="-1"></a>  poly_to_points_ans <span class="ot">&lt;-</span> <span class="fu">poly_to_points</span>(poly, <span class="at">as_spatial =</span> F, <span class="at">simplify_multipolygons =</span> simplify_multipolygons)</span>
<span id="cb161-89"><a href="point-cloud-classification.html#cb161-89" tabindex="-1"></a>  <span class="co"># fit_circle</span></span>
<span id="cb161-90"><a href="point-cloud-classification.html#cb161-90" tabindex="-1"></a>  fit_circle_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">fit_circle</span>(</span>
<span id="cb161-91"><a href="point-cloud-classification.html#cb161-91" tabindex="-1"></a>    <span class="at">points =</span> poly_to_points_ans <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb161-92"><a href="point-cloud-classification.html#cb161-92" tabindex="-1"></a>    <span class="co"># number of iterations for the RANSAC fitting algorithm</span></span>
<span id="cb161-93"><a href="point-cloud-classification.html#cb161-93" tabindex="-1"></a>    , <span class="at">num_iterations =</span> num_iterations</span>
<span id="cb161-94"><a href="point-cloud-classification.html#cb161-94" tabindex="-1"></a>    <span class="co"># threshold value; points are considered inliers if their residuals are below this value</span></span>
<span id="cb161-95"><a href="point-cloud-classification.html#cb161-95" tabindex="-1"></a>    , <span class="at">inlier_threshold =</span> inlier_threshold</span>
<span id="cb161-96"><a href="point-cloud-classification.html#cb161-96" tabindex="-1"></a>  )</span>
<span id="cb161-97"><a href="point-cloud-classification.html#cb161-97" tabindex="-1"></a>  <span class="co"># point_xy_radius_to_circle_sf</span></span>
<span id="cb161-98"><a href="point-cloud-classification.html#cb161-98" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> <span class="fu">point_xy_radius_to_circle_sf</span>(</span>
<span id="cb161-99"><a href="point-cloud-classification.html#cb161-99" tabindex="-1"></a>    <span class="at">center_x =</span> fit_circle_ans<span class="sc">$</span>center_x</span>
<span id="cb161-100"><a href="point-cloud-classification.html#cb161-100" tabindex="-1"></a>    , <span class="at">center_y =</span> fit_circle_ans<span class="sc">$</span>center_y</span>
<span id="cb161-101"><a href="point-cloud-classification.html#cb161-101" tabindex="-1"></a>    , <span class="at">radius =</span> fit_circle_ans<span class="sc">$</span>radius</span>
<span id="cb161-102"><a href="point-cloud-classification.html#cb161-102" tabindex="-1"></a>    , <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(poly)</span>
<span id="cb161-103"><a href="point-cloud-classification.html#cb161-103" tabindex="-1"></a>  )</span>
<span id="cb161-104"><a href="point-cloud-classification.html#cb161-104" tabindex="-1"></a>  <span class="co"># add other vars</span></span>
<span id="cb161-105"><a href="point-cloud-classification.html#cb161-105" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> ans <span class="sc">%&gt;%</span> </span>
<span id="cb161-106"><a href="point-cloud-classification.html#cb161-106" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb161-107"><a href="point-cloud-classification.html#cb161-107" tabindex="-1"></a>      <span class="at">covered_arc_degree =</span> fit_circle_ans<span class="sc">$</span>covered_arc_degree</span>
<span id="cb161-108"><a href="point-cloud-classification.html#cb161-108" tabindex="-1"></a>      , <span class="at">percentage_inlier =</span> fit_circle_ans<span class="sc">$</span>percentage_inlier</span>
<span id="cb161-109"><a href="point-cloud-classification.html#cb161-109" tabindex="-1"></a>      , <span class="at">percentage_inside =</span> fit_circle_ans<span class="sc">$</span>percentage_inside</span>
<span id="cb161-110"><a href="point-cloud-classification.html#cb161-110" tabindex="-1"></a>      <span class="co"># , inliers = fit_circle_ans$inliers</span></span>
<span id="cb161-111"><a href="point-cloud-classification.html#cb161-111" tabindex="-1"></a>    )</span>
<span id="cb161-112"><a href="point-cloud-classification.html#cb161-112" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb161-113"><a href="point-cloud-classification.html#cb161-113" tabindex="-1"></a>  <span class="fu">return</span>(ans)</span>
<span id="cb161-114"><a href="point-cloud-classification.html#cb161-114" tabindex="-1"></a>}</span>
<span id="cb161-115"><a href="point-cloud-classification.html#cb161-115" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;%</span></span>
<span id="cb161-116"><a href="point-cloud-classification.html#cb161-116" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id == 7717) %&gt;%</span></span>
<span id="cb161-117"><a href="point-cloud-classification.html#cb161-117" tabindex="-1"></a><span class="co">#   poly_circle_fit() %&gt;%</span></span>
<span id="cb161-118"><a href="point-cloud-classification.html#cb161-118" tabindex="-1"></a><span class="co">#   ggplot() + geom_sf() + </span></span>
<span id="cb161-119"><a href="point-cloud-classification.html#cb161-119" tabindex="-1"></a><span class="co">#   geom_sf(</span></span>
<span id="cb161-120"><a href="point-cloud-classification.html#cb161-120" tabindex="-1"></a><span class="co">#     data = filtered_watershed_ans_poly %&gt;% dplyr::filter(pred_id == 7717) %&gt;% poly_to_points(as_spatial = T)</span></span>
<span id="cb161-121"><a href="point-cloud-classification.html#cb161-121" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb161-122"><a href="point-cloud-classification.html#cb161-122" tabindex="-1"></a></span>
<span id="cb161-123"><a href="point-cloud-classification.html#cb161-123" tabindex="-1"></a><span class="co"># watershed_ans_poly %&gt;%</span></span>
<span id="cb161-124"><a href="point-cloud-classification.html#cb161-124" tabindex="-1"></a><span class="co">#   dplyr::filter(pred_id == 7717) %&gt;%</span></span>
<span id="cb161-125"><a href="point-cloud-classification.html#cb161-125" tabindex="-1"></a><span class="co">#   poly_circle_fit() %&gt;% </span></span>
<span id="cb161-126"><a href="point-cloud-classification.html#cb161-126" tabindex="-1"></a><span class="co">#   dplyr::glimpse()</span></span>
<span id="cb161-127"><a href="point-cloud-classification.html#cb161-127" tabindex="-1"></a></span>
<span id="cb161-128"><a href="point-cloud-classification.html#cb161-128" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-129"><a href="point-cloud-classification.html#cb161-129" tabindex="-1"></a><span class="co"># 4)</span></span>
<span id="cb161-130"><a href="point-cloud-classification.html#cb161-130" tabindex="-1"></a><span class="co"># function to combine poly_to_points, lidR::fit_circle, and point_xy_radius_to_circle_sf</span></span>
<span id="cb161-131"><a href="point-cloud-classification.html#cb161-131" tabindex="-1"></a><span class="co"># !!! only works with a singular polygon at a time</span></span>
<span id="cb161-132"><a href="point-cloud-classification.html#cb161-132" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb161-133"><a href="point-cloud-classification.html#cb161-133" tabindex="-1"></a>sf_data_circle_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data) {</span>
<span id="cb161-134"><a href="point-cloud-classification.html#cb161-134" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb161-135"><a href="point-cloud-classification.html#cb161-135" tabindex="-1"></a>  <span class="co"># apply poly_circle_fit() to each row to get fitted circle sf data</span></span>
<span id="cb161-136"><a href="point-cloud-classification.html#cb161-136" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb161-137"><a href="point-cloud-classification.html#cb161-137" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-138"><a href="point-cloud-classification.html#cb161-138" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id_xxx =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb161-139"><a href="point-cloud-classification.html#cb161-139" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">nest_by</span>(id_xxx) <span class="sc">%&gt;%</span> </span>
<span id="cb161-140"><a href="point-cloud-classification.html#cb161-140" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb161-141"><a href="point-cloud-classification.html#cb161-141" tabindex="-1"></a>      <span class="at">circle_fit =</span> <span class="fu">poly_circle_fit</span>(<span class="at">poly =</span> data)</span>
<span id="cb161-142"><a href="point-cloud-classification.html#cb161-142" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb161-143"><a href="point-cloud-classification.html#cb161-143" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(circle_fit)</span>
<span id="cb161-144"><a href="point-cloud-classification.html#cb161-144" tabindex="-1"></a>  <span class="co"># combine with original data but drop original geom</span></span>
<span id="cb161-145"><a href="point-cloud-classification.html#cb161-145" tabindex="-1"></a>  df <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb161-146"><a href="point-cloud-classification.html#cb161-146" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-147"><a href="point-cloud-classification.html#cb161-147" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(cf) <span class="sc">%&gt;%</span> </span>
<span id="cb161-148"><a href="point-cloud-classification.html#cb161-148" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data))</span>
<span id="cb161-149"><a href="point-cloud-classification.html#cb161-149" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb161-150"><a href="point-cloud-classification.html#cb161-150" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb161-151"><a href="point-cloud-classification.html#cb161-151" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s apply the <code>sf_data_circle_fit()</code> function we just defined fits the best circle using <code>lidR::fit_circle()</code> to each watershed detected segment to get a spatial data frame with the best fitting circle for each segment</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="point-cloud-classification.html#cb162-1" tabindex="-1"></a><span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb162-2"><a href="point-cloud-classification.html#cb162-2" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb162-3"><a href="point-cloud-classification.html#cb162-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb162-4"><a href="point-cloud-classification.html#cb162-4" tabindex="-1"></a>  <span class="fu">sf_data_circle_fit</span>()</span>
<span id="cb162-5"><a href="point-cloud-classification.html#cb162-5" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb162-6"><a href="point-cloud-classification.html#cb162-6" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 997
## Columns: 8
## $ pred_id            &lt;dbl&gt; 8, 12, 20, 24, 32, 38, 50, 52, 53, 54, 55, 57, 76, …
## $ center_x           &lt;dbl&gt; 499945.1, 499740.5, 499719.8, 499778.4, 499466.5, 4…
## $ center_y           &lt;dbl&gt; 4317699, 4317897, 4317852, 4318049, 4317615, 431806…
## $ radius             &lt;dbl&gt; 8.600242e-01, 1.117770e+00, 1.250685e+00, 1.001747e…
## $ covered_arc_degree &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
## $ percentage_inlier  &lt;dbl&gt; 0.17142857, 0.17142857, 0.11111111, 0.16666667, 0.1…
## $ percentage_inside  &lt;dbl&gt; 0.40000000, 0.42857143, 0.49206349, 0.35416667, 0.1…
## $ geometry           &lt;POLYGON [m]&gt; POLYGON ((499946 4317699, 4..., POLYGON ((4…</code></pre>
<p>let’s check out the distribution of the metrics that quantify the fit of the circle</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="point-cloud-classification.html#cb164-1" tabindex="-1"></a>watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb164-2"><a href="point-cloud-classification.html#cb164-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb164-3"><a href="point-cloud-classification.html#cb164-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(pred_id,center_x,center_y,radius)) <span class="sc">%&gt;%</span> </span>
<span id="cb164-4"><a href="point-cloud-classification.html#cb164-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb164-5"><a href="point-cloud-classification.html#cb164-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb164-6"><a href="point-cloud-classification.html#cb164-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb164-7"><a href="point-cloud-classification.html#cb164-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> ggplot2<span class="sc">::</span><span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb164-8"><a href="point-cloud-classification.html#cb164-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;rocket&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb164-9"><a href="point-cloud-classification.html#cb164-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb164-10"><a href="point-cloud-classification.html#cb164-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb164-11"><a href="point-cloud-classification.html#cb164-11" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb164-12"><a href="point-cloud-classification.html#cb164-12" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb164-13"><a href="point-cloud-classification.html#cb164-13" tabindex="-1"></a>      , <span class="at">axis.title.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb164-14"><a href="point-cloud-classification.html#cb164-14" tabindex="-1"></a>      , <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb164-15"><a href="point-cloud-classification.html#cb164-15" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb164-16"><a href="point-cloud-classification.html#cb164-16" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-142-1.png" width="1008" /></p>
<p>let’s look at the best fitting circles using the remaining piles from our example above</p>
<p>example of watershed detected segments as vectors (pink) and best fitting circle of the segments (orange) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="point-cloud-classification.html#cb165-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb165-2"><a href="point-cloud-classification.html#cb165-2" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb165-3"><a href="point-cloud-classification.html#cb165-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb165-4"><a href="point-cloud-classification.html#cb165-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb165-5"><a href="point-cloud-classification.html#cb165-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb165-6"><a href="point-cloud-classification.html#cb165-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb165-7"><a href="point-cloud-classification.html#cb165-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb165-8"><a href="point-cloud-classification.html#cb165-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb165-9"><a href="point-cloud-classification.html#cb165-9" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb165-10"><a href="point-cloud-classification.html#cb165-10" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb165-11"><a href="point-cloud-classification.html#cb165-11" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb165-12"><a href="point-cloud-classification.html#cb165-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb165-13"><a href="point-cloud-classification.html#cb165-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb165-14"><a href="point-cloud-classification.html#cb165-14" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb165-15"><a href="point-cloud-classification.html#cb165-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb165-16"><a href="point-cloud-classification.html#cb165-16" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb165-17"><a href="point-cloud-classification.html#cb165-17" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb165-18"><a href="point-cloud-classification.html#cb165-18" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span></span>
<span id="cb165-19"><a href="point-cloud-classification.html#cb165-19" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb165-20"><a href="point-cloud-classification.html#cb165-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb165-21"><a href="point-cloud-classification.html#cb165-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb165-22"><a href="point-cloud-classification.html#cb165-22" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb165-23"><a href="point-cloud-classification.html#cb165-23" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb165-24"><a href="point-cloud-classification.html#cb165-24" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb165-25"><a href="point-cloud-classification.html#cb165-25" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb165-26"><a href="point-cloud-classification.html#cb165-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb165-27"><a href="point-cloud-classification.html#cb165-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-143-1.png" width="1008" /></p>
<p>the best fitting circles on the linear watershed detected segements are not very well fitting, we can filter using the intersection over union (IoU) between the circle and the predicted segment. we’ll use the IoU function we defined in this <a href="rgb-classification.html#iou_match">earlier section</a>.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="point-cloud-classification.html#cb166-1" tabindex="-1"></a>watershed_circle_fit_iou <span class="ot">&lt;-</span> </span>
<span id="cb166-2"><a href="point-cloud-classification.html#cb166-2" tabindex="-1"></a>  watershed_keep_overlaps_chull_pred_id <span class="sc">%&gt;%</span> </span>
<span id="cb166-3"><a href="point-cloud-classification.html#cb166-3" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb166-4"><a href="point-cloud-classification.html#cb166-4" tabindex="-1"></a>    <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb166-5"><a href="point-cloud-classification.html#cb166-5" tabindex="-1"></a>      <span class="at">gt_inst =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb166-6"><a href="point-cloud-classification.html#cb166-6" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x)</span>
<span id="cb166-7"><a href="point-cloud-classification.html#cb166-7" tabindex="-1"></a>      , <span class="at">gt_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb166-8"><a href="point-cloud-classification.html#cb166-8" tabindex="-1"></a>      , <span class="at">predictions =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb166-9"><a href="point-cloud-classification.html#cb166-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb166-10"><a href="point-cloud-classification.html#cb166-10" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb166-11"><a href="point-cloud-classification.html#cb166-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_pred_id =</span> pred_id)</span>
<span id="cb166-12"><a href="point-cloud-classification.html#cb166-12" tabindex="-1"></a>      , <span class="at">pred_id =</span> <span class="st">&quot;circ_pred_id&quot;</span></span>
<span id="cb166-13"><a href="point-cloud-classification.html#cb166-13" tabindex="-1"></a>      , <span class="at">min_iou_pct =</span> <span class="dv">0</span></span>
<span id="cb166-14"><a href="point-cloud-classification.html#cb166-14" tabindex="-1"></a>    )    </span>
<span id="cb166-15"><a href="point-cloud-classification.html#cb166-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb166-16"><a href="point-cloud-classification.html#cb166-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb166-17"><a href="point-cloud-classification.html#cb166-17" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb166-18"><a href="point-cloud-classification.html#cb166-18" tabindex="-1"></a>watershed_circle_fit_iou <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 992
## Columns: 5
## $ pred_id      &lt;dbl&gt; 8, 12, 20, 24, 32, 38, 50, 52, 53, 54, 55, 57, 76, 89, 10…
## $ i_area       &lt;dbl&gt; 1.3555093, 2.0641867, 3.3892187, 2.2842953, 0.1490024, 3.…
## $ u_area       &lt;dbl&gt; 3.407082e+00, 4.499157e+00, 6.762657e+00, 5.346846e+00, 5…
## $ iou          &lt;dbl&gt; 3.978505e-01, 4.587941e-01, 5.011667e-01, 4.272229e-01, 2…
## $ circ_pred_id &lt;dbl&gt; 8, 12, 20, 24, 32, 38, 50, 52, 53, 54, 55, 57, 76, 89, 10…</code></pre>
<p>what is the distribution of IoU of the watershed segments and the best fit circle of those segments?</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="point-cloud-classification.html#cb168-1" tabindex="-1"></a>watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb168-2"><a href="point-cloud-classification.html#cb168-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> iou)) <span class="sc">+</span></span>
<span id="cb168-3"><a href="point-cloud-classification.html#cb168-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="st">&quot;navy&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb168-4"><a href="point-cloud-classification.html#cb168-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb168-5"><a href="point-cloud-classification.html#cb168-5" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;IoU of the watershed segments and the best fit circle&quot;</span></span>
<span id="cb168-6"><a href="point-cloud-classification.html#cb168-6" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb168-7"><a href="point-cloud-classification.html#cb168-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb168-8"><a href="point-cloud-classification.html#cb168-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb168-9"><a href="point-cloud-classification.html#cb168-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb168-10"><a href="point-cloud-classification.html#cb168-10" tabindex="-1"></a>    <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb168-11"><a href="point-cloud-classification.html#cb168-11" tabindex="-1"></a>    , <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb168-12"><a href="point-cloud-classification.html#cb168-12" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb168-13"><a href="point-cloud-classification.html#cb168-13" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-145-1.png" width="1008" /></p>
<p>let’s color our predicted polygons by the IoU</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="point-cloud-classification.html#cb169-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb169-2"><a href="point-cloud-classification.html#cb169-2" tabindex="-1"></a>  <span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb169-3"><a href="point-cloud-classification.html#cb169-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb169-4"><a href="point-cloud-classification.html#cb169-4" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb169-5"><a href="point-cloud-classification.html#cb169-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb169-6"><a href="point-cloud-classification.html#cb169-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb169-7"><a href="point-cloud-classification.html#cb169-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(watershed_circle_fit_iou, <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span>)</span>
<span id="cb169-8"><a href="point-cloud-classification.html#cb169-8" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> iou)</span>
<span id="cb169-9"><a href="point-cloud-classification.html#cb169-9" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb169-10"><a href="point-cloud-classification.html#cb169-10" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb169-11"><a href="point-cloud-classification.html#cb169-11" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb169-12"><a href="point-cloud-classification.html#cb169-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb169-13"><a href="point-cloud-classification.html#cb169-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb169-14"><a href="point-cloud-classification.html#cb169-14" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb169-15"><a href="point-cloud-classification.html#cb169-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb169-16"><a href="point-cloud-classification.html#cb169-16" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb169-17"><a href="point-cloud-classification.html#cb169-17" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;orangered&quot;</span></span>
<span id="cb169-18"><a href="point-cloud-classification.html#cb169-18" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb169-19"><a href="point-cloud-classification.html#cb169-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb169-20"><a href="point-cloud-classification.html#cb169-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb169-21"><a href="point-cloud-classification.html#cb169-21" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb169-22"><a href="point-cloud-classification.html#cb169-22" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb169-23"><a href="point-cloud-classification.html#cb169-23" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb169-24"><a href="point-cloud-classification.html#cb169-24" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb169-25"><a href="point-cloud-classification.html#cb169-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb169-26"><a href="point-cloud-classification.html#cb169-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_fermenter</span>(</span>
<span id="cb169-27"><a href="point-cloud-classification.html#cb169-27" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">10</span> <span class="co"># 10 use 10 if can go full range 0-1</span></span>
<span id="cb169-28"><a href="point-cloud-classification.html#cb169-28" tabindex="-1"></a>    , <span class="at">palette =</span> <span class="st">&quot;PuOr&quot;</span> <span class="co"># &quot;BrBG&quot;</span></span>
<span id="cb169-29"><a href="point-cloud-classification.html#cb169-29" tabindex="-1"></a>    , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb169-30"><a href="point-cloud-classification.html#cb169-30" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># use c(0,1) if can go full range 0-1</span></span>
<span id="cb169-31"><a href="point-cloud-classification.html#cb169-31" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span>percent</span>
<span id="cb169-32"><a href="point-cloud-classification.html#cb169-32" tabindex="-1"></a>    , <span class="at">na.value =</span> <span class="st">&quot;sienna4&quot;</span></span>
<span id="cb169-33"><a href="point-cloud-classification.html#cb169-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb169-34"><a href="point-cloud-classification.html#cb169-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill=</span><span class="st">&quot;IoU&quot;</span>) <span class="sc">+</span></span>
<span id="cb169-35"><a href="point-cloud-classification.html#cb169-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb169-36"><a href="point-cloud-classification.html#cb169-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb169-37"><a href="point-cloud-classification.html#cb169-37" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb169-38"><a href="point-cloud-classification.html#cb169-38" tabindex="-1"></a>    , <span class="at">legend.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>, <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb169-39"><a href="point-cloud-classification.html#cb169-39" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-146-1.png" width="1008" /></p>
<p>we’ll set a threshold for the minimum IoU to further filter for segments that are approximately round, this filter should remove linear objects from the watershed detections</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="point-cloud-classification.html#cb170-1" tabindex="-1"></a><span class="co"># min required IoU between the predicted pile and the best fit circle of the predicted pile</span></span>
<span id="cb170-2"><a href="point-cloud-classification.html#cb170-2" tabindex="-1"></a>pct_iou_circle_fit <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb170-3"><a href="point-cloud-classification.html#cb170-3" tabindex="-1"></a><span class="co"># compare iou</span></span>
<span id="cb170-4"><a href="point-cloud-classification.html#cb170-4" tabindex="-1"></a>watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb170-5"><a href="point-cloud-classification.html#cb170-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(iou<span class="sc">&gt;=</span>pct_iou_circle_fit) <span class="sc">%&gt;%</span> </span>
<span id="cb170-6"><a href="point-cloud-classification.html#cb170-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span></code></pre></div>
<p>let’s check out the remaining watershed detected piles after filtering out the irregularly shaped segments (filtered using the convex hull) and filtering out the non-circular segments (filtered using circle fitting)</p>
<p>example of filtered watershed detected segments as vectors (pink) compared with the ground truth piles (blue)</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="point-cloud-classification.html#cb171-1" tabindex="-1"></a>ortho_plt_temp <span class="sc">+</span></span>
<span id="cb171-2"><a href="point-cloud-classification.html#cb171-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb171-3"><a href="point-cloud-classification.html#cb171-3" tabindex="-1"></a>    <span class="at">data =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb171-4"><a href="point-cloud-classification.html#cb171-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> pred_id_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb171-5"><a href="point-cloud-classification.html#cb171-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb171-6"><a href="point-cloud-classification.html#cb171-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb171-7"><a href="point-cloud-classification.html#cb171-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_id =</span> <span class="fu">as.factor</span>(pred_id))</span>
<span id="cb171-8"><a href="point-cloud-classification.html#cb171-8" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;hotpink&quot;</span></span>
<span id="cb171-9"><a href="point-cloud-classification.html#cb171-9" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb171-10"><a href="point-cloud-classification.html#cb171-10" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">0</span></span>
<span id="cb171-11"><a href="point-cloud-classification.html#cb171-11" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb171-12"><a href="point-cloud-classification.html#cb171-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb171-13"><a href="point-cloud-classification.html#cb171-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb171-14"><a href="point-cloud-classification.html#cb171-14" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb171-15"><a href="point-cloud-classification.html#cb171-15" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb171-16"><a href="point-cloud-classification.html#cb171-16" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(aoi_temp)</span>
<span id="cb171-17"><a href="point-cloud-classification.html#cb171-17" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb171-18"><a href="point-cloud-classification.html#cb171-18" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb171-19"><a href="point-cloud-classification.html#cb171-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-148-1.png" width="1008" /></p>
<p>As a final step, we’ll use the convex hull shapes of our remaining segments. This helps to smooth out the often “blocky” edges of raster-based segments, which can look like they were generated in Minecraft. Additionally, by removing any segments with overlapping convex hull shapes, we can likely reduce false detections that are actually groups of small trees or shrubs, ensuring our results represent singular slash piles.</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="point-cloud-classification.html#cb172-1" tabindex="-1"></a><span class="co"># make a function to remove overlapping polygons from a sf data frame</span></span>
<span id="cb172-2"><a href="point-cloud-classification.html#cb172-2" tabindex="-1"></a>st_remove_overlaps <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_data) {</span>
<span id="cb172-3"><a href="point-cloud-classification.html#cb172-3" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(sf_data, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must pass `sf` data object&quot;</span>)}</span>
<span id="cb172-4"><a href="point-cloud-classification.html#cb172-4" tabindex="-1"></a>  <span class="co"># if not polygons</span></span>
<span id="cb172-5"><a href="point-cloud-classification.html#cb172-5" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(sf_data, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">all</span>()) ){</span>
<span id="cb172-6"><a href="point-cloud-classification.html#cb172-6" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb172-7"><a href="point-cloud-classification.html#cb172-7" tabindex="-1"></a>      <span class="st">&quot;`sf_data` data must be an `sf` class object with POLYGON geometry (see [sf::st_geometry_type()])&quot;</span></span>
<span id="cb172-8"><a href="point-cloud-classification.html#cb172-8" tabindex="-1"></a>    ))</span>
<span id="cb172-9"><a href="point-cloud-classification.html#cb172-9" tabindex="-1"></a>  }</span>
<span id="cb172-10"><a href="point-cloud-classification.html#cb172-10" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(sf_data)<span class="sc">&lt;=</span><span class="dv">1</span>){<span class="fu">return</span>(sf_data)}</span>
<span id="cb172-11"><a href="point-cloud-classification.html#cb172-11" tabindex="-1"></a>  <span class="co"># combine all touching polygons and keep the ones that overlap multiple from the original polygons</span></span>
<span id="cb172-12"><a href="point-cloud-classification.html#cb172-12" tabindex="-1"></a>  comb_temp <span class="ot">&lt;-</span> sf_data <span class="sc">%&gt;%</span> </span>
<span id="cb172-13"><a href="point-cloud-classification.html#cb172-13" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb172-14"><a href="point-cloud-classification.html#cb172-14" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_union</span>(<span class="at">by_feature =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb172-15"><a href="point-cloud-classification.html#cb172-15" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb172-16"><a href="point-cloud-classification.html#cb172-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb172-17"><a href="point-cloud-classification.html#cb172-17" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb172-18"><a href="point-cloud-classification.html#cb172-18" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_crs</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(sf_data)) <span class="sc">%&gt;%</span> </span>
<span id="cb172-19"><a href="point-cloud-classification.html#cb172-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">new_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb172-20"><a href="point-cloud-classification.html#cb172-20" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(new_id) </span>
<span id="cb172-21"><a href="point-cloud-classification.html#cb172-21" tabindex="-1"></a>  <span class="co"># identify overlaps</span></span>
<span id="cb172-22"><a href="point-cloud-classification.html#cb172-22" tabindex="-1"></a>  overlap_temp <span class="ot">&lt;-</span> comb_temp <span class="sc">%&gt;%</span> </span>
<span id="cb172-23"><a href="point-cloud-classification.html#cb172-23" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_intersection</span>(sf_data) <span class="sc">%&gt;%</span> </span>
<span id="cb172-24"><a href="point-cloud-classification.html#cb172-24" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb172-25"><a href="point-cloud-classification.html#cb172-25" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(new_id) <span class="sc">%&gt;%</span> </span>
<span id="cb172-26"><a href="point-cloud-classification.html#cb172-26" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n_orig =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb172-27"><a href="point-cloud-classification.html#cb172-27" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb172-28"><a href="point-cloud-classification.html#cb172-28" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(n_orig<span class="sc">&gt;=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb172-29"><a href="point-cloud-classification.html#cb172-29" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(new_id)</span>
<span id="cb172-30"><a href="point-cloud-classification.html#cb172-30" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(overlap_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(sf_data)}</span>
<span id="cb172-31"><a href="point-cloud-classification.html#cb172-31" tabindex="-1"></a>  <span class="co"># just get the overlaps</span></span>
<span id="cb172-32"><a href="point-cloud-classification.html#cb172-32" tabindex="-1"></a>  comb_temp <span class="ot">&lt;-</span> comb_temp <span class="sc">%&gt;%</span> </span>
<span id="cb172-33"><a href="point-cloud-classification.html#cb172-33" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(new_id <span class="sc">%in%</span> overlap_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb172-34"><a href="point-cloud-classification.html#cb172-34" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_union</span>()</span>
<span id="cb172-35"><a href="point-cloud-classification.html#cb172-35" tabindex="-1"></a>  <span class="co"># remove from the original data  </span></span>
<span id="cb172-36"><a href="point-cloud-classification.html#cb172-36" tabindex="-1"></a>  <span class="fu">return</span>(sf<span class="sc">::</span><span class="fu">st_difference</span>(sf_data,comb_temp))</span>
<span id="cb172-37"><a href="point-cloud-classification.html#cb172-37" tabindex="-1"></a>}</span></code></pre></div>
<p>save this filtered data as our predictions</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="point-cloud-classification.html#cb173-1" tabindex="-1"></a><span class="co"># save this filtered data as our predictions</span></span>
<span id="cb173-2"><a href="point-cloud-classification.html#cb173-2" tabindex="-1"></a>predicted_watershed_piles_sf <span class="ot">&lt;-</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb173-3"><a href="point-cloud-classification.html#cb173-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb173-4"><a href="point-cloud-classification.html#cb173-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb173-5"><a href="point-cloud-classification.html#cb173-5" tabindex="-1"></a>  <span class="fu">st_remove_overlaps</span>()</span></code></pre></div>
<p>that looks like it did what we wanted it to do (filter out segments that are non-circular)</p>
<p>let’s look at the entire area again after applying this filter plotting the remaining watershed segmented piles (orange) and the actual piles (white)</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="point-cloud-classification.html#cb174-1" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb174-2"><a href="point-cloud-classification.html#cb174-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(ortho_rast, <span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">colNA =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb174-3"><a href="point-cloud-classification.html#cb174-3" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb174-4"><a href="point-cloud-classification.html#cb174-4" tabindex="-1"></a>  predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb174-5"><a href="point-cloud-classification.html#cb174-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb174-6"><a href="point-cloud-classification.html#cb174-6" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;orangered&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb174-7"><a href="point-cloud-classification.html#cb174-7" tabindex="-1"></a>)</span>
<span id="cb174-8"><a href="point-cloud-classification.html#cb174-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb174-9"><a href="point-cloud-classification.html#cb174-9" tabindex="-1"></a>  slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb174-10"><a href="point-cloud-classification.html#cb174-10" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(ortho_rast)) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb174-11"><a href="point-cloud-classification.html#cb174-11" tabindex="-1"></a>  , <span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb174-12"><a href="point-cloud-classification.html#cb174-12" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-151-1.png" width="1008" /></p>
<p>nice! let’s save these data</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="point-cloud-classification.html#cb175-1" tabindex="-1"></a>predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb175-2"><a href="point-cloud-classification.html#cb175-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="st">&quot;../data/predicted_watershed_piles_sf.gpkg&quot;</span>, <span class="at">append =</span> F)</span>
<span id="cb175-3"><a href="point-cloud-classification.html#cb175-3" tabindex="-1"></a>watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb175-4"><a href="point-cloud-classification.html#cb175-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="st">&quot;../data/watershed_ans_poly.gpkg&quot;</span>, <span class="at">append =</span> F)</span></code></pre></div>
<div id="confusion-matrix-evaluation" class="section level5 hasAnchor" number="4.2.1.1.1">
<h5><span class="header-section-number">4.2.1.1.1</span> Confusion matrix evaluation<a href="point-cloud-classification.html#confusion-matrix-evaluation" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We didn’t “train” any model here, just developed a rules-based method for detecting piles from aerial point cloud data. As such, we can evaluate the methods performance on the “full” set of ground truth pile data.</p>
<p>let’s see how we did given the list of predictions compared to the ground truth data using the confusion matrix matching process we outlined in this <a href="rgb-classification.html#iou_match">earlier section</a>.</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="point-cloud-classification.html#cb176-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb176-2"><a href="point-cloud-classification.html#cb176-2" tabindex="-1"></a>  <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb176-3"><a href="point-cloud-classification.html#cb176-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb176-4"><a href="point-cloud-classification.html#cb176-4" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_watershed_piles_sf))</span>
<span id="cb176-5"><a href="point-cloud-classification.html#cb176-5" tabindex="-1"></a>  , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb176-6"><a href="point-cloud-classification.html#cb176-6" tabindex="-1"></a>  , <span class="at">predictions =</span> predicted_watershed_piles_sf</span>
<span id="cb176-7"><a href="point-cloud-classification.html#cb176-7" tabindex="-1"></a>  , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb176-8"><a href="point-cloud-classification.html#cb176-8" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb176-9"><a href="point-cloud-classification.html#cb176-9" tabindex="-1"></a>)</span></code></pre></div>
<p>how did our predictions do using this methodology?</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="point-cloud-classification.html#cb177-1" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb177-2"><a href="point-cloud-classification.html#cb177-2" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb177-3"><a href="point-cloud-classification.html#cb177-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb177-4"><a href="point-cloud-classification.html#cb177-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> (n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy=</span><span class="fl">0.1</span>))</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   match_grp         n pct  
##   &lt;ord&gt;         &lt;int&gt; &lt;chr&gt;
## 1 omission         28 5.5% 
## 2 commission      328 64.2%
## 3 true positive   155 30.3%</code></pre>
<p>let’s look at that spatially</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="point-cloud-classification.html#cb179-1" tabindex="-1"></a>pal_match_grp <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb179-2"><a href="point-cloud-classification.html#cb179-2" tabindex="-1"></a>  <span class="st">&quot;omission&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">1</span>]</span>
<span id="cb179-3"><a href="point-cloud-classification.html#cb179-3" tabindex="-1"></a>  , <span class="st">&quot;commission&quot;</span><span class="ot">=</span> <span class="st">&quot;gray88&quot;</span> <span class="co">#viridis::cividis(3)[2]</span></span>
<span id="cb179-4"><a href="point-cloud-classification.html#cb179-4" tabindex="-1"></a>  , <span class="st">&quot;true positive&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">3</span>]</span>
<span id="cb179-5"><a href="point-cloud-classification.html#cb179-5" tabindex="-1"></a>)</span>
<span id="cb179-6"><a href="point-cloud-classification.html#cb179-6" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb179-7"><a href="point-cloud-classification.html#cb179-7" tabindex="-1"></a><span class="fu">ortho_plt_fn</span>(<span class="at">stand =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(predicted_watershed_piles_sf) <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_as_sfc</span>(), <span class="at">buffer =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb179-8"><a href="point-cloud-classification.html#cb179-8" tabindex="-1"></a><span class="co"># ggplot2::ggplot() +</span></span>
<span id="cb179-9"><a href="point-cloud-classification.html#cb179-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb179-10"><a href="point-cloud-classification.html#cb179-10" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb179-11"><a href="point-cloud-classification.html#cb179-11" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb179-12"><a href="point-cloud-classification.html#cb179-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(watershed_ans_poly_chull)) <span class="sc">%&gt;%</span> </span>
<span id="cb179-13"><a href="point-cloud-classification.html#cb179-13" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb179-14"><a href="point-cloud-classification.html#cb179-14" tabindex="-1"></a>          ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb179-15"><a href="point-cloud-classification.html#cb179-15" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb179-16"><a href="point-cloud-classification.html#cb179-16" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb179-17"><a href="point-cloud-classification.html#cb179-17" tabindex="-1"></a>        )</span>
<span id="cb179-18"><a href="point-cloud-classification.html#cb179-18" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb179-19"><a href="point-cloud-classification.html#cb179-19" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb179-20"><a href="point-cloud-classification.html#cb179-20" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb179-21"><a href="point-cloud-classification.html#cb179-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb179-22"><a href="point-cloud-classification.html#cb179-22" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb179-23"><a href="point-cloud-classification.html#cb179-23" tabindex="-1"></a>      predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb179-24"><a href="point-cloud-classification.html#cb179-24" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb179-25"><a href="point-cloud-classification.html#cb179-25" tabindex="-1"></a>          ground_truth_prediction_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb179-26"><a href="point-cloud-classification.html#cb179-26" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb179-27"><a href="point-cloud-classification.html#cb179-27" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb179-28"><a href="point-cloud-classification.html#cb179-28" tabindex="-1"></a>        )</span>
<span id="cb179-29"><a href="point-cloud-classification.html#cb179-29" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb179-30"><a href="point-cloud-classification.html#cb179-30" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb179-31"><a href="point-cloud-classification.html#cb179-31" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">0.3</span></span>
<span id="cb179-32"><a href="point-cloud-classification.html#cb179-32" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb179-33"><a href="point-cloud-classification.html#cb179-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb179-34"><a href="point-cloud-classification.html#cb179-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb179-35"><a href="point-cloud-classification.html#cb179-35" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb179-36"><a href="point-cloud-classification.html#cb179-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb179-37"><a href="point-cloud-classification.html#cb179-37" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,pal_match_grp[<span class="st">&quot;commission&quot;</span>])))</span>
<span id="cb179-38"><a href="point-cloud-classification.html#cb179-38" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb179-39"><a href="point-cloud-classification.html#cb179-39" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-156-1.png" width="1008" /></p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="point-cloud-classification.html#cb180-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/watershed_pred_match.jpg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="fl">10.5</span>)</span></code></pre></div>
<p>it looks like we did a really good job correctly predicting the location of actual piles (yellow) but that we incorrectly predicted pile locations at a relatively high rate. Our false positive predictions (i.e. commmissions) were frequently located in areas with quaking aspen (<em>Populus tremuloides</em>) which has many more short trees than the treated conifer areas. It also looks like some edge effects are influencing our results and these will likely improve when we filter for instances located within the treated stand.</p>
<p>let’s quickly look at the IoU values on the true positives</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="point-cloud-classification.html#cb181-1" tabindex="-1"></a>ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(iou) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##       iou        
##  Min.   :0.1541  
##  1st Qu.:0.4485  
##  Median :0.5371  
##  Mean   :0.5381  
##  3rd Qu.:0.6410  
##  Max.   :0.8647  
##  NA&#39;s   :356</code></pre>
<p>finally, let’s check our confusion matrix</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="point-cloud-classification.html#cb183-1" tabindex="-1"></a>confusion_matrix_temp <span class="ot">&lt;-</span> <span class="fu">agg_ground_truth_match</span>(ground_truth_prediction_match_ans)</span>
<span id="cb183-2"><a href="point-cloud-classification.html#cb183-2" tabindex="-1"></a>confusion_matrix_scores_temp <span class="ot">&lt;-</span> <span class="fu">confusion_matrix_scores_fn</span>(confusion_matrix_temp)</span>
<span id="cb183-3"><a href="point-cloud-classification.html#cb183-3" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb183-4"><a href="point-cloud-classification.html#cb183-4" tabindex="-1"></a>confusion_matrix_temp <span class="sc">%&gt;%</span> </span>
<span id="cb183-5"><a href="point-cloud-classification.html#cb183-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_n&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb183-6"><a href="point-cloud-classification.html#cb183-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb183-7"><a href="point-cloud-classification.html#cb183-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb183-8"><a href="point-cloud-classification.html#cb183-8" tabindex="-1"></a>    <span class="at">presence =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fn_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb183-9"><a href="point-cloud-classification.html#cb183-9" tabindex="-1"></a>    , <span class="at">estimate =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;tp_n&quot;</span>, <span class="st">&quot;fp_n&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb183-10"><a href="point-cloud-classification.html#cb183-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb183-11"><a href="point-cloud-classification.html#cb183-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb183-12"><a href="point-cloud-classification.html#cb183-12" tabindex="-1"></a>    <span class="at">is_false =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(presence<span class="sc">!=</span>estimate,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb183-13"><a href="point-cloud-classification.html#cb183-13" tabindex="-1"></a>    , <span class="at">presence_fact =</span> <span class="fu">factor</span>(presence,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Observed Absent&quot;</span>, <span class="st">&quot;Observed Present&quot;</span>))</span>
<span id="cb183-14"><a href="point-cloud-classification.html#cb183-14" tabindex="-1"></a>    , <span class="at">estimate_fact =</span> <span class="fu">factor</span>(estimate,<span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Predicted Absent&quot;</span>, <span class="st">&quot;Predicted Present&quot;</span>))</span>
<span id="cb183-15"><a href="point-cloud-classification.html#cb183-15" tabindex="-1"></a>    , <span class="at">pct =</span> value<span class="sc">/</span><span class="fu">sum</span>(value)</span>
<span id="cb183-16"><a href="point-cloud-classification.html#cb183-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb183-17"><a href="point-cloud-classification.html#cb183-17" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> estimate_fact, <span class="at">x =</span> presence_fact)) <span class="sc">+</span></span>
<span id="cb183-18"><a href="point-cloud-classification.html#cb183-18" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> is_false), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>,<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb183-19"><a href="point-cloud-classification.html#cb183-19" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="dv">1</span>)), <span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb183-20"><a href="point-cloud-classification.html#cb183-20" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy=</span><span class="fl">0.1</span>)), <span class="at">vjust =</span> <span class="fl">3.5</span>, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb183-21"><a href="point-cloud-classification.html#cb183-21" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;turquoise&quot;</span>,<span class="st">&quot;tomato2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb183-22"><a href="point-cloud-classification.html#cb183-22" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb183-23"><a href="point-cloud-classification.html#cb183-23" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb183-24"><a href="point-cloud-classification.html#cb183-24" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Predicted&quot;</span></span>
<span id="cb183-25"><a href="point-cloud-classification.html#cb183-25" tabindex="-1"></a>    , <span class="at">x =</span> <span class="st">&quot;Observed&quot;</span></span>
<span id="cb183-26"><a href="point-cloud-classification.html#cb183-26" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb183-27"><a href="point-cloud-classification.html#cb183-27" tabindex="-1"></a>      <span class="st">&quot;True positive rate (recall) = &quot;</span></span>
<span id="cb183-28"><a href="point-cloud-classification.html#cb183-28" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>recall <span class="sc">%&gt;%</span> </span>
<span id="cb183-29"><a href="point-cloud-classification.html#cb183-29" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb183-30"><a href="point-cloud-classification.html#cb183-30" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Precision (PPV) = &quot;</span></span>
<span id="cb183-31"><a href="point-cloud-classification.html#cb183-31" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>precision <span class="sc">%&gt;%</span> </span>
<span id="cb183-32"><a href="point-cloud-classification.html#cb183-32" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb183-33"><a href="point-cloud-classification.html#cb183-33" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">F1-score = &quot;</span></span>
<span id="cb183-34"><a href="point-cloud-classification.html#cb183-34" tabindex="-1"></a>        , confusion_matrix_scores_temp<span class="sc">$</span>f_score <span class="sc">%&gt;%</span> </span>
<span id="cb183-35"><a href="point-cloud-classification.html#cb183-35" tabindex="-1"></a>          scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb183-36"><a href="point-cloud-classification.html#cb183-36" tabindex="-1"></a>    )</span>
<span id="cb183-37"><a href="point-cloud-classification.html#cb183-37" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb183-38"><a href="point-cloud-classification.html#cb183-38" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb183-39"><a href="point-cloud-classification.html#cb183-39" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb183-40"><a href="point-cloud-classification.html#cb183-40" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb183-41"><a href="point-cloud-classification.html#cb183-41" tabindex="-1"></a>    , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb183-42"><a href="point-cloud-classification.html#cb183-42" tabindex="-1"></a>    , <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb183-43"><a href="point-cloud-classification.html#cb183-43" tabindex="-1"></a>    , <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb183-44"><a href="point-cloud-classification.html#cb183-44" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-159-1.png" width="1008" /></p>
<p>compared to our OBIA <a href="rgb-classification.html#obia">approach</a> using the spectral data alone, we improved the recall rate to 84.7% using only the point cloud data without any spectral information. This means that we correctly identified actual piles more often. Our F1-Score of 46.5% also indicates better balance between correctly identifying positive cases (high recall) and minimizing incorrect positive predictions (high precision).</p>
</div>
</div>
<div id="pile-area-rmse" class="section level4 hasAnchor" number="4.2.1.2">
<h4><span class="header-section-number">4.2.1.2</span> Pile area RMSE<a href="point-cloud-classification.html#pile-area-rmse" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s calculate the root mean square error (RMSE) for the pile area in meters squared for the true positive predictions. RMSE captures the ability of the approach to properly represent the 2D spatial coverage of the slash pile.</p>
<p>pile area RMSE is calculated as</p>
<p><span class="math display">\[
\textrm{RMSE} = \sqrt{ \frac{  \sum_{i=1}^{N} (y_{i} - \hat{y_{i}})^{2}}{N}}
\]</span></p>
<p>Where <span class="math inline">\(N\)</span> is equal to the total number of correctly matched piles, <span class="math inline">\(y_i\)</span> is the image annotated pile area and <span class="math inline">\(\hat{y_i}\)</span> is the predicted pile area of <span class="math inline">\(i\)</span> in square meters.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="point-cloud-classification.html#cb184-1" tabindex="-1"></a>area_rmse_temp <span class="ot">&lt;-</span> ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb184-2"><a href="point-cloud-classification.html#cb184-2" tabindex="-1"></a>  <span class="co"># add area of gt</span></span>
<span id="cb184-3"><a href="point-cloud-classification.html#cb184-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb184-4"><a href="point-cloud-classification.html#cb184-4" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb184-5"><a href="point-cloud-classification.html#cb184-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(predicted_watershed_piles_sf)) <span class="sc">%&gt;%</span></span>
<span id="cb184-6"><a href="point-cloud-classification.html#cb184-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">gt_area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb184-7"><a href="point-cloud-classification.html#cb184-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb184-8"><a href="point-cloud-classification.html#cb184-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,gt_area)</span>
<span id="cb184-9"><a href="point-cloud-classification.html#cb184-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb184-10"><a href="point-cloud-classification.html#cb184-10" tabindex="-1"></a>  <span class="co"># add area of pred</span></span>
<span id="cb184-11"><a href="point-cloud-classification.html#cb184-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb184-12"><a href="point-cloud-classification.html#cb184-12" tabindex="-1"></a>    predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb184-13"><a href="point-cloud-classification.html#cb184-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pred_area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb184-14"><a href="point-cloud-classification.html#cb184-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb184-15"><a href="point-cloud-classification.html#cb184-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,pred_area)</span>
<span id="cb184-16"><a href="point-cloud-classification.html#cb184-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb184-17"><a href="point-cloud-classification.html#cb184-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb184-18"><a href="point-cloud-classification.html#cb184-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb184-19"><a href="point-cloud-classification.html#cb184-19" tabindex="-1"></a>    <span class="at">area_diff =</span> pred_area<span class="sc">-</span>gt_area</span>
<span id="cb184-20"><a href="point-cloud-classification.html#cb184-20" tabindex="-1"></a>    , <span class="at">pct_area_diff =</span> area_diff<span class="sc">/</span>gt_area</span>
<span id="cb184-21"><a href="point-cloud-classification.html#cb184-21" tabindex="-1"></a>  )</span></code></pre></div>
<p>first, we’ll look at the percent difference in area for each pile spatially</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="point-cloud-classification.html#cb185-1" tabindex="-1"></a><span class="co"># look at this spatially</span></span>
<span id="cb185-2"><a href="point-cloud-classification.html#cb185-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb185-3"><a href="point-cloud-classification.html#cb185-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb185-4"><a href="point-cloud-classification.html#cb185-4" tabindex="-1"></a>    <span class="at">data =</span> predicted_watershed_piles_sf <span class="sc">%&gt;%</span> </span>
<span id="cb185-5"><a href="point-cloud-classification.html#cb185-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb185-6"><a href="point-cloud-classification.html#cb185-6" tabindex="-1"></a>        area_rmse_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,area_diff,pct_area_diff)</span>
<span id="cb185-7"><a href="point-cloud-classification.html#cb185-7" tabindex="-1"></a>      )</span>
<span id="cb185-8"><a href="point-cloud-classification.html#cb185-8" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> pct_area_diff)</span>
<span id="cb185-9"><a href="point-cloud-classification.html#cb185-9" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb185-10"><a href="point-cloud-classification.html#cb185-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb185-11"><a href="point-cloud-classification.html#cb185-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb185-12"><a href="point-cloud-classification.html#cb185-12" tabindex="-1"></a>    <span class="at">data =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb185-13"><a href="point-cloud-classification.html#cb185-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb185-14"><a href="point-cloud-classification.html#cb185-14" tabindex="-1"></a>        area_rmse_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id)</span>
<span id="cb185-15"><a href="point-cloud-classification.html#cb185-15" tabindex="-1"></a>      )</span>
<span id="cb185-16"><a href="point-cloud-classification.html#cb185-16" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span></span>
<span id="cb185-17"><a href="point-cloud-classification.html#cb185-17" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb185-18"><a href="point-cloud-classification.html#cb185-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_stepsn</span>(</span>
<span id="cb185-19"><a href="point-cloud-classification.html#cb185-19" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">7</span></span>
<span id="cb185-20"><a href="point-cloud-classification.html#cb185-20" tabindex="-1"></a>    , <span class="at">colors =</span> scales<span class="sc">::</span><span class="fu">pal_div_gradient</span>()(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="at">length.out =</span> <span class="dv">7</span>))</span>
<span id="cb185-21"><a href="point-cloud-classification.html#cb185-21" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">fivenum</span>(area_rmse_temp<span class="sc">$</span>pct_area_diff))),<span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">fivenum</span>(area_rmse_temp<span class="sc">$</span>pct_area_diff))))</span>
<span id="cb185-22"><a href="point-cloud-classification.html#cb185-22" tabindex="-1"></a>    , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb185-23"><a href="point-cloud-classification.html#cb185-23" tabindex="-1"></a>    , <span class="at">show.limits =</span> T</span>
<span id="cb185-24"><a href="point-cloud-classification.html#cb185-24" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb185-25"><a href="point-cloud-classification.html#cb185-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;% difference area&quot;</span>) <span class="sc">+</span></span>
<span id="cb185-26"><a href="point-cloud-classification.html#cb185-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-161-1.png" width="1008" /></p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="point-cloud-classification.html#cb186-1" tabindex="-1"></a><span class="co"># and get a summary of the percent error</span></span>
<span id="cb186-2"><a href="point-cloud-classification.html#cb186-2" tabindex="-1"></a><span class="fu">summary</span>(area_rmse_temp<span class="sc">$</span>pct_area_diff)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## -0.8459 -0.5512 -0.4430 -0.4287 -0.3221  0.3020</code></pre>
<p>and let’s look at the distribution of the difference in area (m2) calculated as the predicted area minus the image-annotated area so that negative difference values mean our predictions were smaller and positive values mean our predictions were larger</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="point-cloud-classification.html#cb188-1" tabindex="-1"></a><span class="co"># plot the difference of the area</span></span>
<span id="cb188-2"><a href="point-cloud-classification.html#cb188-2" tabindex="-1"></a>area_rmse_temp <span class="sc">%&gt;%</span> </span>
<span id="cb188-3"><a href="point-cloud-classification.html#cb188-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb188-4"><a href="point-cloud-classification.html#cb188-4" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> area_diff)</span>
<span id="cb188-5"><a href="point-cloud-classification.html#cb188-5" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb188-6"><a href="point-cloud-classification.html#cb188-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&quot;gray&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb188-7"><a href="point-cloud-classification.html#cb188-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(area_rmse_temp<span class="sc">$</span>area_diff)) <span class="sc">+</span></span>
<span id="cb188-8"><a href="point-cloud-classification.html#cb188-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">annotate</span>(</span>
<span id="cb188-9"><a href="point-cloud-classification.html#cb188-9" tabindex="-1"></a>    <span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">median</span>(area_rmse_temp<span class="sc">$</span>area_diff), <span class="at">y =</span> <span class="dv">0</span></span>
<span id="cb188-10"><a href="point-cloud-classification.html#cb188-10" tabindex="-1"></a>    , <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">&quot;median:&quot;</span>,scales<span class="sc">::</span><span class="fu">comma</span>(<span class="fu">median</span>(area_rmse_temp<span class="sc">$</span>area_diff),<span class="at">accuracy=</span><span class="fl">0.1</span>),<span class="st">&quot;m2&quot;</span>)</span>
<span id="cb188-11"><a href="point-cloud-classification.html#cb188-11" tabindex="-1"></a>    , <span class="at">hjust =</span> <span class="fl">1.01</span>, <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb188-12"><a href="point-cloud-classification.html#cb188-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb188-13"><a href="point-cloud-classification.html#cb188-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;density&quot;</span>,<span class="at">x=</span><span class="st">&quot;area difference (m2)&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;Difference in area between predicted and image-annotated slash piles (m2)&quot;</span>) <span class="sc">+</span></span>
<span id="cb188-14"><a href="point-cloud-classification.html#cb188-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb188-15"><a href="point-cloud-classification.html#cb188-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-162-1.png" width="1008" /></p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="point-cloud-classification.html#cb189-1" tabindex="-1"></a>  <span class="co"># ggplot2::geom_boxplot(outliers = F)</span></span></code></pre></div>
<p>finally, let’s calculate area RMSE (m2)</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="point-cloud-classification.html#cb190-1" tabindex="-1"></a>area_rmse_temp <span class="sc">%&gt;%</span> </span>
<span id="cb190-2"><a href="point-cloud-classification.html#cb190-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb190-3"><a href="point-cloud-classification.html#cb190-3" tabindex="-1"></a>    <span class="at">area_diff_sq =</span> <span class="fu">sum</span>(area_diff<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb190-4"><a href="point-cloud-classification.html#cb190-4" tabindex="-1"></a>    , <span class="at">n =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(area_diff),<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb190-5"><a href="point-cloud-classification.html#cb190-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb190-6"><a href="point-cloud-classification.html#cb190-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb190-7"><a href="point-cloud-classification.html#cb190-7" tabindex="-1"></a>    <span class="at">rmse =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb190-8"><a href="point-cloud-classification.html#cb190-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">coalesce</span>(n,<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb190-9"><a href="point-cloud-classification.html#cb190-9" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="fu">sqrt</span>(area_diff_sq<span class="sc">/</span>n)</span>
<span id="cb190-10"><a href="point-cloud-classification.html#cb190-10" tabindex="-1"></a>    )</span>
<span id="cb190-11"><a href="point-cloud-classification.html#cb190-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb190-12"><a href="point-cloud-classification.html#cb190-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rmse)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 1
##    rmse
##   &lt;dbl&gt;
## 1  15.4</code></pre>
<p>that’s not very good, we’ll have to check out if those image-annotated areas are accurate</p>
</div>
</div>
<div id="watershed-segmentation-sensitivity" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Watershed Segmentation Sensitivity<a href="point-cloud-classification.html#watershed-segmentation-sensitivity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we’ll perform sensitivity testing of our rules-based slash pile detection methodology which uses a CHM input raster generated directly from the aerial point cloud data. This method does not require any training data for model building and can potentially be used broadly across different domains.</p>
<p>The rule-based method for slash pile detection using CHM raster data generally follows this outline:</p>
<ul>
<li><em>CHM Generation</em>: A Canopy Height Model (CHM) is generated, effectively representing a Digital Surface Model (DSM) with the ground removed, ensuring all values are heights above bare earth.</li>
<li><em>Height Filtering</em>: A maximum height filter is applied to the CHM to retaining only raster cells below a maximum expected slash pile height (e.g. 4 m).</li>
<li><em>Candidate Segmentation</em>: Watershed segmentation is then used on this filtered CHM to delineate candidate slash pile locations.
<em>Irregularity Filtering</em>: Candidate pile locations are initially filtered to remove highly irregular shapes by assessing their overlap with their convex hull (e.g. &gt;70% overlap). This step helps exclude lower tree branches (which can appear donut-shaped in the lower CHM slice) and unorganized coarse woody debris.</li>
<li><em>Circularity Filtering</em>: Least squares circle fitting is applied to the remaining candidate segments, and segments are filtered based on a high Intersection over Union (IoU) with the best-fit circle (e.g., &gt;50%). This removes non-circular features such as boulders and downed tree stems.
<em>Shape Refinement &amp; Overlap Removal</em>: Lastly, segments are smoothed using their convex hull to remove the “blocky” raster edges (like they were made in Minecraft). Overlapping convex hull shapes are then removed to prevent false positives from clustered small trees or shrubs, ensuring singular pile detections.</li>
</ul>
<div id="watershed-pile-detection-function" class="section level4 hasAnchor" number="4.2.2.1">
<h4><span class="header-section-number">4.2.2.1</span> Watershed Pile Detection Function<a href="point-cloud-classification.html#watershed-pile-detection-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s package all of the steps we used into a single function which can possibly be integrated into the <code>cloud2trees</code> package.</p>
<p>The parameters are defined as follows:</p>
<ul>
<li><code>max_ht_m</code> : numeric. The maximum height (in meters) a slash pile is expected to be. This value helps us focus on a specific “slice” of the data, ignoring anything taller than a typical pile.</li>
<li><code>min_area_m2</code> : numeric. The smallest 2D area (in square meters) a detected pile must cover to be considered valid.</li>
<li><code>max_area_m2</code> : numeric. The largest 2D area (in square meters) a detected pile can cover to be considered valid.</li>
<li><code>convexity_pct</code> : numeric. A value between 0 and 1 that controls how strict the filtering is for regularly shaped piles. A value of 1 means only piles that are perfectly smooth and rounded, with no dents or inward curves are kept. A value of 0 allows for both perfectly regular and very irregular shapes. This filter works alongside <code>circle_fit_iou_pct</code> to refine the pile’s overall shape.</li>
<li><code>circle_fit_iou_pct</code> : numeric. A value between 0 and 1 that controls how the filtering is for circular pile shapes. Setting it to 1 means only piles that are perfectly circular are kept. A value of 0 allows for a wide range of shapes, including very circular and non-circular ones (like long, straight lines).</li>
<li><code>smooth_segs</code> : logical. Setting this option to TRUE will: 1) smooth out the “blocky” edges of detected piles (which can look like they were made in Minecraft) by using their overall shape; and 2) remove any detected piles that overlap significantly with other smoothed piles to help ensure each detection is a single slash pile, not a cluster of small trees or shrubs.</li>
</ul>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="point-cloud-classification.html#cb192-1" tabindex="-1"></a>slash_pile_detect_watershed <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb192-2"><a href="point-cloud-classification.html#cb192-2" tabindex="-1"></a>  chm_rast</span>
<span id="cb192-3"><a href="point-cloud-classification.html#cb192-3" tabindex="-1"></a>  <span class="do">#### height and area thresholds for the detected piles</span></span>
<span id="cb192-4"><a href="point-cloud-classification.html#cb192-4" tabindex="-1"></a>  <span class="co"># these should be based on data from the literature or expectations based on the prescription</span></span>
<span id="cb192-5"><a href="point-cloud-classification.html#cb192-5" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span> <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb192-6"><a href="point-cloud-classification.html#cb192-6" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="dv">2</span> <span class="co"># set the min expected pile area</span></span>
<span id="cb192-7"><a href="point-cloud-classification.html#cb192-7" tabindex="-1"></a>  , <span class="at">max_area_m2 =</span> <span class="dv">50</span> <span class="co"># set the max expected pile area</span></span>
<span id="cb192-8"><a href="point-cloud-classification.html#cb192-8" tabindex="-1"></a>  <span class="do">#### irregularity filtering</span></span>
<span id="cb192-9"><a href="point-cloud-classification.html#cb192-9" tabindex="-1"></a>  <span class="co"># 1 = perfectly convex (no inward angles); 0 = so many inward angles</span></span>
<span id="cb192-10"><a href="point-cloud-classification.html#cb192-10" tabindex="-1"></a>  <span class="co"># values closer to 1 remove more irregular segments; </span></span>
<span id="cb192-11"><a href="point-cloud-classification.html#cb192-11" tabindex="-1"></a>    <span class="co"># values closer to 0 keep more irregular segments (and also regular segments)</span></span>
<span id="cb192-12"><a href="point-cloud-classification.html#cb192-12" tabindex="-1"></a>  <span class="co"># these will all be further filtered for their circularity and later smoothed to remove blocky edges</span></span>
<span id="cb192-13"><a href="point-cloud-classification.html#cb192-13" tabindex="-1"></a>  <span class="co"># and most inward angles by applying a convex hull to the original detected segment</span></span>
<span id="cb192-14"><a href="point-cloud-classification.html#cb192-14" tabindex="-1"></a>  , <span class="at">convexity_pct =</span> <span class="fl">0.7</span> <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb192-15"><a href="point-cloud-classification.html#cb192-15" tabindex="-1"></a>  <span class="do">#### circularity filtering</span></span>
<span id="cb192-16"><a href="point-cloud-classification.html#cb192-16" tabindex="-1"></a>  <span class="co"># 1 = perfectly circular; 0 = not circular (e.g. linear) but also circular</span></span>
<span id="cb192-17"><a href="point-cloud-classification.html#cb192-17" tabindex="-1"></a>  <span class="co"># min required IoU between the predicted pile and the best fit circle of the predicted pile</span></span>
<span id="cb192-18"><a href="point-cloud-classification.html#cb192-18" tabindex="-1"></a>  , <span class="at">circle_fit_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb192-19"><a href="point-cloud-classification.html#cb192-19" tabindex="-1"></a>  <span class="do">#### shape refinement &amp; overlap removal</span></span>
<span id="cb192-20"><a href="point-cloud-classification.html#cb192-20" tabindex="-1"></a>  <span class="do">## smooth_segs = T ... convex hulls of raster detected segments are returned, any that overlap are removed</span></span>
<span id="cb192-21"><a href="point-cloud-classification.html#cb192-21" tabindex="-1"></a>  <span class="do">## smooth_segs = F ... raster detected segments are returned (blocky) if they meet all prior rules</span></span>
<span id="cb192-22"><a href="point-cloud-classification.html#cb192-22" tabindex="-1"></a>  , <span class="at">smooth_segs =</span> T</span>
<span id="cb192-23"><a href="point-cloud-classification.html#cb192-23" tabindex="-1"></a>) {</span>
<span id="cb192-24"><a href="point-cloud-classification.html#cb192-24" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb192-25"><a href="point-cloud-classification.html#cb192-25" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb192-26"><a href="point-cloud-classification.html#cb192-26" tabindex="-1"></a>  <span class="co"># just get the first layer and &quot;slice&quot; the raster based on the height threshold</span></span>
<span id="cb192-27"><a href="point-cloud-classification.html#cb192-27" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb192-28"><a href="point-cloud-classification.html#cb192-28" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb192-29"><a href="point-cloud-classification.html#cb192-29" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb192-30"><a href="point-cloud-classification.html#cb192-30" tabindex="-1"></a>  </span>
<span id="cb192-31"><a href="point-cloud-classification.html#cb192-31" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-32"><a href="point-cloud-classification.html#cb192-32" tabindex="-1"></a>  <span class="do">## 1) watershed segmentation</span></span>
<span id="cb192-33"><a href="point-cloud-classification.html#cb192-33" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-34"><a href="point-cloud-classification.html#cb192-34" tabindex="-1"></a>    <span class="co"># let&#39;s run watershed segmentation using `lidR::watershed()` which is based on the bioconductor package `EBIimage`</span></span>
<span id="cb192-35"><a href="point-cloud-classification.html#cb192-35" tabindex="-1"></a>    <span class="co"># return is a raster with the first layer representing the identified watershed segments</span></span>
<span id="cb192-36"><a href="point-cloud-classification.html#cb192-36" tabindex="-1"></a>    watershed_ans <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb192-37"><a href="point-cloud-classification.html#cb192-37" tabindex="-1"></a>        <span class="at">chm =</span> chm_rast</span>
<span id="cb192-38"><a href="point-cloud-classification.html#cb192-38" tabindex="-1"></a>        , <span class="at">th_tree =</span> <span class="fl">0.5</span> <span class="co"># this would be the minimum expected pile height</span></span>
<span id="cb192-39"><a href="point-cloud-classification.html#cb192-39" tabindex="-1"></a>      )()</span>
<span id="cb192-40"><a href="point-cloud-classification.html#cb192-40" tabindex="-1"></a>    <span class="fu">names</span>(watershed_ans) <span class="ot">&lt;-</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb192-41"><a href="point-cloud-classification.html#cb192-41" tabindex="-1"></a>    </span>
<span id="cb192-42"><a href="point-cloud-classification.html#cb192-42" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-43"><a href="point-cloud-classification.html#cb192-43" tabindex="-1"></a>  <span class="do">## 1.5) segmentation filtering using raster-based area and volume </span></span>
<span id="cb192-44"><a href="point-cloud-classification.html#cb192-44" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-45"><a href="point-cloud-classification.html#cb192-45" tabindex="-1"></a>    <span class="co"># first, calculate the area of each cell</span></span>
<span id="cb192-46"><a href="point-cloud-classification.html#cb192-46" tabindex="-1"></a>    area_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(chm_rast)</span>
<span id="cb192-47"><a href="point-cloud-classification.html#cb192-47" tabindex="-1"></a>    <span class="fu">names</span>(area_rast) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb192-48"><a href="point-cloud-classification.html#cb192-48" tabindex="-1"></a>    <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb192-49"><a href="point-cloud-classification.html#cb192-49" tabindex="-1"></a>    vol_rast <span class="ot">&lt;-</span> area_rast<span class="sc">*</span>chm_rast</span>
<span id="cb192-50"><a href="point-cloud-classification.html#cb192-50" tabindex="-1"></a>    <span class="fu">names</span>(vol_rast) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb192-51"><a href="point-cloud-classification.html#cb192-51" tabindex="-1"></a>    <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb192-52"><a href="point-cloud-classification.html#cb192-52" tabindex="-1"></a>    area_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> area_rast, <span class="at">z =</span> watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb192-53"><a href="point-cloud-classification.html#cb192-53" tabindex="-1"></a>    <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb192-54"><a href="point-cloud-classification.html#cb192-54" tabindex="-1"></a>    vol_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> vol_rast, <span class="at">z =</span> watershed_ans, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb192-55"><a href="point-cloud-classification.html#cb192-55" tabindex="-1"></a>    <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb192-56"><a href="point-cloud-classification.html#cb192-56" tabindex="-1"></a>    ht_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(<span class="at">x =</span> chm_rast, <span class="at">z =</span> watershed_ans, <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb192-57"><a href="point-cloud-classification.html#cb192-57" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">max_height_m=</span><span class="dv">2</span>)</span>
<span id="cb192-58"><a href="point-cloud-classification.html#cb192-58" tabindex="-1"></a>    </span>
<span id="cb192-59"><a href="point-cloud-classification.html#cb192-59" tabindex="-1"></a>    <span class="co"># let&#39;s convert the watershed-detected segments from raster to vector data </span></span>
<span id="cb192-60"><a href="point-cloud-classification.html#cb192-60" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb192-61"><a href="point-cloud-classification.html#cb192-61" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb192-62"><a href="point-cloud-classification.html#cb192-62" tabindex="-1"></a>      watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb192-63"><a href="point-cloud-classification.html#cb192-63" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb192-64"><a href="point-cloud-classification.html#cb192-64" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-65"><a href="point-cloud-classification.html#cb192-65" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-66"><a href="point-cloud-classification.html#cb192-66" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-67"><a href="point-cloud-classification.html#cb192-67" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb192-68"><a href="point-cloud-classification.html#cb192-68" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb192-69"><a href="point-cloud-classification.html#cb192-69" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-70"><a href="point-cloud-classification.html#cb192-70" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb192-71"><a href="point-cloud-classification.html#cb192-71" tabindex="-1"></a>    </span>
<span id="cb192-72"><a href="point-cloud-classification.html#cb192-72" tabindex="-1"></a>    <span class="co"># add area and volume to our vector data  </span></span>
<span id="cb192-73"><a href="point-cloud-classification.html#cb192-73" tabindex="-1"></a>    <span class="co"># we&#39;ll do this with a slick trick to perform multiple joins succinctly using purrr::reduce</span></span>
<span id="cb192-74"><a href="point-cloud-classification.html#cb192-74" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span> </span>
<span id="cb192-75"><a href="point-cloud-classification.html#cb192-75" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">reduce</span>(</span>
<span id="cb192-76"><a href="point-cloud-classification.html#cb192-76" tabindex="-1"></a>        <span class="fu">list</span>(watershed_ans_poly, area_df, vol_df, ht_df)</span>
<span id="cb192-77"><a href="point-cloud-classification.html#cb192-77" tabindex="-1"></a>        , dplyr<span class="sc">::</span>left_join</span>
<span id="cb192-78"><a href="point-cloud-classification.html#cb192-78" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&#39;pred_id&#39;</span></span>
<span id="cb192-79"><a href="point-cloud-classification.html#cb192-79" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb192-80"><a href="point-cloud-classification.html#cb192-80" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb192-81"><a href="point-cloud-classification.html#cb192-81" tabindex="-1"></a>        <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb192-82"><a href="point-cloud-classification.html#cb192-82" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb192-83"><a href="point-cloud-classification.html#cb192-83" tabindex="-1"></a>      <span class="co"># filter out the segments that don&#39;t meet the size thresholds</span></span>
<span id="cb192-84"><a href="point-cloud-classification.html#cb192-84" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb192-85"><a href="point-cloud-classification.html#cb192-85" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&gt;=</span> min_area_m2</span>
<span id="cb192-86"><a href="point-cloud-classification.html#cb192-86" tabindex="-1"></a>        <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(area_m2,<span class="dv">0</span>) <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb192-87"><a href="point-cloud-classification.html#cb192-87" tabindex="-1"></a>      )</span>
<span id="cb192-88"><a href="point-cloud-classification.html#cb192-88" tabindex="-1"></a>    </span>
<span id="cb192-89"><a href="point-cloud-classification.html#cb192-89" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">&lt;</span><span class="dv">1</span>){</span>
<span id="cb192-90"><a href="point-cloud-classification.html#cb192-90" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb192-91"><a href="point-cloud-classification.html#cb192-91" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and expected size thresholds&quot;</span></span>
<span id="cb192-92"><a href="point-cloud-classification.html#cb192-92" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `max_ht_m`, `min_area_m2`, `max_area_m2` &quot;</span></span>
<span id="cb192-93"><a href="point-cloud-classification.html#cb192-93" tabindex="-1"></a>      ))</span>
<span id="cb192-94"><a href="point-cloud-classification.html#cb192-94" tabindex="-1"></a>    }</span>
<span id="cb192-95"><a href="point-cloud-classification.html#cb192-95" tabindex="-1"></a>    </span>
<span id="cb192-96"><a href="point-cloud-classification.html#cb192-96" tabindex="-1"></a>    <span class="co"># and create a convex hull of the shapes for irregularity filtering and smoothing</span></span>
<span id="cb192-97"><a href="point-cloud-classification.html#cb192-97" tabindex="-1"></a>    <span class="co"># convex hulls of segments</span></span>
<span id="cb192-98"><a href="point-cloud-classification.html#cb192-98" tabindex="-1"></a>    watershed_ans_poly_chull <span class="ot">&lt;-</span></span>
<span id="cb192-99"><a href="point-cloud-classification.html#cb192-99" tabindex="-1"></a>      watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb192-100"><a href="point-cloud-classification.html#cb192-100" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-101"><a href="point-cloud-classification.html#cb192-101" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-102"><a href="point-cloud-classification.html#cb192-102" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-103"><a href="point-cloud-classification.html#cb192-103" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb192-104"><a href="point-cloud-classification.html#cb192-104" tabindex="-1"></a>    </span>
<span id="cb192-105"><a href="point-cloud-classification.html#cb192-105" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-106"><a href="point-cloud-classification.html#cb192-106" tabindex="-1"></a>  <span class="do">## 2) irregularity filtering</span></span>
<span id="cb192-107"><a href="point-cloud-classification.html#cb192-107" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-108"><a href="point-cloud-classification.html#cb192-108" tabindex="-1"></a>    <span class="co"># let&#39;s first filter out segments that have holes in them </span></span>
<span id="cb192-109"><a href="point-cloud-classification.html#cb192-109" tabindex="-1"></a>    <span class="co"># or are very irregularly shaped by comparing the area of the polygon and convex hull</span></span>
<span id="cb192-110"><a href="point-cloud-classification.html#cb192-110" tabindex="-1"></a></span>
<span id="cb192-111"><a href="point-cloud-classification.html#cb192-111" tabindex="-1"></a>    <span class="co"># convexity_pct = min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb192-112"><a href="point-cloud-classification.html#cb192-112" tabindex="-1"></a>    <span class="cf">if</span>(convexity_pct<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb192-113"><a href="point-cloud-classification.html#cb192-113" tabindex="-1"></a>      watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span> watershed_ans_poly<span class="sc">$</span>pred_id</span>
<span id="cb192-114"><a href="point-cloud-classification.html#cb192-114" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb192-115"><a href="point-cloud-classification.html#cb192-115" tabindex="-1"></a>      <span class="co"># compare areas</span></span>
<span id="cb192-116"><a href="point-cloud-classification.html#cb192-116" tabindex="-1"></a>      watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb192-117"><a href="point-cloud-classification.html#cb192-117" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">poly_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb192-118"><a href="point-cloud-classification.html#cb192-118" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb192-119"><a href="point-cloud-classification.html#cb192-119" tabindex="-1"></a>          watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb192-120"><a href="point-cloud-classification.html#cb192-120" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb192-121"><a href="point-cloud-classification.html#cb192-121" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb192-122"><a href="point-cloud-classification.html#cb192-122" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb192-123"><a href="point-cloud-classification.html#cb192-123" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb192-124"><a href="point-cloud-classification.html#cb192-124" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb192-125"><a href="point-cloud-classification.html#cb192-125" tabindex="-1"></a>          <span class="at">pct_chull =</span> poly_area_m2<span class="sc">/</span>chull_area_m2</span>
<span id="cb192-126"><a href="point-cloud-classification.html#cb192-126" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb192-127"><a href="point-cloud-classification.html#cb192-127" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb192-128"><a href="point-cloud-classification.html#cb192-128" tabindex="-1"></a>          pct_chull <span class="sc">&gt;=</span> convexity_pct</span>
<span id="cb192-129"><a href="point-cloud-classification.html#cb192-129" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb192-130"><a href="point-cloud-classification.html#cb192-130" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span>
<span id="cb192-131"><a href="point-cloud-classification.html#cb192-131" tabindex="-1"></a>    }</span>
<span id="cb192-132"><a href="point-cloud-classification.html#cb192-132" tabindex="-1"></a>    </span>
<span id="cb192-133"><a href="point-cloud-classification.html#cb192-133" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb192-134"><a href="point-cloud-classification.html#cb192-134" tabindex="-1"></a>      <span class="fu">identical</span>(watershed_keep_overlaps_chull_pred_id, <span class="fu">numeric</span>(<span class="dv">0</span>))</span>
<span id="cb192-135"><a href="point-cloud-classification.html#cb192-135" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.null</span>(watershed_keep_overlaps_chull_pred_id))</span>
<span id="cb192-136"><a href="point-cloud-classification.html#cb192-136" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(watershed_keep_overlaps_chull_pred_id))</span>
<span id="cb192-137"><a href="point-cloud-classification.html#cb192-137" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">length</span>(watershed_keep_overlaps_chull_pred_id)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb192-138"><a href="point-cloud-classification.html#cb192-138" tabindex="-1"></a>    ){</span>
<span id="cb192-139"><a href="point-cloud-classification.html#cb192-139" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb192-140"><a href="point-cloud-classification.html#cb192-140" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and irregularity expectations&quot;</span></span>
<span id="cb192-141"><a href="point-cloud-classification.html#cb192-141" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `convexity_pct` &quot;</span></span>
<span id="cb192-142"><a href="point-cloud-classification.html#cb192-142" tabindex="-1"></a>      ))</span>
<span id="cb192-143"><a href="point-cloud-classification.html#cb192-143" tabindex="-1"></a>    }</span>
<span id="cb192-144"><a href="point-cloud-classification.html#cb192-144" tabindex="-1"></a>  </span>
<span id="cb192-145"><a href="point-cloud-classification.html#cb192-145" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-146"><a href="point-cloud-classification.html#cb192-146" tabindex="-1"></a>  <span class="do">## 3) circularity filtering</span></span>
<span id="cb192-147"><a href="point-cloud-classification.html#cb192-147" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-148"><a href="point-cloud-classification.html#cb192-148" tabindex="-1"></a>    <span class="co"># let&#39;s apply a circle-fitting algorithm to remove non-circular segments from the remaining segments</span></span>
<span id="cb192-149"><a href="point-cloud-classification.html#cb192-149" tabindex="-1"></a>    <span class="co"># let&#39;s apply the `sf_data_circle_fit()` function that</span></span>
<span id="cb192-150"><a href="point-cloud-classification.html#cb192-150" tabindex="-1"></a>    <span class="co"># fits the best circle using `lidR::fit_circle()` to each watershed detected segment </span></span>
<span id="cb192-151"><a href="point-cloud-classification.html#cb192-151" tabindex="-1"></a>    <span class="co"># to get a spatial data frame with the best fitting circle for each segment</span></span>
<span id="cb192-152"><a href="point-cloud-classification.html#cb192-152" tabindex="-1"></a></span>
<span id="cb192-153"><a href="point-cloud-classification.html#cb192-153" tabindex="-1"></a>    <span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb192-154"><a href="point-cloud-classification.html#cb192-154" tabindex="-1"></a>    watershed_ans_poly_circle_fit <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb192-155"><a href="point-cloud-classification.html#cb192-155" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb192-156"><a href="point-cloud-classification.html#cb192-156" tabindex="-1"></a>      <span class="fu">sf_data_circle_fit</span>()</span>
<span id="cb192-157"><a href="point-cloud-classification.html#cb192-157" tabindex="-1"></a>    </span>
<span id="cb192-158"><a href="point-cloud-classification.html#cb192-158" tabindex="-1"></a>    <span class="co"># filter using the intersection over union (IoU) between the circle and the predicted segment. </span></span>
<span id="cb192-159"><a href="point-cloud-classification.html#cb192-159" tabindex="-1"></a>    <span class="co"># we&#39;ll use the IoU function we defined </span></span>
<span id="cb192-160"><a href="point-cloud-classification.html#cb192-160" tabindex="-1"></a>    <span class="co"># we map over this to only compare the segment to it&#39;s own best circle fit...not all</span></span>
<span id="cb192-161"><a href="point-cloud-classification.html#cb192-161" tabindex="-1"></a>    <span class="co"># we should consider doing this in bulk.....another day</span></span>
<span id="cb192-162"><a href="point-cloud-classification.html#cb192-162" tabindex="-1"></a>    watershed_circle_fit_iou <span class="ot">&lt;-</span> </span>
<span id="cb192-163"><a href="point-cloud-classification.html#cb192-163" tabindex="-1"></a>      watershed_keep_overlaps_chull_pred_id <span class="sc">%&gt;%</span> </span>
<span id="cb192-164"><a href="point-cloud-classification.html#cb192-164" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb192-165"><a href="point-cloud-classification.html#cb192-165" tabindex="-1"></a>        <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb192-166"><a href="point-cloud-classification.html#cb192-166" tabindex="-1"></a>          <span class="at">gt_inst =</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb192-167"><a href="point-cloud-classification.html#cb192-167" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x)</span>
<span id="cb192-168"><a href="point-cloud-classification.html#cb192-168" tabindex="-1"></a>          , <span class="at">gt_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb192-169"><a href="point-cloud-classification.html#cb192-169" tabindex="-1"></a>          , <span class="at">predictions =</span> watershed_ans_poly_circle_fit <span class="sc">%&gt;%</span> </span>
<span id="cb192-170"><a href="point-cloud-classification.html#cb192-170" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb192-171"><a href="point-cloud-classification.html#cb192-171" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb192-172"><a href="point-cloud-classification.html#cb192-172" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_pred_id =</span> pred_id)</span>
<span id="cb192-173"><a href="point-cloud-classification.html#cb192-173" tabindex="-1"></a>          , <span class="at">pred_id =</span> <span class="st">&quot;circ_pred_id&quot;</span></span>
<span id="cb192-174"><a href="point-cloud-classification.html#cb192-174" tabindex="-1"></a>          , <span class="at">min_iou_pct =</span> <span class="dv">0</span> <span class="co"># set to 0 just to return pct</span></span>
<span id="cb192-175"><a href="point-cloud-classification.html#cb192-175" tabindex="-1"></a>        )    </span>
<span id="cb192-176"><a href="point-cloud-classification.html#cb192-176" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb192-177"><a href="point-cloud-classification.html#cb192-177" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb192-178"><a href="point-cloud-classification.html#cb192-178" tabindex="-1"></a>    </span>
<span id="cb192-179"><a href="point-cloud-classification.html#cb192-179" tabindex="-1"></a>    <span class="co"># threshold for the minimum IoU to further filter for segments that are approximately round, </span></span>
<span id="cb192-180"><a href="point-cloud-classification.html#cb192-180" tabindex="-1"></a>    <span class="co"># this filter should remove linear objects from the watershed detections</span></span>
<span id="cb192-181"><a href="point-cloud-classification.html#cb192-181" tabindex="-1"></a>      <span class="co"># compare iou</span></span>
<span id="cb192-182"><a href="point-cloud-classification.html#cb192-182" tabindex="-1"></a>      <span class="cf">if</span>(circle_fit_iou_pct<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb192-183"><a href="point-cloud-classification.html#cb192-183" tabindex="-1"></a>        watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_keep_overlaps_chull_pred_id</span>
<span id="cb192-184"><a href="point-cloud-classification.html#cb192-184" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb192-185"><a href="point-cloud-classification.html#cb192-185" tabindex="-1"></a>        watershed_keep_circle_fit_pred_id <span class="ot">&lt;-</span> watershed_circle_fit_iou <span class="sc">%&gt;%</span> </span>
<span id="cb192-186"><a href="point-cloud-classification.html#cb192-186" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(iou<span class="sc">&gt;=</span>circle_fit_iou_pct) <span class="sc">%&gt;%</span> </span>
<span id="cb192-187"><a href="point-cloud-classification.html#cb192-187" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id) </span>
<span id="cb192-188"><a href="point-cloud-classification.html#cb192-188" tabindex="-1"></a>      }</span>
<span id="cb192-189"><a href="point-cloud-classification.html#cb192-189" tabindex="-1"></a>      </span>
<span id="cb192-190"><a href="point-cloud-classification.html#cb192-190" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb192-191"><a href="point-cloud-classification.html#cb192-191" tabindex="-1"></a>      <span class="fu">identical</span>(watershed_keep_circle_fit_pred_id, <span class="fu">numeric</span>(<span class="dv">0</span>))</span>
<span id="cb192-192"><a href="point-cloud-classification.html#cb192-192" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.null</span>(watershed_keep_circle_fit_pred_id))</span>
<span id="cb192-193"><a href="point-cloud-classification.html#cb192-193" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(watershed_keep_circle_fit_pred_id))</span>
<span id="cb192-194"><a href="point-cloud-classification.html#cb192-194" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">length</span>(watershed_keep_circle_fit_pred_id)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb192-195"><a href="point-cloud-classification.html#cb192-195" tabindex="-1"></a>    ){</span>
<span id="cb192-196"><a href="point-cloud-classification.html#cb192-196" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb192-197"><a href="point-cloud-classification.html#cb192-197" tabindex="-1"></a>        <span class="st">&quot;no segments detected using the given CHM and circularity expectations&quot;</span></span>
<span id="cb192-198"><a href="point-cloud-classification.html#cb192-198" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">     try adjusting `circle_fit_iou_pct` &quot;</span></span>
<span id="cb192-199"><a href="point-cloud-classification.html#cb192-199" tabindex="-1"></a>      ))</span>
<span id="cb192-200"><a href="point-cloud-classification.html#cb192-200" tabindex="-1"></a>    }</span>
<span id="cb192-201"><a href="point-cloud-classification.html#cb192-201" tabindex="-1"></a>    </span>
<span id="cb192-202"><a href="point-cloud-classification.html#cb192-202" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-203"><a href="point-cloud-classification.html#cb192-203" tabindex="-1"></a>  <span class="do">## 4) shape refinement &amp; overlap removal</span></span>
<span id="cb192-204"><a href="point-cloud-classification.html#cb192-204" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb192-205"><a href="point-cloud-classification.html#cb192-205" tabindex="-1"></a>    <span class="co"># use the convex hull shapes of our remaining segments. </span></span>
<span id="cb192-206"><a href="point-cloud-classification.html#cb192-206" tabindex="-1"></a>    <span class="co"># This helps to smooth out the often &#39;blocky&#39; edges of raster-based segments</span></span>
<span id="cb192-207"><a href="point-cloud-classification.html#cb192-207" tabindex="-1"></a>    <span class="co"># , which can look like they were generated in Minecraft. </span></span>
<span id="cb192-208"><a href="point-cloud-classification.html#cb192-208" tabindex="-1"></a>    <span class="co"># Additionally, by removing any segments with overlapping convex hull shapes, </span></span>
<span id="cb192-209"><a href="point-cloud-classification.html#cb192-209" tabindex="-1"></a>    <span class="co"># we can likely reduce false detections that are actually groups of small trees or shrubs, </span></span>
<span id="cb192-210"><a href="point-cloud-classification.html#cb192-210" tabindex="-1"></a>    <span class="co"># ensuring our results represent singular slash piles.</span></span>
<span id="cb192-211"><a href="point-cloud-classification.html#cb192-211" tabindex="-1"></a>    </span>
<span id="cb192-212"><a href="point-cloud-classification.html#cb192-212" tabindex="-1"></a>    <span class="cf">if</span>(smooth_segs){</span>
<span id="cb192-213"><a href="point-cloud-classification.html#cb192-213" tabindex="-1"></a>      return_dta <span class="ot">&lt;-</span> watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb192-214"><a href="point-cloud-classification.html#cb192-214" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb192-215"><a href="point-cloud-classification.html#cb192-215" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb192-216"><a href="point-cloud-classification.html#cb192-216" tabindex="-1"></a>        <span class="fu">st_remove_overlaps</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb192-217"><a href="point-cloud-classification.html#cb192-217" tabindex="-1"></a>        <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb192-218"><a href="point-cloud-classification.html#cb192-218" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb192-219"><a href="point-cloud-classification.html#cb192-219" tabindex="-1"></a>          <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb192-220"><a href="point-cloud-classification.html#cb192-220" tabindex="-1"></a>          , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb192-221"><a href="point-cloud-classification.html#cb192-221" tabindex="-1"></a>        )</span>
<span id="cb192-222"><a href="point-cloud-classification.html#cb192-222" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb192-223"><a href="point-cloud-classification.html#cb192-223" tabindex="-1"></a>      return_dta <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb192-224"><a href="point-cloud-classification.html#cb192-224" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb192-225"><a href="point-cloud-classification.html#cb192-225" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_circle_fit_pred_id)</span>
<span id="cb192-226"><a href="point-cloud-classification.html#cb192-226" tabindex="-1"></a>    }</span>
<span id="cb192-227"><a href="point-cloud-classification.html#cb192-227" tabindex="-1"></a>      </span>
<span id="cb192-228"><a href="point-cloud-classification.html#cb192-228" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb192-229"><a href="point-cloud-classification.html#cb192-229" tabindex="-1"></a>    <span class="fu">return</span>(return_dta)</span>
<span id="cb192-230"><a href="point-cloud-classification.html#cb192-230" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s test this real quick</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="point-cloud-classification.html#cb193-1" tabindex="-1"></a>chm_temp <span class="ot">&lt;-</span> </span>
<span id="cb193-2"><a href="point-cloud-classification.html#cb193-2" tabindex="-1"></a>  cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb193-3"><a href="point-cloud-classification.html#cb193-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb193-4"><a href="point-cloud-classification.html#cb193-4" tabindex="-1"></a>    slash_piles_points <span class="sc">%&gt;%</span> </span>
<span id="cb193-5"><a href="point-cloud-classification.html#cb193-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_zm</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb193-6"><a href="point-cloud-classification.html#cb193-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb193-7"><a href="point-cloud-classification.html#cb193-7" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb193-8"><a href="point-cloud-classification.html#cb193-8" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(cloud2raster_ans<span class="sc">$</span>chm_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb193-9"><a href="point-cloud-classification.html#cb193-9" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb193-10"><a href="point-cloud-classification.html#cb193-10" tabindex="-1"></a>  )</span>
<span id="cb193-11"><a href="point-cloud-classification.html#cb193-11" tabindex="-1"></a><span class="co"># terra::plot(chm_temp)</span></span>
<span id="cb193-12"><a href="point-cloud-classification.html#cb193-12" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="ot">&lt;-</span> <span class="fu">slash_pile_detect_watershed</span>(chm_temp)</span>
<span id="cb193-13"><a href="point-cloud-classification.html#cb193-13" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb193-14"><a href="point-cloud-classification.html#cb193-14" tabindex="-1"></a>slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 69
## Columns: 6
## $ pred_id         &lt;dbl&gt; 11, 23, 43, 47, 100, 147, 202, 206, 216, 224, 231, 241…
## $ area_m2         &lt;dbl&gt; 3.12, 7.06, 3.06, 4.34, 5.20, 2.74, 3.48, 39.40, 2.86,…
## $ volume_m3       &lt;dbl&gt; 9.757329, 18.830532, 8.023260, 10.729498, 12.671159, 7…
## $ max_height_m    &lt;dbl&gt; 3.987000, 3.978000, 3.961000, 3.950000, 3.868167, 3.72…
## $ geometry        &lt;POLYGON [m]&gt; POLYGON ((499614.4 4317833,..., POLYGON ((4994…
## $ volume_per_area &lt;dbl&gt; 3.1273490, 2.6672142, 2.6219804, 2.4722346, 2.4367613,…</code></pre>
<p>how does it look overlaid on the CHM?</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="point-cloud-classification.html#cb195-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(chm_temp, <span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">100</span>), <span class="at">axes =</span> F)</span>
<span id="cb195-2"><a href="point-cloud-classification.html#cb195-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>(),<span class="at">add =</span> T, <span class="at">border =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-167-1.png" width="1008" /></p>
<p>how do the area and volume metrics look?</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="point-cloud-classification.html#cb196-1" tabindex="-1"></a>p1_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb196-2"><a href="point-cloud-classification.html#cb196-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb196-3"><a href="point-cloud-classification.html#cb196-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> area_m2)) <span class="sc">+</span></span>
<span id="cb196-4"><a href="point-cloud-classification.html#cb196-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Blues&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb196-5"><a href="point-cloud-classification.html#cb196-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-6"><a href="point-cloud-classification.html#cb196-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb196-7"><a href="point-cloud-classification.html#cb196-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb196-8"><a href="point-cloud-classification.html#cb196-8" tabindex="-1"></a>p2_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb196-9"><a href="point-cloud-classification.html#cb196-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb196-10"><a href="point-cloud-classification.html#cb196-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> volume_m3)) <span class="sc">+</span></span>
<span id="cb196-11"><a href="point-cloud-classification.html#cb196-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;BuGn&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb196-12"><a href="point-cloud-classification.html#cb196-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-13"><a href="point-cloud-classification.html#cb196-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb196-14"><a href="point-cloud-classification.html#cb196-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb196-15"><a href="point-cloud-classification.html#cb196-15" tabindex="-1"></a>p3_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb196-16"><a href="point-cloud-classification.html#cb196-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb196-17"><a href="point-cloud-classification.html#cb196-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> max_height_m)) <span class="sc">+</span></span>
<span id="cb196-18"><a href="point-cloud-classification.html#cb196-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;YlOrBr&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb196-19"><a href="point-cloud-classification.html#cb196-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-20"><a href="point-cloud-classification.html#cb196-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb196-21"><a href="point-cloud-classification.html#cb196-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb196-22"><a href="point-cloud-classification.html#cb196-22" tabindex="-1"></a>p4_temp <span class="ot">&lt;-</span> slash_pile_detect_watershed_ans_temp <span class="sc">%&gt;%</span> </span>
<span id="cb196-23"><a href="point-cloud-classification.html#cb196-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb196-24"><a href="point-cloud-classification.html#cb196-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> volume_per_area)) <span class="sc">+</span></span>
<span id="cb196-25"><a href="point-cloud-classification.html#cb196-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;PuRd&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb196-26"><a href="point-cloud-classification.html#cb196-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-27"><a href="point-cloud-classification.html#cb196-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb196-28"><a href="point-cloud-classification.html#cb196-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span>
<span id="cb196-29"><a href="point-cloud-classification.html#cb196-29" tabindex="-1"></a>(p1_temp <span class="sc">+</span> p2_temp) <span class="sc">/</span> (p3_temp <span class="sc">+</span> p4_temp)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-168-1.png" width="1008" /></p>
<p>the volume per area ratio (<code>volume_per_area</code>) quantifies the “effective” height or depth of that volume relative to the area it occupies; this ratio may not be very useful for anything other than scaling estimates to relate a three-dimensional quantity (volume) to a two-dimensional quantity (area)</p>
</div>
<div id="parameter-sensitivity-testing" class="section level4 hasAnchor" number="4.2.2.2">
<h4><span class="header-section-number">4.2.2.2</span> Parameter sensitivity testing<a href="point-cloud-classification.html#parameter-sensitivity-testing" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Parameter sensitivity testing is a systematic process of evaluating how changes to the specific thresholds and settings within the detection methodology impact the final results. Since the method doesn’t use training data, its performance is highly dependent on these manually defined parameters. The objective of this testing is to understand the robustness of the method and identify the optimal combination of settings that yield the best detection performance, balancing factors like detection rate (recall) and accuracy of positive predictions (precision).</p>
<p>Here are the general steps to accomplish this testing:</p>
<ul>
<li><em>Define Parameter Ranges and Increments</em>: For each identified parameter, determine a reasonable range of values to test and the step size for incrementing through that range. For example, if a threshold is currently 0.5, you might test from 0.3 to 0.7 in increments of 0.05.</li>
<li><em>Automate the Detection Workflow</em>: Create a script or automated process that can run your entire rules-based slash pile detection method using different combinations of these parameter values.</li>
<li><em>Execute Tests</em>: Run the automated workflow for each defined parameter combination.</li>
<li><em>Collect Performance Metrics</em>: For every run, calculate the key performance metrics against your image-annotated validation data (e.g. recall, precision, F-score)</li>
<li><em>Analyze and Visualize Results</em>: Plot the performance metrics against the varying parameter values or combinations. This will help you visualize trends, identify sweet spots where performance is maximized, and understand trade-offs (e.g., increasing recall might decrease precision).</li>
<li><em>Select Optimal Parameters</em>: Based on the analysis and the specific goals of the project (e.g., minimizing false negatives for safety, or maximizing overall accuracy), select the parameter set that provides the most desirable performance. This might involve choosing a balance between precision and recall, or prioritizing one over the other.</li>
</ul>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="point-cloud-classification.html#cb197-1" tabindex="-1"></a>param_combos_df <span class="ot">&lt;-</span></span>
<span id="cb197-2"><a href="point-cloud-classification.html#cb197-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">crossing</span>(</span>
<span id="cb197-3"><a href="point-cloud-classification.html#cb197-3" tabindex="-1"></a>    <span class="at">max_ht_m =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">4</span>, <span class="at">to =</span>  <span class="dv">6</span>, <span class="at">by =</span> <span class="dv">1</span>) <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb197-4"><a href="point-cloud-classification.html#cb197-4" tabindex="-1"></a>    , <span class="at">min_area_m2 =</span> <span class="fu">c</span>(<span class="dv">2</span>) <span class="co"># seq(from = 1, to =  2, by = 1) # set the min expected pile area</span></span>
<span id="cb197-5"><a href="point-cloud-classification.html#cb197-5" tabindex="-1"></a>    , <span class="at">max_area_m2 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">40</span>, <span class="at">to =</span>  <span class="dv">130</span>, <span class="at">by =</span> <span class="dv">10</span>) <span class="co"># set the max expected pile area</span></span>
<span id="cb197-6"><a href="point-cloud-classification.html#cb197-6" tabindex="-1"></a>    , <span class="at">convexity_pct =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.2</span>, <span class="at">to =</span>  <span class="fl">0.8</span>, <span class="at">by =</span> <span class="fl">0.1</span>) <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb197-7"><a href="point-cloud-classification.html#cb197-7" tabindex="-1"></a>    , <span class="at">circle_fit_iou_pct =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.3</span>, <span class="at">to =</span> <span class="fl">0.8</span>, <span class="at">by =</span> <span class="fl">0.1</span>) </span>
<span id="cb197-8"><a href="point-cloud-classification.html#cb197-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb197-9"><a href="point-cloud-classification.html#cb197-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb197-10"><a href="point-cloud-classification.html#cb197-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(rn)</span>
<span id="cb197-11"><a href="point-cloud-classification.html#cb197-11" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb197-12"><a href="point-cloud-classification.html#cb197-12" tabindex="-1"></a>param_combos_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,260
## Columns: 6
## $ rn                 &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, …
## $ max_ht_m           &lt;dbl&gt; 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, …
## $ min_area_m2        &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ max_area_m2        &lt;dbl&gt; 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40,…
## $ convexity_pct      &lt;dbl&gt; 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.3, 0.3, 0.3, 0.3, 0…
## $ circle_fit_iou_pct &lt;dbl&gt; 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.3, 0.4, 0.5, 0.6, 0…</code></pre>
<p>that might be too many combinations but we’ll give it a shot</p>
<div id="workflow-over-parameter-combinations" class="section level5 hasAnchor" number="4.2.2.2.1">
<h5><span class="header-section-number">4.2.2.2.1</span> Workflow over parameter combinations<a href="point-cloud-classification.html#workflow-over-parameter-combinations" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>to automate the detection workflow we can simply map these combinations over our <code>slash_pile_detect_watershed()</code> function. however, that would result in us running the same watershed segmentation process repeatedly with the same settings. as such, let’s make a function to efficiently perform the detection workflow using the same watershed segmentation and circle fitting for use with the different filtering combinations.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="point-cloud-classification.html#cb199-1" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb199-2"><a href="point-cloud-classification.html#cb199-2" tabindex="-1"></a><span class="co"># 1)</span></span>
<span id="cb199-3"><a href="point-cloud-classification.html#cb199-3" tabindex="-1"></a><span class="co"># function to apply watershed seg over a list of max_ht_m</span></span>
<span id="cb199-4"><a href="point-cloud-classification.html#cb199-4" tabindex="-1"></a><span class="co"># function to apply watershed segmentation over a list of different maximum height threshold (`max_ht_m`) which determines the &quot;slice&quot; of the CHM to use</span></span>
<span id="cb199-5"><a href="point-cloud-classification.html#cb199-5" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb199-6"><a href="point-cloud-classification.html#cb199-6" tabindex="-1"></a>chm_watershed_seg_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(chm_rast,max_ht_m) {</span>
<span id="cb199-7"><a href="point-cloud-classification.html#cb199-7" tabindex="-1"></a>  <span class="co"># get unique hts</span></span>
<span id="cb199-8"><a href="point-cloud-classification.html#cb199-8" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.numeric</span>(max_ht_m))</span>
<span id="cb199-9"><a href="point-cloud-classification.html#cb199-9" tabindex="-1"></a>  max_ht_m <span class="ot">&lt;-</span> max_ht_m[<span class="sc">!</span><span class="fu">is.na</span>(max_ht_m)]</span>
<span id="cb199-10"><a href="point-cloud-classification.html#cb199-10" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb199-11"><a href="point-cloud-classification.html#cb199-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">length</span>(max_ht_m),<span class="dv">0</span>)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb199-12"><a href="point-cloud-classification.html#cb199-12" tabindex="-1"></a>  ){<span class="fu">stop</span>(<span class="st">&quot;could not detect `max_ht_m` parameter setting which should be numeric list&quot;</span>)}</span>
<span id="cb199-13"><a href="point-cloud-classification.html#cb199-13" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb199-14"><a href="point-cloud-classification.html#cb199-14" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(chm_rast,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`chm_rast` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb199-15"><a href="point-cloud-classification.html#cb199-15" tabindex="-1"></a>  <span class="co"># just get the first layer</span></span>
<span id="cb199-16"><a href="point-cloud-classification.html#cb199-16" tabindex="-1"></a>  chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>)</span>
<span id="cb199-17"><a href="point-cloud-classification.html#cb199-17" tabindex="-1"></a>  <span class="co"># map over the watershed</span></span>
<span id="cb199-18"><a href="point-cloud-classification.html#cb199-18" tabindex="-1"></a>  <span class="co"># let&#39;s run watershed segmentation using `lidR::watershed()` which is based on the bioconductor package `EBIimage`</span></span>
<span id="cb199-19"><a href="point-cloud-classification.html#cb199-19" tabindex="-1"></a>  <span class="co"># return is a raster with the first layer representing the identified watershed segments</span></span>
<span id="cb199-20"><a href="point-cloud-classification.html#cb199-20" tabindex="-1"></a>  ret_rast <span class="ot">&lt;-</span> max_ht_m <span class="sc">%&gt;%</span> </span>
<span id="cb199-21"><a href="point-cloud-classification.html#cb199-21" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb199-22"><a href="point-cloud-classification.html#cb199-22" tabindex="-1"></a>      lidR<span class="sc">::</span><span class="fu">watershed</span>(</span>
<span id="cb199-23"><a href="point-cloud-classification.html#cb199-23" tabindex="-1"></a>        <span class="at">chm =</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb199-24"><a href="point-cloud-classification.html#cb199-24" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> x, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb199-25"><a href="point-cloud-classification.html#cb199-25" tabindex="-1"></a>        , <span class="at">th_tree =</span> <span class="fl">0.5</span> <span class="co"># this would be the minimum expected pile height</span></span>
<span id="cb199-26"><a href="point-cloud-classification.html#cb199-26" tabindex="-1"></a>      )()</span>
<span id="cb199-27"><a href="point-cloud-classification.html#cb199-27" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-28"><a href="point-cloud-classification.html#cb199-28" tabindex="-1"></a>    <span class="fu">c</span>()</span>
<span id="cb199-29"><a href="point-cloud-classification.html#cb199-29" tabindex="-1"></a>  <span class="co"># name</span></span>
<span id="cb199-30"><a href="point-cloud-classification.html#cb199-30" tabindex="-1"></a>  <span class="fu">names</span>(ret_rast) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(max_ht_m)</span>
<span id="cb199-31"><a href="point-cloud-classification.html#cb199-31" tabindex="-1"></a>  <span class="fu">return</span>(terra<span class="sc">::</span><span class="fu">rast</span>(ret_rast)) <span class="co"># returns a raster stack</span></span>
<span id="cb199-32"><a href="point-cloud-classification.html#cb199-32" tabindex="-1"></a>}</span>
<span id="cb199-33"><a href="point-cloud-classification.html#cb199-33" tabindex="-1"></a></span>
<span id="cb199-34"><a href="point-cloud-classification.html#cb199-34" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb199-35"><a href="point-cloud-classification.html#cb199-35" tabindex="-1"></a><span class="co"># 2)</span></span>
<span id="cb199-36"><a href="point-cloud-classification.html#cb199-36" tabindex="-1"></a><span class="co"># now we need to define a function to apply the filters to the resulting watershed segmented rasters </span></span>
<span id="cb199-37"><a href="point-cloud-classification.html#cb199-37" tabindex="-1"></a><span class="co"># based on a data frame of difference combinations of filters for irregularity using the comparison to the convex hull</span></span>
<span id="cb199-38"><a href="point-cloud-classification.html#cb199-38" tabindex="-1"></a><span class="do">#########################################################################</span></span>
<span id="cb199-39"><a href="point-cloud-classification.html#cb199-39" tabindex="-1"></a>param_combos_detect_convexity_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb199-40"><a href="point-cloud-classification.html#cb199-40" tabindex="-1"></a>  watershed_rast_stack</span>
<span id="cb199-41"><a href="point-cloud-classification.html#cb199-41" tabindex="-1"></a>  <span class="do">#### height and area thresholds for the detected piles</span></span>
<span id="cb199-42"><a href="point-cloud-classification.html#cb199-42" tabindex="-1"></a>  <span class="co"># these should be based on data from the literature or expectations based on the prescription</span></span>
<span id="cb199-43"><a href="point-cloud-classification.html#cb199-43" tabindex="-1"></a>  , <span class="at">max_ht_m =</span> <span class="dv">4</span> <span class="co"># set the max expected pile height (could also do a minimum??)</span></span>
<span id="cb199-44"><a href="point-cloud-classification.html#cb199-44" tabindex="-1"></a>  , <span class="at">min_area_m2 =</span> <span class="dv">2</span> <span class="co"># set the min expected pile area</span></span>
<span id="cb199-45"><a href="point-cloud-classification.html#cb199-45" tabindex="-1"></a>  , <span class="at">max_area_m2 =</span> <span class="dv">50</span> <span class="co"># set the max expected pile area</span></span>
<span id="cb199-46"><a href="point-cloud-classification.html#cb199-46" tabindex="-1"></a>  <span class="do">#### irregularity filtering</span></span>
<span id="cb199-47"><a href="point-cloud-classification.html#cb199-47" tabindex="-1"></a>  <span class="co"># 1 = perfectly convex (no inward angles); 0 = so many inward angles</span></span>
<span id="cb199-48"><a href="point-cloud-classification.html#cb199-48" tabindex="-1"></a>  <span class="co"># values closer to 1 remove more irregular segments; </span></span>
<span id="cb199-49"><a href="point-cloud-classification.html#cb199-49" tabindex="-1"></a>    <span class="co"># values closer to 0 keep more irregular segments (and also regular segments)</span></span>
<span id="cb199-50"><a href="point-cloud-classification.html#cb199-50" tabindex="-1"></a>  <span class="co"># these will all be further filtered for their circularity and later smoothed to remove blocky edges</span></span>
<span id="cb199-51"><a href="point-cloud-classification.html#cb199-51" tabindex="-1"></a>  <span class="co"># and most inward angles by applying a convex hull to the original detected segment</span></span>
<span id="cb199-52"><a href="point-cloud-classification.html#cb199-52" tabindex="-1"></a>  , <span class="at">convexity_pct =</span> <span class="fl">0.7</span> <span class="co"># min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb199-53"><a href="point-cloud-classification.html#cb199-53" tabindex="-1"></a>) {</span>
<span id="cb199-54"><a href="point-cloud-classification.html#cb199-54" tabindex="-1"></a>  <span class="co"># subset the raster</span></span>
<span id="cb199-55"><a href="point-cloud-classification.html#cb199-55" tabindex="-1"></a>  watershed_ans <span class="ot">&lt;-</span> watershed_rast_stack <span class="sc">%&gt;%</span> </span>
<span id="cb199-56"><a href="point-cloud-classification.html#cb199-56" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">subset</span>( <span class="fu">as.character</span>(<span class="fu">unique</span>(max_ht_m)[<span class="dv">1</span>]) )</span>
<span id="cb199-57"><a href="point-cloud-classification.html#cb199-57" tabindex="-1"></a>  </span>
<span id="cb199-58"><a href="point-cloud-classification.html#cb199-58" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb199-59"><a href="point-cloud-classification.html#cb199-59" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(watershed_ans,<span class="st">&quot;SpatRaster&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;`watershed_ans` must be raster data with the class `SpatRaster` &quot;</span>)}</span>
<span id="cb199-60"><a href="point-cloud-classification.html#cb199-60" tabindex="-1"></a>  <span class="co"># just get the first layer</span></span>
<span id="cb199-61"><a href="point-cloud-classification.html#cb199-61" tabindex="-1"></a>  watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>)</span>
<span id="cb199-62"><a href="point-cloud-classification.html#cb199-62" tabindex="-1"></a>  </span>
<span id="cb199-63"><a href="point-cloud-classification.html#cb199-63" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb199-64"><a href="point-cloud-classification.html#cb199-64" tabindex="-1"></a>  <span class="do">## 1) watershed segmentation</span></span>
<span id="cb199-65"><a href="point-cloud-classification.html#cb199-65" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb199-66"><a href="point-cloud-classification.html#cb199-66" tabindex="-1"></a>    <span class="co"># we can quickly calculate the area of the segments which we could use as a filter</span></span>
<span id="cb199-67"><a href="point-cloud-classification.html#cb199-67" tabindex="-1"></a>    <span class="co"># list of segments that meet size threshold</span></span>
<span id="cb199-68"><a href="point-cloud-classification.html#cb199-68" tabindex="-1"></a>    keep_segs_temp <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb199-69"><a href="point-cloud-classification.html#cb199-69" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">freq</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-70"><a href="point-cloud-classification.html#cb199-70" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_m2 =</span> count <span class="sc">*</span> (terra<span class="sc">::</span><span class="fu">res</span>(watershed_ans) <span class="sc">%&gt;%</span> .[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> <span class="fu">prod</span>()) ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-71"><a href="point-cloud-classification.html#cb199-71" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb199-72"><a href="point-cloud-classification.html#cb199-72" tabindex="-1"></a>        area_m2 <span class="sc">&gt;=</span> min_area_m2 <span class="sc">&amp;</span> </span>
<span id="cb199-73"><a href="point-cloud-classification.html#cb199-73" tabindex="-1"></a>        area_m2 <span class="sc">&lt;=</span> max_area_m2</span>
<span id="cb199-74"><a href="point-cloud-classification.html#cb199-74" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb199-75"><a href="point-cloud-classification.html#cb199-75" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(value)</span>
<span id="cb199-76"><a href="point-cloud-classification.html#cb199-76" tabindex="-1"></a>    <span class="co"># filter the raster (segments that don&#39;t meet the size thresholds are set to NA)</span></span>
<span id="cb199-77"><a href="point-cloud-classification.html#cb199-77" tabindex="-1"></a>    watershed_ans <span class="ot">&lt;-</span> watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb199-78"><a href="point-cloud-classification.html#cb199-78" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">subst</span>(<span class="at">from =</span> keep_segs_temp, <span class="at">to =</span> keep_segs_temp, <span class="at">others =</span> <span class="cn">NA</span>)</span>
<span id="cb199-79"><a href="point-cloud-classification.html#cb199-79" tabindex="-1"></a>    </span>
<span id="cb199-80"><a href="point-cloud-classification.html#cb199-80" tabindex="-1"></a>    <span class="co"># let&#39;s convert the watershed-detected segments from raster to vector data </span></span>
<span id="cb199-81"><a href="point-cloud-classification.html#cb199-81" tabindex="-1"></a>    <span class="co"># and create a convex hull of the shapes for comparison</span></span>
<span id="cb199-82"><a href="point-cloud-classification.html#cb199-82" tabindex="-1"></a>    <span class="co"># vectors of segments</span></span>
<span id="cb199-83"><a href="point-cloud-classification.html#cb199-83" tabindex="-1"></a>    watershed_ans_poly <span class="ot">&lt;-</span></span>
<span id="cb199-84"><a href="point-cloud-classification.html#cb199-84" tabindex="-1"></a>      watershed_ans <span class="sc">%&gt;%</span> </span>
<span id="cb199-85"><a href="point-cloud-classification.html#cb199-85" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">round =</span> F, <span class="at">aggregate =</span> T, <span class="at">values =</span> T, <span class="at">extent =</span> F, <span class="at">na.rm =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb199-86"><a href="point-cloud-classification.html#cb199-86" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="st">&quot;pred_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb199-87"><a href="point-cloud-classification.html#cb199-87" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-88"><a href="point-cloud-classification.html#cb199-88" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-89"><a href="point-cloud-classification.html#cb199-89" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-90"><a href="point-cloud-classification.html#cb199-90" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb199-91"><a href="point-cloud-classification.html#cb199-91" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID=</span>pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb199-92"><a href="point-cloud-classification.html#cb199-92" tabindex="-1"></a>      cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-93"><a href="point-cloud-classification.html#cb199-93" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID)</span>
<span id="cb199-94"><a href="point-cloud-classification.html#cb199-94" tabindex="-1"></a>    </span>
<span id="cb199-95"><a href="point-cloud-classification.html#cb199-95" tabindex="-1"></a>    <span class="cf">if</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(watershed_ans_poly),<span class="dv">0</span>)<span class="sc">&lt;</span><span class="dv">1</span>){</span>
<span id="cb199-96"><a href="point-cloud-classification.html#cb199-96" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb199-97"><a href="point-cloud-classification.html#cb199-97" tabindex="-1"></a>    }</span>
<span id="cb199-98"><a href="point-cloud-classification.html#cb199-98" tabindex="-1"></a>    </span>
<span id="cb199-99"><a href="point-cloud-classification.html#cb199-99" tabindex="-1"></a>    <span class="co"># convex hulls of segments</span></span>
<span id="cb199-100"><a href="point-cloud-classification.html#cb199-100" tabindex="-1"></a>    watershed_ans_poly_chull <span class="ot">&lt;-</span></span>
<span id="cb199-101"><a href="point-cloud-classification.html#cb199-101" tabindex="-1"></a>      watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb199-102"><a href="point-cloud-classification.html#cb199-102" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-103"><a href="point-cloud-classification.html#cb199-103" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-104"><a href="point-cloud-classification.html#cb199-104" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-105"><a href="point-cloud-classification.html#cb199-105" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.))</span>
<span id="cb199-106"><a href="point-cloud-classification.html#cb199-106" tabindex="-1"></a>    </span>
<span id="cb199-107"><a href="point-cloud-classification.html#cb199-107" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb199-108"><a href="point-cloud-classification.html#cb199-108" tabindex="-1"></a>  <span class="do">## 2) irregularity filtering</span></span>
<span id="cb199-109"><a href="point-cloud-classification.html#cb199-109" tabindex="-1"></a>  <span class="do">########################################################################################</span></span>
<span id="cb199-110"><a href="point-cloud-classification.html#cb199-110" tabindex="-1"></a>    <span class="co"># let&#39;s first filter out segments that have holes in them </span></span>
<span id="cb199-111"><a href="point-cloud-classification.html#cb199-111" tabindex="-1"></a>    <span class="co"># or are very irregularly shaped by comparing the area of the polygon and convex hull</span></span>
<span id="cb199-112"><a href="point-cloud-classification.html#cb199-112" tabindex="-1"></a></span>
<span id="cb199-113"><a href="point-cloud-classification.html#cb199-113" tabindex="-1"></a>    <span class="co"># convexity_pct = min required overlap between the predicted pile and the convex hull of the predicted pile</span></span>
<span id="cb199-114"><a href="point-cloud-classification.html#cb199-114" tabindex="-1"></a>    <span class="cf">if</span>(convexity_pct<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb199-115"><a href="point-cloud-classification.html#cb199-115" tabindex="-1"></a>      watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span> watershed_ans_poly<span class="sc">$</span>pred_id</span>
<span id="cb199-116"><a href="point-cloud-classification.html#cb199-116" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb199-117"><a href="point-cloud-classification.html#cb199-117" tabindex="-1"></a>      <span class="co"># compare areas</span></span>
<span id="cb199-118"><a href="point-cloud-classification.html#cb199-118" tabindex="-1"></a>      watershed_keep_overlaps_chull_pred_id <span class="ot">&lt;-</span> watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb199-119"><a href="point-cloud-classification.html#cb199-119" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">poly_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb199-120"><a href="point-cloud-classification.html#cb199-120" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb199-121"><a href="point-cloud-classification.html#cb199-121" tabindex="-1"></a>          watershed_ans_poly_chull <span class="sc">%&gt;%</span> </span>
<span id="cb199-122"><a href="point-cloud-classification.html#cb199-122" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">chull_area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb199-123"><a href="point-cloud-classification.html#cb199-123" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb199-124"><a href="point-cloud-classification.html#cb199-124" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb199-125"><a href="point-cloud-classification.html#cb199-125" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-126"><a href="point-cloud-classification.html#cb199-126" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb199-127"><a href="point-cloud-classification.html#cb199-127" tabindex="-1"></a>          <span class="at">pct_chull =</span> poly_area_m2<span class="sc">/</span>chull_area_m2</span>
<span id="cb199-128"><a href="point-cloud-classification.html#cb199-128" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-129"><a href="point-cloud-classification.html#cb199-129" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb199-130"><a href="point-cloud-classification.html#cb199-130" tabindex="-1"></a>          pct_chull <span class="sc">&gt;=</span> convexity_pct</span>
<span id="cb199-131"><a href="point-cloud-classification.html#cb199-131" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-132"><a href="point-cloud-classification.html#cb199-132" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id)</span>
<span id="cb199-133"><a href="point-cloud-classification.html#cb199-133" tabindex="-1"></a>    }</span>
<span id="cb199-134"><a href="point-cloud-classification.html#cb199-134" tabindex="-1"></a>    </span>
<span id="cb199-135"><a href="point-cloud-classification.html#cb199-135" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb199-136"><a href="point-cloud-classification.html#cb199-136" tabindex="-1"></a>      <span class="fu">identical</span>(watershed_keep_overlaps_chull_pred_id, <span class="fu">numeric</span>(<span class="dv">0</span>))</span>
<span id="cb199-137"><a href="point-cloud-classification.html#cb199-137" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.null</span>(watershed_keep_overlaps_chull_pred_id))</span>
<span id="cb199-138"><a href="point-cloud-classification.html#cb199-138" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(watershed_keep_overlaps_chull_pred_id))</span>
<span id="cb199-139"><a href="point-cloud-classification.html#cb199-139" tabindex="-1"></a>      <span class="sc">||</span> <span class="fu">length</span>(watershed_keep_overlaps_chull_pred_id)<span class="sc">&lt;</span><span class="dv">1</span></span>
<span id="cb199-140"><a href="point-cloud-classification.html#cb199-140" tabindex="-1"></a>    ){</span>
<span id="cb199-141"><a href="point-cloud-classification.html#cb199-141" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb199-142"><a href="point-cloud-classification.html#cb199-142" tabindex="-1"></a>    }</span>
<span id="cb199-143"><a href="point-cloud-classification.html#cb199-143" tabindex="-1"></a>  <span class="do">#########################################</span></span>
<span id="cb199-144"><a href="point-cloud-classification.html#cb199-144" tabindex="-1"></a>  <span class="co"># return the filtered segment polygons</span></span>
<span id="cb199-145"><a href="point-cloud-classification.html#cb199-145" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb199-146"><a href="point-cloud-classification.html#cb199-146" tabindex="-1"></a>    watershed_ans_poly <span class="sc">%&gt;%</span> </span>
<span id="cb199-147"><a href="point-cloud-classification.html#cb199-147" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pred_id <span class="sc">%in%</span> watershed_keep_overlaps_chull_pred_id)</span>
<span id="cb199-148"><a href="point-cloud-classification.html#cb199-148" tabindex="-1"></a>  )</span>
<span id="cb199-149"><a href="point-cloud-classification.html#cb199-149" tabindex="-1"></a>}</span>
<span id="cb199-150"><a href="point-cloud-classification.html#cb199-150" tabindex="-1"></a></span>
<span id="cb199-151"><a href="point-cloud-classification.html#cb199-151" tabindex="-1"></a><span class="co"># function to do the whole thing</span></span>
<span id="cb199-152"><a href="point-cloud-classification.html#cb199-152" tabindex="-1"></a>param_combos_piles_detect_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb199-153"><a href="point-cloud-classification.html#cb199-153" tabindex="-1"></a>  chm</span>
<span id="cb199-154"><a href="point-cloud-classification.html#cb199-154" tabindex="-1"></a>  , param_combos_df</span>
<span id="cb199-155"><a href="point-cloud-classification.html#cb199-155" tabindex="-1"></a>  , <span class="at">smooth_segs =</span> T</span>
<span id="cb199-156"><a href="point-cloud-classification.html#cb199-156" tabindex="-1"></a>  , <span class="at">ofile =</span> <span class="st">&quot;../data/param_combos_piles.gpkg&quot;</span></span>
<span id="cb199-157"><a href="point-cloud-classification.html#cb199-157" tabindex="-1"></a>) {</span>
<span id="cb199-158"><a href="point-cloud-classification.html#cb199-158" tabindex="-1"></a>  <span class="co"># apply chm_watershed_seg_fn</span></span>
<span id="cb199-159"><a href="point-cloud-classification.html#cb199-159" tabindex="-1"></a>  <span class="do">### takes ~37 mins</span></span>
<span id="cb199-160"><a href="point-cloud-classification.html#cb199-160" tabindex="-1"></a>  chm_watershed_seg_ans <span class="ot">&lt;-</span> <span class="fu">chm_watershed_seg_fn</span>(chm, <span class="at">max_ht_m =</span> <span class="fu">unique</span>(param_combos_df<span class="sc">$</span>max_ht_m))</span>
<span id="cb199-161"><a href="point-cloud-classification.html#cb199-161" tabindex="-1"></a>  <span class="co"># # what did we get?</span></span>
<span id="cb199-162"><a href="point-cloud-classification.html#cb199-162" tabindex="-1"></a>  <span class="co"># chm_watershed_seg_ans %&gt;% </span></span>
<span id="cb199-163"><a href="point-cloud-classification.html#cb199-163" tabindex="-1"></a>  <span class="co">#   terra::subset( as.character(unique(param_combos_df$max_ht_m)[3]) ) %&gt;% </span></span>
<span id="cb199-164"><a href="point-cloud-classification.html#cb199-164" tabindex="-1"></a>  <span class="co">#   terra::plot()</span></span>
<span id="cb199-165"><a href="point-cloud-classification.html#cb199-165" tabindex="-1"></a>  </span>
<span id="cb199-166"><a href="point-cloud-classification.html#cb199-166" tabindex="-1"></a>  <span class="co"># just get the unique combinations needed for this param_combos_detect_convexity_fn function</span></span>
<span id="cb199-167"><a href="point-cloud-classification.html#cb199-167" tabindex="-1"></a>  param_combos_convexity_df <span class="ot">&lt;-</span></span>
<span id="cb199-168"><a href="point-cloud-classification.html#cb199-168" tabindex="-1"></a>    param_combos_df <span class="sc">%&gt;%</span> </span>
<span id="cb199-169"><a href="point-cloud-classification.html#cb199-169" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(</span>
<span id="cb199-170"><a href="point-cloud-classification.html#cb199-170" tabindex="-1"></a>      max_ht_m</span>
<span id="cb199-171"><a href="point-cloud-classification.html#cb199-171" tabindex="-1"></a>      , min_area_m2</span>
<span id="cb199-172"><a href="point-cloud-classification.html#cb199-172" tabindex="-1"></a>      , max_area_m2</span>
<span id="cb199-173"><a href="point-cloud-classification.html#cb199-173" tabindex="-1"></a>      , convexity_pct</span>
<span id="cb199-174"><a href="point-cloud-classification.html#cb199-174" tabindex="-1"></a>    )</span>
<span id="cb199-175"><a href="point-cloud-classification.html#cb199-175" tabindex="-1"></a>  <span class="co"># apply this using our data frame to map over the combinations</span></span>
<span id="cb199-176"><a href="point-cloud-classification.html#cb199-176" tabindex="-1"></a>  <span class="do">### takes ~40 mins</span></span>
<span id="cb199-177"><a href="point-cloud-classification.html#cb199-177" tabindex="-1"></a>  param_combos_detect_convexity_ans <span class="ot">&lt;-</span> </span>
<span id="cb199-178"><a href="point-cloud-classification.html#cb199-178" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(param_combos_convexity_df) <span class="sc">%&gt;%</span> </span>
<span id="cb199-179"><a href="point-cloud-classification.html#cb199-179" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb199-180"><a href="point-cloud-classification.html#cb199-180" tabindex="-1"></a>      <span class="fu">param_combos_detect_convexity_fn</span>(</span>
<span id="cb199-181"><a href="point-cloud-classification.html#cb199-181" tabindex="-1"></a>          <span class="at">watershed_rast_stack =</span> chm_watershed_seg_ans</span>
<span id="cb199-182"><a href="point-cloud-classification.html#cb199-182" tabindex="-1"></a>          , <span class="at">max_ht_m =</span> param_combos_convexity_df<span class="sc">$</span>max_ht_m[x]</span>
<span id="cb199-183"><a href="point-cloud-classification.html#cb199-183" tabindex="-1"></a>          , <span class="at">min_area_m2 =</span> param_combos_convexity_df<span class="sc">$</span>min_area_m2[x]</span>
<span id="cb199-184"><a href="point-cloud-classification.html#cb199-184" tabindex="-1"></a>          , <span class="at">max_area_m2 =</span> param_combos_convexity_df<span class="sc">$</span>max_area_m2[x]</span>
<span id="cb199-185"><a href="point-cloud-classification.html#cb199-185" tabindex="-1"></a>          , <span class="at">convexity_pct =</span> param_combos_convexity_df<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb199-186"><a href="point-cloud-classification.html#cb199-186" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-187"><a href="point-cloud-classification.html#cb199-187" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb199-188"><a href="point-cloud-classification.html#cb199-188" tabindex="-1"></a>          <span class="at">max_ht_m =</span> param_combos_convexity_df<span class="sc">$</span>max_ht_m[x]</span>
<span id="cb199-189"><a href="point-cloud-classification.html#cb199-189" tabindex="-1"></a>          , <span class="at">min_area_m2 =</span> param_combos_convexity_df<span class="sc">$</span>min_area_m2[x]</span>
<span id="cb199-190"><a href="point-cloud-classification.html#cb199-190" tabindex="-1"></a>          , <span class="at">max_area_m2 =</span> param_combos_convexity_df<span class="sc">$</span>max_area_m2[x]</span>
<span id="cb199-191"><a href="point-cloud-classification.html#cb199-191" tabindex="-1"></a>          , <span class="at">convexity_pct =</span> param_combos_convexity_df<span class="sc">$</span>convexity_pct[x]</span>
<span id="cb199-192"><a href="point-cloud-classification.html#cb199-192" tabindex="-1"></a>        )</span>
<span id="cb199-193"><a href="point-cloud-classification.html#cb199-193" tabindex="-1"></a>      , <span class="at">.progress =</span> T</span>
<span id="cb199-194"><a href="point-cloud-classification.html#cb199-194" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-195"><a href="point-cloud-classification.html#cb199-195" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb199-196"><a href="point-cloud-classification.html#cb199-196" tabindex="-1"></a>  <span class="co"># generate a record ID</span></span>
<span id="cb199-197"><a href="point-cloud-classification.html#cb199-197" tabindex="-1"></a>  param_combos_detect_convexity_ans <span class="ot">&lt;-</span> param_combos_detect_convexity_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">record_id =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb199-198"><a href="point-cloud-classification.html#cb199-198" tabindex="-1"></a>  <span class="co"># param_combos_detect_convexity_ans &lt;- sf::st_read(&quot;../data/param_combos_detect_convexity_ans.gpkg&quot;) #!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!FULL DATA</span></span>
<span id="cb199-199"><a href="point-cloud-classification.html#cb199-199" tabindex="-1"></a>  </span>
<span id="cb199-200"><a href="point-cloud-classification.html#cb199-200" tabindex="-1"></a>  <span class="co"># #!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Filter for testing</span></span>
<span id="cb199-201"><a href="point-cloud-classification.html#cb199-201" tabindex="-1"></a>  <span class="co"># param_combos_detect_convexity_ans &lt;-</span></span>
<span id="cb199-202"><a href="point-cloud-classification.html#cb199-202" tabindex="-1"></a>  <span class="co">#   param_combos_detect_convexity_ans %&gt;% </span></span>
<span id="cb199-203"><a href="point-cloud-classification.html#cb199-203" tabindex="-1"></a>  <span class="co">#   dplyr::inner_join(</span></span>
<span id="cb199-204"><a href="point-cloud-classification.html#cb199-204" tabindex="-1"></a>  <span class="co">#     param_combos_convexity_df %&gt;% </span></span>
<span id="cb199-205"><a href="point-cloud-classification.html#cb199-205" tabindex="-1"></a>  <span class="co">#       dplyr::slice_sample(n = 5)</span></span>
<span id="cb199-206"><a href="point-cloud-classification.html#cb199-206" tabindex="-1"></a>  <span class="co">#     , by = dplyr::join_by(max_ht_m,min_area_m2,max_area_m2,convexity_pct)</span></span>
<span id="cb199-207"><a href="point-cloud-classification.html#cb199-207" tabindex="-1"></a>  <span class="co">#   )</span></span>
<span id="cb199-208"><a href="point-cloud-classification.html#cb199-208" tabindex="-1"></a>  </span>
<span id="cb199-209"><a href="point-cloud-classification.html#cb199-209" tabindex="-1"></a>  <span class="co"># param_combos_detect_convexity_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb199-210"><a href="point-cloud-classification.html#cb199-210" tabindex="-1"></a>  <span class="co"># and we&#39;ll apply the circle fitting to this spatial data</span></span>
<span id="cb199-211"><a href="point-cloud-classification.html#cb199-211" tabindex="-1"></a>  <span class="co"># apply the sf_data_circle_fit() which takes each segment polygon, transforms it to points, and the fits the best circle</span></span>
<span id="cb199-212"><a href="point-cloud-classification.html#cb199-212" tabindex="-1"></a>  param_combos_detect_cf_ans <span class="ot">&lt;-</span> <span class="fu">sf_data_circle_fit</span>(param_combos_detect_convexity_ans)</span>
<span id="cb199-213"><a href="point-cloud-classification.html#cb199-213" tabindex="-1"></a>  <span class="co"># param_combos_detect_cf_ans %&gt;% sf::st_write(&quot;../data/param_combos_detect_cf_ans.gpkg&quot;)</span></span>
<span id="cb199-214"><a href="point-cloud-classification.html#cb199-214" tabindex="-1"></a>  <span class="co"># param_combos_detect_cf_ans %&gt;% dplyr::glimpse()</span></span>
<span id="cb199-215"><a href="point-cloud-classification.html#cb199-215" tabindex="-1"></a>  <span class="co"># nrow(param_combos_detect_cf_ans)</span></span>
<span id="cb199-216"><a href="point-cloud-classification.html#cb199-216" tabindex="-1"></a>  <span class="co"># nrow(param_combos_detect_convexity_ans)</span></span>
<span id="cb199-217"><a href="point-cloud-classification.html#cb199-217" tabindex="-1"></a>  </span>
<span id="cb199-218"><a href="point-cloud-classification.html#cb199-218" tabindex="-1"></a>  <span class="co"># we&#39;ll use the IoU function we defined </span></span>
<span id="cb199-219"><a href="point-cloud-classification.html#cb199-219" tabindex="-1"></a>    <span class="co"># we map over this to only compare the segment to it&#39;s own best circle fit...not all</span></span>
<span id="cb199-220"><a href="point-cloud-classification.html#cb199-220" tabindex="-1"></a>    <span class="co"># we should consider doing this in bulk.....another day</span></span>
<span id="cb199-221"><a href="point-cloud-classification.html#cb199-221" tabindex="-1"></a>    param_combos_detect_cf_iou <span class="ot">&lt;-</span> </span>
<span id="cb199-222"><a href="point-cloud-classification.html#cb199-222" tabindex="-1"></a>      param_combos_detect_convexity_ans<span class="sc">$</span>record_id <span class="sc">%&gt;%</span> </span>
<span id="cb199-223"><a href="point-cloud-classification.html#cb199-223" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb199-224"><a href="point-cloud-classification.html#cb199-224" tabindex="-1"></a>        <span class="fu">ground_truth_single_match</span>(</span>
<span id="cb199-225"><a href="point-cloud-classification.html#cb199-225" tabindex="-1"></a>          <span class="at">gt_inst =</span> param_combos_detect_convexity_ans <span class="sc">%&gt;%</span> </span>
<span id="cb199-226"><a href="point-cloud-classification.html#cb199-226" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(record_id <span class="sc">==</span> x)</span>
<span id="cb199-227"><a href="point-cloud-classification.html#cb199-227" tabindex="-1"></a>          , <span class="at">gt_id =</span> <span class="st">&quot;record_id&quot;</span></span>
<span id="cb199-228"><a href="point-cloud-classification.html#cb199-228" tabindex="-1"></a>          , <span class="at">predictions =</span> param_combos_detect_cf_ans <span class="sc">%&gt;%</span> </span>
<span id="cb199-229"><a href="point-cloud-classification.html#cb199-229" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(record_id <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb199-230"><a href="point-cloud-classification.html#cb199-230" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(record_id) <span class="sc">%&gt;%</span> <span class="co"># keeping other columns causes error?</span></span>
<span id="cb199-231"><a href="point-cloud-classification.html#cb199-231" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">circ_record_id =</span> record_id)</span>
<span id="cb199-232"><a href="point-cloud-classification.html#cb199-232" tabindex="-1"></a>          , <span class="at">pred_id =</span> <span class="st">&quot;circ_record_id&quot;</span></span>
<span id="cb199-233"><a href="point-cloud-classification.html#cb199-233" tabindex="-1"></a>          , <span class="at">min_iou_pct =</span> <span class="dv">0</span> <span class="co"># set to 0 just to return pct</span></span>
<span id="cb199-234"><a href="point-cloud-classification.html#cb199-234" tabindex="-1"></a>        )    </span>
<span id="cb199-235"><a href="point-cloud-classification.html#cb199-235" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-236"><a href="point-cloud-classification.html#cb199-236" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb199-237"><a href="point-cloud-classification.html#cb199-237" tabindex="-1"></a>    </span>
<span id="cb199-238"><a href="point-cloud-classification.html#cb199-238" tabindex="-1"></a>    <span class="co"># param_combos_detect_cf_iou %&gt;% dplyr::glimpse()</span></span>
<span id="cb199-239"><a href="point-cloud-classification.html#cb199-239" tabindex="-1"></a>  </span>
<span id="cb199-240"><a href="point-cloud-classification.html#cb199-240" tabindex="-1"></a>  <span class="do">### now we need a function to map over all the different filters for circularity by combination of the other settings</span></span>
<span id="cb199-241"><a href="point-cloud-classification.html#cb199-241" tabindex="-1"></a>    <span class="do">### this is going to be highly custom to this particular task :\</span></span>
<span id="cb199-242"><a href="point-cloud-classification.html#cb199-242" tabindex="-1"></a>  final_ans <span class="ot">&lt;-</span> </span>
<span id="cb199-243"><a href="point-cloud-classification.html#cb199-243" tabindex="-1"></a>    param_combos_detect_convexity_ans <span class="sc">%&gt;%</span> </span>
<span id="cb199-244"><a href="point-cloud-classification.html#cb199-244" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb199-245"><a href="point-cloud-classification.html#cb199-245" tabindex="-1"></a>      param_combos_df</span>
<span id="cb199-246"><a href="point-cloud-classification.html#cb199-246" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(max_ht_m,min_area_m2,max_area_m2,convexity_pct)</span>
<span id="cb199-247"><a href="point-cloud-classification.html#cb199-247" tabindex="-1"></a>      , <span class="at">relationship =</span> <span class="st">&quot;many-to-many&quot;</span></span>
<span id="cb199-248"><a href="point-cloud-classification.html#cb199-248" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-249"><a href="point-cloud-classification.html#cb199-249" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb199-250"><a href="point-cloud-classification.html#cb199-250" tabindex="-1"></a>      param_combos_detect_cf_iou <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(record_id,iou)</span>
<span id="cb199-251"><a href="point-cloud-classification.html#cb199-251" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;record_id&quot;</span></span>
<span id="cb199-252"><a href="point-cloud-classification.html#cb199-252" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-253"><a href="point-cloud-classification.html#cb199-253" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(iou,<span class="dv">0</span>)<span class="sc">&gt;=</span>circle_fit_iou_pct)</span>
<span id="cb199-254"><a href="point-cloud-classification.html#cb199-254" tabindex="-1"></a>  </span>
<span id="cb199-255"><a href="point-cloud-classification.html#cb199-255" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb199-256"><a href="point-cloud-classification.html#cb199-256" tabindex="-1"></a>    <span class="do">## 4) shape refinement &amp; overlap removal</span></span>
<span id="cb199-257"><a href="point-cloud-classification.html#cb199-257" tabindex="-1"></a>    <span class="do">########################################################################################</span></span>
<span id="cb199-258"><a href="point-cloud-classification.html#cb199-258" tabindex="-1"></a>      <span class="co"># use the convex hull shapes of our remaining segments. </span></span>
<span id="cb199-259"><a href="point-cloud-classification.html#cb199-259" tabindex="-1"></a>      <span class="co"># This helps to smooth out the often &#39;blocky&#39; edges of raster-based segments</span></span>
<span id="cb199-260"><a href="point-cloud-classification.html#cb199-260" tabindex="-1"></a>      <span class="co"># , which can look like they were generated in Minecraft. </span></span>
<span id="cb199-261"><a href="point-cloud-classification.html#cb199-261" tabindex="-1"></a>      <span class="co"># Additionally, by removing any segments with overlapping convex hull shapes, </span></span>
<span id="cb199-262"><a href="point-cloud-classification.html#cb199-262" tabindex="-1"></a>      <span class="co"># we can likely reduce false detections that are actually groups of small trees or shrubs, </span></span>
<span id="cb199-263"><a href="point-cloud-classification.html#cb199-263" tabindex="-1"></a>      <span class="co"># ensuring our results represent singular slash piles.</span></span>
<span id="cb199-264"><a href="point-cloud-classification.html#cb199-264" tabindex="-1"></a>      <span class="cf">if</span>(smooth_segs){</span>
<span id="cb199-265"><a href="point-cloud-classification.html#cb199-265" tabindex="-1"></a>        final_ans <span class="ot">&lt;-</span> <span class="fu">unique</span>(final_ans<span class="sc">$</span>rn) <span class="sc">%&gt;%</span> </span>
<span id="cb199-266"><a href="point-cloud-classification.html#cb199-266" tabindex="-1"></a>          <span class="co"># have to map over this to do overlaps only on one set at a time</span></span>
<span id="cb199-267"><a href="point-cloud-classification.html#cb199-267" tabindex="-1"></a>          purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb199-268"><a href="point-cloud-classification.html#cb199-268" tabindex="-1"></a>            final_ans <span class="sc">%&gt;%</span> </span>
<span id="cb199-269"><a href="point-cloud-classification.html#cb199-269" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(rn<span class="sc">==</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb199-270"><a href="point-cloud-classification.html#cb199-270" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_convex_hull</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-271"><a href="point-cloud-classification.html#cb199-271" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_simplify</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-272"><a href="point-cloud-classification.html#cb199-272" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-273"><a href="point-cloud-classification.html#cb199-273" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb199-274"><a href="point-cloud-classification.html#cb199-274" tabindex="-1"></a>              <span class="fu">st_remove_overlaps</span>()</span>
<span id="cb199-275"><a href="point-cloud-classification.html#cb199-275" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-276"><a href="point-cloud-classification.html#cb199-276" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb199-277"><a href="point-cloud-classification.html#cb199-277" tabindex="-1"></a>      }</span>
<span id="cb199-278"><a href="point-cloud-classification.html#cb199-278" tabindex="-1"></a>      <span class="cf">if</span>(stringr<span class="sc">::</span><span class="fu">str_length</span>(ofile)<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb199-279"><a href="point-cloud-classification.html#cb199-279" tabindex="-1"></a>        final_ans <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_write</span>(ofile, <span class="at">append =</span> F, <span class="at">quiet =</span> T)</span>
<span id="cb199-280"><a href="point-cloud-classification.html#cb199-280" tabindex="-1"></a>      }</span>
<span id="cb199-281"><a href="point-cloud-classification.html#cb199-281" tabindex="-1"></a>      </span>
<span id="cb199-282"><a href="point-cloud-classification.html#cb199-282" tabindex="-1"></a>    <span class="co"># return</span></span>
<span id="cb199-283"><a href="point-cloud-classification.html#cb199-283" tabindex="-1"></a>      <span class="fu">return</span>(final_ans)</span>
<span id="cb199-284"><a href="point-cloud-classification.html#cb199-284" tabindex="-1"></a>}</span>
<span id="cb199-285"><a href="point-cloud-classification.html#cb199-285" tabindex="-1"></a></span>
<span id="cb199-286"><a href="point-cloud-classification.html#cb199-286" tabindex="-1"></a></span>
<span id="cb199-287"><a href="point-cloud-classification.html#cb199-287" tabindex="-1"></a><span class="co"># param_combos_piles &lt;- </span></span>
<span id="cb199-288"><a href="point-cloud-classification.html#cb199-288" tabindex="-1"></a><span class="co">#   param_combos_df$rn %&gt;% </span></span>
<span id="cb199-289"><a href="point-cloud-classification.html#cb199-289" tabindex="-1"></a><span class="co">#   # sample(3) %&gt;% ## !!!!!!!!!!!!!!!!!!!! remove after testing</span></span>
<span id="cb199-290"><a href="point-cloud-classification.html#cb199-290" tabindex="-1"></a><span class="co">#   purrr::map(\(x)</span></span>
<span id="cb199-291"><a href="point-cloud-classification.html#cb199-291" tabindex="-1"></a><span class="co">#     slash_pile_detect_watershed(</span></span>
<span id="cb199-292"><a href="point-cloud-classification.html#cb199-292" tabindex="-1"></a><span class="co">#         chm_rast = cloud2raster_ans$chm_rast</span></span>
<span id="cb199-293"><a href="point-cloud-classification.html#cb199-293" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_df$max_ht_m[x]</span></span>
<span id="cb199-294"><a href="point-cloud-classification.html#cb199-294" tabindex="-1"></a><span class="co">#         , min_area_m2 = param_combos_df$min_area_m2[x]</span></span>
<span id="cb199-295"><a href="point-cloud-classification.html#cb199-295" tabindex="-1"></a><span class="co">#         , max_area_m2 = param_combos_df$max_area_m2[x]</span></span>
<span id="cb199-296"><a href="point-cloud-classification.html#cb199-296" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_df$convexity_pct[x]</span></span>
<span id="cb199-297"><a href="point-cloud-classification.html#cb199-297" tabindex="-1"></a><span class="co">#         , circle_fit_iou_pct = param_combos_df$circle_fit_iou_pct[x]</span></span>
<span id="cb199-298"><a href="point-cloud-classification.html#cb199-298" tabindex="-1"></a><span class="co">#       ) %&gt;% </span></span>
<span id="cb199-299"><a href="point-cloud-classification.html#cb199-299" tabindex="-1"></a><span class="co">#       dplyr::mutate(</span></span>
<span id="cb199-300"><a href="point-cloud-classification.html#cb199-300" tabindex="-1"></a><span class="co">#         rn = param_combos_df$rn[x]</span></span>
<span id="cb199-301"><a href="point-cloud-classification.html#cb199-301" tabindex="-1"></a><span class="co">#         , max_ht_m = param_combos_df$max_ht_m[x]</span></span>
<span id="cb199-302"><a href="point-cloud-classification.html#cb199-302" tabindex="-1"></a><span class="co">#         , min_area_m2 = param_combos_df$min_area_m2[x]</span></span>
<span id="cb199-303"><a href="point-cloud-classification.html#cb199-303" tabindex="-1"></a><span class="co">#         , max_area_m2 = param_combos_df$max_area_m2[x]</span></span>
<span id="cb199-304"><a href="point-cloud-classification.html#cb199-304" tabindex="-1"></a><span class="co">#         , convexity_pct = param_combos_df$convexity_pct[x]</span></span>
<span id="cb199-305"><a href="point-cloud-classification.html#cb199-305" tabindex="-1"></a><span class="co">#         , circle_fit_iou_pct = param_combos_df$circle_fit_iou_pct[x]</span></span>
<span id="cb199-306"><a href="point-cloud-classification.html#cb199-306" tabindex="-1"></a><span class="co">#       )</span></span>
<span id="cb199-307"><a href="point-cloud-classification.html#cb199-307" tabindex="-1"></a><span class="co">#   ) %&gt;% </span></span>
<span id="cb199-308"><a href="point-cloud-classification.html#cb199-308" tabindex="-1"></a><span class="co">#   dplyr::bind_rows()</span></span>
<span id="cb199-309"><a href="point-cloud-classification.html#cb199-309" tabindex="-1"></a></span>
<span id="cb199-310"><a href="point-cloud-classification.html#cb199-310" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% </span></span>
<span id="cb199-311"><a href="point-cloud-classification.html#cb199-311" tabindex="-1"></a><span class="co">#   sf::st_write(&quot;../data/param_combos_piles.gpkg&quot;, append = F)</span></span>
<span id="cb199-312"><a href="point-cloud-classification.html#cb199-312" tabindex="-1"></a><span class="co"># # param_combos_piles &lt;- sf::st_read(&quot;../data/param_combos_piles.gpkg&quot;)</span></span></code></pre></div>
<p>apply our function using the data frame of the parameter combinations</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="point-cloud-classification.html#cb200-1" tabindex="-1"></a>f_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/param_combos_piles.gpkg&quot;</span></span>
<span id="cb200-2"><a href="point-cloud-classification.html#cb200-2" tabindex="-1"></a>  <span class="co"># &quot;f:/PFDP_Data/sens_test_param_combos/param_combos_piles.gpkg&quot;</span></span>
<span id="cb200-3"><a href="point-cloud-classification.html#cb200-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(f_temp)){</span>
<span id="cb200-4"><a href="point-cloud-classification.html#cb200-4" tabindex="-1"></a>  param_combos_piles <span class="ot">&lt;-</span> <span class="fu">param_combos_piles_detect_fn</span>(</span>
<span id="cb200-5"><a href="point-cloud-classification.html#cb200-5" tabindex="-1"></a>    <span class="at">chm =</span> cloud2raster_ans<span class="sc">$</span>chm_rast</span>
<span id="cb200-6"><a href="point-cloud-classification.html#cb200-6" tabindex="-1"></a>    , <span class="at">param_combos_df =</span> param_combos_df</span>
<span id="cb200-7"><a href="point-cloud-classification.html#cb200-7" tabindex="-1"></a>    , <span class="at">smooth_segs =</span> T</span>
<span id="cb200-8"><a href="point-cloud-classification.html#cb200-8" tabindex="-1"></a>    , <span class="at">ofile =</span> f_temp</span>
<span id="cb200-9"><a href="point-cloud-classification.html#cb200-9" tabindex="-1"></a>  )</span>
<span id="cb200-10"><a href="point-cloud-classification.html#cb200-10" tabindex="-1"></a>  <span class="co"># when this was originally written, the pile area, height, and volume metrics were left out...let&#39;s add those</span></span>
<span id="cb200-11"><a href="point-cloud-classification.html#cb200-11" tabindex="-1"></a>    <span class="co">#    ;\</span></span>
<span id="cb200-12"><a href="point-cloud-classification.html#cb200-12" tabindex="-1"></a>    fix_area_vol_fn_temp <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb200-13"><a href="point-cloud-classification.html#cb200-13" tabindex="-1"></a>      chm_rast</span>
<span id="cb200-14"><a href="point-cloud-classification.html#cb200-14" tabindex="-1"></a>      , max_ht_m</span>
<span id="cb200-15"><a href="point-cloud-classification.html#cb200-15" tabindex="-1"></a>      , pile_polys</span>
<span id="cb200-16"><a href="point-cloud-classification.html#cb200-16" tabindex="-1"></a>    ) {</span>
<span id="cb200-17"><a href="point-cloud-classification.html#cb200-17" tabindex="-1"></a>      <span class="co"># just get the first layer and &quot;slice&quot; the raster based on the height threshold</span></span>
<span id="cb200-18"><a href="point-cloud-classification.html#cb200-18" tabindex="-1"></a>      chm_rast <span class="ot">&lt;-</span> chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb200-19"><a href="point-cloud-classification.html#cb200-19" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">subset</span>(<span class="at">subset =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb200-20"><a href="point-cloud-classification.html#cb200-20" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">clamp</span>(<span class="at">upper =</span> max_ht_m, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">values =</span> F)</span>
<span id="cb200-21"><a href="point-cloud-classification.html#cb200-21" tabindex="-1"></a>      <span class="co"># filterrrrrr</span></span>
<span id="cb200-22"><a href="point-cloud-classification.html#cb200-22" tabindex="-1"></a>      pile_polys <span class="ot">&lt;-</span> pile_polys <span class="sc">%&gt;%</span> </span>
<span id="cb200-23"><a href="point-cloud-classification.html#cb200-23" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(max_ht_m<span class="sc">==</span>max_ht_m)</span>
<span id="cb200-24"><a href="point-cloud-classification.html#cb200-24" tabindex="-1"></a>      <span class="co"># stuff</span></span>
<span id="cb200-25"><a href="point-cloud-classification.html#cb200-25" tabindex="-1"></a>      area_rast_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">cellSize</span>(chm_rast) <span class="sc">%&gt;%</span> </span>
<span id="cb200-26"><a href="point-cloud-classification.html#cb200-26" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">mask</span>(chm_rast)</span>
<span id="cb200-27"><a href="point-cloud-classification.html#cb200-27" tabindex="-1"></a>      <span class="fu">names</span>(area_rast_temp) <span class="ot">&lt;-</span> <span class="st">&quot;area_m2&quot;</span></span>
<span id="cb200-28"><a href="point-cloud-classification.html#cb200-28" tabindex="-1"></a>      <span class="co"># then, multiply area by the CHM (elevation) for each cell to get a raster with cell volumes</span></span>
<span id="cb200-29"><a href="point-cloud-classification.html#cb200-29" tabindex="-1"></a>      vol_rast_temp <span class="ot">&lt;-</span> area_rast_temp<span class="sc">*</span>chm_rast</span>
<span id="cb200-30"><a href="point-cloud-classification.html#cb200-30" tabindex="-1"></a>      <span class="fu">names</span>(vol_rast_temp) <span class="ot">&lt;-</span> <span class="st">&quot;volume_m3&quot;</span></span>
<span id="cb200-31"><a href="point-cloud-classification.html#cb200-31" tabindex="-1"></a>      <span class="co"># sum area within each segment to get the total area</span></span>
<span id="cb200-32"><a href="point-cloud-classification.html#cb200-32" tabindex="-1"></a>      area_df_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(</span>
<span id="cb200-33"><a href="point-cloud-classification.html#cb200-33" tabindex="-1"></a>        <span class="at">x =</span> area_rast_temp</span>
<span id="cb200-34"><a href="point-cloud-classification.html#cb200-34" tabindex="-1"></a>        , <span class="at">z =</span> pile_polys <span class="sc">%&gt;%</span> </span>
<span id="cb200-35"><a href="point-cloud-classification.html#cb200-35" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb200-36"><a href="point-cloud-classification.html#cb200-36" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb200-37"><a href="point-cloud-classification.html#cb200-37" tabindex="-1"></a>        , <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T</span>
<span id="cb200-38"><a href="point-cloud-classification.html#cb200-38" tabindex="-1"></a>      )</span>
<span id="cb200-39"><a href="point-cloud-classification.html#cb200-39" tabindex="-1"></a>      <span class="co"># area_df_temp %&gt;% dplyr::glimpse()</span></span>
<span id="cb200-40"><a href="point-cloud-classification.html#cb200-40" tabindex="-1"></a>      <span class="co"># sum volume within each segment to get the total volume</span></span>
<span id="cb200-41"><a href="point-cloud-classification.html#cb200-41" tabindex="-1"></a>      vol_df_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(</span>
<span id="cb200-42"><a href="point-cloud-classification.html#cb200-42" tabindex="-1"></a>        <span class="at">x =</span> vol_rast_temp</span>
<span id="cb200-43"><a href="point-cloud-classification.html#cb200-43" tabindex="-1"></a>        , <span class="at">z =</span> pile_polys <span class="sc">%&gt;%</span> </span>
<span id="cb200-44"><a href="point-cloud-classification.html#cb200-44" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb200-45"><a href="point-cloud-classification.html#cb200-45" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb200-46"><a href="point-cloud-classification.html#cb200-46" tabindex="-1"></a>        , <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> T</span>
<span id="cb200-47"><a href="point-cloud-classification.html#cb200-47" tabindex="-1"></a>      )</span>
<span id="cb200-48"><a href="point-cloud-classification.html#cb200-48" tabindex="-1"></a>      <span class="co"># max ht within each segment to get the max ht</span></span>
<span id="cb200-49"><a href="point-cloud-classification.html#cb200-49" tabindex="-1"></a>      ht_df_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(</span>
<span id="cb200-50"><a href="point-cloud-classification.html#cb200-50" tabindex="-1"></a>          <span class="at">x =</span> chm_rast</span>
<span id="cb200-51"><a href="point-cloud-classification.html#cb200-51" tabindex="-1"></a>          , <span class="at">z =</span> pile_polys <span class="sc">%&gt;%</span> </span>
<span id="cb200-52"><a href="point-cloud-classification.html#cb200-52" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb200-53"><a href="point-cloud-classification.html#cb200-53" tabindex="-1"></a>            terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb200-54"><a href="point-cloud-classification.html#cb200-54" tabindex="-1"></a>          , <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>, <span class="at">na.rm =</span> T</span>
<span id="cb200-55"><a href="point-cloud-classification.html#cb200-55" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb200-56"><a href="point-cloud-classification.html#cb200-56" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">max_height_m=</span><span class="dv">1</span>)</span>
<span id="cb200-57"><a href="point-cloud-classification.html#cb200-57" tabindex="-1"></a>      <span class="co"># vectors of segments</span></span>
<span id="cb200-58"><a href="point-cloud-classification.html#cb200-58" tabindex="-1"></a>      pile_polys <span class="ot">&lt;-</span></span>
<span id="cb200-59"><a href="point-cloud-classification.html#cb200-59" tabindex="-1"></a>        pile_polys <span class="sc">%&gt;%</span> </span>
<span id="cb200-60"><a href="point-cloud-classification.html#cb200-60" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb200-61"><a href="point-cloud-classification.html#cb200-61" tabindex="-1"></a>          area_df_temp, vol_df_temp, ht_df_temp</span>
<span id="cb200-62"><a href="point-cloud-classification.html#cb200-62" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb200-63"><a href="point-cloud-classification.html#cb200-63" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb200-64"><a href="point-cloud-classification.html#cb200-64" tabindex="-1"></a>          <span class="at">volume_per_area =</span> volume_m3<span class="sc">/</span>area_m2</span>
<span id="cb200-65"><a href="point-cloud-classification.html#cb200-65" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb200-66"><a href="point-cloud-classification.html#cb200-66" tabindex="-1"></a>        <span class="co"># now we need to re-do the volume and area calculations</span></span>
<span id="cb200-67"><a href="point-cloud-classification.html#cb200-67" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb200-68"><a href="point-cloud-classification.html#cb200-68" tabindex="-1"></a>          <span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb200-69"><a href="point-cloud-classification.html#cb200-69" tabindex="-1"></a>          , <span class="at">volume_m3 =</span> area_m2<span class="sc">*</span>volume_per_area</span>
<span id="cb200-70"><a href="point-cloud-classification.html#cb200-70" tabindex="-1"></a>        )</span>
<span id="cb200-71"><a href="point-cloud-classification.html#cb200-71" tabindex="-1"></a>      <span class="fu">return</span>(pile_polys)</span>
<span id="cb200-72"><a href="point-cloud-classification.html#cb200-72" tabindex="-1"></a>    }</span>
<span id="cb200-73"><a href="point-cloud-classification.html#cb200-73" tabindex="-1"></a>    <span class="co"># map it</span></span>
<span id="cb200-74"><a href="point-cloud-classification.html#cb200-74" tabindex="-1"></a>    param_combos_piles <span class="ot">&lt;-</span></span>
<span id="cb200-75"><a href="point-cloud-classification.html#cb200-75" tabindex="-1"></a>      <span class="fu">unique</span>(param_combos_piles<span class="sc">$</span>max_ht_m) <span class="sc">%&gt;%</span> </span>
<span id="cb200-76"><a href="point-cloud-classification.html#cb200-76" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb200-77"><a href="point-cloud-classification.html#cb200-77" tabindex="-1"></a>        <span class="fu">fix_area_vol_fn_temp</span>(</span>
<span id="cb200-78"><a href="point-cloud-classification.html#cb200-78" tabindex="-1"></a>          <span class="at">chm_rast =</span> cloud2raster_ans<span class="sc">$</span>chm_rast</span>
<span id="cb200-79"><a href="point-cloud-classification.html#cb200-79" tabindex="-1"></a>          , <span class="at">max_ht_m =</span> x</span>
<span id="cb200-80"><a href="point-cloud-classification.html#cb200-80" tabindex="-1"></a>          , <span class="at">pile_polys =</span> param_combos_piles <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(max_ht_m<span class="sc">==</span>x)</span>
<span id="cb200-81"><a href="point-cloud-classification.html#cb200-81" tabindex="-1"></a>        )</span>
<span id="cb200-82"><a href="point-cloud-classification.html#cb200-82" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb200-83"><a href="point-cloud-classification.html#cb200-83" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb200-84"><a href="point-cloud-classification.html#cb200-84" tabindex="-1"></a>    <span class="co"># param_combos_piles %&gt;% dplyr::glimpse()</span></span>
<span id="cb200-85"><a href="point-cloud-classification.html#cb200-85" tabindex="-1"></a>    <span class="co"># save it</span></span>
<span id="cb200-86"><a href="point-cloud-classification.html#cb200-86" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_write</span>(param_combos_piles, f_temp, <span class="at">append =</span> F, <span class="at">quiet =</span> T)</span>
<span id="cb200-87"><a href="point-cloud-classification.html#cb200-87" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb200-88"><a href="point-cloud-classification.html#cb200-88" tabindex="-1"></a>  param_combos_piles <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(f_temp, <span class="at">quiet =</span> T)</span>
<span id="cb200-89"><a href="point-cloud-classification.html#cb200-89" tabindex="-1"></a>}</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="point-cloud-classification.html#cb201-1" tabindex="-1"></a>param_combos_piles <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 628,683
## Columns: 14
## $ pred_id            &lt;dbl&gt; 12, 16, 20, 24, 38, 43, 52, 53, 54, 55, 57, 76, 89,…
## $ max_ht_m           &lt;dbl&gt; 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, …
## $ min_area_m2        &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ max_area_m2        &lt;dbl&gt; 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40,…
## $ convexity_pct      &lt;dbl&gt; 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0…
## $ record_id          &lt;int&gt; 3, 4, 5, 6, 8, 9, 11, 12, 13, 14, 15, 16, 17, 20, 2…
## $ rn                 &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
## $ circle_fit_iou_pct &lt;dbl&gt; 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0…
## $ iou                &lt;dbl&gt; 0.3627501, 0.4436463, 0.4199539, 0.3680601, 0.71855…
## $ area_m2            &lt;dbl&gt; 5.820766e-11, 3.680000e+00, 0.000000e+00, 5.600000e…
## $ volume_m3          &lt;dbl&gt; 1.325388e-10, 1.265935e+01, NA, 1.420662e+01, 1.867…
## $ max_height_m       &lt;dbl&gt; 2.277000, 4.000000, NA, 4.000000, 3.999429, NA, 3.9…
## $ volume_per_area    &lt;dbl&gt; 2.2770000, 3.4400403, NA, 2.5368959, 2.0166748, NA,…
## $ geom               &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((499740.7 43..., MULTIP…</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="point-cloud-classification.html#cb203-1" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% sf::st_drop_geometry() %&gt;% dplyr::count(rn) %&gt;% dplyr::slice_head(n=6)</span></span>
<span id="cb203-2"><a href="point-cloud-classification.html#cb203-2" tabindex="-1"></a><span class="co"># terra::plot(cloud2raster_ans$chm_rast, col = viridis::plasma(100), axes = F)</span></span>
<span id="cb203-3"><a href="point-cloud-classification.html#cb203-3" tabindex="-1"></a><span class="co"># terra::plot(param_combos_piles %&gt;% dplyr::filter(rn==param_combos_piles$rn[2222]) %&gt;% terra::vect(),add = T, border = &quot;gray44&quot;, col = NA, lwd = 3)</span></span></code></pre></div>
<p>now we need to validate these combinations against the ground truth data and we can map over the <code>ground_truth_prediction_match()</code> function</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="point-cloud-classification.html#cb204-1" tabindex="-1"></a>f_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/param_combos_gt.csv&quot;</span></span>
<span id="cb204-2"><a href="point-cloud-classification.html#cb204-2" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(f_temp)){</span>
<span id="cb204-3"><a href="point-cloud-classification.html#cb204-3" tabindex="-1"></a>  param_combos_gt <span class="ot">&lt;-</span> </span>
<span id="cb204-4"><a href="point-cloud-classification.html#cb204-4" tabindex="-1"></a>    <span class="fu">unique</span>(param_combos_df<span class="sc">$</span>rn) <span class="sc">%&gt;%</span> </span>
<span id="cb204-5"><a href="point-cloud-classification.html#cb204-5" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb204-6"><a href="point-cloud-classification.html#cb204-6" tabindex="-1"></a>      <span class="fu">ground_truth_prediction_match</span>(</span>
<span id="cb204-7"><a href="point-cloud-classification.html#cb204-7" tabindex="-1"></a>        <span class="at">ground_truth =</span> slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb204-8"><a href="point-cloud-classification.html#cb204-8" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb204-9"><a href="point-cloud-classification.html#cb204-9" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(diameter)) <span class="sc">%&gt;%</span> </span>
<span id="cb204-10"><a href="point-cloud-classification.html#cb204-10" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb204-11"><a href="point-cloud-classification.html#cb204-11" tabindex="-1"></a>        , <span class="at">gt_id =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb204-12"><a href="point-cloud-classification.html#cb204-12" tabindex="-1"></a>        , <span class="at">predictions =</span> param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb204-13"><a href="point-cloud-classification.html#cb204-13" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb204-14"><a href="point-cloud-classification.html#cb204-14" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb204-15"><a href="point-cloud-classification.html#cb204-15" tabindex="-1"></a>            pred_id <span class="sc">%in%</span> (param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb204-16"><a href="point-cloud-classification.html#cb204-16" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb204-17"><a href="point-cloud-classification.html#cb204-17" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb204-18"><a href="point-cloud-classification.html#cb204-18" tabindex="-1"></a>                stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb204-19"><a href="point-cloud-classification.html#cb204-19" tabindex="-1"></a>                  sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb204-20"><a href="point-cloud-classification.html#cb204-20" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span> </span>
<span id="cb204-21"><a href="point-cloud-classification.html#cb204-21" tabindex="-1"></a>              sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb204-22"><a href="point-cloud-classification.html#cb204-22" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">pull</span>(pred_id))</span>
<span id="cb204-23"><a href="point-cloud-classification.html#cb204-23" tabindex="-1"></a>          )</span>
<span id="cb204-24"><a href="point-cloud-classification.html#cb204-24" tabindex="-1"></a>        , <span class="at">pred_id =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb204-25"><a href="point-cloud-classification.html#cb204-25" tabindex="-1"></a>        , <span class="at">min_iou_pct =</span> <span class="fl">0.05</span></span>
<span id="cb204-26"><a href="point-cloud-classification.html#cb204-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb204-27"><a href="point-cloud-classification.html#cb204-27" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn=</span>x)</span>
<span id="cb204-28"><a href="point-cloud-classification.html#cb204-28" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb204-29"><a href="point-cloud-classification.html#cb204-29" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb204-30"><a href="point-cloud-classification.html#cb204-30" tabindex="-1"></a>  param_combos_gt <span class="sc">%&gt;%</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(f_temp, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span>
<span id="cb204-31"><a href="point-cloud-classification.html#cb204-31" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb204-32"><a href="point-cloud-classification.html#cb204-32" tabindex="-1"></a>  param_combos_gt <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(f_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb204-33"><a href="point-cloud-classification.html#cb204-33" tabindex="-1"></a>}</span>
<span id="cb204-34"><a href="point-cloud-classification.html#cb204-34" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb204-35"><a href="point-cloud-classification.html#cb204-35" tabindex="-1"></a>param_combos_gt <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span>
<span id="cb204-36"><a href="point-cloud-classification.html#cb204-36" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::filter(pile_id==120)</span></span></code></pre></div>
<p>let’s attach a flag to only work with piles that intersect with the stand boundary and add the area of the ground truth and predicted piles</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="point-cloud-classification.html#cb205-1" tabindex="-1"></a><span class="co"># let&#39;s attach a flag to only work with piles that intersect with the stand boundary</span></span>
<span id="cb205-2"><a href="point-cloud-classification.html#cb205-2" tabindex="-1"></a><span class="co"># add in/out to piles data</span></span>
<span id="cb205-3"><a href="point-cloud-classification.html#cb205-3" tabindex="-1"></a>param_combos_piles <span class="ot">&lt;-</span> param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb205-4"><a href="point-cloud-classification.html#cb205-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb205-5"><a href="point-cloud-classification.html#cb205-5" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb205-6"><a href="point-cloud-classification.html#cb205-6" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb205-7"><a href="point-cloud-classification.html#cb205-7" tabindex="-1"></a>        stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb205-8"><a href="point-cloud-classification.html#cb205-8" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb205-9"><a href="point-cloud-classification.html#cb205-9" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-10"><a href="point-cloud-classification.html#cb205-10" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb205-11"><a href="point-cloud-classification.html#cb205-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(rn,pred_id) <span class="sc">%&gt;%</span> </span>
<span id="cb205-12"><a href="point-cloud-classification.html#cb205-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_in_stand =</span> T)</span>
<span id="cb205-13"><a href="point-cloud-classification.html#cb205-13" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb205-14"><a href="point-cloud-classification.html#cb205-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-15"><a href="point-cloud-classification.html#cb205-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb205-16"><a href="point-cloud-classification.html#cb205-16" tabindex="-1"></a>    <span class="at">is_in_stand =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_in_stand,F)</span>
<span id="cb205-17"><a href="point-cloud-classification.html#cb205-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-18"><a href="point-cloud-classification.html#cb205-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(area_m2<span class="sc">&gt;=</span>min_area_m2 <span class="sc">&amp;</span> area_m2<span class="sc">&lt;=</span>max_area_m2)</span>
<span id="cb205-19"><a href="point-cloud-classification.html#cb205-19" tabindex="-1"></a></span>
<span id="cb205-20"><a href="point-cloud-classification.html#cb205-20" tabindex="-1"></a><span class="co"># param_combos_piles %&gt;% dplyr::glimpse()</span></span>
<span id="cb205-21"><a href="point-cloud-classification.html#cb205-21" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::glimpse()</span></span>
<span id="cb205-22"><a href="point-cloud-classification.html#cb205-22" tabindex="-1"></a><span class="co"># param_combos_gt %&gt;% dplyr::slice_sample(prop = 0.05) %&gt;% dplyr::count(match_grp)</span></span>
<span id="cb205-23"><a href="point-cloud-classification.html#cb205-23" tabindex="-1"></a><span class="co"># add it to validation</span></span>
<span id="cb205-24"><a href="point-cloud-classification.html#cb205-24" tabindex="-1"></a>param_combos_gt <span class="ot">&lt;-</span></span>
<span id="cb205-25"><a href="point-cloud-classification.html#cb205-25" tabindex="-1"></a>  param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb205-26"><a href="point-cloud-classification.html#cb205-26" tabindex="-1"></a>  <span class="co"># add area of gt</span></span>
<span id="cb205-27"><a href="point-cloud-classification.html#cb205-27" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb205-28"><a href="point-cloud-classification.html#cb205-28" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb205-29"><a href="point-cloud-classification.html#cb205-29" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb205-30"><a href="point-cloud-classification.html#cb205-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,image_gt_area_m2,field_gt_area_m2,image_gt_volume_m3,field_gt_volume_m3,height_m) <span class="sc">%&gt;%</span> </span>
<span id="cb205-31"><a href="point-cloud-classification.html#cb205-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">gt_height_m =</span> height_m) <span class="sc">%&gt;%</span> </span>
<span id="cb205-32"><a href="point-cloud-classification.html#cb205-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id=</span><span class="fu">as.numeric</span>(pile_id))</span>
<span id="cb205-33"><a href="point-cloud-classification.html#cb205-33" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb205-34"><a href="point-cloud-classification.html#cb205-34" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-35"><a href="point-cloud-classification.html#cb205-35" tabindex="-1"></a>  <span class="co"># add info from predictions</span></span>
<span id="cb205-36"><a href="point-cloud-classification.html#cb205-36" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb205-37"><a href="point-cloud-classification.html#cb205-37" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span></span>
<span id="cb205-38"><a href="point-cloud-classification.html#cb205-38" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb205-39"><a href="point-cloud-classification.html#cb205-39" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb205-40"><a href="point-cloud-classification.html#cb205-40" tabindex="-1"></a>        rn,pred_id</span>
<span id="cb205-41"><a href="point-cloud-classification.html#cb205-41" tabindex="-1"></a>        ,is_in_stand</span>
<span id="cb205-42"><a href="point-cloud-classification.html#cb205-42" tabindex="-1"></a>        , area_m2, volume_m3, max_height_m</span>
<span id="cb205-43"><a href="point-cloud-classification.html#cb205-43" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-44"><a href="point-cloud-classification.html#cb205-44" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb205-45"><a href="point-cloud-classification.html#cb205-45" tabindex="-1"></a>        <span class="at">pred_area_m2 =</span> area_m2, <span class="at">pred_volume_m3 =</span> volume_m3, <span class="at">pred_height_m =</span> max_height_m</span>
<span id="cb205-46"><a href="point-cloud-classification.html#cb205-46" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-47"><a href="point-cloud-classification.html#cb205-47" tabindex="-1"></a>      <span class="co"># add volume assuming cone or conical shape</span></span>
<span id="cb205-48"><a href="point-cloud-classification.html#cb205-48" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb205-49"><a href="point-cloud-classification.html#cb205-49" tabindex="-1"></a>        <span class="at">pred_cone_volume_m3 =</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span>pi<span class="sc">*</span>(<span class="fu">sqrt</span>(pred_area_m2<span class="sc">/</span>pi)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>pred_height_m <span class="co"># sqrt(pred_area_m2/pi) = radius assuming of circle covering same area</span></span>
<span id="cb205-50"><a href="point-cloud-classification.html#cb205-50" tabindex="-1"></a>      )</span>
<span id="cb205-51"><a href="point-cloud-classification.html#cb205-51" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(rn,pred_id)</span>
<span id="cb205-52"><a href="point-cloud-classification.html#cb205-52" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb205-53"><a href="point-cloud-classification.html#cb205-53" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb205-54"><a href="point-cloud-classification.html#cb205-54" tabindex="-1"></a>    <span class="at">is_in_stand =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb205-55"><a href="point-cloud-classification.html#cb205-55" tabindex="-1"></a>      is_in_stand <span class="sc">==</span> T <span class="sc">~</span> T</span>
<span id="cb205-56"><a href="point-cloud-classification.html#cb205-56" tabindex="-1"></a>      , is_in_stand <span class="sc">==</span> F <span class="sc">~</span> F</span>
<span id="cb205-57"><a href="point-cloud-classification.html#cb205-57" tabindex="-1"></a>      , match_grp <span class="sc">==</span> <span class="st">&quot;omission&quot;</span> <span class="sc">~</span> T</span>
<span id="cb205-58"><a href="point-cloud-classification.html#cb205-58" tabindex="-1"></a>      , T <span class="sc">~</span> F</span>
<span id="cb205-59"><a href="point-cloud-classification.html#cb205-59" tabindex="-1"></a>    )</span>
<span id="cb205-60"><a href="point-cloud-classification.html#cb205-60" tabindex="-1"></a>    <span class="do">### calculate these based on the formulas below...agg_ground_truth_match() depends on those formulas</span></span>
<span id="cb205-61"><a href="point-cloud-classification.html#cb205-61" tabindex="-1"></a>    <span class="co"># area diffs</span></span>
<span id="cb205-62"><a href="point-cloud-classification.html#cb205-62" tabindex="-1"></a>    , <span class="at">height_diff =</span> pred_height_m<span class="sc">-</span>gt_height_m</span>
<span id="cb205-63"><a href="point-cloud-classification.html#cb205-63" tabindex="-1"></a>    , <span class="at">pct_diff_height =</span> (gt_height_m<span class="sc">-</span>pred_height_m)<span class="sc">/</span>gt_height_m</span>
<span id="cb205-64"><a href="point-cloud-classification.html#cb205-64" tabindex="-1"></a>    <span class="co"># area diffs</span></span>
<span id="cb205-65"><a href="point-cloud-classification.html#cb205-65" tabindex="-1"></a>    , <span class="at">area_diff_image =</span> pred_area_m2<span class="sc">-</span>image_gt_area_m2</span>
<span id="cb205-66"><a href="point-cloud-classification.html#cb205-66" tabindex="-1"></a>    , <span class="at">pct_diff_area_image =</span> (image_gt_area_m2<span class="sc">-</span>pred_area_m2)<span class="sc">/</span>image_gt_area_m2</span>
<span id="cb205-67"><a href="point-cloud-classification.html#cb205-67" tabindex="-1"></a>    , <span class="at">area_diff_field =</span> pred_area_m2<span class="sc">-</span>field_gt_area_m2</span>
<span id="cb205-68"><a href="point-cloud-classification.html#cb205-68" tabindex="-1"></a>    , <span class="at">pct_diff_area_field =</span> (field_gt_area_m2<span class="sc">-</span>pred_area_m2)<span class="sc">/</span>field_gt_area_m2</span>
<span id="cb205-69"><a href="point-cloud-classification.html#cb205-69" tabindex="-1"></a>    <span class="co"># volume diffs</span></span>
<span id="cb205-70"><a href="point-cloud-classification.html#cb205-70" tabindex="-1"></a>    , <span class="at">volume_diff_image =</span> pred_volume_m3<span class="sc">-</span>image_gt_volume_m3</span>
<span id="cb205-71"><a href="point-cloud-classification.html#cb205-71" tabindex="-1"></a>    , <span class="at">pct_diff_volume_image =</span> (image_gt_volume_m3<span class="sc">-</span>pred_volume_m3)<span class="sc">/</span>image_gt_volume_m3</span>
<span id="cb205-72"><a href="point-cloud-classification.html#cb205-72" tabindex="-1"></a>    , <span class="at">volume_diff_field =</span> pred_volume_m3<span class="sc">-</span>field_gt_volume_m3</span>
<span id="cb205-73"><a href="point-cloud-classification.html#cb205-73" tabindex="-1"></a>    , <span class="at">pct_diff_volume_field =</span> (field_gt_volume_m3<span class="sc">-</span>pred_volume_m3)<span class="sc">/</span>field_gt_volume_m3</span>
<span id="cb205-74"><a href="point-cloud-classification.html#cb205-74" tabindex="-1"></a>    <span class="co"># volume diffs cone</span></span>
<span id="cb205-75"><a href="point-cloud-classification.html#cb205-75" tabindex="-1"></a>    , <span class="at">cone_volume_diff_image =</span> pred_cone_volume_m3<span class="sc">-</span>image_gt_volume_m3</span>
<span id="cb205-76"><a href="point-cloud-classification.html#cb205-76" tabindex="-1"></a>    , <span class="at">cone_volume_diff_field =</span> pred_cone_volume_m3<span class="sc">-</span>field_gt_volume_m3</span>
<span id="cb205-77"><a href="point-cloud-classification.html#cb205-77" tabindex="-1"></a>  )</span>
<span id="cb205-78"><a href="point-cloud-classification.html#cb205-78" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb205-79"><a href="point-cloud-classification.html#cb205-79" tabindex="-1"></a>param_combos_gt <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<p>let’s look at one combination spatially</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="point-cloud-classification.html#cb206-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb206-2"><a href="point-cloud-classification.html#cb206-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb206-3"><a href="point-cloud-classification.html#cb206-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb206-4"><a href="point-cloud-classification.html#cb206-4" tabindex="-1"></a>    <span class="at">data =</span> stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb206-5"><a href="point-cloud-classification.html#cb206-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb206-6"><a href="point-cloud-classification.html#cb206-6" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb206-7"><a href="point-cloud-classification.html#cb206-7" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb206-8"><a href="point-cloud-classification.html#cb206-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb206-9"><a href="point-cloud-classification.html#cb206-9" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb206-10"><a href="point-cloud-classification.html#cb206-10" tabindex="-1"></a>      slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb206-11"><a href="point-cloud-classification.html#cb206-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb206-12"><a href="point-cloud-classification.html#cb206-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles)) <span class="sc">%&gt;%</span> </span>
<span id="cb206-13"><a href="point-cloud-classification.html#cb206-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id=</span><span class="fu">as.numeric</span>(pile_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb206-14"><a href="point-cloud-classification.html#cb206-14" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb206-15"><a href="point-cloud-classification.html#cb206-15" tabindex="-1"></a>          param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb206-16"><a href="point-cloud-classification.html#cb206-16" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> param_combos_gt<span class="sc">$</span>rn[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb206-17"><a href="point-cloud-classification.html#cb206-17" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb206-18"><a href="point-cloud-classification.html#cb206-18" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb206-19"><a href="point-cloud-classification.html#cb206-19" tabindex="-1"></a>        )</span>
<span id="cb206-20"><a href="point-cloud-classification.html#cb206-20" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb206-21"><a href="point-cloud-classification.html#cb206-21" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb206-22"><a href="point-cloud-classification.html#cb206-22" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb206-23"><a href="point-cloud-classification.html#cb206-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb206-24"><a href="point-cloud-classification.html#cb206-24" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb206-25"><a href="point-cloud-classification.html#cb206-25" tabindex="-1"></a>      param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb206-26"><a href="point-cloud-classification.html#cb206-26" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> param_combos_gt<span class="sc">$</span>rn[<span class="dv">1</span>] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb206-27"><a href="point-cloud-classification.html#cb206-27" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb206-28"><a href="point-cloud-classification.html#cb206-28" tabindex="-1"></a>          param_combos_gt <span class="sc">%&gt;%</span></span>
<span id="cb206-29"><a href="point-cloud-classification.html#cb206-29" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> param_combos_gt<span class="sc">$</span>rn[<span class="dv">1</span>] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb206-30"><a href="point-cloud-classification.html#cb206-30" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb206-31"><a href="point-cloud-classification.html#cb206-31" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb206-32"><a href="point-cloud-classification.html#cb206-32" tabindex="-1"></a>        )</span>
<span id="cb206-33"><a href="point-cloud-classification.html#cb206-33" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb206-34"><a href="point-cloud-classification.html#cb206-34" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb206-35"><a href="point-cloud-classification.html#cb206-35" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">0.7</span></span>
<span id="cb206-36"><a href="point-cloud-classification.html#cb206-36" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb206-37"><a href="point-cloud-classification.html#cb206-37" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb206-38"><a href="point-cloud-classification.html#cb206-38" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb206-39"><a href="point-cloud-classification.html#cb206-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb206-40"><a href="point-cloud-classification.html#cb206-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb206-41"><a href="point-cloud-classification.html#cb206-41" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb206-42"><a href="point-cloud-classification.html#cb206-42" tabindex="-1"></a>    , <span class="at">panel.background =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;gray66&quot;</span>)</span>
<span id="cb206-43"><a href="point-cloud-classification.html#cb206-43" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb206-44"><a href="point-cloud-classification.html#cb206-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb206-45"><a href="point-cloud-classification.html#cb206-45" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(pal_match_grp[<span class="st">&quot;commission&quot;</span>],<span class="cn">NA</span>,<span class="cn">NA</span>)))</span>
<span id="cb206-46"><a href="point-cloud-classification.html#cb206-46" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb206-47"><a href="point-cloud-classification.html#cb206-47" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-177-1.png" width="1008" /></p>
<p>now we need to aggregate these single tree level results to a single line (for each parameter combination in this instance). let’s make a function to do this that can also calculate RMSE for any column name that contains “diff_” but doesn’t start with “pct_”…this could be a handy function for any analysis comparing predictions to ground truth data.</p>
<p>in addition to RMSE, we’ll calculate the mean error (ME) and the mean absolute percentage error (MAPE) for the respective values:</p>
<p><span class="math display">\[
\textrm{ME} = \frac{  \sum_{i=1}^{N} (\hat{y_{i}} - y_{i})}{N}
\]</span>
<span class="math display">\[
\textrm{MAPE} = \frac{1}{N} \sum_{i=1}^{N} \left| \frac{y_{i} - \hat{y_{i}}}{y_{i}} \right|
\]</span></p>
<p>Where <span class="math inline">\(N\)</span> is equal to the total number of correctly matched piles, <span class="math inline">\(y_i\)</span> is the ground truth measured value and <span class="math inline">\(\hat{y_i}\)</span> is the predicted value of <span class="math inline">\(i\)</span></p>
<p>we could also calculate Relative RMSE (RRMSE)</p>
<p><span class="math display">\[
\textrm{RRMSE} = \frac{\text{RMSE}}{\bar{y}} \times 100\%
\]</span></p>
<p>where, <span class="math inline">\(\bar{y}\)</span> represents the mean of the ground truth values. the interpretations of RMSE and RRMSE are:</p>
<ul>
<li>RMSE: Measures the average magnitude of the differences between predicted and the actual observed values, expressed in the same units as the metric.</li>
<li>RRMSE: Expresses RMSE as a percentage of the mean of the observed values, providing a scale-independent measure to compare model accuracy across different datasets or models.</li>
</ul>
<p>for this analysis, we’ll show how to calculate RRMSE but we’ll only investigate MAPE:</p>
<ul>
<li>Use MAPE when: You need an easily understandable metric for comparing prediction accuracy across different series or models with varying scales, particularly when zeros or near-zero actual values are not present in your data.</li>
<li>Use RRMSE when: You need a metric that is more robust to small or zero actual values and you want to penalize larger errors more heavily due to the squaring of errors in its calculation.</li>
</ul>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="point-cloud-classification.html#cb207-1" tabindex="-1"></a><span class="co"># first function takes df with cols tp_n, fp_n, and fn_n to calculate rate</span></span>
<span id="cb207-2"><a href="point-cloud-classification.html#cb207-2" tabindex="-1"></a>confusion_matrix_scores_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb207-3"><a href="point-cloud-classification.html#cb207-3" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb207-4"><a href="point-cloud-classification.html#cb207-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb207-5"><a href="point-cloud-classification.html#cb207-5" tabindex="-1"></a>    <span class="at">omission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-6"><a href="point-cloud-classification.html#cb207-6" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-7"><a href="point-cloud-classification.html#cb207-7" tabindex="-1"></a>      , T <span class="sc">~</span> fn_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb207-8"><a href="point-cloud-classification.html#cb207-8" tabindex="-1"></a>    ) <span class="co"># False Negative Rate or Miss Rate</span></span>
<span id="cb207-9"><a href="point-cloud-classification.html#cb207-9" tabindex="-1"></a>    , <span class="at">commission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-10"><a href="point-cloud-classification.html#cb207-10" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-11"><a href="point-cloud-classification.html#cb207-11" tabindex="-1"></a>      , T <span class="sc">~</span> fp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb207-12"><a href="point-cloud-classification.html#cb207-12" tabindex="-1"></a>    ) <span class="co"># False Positive Rate</span></span>
<span id="cb207-13"><a href="point-cloud-classification.html#cb207-13" tabindex="-1"></a>    , <span class="at">precision =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-14"><a href="point-cloud-classification.html#cb207-14" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-15"><a href="point-cloud-classification.html#cb207-15" tabindex="-1"></a>      , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb207-16"><a href="point-cloud-classification.html#cb207-16" tabindex="-1"></a>    )</span>
<span id="cb207-17"><a href="point-cloud-classification.html#cb207-17" tabindex="-1"></a>    , <span class="at">recall =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-18"><a href="point-cloud-classification.html#cb207-18" tabindex="-1"></a>      (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-19"><a href="point-cloud-classification.html#cb207-19" tabindex="-1"></a>      , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb207-20"><a href="point-cloud-classification.html#cb207-20" tabindex="-1"></a>    )</span>
<span id="cb207-21"><a href="point-cloud-classification.html#cb207-21" tabindex="-1"></a>    , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-22"><a href="point-cloud-classification.html#cb207-22" tabindex="-1"></a>      <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-23"><a href="point-cloud-classification.html#cb207-23" tabindex="-1"></a>      , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb207-24"><a href="point-cloud-classification.html#cb207-24" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb207-25"><a href="point-cloud-classification.html#cb207-25" tabindex="-1"></a>    )    </span>
<span id="cb207-26"><a href="point-cloud-classification.html#cb207-26" tabindex="-1"></a>  ) </span>
<span id="cb207-27"><a href="point-cloud-classification.html#cb207-27" tabindex="-1"></a>}</span>
<span id="cb207-28"><a href="point-cloud-classification.html#cb207-28" tabindex="-1"></a><span class="co"># aggregate results from ground_truth_prediction_match()</span></span>
<span id="cb207-29"><a href="point-cloud-classification.html#cb207-29" tabindex="-1"></a>agg_ground_truth_match <span class="ot">&lt;-</span> <span class="cf">function</span>(ground_truth_prediction_match_ans) {</span>
<span id="cb207-30"><a href="point-cloud-classification.html#cb207-30" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(ground_truth_prediction_match_ans)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb207-31"><a href="point-cloud-classification.html#cb207-31" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(ground_truth_prediction_match_ans) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){<span class="fu">stop</span>(<span class="st">&quot;ground_truth_prediction_match_ans must contain `match_grp` column&quot;</span>)}</span>
<span id="cb207-32"><a href="point-cloud-classification.html#cb207-32" tabindex="-1"></a>  </span>
<span id="cb207-33"><a href="point-cloud-classification.html#cb207-33" tabindex="-1"></a>  <span class="co"># check for difference columns (contains &quot;_diff&quot;) and calc rmse for only those to return a single line df with colums for each diff_rmse</span></span>
<span id="cb207-34"><a href="point-cloud-classification.html#cb207-34" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb207-35"><a href="point-cloud-classification.html#cb207-35" tabindex="-1"></a>      (ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb207-36"><a href="point-cloud-classification.html#cb207-36" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;_diff&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb207-37"><a href="point-cloud-classification.html#cb207-37" tabindex="-1"></a>        <span class="fu">ncol</span>() )<span class="sc">&gt;</span><span class="dv">0</span></span>
<span id="cb207-38"><a href="point-cloud-classification.html#cb207-38" tabindex="-1"></a>    ){</span>
<span id="cb207-39"><a href="point-cloud-classification.html#cb207-39" tabindex="-1"></a>      <span class="co"># get rmse and mean difference/error for all columns with &quot;_diff&quot; but not &quot;pct_diff&quot;</span></span>
<span id="cb207-40"><a href="point-cloud-classification.html#cb207-40" tabindex="-1"></a>      <span class="co"># get mape for all columns with &quot;pct_diff&quot; but not &quot;diff_&quot;</span></span>
<span id="cb207-41"><a href="point-cloud-classification.html#cb207-41" tabindex="-1"></a>      rmse_df <span class="ot">&lt;-</span> ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb207-42"><a href="point-cloud-classification.html#cb207-42" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb207-43"><a href="point-cloud-classification.html#cb207-43" tabindex="-1"></a>          (tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;_diff&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_&quot;</span>))</span>
<span id="cb207-44"><a href="point-cloud-classification.html#cb207-44" tabindex="-1"></a>          <span class="sc">|</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_diff&quot;</span>)</span>
<span id="cb207-45"><a href="point-cloud-classification.html#cb207-45" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb207-46"><a href="point-cloud-classification.html#cb207-46" tabindex="-1"></a>        tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="at">values_drop_na =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb207-47"><a href="point-cloud-classification.html#cb207-47" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb207-48"><a href="point-cloud-classification.html#cb207-48" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb207-49"><a href="point-cloud-classification.html#cb207-49" tabindex="-1"></a>          <span class="at">sq =</span> <span class="fu">sum</span>(value<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb207-50"><a href="point-cloud-classification.html#cb207-50" tabindex="-1"></a>          , <span class="at">mean =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> T)</span>
<span id="cb207-51"><a href="point-cloud-classification.html#cb207-51" tabindex="-1"></a>          , <span class="at">sumabs =</span> <span class="fu">sum</span>(<span class="fu">abs</span>(value), <span class="at">na.rm =</span> T)</span>
<span id="cb207-52"><a href="point-cloud-classification.html#cb207-52" tabindex="-1"></a>          , <span class="at">nomiss =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(value))</span>
<span id="cb207-53"><a href="point-cloud-classification.html#cb207-53" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-54"><a href="point-cloud-classification.html#cb207-54" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb207-55"><a href="point-cloud-classification.html#cb207-55" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb207-56"><a href="point-cloud-classification.html#cb207-56" tabindex="-1"></a>          <span class="at">rmse =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-57"><a href="point-cloud-classification.html#cb207-57" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">coalesce</span>(nomiss,<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-58"><a href="point-cloud-classification.html#cb207-58" tabindex="-1"></a>            , T <span class="sc">~</span> <span class="fu">sqrt</span>(sq<span class="sc">/</span>nomiss)</span>
<span id="cb207-59"><a href="point-cloud-classification.html#cb207-59" tabindex="-1"></a>          )</span>
<span id="cb207-60"><a href="point-cloud-classification.html#cb207-60" tabindex="-1"></a>          , <span class="at">mape =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-61"><a href="point-cloud-classification.html#cb207-61" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">coalesce</span>(nomiss,<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-62"><a href="point-cloud-classification.html#cb207-62" tabindex="-1"></a>            , T <span class="sc">~</span> sumabs<span class="sc">/</span>nomiss</span>
<span id="cb207-63"><a href="point-cloud-classification.html#cb207-63" tabindex="-1"></a>          )</span>
<span id="cb207-64"><a href="point-cloud-classification.html#cb207-64" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-65"><a href="point-cloud-classification.html#cb207-65" tabindex="-1"></a>        <span class="co"># NA nonsense values</span></span>
<span id="cb207-66"><a href="point-cloud-classification.html#cb207-66" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb207-67"><a href="point-cloud-classification.html#cb207-67" tabindex="-1"></a>          <span class="at">mape =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-68"><a href="point-cloud-classification.html#cb207-68" tabindex="-1"></a>            stringr<span class="sc">::</span><span class="fu">str_starts</span>(name, <span class="st">&quot;pct_diff&quot;</span>) <span class="sc">~</span> mape</span>
<span id="cb207-69"><a href="point-cloud-classification.html#cb207-69" tabindex="-1"></a>            , T <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-70"><a href="point-cloud-classification.html#cb207-70" tabindex="-1"></a>          )</span>
<span id="cb207-71"><a href="point-cloud-classification.html#cb207-71" tabindex="-1"></a>          , <span class="at">rmse =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-72"><a href="point-cloud-classification.html#cb207-72" tabindex="-1"></a>            stringr<span class="sc">::</span><span class="fu">str_starts</span>(name, <span class="st">&quot;pct_diff&quot;</span>) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-73"><a href="point-cloud-classification.html#cb207-73" tabindex="-1"></a>            , T <span class="sc">~</span> rmse</span>
<span id="cb207-74"><a href="point-cloud-classification.html#cb207-74" tabindex="-1"></a>          )</span>
<span id="cb207-75"><a href="point-cloud-classification.html#cb207-75" tabindex="-1"></a>          , <span class="at">mean =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb207-76"><a href="point-cloud-classification.html#cb207-76" tabindex="-1"></a>            stringr<span class="sc">::</span><span class="fu">str_starts</span>(name, <span class="st">&quot;pct_diff&quot;</span>) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb207-77"><a href="point-cloud-classification.html#cb207-77" tabindex="-1"></a>            , T <span class="sc">~</span> mean</span>
<span id="cb207-78"><a href="point-cloud-classification.html#cb207-78" tabindex="-1"></a>          )</span>
<span id="cb207-79"><a href="point-cloud-classification.html#cb207-79" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-80"><a href="point-cloud-classification.html#cb207-80" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(name,rmse,mean,mape) <span class="sc">%&gt;%</span> </span>
<span id="cb207-81"><a href="point-cloud-classification.html#cb207-81" tabindex="-1"></a>        tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb207-82"><a href="point-cloud-classification.html#cb207-82" tabindex="-1"></a>          <span class="at">names_from =</span> name</span>
<span id="cb207-83"><a href="point-cloud-classification.html#cb207-83" tabindex="-1"></a>          , <span class="at">values_from =</span> <span class="fu">c</span>(rmse,mean,mape)</span>
<span id="cb207-84"><a href="point-cloud-classification.html#cb207-84" tabindex="-1"></a>          , <span class="at">names_glue =</span> <span class="st">&quot;{name}_{.value}&quot;</span></span>
<span id="cb207-85"><a href="point-cloud-classification.html#cb207-85" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-86"><a href="point-cloud-classification.html#cb207-86" tabindex="-1"></a>        <span class="co"># remove columns with NA in all rows</span></span>
<span id="cb207-87"><a href="point-cloud-classification.html#cb207-87" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>( dplyr<span class="sc">::</span><span class="fu">where</span>( <span class="sc">~!</span><span class="fu">all</span>(<span class="fu">is.na</span>(.x)) ) )</span>
<span id="cb207-88"><a href="point-cloud-classification.html#cb207-88" tabindex="-1"></a>      </span>
<span id="cb207-89"><a href="point-cloud-classification.html#cb207-89" tabindex="-1"></a>      <span class="cf">if</span>(</span>
<span id="cb207-90"><a href="point-cloud-classification.html#cb207-90" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">nrow</span>(rmse_df),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span></span>
<span id="cb207-91"><a href="point-cloud-classification.html#cb207-91" tabindex="-1"></a>        <span class="sc">||</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">ncol</span>(rmse_df),<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span></span>
<span id="cb207-92"><a href="point-cloud-classification.html#cb207-92" tabindex="-1"></a>      ){</span>
<span id="cb207-93"><a href="point-cloud-classification.html#cb207-93" tabindex="-1"></a>        <span class="co"># empty df</span></span>
<span id="cb207-94"><a href="point-cloud-classification.html#cb207-94" tabindex="-1"></a>        rmse_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>()</span>
<span id="cb207-95"><a href="point-cloud-classification.html#cb207-95" tabindex="-1"></a>      }</span>
<span id="cb207-96"><a href="point-cloud-classification.html#cb207-96" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb207-97"><a href="point-cloud-classification.html#cb207-97" tabindex="-1"></a>      <span class="co"># empty df</span></span>
<span id="cb207-98"><a href="point-cloud-classification.html#cb207-98" tabindex="-1"></a>      rmse_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>()</span>
<span id="cb207-99"><a href="point-cloud-classification.html#cb207-99" tabindex="-1"></a>    }</span>
<span id="cb207-100"><a href="point-cloud-classification.html#cb207-100" tabindex="-1"></a>  </span>
<span id="cb207-101"><a href="point-cloud-classification.html#cb207-101" tabindex="-1"></a>  <span class="co"># count by match group</span></span>
<span id="cb207-102"><a href="point-cloud-classification.html#cb207-102" tabindex="-1"></a>    agg <span class="ot">&lt;-</span></span>
<span id="cb207-103"><a href="point-cloud-classification.html#cb207-103" tabindex="-1"></a>      ground_truth_prediction_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb207-104"><a href="point-cloud-classification.html#cb207-104" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb207-105"><a href="point-cloud-classification.html#cb207-105" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb207-106"><a href="point-cloud-classification.html#cb207-106" tabindex="-1"></a>        <span class="at">match_grp =</span> dplyr<span class="sc">::</span><span class="fu">case_match</span>(</span>
<span id="cb207-107"><a href="point-cloud-classification.html#cb207-107" tabindex="-1"></a>          match_grp</span>
<span id="cb207-108"><a href="point-cloud-classification.html#cb207-108" tabindex="-1"></a>          , <span class="st">&quot;true positive&quot;</span><span class="sc">~</span><span class="st">&quot;tp&quot;</span></span>
<span id="cb207-109"><a href="point-cloud-classification.html#cb207-109" tabindex="-1"></a>          , <span class="st">&quot;commission&quot;</span><span class="sc">~</span><span class="st">&quot;fp&quot;</span></span>
<span id="cb207-110"><a href="point-cloud-classification.html#cb207-110" tabindex="-1"></a>          , <span class="st">&quot;omission&quot;</span><span class="sc">~</span><span class="st">&quot;fn&quot;</span></span>
<span id="cb207-111"><a href="point-cloud-classification.html#cb207-111" tabindex="-1"></a>        )</span>
<span id="cb207-112"><a href="point-cloud-classification.html#cb207-112" tabindex="-1"></a>      )</span>
<span id="cb207-113"><a href="point-cloud-classification.html#cb207-113" tabindex="-1"></a>    <span class="co"># true positive, false positive, false negative rates</span></span>
<span id="cb207-114"><a href="point-cloud-classification.html#cb207-114" tabindex="-1"></a>    return_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">match_grp =</span> <span class="fu">c</span>(<span class="st">&quot;tp&quot;</span>,<span class="st">&quot;fp&quot;</span>,<span class="st">&quot;fn&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb207-115"><a href="point-cloud-classification.html#cb207-115" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(agg, <span class="at">by =</span> <span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb207-116"><a href="point-cloud-classification.html#cb207-116" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(n), <span class="at">.fn =</span> <span class="sc">~</span>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(.x,<span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb207-117"><a href="point-cloud-classification.html#cb207-117" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb207-118"><a href="point-cloud-classification.html#cb207-118" tabindex="-1"></a>        <span class="at">names_from =</span> match_grp</span>
<span id="cb207-119"><a href="point-cloud-classification.html#cb207-119" tabindex="-1"></a>        , <span class="at">values_from =</span> <span class="fu">c</span>(n)</span>
<span id="cb207-120"><a href="point-cloud-classification.html#cb207-120" tabindex="-1"></a>        , <span class="at">names_glue =</span> <span class="st">&quot;{match_grp}_{.value}&quot;</span></span>
<span id="cb207-121"><a href="point-cloud-classification.html#cb207-121" tabindex="-1"></a>      )</span>
<span id="cb207-122"><a href="point-cloud-classification.html#cb207-122" tabindex="-1"></a>    <span class="co"># rates, precision, recall, f-score</span></span>
<span id="cb207-123"><a href="point-cloud-classification.html#cb207-123" tabindex="-1"></a>    return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb207-124"><a href="point-cloud-classification.html#cb207-124" tabindex="-1"></a>      <span class="fu">confusion_matrix_scores_fn</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb207-125"><a href="point-cloud-classification.html#cb207-125" tabindex="-1"></a>      <span class="co"># add rmse</span></span>
<span id="cb207-126"><a href="point-cloud-classification.html#cb207-126" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(rmse_df)</span>
<span id="cb207-127"><a href="point-cloud-classification.html#cb207-127" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb207-128"><a href="point-cloud-classification.html#cb207-128" tabindex="-1"></a>  <span class="fu">return</span>(return_df)</span>
<span id="cb207-129"><a href="point-cloud-classification.html#cb207-129" tabindex="-1"></a>}</span></code></pre></div>
<p>now let’s apply it at the parameter combination level</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="point-cloud-classification.html#cb208-1" tabindex="-1"></a>param_combos_gt_agg <span class="ot">&lt;-</span> <span class="fu">unique</span>(param_combos_gt<span class="sc">$</span>rn) <span class="sc">%&gt;%</span> </span>
<span id="cb208-2"><a href="point-cloud-classification.html#cb208-2" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb208-3"><a href="point-cloud-classification.html#cb208-3" tabindex="-1"></a>    <span class="fu">agg_ground_truth_match</span>(</span>
<span id="cb208-4"><a href="point-cloud-classification.html#cb208-4" tabindex="-1"></a>      param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb208-5"><a href="point-cloud-classification.html#cb208-5" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb208-6"><a href="point-cloud-classification.html#cb208-6" tabindex="-1"></a>          is_in_stand</span>
<span id="cb208-7"><a href="point-cloud-classification.html#cb208-7" tabindex="-1"></a>          <span class="sc">&amp;</span> rn <span class="sc">==</span> x</span>
<span id="cb208-8"><a href="point-cloud-classification.html#cb208-8" tabindex="-1"></a>        )</span>
<span id="cb208-9"><a href="point-cloud-classification.html#cb208-9" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb208-10"><a href="point-cloud-classification.html#cb208-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rn =</span> x)</span>
<span id="cb208-11"><a href="point-cloud-classification.html#cb208-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb208-12"><a href="point-cloud-classification.html#cb208-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb208-13"><a href="point-cloud-classification.html#cb208-13" tabindex="-1"></a>  <span class="co"># add in info on all parameter combinations</span></span>
<span id="cb208-14"><a href="point-cloud-classification.html#cb208-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb208-15"><a href="point-cloud-classification.html#cb208-15" tabindex="-1"></a>    param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb208-16"><a href="point-cloud-classification.html#cb208-16" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb208-17"><a href="point-cloud-classification.html#cb208-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(</span>
<span id="cb208-18"><a href="point-cloud-classification.html#cb208-18" tabindex="-1"></a>      rn,max_ht_m,min_area_m2,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb208-19"><a href="point-cloud-classification.html#cb208-19" tabindex="-1"></a>    )</span>
<span id="cb208-20"><a href="point-cloud-classification.html#cb208-20" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;rn&quot;</span></span>
<span id="cb208-21"><a href="point-cloud-classification.html#cb208-21" tabindex="-1"></a>    , <span class="at">relationship =</span> <span class="st">&quot;one-to-one&quot;</span></span>
<span id="cb208-22"><a href="point-cloud-classification.html#cb208-22" tabindex="-1"></a>  )</span>
<span id="cb208-23"><a href="point-cloud-classification.html#cb208-23" tabindex="-1"></a></span>
<span id="cb208-24"><a href="point-cloud-classification.html#cb208-24" tabindex="-1"></a><span class="co"># we can also add the relative rmse (rrmse) by comparing the rmse to the mean value of the ground truth data</span></span>
<span id="cb208-25"><a href="point-cloud-classification.html#cb208-25" tabindex="-1"></a>param_combos_gt_agg <span class="ot">&lt;-</span> param_combos_gt_agg <span class="sc">%&gt;%</span></span>
<span id="cb208-26"><a href="point-cloud-classification.html#cb208-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb208-27"><a href="point-cloud-classification.html#cb208-27" tabindex="-1"></a>    <span class="co"># add means of gt</span></span>
<span id="cb208-28"><a href="point-cloud-classification.html#cb208-28" tabindex="-1"></a>    slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb208-29"><a href="point-cloud-classification.html#cb208-29" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb208-30"><a href="point-cloud-classification.html#cb208-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(image_gt_area_m2,field_gt_area_m2,image_gt_volume_m3,field_gt_volume_m3,height_m) <span class="sc">%&gt;%</span> </span>
<span id="cb208-31"><a href="point-cloud-classification.html#cb208-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb208-32"><a href="point-cloud-classification.html#cb208-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(.x,<span class="at">na.rm=</span>T))) <span class="sc">%&gt;%</span> </span>
<span id="cb208-33"><a href="point-cloud-classification.html#cb208-33" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">&quot;gt_&quot;</span>, .x, <span class="at">recycle0 =</span> <span class="cn">TRUE</span>))</span>
<span id="cb208-34"><a href="point-cloud-classification.html#cb208-34" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb208-35"><a href="point-cloud-classification.html#cb208-35" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb208-36"><a href="point-cloud-classification.html#cb208-36" tabindex="-1"></a>    <span class="at">area_diff_field_rrmse =</span> area_diff_field_rmse<span class="sc">/</span>gt_field_gt_area_m2</span>
<span id="cb208-37"><a href="point-cloud-classification.html#cb208-37" tabindex="-1"></a>    , <span class="at">area_diff_image_rrmse =</span> area_diff_image_rmse<span class="sc">/</span>gt_image_gt_area_m2</span>
<span id="cb208-38"><a href="point-cloud-classification.html#cb208-38" tabindex="-1"></a>    , <span class="at">volume_diff_field_rrmse =</span> volume_diff_field_rmse<span class="sc">/</span>gt_field_gt_volume_m3</span>
<span id="cb208-39"><a href="point-cloud-classification.html#cb208-39" tabindex="-1"></a>    , <span class="at">volume_diff_image_rrmse =</span> volume_diff_image_rmse<span class="sc">/</span>gt_image_gt_volume_m3</span>
<span id="cb208-40"><a href="point-cloud-classification.html#cb208-40" tabindex="-1"></a>    , <span class="at">cone_volume_diff_field_rrmse =</span> cone_volume_diff_field_rmse<span class="sc">/</span>gt_field_gt_volume_m3</span>
<span id="cb208-41"><a href="point-cloud-classification.html#cb208-41" tabindex="-1"></a>    , <span class="at">cone_volume_diff_image_rrmse =</span> cone_volume_diff_image_rmse<span class="sc">/</span>gt_image_gt_volume_m3</span>
<span id="cb208-42"><a href="point-cloud-classification.html#cb208-42" tabindex="-1"></a>    , <span class="at">height_diff_rrmse =</span> height_diff_rmse<span class="sc">/</span>gt_height_m</span>
<span id="cb208-43"><a href="point-cloud-classification.html#cb208-43" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb208-44"><a href="point-cloud-classification.html#cb208-44" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;gt_&quot;</span>))</span>
<span id="cb208-45"><a href="point-cloud-classification.html#cb208-45" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb208-46"><a href="point-cloud-classification.html#cb208-46" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,260
## Columns: 40
## $ tp_n                         &lt;dbl&gt; 107, 106, 96, 88, 65, 11, 108, 107, 100, …
## $ fp_n                         &lt;dbl&gt; 160, 134, 107, 61, 27, 7, 171, 139, 103, …
## $ fn_n                         &lt;dbl&gt; 12, 13, 23, 31, 54, 110, 11, 12, 19, 27, …
## $ omission_rate                &lt;dbl&gt; 0.10084034, 0.10924370, 0.19327731, 0.260…
## $ commission_rate              &lt;dbl&gt; 0.5992509, 0.5583333, 0.5270936, 0.409396…
## $ precision                    &lt;dbl&gt; 0.4007491, 0.4416667, 0.4729064, 0.590604…
## $ recall                       &lt;dbl&gt; 0.89915966, 0.89075630, 0.80672269, 0.739…
## $ f_score                      &lt;dbl&gt; 0.5544041, 0.5905292, 0.5962733, 0.656716…
## $ area_diff_field_rmse         &lt;dbl&gt; 3.868051, 3.885180, 3.807512, 3.890205, 4…
## $ area_diff_image_rmse         &lt;dbl&gt; 10.46601, 10.50315, 10.91475, 11.25964, 1…
## $ cone_volume_diff_field_rmse  &lt;dbl&gt; 7.490940, 7.526448, 7.790422, 8.120722, 9…
## $ cone_volume_diff_image_rmse  &lt;dbl&gt; 15.78185, 15.85451, 16.58836, 17.31307, 1…
## $ height_diff_rmse             &lt;dbl&gt; 0.5886118, 0.5907639, 0.5865752, 0.596960…
## $ volume_diff_field_rmse       &lt;dbl&gt; 6.266046, 6.296208, 6.356979, 6.635252, 7…
## $ volume_diff_image_rmse       &lt;dbl&gt; 13.49247, 13.55815, 14.16271, 14.79545, 1…
## $ area_diff_field_mean         &lt;dbl&gt; -1.5767572, -1.5800470, -1.8332476, -1.78…
## $ area_diff_image_mean         &lt;dbl&gt; -6.887313, -6.903269, -7.212212, -7.34892…
## $ cone_volume_diff_field_mean  &lt;dbl&gt; -1.855219, -1.858713, -2.225155, -2.25765…
## $ cone_volume_diff_image_mean  &lt;dbl&gt; -6.415861, -6.438672, -6.977413, -7.26086…
## $ height_diff_mean             &lt;dbl&gt; -0.024606325, -0.021877675, -0.067167884,…
## $ volume_diff_field_mean       &lt;dbl&gt; 0.597212113, 0.593251731, 0.283383782, 0.…
## $ volume_diff_image_mean       &lt;dbl&gt; -3.963430, -3.986707, -4.468874, -4.64514…
## $ pct_diff_area_field_mape     &lt;dbl&gt; 0.2355877, 0.2363886, 0.2284273, 0.219623…
## $ pct_diff_area_image_mape     &lt;dbl&gt; 0.4368490, 0.4368840, 0.4379644, 0.429786…
## $ pct_diff_height_mape         &lt;dbl&gt; 0.1891672, 0.1895399, 0.1818905, 0.179652…
## $ pct_diff_volume_field_mape   &lt;dbl&gt; 0.4384068, 0.4408890, 0.4029316, 0.420493…
## $ pct_diff_volume_image_mape   &lt;dbl&gt; 0.3388673, 0.3402073, 0.3430604, 0.338788…
## $ rn                           &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13…
## $ max_ht_m                     &lt;dbl&gt; 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,…
## $ min_area_m2                  &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,…
## $ max_area_m2                  &lt;dbl&gt; 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 4…
## $ convexity_pct                &lt;dbl&gt; 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.3, 0.3, 0…
## $ circle_fit_iou_pct           &lt;dbl&gt; 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.3, 0.4, 0…
## $ area_diff_field_rrmse        &lt;dbl&gt; 0.3646426, 0.3662574, 0.3589356, 0.366731…
## $ area_diff_image_rrmse        &lt;dbl&gt; 0.5484007, 0.5503465, 0.5719135, 0.589985…
## $ volume_diff_field_rrmse      &lt;dbl&gt; 0.6149686, 0.6179288, 0.6238930, 0.651203…
## $ volume_diff_image_rrmse      &lt;dbl&gt; 0.8009531, 0.8048521, 0.8407405, 0.878301…
## $ cone_volume_diff_field_rrmse &lt;dbl&gt; 0.7351834, 0.7386683, 0.7645755, 0.796992…
## $ cone_volume_diff_image_rrmse &lt;dbl&gt; 0.9368571, 0.9411703, 0.9847339, 1.027754…
## $ height_diff_rrmse            &lt;dbl&gt; 0.2697319, 0.2707181, 0.2687987, 0.273557…</code></pre>
</div>
<div id="sensitivity-results" class="section level5 hasAnchor" number="4.2.2.2.2">
<h5><span class="header-section-number">4.2.2.2.2</span> Sensitivity Results<a href="point-cloud-classification.html#sensitivity-results" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>let’s get a quick summary of the evaluation metrics across all parameter combinations</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="point-cloud-classification.html#cb210-1" tabindex="-1"></a><span class="co"># pal</span></span>
<span id="cb210-2"><a href="point-cloud-classification.html#cb210-2" tabindex="-1"></a>pal_eval_metric <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb210-3"><a href="point-cloud-classification.html#cb210-3" tabindex="-1"></a>  RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Oranges&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb210-4"><a href="point-cloud-classification.html#cb210-4" tabindex="-1"></a>  , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Greys&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb210-5"><a href="point-cloud-classification.html#cb210-5" tabindex="-1"></a>  , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Purples&quot;</span>)[<span class="dv">3</span>]</span>
<span id="cb210-6"><a href="point-cloud-classification.html#cb210-6" tabindex="-1"></a>)</span>
<span id="cb210-7"><a href="point-cloud-classification.html#cb210-7" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb210-8"><a href="point-cloud-classification.html#cb210-8" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb210-9"><a href="point-cloud-classification.html#cb210-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(f_score,recall,precision,tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb210-10"><a href="point-cloud-classification.html#cb210-10" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##     f_score           recall          precision      pct_diff_area_field_mape
##  Min.   :0.1259   Min.   :0.07438   Min.   :0.2437   Min.   :0.1112          
##  1st Qu.:0.4448   1st Qu.:0.56198   1st Qu.:0.3691   1st Qu.:0.2143          
##  Median :0.5368   Median :0.80165   Median :0.4688   Median :0.2267          
##  Mean   :0.4955   Mean   :0.68651   Mean   :0.4798   Mean   :0.2208          
##  3rd Qu.:0.5963   3rd Qu.:0.89256   3rd Qu.:0.5876   3rd Qu.:0.2341          
##  Max.   :0.7174   Max.   :0.95868   Max.   :0.8750   Max.   :0.2656          
##  pct_diff_area_image_mape pct_diff_height_mape pct_diff_volume_field_mape
##  Min.   :0.3195           Min.   :0.1352       Min.   :0.2820            
##  1st Qu.:0.4250           1st Qu.:0.1901       1st Qu.:0.4370            
##  Median :0.4327           Median :0.1975       Median :0.4533            
##  Mean   :0.4263           Mean   :0.1956       Mean   :0.4560            
##  3rd Qu.:0.4370           3rd Qu.:0.2031       3rd Qu.:0.4697            
##  Max.   :0.4683           Max.   :0.2567       Max.   :0.6678            
##  pct_diff_volume_image_mape
##  Min.   :0.2063            
##  1st Qu.:0.3303            
##  Median :0.3428            
##  Mean   :0.3361            
##  3rd Qu.:0.3499            
##  Max.   :0.3848</code></pre>
<p>let’s check out the distribution of the instance segmentation (i.e. pile detection) results</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="point-cloud-classification.html#cb212-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb212-2"><a href="point-cloud-classification.html#cb212-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb212-3"><a href="point-cloud-classification.html#cb212-3" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)</span>
<span id="cb212-4"><a href="point-cloud-classification.html#cb212-4" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb212-5"><a href="point-cloud-classification.html#cb212-5" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb212-6"><a href="point-cloud-classification.html#cb212-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-7"><a href="point-cloud-classification.html#cb212-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb212-8"><a href="point-cloud-classification.html#cb212-8" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb212-9"><a href="point-cloud-classification.html#cb212-9" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb212-10"><a href="point-cloud-classification.html#cb212-10" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb212-11"><a href="point-cloud-classification.html#cb212-11" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb212-12"><a href="point-cloud-classification.html#cb212-12" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb212-13"><a href="point-cloud-classification.html#cb212-13" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb212-14"><a href="point-cloud-classification.html#cb212-14" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb212-15"><a href="point-cloud-classification.html#cb212-15" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb212-16"><a href="point-cloud-classification.html#cb212-16" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb212-17"><a href="point-cloud-classification.html#cb212-17" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb212-18"><a href="point-cloud-classification.html#cb212-18" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb212-19"><a href="point-cloud-classification.html#cb212-19" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb212-20"><a href="point-cloud-classification.html#cb212-20" tabindex="-1"></a>        )</span>
<span id="cb212-21"><a href="point-cloud-classification.html#cb212-21" tabindex="-1"></a>      )</span>
<span id="cb212-22"><a href="point-cloud-classification.html#cb212-22" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb212-23"><a href="point-cloud-classification.html#cb212-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb212-24"><a href="point-cloud-classification.html#cb212-24" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric)</span>
<span id="cb212-25"><a href="point-cloud-classification.html#cb212-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb212-26"><a href="point-cloud-classification.html#cb212-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb212-27"><a href="point-cloud-classification.html#cb212-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb212-28"><a href="point-cloud-classification.html#cb212-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb212-29"><a href="point-cloud-classification.html#cb212-29" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb212-30"><a href="point-cloud-classification.html#cb212-30" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb212-31"><a href="point-cloud-classification.html#cb212-31" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb212-32"><a href="point-cloud-classification.html#cb212-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric)) <span class="sc">+</span></span>
<span id="cb212-33"><a href="point-cloud-classification.html#cb212-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb212-34"><a href="point-cloud-classification.html#cb212-34" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb212-35"><a href="point-cloud-classification.html#cb212-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb212-36"><a href="point-cloud-classification.html#cb212-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb212-37"><a href="point-cloud-classification.html#cb212-37" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb212-38"><a href="point-cloud-classification.html#cb212-38" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb212-39"><a href="point-cloud-classification.html#cb212-39" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb212-40"><a href="point-cloud-classification.html#cb212-40" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb212-41"><a href="point-cloud-classification.html#cb212-41" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb212-42"><a href="point-cloud-classification.html#cb212-42" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-181-1.png" width="1008" /></p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="point-cloud-classification.html#cb213-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_dist.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>let’s check out the distribution of the ability of the method to properly extract the form of the piles by looking at the <strong>RMSE</strong> values</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="point-cloud-classification.html#cb214-1" tabindex="-1"></a><span class="co"># this function gets pairs of colors that are spectrally different and cb friendly</span></span>
<span id="cb214-2"><a href="point-cloud-classification.html#cb214-2" tabindex="-1"></a>pal_get_pairs_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb214-3"><a href="point-cloud-classification.html#cb214-3" tabindex="-1"></a>  <span class="cf">if</span>(n<span class="sc">%%</span><span class="dv">2</span><span class="sc">==</span><span class="dv">1</span>){n<span class="ot">=</span>n<span class="sc">+</span><span class="dv">1</span>}</span>
<span id="cb214-4"><a href="point-cloud-classification.html#cb214-4" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">turbo</span>(<span class="at">n =</span> n<span class="sc">*</span><span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb214-5"><a href="point-cloud-classification.html#cb214-5" tabindex="-1"></a>  .[<span class="dv">2</span><span class="sc">:</span>((n<span class="sc">*</span><span class="dv">4</span>)<span class="sc">-</span><span class="dv">1</span>)] <span class="sc">%&gt;%</span> <span class="co"># removes extremes</span></span>
<span id="cb214-6"><a href="point-cloud-classification.html#cb214-6" tabindex="-1"></a>  .[<span class="fu">c</span>(T,T,F,F)] <span class="sc">%&gt;%</span> <span class="co"># keeps 2 of every 4</span></span>
<span id="cb214-7"><a href="point-cloud-classification.html#cb214-7" tabindex="-1"></a>  .[<span class="fu">c</span>(F,F,T,T)] <span class="co"># keeps 2 of every 4</span></span>
<span id="cb214-8"><a href="point-cloud-classification.html#cb214-8" tabindex="-1"></a>  <span class="co"># .[1:n]</span></span>
<span id="cb214-9"><a href="point-cloud-classification.html#cb214-9" tabindex="-1"></a>}</span>
<span id="cb214-10"><a href="point-cloud-classification.html#cb214-10" tabindex="-1"></a><span class="co"># pal_get_pairs_fn(6) %&gt;% scales::show_col()</span></span>
<span id="cb214-11"><a href="point-cloud-classification.html#cb214-11" tabindex="-1"></a></span>
<span id="cb214-12"><a href="point-cloud-classification.html#cb214-12" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb214-13"><a href="point-cloud-classification.html#cb214-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cone_volume_diff&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb214-14"><a href="point-cloud-classification.html#cb214-14" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb214-15"><a href="point-cloud-classification.html#cb214-15" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rmse&quot;</span>))</span>
<span id="cb214-16"><a href="point-cloud-classification.html#cb214-16" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb214-17"><a href="point-cloud-classification.html#cb214-17" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb214-18"><a href="point-cloud-classification.html#cb214-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb214-19"><a href="point-cloud-classification.html#cb214-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb214-20"><a href="point-cloud-classification.html#cb214-20" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb214-21"><a href="point-cloud-classification.html#cb214-21" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb214-22"><a href="point-cloud-classification.html#cb214-22" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb214-23"><a href="point-cloud-classification.html#cb214-23" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb214-24"><a href="point-cloud-classification.html#cb214-24" tabindex="-1"></a>        <span class="co"># rmse</span></span>
<span id="cb214-25"><a href="point-cloud-classification.html#cb214-25" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;area_diff_field_rmse&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb214-26"><a href="point-cloud-classification.html#cb214-26" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;area_diff_image_rmse&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb214-27"><a href="point-cloud-classification.html#cb214-27" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;volume_diff_field_rmse&quot;</span> <span class="sc">~</span> <span class="dv">6</span></span>
<span id="cb214-28"><a href="point-cloud-classification.html#cb214-28" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;volume_diff_image_rmse&quot;</span> <span class="sc">~</span> <span class="dv">7</span></span>
<span id="cb214-29"><a href="point-cloud-classification.html#cb214-29" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;height_diff_rmse&quot;</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb214-30"><a href="point-cloud-classification.html#cb214-30" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb214-31"><a href="point-cloud-classification.html#cb214-31" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb214-32"><a href="point-cloud-classification.html#cb214-32" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb214-33"><a href="point-cloud-classification.html#cb214-33" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb214-34"><a href="point-cloud-classification.html#cb214-34" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb214-35"><a href="point-cloud-classification.html#cb214-35" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb214-36"><a href="point-cloud-classification.html#cb214-36" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb214-37"><a href="point-cloud-classification.html#cb214-37" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb214-38"><a href="point-cloud-classification.html#cb214-38" tabindex="-1"></a>          , <span class="st">&quot;RMSE: Area vs field (m2)&quot;</span></span>
<span id="cb214-39"><a href="point-cloud-classification.html#cb214-39" tabindex="-1"></a>          , <span class="st">&quot;RMSE: Area vs image (m2)&quot;</span></span>
<span id="cb214-40"><a href="point-cloud-classification.html#cb214-40" tabindex="-1"></a>          , <span class="st">&quot;RMSE: Volume vs field (m3)&quot;</span></span>
<span id="cb214-41"><a href="point-cloud-classification.html#cb214-41" tabindex="-1"></a>          , <span class="st">&quot;RMSE: Volume vs image (m3)&quot;</span></span>
<span id="cb214-42"><a href="point-cloud-classification.html#cb214-42" tabindex="-1"></a>          , <span class="st">&quot;RMSE: Height (m)&quot;</span></span>
<span id="cb214-43"><a href="point-cloud-classification.html#cb214-43" tabindex="-1"></a>        )</span>
<span id="cb214-44"><a href="point-cloud-classification.html#cb214-44" tabindex="-1"></a>      )</span>
<span id="cb214-45"><a href="point-cloud-classification.html#cb214-45" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb214-46"><a href="point-cloud-classification.html#cb214-46" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb214-47"><a href="point-cloud-classification.html#cb214-47" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric)</span>
<span id="cb214-48"><a href="point-cloud-classification.html#cb214-48" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb214-49"><a href="point-cloud-classification.html#cb214-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb214-50"><a href="point-cloud-classification.html#cb214-50" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(</span>
<span id="cb214-51"><a href="point-cloud-classification.html#cb214-51" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">pal_get_pairs_fn</span>(<span class="dv">6</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb214-52"><a href="point-cloud-classification.html#cb214-52" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb214-53"><a href="point-cloud-classification.html#cb214-53" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb214-54"><a href="point-cloud-classification.html#cb214-54" tabindex="-1"></a>    <span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric)</span>
<span id="cb214-55"><a href="point-cloud-classification.html#cb214-55" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb214-56"><a href="point-cloud-classification.html#cb214-56" tabindex="-1"></a>    , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb214-57"><a href="point-cloud-classification.html#cb214-57" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb214-58"><a href="point-cloud-classification.html#cb214-58" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb214-59"><a href="point-cloud-classification.html#cb214-59" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb214-60"><a href="point-cloud-classification.html#cb214-60" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb214-61"><a href="point-cloud-classification.html#cb214-61" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb214-62"><a href="point-cloud-classification.html#cb214-62" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb214-63"><a href="point-cloud-classification.html#cb214-63" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb214-64"><a href="point-cloud-classification.html#cb214-64" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb214-65"><a href="point-cloud-classification.html#cb214-65" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb214-66"><a href="point-cloud-classification.html#cb214-66" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb214-67"><a href="point-cloud-classification.html#cb214-67" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-182-1.png" width="1008" /></p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="point-cloud-classification.html#cb215-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_dist_rmse.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>let’s check out the distribution of the ability of the method to properly extract the form of the piles by looking at the <strong>MAPE</strong> values</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="point-cloud-classification.html#cb216-1" tabindex="-1"></a><span class="co"># pal_get_pairs_fn(6) %&gt;% scales::show_col()</span></span>
<span id="cb216-2"><a href="point-cloud-classification.html#cb216-2" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb216-3"><a href="point-cloud-classification.html#cb216-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cone_volume_diff&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb216-4"><a href="point-cloud-classification.html#cb216-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb216-5"><a href="point-cloud-classification.html#cb216-5" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb216-6"><a href="point-cloud-classification.html#cb216-6" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb216-7"><a href="point-cloud-classification.html#cb216-7" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb216-8"><a href="point-cloud-classification.html#cb216-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb216-9"><a href="point-cloud-classification.html#cb216-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb216-10"><a href="point-cloud-classification.html#cb216-10" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb216-11"><a href="point-cloud-classification.html#cb216-11" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb216-12"><a href="point-cloud-classification.html#cb216-12" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb216-13"><a href="point-cloud-classification.html#cb216-13" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb216-14"><a href="point-cloud-classification.html#cb216-14" tabindex="-1"></a>        <span class="co"># rmse</span></span>
<span id="cb216-15"><a href="point-cloud-classification.html#cb216-15" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_area_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb216-16"><a href="point-cloud-classification.html#cb216-16" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_area_image_mape&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb216-17"><a href="point-cloud-classification.html#cb216-17" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_volume_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">6</span></span>
<span id="cb216-18"><a href="point-cloud-classification.html#cb216-18" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_volume_image_mape&quot;</span> <span class="sc">~</span> <span class="dv">7</span></span>
<span id="cb216-19"><a href="point-cloud-classification.html#cb216-19" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_height_mape&quot;</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb216-20"><a href="point-cloud-classification.html#cb216-20" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb216-21"><a href="point-cloud-classification.html#cb216-21" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb216-22"><a href="point-cloud-classification.html#cb216-22" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb216-23"><a href="point-cloud-classification.html#cb216-23" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb216-24"><a href="point-cloud-classification.html#cb216-24" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb216-25"><a href="point-cloud-classification.html#cb216-25" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb216-26"><a href="point-cloud-classification.html#cb216-26" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb216-27"><a href="point-cloud-classification.html#cb216-27" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb216-28"><a href="point-cloud-classification.html#cb216-28" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Area vs field (%)&quot;</span></span>
<span id="cb216-29"><a href="point-cloud-classification.html#cb216-29" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Area vs image (%)&quot;</span></span>
<span id="cb216-30"><a href="point-cloud-classification.html#cb216-30" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Volume vs field (%)&quot;</span></span>
<span id="cb216-31"><a href="point-cloud-classification.html#cb216-31" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Volume vs image (%)&quot;</span></span>
<span id="cb216-32"><a href="point-cloud-classification.html#cb216-32" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Height (%)&quot;</span></span>
<span id="cb216-33"><a href="point-cloud-classification.html#cb216-33" tabindex="-1"></a>        )</span>
<span id="cb216-34"><a href="point-cloud-classification.html#cb216-34" tabindex="-1"></a>      )</span>
<span id="cb216-35"><a href="point-cloud-classification.html#cb216-35" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb216-36"><a href="point-cloud-classification.html#cb216-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb216-37"><a href="point-cloud-classification.html#cb216-37" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric)</span>
<span id="cb216-38"><a href="point-cloud-classification.html#cb216-38" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb216-39"><a href="point-cloud-classification.html#cb216-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb216-40"><a href="point-cloud-classification.html#cb216-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(</span>
<span id="cb216-41"><a href="point-cloud-classification.html#cb216-41" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">pal_get_pairs_fn</span>(<span class="dv">6</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb216-42"><a href="point-cloud-classification.html#cb216-42" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb216-43"><a href="point-cloud-classification.html#cb216-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb216-44"><a href="point-cloud-classification.html#cb216-44" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb216-45"><a href="point-cloud-classification.html#cb216-45" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb216-46"><a href="point-cloud-classification.html#cb216-46" tabindex="-1"></a>    , <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">8</span>)</span>
<span id="cb216-47"><a href="point-cloud-classification.html#cb216-47" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb216-48"><a href="point-cloud-classification.html#cb216-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb216-49"><a href="point-cloud-classification.html#cb216-49" tabindex="-1"></a>    <span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric)</span>
<span id="cb216-50"><a href="point-cloud-classification.html#cb216-50" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb216-51"><a href="point-cloud-classification.html#cb216-51" tabindex="-1"></a>    , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb216-52"><a href="point-cloud-classification.html#cb216-52" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb216-53"><a href="point-cloud-classification.html#cb216-53" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb216-54"><a href="point-cloud-classification.html#cb216-54" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb216-55"><a href="point-cloud-classification.html#cb216-55" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb216-56"><a href="point-cloud-classification.html#cb216-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb216-57"><a href="point-cloud-classification.html#cb216-57" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb216-58"><a href="point-cloud-classification.html#cb216-58" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb216-59"><a href="point-cloud-classification.html#cb216-59" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb216-60"><a href="point-cloud-classification.html#cb216-60" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb216-61"><a href="point-cloud-classification.html#cb216-61" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb216-62"><a href="point-cloud-classification.html#cb216-62" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-183-1.png" width="1008" /></p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="point-cloud-classification.html#cb217-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_dist_mape.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>let’s check out the distribution of the ability of the method to properly extract the form of the piles by looking at the <strong>ME</strong> values</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="point-cloud-classification.html#cb218-1" tabindex="-1"></a><span class="co"># pal_get_pairs_fn(6) %&gt;% scales::show_col()</span></span>
<span id="cb218-2"><a href="point-cloud-classification.html#cb218-2" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb218-3"><a href="point-cloud-classification.html#cb218-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cone_volume_diff&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-4"><a href="point-cloud-classification.html#cb218-4" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb218-5"><a href="point-cloud-classification.html#cb218-5" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mean&quot;</span>))</span>
<span id="cb218-6"><a href="point-cloud-classification.html#cb218-6" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb218-7"><a href="point-cloud-classification.html#cb218-7" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb218-8"><a href="point-cloud-classification.html#cb218-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-9"><a href="point-cloud-classification.html#cb218-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb218-10"><a href="point-cloud-classification.html#cb218-10" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb218-11"><a href="point-cloud-classification.html#cb218-11" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb218-12"><a href="point-cloud-classification.html#cb218-12" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb218-13"><a href="point-cloud-classification.html#cb218-13" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb218-14"><a href="point-cloud-classification.html#cb218-14" tabindex="-1"></a>        <span class="co"># rmse</span></span>
<span id="cb218-15"><a href="point-cloud-classification.html#cb218-15" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;area_diff_field_mean&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb218-16"><a href="point-cloud-classification.html#cb218-16" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;area_diff_image_mean&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb218-17"><a href="point-cloud-classification.html#cb218-17" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;volume_diff_field_mean&quot;</span> <span class="sc">~</span> <span class="dv">6</span></span>
<span id="cb218-18"><a href="point-cloud-classification.html#cb218-18" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;volume_diff_image_mean&quot;</span> <span class="sc">~</span> <span class="dv">7</span></span>
<span id="cb218-19"><a href="point-cloud-classification.html#cb218-19" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;height_diff_mean&quot;</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb218-20"><a href="point-cloud-classification.html#cb218-20" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-21"><a href="point-cloud-classification.html#cb218-21" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb218-22"><a href="point-cloud-classification.html#cb218-22" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb218-23"><a href="point-cloud-classification.html#cb218-23" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb218-24"><a href="point-cloud-classification.html#cb218-24" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb218-25"><a href="point-cloud-classification.html#cb218-25" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb218-26"><a href="point-cloud-classification.html#cb218-26" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb218-27"><a href="point-cloud-classification.html#cb218-27" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb218-28"><a href="point-cloud-classification.html#cb218-28" tabindex="-1"></a>          , <span class="st">&quot;ME: Area vs field (m2)&quot;</span></span>
<span id="cb218-29"><a href="point-cloud-classification.html#cb218-29" tabindex="-1"></a>          , <span class="st">&quot;ME: Area vs image (m2)&quot;</span></span>
<span id="cb218-30"><a href="point-cloud-classification.html#cb218-30" tabindex="-1"></a>          , <span class="st">&quot;ME: Volume vs field (m3)&quot;</span></span>
<span id="cb218-31"><a href="point-cloud-classification.html#cb218-31" tabindex="-1"></a>          , <span class="st">&quot;ME: Volume vs image (m3)&quot;</span></span>
<span id="cb218-32"><a href="point-cloud-classification.html#cb218-32" tabindex="-1"></a>          , <span class="st">&quot;ME: Height (m)&quot;</span></span>
<span id="cb218-33"><a href="point-cloud-classification.html#cb218-33" tabindex="-1"></a>        )</span>
<span id="cb218-34"><a href="point-cloud-classification.html#cb218-34" tabindex="-1"></a>      )</span>
<span id="cb218-35"><a href="point-cloud-classification.html#cb218-35" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb218-36"><a href="point-cloud-classification.html#cb218-36" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb218-37"><a href="point-cloud-classification.html#cb218-37" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> metric)</span>
<span id="cb218-38"><a href="point-cloud-classification.html#cb218-38" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb218-39"><a href="point-cloud-classification.html#cb218-39" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb218-40"><a href="point-cloud-classification.html#cb218-40" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb218-41"><a href="point-cloud-classification.html#cb218-41" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(</span>
<span id="cb218-42"><a href="point-cloud-classification.html#cb218-42" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">pal_get_pairs_fn</span>(<span class="dv">6</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb218-43"><a href="point-cloud-classification.html#cb218-43" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb218-44"><a href="point-cloud-classification.html#cb218-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb218-45"><a href="point-cloud-classification.html#cb218-45" tabindex="-1"></a>    <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">8</span>)</span>
<span id="cb218-46"><a href="point-cloud-classification.html#cb218-46" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb218-47"><a href="point-cloud-classification.html#cb218-47" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb218-48"><a href="point-cloud-classification.html#cb218-48" tabindex="-1"></a>    <span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric)</span>
<span id="cb218-49"><a href="point-cloud-classification.html#cb218-49" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb218-50"><a href="point-cloud-classification.html#cb218-50" tabindex="-1"></a>    , <span class="at">scales =</span> <span class="st">&quot;free&quot;</span></span>
<span id="cb218-51"><a href="point-cloud-classification.html#cb218-51" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb218-52"><a href="point-cloud-classification.html#cb218-52" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb218-53"><a href="point-cloud-classification.html#cb218-53" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb218-54"><a href="point-cloud-classification.html#cb218-54" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;Mean Error &lt; 0 =&gt; Actual&gt;Predicted</span><span class="sc">\n</span><span class="st">Mean Error &gt; 0 =&gt; Actual&lt;Predicted&quot;</span></span>
<span id="cb218-55"><a href="point-cloud-classification.html#cb218-55" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb218-56"><a href="point-cloud-classification.html#cb218-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb218-57"><a href="point-cloud-classification.html#cb218-57" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb218-58"><a href="point-cloud-classification.html#cb218-58" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb218-59"><a href="point-cloud-classification.html#cb218-59" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb218-60"><a href="point-cloud-classification.html#cb218-60" tabindex="-1"></a>    , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>)</span>
<span id="cb218-61"><a href="point-cloud-classification.html#cb218-61" tabindex="-1"></a>    , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb218-62"><a href="point-cloud-classification.html#cb218-62" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-184-1.png" width="1008" /></p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="point-cloud-classification.html#cb219-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_dist_me.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>let’s average across all other factors to look at the main effect by parameter</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="point-cloud-classification.html#cb220-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb220-2"><a href="point-cloud-classification.html#cb220-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb220-3"><a href="point-cloud-classification.html#cb220-3" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)</span>
<span id="cb220-4"><a href="point-cloud-classification.html#cb220-4" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb220-5"><a href="point-cloud-classification.html#cb220-5" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb220-6"><a href="point-cloud-classification.html#cb220-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-7"><a href="point-cloud-classification.html#cb220-7" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb220-8"><a href="point-cloud-classification.html#cb220-8" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct)</span>
<span id="cb220-9"><a href="point-cloud-classification.html#cb220-9" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;param&quot;</span></span>
<span id="cb220-10"><a href="point-cloud-classification.html#cb220-10" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;param_value&quot;</span></span>
<span id="cb220-11"><a href="point-cloud-classification.html#cb220-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-12"><a href="point-cloud-classification.html#cb220-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(param, param_value, metric) <span class="sc">%&gt;%</span></span>
<span id="cb220-13"><a href="point-cloud-classification.html#cb220-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb220-14"><a href="point-cloud-classification.html#cb220-14" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)</span>
<span id="cb220-15"><a href="point-cloud-classification.html#cb220-15" tabindex="-1"></a>    , <span class="at">q25 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb220-16"><a href="point-cloud-classification.html#cb220-16" tabindex="-1"></a>    , <span class="at">q75 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb220-17"><a href="point-cloud-classification.html#cb220-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-18"><a href="point-cloud-classification.html#cb220-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb220-19"><a href="point-cloud-classification.html#cb220-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb220-20"><a href="point-cloud-classification.html#cb220-20" tabindex="-1"></a>    <span class="at">param =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb220-21"><a href="point-cloud-classification.html#cb220-21" tabindex="-1"></a>        param <span class="sc">==</span> <span class="st">&quot;max_ht_m&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb220-22"><a href="point-cloud-classification.html#cb220-22" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;min_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb220-23"><a href="point-cloud-classification.html#cb220-23" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;max_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb220-24"><a href="point-cloud-classification.html#cb220-24" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;convexity_pct&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb220-25"><a href="point-cloud-classification.html#cb220-25" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb220-26"><a href="point-cloud-classification.html#cb220-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-27"><a href="point-cloud-classification.html#cb220-27" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb220-28"><a href="point-cloud-classification.html#cb220-28" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb220-29"><a href="point-cloud-classification.html#cb220-29" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb220-30"><a href="point-cloud-classification.html#cb220-30" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb220-31"><a href="point-cloud-classification.html#cb220-31" tabindex="-1"></a>          <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb220-32"><a href="point-cloud-classification.html#cb220-32" tabindex="-1"></a>          , <span class="st">&quot;min_area_m2&quot;</span></span>
<span id="cb220-33"><a href="point-cloud-classification.html#cb220-33" tabindex="-1"></a>          , <span class="st">&quot;max_area_m2&quot;</span></span>
<span id="cb220-34"><a href="point-cloud-classification.html#cb220-34" tabindex="-1"></a>          , <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb220-35"><a href="point-cloud-classification.html#cb220-35" tabindex="-1"></a>          , <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb220-36"><a href="point-cloud-classification.html#cb220-36" tabindex="-1"></a>        )</span>
<span id="cb220-37"><a href="point-cloud-classification.html#cb220-37" tabindex="-1"></a>      )</span>
<span id="cb220-38"><a href="point-cloud-classification.html#cb220-38" tabindex="-1"></a>    , <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb220-39"><a href="point-cloud-classification.html#cb220-39" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb220-40"><a href="point-cloud-classification.html#cb220-40" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb220-41"><a href="point-cloud-classification.html#cb220-41" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb220-42"><a href="point-cloud-classification.html#cb220-42" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-43"><a href="point-cloud-classification.html#cb220-43" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb220-44"><a href="point-cloud-classification.html#cb220-44" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb220-45"><a href="point-cloud-classification.html#cb220-45" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb220-46"><a href="point-cloud-classification.html#cb220-46" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb220-47"><a href="point-cloud-classification.html#cb220-47" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb220-48"><a href="point-cloud-classification.html#cb220-48" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb220-49"><a href="point-cloud-classification.html#cb220-49" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb220-50"><a href="point-cloud-classification.html#cb220-50" tabindex="-1"></a>        )</span>
<span id="cb220-51"><a href="point-cloud-classification.html#cb220-51" tabindex="-1"></a>      )</span>
<span id="cb220-52"><a href="point-cloud-classification.html#cb220-52" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb220-53"><a href="point-cloud-classification.html#cb220-53" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb220-54"><a href="point-cloud-classification.html#cb220-54" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> median, <span class="at">x =</span> param_value, <span class="at">color =</span> metric, <span class="at">fill =</span> metric, <span class="at">group =</span> metric, <span class="at">shape =</span> metric)</span>
<span id="cb220-55"><a href="point-cloud-classification.html#cb220-55" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb220-56"><a href="point-cloud-classification.html#cb220-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(</span>
<span id="cb220-57"><a href="point-cloud-classification.html#cb220-57" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">ymin =</span> q25, <span class="at">ymax =</span> q75)</span>
<span id="cb220-58"><a href="point-cloud-classification.html#cb220-58" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span></span>
<span id="cb220-59"><a href="point-cloud-classification.html#cb220-59" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb220-60"><a href="point-cloud-classification.html#cb220-60" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb220-61"><a href="point-cloud-classification.html#cb220-61" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb220-62"><a href="point-cloud-classification.html#cb220-62" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(param), <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-63"><a href="point-cloud-classification.html#cb220-63" tabindex="-1"></a>  <span class="co"># ggplot2::scale_color_viridis_d(begin = 0.2, end = 0.8) +</span></span>
<span id="cb220-64"><a href="point-cloud-classification.html#cb220-64" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb220-65"><a href="point-cloud-classification.html#cb220-65" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb220-66"><a href="point-cloud-classification.html#cb220-66" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels =</span> scales<span class="sc">::</span>percent, <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb220-67"><a href="point-cloud-classification.html#cb220-67" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;median value&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-68"><a href="point-cloud-classification.html#cb220-68" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb220-69"><a href="point-cloud-classification.html#cb220-69" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb220-70"><a href="point-cloud-classification.html#cb220-70" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb220-71"><a href="point-cloud-classification.html#cb220-71" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb220-72"><a href="point-cloud-classification.html#cb220-72" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb220-73"><a href="point-cloud-classification.html#cb220-73" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb220-74"><a href="point-cloud-classification.html#cb220-74" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">linetype =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="dv">1</span>))</span>
<span id="cb220-75"><a href="point-cloud-classification.html#cb220-75" tabindex="-1"></a>    , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb220-76"><a href="point-cloud-classification.html#cb220-76" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-185-1.png" width="1008" /></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="point-cloud-classification.html#cb221-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_test.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>based on these main effect aggregated results:</p>
<ul>
<li>increasing the <code>max_ht_m</code> (determines the “slice” of the CHM to use) reduces precision and F-score with minimal impact on recall</li>
<li>increasing the <code>max_area_m2</code> (determines the maximum pile area) has minimal impact on all three evaluation metrics</li>
<li>increasing <code>convexity_pct</code> toward 1 to favor regular shapes had minimal impact on metrics until parameter values exceeded 0.7, at which point recall decreased, but precision and F-score slightly improved</li>
<li>increasing <code>circle_fit_iou_pct</code> toward 1 to favor circular shapes minimally affected recall while improving precision and F-score up to parameter values of 0.5. Beyond this, recall significantly dropped, with only modest F-score improvements, and overall accuracy measured by F-score crashed past 0.7</li>
</ul>
<p>let’s average across all other factors to look at the main effect by parameter for the <strong>MAPE</strong> metrics</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="point-cloud-classification.html#cb222-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb222-2"><a href="point-cloud-classification.html#cb222-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;volume_diff&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb222-3"><a href="point-cloud-classification.html#cb222-3" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb222-4"><a href="point-cloud-classification.html#cb222-4" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_mape&quot;</span>))</span>
<span id="cb222-5"><a href="point-cloud-classification.html#cb222-5" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb222-6"><a href="point-cloud-classification.html#cb222-6" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb222-7"><a href="point-cloud-classification.html#cb222-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb222-8"><a href="point-cloud-classification.html#cb222-8" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb222-9"><a href="point-cloud-classification.html#cb222-9" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct)</span>
<span id="cb222-10"><a href="point-cloud-classification.html#cb222-10" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;param&quot;</span></span>
<span id="cb222-11"><a href="point-cloud-classification.html#cb222-11" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;param_value&quot;</span></span>
<span id="cb222-12"><a href="point-cloud-classification.html#cb222-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb222-13"><a href="point-cloud-classification.html#cb222-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(param, param_value, metric) <span class="sc">%&gt;%</span></span>
<span id="cb222-14"><a href="point-cloud-classification.html#cb222-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb222-15"><a href="point-cloud-classification.html#cb222-15" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)</span>
<span id="cb222-16"><a href="point-cloud-classification.html#cb222-16" tabindex="-1"></a>    , <span class="at">q25 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb222-17"><a href="point-cloud-classification.html#cb222-17" tabindex="-1"></a>    , <span class="at">q75 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(value,<span class="at">na.rm=</span>T,<span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb222-18"><a href="point-cloud-classification.html#cb222-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb222-19"><a href="point-cloud-classification.html#cb222-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb222-20"><a href="point-cloud-classification.html#cb222-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb222-21"><a href="point-cloud-classification.html#cb222-21" tabindex="-1"></a>    <span class="at">param =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb222-22"><a href="point-cloud-classification.html#cb222-22" tabindex="-1"></a>        param <span class="sc">==</span> <span class="st">&quot;max_ht_m&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb222-23"><a href="point-cloud-classification.html#cb222-23" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;min_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb222-24"><a href="point-cloud-classification.html#cb222-24" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;max_area_m2&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb222-25"><a href="point-cloud-classification.html#cb222-25" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;convexity_pct&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb222-26"><a href="point-cloud-classification.html#cb222-26" tabindex="-1"></a>        , param <span class="sc">==</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb222-27"><a href="point-cloud-classification.html#cb222-27" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb222-28"><a href="point-cloud-classification.html#cb222-28" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb222-29"><a href="point-cloud-classification.html#cb222-29" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb222-30"><a href="point-cloud-classification.html#cb222-30" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb222-31"><a href="point-cloud-classification.html#cb222-31" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb222-32"><a href="point-cloud-classification.html#cb222-32" tabindex="-1"></a>          <span class="st">&quot;max_ht_m&quot;</span></span>
<span id="cb222-33"><a href="point-cloud-classification.html#cb222-33" tabindex="-1"></a>          , <span class="st">&quot;min_area_m2&quot;</span></span>
<span id="cb222-34"><a href="point-cloud-classification.html#cb222-34" tabindex="-1"></a>          , <span class="st">&quot;max_area_m2&quot;</span></span>
<span id="cb222-35"><a href="point-cloud-classification.html#cb222-35" tabindex="-1"></a>          , <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb222-36"><a href="point-cloud-classification.html#cb222-36" tabindex="-1"></a>          , <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb222-37"><a href="point-cloud-classification.html#cb222-37" tabindex="-1"></a>        )</span>
<span id="cb222-38"><a href="point-cloud-classification.html#cb222-38" tabindex="-1"></a>      )</span>
<span id="cb222-39"><a href="point-cloud-classification.html#cb222-39" tabindex="-1"></a>    , <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb222-40"><a href="point-cloud-classification.html#cb222-40" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb222-41"><a href="point-cloud-classification.html#cb222-41" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb222-42"><a href="point-cloud-classification.html#cb222-42" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb222-43"><a href="point-cloud-classification.html#cb222-43" tabindex="-1"></a>        <span class="co"># rmse</span></span>
<span id="cb222-44"><a href="point-cloud-classification.html#cb222-44" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_area_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb222-45"><a href="point-cloud-classification.html#cb222-45" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_area_image_mape&quot;</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb222-46"><a href="point-cloud-classification.html#cb222-46" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_volume_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">6</span></span>
<span id="cb222-47"><a href="point-cloud-classification.html#cb222-47" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_volume_image_mape&quot;</span> <span class="sc">~</span> <span class="dv">7</span></span>
<span id="cb222-48"><a href="point-cloud-classification.html#cb222-48" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_height_mape&quot;</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb222-49"><a href="point-cloud-classification.html#cb222-49" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb222-50"><a href="point-cloud-classification.html#cb222-50" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb222-51"><a href="point-cloud-classification.html#cb222-51" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb222-52"><a href="point-cloud-classification.html#cb222-52" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb222-53"><a href="point-cloud-classification.html#cb222-53" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb222-54"><a href="point-cloud-classification.html#cb222-54" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb222-55"><a href="point-cloud-classification.html#cb222-55" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb222-56"><a href="point-cloud-classification.html#cb222-56" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb222-57"><a href="point-cloud-classification.html#cb222-57" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Area vs field (%)&quot;</span></span>
<span id="cb222-58"><a href="point-cloud-classification.html#cb222-58" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Area vs image (%)&quot;</span></span>
<span id="cb222-59"><a href="point-cloud-classification.html#cb222-59" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Volume vs field (%)&quot;</span></span>
<span id="cb222-60"><a href="point-cloud-classification.html#cb222-60" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Volume vs image (%)&quot;</span></span>
<span id="cb222-61"><a href="point-cloud-classification.html#cb222-61" tabindex="-1"></a>          , <span class="st">&quot;MAPE: Height (%)&quot;</span></span>
<span id="cb222-62"><a href="point-cloud-classification.html#cb222-62" tabindex="-1"></a>        )</span>
<span id="cb222-63"><a href="point-cloud-classification.html#cb222-63" tabindex="-1"></a>      )</span>
<span id="cb222-64"><a href="point-cloud-classification.html#cb222-64" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb222-65"><a href="point-cloud-classification.html#cb222-65" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb222-66"><a href="point-cloud-classification.html#cb222-66" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> median, <span class="at">x =</span> param_value, <span class="at">color =</span> metric, <span class="at">fill =</span> metric, <span class="at">group =</span> metric, <span class="at">shape =</span> metric)</span>
<span id="cb222-67"><a href="point-cloud-classification.html#cb222-67" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb222-68"><a href="point-cloud-classification.html#cb222-68" tabindex="-1"></a>  <span class="co"># ggplot2::geom_ribbon(</span></span>
<span id="cb222-69"><a href="point-cloud-classification.html#cb222-69" tabindex="-1"></a>  <span class="co">#   mapping = ggplot2::aes(ymin = q25, ymax = q75)</span></span>
<span id="cb222-70"><a href="point-cloud-classification.html#cb222-70" tabindex="-1"></a>  <span class="co">#   , alpha = 0.2, color = NA</span></span>
<span id="cb222-71"><a href="point-cloud-classification.html#cb222-71" tabindex="-1"></a>  <span class="co"># ) +</span></span>
<span id="cb222-72"><a href="point-cloud-classification.html#cb222-72" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb222-73"><a href="point-cloud-classification.html#cb222-73" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb222-74"><a href="point-cloud-classification.html#cb222-74" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(param), <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb222-75"><a href="point-cloud-classification.html#cb222-75" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">pal_get_pairs_fn</span>(<span class="dv">6</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]) <span class="sc">+</span></span>
<span id="cb222-76"><a href="point-cloud-classification.html#cb222-76" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">pal_get_pairs_fn</span>(<span class="dv">6</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]) <span class="sc">+</span></span>
<span id="cb222-77"><a href="point-cloud-classification.html#cb222-77" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb222-78"><a href="point-cloud-classification.html#cb222-78" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels =</span> scales<span class="sc">::</span>percent, <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb222-79"><a href="point-cloud-classification.html#cb222-79" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;median value&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb222-80"><a href="point-cloud-classification.html#cb222-80" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb222-81"><a href="point-cloud-classification.html#cb222-81" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb222-82"><a href="point-cloud-classification.html#cb222-82" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb222-83"><a href="point-cloud-classification.html#cb222-83" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb222-84"><a href="point-cloud-classification.html#cb222-84" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb222-85"><a href="point-cloud-classification.html#cb222-85" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb222-86"><a href="point-cloud-classification.html#cb222-86" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">linetype =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="dv">1</span>))</span>
<span id="cb222-87"><a href="point-cloud-classification.html#cb222-87" tabindex="-1"></a>    , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb222-88"><a href="point-cloud-classification.html#cb222-88" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-186-1.png" width="1008" /></p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="point-cloud-classification.html#cb223-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_test_mape.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>these results indicate that the method’s accuracy in outlining slash pile form is robust to parameter changes, as the relevant shape accuracy metrics remain consistent across various settings</p>
<div id="best-results-detection" class="section level6 hasAnchor" number="4.2.2.2.2.1">
<h6><span class="header-section-number">4.2.2.2.2.1</span> Best results: detection<a href="point-cloud-classification.html#best-results-detection" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>we can cut to the chase and just look at the parameter combinations that achieved the best results based on the evaluation metrics</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="point-cloud-classification.html#cb224-1" tabindex="-1"></a>pct_rank_th_temp <span class="ot">&lt;-</span> <span class="fl">0.99</span></span>
<span id="cb224-2"><a href="point-cloud-classification.html#cb224-2" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span> param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb224-3"><a href="point-cloud-classification.html#cb224-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(f_score), <span class="fu">desc</span>(recall), <span class="fu">desc</span>(precision)) <span class="sc">%&gt;%</span> </span>
<span id="cb224-4"><a href="point-cloud-classification.html#cb224-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb224-5"><a href="point-cloud-classification.html#cb224-5" tabindex="-1"></a>    <span class="at">.cols =</span> <span class="fu">c</span>(f_score, recall, precision)</span>
<span id="cb224-6"><a href="point-cloud-classification.html#cb224-6" tabindex="-1"></a>    , <span class="at">.fn =</span> dplyr<span class="sc">::</span>percent_rank</span>
<span id="cb224-7"><a href="point-cloud-classification.html#cb224-7" tabindex="-1"></a>    , <span class="at">.names =</span> <span class="st">&quot;pct_rank_{.col}&quot;</span></span>
<span id="cb224-8"><a href="point-cloud-classification.html#cb224-8" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb224-9"><a href="point-cloud-classification.html#cb224-9" tabindex="-1"></a>  <span class="co"># now get the max of these pct ranks by row</span></span>
<span id="cb224-10"><a href="point-cloud-classification.html#cb224-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb224-11"><a href="point-cloud-classification.html#cb224-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-12"><a href="point-cloud-classification.html#cb224-12" tabindex="-1"></a>    <span class="at">pct_rank_max =</span> <span class="fu">max</span>(</span>
<span id="cb224-13"><a href="point-cloud-classification.html#cb224-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">c_across</span>(</span>
<span id="cb224-14"><a href="point-cloud-classification.html#cb224-14" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb224-15"><a href="point-cloud-classification.html#cb224-15" tabindex="-1"></a>      )</span>
<span id="cb224-16"><a href="point-cloud-classification.html#cb224-16" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb224-17"><a href="point-cloud-classification.html#cb224-17" tabindex="-1"></a>    )</span>
<span id="cb224-18"><a href="point-cloud-classification.html#cb224-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-19"><a href="point-cloud-classification.html#cb224-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb224-20"><a href="point-cloud-classification.html#cb224-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-21"><a href="point-cloud-classification.html#cb224-21" tabindex="-1"></a>    <span class="at">rank_lab =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb224-22"><a href="point-cloud-classification.html#cb224-22" tabindex="-1"></a>      pct_rank_f_score<span class="sc">&gt;=</span>pct_rank_th_temp <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb224-23"><a href="point-cloud-classification.html#cb224-23" tabindex="-1"></a>      , pct_rank_recall<span class="sc">&gt;=</span>pct_rank_th_temp <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb224-24"><a href="point-cloud-classification.html#cb224-24" tabindex="-1"></a>      , pct_rank_precision<span class="sc">&gt;=</span>pct_rank_th_temp <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb224-25"><a href="point-cloud-classification.html#cb224-25" tabindex="-1"></a>      , (pct_rank_f_score<span class="sc">&lt;=</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp) <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(f_score,<span class="dv">0</span>)<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb224-26"><a href="point-cloud-classification.html#cb224-26" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-27"><a href="point-cloud-classification.html#cb224-27" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb224-28"><a href="point-cloud-classification.html#cb224-28" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb224-29"><a href="point-cloud-classification.html#cb224-29" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb224-30"><a href="point-cloud-classification.html#cb224-30" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb224-31"><a href="point-cloud-classification.html#cb224-31" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; F-score&quot;</span>)</span>
<span id="cb224-32"><a href="point-cloud-classification.html#cb224-32" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; Recall&quot;</span>)</span>
<span id="cb224-33"><a href="point-cloud-classification.html#cb224-33" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; Precision&quot;</span>)</span>
<span id="cb224-34"><a href="point-cloud-classification.html#cb224-34" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;bottom &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; F-score&quot;</span>)</span>
<span id="cb224-35"><a href="point-cloud-classification.html#cb224-35" tabindex="-1"></a>        )</span>
<span id="cb224-36"><a href="point-cloud-classification.html#cb224-36" tabindex="-1"></a>      )</span>
<span id="cb224-37"><a href="point-cloud-classification.html#cb224-37" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-38"><a href="point-cloud-classification.html#cb224-38" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb224-39"><a href="point-cloud-classification.html#cb224-39" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(rank_lab) <span class="co"># pct_rank_max&gt;=0.99</span></span>
<span id="cb224-40"><a href="point-cloud-classification.html#cb224-40" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb224-41"><a href="point-cloud-classification.html#cb224-41" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-42"><a href="point-cloud-classification.html#cb224-42" tabindex="-1"></a>    <span class="at">lab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct, <span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)</span>
<span id="cb224-43"><a href="point-cloud-classification.html#cb224-43" tabindex="-1"></a>  ) </span>
<span id="cb224-44"><a href="point-cloud-classification.html#cb224-44" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb224-45"><a href="point-cloud-classification.html#cb224-45" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb224-46"><a href="point-cloud-classification.html#cb224-46" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)</span>
<span id="cb224-47"><a href="point-cloud-classification.html#cb224-47" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb224-48"><a href="point-cloud-classification.html#cb224-48" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb224-49"><a href="point-cloud-classification.html#cb224-49" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-50"><a href="point-cloud-classification.html#cb224-50" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb224-51"><a href="point-cloud-classification.html#cb224-51" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb224-52"><a href="point-cloud-classification.html#cb224-52" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;f_score&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb224-53"><a href="point-cloud-classification.html#cb224-53" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;recall&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb224-54"><a href="point-cloud-classification.html#cb224-54" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;precision&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb224-55"><a href="point-cloud-classification.html#cb224-55" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb224-56"><a href="point-cloud-classification.html#cb224-56" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb224-57"><a href="point-cloud-classification.html#cb224-57" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb224-58"><a href="point-cloud-classification.html#cb224-58" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb224-59"><a href="point-cloud-classification.html#cb224-59" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb224-60"><a href="point-cloud-classification.html#cb224-60" tabindex="-1"></a>          <span class="st">&quot;F-score&quot;</span></span>
<span id="cb224-61"><a href="point-cloud-classification.html#cb224-61" tabindex="-1"></a>          , <span class="st">&quot;Recall&quot;</span></span>
<span id="cb224-62"><a href="point-cloud-classification.html#cb224-62" tabindex="-1"></a>          , <span class="st">&quot;Precision&quot;</span></span>
<span id="cb224-63"><a href="point-cloud-classification.html#cb224-63" tabindex="-1"></a>        )</span>
<span id="cb224-64"><a href="point-cloud-classification.html#cb224-64" tabindex="-1"></a>      )</span>
<span id="cb224-65"><a href="point-cloud-classification.html#cb224-65" tabindex="-1"></a>    , <span class="at">lab =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(lab, pct_rank_f_score)</span>
<span id="cb224-66"><a href="point-cloud-classification.html#cb224-66" tabindex="-1"></a>    , <span class="at">val_lab =</span> scales<span class="sc">::</span><span class="fu">percent</span>(value, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb224-67"><a href="point-cloud-classification.html#cb224-67" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb224-68"><a href="point-cloud-classification.html#cb224-68" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb224-69"><a href="point-cloud-classification.html#cb224-69" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> lab, <span class="at">fill =</span> metric, <span class="at">label =</span> val_lab)</span>
<span id="cb224-70"><a href="point-cloud-classification.html#cb224-70" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb224-71"><a href="point-cloud-classification.html#cb224-71" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb224-72"><a href="point-cloud-classification.html#cb224-72" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb224-73"><a href="point-cloud-classification.html#cb224-73" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_eval_metric) <span class="sc">+</span></span>
<span id="cb224-74"><a href="point-cloud-classification.html#cb224-74" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb224-75"><a href="point-cloud-classification.html#cb224-75" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb224-76"><a href="point-cloud-classification.html#cb224-76" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.05</span>)</span>
<span id="cb224-77"><a href="point-cloud-classification.html#cb224-77" tabindex="-1"></a>    <span class="co"># , expand = expansion(mult = c(0, .08))</span></span>
<span id="cb224-78"><a href="point-cloud-classification.html#cb224-78" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb224-79"><a href="point-cloud-classification.html#cb224-79" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(rank_lab), <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb224-80"><a href="point-cloud-classification.html#cb224-80" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb224-81"><a href="point-cloud-classification.html#cb224-81" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;max_ht_m : max_area_m2 : convexity_pct : circle_fit_iou_pct&quot;</span></span>
<span id="cb224-82"><a href="point-cloud-classification.html#cb224-82" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb224-83"><a href="point-cloud-classification.html#cb224-83" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;top (and bottom) parameter combinations by evaluation metrics&quot;</span></span>
<span id="cb224-84"><a href="point-cloud-classification.html#cb224-84" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb224-85"><a href="point-cloud-classification.html#cb224-85" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb224-86"><a href="point-cloud-classification.html#cb224-86" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb224-87"><a href="point-cloud-classification.html#cb224-87" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb224-88"><a href="point-cloud-classification.html#cb224-88" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb224-89"><a href="point-cloud-classification.html#cb224-89" tabindex="-1"></a>    , <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb224-90"><a href="point-cloud-classification.html#cb224-90" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-187-1.png" width="1008" /></p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="point-cloud-classification.html#cb225-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_ever_bars.jpeg&quot;</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">width =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>let’s make a table of these results</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="point-cloud-classification.html#cb226-1" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb226-2"><a href="point-cloud-classification.html#cb226-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_rank_max<span class="sc">&gt;=</span>pct_rank_th_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb226-3"><a href="point-cloud-classification.html#cb226-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb226-4"><a href="point-cloud-classification.html#cb226-4" tabindex="-1"></a>    rank_lab</span>
<span id="cb226-5"><a href="point-cloud-classification.html#cb226-5" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb226-6"><a href="point-cloud-classification.html#cb226-6" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb226-7"><a href="point-cloud-classification.html#cb226-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-8"><a href="point-cloud-classification.html#cb226-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb226-9"><a href="point-cloud-classification.html#cb226-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(rank_lab,<span class="fu">desc</span>(f_score), <span class="fu">desc</span>(recall), <span class="fu">desc</span>(precision)) <span class="sc">%&gt;%</span> </span>
<span id="cb226-10"><a href="point-cloud-classification.html#cb226-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb226-11"><a href="point-cloud-classification.html#cb226-11" tabindex="-1"></a>    <span class="at">.cols =</span> <span class="fu">c</span>(f_score, recall, precision)</span>
<span id="cb226-12"><a href="point-cloud-classification.html#cb226-12" tabindex="-1"></a>    , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb226-13"><a href="point-cloud-classification.html#cb226-13" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb226-14"><a href="point-cloud-classification.html#cb226-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">blank=</span> <span class="st">&quot;   &quot;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-15"><a href="point-cloud-classification.html#cb226-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(blank, <span class="at">.before =</span> f_score) <span class="sc">%&gt;%</span> </span>
<span id="cb226-16"><a href="point-cloud-classification.html#cb226-16" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb226-17"><a href="point-cloud-classification.html#cb226-17" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;parameter combinations that achieved the best slash pile detection results&quot;</span></span>
<span id="cb226-18"><a href="point-cloud-classification.html#cb226-18" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb226-19"><a href="point-cloud-classification.html#cb226-19" tabindex="-1"></a>      <span class="st">&quot;.&quot;</span></span>
<span id="cb226-20"><a href="point-cloud-classification.html#cb226-20" tabindex="-1"></a>      ,<span class="st">&quot;max_ht_m&quot;</span>,<span class="st">&quot;max_area_m2&quot;</span>,<span class="st">&quot;convexity_pct&quot;</span>,<span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb226-21"><a href="point-cloud-classification.html#cb226-21" tabindex="-1"></a>      , <span class="st">&quot;   &quot;</span></span>
<span id="cb226-22"><a href="point-cloud-classification.html#cb226-22" tabindex="-1"></a>      , <span class="st">&quot;F-score&quot;</span>, <span class="st">&quot;Recall&quot;</span>, <span class="st">&quot;Precision&quot;</span></span>
<span id="cb226-23"><a href="point-cloud-classification.html#cb226-23" tabindex="-1"></a>    )</span>
<span id="cb226-24"><a href="point-cloud-classification.html#cb226-24" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb226-25"><a href="point-cloud-classification.html#cb226-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-26"><a href="point-cloud-classification.html#cb226-26" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb226-27"><a href="point-cloud-classification.html#cb226-27" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb226-28"><a href="point-cloud-classification.html#cb226-28" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">6</span>, <span class="st">&quot;Evaluation Metric&quot;</span> <span class="ot">=</span> <span class="dv">3</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-188">Table 4.1: </span>parameter combinations that achieved the best slash pile detection results
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="6">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Evaluation Metric
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
.
</th>
<th style="text-align:right;">
max_ht_m
</th>
<th style="text-align:right;">
max_area_m2
</th>
<th style="text-align:right;">
convexity_pct
</th>
<th style="text-align:right;">
circle_fit_iou_pct
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
F-score
</th>
<th style="text-align:left;">
Recall
</th>
<th style="text-align:left;">
Precision
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="13">
top 1% F-score
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
82%
</td>
<td style="text-align:left;">
64%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
72%
</td>
<td style="text-align:left;">
83%
</td>
<td style="text-align:left;">
63%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
71%
</td>
<td style="text-align:left;">
81%
</td>
<td style="text-align:left;">
63%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
71%
</td>
<td style="text-align:left;">
80%
</td>
<td style="text-align:left;">
63%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
71%
</td>
<td style="text-align:left;">
79%
</td>
<td style="text-align:left;">
64%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
71%
</td>
<td style="text-align:left;">
80%
</td>
<td style="text-align:left;">
63%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
83%
</td>
<td style="text-align:left;">
61%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
80%
</td>
<td style="text-align:left;">
62%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
81%
</td>
<td style="text-align:left;">
61%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
78%
</td>
<td style="text-align:left;">
63%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
70%
</td>
<td style="text-align:left;">
79%
</td>
<td style="text-align:left;">
62%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
69%
</td>
<td style="text-align:left;">
64%
</td>
<td style="text-align:left;">
76%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
40
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
69%
</td>
<td style="text-align:left;">
80%
</td>
<td style="text-align:left;">
61%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="13">
top 1% Recall
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
58%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
42%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
54%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
38%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
53%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
37%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
51%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
35%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
50%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
34%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
49%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
33%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
130
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
49%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
33%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
49%
</td>
<td style="text-align:left;">
96%
</td>
<td style="text-align:left;">
32%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
48%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
32%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
43%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
28%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
42%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
27%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
42%
</td>
<td style="text-align:left;">
96%
</td>
<td style="text-align:left;">
27%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
41%
</td>
<td style="text-align:left;">
95%
</td>
<td style="text-align:left;">
26%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
top 1% Precision
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
30%
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
81%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
28%
</td>
<td style="text-align:left;">
17%
</td>
<td style="text-align:left;">
87%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
130
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
27%
</td>
<td style="text-align:left;">
17%
</td>
<td style="text-align:left;">
80%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
40
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
25%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
82%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
24%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
81%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
24%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
81%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
24%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
81%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
24%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
81%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
79%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
130
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
79%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
88%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
10%
</td>
<td style="text-align:left;">
86%
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="point-cloud-classification.html#cb227-1" tabindex="-1"></a>  <span class="co"># kableExtra::scroll_box(height = &quot;8in&quot;)</span></span></code></pre></div>
<p>let’s check out maps of the pile detection results for the parameter combinations with the highest F-score</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="point-cloud-classification.html#cb228-1" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span> df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb228-2"><a href="point-cloud-classification.html#cb228-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_rank_f_score<span class="sc">&gt;=</span>pct_rank_th_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb228-3"><a href="point-cloud-classification.html#cb228-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(f_score), <span class="fu">desc</span>(recall), <span class="fu">desc</span>(precision)) <span class="sc">%&gt;%</span> </span>
<span id="cb228-4"><a href="point-cloud-classification.html#cb228-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb228-5"><a href="point-cloud-classification.html#cb228-5" tabindex="-1"></a>    rn, rank_lab</span>
<span id="cb228-6"><a href="point-cloud-classification.html#cb228-6" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb228-7"><a href="point-cloud-classification.html#cb228-7" tabindex="-1"></a>    , f_score, recall, precision</span>
<span id="cb228-8"><a href="point-cloud-classification.html#cb228-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb228-9"><a href="point-cloud-classification.html#cb228-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">4</span>)</span>
<span id="cb228-10"><a href="point-cloud-classification.html#cb228-10" tabindex="-1"></a><span class="co"># ortho</span></span>
<span id="cb228-11"><a href="point-cloud-classification.html#cb228-11" tabindex="-1"></a>ortho_plt_temp <span class="ot">&lt;-</span> <span class="fu">ortho_plt_fn</span>(</span>
<span id="cb228-12"><a href="point-cloud-classification.html#cb228-12" tabindex="-1"></a>    <span class="at">stand =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(stand_boundary) <span class="sc">%&gt;%</span></span>
<span id="cb228-13"><a href="point-cloud-classification.html#cb228-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span></span>
<span id="cb228-14"><a href="point-cloud-classification.html#cb228-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb228-15"><a href="point-cloud-classification.html#cb228-15" tabindex="-1"></a>    , <span class="at">buffer =</span> <span class="dv">10</span></span>
<span id="cb228-16"><a href="point-cloud-classification.html#cb228-16" tabindex="-1"></a>  )</span>
<span id="cb228-17"><a href="point-cloud-classification.html#cb228-17" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb228-18"><a href="point-cloud-classification.html#cb228-18" tabindex="-1"></a>plt_list_temp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_temp) <span class="sc">%&gt;%</span></span>
<span id="cb228-19"><a href="point-cloud-classification.html#cb228-19" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x)</span>
<span id="cb228-20"><a href="point-cloud-classification.html#cb228-20" tabindex="-1"></a>    <span class="co"># ortho_plt_temp +</span></span>
<span id="cb228-21"><a href="point-cloud-classification.html#cb228-21" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb228-22"><a href="point-cloud-classification.html#cb228-22" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb228-23"><a href="point-cloud-classification.html#cb228-23" tabindex="-1"></a>        <span class="at">data =</span> stand_boundary <span class="sc">%&gt;%</span> </span>
<span id="cb228-24"><a href="point-cloud-classification.html#cb228-24" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles))</span>
<span id="cb228-25"><a href="point-cloud-classification.html#cb228-25" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb228-26"><a href="point-cloud-classification.html#cb228-26" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb228-27"><a href="point-cloud-classification.html#cb228-27" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb228-28"><a href="point-cloud-classification.html#cb228-28" tabindex="-1"></a>        <span class="at">data =</span> </span>
<span id="cb228-29"><a href="point-cloud-classification.html#cb228-29" tabindex="-1"></a>          slash_piles_polys <span class="sc">%&gt;%</span> </span>
<span id="cb228-30"><a href="point-cloud-classification.html#cb228-30" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb228-31"><a href="point-cloud-classification.html#cb228-31" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_transform</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(param_combos_piles)) <span class="sc">%&gt;%</span> </span>
<span id="cb228-32"><a href="point-cloud-classification.html#cb228-32" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pile_id=</span><span class="fu">as.numeric</span>(pile_id)) <span class="sc">%&gt;%</span> </span>
<span id="cb228-33"><a href="point-cloud-classification.html#cb228-33" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb228-34"><a href="point-cloud-classification.html#cb228-34" tabindex="-1"></a>              param_combos_gt <span class="sc">%&gt;%</span> </span>
<span id="cb228-35"><a href="point-cloud-classification.html#cb228-35" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> df_temp<span class="sc">$</span>rn[x]) <span class="sc">%&gt;%</span> </span>
<span id="cb228-36"><a href="point-cloud-classification.html#cb228-36" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(pile_id,match_grp)</span>
<span id="cb228-37"><a href="point-cloud-classification.html#cb228-37" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;pile_id&quot;</span></span>
<span id="cb228-38"><a href="point-cloud-classification.html#cb228-38" tabindex="-1"></a>            )</span>
<span id="cb228-39"><a href="point-cloud-classification.html#cb228-39" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb228-40"><a href="point-cloud-classification.html#cb228-40" tabindex="-1"></a>        , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.6</span></span>
<span id="cb228-41"><a href="point-cloud-classification.html#cb228-41" tabindex="-1"></a>      ) <span class="sc">+</span> </span>
<span id="cb228-42"><a href="point-cloud-classification.html#cb228-42" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb228-43"><a href="point-cloud-classification.html#cb228-43" tabindex="-1"></a>        <span class="at">data =</span></span>
<span id="cb228-44"><a href="point-cloud-classification.html#cb228-44" tabindex="-1"></a>          param_combos_piles <span class="sc">%&gt;%</span> </span>
<span id="cb228-45"><a href="point-cloud-classification.html#cb228-45" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> df_temp<span class="sc">$</span>rn[x] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb228-46"><a href="point-cloud-classification.html#cb228-46" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb228-47"><a href="point-cloud-classification.html#cb228-47" tabindex="-1"></a>              param_combos_gt <span class="sc">%&gt;%</span></span>
<span id="cb228-48"><a href="point-cloud-classification.html#cb228-48" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(rn <span class="sc">==</span> df_temp<span class="sc">$</span>rn[x] <span class="sc">&amp;</span> is_in_stand) <span class="sc">%&gt;%</span> </span>
<span id="cb228-49"><a href="point-cloud-classification.html#cb228-49" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(pred_id,match_grp)</span>
<span id="cb228-50"><a href="point-cloud-classification.html#cb228-50" tabindex="-1"></a>              , <span class="at">by =</span> <span class="st">&quot;pred_id&quot;</span></span>
<span id="cb228-51"><a href="point-cloud-classification.html#cb228-51" tabindex="-1"></a>            )</span>
<span id="cb228-52"><a href="point-cloud-classification.html#cb228-52" tabindex="-1"></a>        , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb228-53"><a href="point-cloud-classification.html#cb228-53" tabindex="-1"></a>        , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb228-54"><a href="point-cloud-classification.html#cb228-54" tabindex="-1"></a>        , <span class="at">lwd =</span> <span class="fl">0.5</span></span>
<span id="cb228-55"><a href="point-cloud-classification.html#cb228-55" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb228-56"><a href="point-cloud-classification.html#cb228-56" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb228-57"><a href="point-cloud-classification.html#cb228-57" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb228-58"><a href="point-cloud-classification.html#cb228-58" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb228-59"><a href="point-cloud-classification.html#cb228-59" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb228-60"><a href="point-cloud-classification.html#cb228-60" tabindex="-1"></a>          <span class="st">&quot; F-score = &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(df_temp<span class="sc">$</span>f_score[x], <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb228-61"><a href="point-cloud-classification.html#cb228-61" tabindex="-1"></a>          ,<span class="st">&quot; | Recall = &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(df_temp<span class="sc">$</span>recall[x], <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb228-62"><a href="point-cloud-classification.html#cb228-62" tabindex="-1"></a>          ,<span class="st">&quot; | Precision = &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(df_temp<span class="sc">$</span>precision[x], <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb228-63"><a href="point-cloud-classification.html#cb228-63" tabindex="-1"></a>        )</span>
<span id="cb228-64"><a href="point-cloud-classification.html#cb228-64" tabindex="-1"></a>        , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb228-65"><a href="point-cloud-classification.html#cb228-65" tabindex="-1"></a>          <span class="st">&quot; max_ht_m = &quot;</span>, (df_temp<span class="sc">$</span>max_ht_m[x])</span>
<span id="cb228-66"><a href="point-cloud-classification.html#cb228-66" tabindex="-1"></a>          ,<span class="st">&quot; : max_area_m2 = &quot;</span>, (df_temp<span class="sc">$</span>max_area_m2[x])</span>
<span id="cb228-67"><a href="point-cloud-classification.html#cb228-67" tabindex="-1"></a>          ,<span class="st">&quot; : convexity_pct = &quot;</span>, (df_temp<span class="sc">$</span>convexity_pct[x])</span>
<span id="cb228-68"><a href="point-cloud-classification.html#cb228-68" tabindex="-1"></a>          ,<span class="st">&quot; : circle_fit_iou_pct = &quot;</span>, (df_temp<span class="sc">$</span>circle_fit_iou_pct[x])</span>
<span id="cb228-69"><a href="point-cloud-classification.html#cb228-69" tabindex="-1"></a>          , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb228-70"><a href="point-cloud-classification.html#cb228-70" tabindex="-1"></a>        )</span>
<span id="cb228-71"><a href="point-cloud-classification.html#cb228-71" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb228-72"><a href="point-cloud-classification.html#cb228-72" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb228-73"><a href="point-cloud-classification.html#cb228-73" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb228-74"><a href="point-cloud-classification.html#cb228-74" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb228-75"><a href="point-cloud-classification.html#cb228-75" tabindex="-1"></a>        <span class="co"># , panel.background = ggplot2::element_rect(fill = &quot;gray66&quot;)</span></span>
<span id="cb228-76"><a href="point-cloud-classification.html#cb228-76" tabindex="-1"></a>        , <span class="at">plot.title =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>)</span>
<span id="cb228-77"><a href="point-cloud-classification.html#cb228-77" tabindex="-1"></a>        , <span class="at">plot.subtitle =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb228-78"><a href="point-cloud-classification.html#cb228-78" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb228-79"><a href="point-cloud-classification.html#cb228-79" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb228-80"><a href="point-cloud-classification.html#cb228-80" tabindex="-1"></a>        <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(pal_match_grp[<span class="st">&quot;commission&quot;</span>],<span class="cn">NA</span>,<span class="cn">NA</span>)))</span>
<span id="cb228-81"><a href="point-cloud-classification.html#cb228-81" tabindex="-1"></a>        , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb228-82"><a href="point-cloud-classification.html#cb228-82" tabindex="-1"></a>      )</span>
<span id="cb228-83"><a href="point-cloud-classification.html#cb228-83" tabindex="-1"></a>  )</span></code></pre></div>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="point-cloud-classification.html#cb229-1" tabindex="-1"></a>patchwork<span class="sc">::</span><span class="fu">wrap_plots</span>(</span>
<span id="cb229-2"><a href="point-cloud-classification.html#cb229-2" tabindex="-1"></a>    plt_list_temp</span>
<span id="cb229-3"><a href="point-cloud-classification.html#cb229-3" tabindex="-1"></a>    , <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb229-4"><a href="point-cloud-classification.html#cb229-4" tabindex="-1"></a>    , <span class="at">guides =</span> <span class="st">&quot;collect&quot;</span></span>
<span id="cb229-5"><a href="point-cloud-classification.html#cb229-5" tabindex="-1"></a>  ) <span class="sc">&amp;</span></span>
<span id="cb229-6"><a href="point-cloud-classification.html#cb229-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-190-1.png" width="816" /></p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="point-cloud-classification.html#cb230-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;../data/best_pile_detect_ever.jpeg&quot;</span>, <span class="at">height =</span> <span class="fl">9.5</span>, <span class="at">width =</span> <span class="fl">8.5</span>)</span></code></pre></div>
</div>
<div id="best-results-form" class="section level6 hasAnchor" number="4.2.2.2.2.2">
<h6><span class="header-section-number">4.2.2.2.2.2</span> Best results: form<a href="point-cloud-classification.html#best-results-form" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>we can cut to the chase and just look at the parameter combinations that achieved the best results based on the form quantification</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="point-cloud-classification.html#cb231-1" tabindex="-1"></a>pct_rank_th_temp <span class="ot">&lt;-</span> <span class="fl">0.99</span></span>
<span id="cb231-2"><a href="point-cloud-classification.html#cb231-2" tabindex="-1"></a>df_temp <span class="ot">&lt;-</span></span>
<span id="cb231-3"><a href="point-cloud-classification.html#cb231-3" tabindex="-1"></a>  param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb231-4"><a href="point-cloud-classification.html#cb231-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb231-5"><a href="point-cloud-classification.html#cb231-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb231-6"><a href="point-cloud-classification.html#cb231-6" tabindex="-1"></a>    <span class="at">.cols =</span> <span class="fu">c</span>(pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape)</span>
<span id="cb231-7"><a href="point-cloud-classification.html#cb231-7" tabindex="-1"></a>    , <span class="at">.fn =</span> dplyr<span class="sc">::</span>percent_rank</span>
<span id="cb231-8"><a href="point-cloud-classification.html#cb231-8" tabindex="-1"></a>    , <span class="at">.names =</span> <span class="st">&quot;pct_rank_{.col}&quot;</span></span>
<span id="cb231-9"><a href="point-cloud-classification.html#cb231-9" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb231-10"><a href="point-cloud-classification.html#cb231-10" tabindex="-1"></a>  <span class="co"># now get the max of these pct ranks by row</span></span>
<span id="cb231-11"><a href="point-cloud-classification.html#cb231-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb231-12"><a href="point-cloud-classification.html#cb231-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb231-13"><a href="point-cloud-classification.html#cb231-13" tabindex="-1"></a>    <span class="at">pct_rank_max =</span> <span class="fu">max</span>(</span>
<span id="cb231-14"><a href="point-cloud-classification.html#cb231-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">c_across</span>(</span>
<span id="cb231-15"><a href="point-cloud-classification.html#cb231-15" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;pct_rank&quot;</span>)</span>
<span id="cb231-16"><a href="point-cloud-classification.html#cb231-16" tabindex="-1"></a>      )</span>
<span id="cb231-17"><a href="point-cloud-classification.html#cb231-17" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb231-18"><a href="point-cloud-classification.html#cb231-18" tabindex="-1"></a>    )</span>
<span id="cb231-19"><a href="point-cloud-classification.html#cb231-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb231-20"><a href="point-cloud-classification.html#cb231-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb231-21"><a href="point-cloud-classification.html#cb231-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb231-22"><a href="point-cloud-classification.html#cb231-22" tabindex="-1"></a>    <span class="at">rank_lab =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb231-23"><a href="point-cloud-classification.html#cb231-23" tabindex="-1"></a>      pct_rank_pct_diff_volume_field_mape<span class="sc">&lt;=</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp) <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb231-24"><a href="point-cloud-classification.html#cb231-24" tabindex="-1"></a>      , pct_rank_pct_diff_area_field_mape<span class="sc">&lt;=</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp) <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb231-25"><a href="point-cloud-classification.html#cb231-25" tabindex="-1"></a>      , pct_rank_pct_diff_height_mape<span class="sc">&lt;=</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp) <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb231-26"><a href="point-cloud-classification.html#cb231-26" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb231-27"><a href="point-cloud-classification.html#cb231-27" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb231-28"><a href="point-cloud-classification.html#cb231-28" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb231-29"><a href="point-cloud-classification.html#cb231-29" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb231-30"><a href="point-cloud-classification.html#cb231-30" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb231-31"><a href="point-cloud-classification.html#cb231-31" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Volume vs field&quot;</span>)</span>
<span id="cb231-32"><a href="point-cloud-classification.html#cb231-32" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Area vs field&quot;</span>)</span>
<span id="cb231-33"><a href="point-cloud-classification.html#cb231-33" tabindex="-1"></a>          , <span class="fu">paste0</span>(<span class="st">&quot;top &quot;</span>, scales<span class="sc">::</span><span class="fu">percent</span>(<span class="dv">1</span><span class="sc">-</span>pct_rank_th_temp, <span class="at">accuracy =</span> <span class="dv">1</span>), <span class="st">&quot; MAPE Height&quot;</span>)</span>
<span id="cb231-34"><a href="point-cloud-classification.html#cb231-34" tabindex="-1"></a>        )</span>
<span id="cb231-35"><a href="point-cloud-classification.html#cb231-35" tabindex="-1"></a>      )</span>
<span id="cb231-36"><a href="point-cloud-classification.html#cb231-36" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb231-37"><a href="point-cloud-classification.html#cb231-37" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb231-38"><a href="point-cloud-classification.html#cb231-38" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(rank_lab) <span class="co"># pct_rank_max&gt;=0.99</span></span>
<span id="cb231-39"><a href="point-cloud-classification.html#cb231-39" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb231-40"><a href="point-cloud-classification.html#cb231-40" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb231-41"><a href="point-cloud-classification.html#cb231-41" tabindex="-1"></a>    <span class="at">lab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct, <span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)</span>
<span id="cb231-42"><a href="point-cloud-classification.html#cb231-42" tabindex="-1"></a>  ) </span>
<span id="cb231-43"><a href="point-cloud-classification.html#cb231-43" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb231-44"><a href="point-cloud-classification.html#cb231-44" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb231-45"><a href="point-cloud-classification.html#cb231-45" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape)</span>
<span id="cb231-46"><a href="point-cloud-classification.html#cb231-46" tabindex="-1"></a>    , <span class="at">names_to =</span> <span class="st">&quot;metric&quot;</span></span>
<span id="cb231-47"><a href="point-cloud-classification.html#cb231-47" tabindex="-1"></a>    , <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb231-48"><a href="point-cloud-classification.html#cb231-48" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb231-49"><a href="point-cloud-classification.html#cb231-49" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb231-50"><a href="point-cloud-classification.html#cb231-50" tabindex="-1"></a>    <span class="at">metric =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb231-51"><a href="point-cloud-classification.html#cb231-51" tabindex="-1"></a>        metric <span class="sc">==</span> <span class="st">&quot;pct_diff_volume_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb231-52"><a href="point-cloud-classification.html#cb231-52" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_area_field_mape&quot;</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb231-53"><a href="point-cloud-classification.html#cb231-53" tabindex="-1"></a>        , metric <span class="sc">==</span> <span class="st">&quot;pct_diff_height_mape&quot;</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb231-54"><a href="point-cloud-classification.html#cb231-54" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb231-55"><a href="point-cloud-classification.html#cb231-55" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb231-56"><a href="point-cloud-classification.html#cb231-56" tabindex="-1"></a>        <span class="at">ordered =</span> T</span>
<span id="cb231-57"><a href="point-cloud-classification.html#cb231-57" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb231-58"><a href="point-cloud-classification.html#cb231-58" tabindex="-1"></a>        , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb231-59"><a href="point-cloud-classification.html#cb231-59" tabindex="-1"></a>          <span class="st">&quot;MAPE Volume vs field&quot;</span></span>
<span id="cb231-60"><a href="point-cloud-classification.html#cb231-60" tabindex="-1"></a>          , <span class="st">&quot;MAPE Area vs field&quot;</span></span>
<span id="cb231-61"><a href="point-cloud-classification.html#cb231-61" tabindex="-1"></a>          , <span class="st">&quot;MAPE Height&quot;</span></span>
<span id="cb231-62"><a href="point-cloud-classification.html#cb231-62" tabindex="-1"></a>        )</span>
<span id="cb231-63"><a href="point-cloud-classification.html#cb231-63" tabindex="-1"></a>      )</span>
<span id="cb231-64"><a href="point-cloud-classification.html#cb231-64" tabindex="-1"></a>    , <span class="at">lab =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(lab, pct_rank_pct_diff_volume_field_mape) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb231-65"><a href="point-cloud-classification.html#cb231-65" tabindex="-1"></a>    , <span class="at">val_lab =</span> scales<span class="sc">::</span><span class="fu">percent</span>(value, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb231-66"><a href="point-cloud-classification.html#cb231-66" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb231-67"><a href="point-cloud-classification.html#cb231-67" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb231-68"><a href="point-cloud-classification.html#cb231-68" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> lab, <span class="at">fill =</span> metric, <span class="at">label =</span> val_lab)</span>
<span id="cb231-69"><a href="point-cloud-classification.html#cb231-69" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb231-70"><a href="point-cloud-classification.html#cb231-70" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb231-71"><a href="point-cloud-classification.html#cb231-71" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb231-72"><a href="point-cloud-classification.html#cb231-72" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">pal_get_pairs_fn</span>(<span class="dv">6</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>][<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb231-73"><a href="point-cloud-classification.html#cb231-73" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb231-74"><a href="point-cloud-classification.html#cb231-74" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb231-75"><a href="point-cloud-classification.html#cb231-75" tabindex="-1"></a>    , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.05</span>)</span>
<span id="cb231-76"><a href="point-cloud-classification.html#cb231-76" tabindex="-1"></a>    <span class="co"># , expand = expansion(mult = c(0, .08))</span></span>
<span id="cb231-77"><a href="point-cloud-classification.html#cb231-77" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb231-78"><a href="point-cloud-classification.html#cb231-78" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(metric), <span class="at">rows =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(rank_lab), <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb231-79"><a href="point-cloud-classification.html#cb231-79" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb231-80"><a href="point-cloud-classification.html#cb231-80" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;max_ht_m : max_area_m2 : convexity_pct : circle_fit_iou_pct&quot;</span></span>
<span id="cb231-81"><a href="point-cloud-classification.html#cb231-81" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb231-82"><a href="point-cloud-classification.html#cb231-82" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;top (and bottom) parameter combinations by evaluation metrics&quot;</span></span>
<span id="cb231-83"><a href="point-cloud-classification.html#cb231-83" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb231-84"><a href="point-cloud-classification.html#cb231-84" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb231-85"><a href="point-cloud-classification.html#cb231-85" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb231-86"><a href="point-cloud-classification.html#cb231-86" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb231-87"><a href="point-cloud-classification.html#cb231-87" tabindex="-1"></a>    , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb231-88"><a href="point-cloud-classification.html#cb231-88" tabindex="-1"></a>    , <span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)</span>
<span id="cb231-89"><a href="point-cloud-classification.html#cb231-89" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-192-1.png" width="1008" /></p>
<p>let’s make a table of these results</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="point-cloud-classification.html#cb232-1" tabindex="-1"></a>df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb232-2"><a href="point-cloud-classification.html#cb232-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb232-3"><a href="point-cloud-classification.html#cb232-3" tabindex="-1"></a>    rank_lab</span>
<span id="cb232-4"><a href="point-cloud-classification.html#cb232-4" tabindex="-1"></a>    , max_ht_m,max_area_m2,convexity_pct,circle_fit_iou_pct</span>
<span id="cb232-5"><a href="point-cloud-classification.html#cb232-5" tabindex="-1"></a>    , pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape</span>
<span id="cb232-6"><a href="point-cloud-classification.html#cb232-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb232-7"><a href="point-cloud-classification.html#cb232-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb232-8"><a href="point-cloud-classification.html#cb232-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(rank_lab,pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb232-9"><a href="point-cloud-classification.html#cb232-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb232-10"><a href="point-cloud-classification.html#cb232-10" tabindex="-1"></a>    <span class="at">.cols =</span> <span class="fu">c</span>(pct_diff_volume_field_mape, pct_diff_area_field_mape, pct_diff_height_mape)</span>
<span id="cb232-11"><a href="point-cloud-classification.html#cb232-11" tabindex="-1"></a>    , <span class="at">.fn =</span> <span class="sc">~</span> scales<span class="sc">::</span><span class="fu">percent</span>(.x, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb232-12"><a href="point-cloud-classification.html#cb232-12" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb232-13"><a href="point-cloud-classification.html#cb232-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">blank=</span> <span class="st">&quot;   &quot;</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb232-14"><a href="point-cloud-classification.html#cb232-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(blank, <span class="at">.before =</span> pct_diff_volume_field_mape) <span class="sc">%&gt;%</span> </span>
<span id="cb232-15"><a href="point-cloud-classification.html#cb232-15" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb232-16"><a href="point-cloud-classification.html#cb232-16" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;parameter combinations that achieved the best slash pile form quantification results&quot;</span></span>
<span id="cb232-17"><a href="point-cloud-classification.html#cb232-17" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb232-18"><a href="point-cloud-classification.html#cb232-18" tabindex="-1"></a>      <span class="st">&quot;.&quot;</span></span>
<span id="cb232-19"><a href="point-cloud-classification.html#cb232-19" tabindex="-1"></a>      ,<span class="st">&quot;max_ht_m&quot;</span>,<span class="st">&quot;max_area_m2&quot;</span>,<span class="st">&quot;convexity_pct&quot;</span>,<span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb232-20"><a href="point-cloud-classification.html#cb232-20" tabindex="-1"></a>      , <span class="st">&quot;   &quot;</span></span>
<span id="cb232-21"><a href="point-cloud-classification.html#cb232-21" tabindex="-1"></a>      , <span class="st">&quot;MAPE Volume vs field&quot;</span></span>
<span id="cb232-22"><a href="point-cloud-classification.html#cb232-22" tabindex="-1"></a>      , <span class="st">&quot;MAPE Area vs field&quot;</span></span>
<span id="cb232-23"><a href="point-cloud-classification.html#cb232-23" tabindex="-1"></a>      , <span class="st">&quot;MAPE Height&quot;</span></span>
<span id="cb232-24"><a href="point-cloud-classification.html#cb232-24" tabindex="-1"></a>    )</span>
<span id="cb232-25"><a href="point-cloud-classification.html#cb232-25" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb232-26"><a href="point-cloud-classification.html#cb232-26" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb232-27"><a href="point-cloud-classification.html#cb232-27" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb232-28"><a href="point-cloud-classification.html#cb232-28" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb232-29"><a href="point-cloud-classification.html#cb232-29" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">6</span>, <span class="st">&quot;Evaluation Metric&quot;</span> <span class="ot">=</span> <span class="dv">3</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-193">Table 4.2: </span>parameter combinations that achieved the best slash pile form quantification results
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="6">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Evaluation Metric
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
.
</th>
<th style="text-align:right;">
max_ht_m
</th>
<th style="text-align:right;">
max_area_m2
</th>
<th style="text-align:right;">
convexity_pct
</th>
<th style="text-align:right;">
circle_fit_iou_pct
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
MAPE Volume vs field
</th>
<th style="text-align:left;">
MAPE Area vs field
</th>
<th style="text-align:left;">
MAPE Height
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="13">
top 1% MAPE Volume vs field
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
28%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
16%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
30%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
130
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
31%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
32%
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
16%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
33%
</td>
<td style="text-align:left;">
23%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
35%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
14%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
36%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
130
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
36%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
16%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
36%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
19%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
37%
</td>
<td style="text-align:left;">
24%
</td>
<td style="text-align:left;">
18%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
37%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
38%
</td>
<td style="text-align:left;">
21%
</td>
<td style="text-align:left;">
18%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
39%
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="13">
top 1% MAPE Area vs field
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
39%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
16%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
46%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
19%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
47%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
25%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
47%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
20%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
47%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
47%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
21%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
48%
</td>
<td style="text-align:left;">
13%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
48%
</td>
<td style="text-align:left;">
12%
</td>
<td style="text-align:left;">
20%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
53%
</td>
<td style="text-align:left;">
11%
</td>
<td style="text-align:left;">
23%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
53%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
16%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
54%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
25%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
57%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
130
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
59%
</td>
<td style="text-align:left;">
14%
</td>
<td style="text-align:left;">
17%
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="11">
top 1% MAPE Height
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
39%
</td>
<td style="text-align:left;">
22%
</td>
<td style="text-align:left;">
14%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
40
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
44%
</td>
<td style="text-align:left;">
20%
</td>
<td style="text-align:left;">
15%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
44%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
15%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
80
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
46%
</td>
<td style="text-align:left;">
15%
</td>
<td style="text-align:left;">
15%
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
49%
</td>
<td style="text-align:left;">
18%
</td>
<td style="text-align:left;">
14%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
49%
</td>
<td style="text-align:left;">
17%
</td>
<td style="text-align:left;">
15%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
52%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
15%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
0.4
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
54%
</td>
<td style="text-align:left;">
16%
</td>
<td style="text-align:left;">
16%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
40
</td>
<td style="text-align:right;">
0.3
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
57%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
15%
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
58%
</td>
<td style="text-align:left;">
22%
</td>
<td style="text-align:left;">
15%
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
0.8
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
67%
</td>
<td style="text-align:left;">
19%
</td>
<td style="text-align:left;">
14%
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="point-cloud-classification.html#cb233-1" tabindex="-1"></a>  <span class="co"># kableExtra::scroll_box(height = &quot;8in&quot;)</span></span></code></pre></div>
</div>
<div id="parameter-combination-drill-downs" class="section level6 hasAnchor" number="4.2.2.2.2.3">
<h6><span class="header-section-number">4.2.2.2.2.3</span> Parameter combination drill-downs<a href="point-cloud-classification.html#parameter-combination-drill-downs" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The objective of these combination drill-down plots is to convey the pile detection evaluation results for a given set of the <code>convexity_pct</code>, <code>circle_fit_iou_pct</code>, and <code>max_area_m2</code> parameter settings while holding the <code>max_ht_m</code> and <code>min_area_m2</code> parameters constant since these should be defined based on the expected values of the treatment area. Based on our validation data, it was clear that the optimal <code>max_ht_m</code> value was 4.0 and that setting the value above this level resulted in understory trees being incorrectly detected as slash piles.</p>
<div id="f-score" class="section level7" number="4.2.2.2.2.3.1">
<p class="heading"><span class="header-section-number">4.2.2.2.2.3.1</span> F-score</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="point-cloud-classification.html#cb234-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb234-2"><a href="point-cloud-classification.html#cb234-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb234-3"><a href="point-cloud-classification.html#cb234-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb234-4"><a href="point-cloud-classification.html#cb234-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb234-5"><a href="point-cloud-classification.html#cb234-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-6"><a href="point-cloud-classification.html#cb234-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb234-7"><a href="point-cloud-classification.html#cb234-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb234-8"><a href="point-cloud-classification.html#cb234-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb234-9"><a href="point-cloud-classification.html#cb234-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb234-10"><a href="point-cloud-classification.html#cb234-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb234-11"><a href="point-cloud-classification.html#cb234-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb234-12"><a href="point-cloud-classification.html#cb234-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb234-13"><a href="point-cloud-classification.html#cb234-13" tabindex="-1"></a>      , <span class="at">fill =</span> f_score</span>
<span id="cb234-14"><a href="point-cloud-classification.html#cb234-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(f_score,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb234-15"><a href="point-cloud-classification.html#cb234-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb234-16"><a href="point-cloud-classification.html#cb234-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb234-17"><a href="point-cloud-classification.html#cb234-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb234-18"><a href="point-cloud-classification.html#cb234-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb234-19"><a href="point-cloud-classification.html#cb234-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(</span>
<span id="cb234-20"><a href="point-cloud-classification.html#cb234-20" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;Oranges&quot;</span></span>
<span id="cb234-21"><a href="point-cloud-classification.html#cb234-21" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb234-22"><a href="point-cloud-classification.html#cb234-22" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb234-23"><a href="point-cloud-classification.html#cb234-23" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb234-24"><a href="point-cloud-classification.html#cb234-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb234-25"><a href="point-cloud-classification.html#cb234-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb234-26"><a href="point-cloud-classification.html#cb234-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb234-27"><a href="point-cloud-classification.html#cb234-27" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb234-28"><a href="point-cloud-classification.html#cb234-28" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;F-score by parameter setting combination levels&quot;</span></span>
<span id="cb234-29"><a href="point-cloud-classification.html#cb234-29" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb234-30"><a href="point-cloud-classification.html#cb234-30" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb234-31"><a href="point-cloud-classification.html#cb234-31" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb234-32"><a href="point-cloud-classification.html#cb234-32" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb234-33"><a href="point-cloud-classification.html#cb234-33" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb234-34"><a href="point-cloud-classification.html#cb234-34" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb234-35"><a href="point-cloud-classification.html#cb234-35" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb234-36"><a href="point-cloud-classification.html#cb234-36" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb234-37"><a href="point-cloud-classification.html#cb234-37" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb234-38"><a href="point-cloud-classification.html#cb234-38" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb234-39"><a href="point-cloud-classification.html#cb234-39" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-196-1.png" width="1008" /></p>
</div>
<div id="recall" class="section level7" number="4.2.2.2.2.3.2">
<p class="heading"><span class="header-section-number">4.2.2.2.2.3.2</span> Recall</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="point-cloud-classification.html#cb235-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb235-2"><a href="point-cloud-classification.html#cb235-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb235-3"><a href="point-cloud-classification.html#cb235-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb235-4"><a href="point-cloud-classification.html#cb235-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb235-5"><a href="point-cloud-classification.html#cb235-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb235-6"><a href="point-cloud-classification.html#cb235-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb235-7"><a href="point-cloud-classification.html#cb235-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb235-8"><a href="point-cloud-classification.html#cb235-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb235-9"><a href="point-cloud-classification.html#cb235-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb235-10"><a href="point-cloud-classification.html#cb235-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb235-11"><a href="point-cloud-classification.html#cb235-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb235-12"><a href="point-cloud-classification.html#cb235-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb235-13"><a href="point-cloud-classification.html#cb235-13" tabindex="-1"></a>      , <span class="at">fill =</span> recall</span>
<span id="cb235-14"><a href="point-cloud-classification.html#cb235-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(recall,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb235-15"><a href="point-cloud-classification.html#cb235-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb235-16"><a href="point-cloud-classification.html#cb235-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb235-17"><a href="point-cloud-classification.html#cb235-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb235-18"><a href="point-cloud-classification.html#cb235-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb235-19"><a href="point-cloud-classification.html#cb235-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_gradient</span>(</span>
<span id="cb235-20"><a href="point-cloud-classification.html#cb235-20" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">&quot;gray97&quot;</span>, <span class="at">high =</span> <span class="st">&quot;gray27&quot;</span></span>
<span id="cb235-21"><a href="point-cloud-classification.html#cb235-21" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb235-22"><a href="point-cloud-classification.html#cb235-22" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb235-23"><a href="point-cloud-classification.html#cb235-23" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb235-24"><a href="point-cloud-classification.html#cb235-24" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb235-25"><a href="point-cloud-classification.html#cb235-25" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb235-26"><a href="point-cloud-classification.html#cb235-26" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb235-27"><a href="point-cloud-classification.html#cb235-27" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Recall by parameter setting combination levels&quot;</span></span>
<span id="cb235-28"><a href="point-cloud-classification.html#cb235-28" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb235-29"><a href="point-cloud-classification.html#cb235-29" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb235-30"><a href="point-cloud-classification.html#cb235-30" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb235-31"><a href="point-cloud-classification.html#cb235-31" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb235-32"><a href="point-cloud-classification.html#cb235-32" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb235-33"><a href="point-cloud-classification.html#cb235-33" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb235-34"><a href="point-cloud-classification.html#cb235-34" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb235-35"><a href="point-cloud-classification.html#cb235-35" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb235-36"><a href="point-cloud-classification.html#cb235-36" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb235-37"><a href="point-cloud-classification.html#cb235-37" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb235-38"><a href="point-cloud-classification.html#cb235-38" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-197-1.png" width="1008" /></p>
</div>
<div id="precision" class="section level7" number="4.2.2.2.2.3.3">
<p class="heading"><span class="header-section-number">4.2.2.2.2.3.3</span> Precision</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="point-cloud-classification.html#cb236-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb236-2"><a href="point-cloud-classification.html#cb236-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb236-3"><a href="point-cloud-classification.html#cb236-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb236-4"><a href="point-cloud-classification.html#cb236-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb236-5"><a href="point-cloud-classification.html#cb236-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-6"><a href="point-cloud-classification.html#cb236-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb236-7"><a href="point-cloud-classification.html#cb236-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb236-8"><a href="point-cloud-classification.html#cb236-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb236-9"><a href="point-cloud-classification.html#cb236-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb236-10"><a href="point-cloud-classification.html#cb236-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb236-11"><a href="point-cloud-classification.html#cb236-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb236-12"><a href="point-cloud-classification.html#cb236-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb236-13"><a href="point-cloud-classification.html#cb236-13" tabindex="-1"></a>      , <span class="at">fill =</span> precision</span>
<span id="cb236-14"><a href="point-cloud-classification.html#cb236-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(precision,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb236-15"><a href="point-cloud-classification.html#cb236-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb236-16"><a href="point-cloud-classification.html#cb236-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb236-17"><a href="point-cloud-classification.html#cb236-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb236-18"><a href="point-cloud-classification.html#cb236-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb236-19"><a href="point-cloud-classification.html#cb236-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(</span>
<span id="cb236-20"><a href="point-cloud-classification.html#cb236-20" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;Purples&quot;</span></span>
<span id="cb236-21"><a href="point-cloud-classification.html#cb236-21" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb236-22"><a href="point-cloud-classification.html#cb236-22" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb236-23"><a href="point-cloud-classification.html#cb236-23" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb236-24"><a href="point-cloud-classification.html#cb236-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb236-25"><a href="point-cloud-classification.html#cb236-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb236-26"><a href="point-cloud-classification.html#cb236-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb236-27"><a href="point-cloud-classification.html#cb236-27" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb236-28"><a href="point-cloud-classification.html#cb236-28" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Precision by parameter setting combination levels&quot;</span></span>
<span id="cb236-29"><a href="point-cloud-classification.html#cb236-29" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb236-30"><a href="point-cloud-classification.html#cb236-30" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb236-31"><a href="point-cloud-classification.html#cb236-31" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb236-32"><a href="point-cloud-classification.html#cb236-32" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb236-33"><a href="point-cloud-classification.html#cb236-33" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb236-34"><a href="point-cloud-classification.html#cb236-34" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb236-35"><a href="point-cloud-classification.html#cb236-35" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb236-36"><a href="point-cloud-classification.html#cb236-36" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb236-37"><a href="point-cloud-classification.html#cb236-37" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb236-38"><a href="point-cloud-classification.html#cb236-38" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb236-39"><a href="point-cloud-classification.html#cb236-39" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-198-1.png" width="1008" /></p>
</div>
<div id="mape-volume-vs-field" class="section level7" number="4.2.2.2.2.3.4">
<p class="heading"><span class="header-section-number">4.2.2.2.2.3.4</span> MAPE Volume vs field</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="point-cloud-classification.html#cb237-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb237-2"><a href="point-cloud-classification.html#cb237-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb237-3"><a href="point-cloud-classification.html#cb237-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb237-4"><a href="point-cloud-classification.html#cb237-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb237-5"><a href="point-cloud-classification.html#cb237-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb237-6"><a href="point-cloud-classification.html#cb237-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb237-7"><a href="point-cloud-classification.html#cb237-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb237-8"><a href="point-cloud-classification.html#cb237-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb237-9"><a href="point-cloud-classification.html#cb237-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb237-10"><a href="point-cloud-classification.html#cb237-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb237-11"><a href="point-cloud-classification.html#cb237-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb237-12"><a href="point-cloud-classification.html#cb237-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb237-13"><a href="point-cloud-classification.html#cb237-13" tabindex="-1"></a>      , <span class="at">fill =</span> pct_diff_volume_field_mape</span>
<span id="cb237-14"><a href="point-cloud-classification.html#cb237-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_diff_volume_field_mape,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb237-15"><a href="point-cloud-classification.html#cb237-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb237-16"><a href="point-cloud-classification.html#cb237-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb237-17"><a href="point-cloud-classification.html#cb237-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb237-18"><a href="point-cloud-classification.html#cb237-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb237-19"><a href="point-cloud-classification.html#cb237-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(</span>
<span id="cb237-20"><a href="point-cloud-classification.html#cb237-20" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;Blues&quot;</span></span>
<span id="cb237-21"><a href="point-cloud-classification.html#cb237-21" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb237-22"><a href="point-cloud-classification.html#cb237-22" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb237-23"><a href="point-cloud-classification.html#cb237-23" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb237-24"><a href="point-cloud-classification.html#cb237-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb237-25"><a href="point-cloud-classification.html#cb237-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb237-26"><a href="point-cloud-classification.html#cb237-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb237-27"><a href="point-cloud-classification.html#cb237-27" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb237-28"><a href="point-cloud-classification.html#cb237-28" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;MAPE Volume vs field by parameter setting combination levels&quot;</span></span>
<span id="cb237-29"><a href="point-cloud-classification.html#cb237-29" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb237-30"><a href="point-cloud-classification.html#cb237-30" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb237-31"><a href="point-cloud-classification.html#cb237-31" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb237-32"><a href="point-cloud-classification.html#cb237-32" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb237-33"><a href="point-cloud-classification.html#cb237-33" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb237-34"><a href="point-cloud-classification.html#cb237-34" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb237-35"><a href="point-cloud-classification.html#cb237-35" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb237-36"><a href="point-cloud-classification.html#cb237-36" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb237-37"><a href="point-cloud-classification.html#cb237-37" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb237-38"><a href="point-cloud-classification.html#cb237-38" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb237-39"><a href="point-cloud-classification.html#cb237-39" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-199-1.png" width="1008" /></p>
</div>
<div id="mape-area-vs-field" class="section level7" number="4.2.2.2.2.3.5">
<p class="heading"><span class="header-section-number">4.2.2.2.2.3.5</span> MAPE Area vs field</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="point-cloud-classification.html#cb238-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb238-2"><a href="point-cloud-classification.html#cb238-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb238-3"><a href="point-cloud-classification.html#cb238-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb238-4"><a href="point-cloud-classification.html#cb238-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb238-5"><a href="point-cloud-classification.html#cb238-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-6"><a href="point-cloud-classification.html#cb238-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb238-7"><a href="point-cloud-classification.html#cb238-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb238-8"><a href="point-cloud-classification.html#cb238-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb238-9"><a href="point-cloud-classification.html#cb238-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb238-10"><a href="point-cloud-classification.html#cb238-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb238-11"><a href="point-cloud-classification.html#cb238-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb238-12"><a href="point-cloud-classification.html#cb238-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb238-13"><a href="point-cloud-classification.html#cb238-13" tabindex="-1"></a>      , <span class="at">fill =</span> pct_diff_area_field_mape</span>
<span id="cb238-14"><a href="point-cloud-classification.html#cb238-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_diff_area_field_mape,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb238-15"><a href="point-cloud-classification.html#cb238-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb238-16"><a href="point-cloud-classification.html#cb238-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb238-17"><a href="point-cloud-classification.html#cb238-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb238-18"><a href="point-cloud-classification.html#cb238-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb238-19"><a href="point-cloud-classification.html#cb238-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(</span>
<span id="cb238-20"><a href="point-cloud-classification.html#cb238-20" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;YlGn&quot;</span></span>
<span id="cb238-21"><a href="point-cloud-classification.html#cb238-21" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb238-22"><a href="point-cloud-classification.html#cb238-22" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb238-23"><a href="point-cloud-classification.html#cb238-23" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb238-24"><a href="point-cloud-classification.html#cb238-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb238-25"><a href="point-cloud-classification.html#cb238-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb238-26"><a href="point-cloud-classification.html#cb238-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb238-27"><a href="point-cloud-classification.html#cb238-27" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb238-28"><a href="point-cloud-classification.html#cb238-28" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;MAPE Area vs field by parameter setting combination levels&quot;</span></span>
<span id="cb238-29"><a href="point-cloud-classification.html#cb238-29" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb238-30"><a href="point-cloud-classification.html#cb238-30" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb238-31"><a href="point-cloud-classification.html#cb238-31" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb238-32"><a href="point-cloud-classification.html#cb238-32" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb238-33"><a href="point-cloud-classification.html#cb238-33" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb238-34"><a href="point-cloud-classification.html#cb238-34" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb238-35"><a href="point-cloud-classification.html#cb238-35" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb238-36"><a href="point-cloud-classification.html#cb238-36" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb238-37"><a href="point-cloud-classification.html#cb238-37" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb238-38"><a href="point-cloud-classification.html#cb238-38" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb238-39"><a href="point-cloud-classification.html#cb238-39" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-200-1.png" width="1008" /></p>
</div>
<div id="mape-height" class="section level7" number="4.2.2.2.2.3.6">
<p class="heading"><span class="header-section-number">4.2.2.2.2.3.6</span> MAPE Height</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="point-cloud-classification.html#cb239-1" tabindex="-1"></a>param_combos_gt_agg <span class="sc">%&gt;%</span> </span>
<span id="cb239-2"><a href="point-cloud-classification.html#cb239-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb239-3"><a href="point-cloud-classification.html#cb239-3" tabindex="-1"></a>    max_ht_m <span class="sc">==</span> best_max_ht_m_temp</span>
<span id="cb239-4"><a href="point-cloud-classification.html#cb239-4" tabindex="-1"></a>    <span class="sc">&amp;</span> min_area_m2 <span class="sc">==</span> best_min_area_m2_temp</span>
<span id="cb239-5"><a href="point-cloud-classification.html#cb239-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb239-6"><a href="point-cloud-classification.html#cb239-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb239-7"><a href="point-cloud-classification.html#cb239-7" tabindex="-1"></a>    <span class="at">flab =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;max_area_m2&quot;</span>,max_area_m2,<span class="at">sep =</span> <span class="st">&quot; = &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb239-8"><a href="point-cloud-classification.html#cb239-8" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(max_area_m2)</span>
<span id="cb239-9"><a href="point-cloud-classification.html#cb239-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb239-10"><a href="point-cloud-classification.html#cb239-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb239-11"><a href="point-cloud-classification.html#cb239-11" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">as.factor</span>(convexity_pct)</span>
<span id="cb239-12"><a href="point-cloud-classification.html#cb239-12" tabindex="-1"></a>      , <span class="at">x =</span> <span class="fu">as.factor</span>(circle_fit_iou_pct)</span>
<span id="cb239-13"><a href="point-cloud-classification.html#cb239-13" tabindex="-1"></a>      , <span class="at">fill =</span> pct_diff_height_mape</span>
<span id="cb239-14"><a href="point-cloud-classification.html#cb239-14" tabindex="-1"></a>      , <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_diff_height_mape,<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb239-15"><a href="point-cloud-classification.html#cb239-15" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb239-16"><a href="point-cloud-classification.html#cb239-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb239-17"><a href="point-cloud-classification.html#cb239-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb239-18"><a href="point-cloud-classification.html#cb239-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(flab)) <span class="sc">+</span> </span>
<span id="cb239-19"><a href="point-cloud-classification.html#cb239-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_distiller</span>(</span>
<span id="cb239-20"><a href="point-cloud-classification.html#cb239-20" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;Reds&quot;</span></span>
<span id="cb239-21"><a href="point-cloud-classification.html#cb239-21" tabindex="-1"></a>      , <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb239-22"><a href="point-cloud-classification.html#cb239-22" tabindex="-1"></a>      , <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb239-23"><a href="point-cloud-classification.html#cb239-23" tabindex="-1"></a>      , <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb239-24"><a href="point-cloud-classification.html#cb239-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb239-25"><a href="point-cloud-classification.html#cb239-25" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb239-26"><a href="point-cloud-classification.html#cb239-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;circle_fit_iou_pct&quot;</span></span>
<span id="cb239-27"><a href="point-cloud-classification.html#cb239-27" tabindex="-1"></a>      , <span class="at">y =</span> <span class="st">&quot;convexity_pct&quot;</span></span>
<span id="cb239-28"><a href="point-cloud-classification.html#cb239-28" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;MAPE Height vs field by parameter setting combination levels&quot;</span></span>
<span id="cb239-29"><a href="point-cloud-classification.html#cb239-29" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb239-30"><a href="point-cloud-classification.html#cb239-30" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb239-31"><a href="point-cloud-classification.html#cb239-31" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb239-32"><a href="point-cloud-classification.html#cb239-32" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb239-33"><a href="point-cloud-classification.html#cb239-33" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb239-34"><a href="point-cloud-classification.html#cb239-34" tabindex="-1"></a>      , <span class="at">panel.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb239-35"><a href="point-cloud-classification.html#cb239-35" tabindex="-1"></a>      , <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb239-36"><a href="point-cloud-classification.html#cb239-36" tabindex="-1"></a>      <span class="co"># , plot.title = element_text(hjust = 0.5)</span></span>
<span id="cb239-37"><a href="point-cloud-classification.html#cb239-37" tabindex="-1"></a>      <span class="co"># , plot.subtitle = element_text(hjust = 0.5)</span></span>
<span id="cb239-38"><a href="point-cloud-classification.html#cb239-38" tabindex="-1"></a>      , <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb239-39"><a href="point-cloud-classification.html#cb239-39" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="manitou_slash_piles_files/figure-html/unnamed-chunk-201-1.png" width="1008" /></p>

</div>
</div>
</div>
</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="rgb-classification.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
