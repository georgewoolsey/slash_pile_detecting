# Point Cloud Processing{#ptcld_process}

We'll use the `cloud2trees` [package](https://github.com/georgewoolsey/cloud2trees) to perform all preprocessing of point cloud data which includes:

* ground classification and noise removal
* raster data (DTM and CHM) generation
* point cloud height normalization

All of this can be accomplished using the `cloud2trees::cloud2raster()` function. After generating these products from the raw point cloud we'll perform object segmentation to attempt to detect slash piles from the CHM which we'll generate by setting the minimum height to zero (essentially a digital surface model [DSM] with the ground removed).

To attempt to identify slash piles from the CHM/DSM, we can use watershed segmentation or DBSCAN (Density-Based Spatial Clustering of Applications with Noise), for example. Both of these methods are common in segmenting individual trees and coarse woody debris from CHM data.

## Process Raw Point Cloud

We'll use `cloud2trees::cloud2raster()` to process the raw point cloud data. For each site we'll generate a fine-resolution (0.1 m) CHM data set which can be aggregated to coarser resolution for sensitivity testing. Fine resolution CHM data would include granular details which may be important for delineating smaller slash piles while more coarse resolution data may help smooth out noise in the data to reduce false positive pile detections and potentially better represent the form of the actual piles

```{r}
# set chm res
my_chm_res_m <- 0.1
```

### PSINF Mixed Conifer Site

```{r, results=F}
# processing dirs
c2t_out_dir_temp <- "../data/PFDP_Data/"
out_dir_temp <- file.path(c2t_out_dir_temp, paste0("point_cloud_processing_delivery_chm",my_chm_res_m,"m") )
las_dir_temp <- "f:\\PFDP_Data\\p4pro_images\\P4Pro_06_17_2021_half_half_optimal\\2_densification\\point_cloud"
# read header with catalog
lidR::readLAScatalog(las_dir_temp)
# do it
if(!dir.exists(out_dir_temp)){
  # cloud2trees
  psinf_cloud2raster_ans <- cloud2trees::cloud2raster(
    output_dir = c2t_out_dir_temp
    , input_las_dir = las_dir_temp
    , accuracy_level = 2
    , keep_intrmdt = T
    , dtm_res_m = 0.25
    , chm_res_m = my_chm_res_m
    , min_height = 0 # effectively generates a DSM based on non-ground points
  )
  # rename
  file.rename(from = file.path(c2t_out_dir_temp,"point_cloud_processing_delivery"), to = out_dir_temp)
}else{
  dtm_temp <- terra::rast( file.path(out_dir_temp, "dtm_0.25m.tif") )
  chm_temp <- terra::rast( file.path(out_dir_temp, paste0("chm_", my_chm_res_m,"m.tif")) )
  # combine
  psinf_cloud2raster_ans <- list(
    "dtm_rast" = dtm_temp
    , "chm_rast" = chm_temp
  )
}
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

let's check out the DTM

```{r, results='hide', message=FALSE, fig.show='asis'}
psinf_cloud2raster_ans$dtm_rast %>% 
  terra::aggregate(fact = 2) %>%  #, fun = "median", cores = lasR::half_cores(), na.rm = T) %>% 
  terra::plot(
    col = harrypotter::hp(n = 100, option = "mischief")
    , axes = F
    , main = "PSINF DTM (m)"
  )
# add stand boundary
terra::plot(
  psinf_stand_boundary %>% 
    terra::vect() %>% 
    terra::project(terra::crs(psinf_rgb_rast))
  , add = T, border = "black", col = NA, lwd = 1.2
)
```

and CHM

```{r, results='hide', message=FALSE, fig.show='asis'}
psinf_cloud2raster_ans$chm_rast %>% 
  terra::aggregate(fact = 2) %>%  #, fun = "median", cores = lasR::half_cores(), na.rm = T) %>% 
  terra::plot(
    col = viridis::plasma(100)
    , axes = F
    , main = "PSINF CHM (m)"
  )
# add stand boundary
terra::plot(
  psinf_stand_boundary %>% 
    terra::vect() %>% 
    terra::project(terra::crs(psinf_rgb_rast))
  , add = T, border = "black", col = NA, lwd = 1.2
)
```

### DTM and CHM + piles

let's visually inspect the DTM and CHM with the pile outlines overlaid

```{r}
p_fn_temp <- function(
    rn
    , df = slash_piles_polys
    , rast = cloud2raster_ans$dtm_rast
    , crs = terra::crs(cloud2raster_ans$dtm_rast)
    , my_title = ""
    , vopt = "viridis"
    , lim = NULL
) {
  # scale the buffer based on the largest
    d_temp <- df %>%
      dplyr::arrange(tolower(comment), desc(field_diameter_m)) %>% 
      dplyr::slice(rn) %>% 
      sf::st_transform(crs)
    
    # plt classifier
    # convert to stars
    comp_st <- rast %>%  
      terra::crop(
        d_temp %>% sf::st_buffer(20) %>% terra::vect()
      ) %>% 
      terra::as.data.frame(xy = T) %>% 
      dplyr::rename(f=3)
    
    # ggplot
    comp_temp <- ggplot2::ggplot() +
      ggplot2::geom_tile(data = comp_st, ggplot2::aes(x=x,y=y,fill=f)) +
      ggplot2::geom_sf(data = d_temp, fill = NA, color = "gray33", lwd = 0.4) +
      ggplot2::scale_x_continuous(expand = c(0, 0)) +
      ggplot2::scale_y_continuous(expand = c(0, 0)) +
      ggplot2::labs(
        x = ""
        , y = ""
        , subtitle = my_title
      ) +
      ggplot2::theme_void() +
      ggplot2::theme(
        legend.position = "none" # c(0.5,1)
        , legend.margin = margin(0,0,0,0)
        , legend.text = element_text(size = 8)
        , legend.title = element_text(size = 8)
        , legend.key = element_rect(fill = "white")
        # , plot.title = ggtext::element_markdown(size = 10, hjust = 0.5)
        , plot.title = element_text(size = 8, hjust = 0.5, face = "bold")
        , plot.subtitle = element_text(size = 6, hjust = 0.5, face = "italic")
      )
  if(!is.null(lim)){
    comp_temp <- comp_temp + 
      ggplot2::scale_fill_viridis_c(option = vopt, limits = lim)
  }else{
    comp_temp <- comp_temp + 
      ggplot2::scale_fill_viridis_c(option = vopt)
  }
    
  plt_temp <- comp_temp
  return(list("plt"=plt_temp,"d"=d_temp))
}

# p_fn_temp(
#   rn = 5
#   # , lim = c(floor(terra::minmax(cloud2raster_ans$dtm_rast)[1]*0.98), floor(terra::minmax(cloud2raster_ans$dtm_rast)[2]*1.02))
# )
# p_fn_temp(
#   rn = 11
#   , rast = cloud2raster_ans$chm_rast
#   , vopt = "plasma"
# )
# combine 3
plt_combine_temp <- function(
    rn
    , df = slash_piles_polys %>% dplyr::filter(!is.na(comment))
    , rast1 = cloud2raster_ans$dtm_rast
    , title1 = "DTM"
    , vopt1 = "viridis"
    , rast2 = cloud2raster_ans$chm_rast
    , title2 = "CHM"
    , vopt2 = "plasma"
    , crs = terra::crs(cloud2raster_ans$dtm_rast)
) {
  # composite 1
  ans1 <- p_fn_temp(
    rn = rn
    , df = df
    , rast = rast1
    , my_title = title1
    , crs = crs
    , vopt = vopt1
  )
  # composite 2
  ans2 <- p_fn_temp(
    rn = rn
    , df = df
    , rast = rast2
    , my_title = title2
    , crs = crs
    , vopt = vopt2
  )
  # plt rgb
    rgb_temp <-
      ortho_plt_fn(my_ortho_rast = ortho_rast, stand =ans1$d) + 
      ggplot2::geom_sf(data = ans1$d, fill = NA, color = "white", lwd = 0.3)
  # combine
    r <- ans1$plt + ans2$plt + rgb_temp
    return(r)
}

# plt_combine_temp(2)

# add pile locations
plt_list_rast_comp <- sample(1:nrow(slash_piles_polys %>% dplyr::filter(!is.na(comment))),10) %>% 
  purrr::map(plt_combine_temp)
# plt_list_rast_comp[[2]]
```

combine the plots for a few piles

```{r, height = 10.5, width = 7.5}
patchwork::wrap_plots(
  plt_list_rast_comp
  , ncol = 2
)
ggplot2::ggsave("../data/pile_tiles_rast.jpeg", height = 8.5, width = 10.5)
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
remove(las_ctg, plt_list_rast_comp)
gc()
```

a few things are noteworthy in these examples:
 
* Piles are clearly visible in some areas of the DTM but less visible in other areas
* Piles are delineated in the CHM but with varying degrees of definition based on surrounding terrain and pile structure
* The DTM and CHM were rarely impacted by shadows in the RGB imagery
* It is interesting to see coarse woody debris occasionally visible in the CHM

```{r, include=FALSE, eval=TRUE}
# quick function to ingest a sf data.frame with geometry features for each row
# and return a bbox for each row-level geometry
st_bbox_by_row <- function(
  df
  , corner = NA # ul,ll,ur,lr,full
  , dimensions = T
) {
  if(!inherits(df,"sf")){stop("must be sf class object")}
  # corner
  corner <- dplyr::coalesce(corner,"") %>% tolower()
  
  nd <- df %>% 
    sf::st_set_geometry("geometry") %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(
      xmin_temp = sf::st_bbox(geometry)[1]
      , ymin_temp = sf::st_bbox(geometry)[2]
      , xmax_temp = sf::st_bbox(geometry)[3]
      , ymax_temp = sf::st_bbox(geometry)[4]
    )

  if(corner == "ul"){
    ret_d <- nd %>% 
      sf::st_drop_geometry() %>% 
      sf::st_as_sf(
        coords = c("xmin_temp","ymax_temp")
        , remove = F
        , crs = sf::st_crs(df)
      ) %>% 
      dplyr::ungroup()
  }else if(corner == "ll"){
    ret_d <- nd %>% 
      sf::st_drop_geometry() %>% 
      sf::st_as_sf(
        coords = c("xmin_temp","ymin_temp")
        , remove = F
        , crs = sf::st_crs(df)
      ) %>% 
      dplyr::ungroup()
  }else if(corner == "ur"){
    ret_d <- nd %>% 
      sf::st_drop_geometry() %>% 
      sf::st_as_sf(
        coords = c("xmax_temp","ymax_temp")
        , remove = F
        , crs = sf::st_crs(df)
      ) %>% 
      dplyr::ungroup()
  }else if(corner == "lr"){
    ret_d <- nd %>% 
      sf::st_drop_geometry() %>% 
      sf::st_as_sf(
        coords = c("xmax_temp","ymin_temp")
        , remove = F
        , crs = sf::st_crs(df)
      ) %>% 
      dplyr::ungroup()
  }else if(corner == "full"){
    ret_d <- nd %>% 
      dplyr::mutate(
        geometry = sf::st_sfc(
            sf::st_point(c(xmin_temp,ymin_temp)) # lower_left_pt
            , sf::st_point(c(xmax_temp,ymax_temp)) # upper_right_pt
          ) %>% 
          sf::st_bbox() %>% 
          sf::st_as_sfc()
      ) %>%
      dplyr::ungroup() %>%
      sf::st_set_geometry("geometry") %>%
      sf::st_set_crs(sf::st_crs(df))
  }else{
    ret_d <- nd %>% dplyr::ungroup()
  }
  
  # length/width
  if(dimensions){
    ret_d <- ret_d %>% 
      dplyr::rowwise() %>% 
      dplyr::mutate(
        # calc dimensions
        xdiff_temp = xmax_temp-xmin_temp
        , ydiff_temp = ymax_temp-ymin_temp
        , shape_length = max(xdiff_temp,ydiff_temp,na.rm = T)
        , shape_width = min(xdiff_temp,ydiff_temp,na.rm = T)
      ) %>% 
      dplyr::select(-c(xmin_temp,ymin_temp,xmax_temp,ymax_temp,xdiff_temp,ydiff_temp)) %>% 
      dplyr::ungroup()
  }else{
    ret_d <- ret_d %>% 
      dplyr::select(-c(xmin_temp,ymin_temp,xmax_temp,ymax_temp))
  }
  
  return(ret_d)
}
```

```{r, include = F, eval = F}
pile_id_temp <- 
  # slash_piles_polys %>% dplyr::arrange(desc(field_diameter_m)) %>% dplyr::slice(1) %>% dplyr::pull(pile_id)
  73
crs_temp <- terra::crs(ortho_rast)
# buff
buff_temp <- slash_piles_polys %>% dplyr::filter(pile_id == pile_id_temp) %>% 
  sf::st_centroid() %>% 
  sf::st_buffer(35, endCapStyle = "SQUARE")
# piles filter
piles_temp <- slash_piles_polys %>% 
  sf::st_intersection(buff_temp) %>% 
  dplyr::mutate(rn = dplyr::row_number())
piles_bbox_temp <- piles_temp %>% st_bbox_by_row(corner = "ul")
  
# rgb
rgb_temp <- 
  ortho_plt_fn(my_ortho_rast = ortho_rast, stand = buff_temp %>% sf::st_transform(crs_temp), buffer = 0) 
# rgb_temp
rgb_temp + 
  ggplot2::geom_sf(
    data = piles_temp %>% sf::st_transform(crs_temp)
    , fill = NA, color = "orangered2", lwd = 0.8
  ) +
  ggplot2::geom_sf_label(
    data = piles_bbox_temp %>% sf::st_transform(crs_temp)
    , ggplot2::aes(label = rn, fontface = "bold")
    , vjust = 0, hjust = 0.5
    # , color = "white"
  )
ggplot2::ggsave("../data/rgbtesttest.jpg", height = 7, width = 7.5)
# dtm
dtm_temp <- 
  cloud2raster_ans$dtm_rast %>%  
  terra::crop(
    buff_temp %>% 
      sf::st_transform(crs_temp) %>% 
      terra::vect()
  ) %>% 
  terra::as.data.frame(xy = T) %>% 
  dplyr::rename(f=3) %>% 
  ggplot2::ggplot() +
  ggplot2::geom_tile(ggplot2::aes(x=x,y=y,fill=f)) +
  ggplot2::scale_fill_viridis_c(option = "viridis") +
  ggplot2::scale_x_continuous(expand = c(0, 0)) +
  ggplot2::scale_y_continuous(expand = c(0, 0)) +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "none")
dtm_temp +
  ggplot2::geom_sf(
    data = piles_temp %>% sf::st_transform(crs_temp)
    , fill = NA, color = "orangered2", lwd = 0.8
  ) +
  ggplot2::geom_sf_label(
    data = piles_bbox_temp %>% sf::st_transform(crs_temp)
    , ggplot2::aes(label = rn, fontface = "bold")
    , vjust = 0, hjust = 0.5
    # , color = "white"
  )
ggplot2::ggsave("../data/dtmtesttest.jpg", height = 7, width = 7.5)
# chm
chm_temp <- 
  cloud2raster_ans$chm_rast %>%  
  terra::crop(
    buff_temp %>% 
      sf::st_transform(crs_temp) %>% 
      terra::vect()
  ) %>% 
  terra::as.data.frame(xy = T) %>% 
  dplyr::rename(f=3) %>% 
  ggplot2::ggplot() +
  ggplot2::geom_tile(ggplot2::aes(x=x,y=y,fill=f)) +
  # harrypotter::scale_fill_hp("mischief") +
  ggplot2::scale_fill_viridis_c(option = "mako", direction = -1) +
  # ggplot2::scale_fill_distiller(palette = "BrBG", direction = 1) +
  ggplot2::scale_x_continuous(expand = c(0, 0)) +
  ggplot2::scale_y_continuous(expand = c(0, 0)) +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "none")
chm_temp +
  ggplot2::geom_sf(
    data = piles_temp %>% sf::st_transform(crs_temp)
    , fill = NA, color = "orangered2", lwd = 0.8
  ) +
  ggplot2::geom_sf_label(
    data = piles_bbox_temp %>% sf::st_transform(crs_temp)
    , ggplot2::aes(label = rn, fontface = "bold")
    , vjust = 0, hjust = 0.5
    # , color = "white"
  )
ggplot2::ggsave("../data/chmtesttest.jpg", height = 7, width = 7.5)
```

```{r, include = F, eval = F}
# cld
ctg_temp <- lidR::readLAScatalog(
  "f:\\PFDP_Data\\p4pro_images\\P4Pro_06_17_2021_half_half_optimal\\2_densification\\point_cloud"
  # "../data/point_cloud_processing_temp/02_normalize"
  , select = "xyzRGB"
)
lidR::opt_progress(ctg_temp) <- F
lidR::opt_filter(ctg_temp) <- "-drop_duplicates"

lidR::clip_roi(
  ctg_temp
  # biggest mechanical
  , piles_temp %>%
    dplyr::filter(rn==1) %>% 
    sf::st_centroid() %>% 
    sf::st_buffer(4.2, endCapStyle = "SQUARE") %>% 
    sf::st_transform(lidR::st_crs(ctg_temp))
) %>% 
lidR::plot(
    color = "RGB", bg = "white", legend = F
  )  


lidR::clip_roi(
  ctg_temp
  # biggest mechanical
  , piles_temp %>%
    dplyr::filter(rn==2) %>% 
    sf::st_centroid() %>% 
    sf::st_buffer(5, endCapStyle = "SQUARE") %>% 
    sf::st_transform(lidR::st_crs(ctg_temp))
) %>% 
  purrr::pluck("data") %>% 
  summary()
lidR::plot(
    color = "RGB", bg = "white", legend = F
  )  


p_fn_temp(1)
p_fn_temp(2)
p_fn_temp(3)
p_fn_temp(4)
p_fn_temp(5)
```

```{r, include=FALSE, eval=FALSE}
### PSINF Mixed Conifer Site
### TRFO-BLM Pinyon-Juniper Site
### BHEF Ponderosa Pine Site
### ARNF Ponderosa Pine Site
```

