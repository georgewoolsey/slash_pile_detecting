We followed [these directions](https://segoptim.bitbucket.io/docs/installation.html#installing-the-package) to install and setup the `SegOptim` [package](https://github.com/joaofgoncalves/SegOptim). A limitation of the `SegOptim` package is that it relies on external software to perform image segmentation because at the time of development R had no 'native' packages for conducting image segmentation. 

```{r}
# remotes::install_github("dalpozz/unbalanced")
# remotes::install_github("joaofgoncalves/SegOptim")
## !!!!!!!!!!!!!!!! SegOptim also requires external (or 3rd party) software to implement image segmentation
## !!!!!!!!!!!!!!!! we installed the options available at: https://trac.osgeo.org/osgeo4w/
## !!!!!!!!!!!!!!!! we installed the options available at: https://www.orfeo-toolbox.org/download/
library("SegOptim")
```

## `SegOptim` segmentation

### input data

in addition to the training data, `SegOptim` requires two additional data sources as input which Goncalves et al. (2019) describe: 

1. *segmentation features*: encompassed less dimensions (in comparison to the classification feature space) to allow fast processing needed to run segmentation. For example, the Red (R), Green (G) and Blue (B) bands were employed
2. *classification features* were many: 
    + spectral bands (reflectance values); 
    + alternative colour spaces (other than RGB but with better separability between components; e.g., XYZ, YUV); 
    + multiple combinations of band ratios in the form: where and are any two different spectral bands; 
    + vegetation and/or water indices (e.g., NDVI, EVI, NDWI); 
    + multiple combinations of Normalized Difference Indices (NDI); 
    + texture operators such as Haralick (Haralick, 1979) (HL; e.g., energy, entropy, correlation, inertia), Local Statistics (LS; e.g., mean, variance)
    
all data needs to be saved to the disk for reading by the `SegOptim` package functions

```{r}
tempdir_temp <- tempdir()
fpath_train <- file.path(tempdir_temp, "train.tif")
fpath_seg <- file.path(tempdir_temp, "seg.tif")
fpath_class <- file.path(tempdir_temp, "class.tif")
# write
terra::writeRaster(class_rast_training, filename = fpath_train, overwrite = T)
terra::writeRaster(
  pred_rast %>% terra::subset(c("red","green","blue"))
  , filename = fpath_seg
  , overwrite = T
)
terra::writeRaster(
  pred_rast # includes indicies and textural as well as RGB
  , filename = fpath_class
  , overwrite = T
)
```

for this example we'll use the Large Scale Mean Shift segmentation algorithm ([Michel et al. 2014](https://scholar.google.com/scholar?cluster=2475881846105669180&hl=en&as_sdt=0,6)) which is implemented using the [Orfeo Toolbox (OTB)](https://www.orfeo-toolbox.org/download/) software which provides [documentation for the algorithm](https://www.orfeo-toolbox.org/CookBook/Applications/app_LargeScaleMeanShift.html?highlight=spectral%20range) and a [cookbook here](https://www.orfeo-toolbox.org/CookBook/recipes/improc.html#segmentation)

```{r}
##################################################this doesn't work with OTB-9.1.1
# ?segmentation_OTB_LSMS
## Run the segmentation
outSegmRst <- SegOptim::segmentation_OTB_LSMS(
  # Input raster with features/bands to segment
  inputRstPath = fpath_seg
  # Algorithm params
    ### The range and spatial radius used for the segmentation step are half the values used for Mean-Shift smoothing, which are obtained from LargeScaleMeanShift parameters.
  # Range radius defining the radius (expressed in radiometry units) in the multi-spectral space
    , SpectralRange = 15 # 15 default 
  # Radius of the spatial neighborhood for averaging. Higher values will result in more smoothing and higher processing time
    , SpatialRange = 5 # 5 default 
  # If, after the segmentation, a segment is of size strictly lower than this criterion, the segment is merged with the segment that has the closest sepctral signature.
    , MinSize = 50 # 5 default 
  # Output
  , outputSegmRst = "../data/segmentation_OTB_LSMS_rast.tif" ## Output file from OTB image segmentation
  , verbose = TRUE
  , otbBinPath = "c:/OTB/bin" # Path to Orfeo Toolbox binaries
  , lsms_maxiter = 50
)

# Check the file paths with outputs
print(outSegmRst)

# Load the segmented raster and plot it
terra::rast(outSegmRst$segm)

plot(segmRst)

# The final output file containing the distribution of the target species
outClassRst.path <- "./WV2_VilarVeiga_AcaciaDealbata_v1.tif"

```

